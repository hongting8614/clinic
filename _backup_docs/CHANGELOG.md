# 更新日志

## [v3.5] - 2025-11-04

### 🎉 重大更新

#### 入库模块全面重构
- 从卡片式UI升级为**表格式UI**，支持连续输入
- 实现**双签名审核流程**（操作员签名 + 复核员签名）
- 新增**三种药品录入方式**：扫码、从档案选择、新建药品

### ✨ 新增功能

#### 1. 新增组件
- **`in-entry-toolbar`**: 药品录入工具条
  - 扫码入库（支持连续扫码模式）
  - 从档案选择
  - 新建药品
  - 清空明细
  
- **`in-entry-table`**: 可编辑明细表格
  - 15列完整药品信息
  - 实时验证
  - 自动计算（距有效期天数、金额、统计）
  - 颜色警告（近效期、过期）

#### 2. 药品档案选择模式
- `pages-sub/drug/list.vue` 新增 `mode=select` 选择模式
- 使用全局事件 `uni.$emit('drugSelected')` 传递数据
- 支持搜索和分类筛选

#### 3. 复核流程完善
- 列表页权限判断（只能编辑自己的、只能复核别人的）
- 详情页流程指示器
- 复核操作区（签名 + 驳回原因）
- 云函数自动更新库存

#### 4. 表格特性增强
- 横向滚动支持
- 固定表头
- 必填项标识
- 错误行高亮
- 等宽字体显示条形码
- 底部统计栏

### 🔄 优化改进

#### UI/UX
- 优化入库单号自动生成
- 优化日期选择器范围限制
- 优化扫码错误提示（用户取消不提示）
- 优化删除/清空二次确认
- 优化签名组件集成

#### 数据流
- 统一 v-model 双向绑定
- 简化事件传递
- 按需验证，提升性能

#### 代码质量
- 组件化设计，提升复用性
- 清理旧代码和无用样式（约200行）
- 统一API封装
- 完善注释和文档

### 🗑️ 移除内容

#### 旧UI组件
- 移除卡片式药品列表
- 移除 `DrugSelector` 组件依赖（改用页面导航）

#### 无用样式
- `.section-count`
- `.clear-all`
- `.table-toolbar`
- `.switch-item`
- 旧的 `.table`, `.tr`, `.thead`, `.tbody`
- 旧的 `.cell-input`, `.cell-picker`
- 等约150行无用样式

### 🐛 修复问题

- 修复 `uni.scanCode` 返回值处理
- 修复 v-model 双向绑定
- 修复日期验证逻辑
- 修复数量/单价验证规则

### 📝 文档

#### 新增文档
- `docs/入库模块重构日志.md` - 重构详细记录
- `docs/入库模块完整功能说明.md` - 完整功能说明

#### 更新文档
- `📊项目状态总览.md` - 更新模块状态
- `CHANGELOG.md` - 本文件

### 🔧 技术细节

#### 云函数
- `inRecords` 已支持所有CRUD操作
- `inRecords/approve` 自动更新库存
- `inRecords/reject` 支持驳回原因
- `inRecords/getCounts` 统计各状态数量

#### 数据库
- `in_records` 表结构完善
- 索引优化（recordNo、status、createTime）
- 库存更新逻辑（FIFO待实现）

#### 权限控制
- 操作员：创建、编辑自己的草稿、提交
- 复核员：复核别人的单据、通过/驳回
- 自动校验：不能复核自己的单据

### 📊 代码统计

- **删除**: ~200行（旧UI + 旧样式）
- **新增**: ~500行（新组件：toolbar + table）
- **净增**: ~300行
- **Linter错误**: 0 ✅

### 🚀 待办事项

#### 高优先级
- [ ] 药品新建页面回调处理
- [ ] 外部药品数据API对接
- [ ] 批次FIFO出库逻辑

#### 中优先级
- [ ] 草稿自动保存
- [ ] 批量导入Excel
- [ ] 打印/导出PDF

#### 低优先级
- [ ] 统计报表
- [ ] 批量审核

---

## [v3.4] - 2025-11-01

### ✅ 完成
- 项目基础架构搭建
- 药品档案管理
- 库存管理
- 出库管理（基础）
- 用户权限系统

---

**维护**: AI Assistant  
**项目**: AK-PMS (爱康医务室管理系统)









