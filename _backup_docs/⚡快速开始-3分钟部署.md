# ⚡ 快速开始 - 3分钟部署 AK-PMS v3.3

**目标**: 最快速度让系统运行起来  
**时间**: 约3分钟  
**难度**: ⭐⭐☆☆☆

---

## 📝 前置检查

确保你已经：
- ✅ 安装了微信开发者工具
- ✅ 开通了微信云开发环境
- ✅ 项目代码已下载到本地

---

## 🚀 三步部署

### Step 1: 部署云函数（1分钟）

1. **打开微信开发者工具**，导入项目

2. **批量上传云函数**：
   ```
   在左侧目录树找到 cloudfunctions 文件夹
   依次右键以下5个文件夹 → "上传并部署：云端安装依赖"
   
   ✅ clinicRecords      (门诊登记)
   ✅ reportService      (报表服务)
   ✅ queryService       (查询服务)
   ✅ dailySummary       (每日统计)
   ✅ expiryMonitor      (效期预警)
   ```

3. **等待上传完成**（约30秒）

---

### Step 2: 创建数据库（1分钟）

1. **打开云开发控制台**：
   - 点击开发者工具顶部"云开发"按钮
   - 选择"数据库"标签

2. **创建3个新集合**：
   ```
   点击"添加集合" → 输入名称 → 确定
   
   ✅ clinic_usage     (门诊用药记录)
   ✅ statistics       (统计数据)
   ✅ alerts           (预警记录)
   ```

3. **快速配置索引**（可选，提升性能）：
   ```javascript
   // 在 clinic_usage 集合设置页 → 索引管理 → 添加索引
   { "location": 1, "createTime": -1 }
   { "drugId": 1, "createTime": -1 }
   ```

---

### Step 3: 配置定时任务（1分钟）

1. **打开云函数管理**：
   - 云开发控制台 → 云函数
   - 找到 `dailySummary` 云函数

2. **添加定时触发器**：
   ```
   点击"定时触发器"标签 → 新建触发器
   
   【dailySummary】
   触发器名称: daily_stats
   Cron表达式: 59 23 * * *
   时区: Asia/Shanghai
   
   【expiryMonitor】
   触发器名称: expiry_check
   Cron表达式: 10 0 * * *
   时区: Asia/Shanghai
   ```

3. **保存并启用**

---

## ✅ 验证部署

### 快速测试（30秒）

在微信开发者工具的"控制台"标签中运行：

```javascript
// 测试1: 门诊登记功能
wx.cloud.callFunction({
  name: 'clinicRecords',
  data: {
    action: 'getTodayCount',
    data: { location: 'land_park' }
  }
}).then(res => {
  console.log('✅ 门诊功能正常', res);
});

// 测试2: 报表服务
wx.cloud.callFunction({
  name: 'reportService',
  data: {
    reportType: 'R4_stock',
    params: { location: 'all' }
  }
}).then(res => {
  console.log('✅ 报表功能正常', res);
});

// 测试3: 定时任务
wx.cloud.callFunction({
  name: 'expiryMonitor'
}).then(res => {
  console.log('✅ 预警功能正常', res);
});
```

### 查看结果
- 如果控制台输出 "✅ XXX功能正常"，说明部署成功！
- 如果有错误，请查看"常见问题"章节

---

## 🎯 开始使用

### 在手机上体验

1. **点击"编译"** 按钮
2. **扫描二维码** 在手机上打开小程序
3. **首页找到新功能**：
   - 🩺 **门诊用药**（绿色卡片）
   - 📊 **报表查询**（紫色卡片）

### 门诊用药流程

```
1. 点击"门诊用药"
2. 选择园区（陆园/水园/医务室）
3. 扫码或搜索药品
4. 输入用量（自动换算单位）
5. 填写患者信息
6. 保存（自动扣减库存）
```

---

## ❓ 常见问题

### Q1: 云函数上传失败？
**解决**:
- 检查网络连接
- 确认云开发环境已开通
- 重新上传一次

### Q2: 定时任务没有执行？
**解决**:
- 检查Cron表达式是否正确
- 确认触发器已启用
- 查看云函数日志

### Q3: 门诊登记提示"库存不足"？
**解决**:
- 确认该园区有对应药品库存
- 检查 stock 表中是否有 location 字段
- 可能需要先添加入库记录

### Q4: 测试时报错"云函数不存在"？
**解决**:
- 等待30秒，云函数部署需要时间
- 刷新页面重新编译
- 确认云函数已成功上传

---

## 📚 进阶配置

### 想要更完整的功能？

继续查看以下文档：

| 文档 | 内容 | 时间 |
|------|------|------|
| 🚀v3.3部署指南.md | 完整部署流程 + 测试验证 | 10分钟 |
| AK-PMS_v3.3_功能与管理文档.md | 功能说明 + 操作指南 | 30分钟 |
| AK-PMS_v3.3_技术栈与实现说明.md | 技术细节 + API文档 | 60分钟 |

### 数据迁移

如果你有旧数据需要迁移：

```javascript
// 在云开发控制台 → 数据库 → stock 集合 → 执行
const db = cloud.database();
const stocks = await db.collection('stock').get();

for (const stock of stocks.data) {
  const drug = await db.collection('drugs').doc(stock.drugId).get();
  await db.collection('stock').doc(stock._id).update({
    data: {
      specification: drug.data.specification || '未知',
      location: 'land_park',  // 默认设为陆园
      daysToExpiry: 999,
      expiryStatus: '正常'
    }
  });
}
```

---

## 🎊 恭喜！

**你已成功部署 AK-PMS v3.3！**

现在你可以：
- ✅ 使用门诊用药快速登记功能
- ✅ 查看5大核心报表
- ✅ 使用6项查询功能
- ✅ 接收效期预警提醒（每天00:10）
- ✅ 查看每日统计数据（每天23:59生成）

---

## 📞 需要帮助？

- 📖 查看完整部署指南
- 🔍 搜索常见问题文档
- 💬 查看开发日志
- 📧 联系技术支持

---

**快速开始指南 v1.0**  
**最后更新**: 2025-11-01


