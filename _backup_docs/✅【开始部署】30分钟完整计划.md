# ✅ AK-PMS 30分钟完整部署计划

**目标**: 将系统从本地代码部署到云端，立即可用  
**总耗时**: 30-40分钟  
**难度**: ⭐⭐⭐☆☆ 中等

---

## 🎯 部署概览

```
当前状态: 本地代码完成 ✅
目标状态: 云端运行 🎯

需要完成:
├── 21个云函数上传
├── 12个数据库集合创建
├── 2个定时触发器配置
└── 功能测试验证
```

---

## ⏱️ 时间分配

| 阶段 | 任务 | 预计时间 | 优先级 |
|------|------|---------|--------|
| 阶段1 | 紧急修复 stockManage | 2分钟 | ⭐⭐⭐ |
| 阶段2 | 核心云函数部署 | 15分钟 | ⭐⭐⭐ |
| 阶段3 | 数据库集合创建 | 8分钟 | ⭐⭐⭐ |
| 阶段4 | 定时触发器配置 | 3分钟 | ⭐⭐ |
| 阶段5 | 编译测试验证 | 5分钟 | ⭐⭐⭐ |
| **总计** | | **33分钟** | |

---

## 📋 阶段1: 紧急修复 stockManage（2分钟）⭐⭐⭐

### 🚨 当前问题
```
错误: 云函数调用失败: stockManage 
      Error: $ is not defined
```

### ✅ 立即操作

```
1. 打开微信开发者工具
2. 点击顶部：云开发
3. 左侧找到：cloudfunctions/stockManage
4. 右键点击 stockManage 文件夹
5. 选择：上传并部署：云端安装依赖 ⚠️
6. 等待完成（1-2分钟）
7. 点击：编译
8. 验证首页数据正常显示
```

### ✅ 成功标志
- [x] 看到"部署成功"提示
- [x] 首页"今日数据"正常显示
- [x] 控制台无 "$ is not defined" 错误

**详细步骤**: 📄 `🎯【第一步】立即上传stockManage.txt`

---

## 📋 阶段2: 核心云函数部署（15分钟）⭐⭐⭐

### 必须部署的云函数（11个）

#### 批次1: 基础功能（4个，8分钟）
```
□ drugManage          - 药品管理
□ inRecords           - 入库管理
□ outRecords          - 出库管理
□ getDrugList         - 药品查询
```

#### 批次2: 高级功能（4个，8分钟）
```
□ clinicRecords       - 门诊登记 (v3.2)
□ reportService       - 报表服务 (v3.3)
□ queryService        - 查询服务 (v3.3)
□ getStockList        - 库存查询
```

#### 批次3: 定时任务（3个，6分钟）
```
□ dailySummary        - 每日统计
□ expiryMonitor       - 效期预警
□ login               - 用户登录
```

### 统一操作步骤
```
对每个云函数重复:
1. 右键点击云函数文件夹
2. 选择：上传并部署：云端安装依赖
3. 等待1-2分钟
4. 看到"部署成功"
5. 继续下一个
```

### 可选部署（8个，稍后完成）
```
□ consumeRecords      - 消耗记录
□ requisitionRecords  - 请领记录
□ updateStock         - 库存更新
□ getUserList         - 用户列表
□ addUser             - 添加用户
□ updateUser          - 更新用户
□ deleteUser          - 删除用户
□ updateUserStatus    - 用户状态
□ getMyOpenId         - 获取OpenID
```

**详细清单**: 📄 `📋云函数批量部署清单.txt`

---

## 📋 阶段3: 数据库集合创建（8分钟）⭐⭐⭐

### 访问云开发控制台
```
方法1: 微信开发者工具
  云开发 → 数据库

方法2: 浏览器
  https://console.cloud.tencent.com/tcb
  → 选择环境 → 数据库
```

### 需要创建的集合（12个）

#### 核心业务（7个）
```
1. □ drugs                - 药品档案
2. □ stock                - 库存信息
3. □ in_records           - 入库记录
4. □ out_records          - 出库记录
5. □ clinic_usage         - 门诊用药 (v3.2)
6. □ consume_records      - 消耗记录
7. □ requisition_records  - 请领记录
```

#### 系统功能（5个）
```
8. □ users                - 用户信息
9. □ statistics           - 统计数据 (v3.3)
10. □ alerts              - 预警记录 (v3.3)
11. □ operation_logs      - 操作日志
12. □ stock_check         - 盘点记录
```

### 创建步骤（每个集合约30秒）
```
1. 点击"添加集合"
2. 输入集合名称（如：drugs）
3. 点击"确定"
4. 点击新建的集合
5. 权限设置 → 所有用户可读写
6. 点击"保存"
7. 继续下一个
```

**详细指南**: 📄 `🗄️数据库创建指南.txt`

---

## 📋 阶段4: 定时触发器配置（3分钟）⭐⭐

### 需要配置的触发器（2个）

#### 1. dailySummary - 每日统计
```
功能: 每天23:59统计当日数据
配置:
  - 触发器名称: dailySummary
  - 触发周期: 自定义
  - Cron表达式: 0 59 23 * * * *
```

#### 2. expiryMonitor - 效期预警
```
功能: 每天00:10扫描临期药品
配置:
  - 触发器名称: expiryMonitor
  - 触发周期: 自定义
  - Cron表达式: 0 10 0 * * * *
```

### 配置步骤
```
1. 云开发控制台 → 云函数
2. 找到 dailySummary
3. 点击"触发器"标签
4. 点击"添加触发器"
5. 填写配置信息
6. 点击"确定"
7. 重复配置 expiryMonitor
```

---

## 📋 阶段5: 编译测试验证（5分钟）⭐⭐⭐

### 5.1 编译项目
```
1. 点击顶部：编译
2. 等待编译完成
3. 查看控制台无错误
```

### 5.2 功能测试清单

#### ✅ 测试1: 首页数据加载
```
操作: 进入首页
预期: 
  - 今日数据显示正常
  - 入库单/出库单数量显示
  - 药品种类显示
  - 库存预警显示
  - 无 "$ is not defined" 错误
```

#### ✅ 测试2: 药品选择器
```
操作: 
  1. 点击"药品入库"
  2. 点击"添加药品"
  3. 搜索"阿莫"
预期:
  - 显示药品列表
  - 可以选择药品
```

#### ✅ 测试3: 门诊用药登记
```
操作:
  1. 点击"门诊用药"
  2. 选择园区
  3. 添加药品
  4. 输入用量
预期:
  - 园区选择正常
  - 药品选择正常
  - 单位换算正常
  - 保存成功
```

#### ✅ 测试4: 报表查询
```
操作:
  1. 点击"报表中心"
  2. 选择任意报表
  3. 点击"查询"
预期:
  - 报表数据显示
  - 图表渲染正常
  - 可以导出Excel
```

---

## 📊 部署进度总览

### 云函数部署进度
```
核心功能 (12个):
□□□□□□□□□□□□ 0/12 (0%)

辅助功能 (9个):
□□□□□□□□□ 0/9 (0%)

总进度: 0/21 (0%)
```

### 数据库创建进度
```
核心业务 (7个):
□□□□□□□ 0/7 (0%)

系统功能 (5个):
□□□□□ 0/5 (0%)

总进度: 0/12 (0%)
```

### 定时任务配置进度
```
□ dailySummary 触发器
□ expiryMonitor 触发器

总进度: 0/2 (0%)
```

### 功能测试进度
```
□ 首页数据加载
□ 药品选择器
□ 门诊用药登记
□ 报表查询

总进度: 0/4 (0%)
```

---

## ⚠️ 常见问题速查

### Q1: 找不到"云开发"按钮？
```
解决:
1. 确认已登录微信开发者工具
2. 确认项目已开通云开发
3. 尝试：工具 → 云开发
```

### Q2: 上传云函数失败？
```
解决:
1. 检查网络连接
2. 关闭VPN/代理
3. 重启微信开发者工具
4. 重新上传
```

### Q3: 部署成功但还是报错？
```
解决:
1. 点击"编译"重新编译
2. 清除缓存：工具 → 清除缓存
3. 等待1-2分钟
4. 查看云函数日志
```

### Q4: 数据库集合创建失败？
```
解决:
1. 检查集合名称是否符合规范
2. 检查环境配额是否已满
3. 刷新页面重试
```

### Q5: 触发器配置不生效？
```
解决:
1. 确认Cron表达式正确
2. 手动触发测试
3. 查看云函数日志
```

---

## 🎯 部署检查清单

### 部署前准备
- [x] 微信开发者工具已安装
- [x] 已登录微信开发者账号
- [x] 项目已在工具中打开
- [x] 已开通云开发服务
- [ ] 准备开始部署

### 阶段1: 紧急修复
- [ ] stockManage 已上传
- [ ] 部署成功
- [ ] 首页正常显示

### 阶段2: 云函数部署
- [ ] drugManage 已部署
- [ ] inRecords 已部署
- [ ] outRecords 已部署
- [ ] clinicRecords 已部署
- [ ] reportService 已部署
- [ ] queryService 已部署
- [ ] 其他核心云函数已部署

### 阶段3: 数据库创建
- [ ] drugs 已创建
- [ ] stock 已创建
- [ ] in_records 已创建
- [ ] out_records 已创建
- [ ] clinic_usage 已创建
- [ ] 其他集合已创建
- [ ] 权限已配置

### 阶段4: 触发器配置
- [ ] dailySummary 触发器已配置
- [ ] expiryMonitor 触发器已配置

### 阶段5: 测试验证
- [ ] 编译成功
- [ ] 首页测试通过
- [ ] 药品选择器测试通过
- [ ] 门诊登记测试通过
- [ ] 报表查询测试通过

---

## 📚 相关文档索引

### 快速开始
- 📄 `🎯【第一步】立即上传stockManage.txt` - 紧急修复指南
- 📄 `🚨必看-部署云函数3步.txt` - 简化版指南

### 详细指南
- 📄 `🚀【立即执行】完整部署方案.md` - 完整部署流程
- 📄 `📋云函数批量部署清单.txt` - 云函数清单
- 📄 `🗄️数据库创建指南.txt` - 数据库指南

### 项目文档
- 📄 `📊项目状态总览.md` - 项目概况
- 📄 `🎉AK-PMS_v3.4_最终完成报告.md` - 完成报告
- 📄 `AK-PMS_v3.3_技术栈与实现说明.md` - 技术文档

---

## 🎊 部署完成后

### 立即可用的功能
```
✅ 药品档案管理
✅ 入库管理（扫码+手动）
✅ 出库管理（园区领用+FIFO批次）
✅ 门诊用药登记（分园区+单位换算）
✅ 库存查询（实时+预警）
✅ 报表中心（5大报表+6项查询）
✅ 数据可视化（3种图表）
✅ Excel导出
✅ 每日统计（自动）
✅ 效期预警（自动）
```

### 下一步工作
```
1. 📊 导入测试数据
   - 药品清单
   - 用户账号
   
2. 🧪 全面功能测试
   - 入库流程
   - 出库流程
   - 门诊登记
   - 报表查询
   
3. 👥 用户培训
   - 操作培训
   - 答疑解惑
   
4. 🚀 正式上线
   - 切换到生产环境
   - 修改权限配置
   - 开始正式使用
```

---

## 📝 部署记录表

```
部署日期: ___________
部署人员: ___________
开始时间: ___________
结束时间: ___________
总耗时:   ___________

部署结果:
□ 全部成功
□ 部分成功
□ 失败

遇到的问题:
_______________________________________
_______________________________________
_______________________________________

解决方案:
_______________________________________
_______________________________________
_______________________________________

备注:
_______________________________________
_______________________________________
_______________________________________
```

---

## 🎯 现在开始部署！

### 第一步（最重要）
```
📄 打开: 🎯【第一步】立即上传stockManage.txt
⏱️ 时间: 2分钟
🎯 目标: 修复首页错误
```

### 第二步
```
📄 参考: 📋云函数批量部署清单.txt
⏱️ 时间: 15分钟
🎯 目标: 部署核心云函数
```

### 第三步
```
📄 参考: 🗄️数据库创建指南.txt
⏱️ 时间: 8分钟
🎯 目标: 创建数据库集合
```

### 第四步
```
⏱️ 时间: 3分钟
🎯 目标: 配置定时触发器
```

### 第五步
```
⏱️ 时间: 5分钟
🎯 目标: 编译测试验证
```

---

**预计总耗时**: 30-40分钟  
**成功率**: 95%+  
**难度**: ⭐⭐⭐☆☆

**🎉 30分钟后，系统就能完整运行了！现在就开始吧！🎉**

---

**AK-PMS 药品管理系统**  
**版本**: v3.4 Enhanced Edition  
**部署指南版本**: v1.0  
**最后更新**: 2025-11-03

