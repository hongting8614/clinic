# 📊 药材盘点表功能设计文档

> **系统**: 爱康医务室药材管理系统  
> **模块**: 药材盘点管理  
> **版本**: v1.0  
> **设计时间**: 2025-10-31

---

## 🎯 功能概述

在小程序中实现药材盘点表功能，支持月度盘点、实时统计、效期预警等功能，提供Excel风格的表格界面。

---

## 📋 页面设计

### 一、药材盘点列表页

#### 页面路径
`pages-sub/inventory/list.vue`

#### 功能模块

##### 1. 顶部筛选区
```
┌─────────────────────────────────────┐
│  📅 2025年10月  🔽   🔍 搜索药材     │
│  [陆园] [水园] [全部]  📊 导出报表   │
└─────────────────────────────────────┘
```

- **月份选择器**：选择盘点月份
- **园区切换**：陆园、水园、全部
- **搜索框**：按药材名称搜索
- **导出按钮**：导出为Excel

##### 2. 统计卡片区
```
┌────────┬────────┬────────┬────────┐
│ 药材总数 │ 本月入库 │ 本月出库 │ 本月实存 │
│   39   │   50   │   28   │   61   │
└────────┴────────┴────────┴────────┘
┌────────┬────────┬────────┬────────┐
│ 过期药材 │ 近效期  │ 低库存  │ 盘点进度 │
│   2    │   5    │   3    │  85%   │
└────────┴────────┴────────┴────────┘
```

##### 3. 表格区域

**横向滚动表格（Excel风格）**

```
┌──────────────────────────────────────────────────────────────┐
│ 序号 │ 药材名称    │ 规格      │ 有效期    │ 上月结存 │ ... │
├──────┼────────────┼──────────┼──────────┼─────────┼─────┤
│  1   │ 碘伏       │ 500ml/瓶  │ 2026-06  │ 9 瓶     │ ... │
│      │            │           │ 🟢 正常   │          │     │
├──────┼────────────┼──────────┼──────────┼─────────┼─────┤
│  2   │ 阿莫西林   │ 100粒/盒  │ 2025-11  │ 5 盒     │ ... │
│      │            │           │ 🟡 近效期 │          │     │
├──────┼────────────┼──────────┼──────────┼─────────┼─────┤
│  3   │ 创可贴     │ 100片/盒  │ 2024-10  │ 2 盒     │ ... │
│      │            │           │ 🔴 已过期 │          │     │
└──────┴────────────┴──────────┴──────────┴─────────┴─────┘
```

**完整列定义**：
1. 序号
2. 药材名称
3. 规格
4. 有效期（含状态标识）
5. 上月结存（数量+单位）
6. 本月入库数
7. 本月出库数
8. 本月损耗数
9. 本月实存数
10. 操作（查看详情/盘点）

##### 4. 行操作
- **点击行**：展开详情
- **左滑**：显示"盘点"、"详情"按钮
- **长按**：批量选择模式

##### 5. 底部操作栏
```
┌─────────────────────────────────────┐
│  📋 新建盘点  |  📤 批量导入  |  💾 保存 │
└─────────────────────────────────────┘
```

---

### 二、药材盘点详情页

#### 页面路径
`pages-sub/inventory/detail.vue`

#### 详情卡片设计

```
┌─────────────────────────────────────┐
│  📦 药材基本信息                      │
├─────────────────────────────────────┤
│  药材名称：阿莫西林胶囊                │
│  规格：100粒/盒                       │
│  包装单位：盒  最小单位：粒             │
│  换算系数：1盒 = 100粒                 │
│  生产厂家：XX制药                      │
│  批号：20241015                       │
│  有效期：2025-11-30 🟡 近效期（3个月内）│
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📊 库存统计（陆园）                  │
├─────────────────────────────────────┤
│  上月结存：5 盒 (500 粒)              │
│  本月入库：10 盒 (1000 粒)            │
│  本月出库：1 盒 (100 粒)              │
│  本月损耗：0 盒                       │
│  理论库存：14 盒 (1400 粒)            │
│  实际盘点：_____ 盒 _____ 粒  [录入] │
│  盈亏情况：_____ 盒 _____ 粒          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📝 盘点记录                          │
├─────────────────────────────────────┤
│  盘点人：张三                         │
│  盘点时间：2025-10-31 14:30          │
│  实盘数量：13.5 盒 (1350 粒)         │
│  盈亏：-0.5 盒 (-50 粒)              │
│  备注：[                        ]     │
│                                      │
│  [📷 拍照上传] [✍️ 签名确认]          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📜 本月出入库明细（可点击查看原单）   │
├─────────────────────────────────────┤
│  📥 入库记录（1条）                   │
│  10-05  入库   +10盒   批号:202410   │
│          单号:IN20251005001 →       │
│                                      │
│  📤 园区领用（1条）                   │
│  10-18  领用   -1盒    陆园          │
│          单号:OUT20251018001 →      │
│                                      │
│  💊 门诊用药（3条）                   │
│  10-12  门诊   -20粒   用药人:李四   │
│          单号:CLINIC20251012001 →   │
│  10-15  门诊   -15粒   用药人:王五   │
│  10-20  门诊   -15粒   用药人:赵六   │
│                                      │
│  📊 日消耗（2条）                     │
│  10-25  消耗   -30粒   陆园          │
│          单号:CONSUME20251025001 →  │
│  10-28  消耗   -20粒   陆园          │
│                                      │
│  [查看完整明细]                      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📈 库存计算过程                      │
├─────────────────────────────────────┤
│  上月结存:        5.00 盒            │
│  + 本月入库:     10.00 盒            │
│  - 园区领用:      1.00 盒            │
│  - 门诊用药:      0.50 盒 (50粒)    │
│  - 日消耗:        0.30 盒 (30粒)    │
│  ═══════════════════════════════     │
│  = 理论库存:     13.20 盒 (1320粒)  │
│                                      │
│  实际盘点:       13.50 盒 (1350粒)  │
│  ───────────────────────────────     │
│  盈亏情况:       +0.30 盒 (+30粒) 🟢 │
│  盈亏原因: [上月有遗漏未录入]        │
└─────────────────────────────────────┘
```

---

### 三、快速盘点页面

#### 页面路径
`pages-sub/inventory/quick.vue`

#### 扫码盘点模式

```
┌─────────────────────────────────────┐
│           📱 快速盘点模式              │
├─────────────────────────────────────┤
│                                      │
│         [扫描药材条形码]              │
│                                      │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  │        📷 扫描区域              │ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  或 [手动输入药材名称]               │
│                                      │
├─────────────────────────────────────┤
│  阿莫西林胶囊  100粒/盒               │
│                                      │
│  理论库存：14 盒 (1400 粒)           │
│                                      │
│  实盘数量：                          │
│  ┌──────┐  ┌──────────────┐        │
│  │  13  │盒│   50         │粒      │
│  └──────┘  └──────────────┘        │
│   [- 1盒 +]  [- 10粒 +]             │
│                                      │
│  盈亏：-0.5 盒 (-50 粒) 🔴           │
│                                      │
│  备注：[瓶身破损，漏洒约50粒]         │
│                                      │
│  [📷 拍照] [下一个] [保存并继续]     │
└─────────────────────────────────────┘
```

---

### 四、盘点报表页

#### 页面路径
`pages-sub/inventory/report.vue`

#### 月度盘点报表

```
┌─────────────────────────────────────┐
│  📊 2025年10月药材盘点报表            │
│  园区：陆园  盘点人：张三              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📈 盘点汇总                          │
├─────────────────────────────────────┤
│  盘点药材：39 种                      │
│  盘点完成：33 种 (85%)                │
│  盈亏情况：                           │
│    盘盈：5 种  价值：¥120             │
│    盘亏：3 种  价值：¥85              │
│  异常情况：                           │
│    过期药材：2 种                     │
│    近效期：5 种                       │
│    低库存：3 种                       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📋 盘亏明细                          │
├─────────────────────────────────────┤
│  1. 阿莫西林胶囊                      │
│     盘亏：-0.5盒 (-50粒)  ¥30        │
│     原因：瓶身破损漏洒                 │
│                                      │
│  2. 创可贴                           │
│     盘亏：-2盒  ¥40                  │
│     原因：未登记使用                   │
│                                      │
│  3. 碘伏                             │
│     盘亏：-1瓶  ¥15                  │
│     原因：自然挥发                     │
│                                      │
│  [查看更多]                          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  ✍️ 签名确认                          │
├─────────────────────────────────────┤
│  盘点人：张三    签名：[_______]      │
│  复核人：李四    签名：[_______]      │
│  日期：2025-10-31                    │
│                                      │
│  [📤 导出Excel] [📧 发送邮件] [✅ 完成]│
└─────────────────────────────────────┘
```

---

## 🎨 UI/UX 设计规范

### 颜色方案

#### 状态颜色
- **正常**：🟢 绿色 `#10b981`
- **近效期（6个月内）**：🟡 黄色 `#f59e0b`
- **近效期（3个月内）**：🟠 橙色 `#f97316`
- **已过期**：🔴 红色 `#ef4444`
- **盘盈**：🟢 绿色 `#10b981`
- **盘亏**：🔴 红色 `#ef4444`

#### 表格配色
- **表头背景**：渐变蓝绿 `linear-gradient(135deg, #667eea 0%, #764ba2 100%)`
- **奇数行**：白色 `#ffffff`
- **偶数行**：浅灰 `#f9fafb`
- **选中行**：浅蓝 `#eff6ff`
- **边框**：灰色 `#e5e7eb`

### 表格交互

#### 1. 横向滚动表格
```vue
<scroll-view 
  scroll-x 
  class="table-scroll"
  :scroll-left="scrollLeft"
>
  <!-- 表格内容 -->
</scroll-view>
```

#### 2. 固定第一列
- 使用 `position: sticky` 固定序号和药材名称列
- 滚动时保持可见

#### 3. 单元格编辑
- 双击单元格进入编辑模式
- 自动保存修改
- 显示保存状态图标

#### 4. 行操作
- **点击行**：展开/收起详情
- **左滑**：显示操作按钮
- **长按**：进入批量选择模式

### 响应式设计

#### 竖屏模式（默认）
- 表格横向滚动
- 显示核心列（序号、名称、有效期、实存数）
- 其他列滚动查看

#### 横屏模式
- 显示更多列
- 扩大单元格尺寸
- 优化输入体验

---

## 💾 数据结构设计

### 盘点记录数据结构

```javascript
{
  _id: '盘点记录ID',
  inventoryNo: 'INV202510001',      // 盘点单号
  date: '2025-10-31',                // 盘点日期
  month: '2025-10',                  // 盘点月份
  location: 'land_park',             // 园区
  locationName: '陆园',
  status: 'in_progress',             // 状态：in_progress/completed/confirmed
  
  items: [{
    drugId: '药材ID',
    drugName: '阿莫西林胶囊',
    spec: '100粒/盒',
    packUnit: '盒',                  // 包装单位
    minUnit: '粒',                   // 最小单位
    conversionRate: 100,             // 换算系数
    
    batch: '202410001',              // 批号
    expireDate: '2025-11-30',        // 有效期
    expireStatus: 'near_expiry',     // 效期状态
    
    // 库存数据（包装单位） - 自动从系统记录计算
    lastMonthStock: 5,               // 上月结存（来自上月盘点）
    monthInbound: 10,                // 本月入库（来自 in_records）
    monthOutbound: 1,                // 本月出库（来自 out_records 园区领用）
    monthClinic: 0.5,                // 本月门诊（来自 clinic_records）
    monthConsume: 0.3,               // 本月日消耗（来自 consume_records）
    monthLoss: 0,                    // 本月损耗（手动录入）
    theoreticalStock: 14.2,          // 理论库存 = 上月结存 + 本月入库 - 本月出库 - 门诊 - 日消耗 - 损耗
    
    // 明细记录关联 ⭐ 新增
    inboundRecords: [                // 本月入库记录ID
      {
        recordId: 'IN20251005001',
        date: '2025-10-05',
        quantity: 10,
        batch: '202410001'
      }
    ],
    outboundRecords: [               // 本月出库记录ID
      {
        recordId: 'OUT20251018001',
        date: '2025-10-18',
        quantity: 1,
        location: 'land_park'
      }
    ],
    clinicRecords: [                 // 本月门诊用药记录
      {
        recordId: 'CLINIC20251012001',
        date: '2025-10-12',
        quantityMin: 50,
        quantityPack: 0.5,
        patient: '李四'
      }
    ],
    consumeRecords: [                // 本月日消耗记录
      {
        recordId: 'CONSUME20251025001',
        date: '2025-10-25',
        quantityMin: 30,
        quantityPack: 0.3,
        location: 'land_park'
      }
    ],
    
    // 盘点数据
    actualStockPack: 13.5,           // 实盘数量（包装单位）
    actualStockMin: 1350,            // 实盘数量（最小单位）
    profitLossPack: -0.7,            // 盈亏（包装单位）= 实盘 - 理论
    profitLossMin: -70,              // 盈亏（最小单位）
    profitLossAmount: -42,           // 盈亏金额
    
    reason: '瓶身破损漏洒',           // 盈亏原因
    photos: ['图片URL'],             // 现场照片
    remark: '备注'
  }],
  
  // 统计数据
  summary: {
    totalDrugs: 39,                  // 总药材数
    completedDrugs: 33,              // 已盘点数
    completionRate: 0.85,            // 完成率
    profitDrugs: 5,                  // 盘盈种类
    profitAmount: 120,               // 盘盈金额
    lossDrugs: 3,                    // 盘亏种类
    lossAmount: 85,                  // 盘亏金额
    expiredDrugs: 2,                 // 过期药材
    nearExpiryDrugs: 5,              // 近效期药材
    lowStockDrugs: 3                 // 低库存药材
  },
  
  // 签名确认
  operator: '张三',                  // 盘点人
  operatorSignature: '签名图片URL',
  reviewer: '李四',                  // 复核人
  reviewerSignature: '签名图片URL',
  
  createTime: '2025-10-31 14:30:00',
  updateTime: '2025-10-31 16:45:00',
  confirmTime: '2025-10-31 17:00:00'
}
```

---

## 🔧 技术实现

### 云函数

#### inventoryRecords 云函数
```javascript
// 核心方法
- create()              // 创建盘点单
- getList()            // 获取盘点列表
- getDetail()          // 获取盘点详情
- update()             // 更新盘点数据
- quickInventory()     // 快速盘点
- confirm()            // 确认完成
- exportExcel()        // 导出Excel
- getReport()          // 获取报表
- calculateTheoretical() // 计算理论库存 ⭐ 核心
- getMonthRecords()    // 获取本月出入库记录 ⭐ 新增
- syncWithStock()      // 同步当前库存 ⭐ 新增
```

#### calculateTheoretical() 详细实现 ⭐

```javascript
/**
 * 计算理论库存
 * 从各个业务模块汇总数据
 */
async calculateTheoretical(drugId, location, month) {
  const db = cloud.database();
  const _ = db.command;
  
  // 1. 获取上月盘点结存（如果没有，则取当前库存）
  const lastMonthInventory = await db.collection('inventory_records')
    .where({
      drugId: drugId,
      location: location,
      month: getLastMonth(month),
      status: 'confirmed'
    })
    .get();
  
  const lastMonthStock = lastMonthInventory.data[0]?.actualStockPack || 0;
  
  // 2. 查询本月入库记录（in_records）
  const startDate = `${month}-01`;
  const endDate = `${month}-31`;
  
  const inboundRecords = await db.collection('in_records')
    .where({
      drugId: drugId,
      createTime: _.gte(startDate).and(_.lte(endDate)),
      status: 'confirmed'  // 已复核的入库单
    })
    .get();
  
  const monthInbound = inboundRecords.data.reduce((sum, record) => {
    return sum + record.items.find(item => item.drugId === drugId)?.quantity || 0;
  }, 0);
  
  // 3. 查询本月园区领用（out_records）
  const outboundRecords = await db.collection('out_records')
    .where({
      location: location,
      createTime: _.gte(startDate).and(_.lte(endDate)),
      status: 'completed'
    })
    .get();
  
  let monthOutbound = 0;
  outboundRecords.data.forEach(record => {
    const item = record.items.find(i => i.drugId === drugId);
    if (item) monthOutbound += item.quantityPack;
  });
  
  // 4. 查询本月门诊用药（clinic_records）
  const clinicRecords = await db.collection('clinic_records')
    .where({
      drugId: drugId,
      createTime: _.gte(startDate).and(_.lte(endDate))
    })
    .get();
  
  const monthClinic = clinicRecords.data.reduce((sum, record) => {
    return sum + (record.quantityPack || 0);
  }, 0);
  
  // 5. 查询本月日消耗（consume_records）
  const consumeRecords = await db.collection('consume_records')
    .where({
      location: location,
      startDate: _.gte(startDate),
      endDate: _.lte(endDate)
    })
    .get();
  
  let monthConsume = 0;
  consumeRecords.data.forEach(record => {
    record.items.forEach(item => {
      if (item.drugId === drugId) {
        monthConsume += item.quantityPack;
      }
    });
  });
  
  // 6. 计算理论库存
  const theoreticalStock = lastMonthStock + monthInbound - monthOutbound - monthClinic - monthConsume;
  
  // 7. 返回详细数据
  return {
    drugId,
    location,
    month,
    lastMonthStock,           // 上月结存
    monthInbound,             // 本月入库
    monthOutbound,            // 本月出库
    monthClinic,              // 本月门诊
    monthConsume,             // 本月日消耗
    theoreticalStock,         // 理论库存
    
    // 明细记录
    inboundRecords: inboundRecords.data.map(r => ({
      recordId: r._id,
      date: r.createTime,
      quantity: r.items.find(i => i.drugId === drugId)?.quantity
    })),
    outboundRecords: outboundRecords.data.map(r => ({
      recordId: r._id,
      date: r.createTime,
      quantity: r.items.find(i => i.drugId === drugId)?.quantityPack,
      location: r.location
    })),
    clinicRecords: clinicRecords.data.map(r => ({
      recordId: r._id,
      date: r.createTime,
      quantityMin: r.quantityMin,
      quantityPack: r.quantityPack,
      patient: r.patient
    })),
    consumeRecords: consumeRecords.data.flatMap(r => 
      r.items
        .filter(i => i.drugId === drugId)
        .map(i => ({
          recordId: r._id,
          date: r.createTime,
          quantityMin: i.quantityMin,
          quantityPack: i.quantityPack,
          location: r.location
        }))
    )
  };
}
```

### 前端页面

#### 1. 盘点列表页
- `pages-sub/inventory/list.vue`
- 表格组件：`components/InventoryTable.vue`
- 筛选组件：`components/InventoryFilter.vue`

#### 2. 盘点详情页
- `pages-sub/inventory/detail.vue`
- 统计卡片：`components/InventoryStats.vue`
- 明细列表：`components/InventoryDetail.vue`

#### 3. 快速盘点页
- `pages-sub/inventory/quick.vue`
- 扫码组件：`components/Scanner.vue`
- 输入组件：`components/InventoryInput.vue`

#### 4. 盘点报表页
- `pages-sub/inventory/report.vue`
- 报表组件：`components/InventoryReport.vue`
- 签名组件：`components/Signature.vue`

---

## 📱 功能流程

### 月度盘点流程

```
1. 创建盘点单
   → 选择月份、园区
   → 系统自动生成盘点单
   → 🔗 自动关联业务数据：
      • 从上月盘点获取期初库存
      • 汇总本月入库记录（in_records）
      • 汇总本月园区领用（out_records）
      • 汇总本月门诊用药（clinic_records）
      • 汇总本月日消耗（consume_records）
   → 自动计算理论库存
   → 显示明细记录列表（可点击查看原单）

2. 执行盘点
   方式A：表格模式
   → 查看盘点列表
   → 查看每个药材的出入库明细
   → 逐行录入实盘数据
   → 系统自动计算盈亏
   → 点击明细记录可跳转查看原单
   
   方式B：快速盘点模式
   → 扫码识别药材
   → 显示本月出入库汇总
   → 显示理论库存
   → 录入实盘数量
   → 实时显示盈亏
   → 拍照记录
   → 自动保存

3. 盈亏分析
   → 查看盈亏明细
   → 对比出入库记录
   → 追溯异常操作
   → 填写盈亏原因
   → 拍照留证
   → 审批确认

4. 签名确认
   → 盘点人签名
   → 复核人签名
   → 完成盘点
   → 盘点结果作为下月期初库存

5. 生成报表
   → 查看汇总数据
   → 查看明细追溯
   → 导出Excel（含出入库明细）
   → 发送邮件
```

---

## 🔗 数据关联关系图

### 盘点与业务模块的关联

```
                    [上月盘点] 
                        ↓
                   期初库存
                        ↓
         ┌──────────────┴──────────────┐
         │                             │
    [本月业务数据]              [当前库存]
         │                             │
    ┌────┴────┐                        │
    │         │                        │
 入库记录   出库记录                    │
    │         │                        │
    │    ┌────┴────┐                   │
    │    │         │                   │
    │  园区领用  门诊用药              │
    │    │         │                   │
    │    │    ┌────┴────┐              │
    │    │    │         │              │
    │    │    │     日消耗             │
    │    │    │         │              │
    └────┴────┴─────────┴──────────────┤
                                       │
                              理论库存计算
                                       │
                    理论库存 = 期初 + 入库 - 出库 - 门诊 - 日消耗
                                       │
                                       ↓
                              ┌────────┴────────┐
                              │                 │
                         实际盘点          当前库存
                              │                 │
                              └────────┬────────┘
                                       │
                                   盈亏分析
                                       │
                         盈亏 = 实盘 - 理论
                                       │
                                       ↓
                              ┌────────┴────────┐
                              │                 │
                          盘盈处理          盘亏处理
                              │                 │
                         补充说明          查找原因
                                       │
                                       ↓
                              签名确认完成
                                       │
                                       ↓
                          作为下月期初库存
```

### 数据可追溯性

**1. 正向追溯**
```
盘点记录 → 查看明细 → 点击记录 → 跳转原单

示例：
盘点发现阿莫西林盘亏0.5盒
→ 查看本月出入库明细
→ 发现10-12有门诊用药20粒
→ 点击查看 CLINIC20251012001
→ 查看用药人、时间、签名
```

**2. 反向追溯**
```
原单记录 → 关联盘点 → 查看影响

示例：
查看入库单 IN20251005001
→ 查看"关联盘点"
→ 显示10月盘点中该批次的去向
→ 查看库存流转
```

---

## 💡 数据一致性保证

### 1. 数据同步机制

**自动同步时机**：
- 创建盘点单时：同步最新业务数据
- 刷新页面时：重新计算理论库存
- 完成盘点后：更新下月期初库存

**同步范围**：
```javascript
// 同步本月数据
{
  入库记录: in_records (status='confirmed'),
  园区领用: out_records (location=当前园区, status='completed'),
  门诊用药: clinic_records (createTime=本月),
  日消耗: consume_records (location=当前园区, date=本月)
}
```

### 2. 数据验证

**创建盘点单时**：
```
✓ 检查是否有未完成的盘点
✓ 检查上月盘点是否已确认
✓ 检查本月业务数据完整性
✓ 验证库存数据准确性
```

**确认盘点时**：
```
✓ 所有药材必须已盘点
✓ 盈亏原因必须填写（盈亏≠0时）
✓ 双人签名必须完成
✓ 照片证据必须上传（盈亏较大时）
```

### 3. 异常处理

**盈亏过大警告**：
```
if (Math.abs(盈亏) > 理论库存 * 0.1) {
  显示警告："盈亏超过10%，请仔细核对！"
  必须填写详细说明
  必须上传现场照片
  需要管理员审批
}
```

**数据不一致提示**：
```
if (当前库存 != 理论库存 && 无盘点记录) {
  提示："检测到库存数据异常，建议立即盘点"
  显示差异明细
  提供一键创建盘点单
}
```

---

## ✨ 特色功能

### 1. 智能计算
- 自动计算理论库存
- 自动换算单位（包装单位 ↔ 最小单位）
- 自动计算盈亏数量和金额

### 2. 效期预警
- 🟢 正常（6个月以上）
- 🟡 近效期（3-6个月）
- 🟠 即将过期（3个月内）
- 🔴 已过期

### 3. 扫码盘点
- 扫描条形码快速定位
- 自动加载药材信息
- 显示理论库存
- 快速录入实盘数据

### 4. 拍照留证
- 现场拍照记录
- 支持多图上传
- 图片压缩优化
- 云端存储

### 5. 电子签名
- 盘点人签名
- 复核人签名
- 签名图片保存
- 防篡改

### 6. Excel导出
- 一键导出盘点报表
- 标准Excel格式
- 包含所有明细
- 支持打印

---

## 📊 报表示例

### Excel导出格式

```
                    2025年10月药材盘点报表
                        陆园医务室

序号 | 药材名称 | 规格 | 有效期 | 上月结存 | 本月入库 | 本月出库 | 理论库存 | 实盘数量 | 盈亏 | 备注
-----|---------|------|--------|---------|---------|---------|---------|---------|------|-----
  1  | 阿莫西林 | 100粒/盒 | 2025-11 | 5盒 | 10盒 | 1盒 | 14盒 | 13.5盒 | -0.5盒 | 瓶身破损
  2  | 创可贴   | 100片/盒 | 2026-07 | 13盒 | 0盒  | 2盒 | 11盒 | 11盒   | 0盒    | 
  3  | 碘伏     | 500ml/瓶 | 2026-06 | 9瓶  | 0瓶  | 0瓶 | 9瓶  | 8瓶    | -1瓶   | 自然挥发
...

盘点汇总：
总药材数：39 种
盘点完成：33 种 (85%)
盘盈：5 种  ¥120
盘亏：3 种  ¥85

盘点人：张三  签名：______    日期：2025-10-31
复核人：李四  签名：______    日期：2025-10-31
```

---

## 🎯 后续优化

### 1. 智能预测
- 基于历史数据预测库存
- 智能提示异常波动
- 自动推荐采购量

### 2. 语音录入
- 支持语音输入数量
- 提高盘点效率

### 3. 多人协作
- 支持多人同时盘点
- 实时同步数据
- 进度可视化

### 4. AI识别
- 图片识别药材
- 自动读取批号
- 智能识别有效期

---

## 📝 总结

此药材盘点表功能设计：
- ✅ 完整的盘点流程
- ✅ Excel风格表格
- ✅ 单位自动换算
- ✅ 效期智能预警
- ✅ 扫码快速盘点
- ✅ 电子签名确认
- ✅ 一键导出报表
- ✅ **数据完全关联** ⭐⭐⭐ 核心亮点

### 🔗 数据关联核心价值

#### 1. 全流程追溯
```
每一笔盘点盈亏都能追溯到具体的：
• 哪天入库的？（入库单号）
• 谁领用的？（领用记录）
• 哪个患者用的？（门诊记录）
• 哪天消耗的？（日消耗记录）
```

#### 2. 自动计算理论库存
```
系统自动汇总：
上月结存 + 本月入库 - 本月出库 - 门诊用药 - 日消耗 = 理论库存

无需手工计算，避免人为错误！
```

#### 3. 盈亏原因可查
```
盘亏 0.5盒 → 点击查看明细
→ 发现10-12门诊用药20粒
→ 点击跳转到门诊记录
→ 查看是谁用的、何时用的
```

#### 4. 数据一致性保证
```
• 盘点数据来源于真实业务记录
• 支持双向追溯（盘点→原单，原单→盘点）
• 异常数据自动预警
• 大额盈亏强制审批
```

#### 5. 月度闭环管理
```
本月盘点确认 → 自动成为下月期初 → 形成完整闭环
```

### 🎯 与其他系统的区别

| 对比项 | 传统Excel | 普通系统 | 本系统 ⭐ |
|--------|-----------|---------|----------|
| 理论库存 | 手工计算 | 显示数值 | **自动汇总+明细追溯** |
| 盈亏分析 | 无法追溯 | 显示差异 | **点击查看原单** |
| 数据关联 | ❌ 无 | ⚠️ 部分 | **✅ 完全关联** |
| 单位换算 | ❌ 手工 | ⚠️ 单一 | **✅ 双单位自动换算** |
| 可追溯性 | ❌ 无 | ⚠️ 有限 | **✅ 全流程追溯** |

满足医务室月度盘点需求，提高盘点效率，确保数据准确性！🎉

**关键创新**：盘点不再是孤立的数据记录，而是与入库、出库、门诊、日消耗全面关联的数据闭环系统！

