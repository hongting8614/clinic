# 🏠 首页快捷入口设计文档

> **系统**: 爱康医务室药材管理系统  
> **模块**: 首页快捷功能  
> **版本**: v1.0  
> **设计时间**: 2025-10-31

---

## 🎯 设计目标

将**门诊用药登记**等高频功能放在首页显著位置，实现快速访问和操作，提升医务人员工作效率。

---

## 📱 首页布局设计

### 整体结构

```
┌─────────────────────────────────────┐
│  🏥 爱康医务室药材管理系统           │
│  欢乐谷园区 | 👤 张医生              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📊 今日数据概览                      │
├─────────────────────────────────────┤
│  ┌──────┬──────┬──────┬──────┐      │
│  │ 入库 │ 出库 │ 门诊 │ 预警 │      │
│  │  5   │  3   │  12  │  2   │      │
│  └──────┴──────┴──────┴──────┘      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  ⚡ 快捷操作（核心功能区）            │
├─────────────────────────────────────┤
│  ┌────────────┐  ┌────────────┐    │
│  │ 💊 门诊用药 │  │ 📦 快速入库 │    │
│  │   登记     │  │            │    │
│  └────────────┘  └────────────┘    │
│  ┌────────────┐  ┌────────────┐    │
│  │ 📤 园区领用 │  │ 📋 药材盘点 │    │
│  │            │  │            │    │
│  └────────────┘  └────────────┘    │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📱 扫码快捷入口                      │
├─────────────────────────────────────┤
│         [📷 扫描药材条码]             │
│    自动识别并跳转到对应功能            │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  🔥 常用功能                          │
├─────────────────────────────────────┤
│  📊 日消耗统计  |  📈 库存查询        │
│  🔍 药材档案    |  📜 操作记录        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  ⚠️ 预警提醒                          │
├─────────────────────────────────────┤
│  🔴 阿莫西林胶囊 - 已过期             │
│  🟡 创可贴 - 近效期（2个月）          │
│  [查看全部预警]                      │
└─────────────────────────────────────┘
```

---

## 💊 门诊用药登记 - 快捷入口（核心）

### 一、首页入口设计

#### 大卡片样式
```
┌─────────────────────────────────────┐
│  💊 门诊用药登记                      │
│                                      │
│     [点击快速登记]                    │
│                                      │
│  今日已登记：12人次                   │
│  最近：感冒灵 x2  李四  10:30        │
└─────────────────────────────────────┘
```

**设计要点**：
- 🎨 **醒目颜色**: 橙色渐变背景 `#f59e0b → #f97316`
- 📏 **大尺寸**: 占首页1/4空间
- 📍 **优先位置**: 快捷操作区第一位
- 💡 **实时数据**: 显示今日登记数
- ⚡ **一键直达**: 点击直接进入登记页

---

### 二、快速登记页面设计

#### 页面路径
`pages-sub/clinic/quick.vue`

#### 页面布局

```
┌─────────────────────────────────────┐
│  ← 门诊用药登记   💊   [历史记录] ✅  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📷 扫码药材 / 手动选择                │
├─────────────────────────────────────┤
│                                      │
│      [扫描药材条码]                   │
│                                      │
│  或 [🔍 搜索药材名称]                 │
│                                      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  🔥 常用药材（快速选择）               │
├─────────────────────────────────────┤
│  [感冒灵] [阿莫西林] [创可贴]         │
│  [碘伏]   [棉签]     [纱布]          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  🏥 所属园区选择 ⭐ 新增               │
├─────────────────────────────────────┤
│  ┌────────────┬────────────┐         │
│  │ ⚫ 陆园     │ ⚪ 水园     │         │
│  └────────────┴────────────┘         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  💊 药材信息（陆园库存）              │
├─────────────────────────────────────┤
│  药材：阿莫西林胶囊                   │
│  规格：100粒/盒                       │
│  陆园库存：14盒 (1400粒) ✅ 充足      │
│  水园库存：8盒 (800粒) ✅ 充足        │
│  批次：20241015  效期：2025-11       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  🔢 用药数量                          │
├─────────────────────────────────────┤
│  单位选择：                           │
│  ┌────────────┬────────────┐         │
│  │ ⚪ 盒（包装）│ ⚫ 粒（最小）│         │
│  └────────────┴────────────┘         │
│                                      │
│  常用剂量（粒）：                     │
│  [ 1粒 ] [ 2粒 ] [ 3粒 ] [ 6粒 ]     │
│  [ 10粒] [ 20粒] [ 30粒] [自定义]    │
│                                      │
│  当前数量：                           │
│  ┌──────────────────────┐           │
│  │  [-]    20    [+]    │  粒       │
│  └──────────────────────┘           │
│                                      │
│  自动换算：20粒 = 0.2盒              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  👤 患者信息登记                      │
├─────────────────────────────────────┤
│  姓名：[________________]   必填      │
│                                      │
│  性别：[ ⚫ 男 ]  [ ⚪ 女 ]           │
│                                      │
│  年龄：                               │
│  ┌──────┬──────┬──────┬──────┐      │
│  │ <18岁│18-35岁│36-60岁│ >60岁│      │
│  └──────┴──────┴──────┴──────┘      │
│  或输入具体：[____] 岁                │
│                                      │
│  常用患者快速选择：                   │
│  [ 张三/男/45 ] [ 李四/女/28 ]       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  📝 备注（选填）                      │
│  [__________________________]        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│         [💾 保存] [➕ 保存并继续]      │
└─────────────────────────────────────┘
```

---

### 三、交互优化

#### 1. 快速登记流程 ⭐ 优化
```
扫描药材条码
  ↓
自动识别药材
  ↓
选择园区（陆园/水园） ⭐ 新增
  ↓
显示该园区库存信息
  ↓
选择单位（盒/粒，默认最小单位）
  ↓
输入数量（支持常用剂量快选）
  ↓
验证该园区库存是否充足 ⭐ 新增
  ↓
实时显示单位换算
  ↓
填写患者信息：
  - 姓名（必填，支持常用患者选择）
  - 性别（男/女，大按钮选择）
  - 年龄（年龄段快选/具体输入）
  ↓
点击保存（语音确认"已保存"）
  ↓
扣减对应园区库存 ⭐ 新增
  ↓
自动清空，准备下一个
```

**总耗时目标**：<35秒/人次

#### 2. 单位切换功能 ⭐ 新增
```
┌────────────────────────────────────┐
│  单位选择：                         │
│  ┌────────────┬────────────┐       │
│  │ ⚪ 盒（包装）│ ⚫ 粒（最小）│       │
│  └────────────┴────────────┘       │
│                                     │
│  切换盒：常用数量显示为             │
│  [ 0.5盒 ] [ 1盒 ] [ 2盒 ] [ 3盒 ] │
│                                     │
│  切换粒：常用数量显示为             │
│  [ 1粒 ] [ 2粒 ] [ 3粒 ] [ 6粒 ]   │
│                                     │
│  实时换算：                         │
│  输入20粒 → 显示"= 0.2盒"          │
│  输入0.5盒 → 显示"= 50粒"          │
└────────────────────────────────────┘
```

**智能单位推荐**：
- 默认选择最小单位（更常用）
- 数量≥1包装时，提示"建议切换为盒"
- 根据药材类型自动显示单位名称

#### 3. 常用剂量按钮
```
┌────────────────────────────────────┐
│  根据药材类型和单位自动显示：        │
│                                     │
│  胶囊（粒）：[ 1粒 ] [ 2粒 ] [ 6粒 ]│
│  片剂（片）：[ 1片 ] [ 2片 ] [ 3片 ]│
│  糖浆（ml）：[ 5ml ] [ 10ml ]       │
│  注射（支）：[ 1支 ] [ 2支 ]        │
│  包装（盒）：[ 0.5盒] [ 1盒 ] [ 2盒]│
└────────────────────────────────────┘
```

#### 4. 患者信息登记 ⭐ 新增

**姓名输入**：
```
- 手动输入姓名
- 支持拼音搜索历史患者
- 自动联想补全
```

**性别选择**：
```
大按钮单选：
[ ⚫ 男 ]  [ ⚪ 女 ]
```

**年龄选择**：
```
方式一：快速选择年龄段
┌──────┬──────┬──────┬──────┐
│ <18岁│18-35岁│36-60岁│ >60岁│
└──────┴──────┴──────┴──────┘

方式二：输入具体年龄
[____] 岁
```

**常用患者**：
```
显示最近10次患者
点击自动填充姓名、性别、年龄
[ 张三/男/45 ] [ 李四/女/28 ]
```

#### 4. 连续登记模式
```
保存后：
  ☑ 自动清空药材和数量
  ☑ 保留用药人（同一患者多次用药）
  ☑ 显示"已保存"提示（2秒后消失）
  ☑ 光标自动回到扫码区
  ☑ 语音播报："已保存，继续下一个"
```

---

### 四、特色功能

#### 1. 语音播报 🔊
```javascript
// 操作确认语音
- "扫码成功"
- "库存充足"
- "库存不足，请及时补货"
- "已保存"
- "用药登记完成"
```

#### 2. 震动反馈 📳
```javascript
// 关键操作震动提示
- 扫码成功：短震一次
- 保存成功：短震两次
- 库存不足：长震一次
- 操作错误：短震三次
```

#### 3. 快捷手势
```
- 上滑：查看历史记录
- 下拉：刷新数据
- 左滑：删除当前记录
- 右滑：返回首页
```

#### 4. 智能提示
```
- 库存<10%：🔴 "库存不足，请及时补货"
- 近效期：🟡 "该药品即将过期，请注意"
- 常用剂量：💡 "该药品常用剂量为XX"
- 重复用药：⚠️ "该患者今日已用药，是否继续？"
```

---

## 🎨 UI设计规范

### 配色方案

#### 门诊用药登记专用色
```
主色：橙色系
- 浅橙：#fed7aa
- 标准橙：#f59e0b  
- 深橙：#f97316
- 渐变：linear-gradient(135deg, #f59e0b 0%, #f97316 100%)
```

#### 按钮设计
```
┌────────────────┐
│  常用剂量按钮   │  - 大尺寸：60x60px
│                │  - 圆角：8px
│   [ 2粒 ]      │  - 阴影：0 2px 8px rgba(0,0,0,0.1)
│                │  - 点击动效：scale(0.95)
└────────────────┘

┌────────────────┐
│  保存按钮       │  - 宽度：100%
│                │  - 高度：48px
│  [ 💾 保存 ]   │  - 渐变背景
│                │  - 白色文字
└────────────────┘
```

### 字体大小
```
药材名称：20px bold
规格信息：16px
数量显示：32px bold  ← 特大号，易读
用药人：18px
提示信息：14px
```

### 间距
```
卡片间距：16px
内容间距：12px
按钮间距：8px
```

---

## 📊 数据记录格式

### 门诊用药记录
```javascript
{
  _id: 'CLINIC20251031001',
  drugId: '药材ID',
  drugName: '阿莫西林胶囊',
  spec: '100粒/盒',
  packUnit: '盒',
  minUnit: '粒',
  conversionRate: 100,
  
  batch: '20241015',
  batchId: '批次ID',
  expireDate: '2025-11-30',
  
  // 园区关联 ⭐⭐⭐ 核心新增
  location: 'land_park',        // 所属园区：land_park/water_park
  locationName: '陆园',          // 园区名称
  
  // 用药数量 ⭐ 优化
  inputUnit: 'min',             // 录入单位：pack/min
  inputQuantity: 20,            // 录入数量
  quantityMin: 20,              // 最小单位数量（记录）
  quantityPack: 0.2,            // 包装单位数量（扣库存）
  
  // 患者信息 ⭐ 新增
  patient: {
    name: '李四',               // 患者姓名（必填）
    gender: '男',               // 性别：男/女
    age: 45,                    // 年龄（具体）
    ageRange: '36-60岁',        // 年龄段
    phone: '13800138000'        // 电话（选填）
  },
  
  // 操作信息
  operator: '张医生',           // 登记人
  operatorId: 'DOC001',
  createTime: '2025-10-31 10:30:45',  // 自动记录
  
  // 扫码信息
  scanMethod: 'barcode',        // 录入方式：barcode/manual
  scanTime: '2025-10-31 10:30:40',
  
  remark: '头痛',               // 备注
  
  // 追溯信息（园区库存）⭐ 关联
  stockBeforePark: 14.0,        // 该园区用药前库存
  stockAfterPark: 13.8,         // 该园区用药后库存
  stockOtherPark: 8.0,          // 另一园区库存（仅供参考）
  isQuickEntry: true,           // 是否快捷入口
  
  // 常用患者标记（用于快速选择）
  isFrequentPatient: false,     // 是否常用患者
  visitCount: 1                 // 就诊次数
}
```

---

## 🔧 技术实现

### 云函数方法

#### clinicRecords.quickAdd() ⭐ 更新
```javascript
/**
 * 快速登记门诊用药
 * 支持园区关联，从指定园区扣减库存
 */
async quickAdd(data) {
  const db = cloud.database();
  
  // 1. 验证该园区库存 ⭐ 核心
  const stock = await checkParkStock(
    data.drugId, 
    data.location,      // 指定园区
    data.quantityPack
  );
  
  if (!stock.available) {
    return {
      success: false,
      message: `${data.locationName}库存不足，当前仅剩${stock.quantity}${data.packUnit}`
    };
  }
  
  // 2. 检查重复用药（今日同一患者同一药材）
  const duplicate = await checkDuplicateToday(
    data.patient.name, 
    data.drugId,
    data.location       // 同园区重复检查
  );
  if (duplicate) {
    return {
      success: false,
      needConfirm: true,
      message: '该患者今日在该园区已用过此药，是否继续？'
    };
  }
  
  // 3. 保存记录（包含园区信息）
  const record = await saveClinicRecord({
    ...data,
    stockBeforePark: stock.quantity,
    stockAfterPark: stock.quantity - data.quantityPack
  });
  
  // 4. 扣减该园区库存 ⭐ 核心
  await updateParkStock(
    data.drugId, 
    data.batch, 
    data.location,      // 指定园区
    -data.quantityPack
  );
  
  // 5. 更新患者就诊次数
  await updatePatientVisitCount(data.patient.name);
  
  // 6. 返回成功（包含语音播报文本）
  return {
    success: true,
    recordId: record._id,
    message: '已保存',
    voiceText: `${data.locationName}用药登记完成`,
    stockRemain: stock.quantity - data.quantityPack,
    location: data.locationName
  };
}

/**
 * 检查园区库存
 */
async checkParkStock(drugId, location, quantity) {
  const db = cloud.database();
  
  // 查询该园区的库存
  const stockRecord = await db.collection('stock')
    .where({
      drugId: drugId,
      location: location,
      quantity: db.command.gt(0)
    })
    .orderBy('expireDate', 'asc')  // FIFO
    .get();
  
  if (stockRecord.data.length === 0) {
    return {
      available: false,
      quantity: 0
    };
  }
  
  // 计算该园区总库存
  const totalStock = stockRecord.data.reduce((sum, item) => {
    return sum + item.quantity;
  }, 0);
  
  return {
    available: totalStock >= quantity,
    quantity: totalStock,
    batches: stockRecord.data
  };
}

/**
 * 更新园区库存
 */
async updateParkStock(drugId, batch, location, quantityChange) {
  const db = cloud.database();
  const _ = db.command;
  
  // 更新指定园区的库存
  await db.collection('stock')
    .where({
      drugId: drugId,
      batch: batch,
      location: location
    })
    .update({
      data: {
        quantity: _.inc(quantityChange),
        updateTime: new Date()
      }
    });
}
```

---

## 📱 扫码智能跳转

### 扫码后自动识别
```javascript
// 扫码识别逻辑
function onScanCode(code) {
  // 1. 查询药材信息
  const drug = await getDrugByBarcode(code);
  
  if (!drug) {
    showToast('未找到该药材');
    return;
  }
  
  // 2. 判断用户意图（基于当前位置）
  const currentPage = getCurrentPage();
  
  if (currentPage === 'home') {
    // 首页扫码 → 自动跳转门诊登记
    navigateTo({
      url: '/pages-sub/clinic/quick',
      params: {
        drugId: drug._id,
        autoFill: true  // 自动填充药材信息
      }
    });
  }
  
  // 3. 自动加载药材信息
  loadDrugInfo(drug);
  
  // 4. 焦点移到数量输入
  focusQuantityInput();
}
```

---

## ⚡ 性能优化

### 1. 常用数据预加载
```javascript
// 进入首页时预加载
onLoad() {
  // 预加载常用药材（top 20）
  preloadFrequentDrugs();
  
  // 预加载常用患者（最近50个）
  preloadFrequentPatients();
  
  // 预加载当前库存状态
  preloadStockStatus();
}
```

### 2. 离线缓存
```javascript
// 缓存策略
{
  常用药材: 缓存24小时,
  常用患者: 缓存12小时,
  库存数据: 缓存5分钟,
  配置信息: 缓存7天
}
```

### 3. 操作响应优化
```javascript
// 乐观更新
async saveRecord(data) {
  // 1. 立即显示"已保存"（乐观）
  showSuccessToast('已保存');
  clearForm();
  
  // 2. 后台保存
  try {
    await api.save(data);
  } catch (err) {
    // 3. 失败时回滚并提示
    showErrorToast('保存失败，请重试');
    restoreForm(data);
  }
}
```

---

## 📈 数据统计

### 门诊用药统计面板
```
┌─────────────────────────────────────┐
│  📊 今日门诊用药统计                  │
├─────────────────────────────────────┤
│  用药人次：12人次                     │
│  用药种类：8种                        │
│  高频药材：                           │
│    1. 感冒灵  5人次                   │
│    2. 阿莫西林 3人次                  │
│    3. 创可贴  2人次                   │
│                                      │
│  用药时段分布：                       │
│  08:00-10:00  ████  4人次            │
│  10:00-12:00  ██████  6人次          │
│  14:00-16:00  ██  2人次              │
│                                      │
│  [查看详细报表]                      │
└─────────────────────────────────────┘
```

---

## 🎯 使用流程示例

### 场景一：陆园患者头痛来拿药 ⭐ 更新

```
1. 医务人员打开小程序
   → 首页显示"门诊用药登记"橙色大卡片
   
2. 点击"门诊用药登记"
   → 进入快速登记页
   
3. 扫描阿莫西林胶囊条码
   → 自动识别药材
   
4. 选择园区 ⭐ 新增
   → 点击"陆园"按钮
   → 显示陆园库存：14盒（1400粒）✅ 充足
   → 显示水园库存：8盒（800粒）✅ 充足
   → 默认选中"粒（最小单位）"
   
5. 选择数量
   → 点击常用剂量"6粒"按钮
   → 自动填充数量：6粒
   → 实时显示换算：6粒 = 0.06盒
   → 验证陆园库存：充足 ✅
   
6. 填写患者信息
   → 姓名：输入"李四"（或点击常用患者）
   → 性别：点击"男"按钮
   → 年龄：点击"36-60岁"（或输入具体年龄45）
   
7. 点击"保存"
   → 扣减陆园库存：14盒 → 13.94盒 ⭐
   → 语音播报："陆园用药登记完成"
   → 震动反馈
   → 自动清空，准备下一个患者
   
总耗时：约30秒 ✅
```

### 场景二：水园库存不足提醒 ⭐ 新增

```
1. 扫描创可贴条码
   
2. 选择"水园"
   → 显示陆园库存：20盒 ✅ 充足
   → 显示水园库存：0.5盒 🟡 库存不足
   
3. 点击"10片"
   → 水园库存：0.5盒 = 50片
   → 提示：🔴 "水园库存不足，最多50片"
   
4. 建议切换园区
   → 提示："建议切换到陆园（库存充足）"
   → 点击"切换到陆园"
   → 自动切换园区
   
5. 从陆园扣减库存并保存
```

### 场景三：常用患者快速登记

```
1. 点击"门诊用药登记"
   
2. 扫描感冒灵条码
   → 自动识别
   
3. 选择"陆园"
   → 显示库存充足
   
4. 点击"10粒"
   
5. 点击常用患者"张三/男/45"
   → 自动填充所有患者信息
   
6. 点击"保存"
   → 扣减陆园库存
   
总耗时：约20秒 ✅（常用患者更快）
```

### 场景四：包装单位录入

```
1. 扫描碘伏条码（500ml/瓶）
   → 默认显示"ml"单位
   
2. 选择"水园"
   → 显示水园库存：5瓶
   
3. 切换到"瓶（包装）"单位
   → 常用剂量变为：[0.5瓶] [1瓶] [2瓶]
   
4. 点击"1瓶"
   → 自动换算：1瓶 = 500ml
   → 验证水园库存：充足 ✅
   
5. 填写患者信息并保存
   → 扣减水园库存：5瓶 → 4瓶
```

---

## 📝 总结

### 设计亮点 ⭐ 最终版

1. ✅ **首页快捷入口** - 橙色大卡片，显著位置
2. ✅ **扫码智能识别** - 自动跳转登记页面
3. ✅ **园区关联管理** ⭐⭐⭐ 核心 - 选择园区，验证库存，精准扣减
4. ✅ **单位灵活切换** ⭐ 新增 - 包装单位/最小单位随意切换，实时换算
5. ✅ **常用剂量快选** - 根据单位显示不同的常用数量
6. ✅ **患者信息登记** ⭐ 新增 - 姓名、性别、年龄完整记录
7. ✅ **常用患者功能** - 最近患者快速选择，自动填充信息
8. ✅ **连续登记模式** - 保存后自动清空
9. ✅ **智能提示预警** - 库存/效期/重复用药/园区库存不足
10. ✅ **性能优化** - 预加载+缓存+乐观更新

### 核心价值 ⭐ 更新

- ⚡ **操作快速**: 单次登记<30秒（常用患者<15秒）
- 🎯 **界面简洁**: 大按钮，易点击
- 🔄 **单位灵活**: 包装单位/最小单位自由切换，实时换算
- 👥 **患者登记**: 姓名、性别、年龄完整记录，便于追溯
- 💡 **智能提示**: 减少错误操作
- 📊 **数据完整**: 自动记录追溯信息（用药前后库存、单位换算等）
- 🔄 **连续作业**: 支持快速批量登记
- 📝 **常用功能**: 常用患者/常用剂量快速选择

### 🆕 新增功能对比

| 功能 | 旧版设计 | 新版设计 ⭐ |
|------|---------|-----------|
| 单位输入 | 仅最小单位 | **可选包装/最小单位** |
| 数量录入 | 固定单位 | **根据单位显示常用剂量** |
| 单位换算 | 自动 | **实时显示、双向换算** |
| 患者信息 | 扫工牌 | **手动登记：姓名+性别+年龄** |
| 患者记录 | 工号 | **完整患者档案** |
| 快速选择 | 无 | **常用患者列表** |

**目标**：让医务人员能在最短时间内完成门诊用药登记，同时记录完整的患者信息，提升工作效率和数据质量！🎉

