# 📋 入库模块快速参考 v3.6

**版本**: v3.6  
**更新时间**: 2025-11-06

---

## 🎯 核心功能

### ✅ 已完成功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 新建入库单 | ✅ | 完整实现 |
| 编辑入库单 | ✅ | 支持编辑草稿和驳回单 |
| 药品录入 | ✅ | 扫码/选择/新建三种方式 |
| 数据验证 | ✅ | 增强验证规则 |
| 供应商管理 | ✅ | 智能选择组件 |
| 双签名审核 | ✅ | 操作员+复核员 |
| 统计面板 | ✅ | 今日/本周/本月统计 |
| 库存自动更新 | ✅ | 复核通过后自动更新 |

---

## 🚀 快速操作

### 新建入库单
```
列表页 → + 按钮 → 选择供应商 → 添加药品 → 填写明细 → 签名 → 提交
```

### 编辑入库单
```
列表页 → 草稿/驳回单 → 编辑按钮 → 修改内容 → 保存/提交
```

### 复核入库单
```
列表页 → 待复核 → 选择单据 → 查看详情 → 签名 → 通过/驳回
```

---

## 📝 数据验证规则

### 必填字段
- ✅ 批号：不能为空或仅包含空格
- ✅ 生产日期：必填，不能晚于今天
- ✅ 有效期：必填，必须晚于生产日期，不能已过期
- ✅ 数量：必填，必须为正整数，≤999999
- ✅ 签名：必填

### 选填字段
- 供应商：可选
- 单价：可选，如填写需≥0且≤999999.99

---

## 🔧 组件使用

### 供应商选择器
```vue
<supplier-selector 
  v-model="supplier"
  @change="onSupplierChange"
></supplier-selector>
```

### 药品选择弹窗
```vue
<drug-selector-popup
  :show="showDrugSelector"
  @update:show="showDrugSelector = $event"
  @confirm="onDrugsConfirm"
  @continue="onDrugsContinue"
></drug-selector-popup>
```

### 药品创建弹窗
```vue
<drug-create-popup
  :show="showDrugCreate"
  @update:show="showDrugCreate = $event"
  @created="onDrugCreated"
  @save-and-continue="onDrugSaveAndContinue"
></drug-create-popup>
```

---

## 🎨 界面特性

### 合计栏
- 渐变背景（紫色主题）
- 显示：品种数 / 总数量 / 总金额
- 金额金色高亮

### 提示信息
- 空状态：显示操作提示
- 签名状态：显示"必填"或"✓ 已签名"
- 错误提示：精确到行号

### 状态标识
- 草稿：灰色
- 待复核：橙色
- 已完成：绿色
- 已驳回：红色

---

## 📡 API接口

### inRecords 云函数

#### 创建入库单
```javascript
{
  action: 'create',
  data: {
    recordNo: 'RK20251106001',
    supplier: '国药控股',
    items: [...],
    operator: '张三',
    operatorId: 'user_001',
    operatorSign: 'https://...',
    operatorSignTime: new Date(),
    status: 'pending_review' // 或 'draft'
  }
}
```

#### 更新入库单
```javascript
{
  action: 'update',
  data: {
    _id: 'in_001',
    ...更新的字段
  }
}
```

#### 获取详情
```javascript
{
  action: 'getDetail',
  data: { _id: 'in_001' }
}
```

#### 获取列表
```javascript
{
  action: 'getList',
  data: {
    status: 'pending_review', // 'all' | 'draft' | 'pending_review' | 'completed' | 'rejected'
    page: 1,
    pageSize: 10
  }
}
```

#### 获取统计
```javascript
{
  action: 'getStats',
  data: {}
}
// 返回: { today, thisWeek, thisMonth, pending }
```

#### 复核通过
```javascript
{
  action: 'approve',
  data: {
    _id: 'in_001',
    reviewer: '李四',
    reviewerId: 'user_002',
    reviewerSign: 'https://...',
    reviewerSignTime: new Date()
  }
}
```

#### 复核驳回
```javascript
{
  action: 'reject',
  data: {
    _id: 'in_001',
    reviewer: '李四',
    reviewerId: 'user_002',
    rejectReason: '批号填写不规范'
  }
}
```

---

## 🐛 常见问题

### Q1: 编辑时数据没有加载？
**A**: 检查URL参数是否正确传递了 `id`
```javascript
uni.navigateTo({
  url: `/pages-sub/in/add?id=${recordId}`
})
```

### Q2: 提示"药品已过期，不能入库"？
**A**: 检查有效期是否填写正确，过期药品确实不应入库

### Q3: 供应商列表为空？
**A**: 当前使用预置数据，可以通过"新建供应商"添加

### Q4: 验证提示"第X行"是什么意思？
**A**: 表示药品明细表格的第X行数据有问题，方便快速定位

### Q5: 保存草稿和提交复核有什么区别？
**A**: 
- 保存草稿：不需要签名，可继续编辑，不更新库存
- 提交复核：必须签名，等待复核，复核通过后更新库存

---

## 📊 数据流程

```
新建入库单
  ↓
填写基本信息 + 添加药品
  ↓
保存草稿（可选） ←→ 继续编辑
  ↓
操作员签名
  ↓
提交复核（status: pending_review）
  ↓
复核员查看
  ↓
├─ 通过复核 → 自动更新库存（status: completed）
└─ 驳回 → 操作员重新编辑（status: rejected）
```

---

## 🎯 最佳实践

### 1. 入库流程规范
- ✅ 先验收货物，再录入系统
- ✅ 核对药品信息与实物一致
- ✅ 检查生产日期和有效期
- ✅ 拒收过期或即将过期的药品
- ✅ 双人操作、双人签名

### 2. 数据录入规范
- ✅ 批号填写完整、准确
- ✅ 日期格式统一
- ✅ 数量核对准确
- ✅ 供应商信息填写完整

### 3. 复核规范
- ✅ 逐项核对药品信息
- ✅ 检查数量是否合理
- ✅ 发现问题及时驳回
- ✅ 驳回原因说明清楚

---

## 📁 文件结构

```
pages-sub/in/
├── add.vue          # 新建/编辑入库单
├── list.vue         # 入库单列表
└── detail.vue       # 入库单详情

components/
├── drug-selector-popup/     # 药品选择弹窗
├── drug-create-popup/       # 药品创建弹窗
├── supplier-selector/       # 供应商选择器（新增）
└── signature/               # 签名组件

cloudfunctions/
└── inRecords/               # 入库记录管理云函数
```

---

## 🔄 版本历史

### v3.6 (2025-11-06)
- ✅ 完善编辑功能
- ✅ 增强数据验证
- ✅ 新增供应商选择器
- ✅ 优化用户体验

### v3.5 (2025-11-05)
- ✅ 添加统计面板
- ✅ 完善双签名流程
- ✅ 优化界面设计

### v3.4 (2025-11-04)
- ✅ 基础功能实现
- ✅ 药品录入功能
- ✅ 库存自动更新

---

**快速参考文档**  
**AK-PMS v3.6**  
**更新时间**: 2025-11-06


