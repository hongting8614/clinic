# 📋 入库模块 - 连续录入功能完整说明

**版本**: v4.0  
**完成日期**: 2025-11-05  
**状态**: ✅ 开发完成

---

## 🎯 功能概述

入库模块新增**连续录入**功能，支持在一个弹窗内连续选择/创建多个药品，无需反复跳转页面，大幅提升录入效率。

---

## ✨ 核心功能

### 1. 📋 连续选择药品（从档案）

**使用场景**: 从现有药品档案中批量选择药品

#### 功能特点
- ✅ **批量多选** - 一次可选择多个药品
- ✅ **继续添加** - 添加后弹窗保持打开，可继续选择
- ✅ **完成关闭** - 选择完成后一键关闭
- ✅ **搜索过滤** - 支持药品名称/拼音快速搜索
- ✅ **实时计数** - 显示已选数量

#### 使用流程

```
Step 1: 点击「📋 从档案选择」按钮
   └─ 打开药品选择弹窗

Step 2: 搜索并选择药品
   ├─ 在搜索框输入关键词（支持拼音）
   ├─ 点击药品项进行多选
   └─ 已选药品显示 ✓ 标记和蓝色背景

Step 3: 添加到入库单
   ├─ 方式1: 点击「继续添加」
   │   ├─ 已选药品添加到入库单
   │   ├─ 弹窗保持打开
   │   └─ 可以继续选择其他药品
   │
   └─ 方式2: 点击「完成」
       ├─ 已选药品添加到入库单
       └─ 自动关闭弹窗
```

#### 界面预览

```
┌─────────────────────────────────────────┐
│  选择药品              已选 3 项      ✕  │
├─────────────────────────────────────────┤
│  🔍 搜索药品名称或拼音              ✕  │
├─────────────────────────────────────────┤
│  ☑️ 阿莫西林胶囊        [高值]       ✓  │
│     规格：0.25g*24粒                    │
│     单位：盒                            │
│     厂家：XX制药                        │
├─────────────────────────────────────────┤
│  ☑️ 头孢克肟颗粒                     ✓  │
│     规格：0.5g*12袋                     │
├─────────────────────────────────────────┤
│  ○ 布洛芬片                         ○  │
│     规格：0.4g*20片                     │
├─────────────────────────────────────────┤
│  已选择 2 项                            │
│  [继续添加]           [完成 (2)]        │
└─────────────────────────────────────────┘
```

---

### 2. ✍️ 连续创建药品

**使用场景**: 快速创建多个新药品并添加到入库单

#### 功能特点
- ✅ **快速创建** - 填写关键信息即可创建
- ✅ **扫码支持** - 内置扫码功能获取条形码
- ✅ **保存并继续** - 保存后表单清空，继续创建下一个
- ✅ **保存并添加** - 保存并关闭弹窗，添加到入库单
- ✅ **自动清空** - 保存后表单自动重置

#### 使用流程

```
Step 1: 点击「✍️ 新建药品」按钮
   └─ 打开药品创建弹窗

Step 2: 填写药品信息
   ├─ 药品名称 * (必填)
   ├─ 条形码 (可扫码获取)
   ├─ 规格 * (必填，如：0.5g*12片)
   ├─ 单位 * (必填，如：盒)
   ├─ 生产厂家 (选填)
   └─ 药品分类 (选填)

Step 3: 保存药品
   ├─ 方式1: 点击「保存并继续」
   │   ├─ 药品保存到数据库
   │   ├─ 添加到入库单
   │   ├─ 表单自动清空
   │   ├─ 弹窗保持打开
   │   └─ 可以继续创建下一个药品
   │
   └─ 方式2: 点击「保存并添加」
       ├─ 药品保存到数据库
       ├─ 添加到入库单
       └─ 自动关闭弹窗
```

#### 界面预览

```
┌─────────────────────────────────────────┐
│  新建药品                            ✕  │
├─────────────────────────────────────────┤
│  药品名称 *                             │
│  ┌─────────────────────────────────┐   │
│  │ 请输入药品名称                  │   │
│  └─────────────────────────────────┘   │
│                                         │
│  条形码                                 │
│  ┌─────────────────────┐  [扫码]       │
│  │ 请输入或扫码        │                │
│  └─────────────────────┘                │
│                                         │
│  规格 *                                 │
│  ┌─────────────────────────────────┐   │
│  │ 如：0.5g*12片                   │   │
│  └─────────────────────────────────┘   │
│                                         │
│  单位 *                                 │
│  ┌─────────────────────────────────┐   │
│  │ 如：盒                          │   │
│  └─────────────────────────────────┘   │
│                                         │
│  生产厂家                               │
│  ┌─────────────────────────────────┐   │
│  │ 请输入生产厂家                  │   │
│  └─────────────────────────────────┘   │
│                                         │
│  药品分类                               │
│  ┌─────────────────────────────────┐   │
│  │ 请选择分类                  ›   │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  [保存并继续]      [保存并添加]         │
└─────────────────────────────────────────┘
```

---

### 3. 📷 连续扫码入库

**使用场景**: 使用扫码枪或手机摄像头快速录入药品

#### 功能特点
- ✅ **连续扫码** - 开启后自动连续调用扫码
- ✅ **自动查询** - 扫码后自动查询药品信息
- ✅ **智能引导** - 未找到药品时引导创建
- ✅ **去重检查** - 自动检查是否已添加

#### 使用流程

```
Step 1: 开启连续扫码模式
   └─ 勾选「连续扫码」开关

Step 2: 点击「📷 扫码入库」
   └─ 调用摄像头扫描条形码

Step 3: 自动处理结果
   ├─ 找到药品
   │   ├─ 自动添加到入库单
   │   └─ 自动唤起下一次扫码
   │
   └─ 未找到药品
       ├─ 弹出提示「该条码未在系统中找到，是否手动录入？」
       ├─ [确定] → 打开创建药品弹窗（带条形码）
       └─ [取消] → 继续扫码（连续模式下）
```

---

## 💡 使用技巧

### 技巧1: 批量录入相同供应商的药品

1. 开启「连续扫码」或使用「从档案选择」
2. 批量添加所有药品
3. 使用「同批号」「同生产日期」等快捷功能
4. 填写第一行数据，其他行自动填充

### 技巧2: 快速创建并入库新药品

1. 扫码未找到时，点击「确定」创建
2. 条形码已自动填入
3. 填写必填项（名称、规格、单位）
4. 点击「保存并继续」
5. 重复步骤3-4，创建多个新药品
6. 最后点击「保存并添加」完成

### 技巧3: 混合使用多种录入方式

```
场景：入库10种药品
  ├─ 8种已录入档案 → 使用「从档案选择」批量添加
  ├─ 1种有条形码但未录入 → 使用「扫码入库」自动创建
  └─ 1种无条形码 → 使用「新建药品」手动创建
```

---

## 📊 组件说明

### 组件1: DrugSelectorPopup

**路径**: `components/drug-selector-popup/index.vue`

**Props**:
- `show` - 是否显示弹窗
- `mode` - 模式（select: 选择模式）

**Events**:
- `update:show` - 弹窗显示状态变化
- `confirm` - 完成选择（关闭弹窗）
- `continue` - 继续添加（保持弹窗打开）

**使用示例**:
```vue
<drug-selector-popup
  :show="showSelector"
  @update:show="showSelector = $event"
  @confirm="onDrugsConfirm"
  @continue="onDrugsContinue"
></drug-selector-popup>
```

---

### 组件2: DrugCreatePopup

**路径**: `components/drug-create-popup/index.vue`

**Props**:
- `show` - 是否显示弹窗
- `defaultBarcode` - 默认条形码（扫码时传入）

**Events**:
- `update:show` - 弹窗显示状态变化
- `created` - 创建完成（关闭弹窗）
- `save-and-continue` - 保存并继续（保持弹窗打开）

**使用示例**:
```vue
<drug-create-popup
  :show="showCreate"
  :default-barcode="scannedBarcode"
  @update:show="showCreate = $event"
  @created="onDrugCreated"
  @save-and-continue="onDrugSaveAndContinue"
></drug-create-popup>
```

---

## 🔧 集成到页面

### 步骤1: 导入组件

```vue
<script>
import DrugSelectorPopup from '@/components/drug-selector-popup/index.vue'
import DrugCreatePopup from '@/components/drug-create-popup/index.vue'

export default {
  components: {
    DrugSelectorPopup,
    DrugCreatePopup
  }
}
</script>
```

### 步骤2: 添加状态

```javascript
data() {
  return {
    showDrugSelector: false,  // 药品选择弹窗
    showDrugCreate: false,     // 药品创建弹窗
    pendingBarcode: ''         // 待创建药品的条形码
  }
}
```

### 步骤3: 添加模板

```vue
<template>
  <!-- 药品选择弹窗 -->
  <drug-selector-popup
    :show="showDrugSelector"
    @update:show="showDrugSelector = $event"
    @confirm="onDrugsSelected"
    @continue="onDrugsContinue"
  ></drug-selector-popup>
  
  <!-- 药品创建弹窗 -->
  <drug-create-popup
    :show="showDrugCreate"
    :default-barcode="pendingBarcode"
    @update:show="showDrugCreate = $event"
    @created="onDrugCreated"
    @save-and-continue="onDrugSaveAndContinue"
  ></drug-create-popup>
</template>
```

### 步骤4: 添加事件处理

```javascript
methods: {
  // 打开选择弹窗
  handleSelectDrug() {
    this.showDrugSelector = true
  },
  
  // 选择完成（批量添加并关闭）
  onDrugsSelected(drugs) {
    drugs.forEach(drug => {
      this.addDrugToList(drug, 'select')
    })
    this.showDrugSelector = false
  },
  
  // 继续添加（批量添加但保持打开）
  onDrugsContinue(drugs) {
    drugs.forEach(drug => {
      this.addDrugToList(drug, 'select')
    })
  },
  
  // 打开创建弹窗
  handleCreateDrug(barcode = '') {
    this.pendingBarcode = barcode
    this.showDrugCreate = true
  },
  
  // 创建完成（添加并关闭）
  onDrugCreated(drugData) {
    this.addDrugToList(drugData, 'create')
    this.showDrugCreate = false
    this.pendingBarcode = ''
  },
  
  // 保存并继续（添加但保持打开）
  onDrugSaveAndContinue(drugData) {
    this.addDrugToList(drugData, 'create')
  }
}
```

---

## 🎨 界面优化

### 视觉反馈
- ✅ 已选药品显示蓝色背景
- ✅ 已选标记使用 ✓ 图标
- ✅ 已选数量实时显示在标题栏
- ✅ 按钮禁用状态（未选择时）

### 交互优化
- ✅ 点击药品卡片切换选择状态
- ✅ 搜索框支持实时过滤
- ✅ 支持清空搜索关键词
- ✅ 弹窗关闭自动清空选择

---

## 📝 注意事项

### 1. 数据格式

药品数据需包含以下字段：
```javascript
{
  _id: '药品ID',
  name: '药品名称',
  spec: '规格',
  unit: '单位',
  manufacturer: '生产厂家',
  category: '分类',
  barcode: '条形码',
  isHighValue: false,  // 是否高值
  isEmergency: false   // 是否急救
}
```

### 2. 云函数要求

需要云函数支持以下操作：
- `drugManage.getList` - 获取药品列表
- `drugManage.create` - 创建新药品
- `drugManage.getByBarcode` - 根据条形码查询

### 3. 权限要求

需要以下微信小程序权限：
- `scope.camera` - 摄像头权限（扫码功能）

---

## 🚀 性能优化

### 1. 列表虚拟化
- 药品列表使用 `scroll-view` 滚动加载
- 建议每次加载100条数据

### 2. 搜索防抖
- 搜索输入使用计算属性，实时过滤
- 无需额外的防抖处理

### 3. 内存优化
- 弹窗关闭时清空选择数据
- 避免内存泄漏

---

## ✅ 完成状态

- [x] 创建药品选择弹窗组件
- [x] 创建药品创建弹窗组件
- [x] 支持连续选择功能
- [x] 支持连续创建功能
- [x] 集成到入库页面
- [x] 完善文档说明

---

## 📞 技术支持

如有问题，请查看：
- 入库模块使用指南: `🎯入库模块使用指南.md`
- 组件源码: 
  - `components/drug-selector-popup/index.vue`
  - `components/drug-create-popup/index.vue`

