# 📐 分园区单位转换界面设计 v3.12

**设计时间**: 2025-11-06  
**版本**: v3.12  
**基于**: 🔧分园区单位转换与数据库优化方案_v3.11  
**核心功能**: 入库单位转换 + 分园区管理 + 双单位显示

---

## 📋 设计原则

### 核心目标
```
1. 入库用包装单位（盒、瓶）→ 自动转换为最小单位存储    总库存只显示整包装单位  这个出库时才转换   说出转换方法  正则表达式
2. 出库用最小单位（粒、片）→ 实时显示包装单位换算   出库单位也是整包装
3. 分园区管理 → 独立库存、独立统计
4. 双单位显示 → 操作友好、数据准确
```

### 用户体验
```
✅ 入库人员：习惯用"盒"计数，系统自动转换
✅ 出库人员：盒，系统自动换算 门诊减出库存时  用最小单位
✅ 管理人员：一目了然看到双单位，便于核对
```

---

## 🎨 界面设计

## 设计1：入库单界面（包装单位入库）

### 界面布局
```
┌─────────────────────────────────────────────┐
│ ← 新建入库单                          [保存]│
├─────────────────────────────────────────────┤
│                                             │
│ 🏥 入库信息                                 │
│ ┌─────────────────────────────────────────┐│
│ │ 入库单号  RK20251106001                 ││
│ │ 入库时间  2025-11-06 10:30              ││
│ │ 操作员    张三                          ││
│ │ 入库园区  🏥 医务室中央库          ▼   ││◄─ 固定中央库   没有中央库  就是药库
│ │ 供应商    [国药控股_______________] ▼  ││
│ └─────────────────────────────────────────┘│
│                                             │
│ 💊 药品明细 (3种)            [📋选择][✍️新建]│
│                                             │
│ ╔═══════════════════════════════════════╗ │◄─ 横向滚动表格
│ ║ # │ 药品名称 │ 规格 │ 批号 │ 生产 │ 有效 │ 距期 │ 数量 │ 单位 │ 💡最小单位 │ 单价 │ 金额 │ 操作 ║
│ ╠═══════════════════════════════════════╣ │
│ ║ 1 │ 阿莫西林 │ 0.25g│20250│2025-│2027-│730天│ 10  │ 盒  │ 240粒    │12.5 │125  │ 🗑  ║
│ ║   │ 胶囊     │×24粒 │101  │01-01│01-01│  ✓ │     │     │ ═══════  │     │     │     ║
│ ║   │          │/盒   │     │     │     │     │     │     │ 自动计算  │     │     │     ║
│ ╠═══════════════════════════════════════╣ │
│ ║ 2 │ 布洛芬片 │ 0.2g │20250│2025-│2027-│731天│ 15  │ 盒  │ 300粒    │18.0 │270  │ 🗑  ║
│ ║   │          │×20片 │102  │01-02│01-02│  ✓ │     │     │ ═══════  │     │     │     ║
│ ║   │          │/盒   │     │     │     │     │     │     │ 自动计算  │     │     │     ║
│ ╠═══════════════════════════════════════╣ │
│ ║ 3 │ 对乙酰氨│ 0.5g │20250│2025-│2027-│729天│ 20  │ 盒  │ 240粒    │15.0 │300  │ 🗑  ║
│ ║   │ 基酚片  │×12片 │103  │01-03│01-03│  ✓ │     │     │ ═══════  │     │     │     ║
│ ║   │          │/盒   │     │     │     │     │     │     │ 自动计算  │     │     │     ║
│ ╚═══════════════════════════════════════╝ │
│                                             │
│ 💡 智能提示          不要提示                        │
│ ┌─────────────────────────────────────────┐│
│ │ • 入库数量按包装单位（盒）填写          ││
│ │ • 系统自动计算并存储最小单位（粒）      ││
│ │ • 入库后将自动入库到"医务室中央库"      ││
│ └─────────────────────────────────────────┘│
│                                             │
│ 📊 入库汇总                                  │
│ ┌─────────────────────────────────────────┐│
│ │ 品种总数: 3 种                          ││
│ │ 包装总数: 45 盒                         ││
│ │ 最小单位: 780 粒/片                     ││◄─ 双单位显示
│ │ 合计金额: ¥695.00                       ││
│ └─────────────────────────────────────────┘│
│                                             │
│ ✍️ 操作员签名 *                              │
│ ┌─────────────────────────────────────────┐│
│ │ [点击签名]                    未签名    ││
│ └─────────────────────────────────────────┘│
│                                             │
├─────────────────────────────────────────────┤
│ [💾 保存草稿]              [✓ 提交复核]    │
└─────────────────────────────────────────────┘
```

### 关键交互说明

#### 1. 规格自动解析
```
操作流程:
1. 选择药品"阿莫西林胶囊"
   ↓
2. 系统读取规格: "0.25g×24粒/盒"
   ↓
3. 自动解析:
   - 包装单位: 盒
   - 最小单位: 粒
   - 转换率: 24 (1盒=24粒)
   ↓
4. 表格显示:
   - 数量列: 输入框（盒）
   - 最小单位列: 自动计算（粒，只读）
```

#### 2. 实时计算最小单位
```
用户输入: 10 盒
         ↓
解析规格: 0.25g×24粒/盒
         ↓
提取转换率: 24  这个24用什么方法转过来的  要有实现方法   如果规格是  0.1×12粒/盒 怎么办
         ↓
计算公式: 10 × 24 = 240
         ↓
显示结果: 💡 240粒 （高亮显示）
```

#### 3. 数据提交
```
前端提交数据结构:
{
  recordNo: "RK20251106001",
  location: "central_storage",
  locationName: "医务室中央库",
  items: [
    {
      drugId: "drug_001",
      drugName: "阿莫西林胶囊",
      specification: "0.25g×24粒/盒",
      
      // 包装单位（用户输入）
      quantity: 10,
      unit: "盒",
      
      // 最小单位（自动计算）
      minQuantity: 240,
      minUnit: "粒",
      conversionRate: 24,
      
      batch: "20250101",
      productionDate: "2025-01-01",
      expireDate: "2027-01-01",
      price: 12.5
    }
  ]
}

后端存储（统一最小单位）:
stock 集合:
{
  drugId: "drug_001",
  quantity: 240,        // 存储最小单位
  quantityPack: 10,     // 冗余包装单位（便于显示）
  minUnit: "粒",
  packUnit: "盒",
  conversionRate: 24
}
```

---

## 设计2：出库单界面（最小单位出库）

### 界面布局
```
┌─────────────────────────────────────────────┐
│ ← 新建出库单                          [保存]│
├─────────────────────────────────────────────┤
│                                             │
│ 🎯 出库信息                                 │
│ ┌─────────────────────────────────────────┐│
│ │ 出库单号  CK20251106001                 ││
│ │ 出库时间  2025-11-06 14:30              ││
│ │ 发药人    张三                          ││
│ │                                         ││
│ │ 出库园区 * [请选择园区____________] ▼  ││◄─ 必选
│ │ ┌───────────────────────────────────┐  ││
│ │ │ 🎢 陆园医务室                     │  ││◄─ 选项1
│ │ │ 🌊 水园医务室                     │  ││◄─ 选项2
│ │ │ 🏥 医务室中央库（调拨出库）   取消    │  ││◄─ 选项3 这项不要
│ │ └───────────────────────────────────┘  ││
│ │                                         ││
│ │ 领药人    [王五___________________]    ││    要有复核人
│ │ 备注      [陆园日常用药补充________]   ││
│ └─────────────────────────────────────────┘│
│                                             │
│ 💊 药品明细 (2种)            [📋选择][✍️新建]│   输入框没有获取焦点时  隐藏
│                                             │
│ ╔════════════════════════════════════════╗│◄─ 横向滚动表格
│ ║ # │ 药品名称 │ 规格 │ 批号 │ 有效期 │ 当前库存 │ 出库数量 │ 单位 │ 💡换算 │ 剩余库存 │ 操作 ║
│ ╠════════════════════════════════════════╣│
│ ║ 1 │ 阿莫西林 │ 0.25g│20250│2027-  │ 240粒   │ [30___]│ 粒  │1.25盒 │ 210粒   │ 🗑  ║
│ ║   │ 胶囊     │×24粒 │101  │01-01  │ (10盒)  │        │     │═════ │ (8.75盒)│     ║
│ ║   │          │/盒   │     │730天✓ │         │        │     │自动换│         │     ║
│ ╠════════════════════════════════════════╣│
│ ║ 2 │ 布洛芬片 │ 0.2g │20250│2027-  │ 300粒   │ [50___]│ 粒  │2.5盒  │ 250粒   │ 🗑  ║
│ ║   │          │×20片 │102  │01-02  │ (15盒)  │        │     │═════ │ (12.5盒)│     ║
│ ║   │          │/盒   │     │731天✓ │         │        │     │自动换│         │     ║
│ ╚════════════════════════════════════════╝│
│                                             │
│ 💡 智能提示                 不要提示                   │
│ ┌─────────────────────────────────────────┐│
│ │ • 出库数量按最小单位（粒/片）填写       ││
│ │ • 系统自动换算为包装单位供参考          ││
│ │ • 库存数量已按选定园区筛选              ││
│ │ • 出库后将从"陆园"库存中扣减            ││
│ └─────────────────────────────────────────┘│
│                                             │
│ 📊 出库汇总                                  │  简化 不要
│ ┌─────────────────────────────────────────┐│
│ │ 品种总数: 2 种                          ││
│ │ 出库数量: 80 粒/片                      ││◄─ 最小单位
│ │ 换算数量: 3.75 盒                       ││◄─ 包装单位
│ │ 出库园区: 🎢 陆园医务室                 ││
│ └─────────────────────────────────────────┘│
│                                             │
│ ✍️ 双签名                                    │
│ ┌─────────────────────────────────────────┐│
│ │ 发药人签名: [已签名] ✓ 张三             ││
│ │ 领药人签名: [点击签名]    未签名        ││
│ └─────────────────────────────────────────┘│
│                                             │
├─────────────────────────────────────────────┤
│ [💾 保存草稿]              [✓ 提交复核]    │
└─────────────────────────────────────────────┘
```

### 关键交互说明

#### 1. 园区选择联动库存
```
操作流程:
1. 用户选择"🎢 陆园医务室"
   ↓
2. 系统查询该园区库存
   location: "land_park"
   ↓
3. 药品选择器只显示该园区有库存的药品
   ↓
4. 库存列显示该园区的实际库存
   当前库存: 240粒 (10盒)
```

#### 2. 最小单位出库 + 自动换算  出库是整包装出库
```
用户输入: 30 粒
         ↓
读取规格: 0.25g×24粒/盒
         ↓
提取转换率: 24
         ↓
换算公式: 30 ÷ 24 = 1.25
         ↓
显示结果: 💡 1.25盒 （灰色显示，仅供参考）
         ↓
库存扣减: 240 - 30 = 210粒
         ↓
显示剩余: 210粒 (8.75盒)
```

#### 3. 库存验证
```
验证规则:
1. 选择药品时：
   IF 园区未选择
   THEN 提示"请先选择出库园区"
   
2. 输入数量时：
   IF 出库数量 > 当前库存
   THEN 显示红色警告"库存不足"
   ELSE 显示绿色"库存充足"
   
3. 提交时：
   FOR EACH item IN items
     IF item.quantity > stock.quantity
     THEN 返回错误"库存不足"
```

#### 4. 数据提交
```
前端提交数据结构:
{
  recordNo: "CK20251106001",
  location: "land_park",
  locationName: "陆园医务室",
  items: [
    {
      drugId: "drug_001",
      drugName: "阿莫西林胶囊",
      specification: "0.25g×24粒/盒",
      batch: "20250101",
      
      // 最小单位（用户输入）
      quantity: 30,
      unit: "粒",
      
      // 包装单位（自动计算，仅显示）
      packQuantity: 1.25,
      packUnit: "盒",
      conversionRate: 24,
      
      // 库存信息（用于验证）
      stockId: "stock_001",
      beforeQuantity: 240,
      afterQuantity: 210
    }
  ]
}

后端处理（扣减库存）:
stock 集合 更新:
{
  _id: "stock_001",
  location: "land_park",
  quantity: 240 → 210,        // 扣减最小单位
  quantityPack: 10 → 8.75     // 更新包装单位
}
```

---

## 设计3：库存列表界面（分园区显示）

### 界面布局
```
┌─────────────────────────────────────────────┐
│ ← 库存管理                          [搜索]  │
├─────────────────────────────────────────────┤
│                                             │
│ 🏥 园区筛选                                  │
│ ┌───────┬───────┬───────┬───────┐         │
│ │ ● 全部│  陆园 │  水园 │ 中央库│         │◄─ 标签切换
│ └───────┴───────┴───────┴───────┘         │
│                                             │
│ 📊 库存统计卡片           中央库改为药库                     │
│ ┌──────────────┬──────────────┬──────────┐│
│ │ 🎢 陆园       │ 🌊 水园       │ 🏥 中央库 ││
│ │ 品种: 28     │ 品种: 25     │ 品种: 95  ││
│ │ 总量: 2,340粒│ 总量: 1,890粒│总量:12,500不要││
│ │ 换算: 98盒  不要 │ 换算: 79盒  不要 │ 换算: 521盒││
│ └──────────────┴──────────────┴──────────┘│
│                                             │
│ 💊 库存明细列表                              │
│                                             │
│ ┌─────────────────────────────────────────┐│
│ │ 阿莫西林胶囊                 🎢 陆园    ││◄─ 园区标签
│ │ 0.25g×24粒/盒 | 批号: 20250101         ││
│ │ ─────────────────────────────────────  ││
│ │ 💊 当前库存:                            ││
│ │    210粒 = 8盒零18粒                   ││◄─ 双单位显示
│ │    (8.75盒)                            ││◄─ 精确换算
│ │                                         ││
│ │ 📅 有效期: 2027-01-01 (730天)     ✓   ││
│ │ 💰 单价: ¥12.5/盒                      ││
│ │                                  [详情]││
│ └─────────────────────────────────────────┘│
│                                             │
│ ┌─────────────────────────────────────────┐│
│ │ 布洛芬片                     🌊 水园    ││
│ │ 0.2g×20片/盒 | 批号: 20250102          ││
│ │ ─────────────────────────────────────  ││
│ │ 💊 当前库存:                            ││
│ │    180片 = 9盒                         ││◄─ 整盒显示
│ │    (9盒)                               ││
│ │                                         ││
│ │ 📅 有效期: 2027-01-02 (731天)     ✓   ││
│ │ 💰 单价: ¥18.0/盒                      ││
│ │                                  [详情]││
│ └─────────────────────────────────────────┘│
│                                             │
│ ┌─────────────────────────────────────────┐│
│ │ 对乙酰氨基酚片               🏥 中央库  ││
│ │ 0.5g×12片/盒 | 批号: 20250103          ││
│ │ ─────────────────────────────────────  ││
│ │ 💊 当前库存:                            ││
│ │    1,250片 = 104盒零2片                ││◄─ 混合显示
│ │    (104.17盒)                          ││
│ │                                         ││
│ │ 📅 有效期: 2027-01-03 (729天)     ✓   ││
│ │ 💰 单价: ¥15.0/盒                      ││
│ │                                  [详情]││
│ └─────────────────────────────────────────┘│
│                                             │
│ 💡 显示规则说明                              │
│ • 整盒显示: 180片 = 9盒                    │
│ • 零散显示: 30片 = 1.25盒                  │
│ • 混合显示: 210片 = 8盒零18片              │
│                                             │
└─────────────────────────────────────────────┘
```

### 双单位显示逻辑

#### 显示格式算法
```javascript
/**
 * 格式化库存数量显示
 * @param {Number} minQuantity - 最小单位数量（如240粒）
 * @param {Object} specInfo - 规格信息
 * @returns {String} 格式化字符串
 */
function formatStockDisplay(minQuantity, specInfo) {
  const { minUnit, packUnit, conversionRate } = specInfo
  
  // 计算包装数量
  const totalPacks = minQuantity / conversionRate  // 10.5
  const fullPacks = Math.floor(totalPacks)         // 10
  const remainMin = minQuantity % conversionRate   // 12
  
  // 情况1: 整盒（无余数）
  if (remainMin === 0) {
    return `${minQuantity}${minUnit} = ${fullPacks}${packUnit}`
    // 示例: "240粒 = 10盒"
  }
  
  // 情况2: 零散（不足1盒）
  if (fullPacks === 0) {
    return `${minQuantity}${minUnit} = ${totalPacks.toFixed(2)}${packUnit}`
    // 示例: "18粒 = 0.75盒"
  }
  
  // 情况3: 混合（有整盒+零散）
  return `${minQuantity}${minUnit} = ${fullPacks}${packUnit}零${remainMin}${minUnit}`
  // 示例: "210粒 = 8盒零18粒"
}

// 使用示例
console.log(formatStockDisplay(240, { minUnit: '粒', packUnit: '盒', conversionRate: 24 }))
// 输出: "240粒 = 10盒"

console.log(formatStockDisplay(210, { minUnit: '粒', packUnit: '盒', conversionRate: 24 }))
// 输出: "210粒 = 8盒零18粒"

console.log(formatStockDisplay(18, { minUnit: '粒', packUnit: '盒', conversionRate: 24 }))
// 输出: "18粒 = 0.75盒"
```

---

## 设计4：药品档案界面（规格管理）

### 界面布局
```
┌─────────────────────────────────────────────┐
│ ← 药品档案                          [添加]  │
├─────────────────────────────────────────────┤
│                                             │
│ 🔍 搜索与筛选                                │
│ [搜索药品名称/拼音___________] 🔍  [分类▼] │
│                                             │
│ 💊 药品列表                                  │
│                                             │
│ ┌─────────────────────────────────────────┐│
│ │ 阿莫西林胶囊                            ││
│ │ ─────────────────────────────────────  ││
│ │ 📦 规格: 0.25g×24粒/盒                 ││◄─ 原始规格
│ │                                         ││
│ │ 🔄 单位转换信息:                        ││◄─ 解析结果
│ │    • 包装单位: 盒                       ││
│ │    • 最小单位: 粒                       ││
│ │    • 转换率: 1盒 = 24粒                ││
│ │    • 剂量: 0.25g                       ││
│ │                                         ││
│ │ 🏭 厂家: 华北制药                       ││
│ │ 📊 分类: 抗生素                         ││
│ │ 🏷️ 条码: 6901234567890                 ││
│ │                                         ││
│ │ 📊 当前库存:                            ││
│ │    • 陆园: 210粒 (8.75盒)              ││
│ │    • 水园: 180粒 (7.5盒)               ││
│ │    • 中央库: 1200粒 (50盒)             ││
│ │                              [编辑][详情]││
│ └─────────────────────────────────────────┘│
│                                             │
│ ┌─────────────────────────────────────────┐│
│ │ ⚠️ 布洛芬片                             ││◄─ 规格异常
│ │ ─────────────────────────────────────  ││
│ │ 📦 规格: 100片                          ││◄─ 不规范格式
│ │                                         ││
│ │ ❌ 单位转换信息: 无法解析               ││◄─ 解析失败
│ │    请修正规格为标准格式:                ││
│ │    推荐: 0.2g×100片/瓶                  ││
│ │                                         ││
│ │ 💡 建议操作:                            ││
│ │    [修正规格] [查看示例]                ││
│ └─────────────────────────────────────────┘│
│                                             │
└─────────────────────────────────────────────┘
```

### 新建/编辑药品界面
```
┌─────────────────────────────────────────────┐
│ ← 新建药品                          [保存]  │
├─────────────────────────────────────────────┤
│                                             │
│ 📝 基本信息                                  │
│ ┌─────────────────────────────────────────┐│
│ │ 药品名称 *                              ││
│ │ [阿莫西林胶囊___________________]      ││
│ │                                         ││
│ │ 规格 * (重要)                           ││◄─ 关键字段
│ │ [0.25g×24粒/盒_________________]       ││
│ │                                         ││
│ │ 💡 规格格式说明:                        ││◄─ 智能提示
│ │ ┌─────────────────────────────────────┐││
│ │ │ 标准格式: 剂量×数量单位/包装单位    │││
│ │ │                                     │││
│ │ │ 常用示例:                           │││
│ │ │ ✓ 0.25g×24粒/盒                    │││
│ │ │ ✓ 0.2g×20片/盒                     │││
│ │ │ ✓ 5ml×10支/盒                      │││
│ │ │ ✓ 10ml×6瓶/盒                      │││
│ │ │ ✓ 3g×10袋/盒                       │││
│ │ │ ✓ 20g/支                           │││
│ │ └─────────────────────────────────────┘││
│ │                                         ││
│ │ 🔍 规格实时验证:                        ││◄─ 实时反馈
│ │ ┌─────────────────────────────────────┐││
│ │ │ ✅ 规格格式正确                     │││
│ │ │ 已解析:                             │││
│ │ │ • 包装单位: 盒                      │││
│ │ │ • 最小单位: 粒                      │││
│ │ │ • 转换率: 1盒 = 24粒               │││
│ │ │ • 剂量: 0.25g                      │││
│ │ └─────────────────────────────────────┘││
│ │                                         ││
│ │ 厂家                                    ││
│ │ [华北制药_______________________]      ││
│ │                                         ││
│ │ 条形码 (可选)                           ││
│ │ [6901234567890__] 📷 [扫码录入]        ││
│ │                                         ││
│ │ 分类                                    ││
│ │ [抗生素_____________________] ▼        ││
│ │                                         ││
│ │ 库存预警阈值                            ││
│ │ [100___] 粒   (换算: [4.17_] 盒)      ││◄─ 双单位设置
│ │                                         ││
│ │ 药品属性                                ││
│ │ ☐ 高值药品  ☐ 急救药品  ☐ 处方药      ││
│ └─────────────────────────────────────────┘│
│                                             │
├─────────────────────────────────────────────┤
│ [取消]                        [保存并继续]  │
└─────────────────────────────────────────────┘
```

---

## 设计5：统计报表界面（分园区对比）

### 园区出库对比报表
```
┌─────────────────────────────────────────────┐
│ ← 园区出库统计              [导出] [打印]  │
├─────────────────────────────────────────────┤
│                                             │
│ 📅 查询条件                                  │
│ ┌─────────────────────────────────────────┐│
│ │ 时间范围: [2025-11-01] ~ [2025-11-06]  ││
│ │ 筛选园区: [● 全部] [ 陆园] [ 水园]     ││
│ │          [查询]                         ││
│ └─────────────────────────────────────────┘│
│                                             │
│ 📊 园区对比图表                              │
│ ┌─────────────────────────────────────────┐│
│ │         园区出库数量对比                ││
│ │    ▲                                    ││
│ │500 │     ███                            ││
│ │400 │ ███ ███                            ││
│ │300 │ ███ ███ ███                        ││
│ │200 │ ███ ███ ███                        ││
│ │100 │ ███ ███ ███                        ││
│ │  0 └─────────────────►                 ││
│ │     陆园 水园 中央库                    ││
│ │                                         ││
│ │ 图例: █ 最小单位(粒) ▒ 包装单位(盒)   ││
│ └─────────────────────────────────────────┘│
│                                             │
│ 📋 明细列表                                  │
│ ╔═══════════════════════════════════════╗ │
│ ║ 园区    │ 药品     │ 规格    │ 出库数量│ 换算   │ 次数 │ 占比  ║
│ ╠═══════════════════════════════════════╣ │
│ ║ 🎢 陆园 │ 阿莫西林│ 0.25g×│ 360粒  │ 15盒  │ 12次 │ 45% ║
│ ║         │ 胶囊    │ 24粒/盒│        │       │      │     ║
│ ╠═══════════════════════════════════════╣ │
│ ║ 🎢 陆园 │ 布洛芬片│ 0.2g× │ 240片  │ 12盒  │ 8次  │ 30% ║
│ ║         │         │ 20片/盒│        │       │      │     ║
│ ╠═══════════════════════════════════════╣ │
│ ║ 🌊 水园 │ 阿莫西林│ 0.25g×│ 288粒  │ 12盒  │ 10次 │ 40% ║
│ ║         │ 胶囊    │ 24粒/盒│        │       │      │     ║
│ ╠═══════════════════════════════════════╣ │
│ ║ 🌊 水园 │ 对乙酰氨│ 0.5g× │ 180片  │ 15盒  │ 9次  │ 35% ║
│ ║         │ 基酚片  │ 12片/盒│        │       │      │     ║
│ ╚═══════════════════════════════════════╝ │
│                                             │
│ 📊 汇总统计                                  │
│ ┌──────────────┬──────────────┬──────────┐│
│ │ 🎢 陆园       │ 🌊 水园       │ 📊 合计   ││
│ │ 品种: 15     │ 品种: 12     │ 品种: 27  ││
│ │ 次数: 45次   │ 次数: 38次   │ 次数: 83次││
│ │ 数量: 1,250粒│ 数量: 980粒  │总量: 2,230││
│ │ 换算: 52盒   │ 换算: 41盒   │ 换算: 93盒││
│ └──────────────┴──────────────┴──────────┘│
│                                             │
└─────────────────────────────────────────────┘
```

---

## 🎯 核心组件设计

### 组件1: UnitConverter（单位转换组件）

#### 使用场景
```vue
<!-- 入库页面 - 自动计算最小单位 -->
<view class="unit-display">
  <input 
    type="number" 
    v-model="item.quantity" 
    @blur="onQuantityChange(item)"
  />
  <text class="unit">{{ item.packUnit }}</text>
  <text class="converted">
    💡 {{ item.minQuantity }}{{ item.minUnit }}
  </text>
</view>

<script>
import UnitConverter from '@/utils/unitConverter'

methods: {
  onQuantityChange(item) {
    if (!item.quantity || !item.specInfo) return
    
    // 自动计算最小单位
    item.minQuantity = UnitConverter.convert(
      Number(item.quantity),
      item.packUnit,
      item.minUnit,
      item.specInfo
    )
  }
}
</script>
```

### 组件2: ParkSelector（园区选择器）

#### 使用场景
```vue
<template>
  <picker 
    mode="selector"
    :value="parkIndex"
    :range="parkList"
    range-key="name"
    @change="onParkChange"
  >
    <view class="park-picker">
      <text v-if="selectedPark" class="park-icon">
        {{ selectedPark.icon }}
      </text>
      <text class="park-name">
        {{ selectedPark ? selectedPark.name : '请选择园区' }}
      </text>
    </view>
  </picker>
</template>

<script>
import { getOutboundParks } from '@/utils/parkConfig'

export default {
  data() {
    return {
      parkIndex: 0,
      parkList: [],
      selectedPark: null
    }
  },
  mounted() {
    this.parkList = getOutboundParks()
    if (this.parkList.length > 0) {
      this.selectedPark = this.parkList[0]
    }
  },
  methods: {
    onParkChange(e) {
      this.parkIndex = e.detail.value
      this.selectedPark = this.parkList[this.parkIndex]
      this.$emit('change', this.selectedPark)
    }
  }
}
</script>
```

### 组件3: StockDisplay（库存显示组件）

#### 使用场景
```vue
<template>
  <view class="stock-display">
    <!-- 主显示：最小单位 -->
    <view class="primary-unit">
      <text class="quantity">{{ quantity }}</text>
      <text class="unit">{{ minUnit }}</text>
    </view>
    
    <!-- 副显示：包装单位 -->
    <view class="secondary-unit">
      <text class="converted">
        {{ formatDisplay }}
      </text>
    </view>
  </view>
</template>

<script>
import UnitConverter from '@/utils/unitConverter'

export default {
  props: {
    quantity: {
      type: Number,
      required: true
    },
    specInfo: {
      type: Object,
      required: true
    }
  },
  computed: {
    minUnit() {
      return this.specInfo.minUnit || ''
    },
    formatDisplay() {
      return UnitConverter.formatQuantity(this.quantity, this.specInfo)
    }
  }
}
</script>

<style scoped>
.stock-display {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.primary-unit {
  font-size: 16px;
  font-weight: bold;
  color: #303133;
}

.secondary-unit {
  font-size: 12px;
  color: #909399;
}

.converted::before {
  content: '= ';
}
</style>
```

---

## 📱 响应式设计

### 小屏适配（<375px）
```
策略:
1. 表格横向滚动
2. 关键列固定（药品名称、数量）
3. 辅助列可隐藏（厂家、备注）
4. 卡片式布局代替表格

示例:
┌─────────────────────────┐
│ 阿莫西林胶囊            │
│ 0.25g×24粒/盒           │
│ ─────────────────────── │
│ 批号: 20250101          │
│ 出库: 30粒 (1.25盒)     │
│ 库存: 210粒 (8.75盒)    │
│ 园区: 🎢 陆园           │
└─────────────────────────┘
```

### 中屏适配（375-768px）
```
策略:
1. 表格正常显示
2. 双单位并排显示
3. 园区选择器展开

正常表格布局
```

### 大屏适配（>768px）
```
策略:
1. 左右分栏布局
2. 实时预览面板
3. 快捷操作侧边栏

┌──────────────┬──────────┐
│              │          │
│   主表单     │  实时    │
│              │  预览    │
│              │          │
└──────────────┴──────────┘
```

---

## 🎨 颜色与图标设计

### 园区标识色
```css
/* 陆园 */
.park-land {
  color: #67c23a;
  background: #f0f9ff;
  border-color: #67c23a;
}

/* 水园 */
.park-water {
  color: #409eff;
  background: #ecf5ff;
  border-color: #409eff;
}

/* 中央库 */
.park-central {
  color: #909399;
  background: #f4f4f5;
  border-color: #909399;
}
```

### 单位显示色
```css
/* 包装单位（入库用） */
.unit-pack {
  color: #303133;
  font-weight: bold;
  font-size: 16px;
}

/* 最小单位（出库用） */
.unit-min {
  color: #409eff;
  font-weight: bold;
  font-size: 16px;
}

/* 换算提示（辅助显示） */
.unit-converted {
  color: #909399;
  font-size: 12px;
}
```

### 图标使用
```
🏥 医务室中央库
🎢 陆园（陆地游乐园）
🌊 水园（水上游乐园）
💊 药品
📦 包装单位
💡 换算提示
✅ 验证通过
❌ 验证失败
⚠️ 警告提示
```

---

## 📊 数据流设计

### 入库流程数据流
```
前端操作:
用户输入 10盒
    ↓
解析规格: 0.25g×24粒/盒
    ↓
提取转换率: 24
    ↓
计算最小单位: 10 × 24 = 240粒
    ↓
提交数据: { quantity: 10, unit: "盒", minQuantity: 240, minUnit: "粒" }
    ↓
云函数处理:
入库审核通过
    ↓
更新库存: stock.quantity += 240 (统一用最小单位)
    ↓
冗余字段: stock.quantityPack += 10 (便于显示)
    ↓
完成入库
```

### 出库流程数据流
```
前端操作:
选择园区: 陆园 (land_park)
    ↓
查询库存: location = "land_park"
    ↓
显示库存: 240粒 (10盒)
    ↓
用户输入: 30粒
    ↓
实时换算: 30 ÷ 24 = 1.25盒
    ↓
库存验证: 30 < 240 ✓
    ↓
提交数据: { quantity: 30, unit: "粒", location: "land_park" }
    ↓
云函数处理:
出库审核通过
    ↓
扣减库存: stock.quantity -= 30  (240 → 210)
    ↓
更新冗余: stock.quantityPack = 210 / 24 = 8.75
    ↓
完成出库
```

---

## 🔧 实现优先级

### P0（立即实现）
```
□ UnitConverter 工具类
□ 入库页面单位转换显示
□ 出库页面单位转换显示
□ 库存页面双单位显示
```

### P1（第二阶段）
```
□ 园区选择器组件
□ 分园区库存查询
□ 库存充足性验证
□ 规格实时验证
```

### P2（第三阶段）
```
□ 分园区统计报表
□ 跨园区调拨
□ 库存预警优化
□ 数据可视化图表
```

---

## 📚 用户操作手册

### 入库操作说明
```
步骤1: 创建入库单
  - 系统自动生成单号
  - 默认入库到"医务室中央库"
  - 选择供应商（可选）

步骤2: 添加药品
  - 点击"选择药品"从列表选择
  - 或点击"新建药品"快速创建
  - 系统自动显示规格和单位

步骤3: 填写批次信息
  - 批号：输入药品批号
  - 生产日期：选择日期
  - 有效期：选择日期（系统自动计算距期）
  - 数量：输入包装单位数量（如10盒）
  - 💡系统自动计算最小单位（如240粒）
  - 单价：输入单价（可选）

步骤4: 签名提交
  - 操作员电子签名
  - 提交复核
  - 等待复核员审核

提示:
✅ 入库数量按包装单位填写（盒、瓶）
✅ 系统自动转换为最小单位存储
✅ 双单位显示便于核对
```

### 出库操作说明
```
步骤1: 创建出库单
  - 系统自动生成单号
  - ⚠️ 必须先选择出库园区（陆园/水园）
  - 填写领药人和备注

步骤2: 选择药品
  - 系统自动显示所选园区的库存
  - 只能选择有库存的药品
  - 显示当前库存（双单位）

步骤3: 填写出库数量
  - 数量：输入最小单位数量（如30粒）
  - 💡系统自动换算包装单位（如1.25盒）
  - ⚠️ 系统自动验证库存是否充足
  - 显示扣减后剩余库存

步骤4: 双签名提交
  - 发药人签名
  - 领药人签名
  - 提交复核
  - 系统自动扣减库存

提示:
✅ 出库数量按最小单位填写（粒、片）
✅ 系统自动换算包装单位供参考
✅ 库存不足时会红色警告
✅ 分园区独立管理库存
```

---

**文档版本**: v3.12  
**设计完成**: 2025-11-06  
**核心功能**: 入库包装单位 + 出库最小单位 + 分园区管理 + 双单位显示

🎨 界面设计完成！建议优先实现入库和出库页面的单位转换功能！

