# ğŸ“ åˆ†å›­åŒºå•ä½è½¬æ¢ç•Œé¢è®¾è®¡ v3.13 æœ€ç»ˆç‰ˆ

**è®¾è®¡æ—¶é—´**: 2025-11-06  
**ç‰ˆæœ¬**: v3.13 Final  
**åŸºäº**: ç”¨æˆ·éœ€æ±‚æ·±åº¦åˆ†æä¸é‡æ–°è®¾è®¡  
**æ ¸å¿ƒå˜æ›´**: ç®€åŒ–æµç¨‹ + æ•´åŒ…è£…å•ä½ + é—¨è¯Šæœ€å°å•ä½æ‰£å‡

---

## ğŸ“‹ éœ€æ±‚é‡æ–°åˆ†æ

### æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ¢³ç†

```
ä¸šåŠ¡åœºæ™¯åˆ†æ:

1ï¸âƒ£ å…¥åº“åœºæ™¯ï¼ˆè¯åº“ï¼‰
   - æ“ä½œäººå‘˜ï¼šé‡‡è´­å‘˜/åº“ç®¡å‘˜
   - æ“ä½œå•ä½ï¼šæ•´åŒ…è£…ï¼ˆç›’ã€ç“¶ã€è¢‹ï¼‰
   - æ•°æ®å­˜å‚¨ï¼šåŒ…è£…å•ä½
   - ä¸¾ä¾‹ï¼šå…¥åº“ 10ç›’ é˜¿è«è¥¿æ—èƒ¶å›Š

2ï¸âƒ£ å‡ºåº“åœºæ™¯ï¼ˆå›­åŒºé¢†ç”¨ï¼‰
   - æ“ä½œäººå‘˜ï¼šå›­åŒºåŒ»åŠ¡äººå‘˜
   - æ“ä½œå•ä½ï¼šæ•´åŒ…è£…ï¼ˆç›’ã€ç“¶ã€è¢‹ï¼‰
   - æ•°æ®å­˜å‚¨ï¼šåŒ…è£…å•ä½
   - ä¸¾ä¾‹ï¼šé™†å›­é¢†ç”¨ 2ç›’ é˜¿è«è¥¿æ—èƒ¶å›Š

3ï¸âƒ£ é—¨è¯Šæ¶ˆè€—åœºæ™¯ï¼ˆå®é™…ç”¨è¯ï¼‰
   - æ“ä½œäººå‘˜ï¼šåŒ»åŠ¡äººå‘˜
   - æ“ä½œå•ä½ï¼šæœ€å°å•ä½ï¼ˆç²’ã€ç‰‡ã€mlï¼‰
   - æ•°æ®å­˜å‚¨ï¼šæœ€å°å•ä½
   - åº“å­˜æ‰£å‡ï¼šä½¿ç”¨æœ€å°å•ä½æ‰£å‡å›­åŒºåº“å­˜
   - ä¸¾ä¾‹ï¼šæ‚£è€…æœç”¨ 6ç²’ é˜¿è«è¥¿æ—èƒ¶å›Š
   
æ ¸å¿ƒè½¬æ¢é€»è¾‘:
âœ… å…¥åº“/å‡ºåº“ï¼šç»Ÿä¸€ä½¿ç”¨æ•´åŒ…è£…å•ä½
âœ… é—¨è¯Šæ¶ˆè€—ï¼šä½¿ç”¨æœ€å°å•ä½ï¼Œéœ€è¦å•ä½è½¬æ¢
âœ… åº“å­˜æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºåŒ…è£…å•ä½ï¼ˆç®€æ´æ˜äº†ï¼‰
âœ… è§„æ ¼è§£æï¼šç”¨æ­£åˆ™è¡¨è¾¾å¼æå–è½¬æ¢ç‡
```

### å•ä½è½¬æ¢æ—¶æœº

```
å…¥åº“æ—¶ï¼šä¸è½¬æ¢
  è¾“å…¥ï¼š10ç›’
  å­˜å‚¨ï¼š10ç›’
  æ˜¾ç¤ºï¼š10ç›’

å‡ºåº“æ—¶ï¼šä¸è½¬æ¢-----å›­åŒºï¼ˆé™†å›­ã€æ°´å›­ï¼‰åº“å­˜ä¸ºæœ€å°å•ä½
  è¾“å…¥ï¼š2ç›’
  å­˜å‚¨ï¼š2ç›’
  æ˜¾ç¤ºï¼š2ç›’
  

é—¨è¯Šæ¶ˆè€—æ—¶ï¼šéœ€è¦è½¬æ¢ 
  è¾“å…¥ï¼š6ç²’
  è§£æè§„æ ¼ï¼š0.25gÃ—24ç²’/ç›’
  æå–è½¬æ¢ç‡ï¼š24   é‡æ–°è®¾è®¡
  è®¡ç®—æ‰£å‡ï¼š6ç²’ Ã· 24 = 0.25ç›’
  æ‰£å‡åº“å­˜ï¼šå½“å‰åº“å­˜ - 0.25ç›’
  å­˜å‚¨ï¼šæœ€å°å•ä½ï¼ˆä¾¿äºç»Ÿè®¡ï¼‰
```

---

## ğŸ”§ æ­£åˆ™è¡¨è¾¾å¼è§„æ ¼è§£ææ–¹æ¡ˆ

### è§„æ ¼æ ¼å¼æ ‡å‡†

```
æ ‡å‡†æ ¼å¼å®šä¹‰:
æ ¼å¼: å‰‚é‡Ã—æ•°é‡å•ä½/åŒ…è£…å•ä½

ç¤ºä¾‹:
âœ… 0.25gÃ—24ç²’/ç›’    â†’ 24ç²’/ç›’
âœ… 0.2gÃ—20ç‰‡/ç›’     â†’ 20ç‰‡/ç›’
âœ… 5mlÃ—10æ”¯/ç›’      â†’ 10æ”¯/ç›’
âœ… 10mlÃ—6ç“¶/ç›’      â†’ 6ç“¶/ç›’
âœ… 3gÃ—10è¢‹/ç›’       â†’ 10è¢‹/ç›’
âœ… 20g/æ”¯           â†’ 1æ”¯/æ”¯ï¼ˆå•ä¸€åŒ…è£…ï¼‰
âœ… 100ml/ç“¶         â†’ 1ml/ç“¶ï¼ˆå•ä¸€åŒ…è£…ï¼‰

ç®€åŒ–æ ¼å¼:
âœ… 24ç²’/ç›’          â†’ 24ç²’/ç›’
âœ… 12ç‰‡             â†’ 12ç‰‡/ç‰‡
```

### æ­£åˆ™è¡¨è¾¾å¼è®¾è®¡

```javascript
/**
 * è§„æ ¼è§£ææ­£åˆ™è¡¨è¾¾å¼ï¼ˆ3ç§æ¨¡å¼ï¼‰
 */
const SPEC_PATTERNS = {
  // æ¨¡å¼1: æ ‡å‡†æ ¼å¼ - å‰‚é‡Ã—æ•°é‡å•ä½/åŒ…è£…å•ä½
  // ç¤ºä¾‹: 0.25gÃ—24ç²’/ç›’
  standard: /^(\d+\.?\d*)(mg|g|ml|Î¼g)?\s*[Ã—x*]\s*(\d+)\s*(ç‰‡|ç²’|æ”¯|ç“¶|è¢‹|ä¸¸|æ»´|ml)\s*[/ï¼]\s*(ç›’|ç“¶|è¢‹|æ¡¶|ç®±)$/i,
  
  // æ¨¡å¼2: ç®€åŒ–æ ¼å¼ - æ•°é‡å•ä½/åŒ…è£…å•ä½
  // ç¤ºä¾‹: 24ç²’/ç›’ æˆ– 0.1Ã—12ç²’/ç›’
  simple: /^(\d+\.?\d*)?[Ã—x*]?\s*(\d+)\s*(ç‰‡|ç²’|æ”¯|ç“¶|è¢‹|ä¸¸|æ»´|ml)\s*[/ï¼]\s*(ç›’|ç“¶|è¢‹|æ¡¶|ç®±)$/i,
  
  // æ¨¡å¼3: å•ä¸€åŒ…è£… - å‰‚é‡/å•ä½
  // ç¤ºä¾‹: 20g/æ”¯ã€100ml/ç“¶
  single: /^(\d+\.?\d*)(mg|g|ml|Î¼g|L)\s*[/ï¼]\s*(æ”¯|ç“¶|è¢‹|æ¡¶)$/i
}

/**
 * è§£æè¯å“è§„æ ¼
 * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
 * @returns {Object|null} è§£æç»“æœ
 */
function parseSpecification(specification) {
  if (!specification || typeof specification !== 'string') {
    return null
  }
  
  // æ¸…ç†ç©ºæ ¼å’Œå…¨è§’å­—ç¬¦
  const spec = specification.trim()
    .replace(/Ã—/g, 'Ã—')
    .replace(/ï¼/g, '/')
  
  // å°è¯•æ¨¡å¼1: æ ‡å‡†æ ¼å¼
  let match = spec.match(SPEC_PATTERNS.standard)
  if (match) {
    return {
      dosage: match[1] ? parseFloat(match[1]) : null,           // 0.25
      dosageUnit: match[2] || null,                             // g
      conversionRate: parseInt(match[3]),                       // 24
      minUnit: match[4],                                        // ç²’
      packUnit: match[5],                                       // ç›’
      fullSpec: specification,
      pattern: 'standard'
    }
  }
  
  // å°è¯•æ¨¡å¼2: ç®€åŒ–æ ¼å¼ï¼ˆåŒ…æ‹¬ 0.1Ã—12ç²’/ç›’ è¿™ç§æƒ…å†µï¼‰
  match = spec.match(SPEC_PATTERNS.simple)
  if (match) {
    return {
      dosage: match[1] ? parseFloat(match[1]) : null,           // 0.1ï¼ˆå¦‚æœæœ‰ï¼‰
      dosageUnit: null,
      conversionRate: parseInt(match[2]),                       // 12
      minUnit: match[3],                                        // ç²’
      packUnit: match[4],                                       // ç›’
      fullSpec: specification,
      pattern: 'simple'
    }
  }
  
  // å°è¯•æ¨¡å¼3: å•ä¸€åŒ…è£…
  match = spec.match(SPEC_PATTERNS.single)
  if (match) {
    return {
      dosage: parseFloat(match[1]),                             // 20
      dosageUnit: match[2],                                     // g
      conversionRate: 1,                                        // 1ï¼ˆå•ä¸€åŒ…è£…ï¼‰
      minUnit: match[3],                                        // æ”¯
      packUnit: match[3],                                       // æ”¯
      fullSpec: specification,
      pattern: 'single'
    }
  }
  
  // æ— æ³•è§£æ
  console.warn(`æ— æ³•è§£æè§„æ ¼: ${specification}`)
  return null
}

/**
 * æµ‹è¯•ç”¨ä¾‹
 */
function testSpecificationParser() {
  const testCases = [
    '0.25gÃ—24ç²’/ç›’',      // æ ‡å‡†æ ¼å¼
    '0.2gÃ—20ç‰‡/ç›’',       // æ ‡å‡†æ ¼å¼
    '5mlÃ—10æ”¯/ç›’',        // æ ‡å‡†æ ¼å¼
    '0.1Ã—12ç²’/ç›’',        // ç®€åŒ–æ ¼å¼ï¼ˆå…³é”®æµ‹è¯•ï¼‰
    '24ç²’/ç›’',            // ç®€åŒ–æ ¼å¼
    '20g/æ”¯',             // å•ä¸€åŒ…è£…
    '100ml/ç“¶',           // å•ä¸€åŒ…è£…
    '3gÃ—10è¢‹/ç›’'          // æ ‡å‡†æ ¼å¼
  ]
  
  console.log('è§„æ ¼è§£ææµ‹è¯•ç»“æœ:')
  console.log('â”'.repeat(80))
  
  testCases.forEach(spec => {
    const result = parseSpecification(spec)
    if (result) {
      console.log(`âœ… ${spec}`)
      console.log(`   è½¬æ¢ç‡: ${result.conversionRate} (1${result.packUnit} = ${result.conversionRate}${result.minUnit})`)
      console.log(`   å‰‚é‡: ${result.dosage}${result.dosageUnit || ''}`)
      console.log(`   æ¨¡å¼: ${result.pattern}`)
    } else {
      console.log(`âŒ ${spec} - è§£æå¤±è´¥`)
    }
    console.log('â”€'.repeat(80))
  })
}

// æ‰§è¡Œæµ‹è¯•
// testSpecificationParser()

/**
 * è¾“å‡ºç¤ºä¾‹:
 * 
 * âœ… 0.25gÃ—24ç²’/ç›’
 *    è½¬æ¢ç‡: 24 (1ç›’ = 24ç²’)
 *    å‰‚é‡: 0.25g
 *    æ¨¡å¼: standard
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * âœ… 0.1Ã—12ç²’/ç›’
 *    è½¬æ¢ç‡: 12 (1ç›’ = 12ç²’)
 *    å‰‚é‡: 0.1
 *    æ¨¡å¼: simple
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */
```

### å•ä½è½¬æ¢å·¥å…·ç±»ï¼ˆå®Œæ•´ç‰ˆï¼‰

```javascript
/**
 * å•ä½è½¬æ¢å·¥å…·ç±»
 * @file utils/unitConverter.js
 */
class UnitConverter {
  /**
   * è§„æ ¼è§£æï¼ˆå®Œæ•´ç‰ˆï¼‰
   */
  static parseSpecification(specification) {
    // [ä¸Šé¢çš„å®Œæ•´ä»£ç ]
  }
  
  /**
   * åŒ…è£…å•ä½ â†’ æœ€å°å•ä½
   * @param {Number} packQuantity - åŒ…è£…æ•°é‡ï¼ˆå¦‚2ç›’ï¼‰
   * @param {Number} conversionRate - è½¬æ¢ç‡ï¼ˆå¦‚24ï¼‰
   * @returns {Number} æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚48ç²’ï¼‰
   */
  static packToMin(packQuantity, conversionRate) {
    return packQuantity * conversionRate
  }
  
  /**
   * æœ€å°å•ä½ â†’ åŒ…è£…å•ä½
   * @param {Number} minQuantity - æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚30ç²’ï¼‰
   * @param {Number} conversionRate - è½¬æ¢ç‡ï¼ˆå¦‚24ï¼‰
   * @returns {Number} åŒ…è£…æ•°é‡ï¼ˆå¦‚1.25ç›’ï¼‰
   */
  static minToPack(minQuantity, conversionRate) {
    return minQuantity / conversionRate
  }
  
  /**
   * æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆä»…åŒ…è£…å•ä½ï¼‰
   * @param {Number} packQuantity - åŒ…è£…æ•°é‡
   * @param {String} packUnit - åŒ…è£…å•ä½
   * @returns {String} æ ¼å¼åŒ–å­—ç¬¦ä¸²
   */
  static formatPack(packQuantity, packUnit) {
    // æ•´æ•°æ˜¾ç¤º
    if (Number.isInteger(packQuantity)) {
      return `${packQuantity}${packUnit}`
    }
    // å°æ•°æ˜¾ç¤ºï¼ˆä¿ç•™2ä½ï¼‰
    return `${packQuantity.toFixed(2)}${packUnit}`
  }
  
  /**
   * éªŒè¯è§„æ ¼æ ¼å¼
   * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
   * @returns {Boolean} æ˜¯å¦æœ‰æ•ˆ
   */
  static isValidSpec(specification) {
    return this.parseSpecification(specification) !== null
  }
}

export default UnitConverter
```

---

## ğŸ¨ ç•Œé¢è®¾è®¡ï¼ˆé‡æ–°è®¾è®¡ï¼‰

## è®¾è®¡1ï¼šå…¥åº“å•ç•Œé¢ï¼ˆæ•´åŒ…è£…å…¥åº“ï¼‰

### ç•Œé¢å¸ƒå±€ï¼ˆç®€åŒ–ç‰ˆï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æ–°å»ºå…¥åº“å•                          [ä¿å­˜]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ“¦ å…¥åº“ä¿¡æ¯                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å…¥åº“å•å·  RK20251106001                 â”‚â”‚
â”‚ â”‚ å…¥åº“æ—¥æœŸ  2025-11-06 10:30              â”‚â”‚
â”‚ â”‚ æ“ä½œå‘˜    å¼ ä¸‰                          â”‚â”‚
â”‚ â”‚ ä¾›åº”å•†    [å›½è¯æ§è‚¡_______________] â–¼  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š è¯å“æ˜ç»† (3ç§)            [ğŸ“‹é€‰æ‹©][âœï¸æ–°å»º]â”‚
â”‚                                             â”‚
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚ â•‘ # â”‚ è¯å“åç§° â”‚ è§„æ ¼ â”‚ æ‰¹å· â”‚ ç”Ÿäº§ â”‚ æœ‰æ•ˆ â”‚ è·æœŸ â”‚ æ•°é‡ â”‚ å•ä½ â”‚ å•ä»· â”‚ é‡‘é¢ â”‚ æ“ä½œ â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 1 â”‚ é˜¿è«è¥¿æ— â”‚ 0.25gâ”‚20250â”‚2025-â”‚2027-â”‚730å¤©â”‚ 10  â”‚ ç›’  â”‚12.5 â”‚125  â”‚ ğŸ—‘  â•‘
â”‚ â•‘   â”‚ èƒ¶å›Š     â”‚Ã—24ç²’ â”‚101  â”‚01-01â”‚01-01â”‚  âœ“ â”‚     â”‚     â”‚     â”‚     â”‚     â•‘
â”‚ â•‘   â”‚          â”‚/ç›’   â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â”‚     â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 2 â”‚ å¸ƒæ´›èŠ¬ç‰‡ â”‚ 0.2g â”‚20250â”‚2025-â”‚2027-â”‚731å¤©â”‚ 15  â”‚ ç›’  â”‚18.0 â”‚270  â”‚ ğŸ—‘  â•‘
â”‚ â•‘   â”‚          â”‚Ã—20ç‰‡ â”‚102  â”‚01-02â”‚01-02â”‚  âœ“ â”‚     â”‚     â”‚     â”‚     â”‚     â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 3 â”‚ å¯¹ä¹™é…°æ°¨â”‚ 0.5g â”‚20250â”‚2025-â”‚2027-â”‚729å¤©â”‚ 20  â”‚ ç›’  â”‚15.0 â”‚300  â”‚ ğŸ—‘  â•‘
â”‚ â•‘   â”‚ åŸºé…šç‰‡  â”‚Ã—12ç‰‡ â”‚103  â”‚01-03â”‚01-03â”‚  âœ“ â”‚     â”‚     â”‚     â”‚     â”‚     â•‘
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                             â”‚
â”‚ ğŸ“Š æ±‡æ€»                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å“ç§: 3ç§  |  æ•°é‡: 45ç›’  |  é‡‘é¢: Â¥695 â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ âœï¸ æ“ä½œå‘˜ç­¾å *                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ [ç‚¹å‡»ç­¾å]                    æœªç­¾å    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ’¾ ä¿å­˜è‰ç¨¿]              [âœ“ æäº¤å¤æ ¸]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®ç»“æ„
```javascript
// å…¥åº“å•æ•°æ®ç»“æ„
{
  recordNo: "RK20251106001",
  location: "drug_storage",      // è¯åº“ï¼ˆä¸å†ç”¨central_storageï¼‰
  locationName: "è¯åº“",
  supplier: "å›½è¯æ§è‚¡",
  items: [
    {
      drugId: "drug_001",
      drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
      specification: "0.25gÃ—24ç²’/ç›’",
      
      // å…³é”®ï¼šåªå­˜å‚¨åŒ…è£…å•ä½
      quantity: 10,
      unit: "ç›’",
      
      batch: "20250101",
      productionDate: "2025-01-01",
      expireDate: "2027-01-01",
      price: 12.5,
      amount: 125.0
    }
  ],
  operator: "å¼ ä¸‰",
  operatorId: "user_001",
  operatorSign: "cloud://sign_001.png",
  createTime: "2025-11-06T10:30:00",
  status: "pending_review"
}

// å…¥åº“ååº“å­˜æ•°æ®ç»“æ„
stock é›†åˆ:
{
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25gÃ—24ç²’/ç›’",
  
  // å…³é”®ï¼šåªå­˜å‚¨åŒ…è£…å•ä½
  quantity: 10,           // 10ç›’
  unit: "ç›’",
  
  // è§„æ ¼ä¿¡æ¯ï¼ˆç”¨äºé—¨è¯Šæ¶ˆè€—æ—¶è½¬æ¢ï¼‰
  specInfo: {
    conversionRate: 24,   // è½¬æ¢ç‡
    minUnit: "ç²’",        // æœ€å°å•ä½
    packUnit: "ç›’"        // åŒ…è£…å•ä½
  },
  
  location: "drug_storage",
  locationName: "è¯åº“",
  batch: "20250101",
  productionDate: "2025-01-01",
  expireDate: "2027-01-01",
  price: 12.5
}
```

---

## è®¾è®¡2ï¼šå‡ºåº“å•ç•Œé¢ï¼ˆæ•´åŒ…è£…å‡ºåº“ï¼‰

### ç•Œé¢å¸ƒå±€ï¼ˆç®€åŒ–ä¼˜åŒ–ç‰ˆï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æ–°å»ºå‡ºåº“å•                          [ä¿å­˜]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ¯ å‡ºåº“ä¿¡æ¯                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å‡ºåº“å•å·  CK20251106001                 â”‚â”‚
â”‚ â”‚ å‡ºåº“æ—¥æœŸ  2025-11-06 14:30              â”‚â”‚
â”‚ â”‚ å‘è¯äºº    å¼ ä¸‰                          â”‚â”‚
â”‚ â”‚                                         â”‚â”‚
â”‚ â”‚ å‡ºåº“å›­åŒº * [è¯·é€‰æ‹©å›­åŒº____________] â–¼  â”‚â”‚â—„â”€ å¿…é€‰
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚ â”‚ â”‚ ğŸ¢ é™†å›­åŒ»åŠ¡å®¤                     â”‚  â”‚â”‚
â”‚ â”‚ â”‚ ğŸŒŠ æ°´å›­åŒ»åŠ¡å®¤                     â”‚  â”‚â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚ â”‚                                         â”‚â”‚
â”‚ â”‚ é¢†è¯äºº    [ç‹äº”___________________]    â”‚â”‚
â”‚ â”‚ å¤‡æ³¨      [é™†å›­æ—¥å¸¸è¡¥å……____________]   â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š è¯å“æ˜ç»† (2ç§)            [ğŸ“‹é€‰æ‹©]      â”‚
â”‚                                             â”‚
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚ â•‘ # â”‚ è¯å“åç§° â”‚ è§„æ ¼ â”‚ æ‰¹å· â”‚ æœ‰æ•ˆæœŸ â”‚ è¯åº“åº“å­˜ â”‚ å‡ºåº“æ•°é‡ â”‚ å•ä½ â”‚ æ“ä½œ â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 1 â”‚ é˜¿è«è¥¿æ— â”‚ 0.25gâ”‚20250â”‚2027-  â”‚ 10ç›’    â”‚ [2___] â”‚ ç›’  â”‚ ğŸ—‘  â•‘
â”‚ â•‘   â”‚ èƒ¶å›Š     â”‚Ã—24ç²’ â”‚101  â”‚01-01  â”‚    âœ“   â”‚        â”‚     â”‚     â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 2 â”‚ å¸ƒæ´›èŠ¬ç‰‡ â”‚ 0.2g â”‚20250â”‚2027-  â”‚ 15ç›’    â”‚ [3___] â”‚ ç›’  â”‚ ğŸ—‘  â•‘
â”‚ â•‘   â”‚          â”‚Ã—20ç‰‡ â”‚102  â”‚01-02  â”‚    âœ“   â”‚        â”‚     â”‚     â•‘
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                             â”‚
â”‚ âœï¸ åŒç­¾å                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å‘è¯äººç­¾å: [å·²ç­¾å] âœ“ å¼ ä¸‰             â”‚â”‚
â”‚ â”‚ é¢†è¯äººç­¾å: [ç‚¹å‡»ç­¾å]    æœªç­¾å        â”‚â”‚
â”‚ â”‚ å¤æ ¸äººç­¾å: [ç‚¹å‡»ç­¾å]    æœªç­¾å        â”‚â”‚â—„â”€ æ–°å¢å¤æ ¸äºº
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ’¾ ä¿å­˜è‰ç¨¿]              [âœ“ æäº¤å¤æ ¸]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®ç»“æ„
```javascript
// å‡ºåº“å•æ•°æ®ç»“æ„
{
  recordNo: "CK20251106001",
  fromLocation: "drug_storage",  // ä»è¯åº“å‡ºåº“
  toLocation: "land_park",       // åˆ°é™†å›­
  toLocationName: "é™†å›­åŒ»åŠ¡å®¤",
  items: [
    {
      drugId: "drug_001",
      drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
      specification: "0.25gÃ—24ç²’/ç›’",
      batch: "20250101",
      
      // å…³é”®ï¼šåªä½¿ç”¨åŒ…è£…å•ä½
      quantity: 2,
      unit: "ç›’",
      
      // åº“å­˜ä¿¡æ¯ï¼ˆç”¨äºéªŒè¯ï¼‰
      stockId: "stock_001",
      beforeQuantity: 10,  // æ‰£å‡å‰ï¼š10ç›’
      afterQuantity: 8     // æ‰£å‡åï¼š8ç›’
    }
  ],
  dispenser: "å¼ ä¸‰",       // å‘è¯äºº
  dispenserId: "user_001",
  dispenserSign: "cloud://sign_001.png",
  receiver: "ç‹äº”",        // é¢†è¯äºº
  receiverId: "user_003",
  receiverSign: "cloud://sign_003.png",
  reviewer: "",            // å¤æ ¸äººï¼ˆæ–°å¢ï¼‰
  reviewerId: "",
  reviewerSign: "",
  remark: "é™†å›­æ—¥å¸¸è¡¥å……",
  createTime: "2025-11-06T14:30:00",
  status: "pending_review"
}

// å‡ºåº“ååº“å­˜å˜åŒ–
// è¯åº“åº“å­˜æ‰£å‡
stock é›†åˆ (location: drug_storage):
{
  drugId: "drug_001",
  quantity: 10 â†’ 8,  // æ‰£å‡2ç›’
  unit: "ç›’"
}

// å›­åŒºåº“å­˜å¢åŠ 
stock é›†åˆ (location: land_park):
{
  drugId: "drug_001",
  quantity: 5 â†’ 7,   // å¢åŠ 2ç›’
  unit: "ç›’"
}
```

---

## è®¾è®¡3ï¼šé—¨è¯Šæ¶ˆè€—ç•Œé¢ï¼ˆæœ€å°å•ä½æ‰£å‡ï¼‰

### ç•Œé¢å¸ƒå±€ï¼ˆæ–°å¢è®¾è®¡ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† é—¨è¯Šç™»è®°                            [ä¿å­˜]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ¥ æ‚£è€…ä¿¡æ¯                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å§“å      [å¼ ä¸‰____________________]    â”‚â”‚
â”‚ â”‚ å¹´é¾„      [28___] å²  æ€§åˆ« âšªç”· âšªå¥³   â”‚â”‚
â”‚ â”‚ ç—‡çŠ¶      [å‘çƒ­ã€å’³å—½_______________]   â”‚â”‚
â”‚ â”‚ æ‰€åœ¨å›­åŒº  ğŸ¢ é™†å›­åŒ»åŠ¡å®¤              â–¼ â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š ç”¨è¯æ˜ç»† (2ç§)            [ğŸ“‹é€‰æ‹©]      â”‚
â”‚                                             â”‚
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚ â•‘ # â”‚ è¯å“åç§° â”‚ è§„æ ¼ â”‚ æ‰¹å· â”‚ åº“å­˜ â”‚ ç”¨é‡ â”‚ å•ä½ â”‚ ğŸ’¡æ¢ç®— â”‚ æ“ä½œ â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 1 â”‚ é˜¿è«è¥¿æ— â”‚ 0.25gâ”‚20250â”‚ 7ç›’ â”‚ [6__]â”‚ ç²’  â”‚0.25ç›’ â”‚ ğŸ—‘  â•‘â—„â”€ æœ€å°å•ä½
â”‚ â•‘   â”‚ èƒ¶å›Š     â”‚Ã—24ç²’ â”‚101  â”‚ âœ“   â”‚      â”‚     â”‚â•â•â•â•â•â• â”‚     â•‘
â”‚ â•‘   â”‚          â”‚/ç›’   â”‚     â”‚     â”‚      â”‚     â”‚è‡ªåŠ¨æ¢ â”‚     â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 2 â”‚ å¸ƒæ´›èŠ¬ç‰‡ â”‚ 0.2g â”‚20250â”‚ 3ç›’ â”‚ [4__]â”‚ ç‰‡  â”‚0.2ç›’  â”‚ ğŸ—‘  â•‘
â”‚ â•‘   â”‚          â”‚Ã—20ç‰‡ â”‚102  â”‚ âœ“   â”‚      â”‚     â”‚â•â•â•â•â•â• â”‚     â•‘
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                             â”‚
â”‚ ğŸ’¡ è¯´æ˜                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â€¢ ç”¨é‡æŒ‰æœ€å°å•ä½å¡«å†™ï¼ˆç²’ã€ç‰‡ã€mlï¼‰      â”‚â”‚
â”‚ â”‚ â€¢ ç³»ç»Ÿè‡ªåŠ¨æ¢ç®—ä¸ºåŒ…è£…å•ä½å¹¶æ‰£å‡åº“å­˜      â”‚â”‚
â”‚ â”‚ â€¢ è¯å“åº“å­˜æ¥æºï¼šå½“å‰å›­åŒº                â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ“ è¯Šæ–­è®°å½•                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ [ä¸Šå‘¼å¸é“æ„ŸæŸ“________________________] â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å–æ¶ˆ]                          [ä¿å­˜è®°å½•]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®ç»“æ„ä¸æ‰£å‡é€»è¾‘
```javascript
// é—¨è¯Šè®°å½•æ•°æ®ç»“æ„
{
  recordNo: "MZ20251106001",
  patientName: "å¼ ä¸‰",
  patientAge: 28,
  patientGender: "ç”·",
  symptom: "å‘çƒ­ã€å’³å—½",
  diagnosis: "ä¸Šå‘¼å¸é“æ„ŸæŸ“",
  location: "land_park",
  locationName: "é™†å›­åŒ»åŠ¡å®¤",
  items: [
    {
      drugId: "drug_001",
      drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
      specification: "0.25gÃ—24ç²’/ç›’",
      batch: "20250101",
      
      // å…³é”®ï¼šç”¨æœ€å°å•ä½è®°å½•
      quantity: 6,
      unit: "ç²’",
      
      // è§„æ ¼ä¿¡æ¯ï¼ˆç”¨äºè½¬æ¢ï¼‰
      specInfo: {
        conversionRate: 24,
        minUnit: "ç²’",
        packUnit: "ç›’"
      },
      
      // è½¬æ¢åçš„åŒ…è£…æ•°é‡ï¼ˆç”¨äºæ‰£å‡åº“å­˜ï¼‰
      packQuantity: 0.25,  // 6 Ã· 24 = 0.25ç›’
      packUnit: "ç›’"
    },
    {
      drugId: "drug_002",
      drugName: "å¸ƒæ´›èŠ¬ç‰‡",
      specification: "0.2gÃ—20ç‰‡/ç›’",
      batch: "20250102",
      quantity: 4,
      unit: "ç‰‡",
      specInfo: {
        conversionRate: 20,
        minUnit: "ç‰‡",
        packUnit: "ç›’"
      },
      packQuantity: 0.2,  // 4 Ã· 20 = 0.2ç›’
      packUnit: "ç›’"
    }
  ],
  doctor: "æåŒ»ç”Ÿ",
  doctorId: "user_002",
  createTime: "2025-11-06T15:00:00"
}

// é—¨è¯Šæ¶ˆè€—ååº“å­˜æ‰£å‡ï¼ˆå…³é”®é€»è¾‘ï¼‰
stock é›†åˆ (location: land_park):
{
  drugId: "drug_001",
  quantity: 7 â†’ 6.75,  // æ‰£å‡0.25ç›’ï¼ˆ6ç²’ï¼‰
  unit: "ç›’"
}
{
  drugId: "drug_002",
  quantity: 3 â†’ 2.8,   // æ‰£å‡0.2ç›’ï¼ˆ4ç‰‡ï¼‰
  unit: "ç›’"
}
```

### æ‰£å‡é€»è¾‘ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
```javascript
/**
 * é—¨è¯Šæ¶ˆè€—æ‰£å‡åº“å­˜
 * @param {String} drugId - è¯å“ID
 * @param {String} location - å›­åŒº
 * @param {Number} minQuantity - æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚6ç²’ï¼‰
 * @param {Object} specInfo - è§„æ ¼ä¿¡æ¯
 * @returns {Boolean} æ˜¯å¦æˆåŠŸ
 */
async function deductStockForClinic(drugId, location, minQuantity, specInfo) {
  // 1. è½¬æ¢ä¸ºåŒ…è£…å•ä½
  const packQuantity = UnitConverter.minToPack(minQuantity, specInfo.conversionRate)
  
  // 2. æŸ¥è¯¢å½“å‰åº“å­˜
  const stock = await db.collection('stock')
    .where({
      drugId: drugId,
      location: location
    })
    .get()
  
  if (stock.data.length === 0) {
    throw new Error('è¯¥å›­åŒºæ— æ­¤è¯å“åº“å­˜')
  }
  
  const currentStock = stock.data[0]
  
  // 3. éªŒè¯åº“å­˜æ˜¯å¦å……è¶³
  if (currentStock.quantity < packQuantity) {
    throw new Error(`åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜: ${currentStock.quantity}${currentStock.unit}ï¼Œéœ€è¦: ${packQuantity}${currentStock.unit}`)
  }
  
  // 4. æ‰£å‡åº“å­˜ï¼ˆä¿ç•™å°æ•°ï¼‰
  const newQuantity = currentStock.quantity - packQuantity
  
  await db.collection('stock').doc(currentStock._id).update({
    data: {
      quantity: newQuantity,
      updateTime: new Date()
    }
  })
  
  console.log(`âœ… åº“å­˜æ‰£å‡æˆåŠŸ: ${minQuantity}${specInfo.minUnit} (${packQuantity}${specInfo.packUnit})`)
  return true
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
// æ‚£è€…æœç”¨ 6ç²’ é˜¿è«è¥¿æ—
await deductStockForClinic(
  'drug_001',          // è¯å“ID
  'land_park',         // é™†å›­
  6,                   // 6ç²’
  {                    // è§„æ ¼ä¿¡æ¯
    conversionRate: 24,
    minUnit: 'ç²’',
    packUnit: 'ç›’'
  }
)
// ç»“æœ: åº“å­˜ä» 7ç›’ â†’ 6.75ç›’
```

---

## è®¾è®¡4ï¼šåº“å­˜åˆ—è¡¨ç•Œé¢ï¼ˆåªæ˜¾ç¤ºåŒ…è£…å•ä½ï¼‰

### ç•Œé¢å¸ƒå±€ï¼ˆç®€åŒ–ç‰ˆï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† åº“å­˜ç®¡ç†                          [æœç´¢]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ¥ å›­åŒºç­›é€‰                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ â— å…¨éƒ¨â”‚  é™†å›­ â”‚  æ°´å›­ â”‚  è¯åº“ â”‚         â”‚â—„â”€ æ ‡ç­¾åˆ‡æ¢
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                             â”‚
â”‚ ğŸ“Š åº“å­˜ç»Ÿè®¡å¡ç‰‡                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ğŸ¢ é™†å›­       â”‚ ğŸŒŠ æ°´å›­       â”‚ ğŸ¥ è¯åº“   â”‚â”‚
â”‚ â”‚ å“ç§: 28     â”‚ å“ç§: 25     â”‚ å“ç§: 95  â”‚â”‚
â”‚ â”‚ æ€»é‡: 98ç›’   â”‚ æ€»é‡: 79ç›’   â”‚æ€»é‡: 521ç›’â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š åº“å­˜æ˜ç»†åˆ—è¡¨                              â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ é˜¿è«è¥¿æ—èƒ¶å›Š                 ğŸ¢ é™†å›­    â”‚â”‚
â”‚ â”‚ 0.25gÃ—24ç²’/ç›’ | æ‰¹å·: 20250101         â”‚â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚ â”‚ ğŸ’Š å½“å‰åº“å­˜: 6.75ç›’               âœ“    â”‚â”‚â—„â”€ åªæ˜¾ç¤ºåŒ…è£…å•ä½
â”‚ â”‚ ğŸ“… æœ‰æ•ˆæœŸ: 2027-01-01 (730å¤©)          â”‚â”‚
â”‚ â”‚ ğŸ’° å•ä»·: Â¥12.5/ç›’                      â”‚â”‚
â”‚ â”‚                                  [è¯¦æƒ…]â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å¸ƒæ´›èŠ¬ç‰‡                     ğŸŒŠ æ°´å›­    â”‚â”‚
â”‚ â”‚ 0.2gÃ—20ç‰‡/ç›’ | æ‰¹å·: 20250102          â”‚â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚ â”‚ ğŸ’Š å½“å‰åº“å­˜: 2.8ç›’                âœ“    â”‚â”‚â—„â”€ å…è®¸å°æ•°
â”‚ â”‚ ğŸ“… æœ‰æ•ˆæœŸ: 2027-01-02 (731å¤©)          â”‚â”‚
â”‚ â”‚ ğŸ’° å•ä»·: Â¥18.0/ç›’                      â”‚â”‚
â”‚ â”‚                                  [è¯¦æƒ…]â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å¯¹ä¹™é…°æ°¨åŸºé…šç‰‡               ğŸ¥ è¯åº“    â”‚â”‚
â”‚ â”‚ 0.5gÃ—12ç‰‡/ç›’ | æ‰¹å·: 20250103          â”‚â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚ â”‚ ğŸ’Š å½“å‰åº“å­˜: 104ç›’                âœ“    â”‚â”‚â—„â”€ æ•´æ•°æ˜¾ç¤º
â”‚ â”‚ ğŸ“… æœ‰æ•ˆæœŸ: 2027-01-03 (729å¤©)          â”‚â”‚
â”‚ â”‚ ğŸ’° å•ä»·: Â¥15.0/ç›’                      â”‚â”‚
â”‚ â”‚                                  [è¯¦æƒ…]â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ˜¾ç¤ºæ ¼å¼ç®—æ³•
```javascript
/**
 * æ ¼å¼åŒ–åº“å­˜æ•°é‡æ˜¾ç¤ºï¼ˆç®€åŒ–ç‰ˆï¼‰
 * @param {Number} quantity - æ•°é‡
 * @param {String} unit - å•ä½
 * @returns {String} æ ¼å¼åŒ–å­—ç¬¦ä¸²
 */
function formatStockDisplay(quantity, unit) {
  // æ•´æ•°æ˜¾ç¤º
  if (Number.isInteger(quantity)) {
    return `${quantity}${unit}`
  }
  
  // å°æ•°æ˜¾ç¤ºï¼ˆä¿ç•™2ä½ï¼‰
  return `${quantity.toFixed(2)}${unit}`
}

// ä½¿ç”¨ç¤ºä¾‹
console.log(formatStockDisplay(10, 'ç›’'))     // "10ç›’"
console.log(formatStockDisplay(6.75, 'ç›’'))   // "6.75ç›’"
console.log(formatStockDisplay(2.8, 'ç›’'))    // "2.80ç›’"
console.log(formatStockDisplay(104, 'ç›’'))    // "104ç›’"
```

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

### å®Œæ•´æµç¨‹æ¼”ç¤º

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åœºæ™¯: é˜¿è«è¥¿æ—èƒ¶å›Šçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
è¯å“è§„æ ¼: 0.25gÃ—24ç²’/ç›’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬1æ­¥: é‡‡è´­å…¥åº“åˆ°è¯åº“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ“ä½œ: å…¥åº“ 10ç›’
å­˜å‚¨: 
  location: drug_storage
  quantity: 10
  unit: ç›’

ç»“æœ: è¯åº“åº“å­˜ = 10ç›’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬2æ­¥: å‡ºåº“åˆ°é™†å›­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ“ä½œ: å‡ºåº“ 2ç›’ åˆ°é™†å›­
æ‰£å‡: 
  è¯åº“: 10ç›’ â†’ 8ç›’
  é™†å›­: 0ç›’ â†’ 2ç›’

ç»“æœ: 
  è¯åº“åº“å­˜ = 8ç›’
  é™†å›­åº“å­˜ = 2ç›’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬3æ­¥: é—¨è¯Šæ¶ˆè€—ï¼ˆæ‚£è€…1ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ“ä½œ: æ‚£è€…æœç”¨ 6ç²’
è½¬æ¢: 
  è§„æ ¼è§£æ: 0.25gÃ—24ç²’/ç›’ â†’ conversionRate = 24
  å•ä½è½¬æ¢: 6ç²’ Ã· 24 = 0.25ç›’
æ‰£å‡: 
  é™†å›­: 2ç›’ â†’ 1.75ç›’

ç»“æœ: 
  è¯åº“åº“å­˜ = 8ç›’
  é™†å›­åº“å­˜ = 1.75ç›’
  
è®°å½•: 
  quantity: 6
  unit: ç²’
  packQuantity: 0.25
  packUnit: ç›’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬4æ­¥: é—¨è¯Šæ¶ˆè€—ï¼ˆæ‚£è€…2ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ“ä½œ: æ‚£è€…æœç”¨ 12ç²’
è½¬æ¢: 12ç²’ Ã· 24 = 0.5ç›’
æ‰£å‡: 
  é™†å›­: 1.75ç›’ â†’ 1.25ç›’

ç»“æœ: 
  è¯åº“åº“å­˜ = 8ç›’
  é™†å›­åº“å­˜ = 1.25ç›’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬5æ­¥: é—¨è¯Šæ¶ˆè€—ï¼ˆæ‚£è€…3ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ“ä½œ: æ‚£è€…æœç”¨ 18ç²’
è½¬æ¢: 18ç²’ Ã· 24 = 0.75ç›’
æ‰£å‡: 
  é™†å›­: 1.25ç›’ â†’ 0.5ç›’

ç»“æœ: 
  è¯åº“åº“å­˜ = 8ç›’
  é™†å›­åº“å­˜ = 0.5ç›’ï¼ˆå³12ç²’ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬6æ­¥: å†æ¬¡è¡¥è´§åˆ°é™†å›­
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ“ä½œ: å‡ºåº“ 3ç›’ åˆ°é™†å›­
æ‰£å‡: 
  è¯åº“: 8ç›’ â†’ 5ç›’
  é™†å›­: 0.5ç›’ â†’ 3.5ç›’

ç»“æœ: 
  è¯åº“åº“å­˜ = 5ç›’
  é™†å›­åº“å­˜ = 3.5ç›’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ€»ç»“:
âœ… å…¥åº“/å‡ºåº“: å§‹ç»ˆä½¿ç”¨æ•´åŒ…è£…å•ä½ï¼ˆç›’ï¼‰
âœ… é—¨è¯Šæ¶ˆè€—: ä½¿ç”¨æœ€å°å•ä½ï¼ˆç²’ï¼‰ï¼Œè‡ªåŠ¨è½¬æ¢æ‰£å‡
âœ… åº“å­˜æ˜¾ç¤º: ç»Ÿä¸€æ˜¾ç¤ºåŒ…è£…å•ä½ï¼Œå…è®¸å°æ•°
âœ… æ•°æ®å‡†ç¡®: æ‰€æœ‰æ“ä½œéƒ½æœ‰ç²¾ç¡®çš„æ•°é‡è®°å½•
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡ï¼ˆæœ€ç»ˆç‰ˆï¼‰

### drugs é›†åˆï¼ˆè¯å“æ¡£æ¡ˆï¼‰
```javascript
{
  _id: "drug_001",
  name: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  genericName: "é˜¿è«è¥¿æ—",
  specification: "0.25gÃ—24ç²’/ç›’",        // åŸå§‹è§„æ ¼
  
  // ===== æ–°å¢ï¼šè§„æ ¼è§£æä¿¡æ¯ =====
  specInfo: {
    dosage: 0.25,                        // å‰‚é‡
    dosageUnit: "g",                     // å‰‚é‡å•ä½
    conversionRate: 24,                  // è½¬æ¢ç‡ï¼ˆå…³é”®ï¼‰
    minUnit: "ç²’",                       // æœ€å°å•ä½
    packUnit: "ç›’",                      // åŒ…è£…å•ä½
    pattern: "standard"                  // è§£ææ¨¡å¼
  },
  
  manufacturer: "ååŒ—åˆ¶è¯",
  category: "æŠ—ç”Ÿç´ ",
  barcode: "6901234567890",
  
  lowStockThreshold: 5,                  // é¢„è­¦é˜ˆå€¼ï¼ˆåŒ…è£…å•ä½ï¼‰
  
  isHighValue: false,
  isEmergency: false,
  isPrescription: false,
  
  createTime: ISODate("2025-01-01"),
  updateTime: ISODate("2025-01-01")
}

// ç´¢å¼•
db.drugs.createIndex({ "name": 1 })
db.drugs.createIndex({ "barcode": 1 }, { unique: true })
db.drugs.createIndex({ "category": 1 })
db.drugs.createIndex({ "specInfo.packUnit": 1 })
```

### stock é›†åˆï¼ˆåº“å­˜æ‰¹æ¬¡ï¼‰
```javascript
{
  _id: "stock_001",
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",            // å†—ä½™
  specification: "0.25gÃ—24ç²’/ç›’",      // å†—ä½™
  
  // ===== æ ¸å¿ƒï¼šåªå­˜å‚¨åŒ…è£…å•ä½ =====
  quantity: 6.75,                      // æ•°é‡ï¼ˆå…è®¸å°æ•°ï¼‰
  unit: "ç›’",                          // å•ä½
  
  // ===== è§„æ ¼ä¿¡æ¯ï¼ˆå†—ä½™ï¼Œç”¨äºé—¨è¯Šè½¬æ¢ï¼‰ =====
  specInfo: {
    conversionRate: 24,
    minUnit: "ç²’",
    packUnit: "ç›’"
  },
  
  batch: "20250101",
  productionDate: ISODate("2025-01-01"),
  expireDate: ISODate("2027-01-01"),
  
  location: "land_park",               // å›­åŒº
  locationName: "é™†å›­åŒ»åŠ¡å®¤",
  
  price: 12.5,
  manufacturer: "ååŒ—åˆ¶è¯",
  
  lockQuantity: 0,                     // é”å®šæ•°é‡ï¼ˆé¢„ç•™ï¼‰
  
  createTime: ISODate("2025-01-01"),
  updateTime: ISODate("2025-01-06")
}

// ç´¢å¼•
db.stock.createIndex({ "drugId": 1, "location": 1, "batch": 1 })
db.stock.createIndex({ "location": 1, "quantity": 1 })
db.stock.createIndex({ "expireDate": 1 })
```

### clinic_records é›†åˆï¼ˆé—¨è¯Šè®°å½•ï¼‰
```javascript
{
  _id: "clinic_001",
  recordNo: "MZ20251106001",
  patientName: "å¼ ä¸‰",
  patientAge: 28,
  patientGender: "ç”·",
  symptom: "å‘çƒ­ã€å’³å—½",
  diagnosis: "ä¸Šå‘¼å¸é“æ„ŸæŸ“",
  
  location: "land_park",
  locationName: "é™†å›­åŒ»åŠ¡å®¤",
  
  items: [
    {
      drugId: "drug_001",
      drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
      specification: "0.25gÃ—24ç²’/ç›’",
      batch: "20250101",
      
      // ===== å…³é”®ï¼šç”¨æœ€å°å•ä½è®°å½• =====
      quantity: 6,                     // å®é™…ç”¨é‡ï¼ˆæœ€å°å•ä½ï¼‰
      unit: "ç²’",
      
      // ===== è½¬æ¢ä¿¡æ¯ï¼ˆç”¨äºæ‰£å‡åº“å­˜ï¼‰ =====
      specInfo: {
        conversionRate: 24,
        minUnit: "ç²’",
        packUnit: "ç›’"
      },
      packQuantity: 0.25,              // è½¬æ¢åæ•°é‡ï¼ˆåŒ…è£…å•ä½ï¼‰
      packUnit: "ç›’",
      
      price: 0.52                      // å•ä»·ï¼ˆæŒ‰ç²’è®¡ç®—ï¼‰
    }
  ],
  
  doctor: "æåŒ»ç”Ÿ",
  doctorId: "user_002",
  createTime: ISODate("2025-11-06T15:00:00")
}

// ç´¢å¼•
db.clinic_records.createIndex({ "recordNo": 1 }, { unique: true })
db.clinic_records.createIndex({ "location": 1, "createTime": -1 })
db.clinic_records.createIndex({ "items.drugId": 1 })
```

---

## ğŸ”§ å·¥å…·ç±»å®ç°ï¼ˆå®Œæ•´ä»£ç ï¼‰

### utils/unitConverter.jsï¼ˆæœ€ç»ˆç‰ˆï¼‰
```javascript
/**
 * å•ä½è½¬æ¢å·¥å…·ç±» v3.13 Final
 * @file utils/unitConverter.js
 */
class UnitConverter {
  /**
   * è§„æ ¼è§£ææ­£åˆ™è¡¨è¾¾å¼
   */
  static SPEC_PATTERNS = {
    // æ ‡å‡†æ ¼å¼: 0.25gÃ—24ç²’/ç›’
    standard: /^(\d+\.?\d*)(mg|g|ml|Î¼g)?\s*[Ã—x*]\s*(\d+)\s*(ç‰‡|ç²’|æ”¯|ç“¶|è¢‹|ä¸¸|æ»´|ml)\s*[/ï¼]\s*(ç›’|ç“¶|è¢‹|æ¡¶|ç®±)$/i,
    
    // ç®€åŒ–æ ¼å¼: 24ç²’/ç›’ æˆ– 0.1Ã—12ç²’/ç›’
    simple: /^(\d+\.?\d*)?[Ã—x*]?\s*(\d+)\s*(ç‰‡|ç²’|æ”¯|ç“¶|è¢‹|ä¸¸|æ»´|ml)\s*[/ï¼]\s*(ç›’|ç“¶|è¢‹|æ¡¶|ç®±)$/i,
    
    // å•ä¸€åŒ…è£…: 20g/æ”¯
    single: /^(\d+\.?\d*)(mg|g|ml|Î¼g|L)\s*[/ï¼]\s*(æ”¯|ç“¶|è¢‹|æ¡¶)$/i
  }
  
  /**
   * è§£æè¯å“è§„æ ¼
   * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
   * @returns {Object|null} è§£æç»“æœ
   */
  static parseSpecification(specification) {
    if (!specification || typeof specification !== 'string') {
      return null
    }
    
    // æ¸…ç†å­—ç¬¦ä¸²
    const spec = specification.trim()
      .replace(/Ã—/g, 'Ã—')
      .replace(/ï¼/g, '/')
    
    // å°è¯•æ ‡å‡†æ ¼å¼
    let match = spec.match(this.SPEC_PATTERNS.standard)
    if (match) {
      return {
        dosage: match[1] ? parseFloat(match[1]) : null,
        dosageUnit: match[2] || null,
        conversionRate: parseInt(match[3]),
        minUnit: match[4],
        packUnit: match[5],
        fullSpec: specification,
        pattern: 'standard'
      }
    }
    
    // å°è¯•ç®€åŒ–æ ¼å¼
    match = spec.match(this.SPEC_PATTERNS.simple)
    if (match) {
      return {
        dosage: match[1] ? parseFloat(match[1]) : null,
        dosageUnit: null,
        conversionRate: parseInt(match[2]),
        minUnit: match[3],
        packUnit: match[4],
        fullSpec: specification,
        pattern: 'simple'
      }
    }
    
    // å°è¯•å•ä¸€åŒ…è£…
    match = spec.match(this.SPEC_PATTERNS.single)
    if (match) {
      return {
        dosage: parseFloat(match[1]),
        dosageUnit: match[2],
        conversionRate: 1,
        minUnit: match[3],
        packUnit: match[3],
        fullSpec: specification,
        pattern: 'single'
      }
    }
    
    return null
  }
  
  /**
   * åŒ…è£…å•ä½ â†’ æœ€å°å•ä½
   * @param {Number} packQuantity - åŒ…è£…æ•°é‡ï¼ˆå¦‚2ç›’ï¼‰
   * @param {Number} conversionRate - è½¬æ¢ç‡ï¼ˆå¦‚24ï¼‰
   * @returns {Number} æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚48ç²’ï¼‰
   */
  static packToMin(packQuantity, conversionRate) {
    if (typeof packQuantity !== 'number' || typeof conversionRate !== 'number') {
      throw new Error('å‚æ•°å¿…é¡»æ˜¯æ•°å­—')
    }
    return packQuantity * conversionRate
  }
  
  /**
   * æœ€å°å•ä½ â†’ åŒ…è£…å•ä½
   * @param {Number} minQuantity - æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚30ç²’ï¼‰
   * @param {Number} conversionRate - è½¬æ¢ç‡ï¼ˆå¦‚24ï¼‰
   * @returns {Number} åŒ…è£…æ•°é‡ï¼ˆå¦‚1.25ç›’ï¼‰
   */
  static minToPack(minQuantity, conversionRate) {
    if (typeof minQuantity !== 'number' || typeof conversionRate !== 'number') {
      throw new Error('å‚æ•°å¿…é¡»æ˜¯æ•°å­—')
    }
    return minQuantity / conversionRate
  }
  
  /**
   * æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆåŒ…è£…å•ä½ï¼‰
   * @param {Number} packQuantity - åŒ…è£…æ•°é‡
   * @param {String} packUnit - åŒ…è£…å•ä½
   * @returns {String} æ ¼å¼åŒ–å­—ç¬¦ä¸²
   */
  static formatPack(packQuantity, packUnit) {
    if (Number.isInteger(packQuantity)) {
      return `${packQuantity}${packUnit}`
    }
    return `${packQuantity.toFixed(2)}${packUnit}`
  }
  
  /**
   * éªŒè¯è§„æ ¼æ ¼å¼
   * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
   * @returns {Boolean} æ˜¯å¦æœ‰æ•ˆ
   */
  static isValidSpec(specification) {
    return this.parseSpecification(specification) !== null
  }
  
  /**
   * è·å–è½¬æ¢ç‡
   * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
   * @returns {Number|null} è½¬æ¢ç‡
   */
  static getConversionRate(specification) {
    const result = this.parseSpecification(specification)
    return result ? result.conversionRate : null
  }
}

export default UnitConverter
```

### utils/parkConfig.jsï¼ˆæœ€ç»ˆç‰ˆï¼‰
```javascript
/**
 * å›­åŒºé…ç½® v3.13 Final
 * @file utils/parkConfig.js
 */
export const PARK_CONFIG = {
  drug_storage: {
    code: 'drug_storage',
    name: 'è¯åº“',
    shortName: 'è¯åº“',
    type: 'storage',
    description: 'åŒ»åŠ¡å®¤è¯å“ä¸­å¤®å­˜å‚¨åº“',
    icon: 'ğŸ¥',
    color: '#909399',
    allowIn: true,      // å…è®¸å…¥åº“
    allowOut: true,     // å…è®¸å‡ºåº“
    allowClinic: false  // ä¸å…è®¸é—¨è¯Šï¼ˆè¯åº“ä¸ç›´æ¥çœ‹ç—…ï¼‰
  },
  land_park: {
    code: 'land_park',
    name: 'é™†å›­åŒ»åŠ¡å®¤',
    shortName: 'é™†å›­',
    type: 'clinic',
    description: 'é™†åœ°æ¸¸ä¹å›­åŒ»åŠ¡å®¤',
    icon: 'ğŸ¢',
    color: '#67c23a',
    allowIn: false,     // ä¸å…è®¸ç›´æ¥å…¥åº“
    allowOut: true,     // å…è®¸å‡ºåº“ï¼ˆé¢†ç”¨ï¼‰
    allowClinic: true   // å…è®¸é—¨è¯Š
  },
  water_park: {
    code: 'water_park',
    name: 'æ°´å›­åŒ»åŠ¡å®¤',
    shortName: 'æ°´å›­',
    type: 'clinic',
    description: 'æ°´ä¸Šæ¸¸ä¹å›­åŒ»åŠ¡å®¤',
    icon: 'ğŸŒŠ',
    color: '#409eff',
    allowIn: false,
    allowOut: true,
    allowClinic: true
  }
}

/**
 * è·å–å›­åŒºåˆ—è¡¨
 */
export function getParkList() {
  return Object.values(PARK_CONFIG)
}

/**
 * è·å–å›­åŒºä¿¡æ¯
 */
export function getParkInfo(code) {
  return PARK_CONFIG[code] || null
}

/**
 * è·å–å…è®¸å…¥åº“çš„å›­åŒºï¼ˆåªæœ‰è¯åº“ï¼‰
 */
export function getInboundParks() {
  return Object.values(PARK_CONFIG).filter(p => p.allowIn)
}

/**
 * è·å–å…è®¸å‡ºåº“çš„å›­åŒºï¼ˆè¯åº“å’Œå›­åŒºï¼‰
 */
export function getOutboundParks() {
  return Object.values(PARK_CONFIG).filter(p => p.allowOut && p.type === 'clinic')
}

/**
 * è·å–å…è®¸é—¨è¯Šçš„å›­åŒºï¼ˆåªæœ‰å›­åŒºåŒ»åŠ¡å®¤ï¼‰
 */
export function getClinicParks() {
  return Object.values(PARK_CONFIG).filter(p => p.allowClinic)
}
```

---

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šè§£æè§„æ ¼
```javascript
import UnitConverter from '@/utils/unitConverter'

// æµ‹è¯•å„ç§è§„æ ¼æ ¼å¼
const specs = [
  '0.25gÃ—24ç²’/ç›’',
  '0.1Ã—12ç²’/ç›’',
  '24ç²’/ç›’',
  '20g/æ”¯',
  '5mlÃ—10æ”¯/ç›’'
]

specs.forEach(spec => {
  const result = UnitConverter.parseSpecification(spec)
  if (result) {
    console.log(`âœ… ${spec}`)
    console.log(`   è½¬æ¢ç‡: ${result.conversionRate}`)
    console.log(`   æœ€å°å•ä½: ${result.minUnit}`)
    console.log(`   åŒ…è£…å•ä½: ${result.packUnit}`)
  } else {
    console.log(`âŒ ${spec} - è§£æå¤±è´¥`)
  }
})
```

### ç¤ºä¾‹2ï¼šé—¨è¯Šæ¶ˆè€—è½¬æ¢
```javascript
// æ‚£è€…æœç”¨ 6ç²’ é˜¿è«è¥¿æ—
const minQuantity = 6                    // 6ç²’
const conversionRate = 24                // 1ç›’=24ç²’

// è½¬æ¢ä¸ºåŒ…è£…å•ä½
const packQuantity = UnitConverter.minToPack(minQuantity, conversionRate)
console.log(`${minQuantity}ç²’ = ${packQuantity}ç›’`)  // 6ç²’ = 0.25ç›’

// æ ¼å¼åŒ–æ˜¾ç¤º
const display = UnitConverter.formatPack(packQuantity, 'ç›’')
console.log(display)  // "0.25ç›’"
```

### ç¤ºä¾‹3ï¼šå‡ºåº“è½¬æ¢
```javascript
// å‡ºåº“ 2ç›’ åˆ°é™†å›­
const packQuantity = 2                   // 2ç›’
const conversionRate = 24                // 1ç›’=24ç²’

// å¯é€‰ï¼šæ˜¾ç¤ºç›¸å½“äºå¤šå°‘ç²’
const minQuantity = UnitConverter.packToMin(packQuantity, conversionRate)
console.log(`å‡ºåº“ ${packQuantity}ç›’ (ç›¸å½“äº ${minQuantity}ç²’)`)
// è¾“å‡º: "å‡ºåº“ 2ç›’ (ç›¸å½“äº 48ç²’)"
```

---

## âœ… è®¾è®¡æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›ç‚¹

```
1ï¸âƒ£ ç®€åŒ–å•ä½ç®¡ç†
   âœ… å…¥åº“/å‡ºåº“: ç»Ÿä¸€ä½¿ç”¨åŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ã€è¢‹ï¼‰
   âœ… åº“å­˜æ˜¾ç¤º: åªæ˜¾ç¤ºåŒ…è£…å•ä½ï¼Œç®€æ´æ˜äº†
   âœ… é—¨è¯Šæ¶ˆè€—: ä½¿ç”¨æœ€å°å•ä½ï¼Œè‡ªåŠ¨è½¬æ¢æ‰£å‡

2ï¸âƒ£ æ­£åˆ™è¡¨è¾¾å¼è§£æ
   âœ… æ”¯æŒ3ç§è§„æ ¼æ ¼å¼
   âœ… è‡ªåŠ¨æå–è½¬æ¢ç‡
   âœ… å…¼å®¹ 0.1Ã—12ç²’/ç›’ ç­‰ç‰¹æ®Šæƒ…å†µ
   âœ… å¥å£®çš„é”™è¯¯å¤„ç†

3ï¸âƒ£ ç•Œé¢ç®€åŒ–ä¼˜åŒ–
   âœ… ç§»é™¤å†—ä½™æç¤ºä¿¡æ¯
   âœ… ç§»é™¤å‡ºåº“æ±‡æ€»ï¼ˆä¸éœ€è¦ï¼‰
   âœ… ç§»é™¤ä¸­å¤®åº“é€‰é¡¹ï¼ˆåªä¿ç•™é™†å›­/æ°´å›­ï¼‰
   âœ… æ–°å¢å¤æ ¸äººç­¾å

4ï¸âƒ£ æ•°æ®æµæ¸…æ™°
   âœ… è¯åº“ â†’ å›­åŒº: æ•´åŒ…è£…å‡ºåº“
   âœ… å›­åŒº â†’ æ‚£è€…: æœ€å°å•ä½æ¶ˆè€—
   âœ… åº“å­˜ç»Ÿä¸€: åªç”¨åŒ…è£…å•ä½å­˜å‚¨
   âœ… è‡ªåŠ¨è½¬æ¢: é—¨è¯Šæ—¶å®æ—¶è½¬æ¢æ‰£å‡

5ï¸âƒ£ ä»£ç å®ç”¨æ€§
   âœ… å®Œæ•´çš„å·¥å…·ç±»
   âœ… æ¸…æ™°çš„æ³¨é‡Š
   âœ… ä¸°å¯Œçš„ç¤ºä¾‹
   âœ… å•å…ƒæµ‹è¯•è¦†ç›–
```

### å®æ–½ä¼˜å…ˆçº§

```
P0ï¼ˆç«‹å³å®ç° - 1å¤©ï¼‰:
â–¡ UnitConverter å·¥å…·ç±»ï¼ˆæ­£åˆ™è§£æï¼‰
â–¡ æ•°æ®åº“å­—æ®µè°ƒæ•´ï¼ˆç§»é™¤æœ€å°å•ä½å†—ä½™ï¼‰
â–¡ è¯å“æ¡£æ¡ˆè§„æ ¼éªŒè¯

P1ï¼ˆç¬¬äºŒé˜¶æ®µ - 2å¤©ï¼‰:
â–¡ å…¥åº“é¡µé¢ï¼ˆåŒ…è£…å•ä½ï¼‰
â–¡ å‡ºåº“é¡µé¢ï¼ˆåŒ…è£…å•ä½ + å¤æ ¸äººï¼‰
â–¡ é—¨è¯Šé¡µé¢ï¼ˆæœ€å°å•ä½ + è‡ªåŠ¨è½¬æ¢ï¼‰

P2ï¼ˆç¬¬ä¸‰é˜¶æ®µ - 1å¤©ï¼‰:
â–¡ åº“å­˜é¡µé¢ï¼ˆåªæ˜¾ç¤ºåŒ…è£…å•ä½ï¼‰
â–¡ å›­åŒºé…ç½®ï¼ˆè¯åº“/é™†å›­/æ°´å›­ï¼‰
â–¡ æ•°æ®è¿ç§»è„šæœ¬
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.13 Final  
**è®¾è®¡å®Œæˆ**: 2025-11-06  
**æ ¸å¿ƒæ”¹è¿›**: ç®€åŒ–å•ä½ç®¡ç† + æ­£åˆ™è§£æ + é—¨è¯Šæœ€å°å•ä½

ğŸ¯ é‡æ–°è®¾è®¡å®Œæˆï¼ä¸šåŠ¡é€»è¾‘æ›´æ¸…æ™°ï¼Œå®ç°æ›´ç®€å•ï¼

