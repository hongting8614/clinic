# ğŸ“ åˆ†å›­åŒºå•ä½è½¬æ¢ç•Œé¢è®¾è®¡ v3.14 ç»ˆæç‰ˆ

**è®¾è®¡æ—¶é—´**: 2025-11-06  
**ç‰ˆæœ¬**: v3.14 Ultimate  
**åŸºäº**: ç”¨æˆ·æ ¸å¿ƒéœ€æ±‚é‡æ–°åˆ†æ  
**å…³é”®å˜æ›´**: è¯åº“ç”¨åŒ…è£…å•ä½ + å›­åŒºç”¨æœ€å°å•ä½ + åŒè½¨åˆ¶ç®¡ç†

---

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚é‡æ–°åˆ†æ

### ä¸šåŠ¡é€»è¾‘é‡æ–°æ¢³ç†

```
å…³é”®ç†è§£:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¥ è¯åº“ï¼ˆdrug_storageï¼‰
   - è§’è‰²å®šä½ï¼šä¸­å¤®ä»“åº“ï¼Œå¤§å®—è¿›å‡º
   - å­˜å‚¨å•ä½ï¼šåŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ã€è¢‹ï¼‰
   - ä¸šåŠ¡åœºæ™¯ï¼šé‡‡è´­å…¥åº“ã€æ‰¹é‡å‡ºåº“åˆ°å›­åŒº
   - ä¸¾ä¾‹ï¼šå…¥åº“100ç›’ï¼Œå‡ºåº“20ç›’åˆ°é™†å›­

ğŸ¢ å›­åŒºï¼ˆland_park/water_parkï¼‰
   - è§’è‰²å®šä½ï¼šä¸€çº¿è¯Šç–—ç‚¹ï¼Œé¢‘ç¹æ¶ˆè€—
   - å­˜å‚¨å•ä½ï¼šæœ€å°å•ä½ï¼ˆç²’ã€ç‰‡ã€mlï¼‰â­ å…³é”®ï¼
   - ä¸šåŠ¡åœºæ™¯ï¼šæ¥æ”¶è¯åº“å‡ºåº“ã€é—¨è¯Šæ¶ˆè€—æ‰£å‡
   - ä¸¾ä¾‹ï¼šåº“å­˜480ç²’ï¼Œé—¨è¯Šç”¨6ç²’ï¼Œå‰©474ç²’

æ ¸å¿ƒé€»è¾‘:
âœ… è¯åº“å…¥åº“ï¼šç”¨åŒ…è£…å•ä½ï¼ˆ10ç›’ï¼‰
âœ… è¯åº“å‡ºåº“ï¼šç”¨åŒ…è£…å•ä½ï¼ˆ2ç›’ï¼‰â†’ è‡ªåŠ¨è½¬æ¢ä¸ºæœ€å°å•ä½ï¼ˆ48ç²’ï¼‰å…¥å›­åŒº
âœ… å›­åŒºåº“å­˜ï¼šç»Ÿä¸€ç”¨æœ€å°å•ä½å­˜å‚¨ï¼ˆ480ç²’ï¼‰
âœ… é—¨è¯Šæ¶ˆè€—ï¼šç›´æ¥æ‰£å‡æœ€å°å•ä½ï¼ˆ480-6=474ç²’ï¼‰
âœ… åº“å­˜æ˜¾ç¤ºï¼šè¯åº“æ˜¾ç¤ºåŒ…è£…å•ä½ï¼Œå›­åŒºæ˜¾ç¤ºæœ€å°å•ä½+æ¢ç®—
```

### æ•°æ®æµå®Œæ•´å›¾è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´ä¸šåŠ¡æ•°æ®æµ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬1æ­¥: é‡‡è´­å…¥åº“åˆ°è¯åº“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: å…¥åº“ 10ç›’ é˜¿è«è¥¿æ—ï¼ˆ0.25gÃ—24ç²’/ç›’ï¼‰
å­˜å‚¨: 
  location: drug_storage
  quantity: 10
  unit: ç›’
  
ç»“æœ: è¯åº“ = 10ç›’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯åº“                                     â”‚
â”‚ é˜¿è«è¥¿æ—: 10ç›’                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ç¬¬2æ­¥: å‡ºåº“åˆ°é™†å›­ï¼ˆå…³é”®è½¬æ¢ç‚¹ï¼‰â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: å‡ºåº“ 2ç›’ åˆ°é™†å›­
ç•Œé¢è¾“å…¥: 2ç›’ï¼ˆç”¨æˆ·ä¹ æƒ¯ï¼‰
ç³»ç»Ÿå¤„ç†:
  1. è§£æè§„æ ¼: 0.25gÃ—24ç²’/ç›’
  2. æå–è½¬æ¢ç‡: 24
  3. è½¬æ¢è®¡ç®—: 2ç›’ Ã— 24 = 48ç²’
  4. è¯åº“æ‰£å‡: 10ç›’ - 2ç›’ = 8ç›’
  5. å›­åŒºå¢åŠ : 0ç²’ + 48ç²’ = 48ç²’ â­

å­˜å‚¨:
  è¯åº“: quantity: 8ç›’, unit: ç›’
  é™†å›­: quantity: 48ç²’, unit: ç²’ â­ å…³é”®ï¼

ç»“æœ: è¯åº“ = 8ç›’, é™†å›­ = 48ç²’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯åº“             â”‚    â”‚ é™†å›­             â”‚
â”‚ é˜¿è«è¥¿æ—: 8ç›’    â”‚    â”‚ é˜¿è«è¥¿æ—: 48ç²’   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ç¬¬3æ­¥: é—¨è¯Šæ¶ˆè€—ï¼ˆç›´æ¥æ‰£å‡ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: æ‚£è€…æœç”¨ 6ç²’
ç•Œé¢è¾“å…¥: 6ç²’ï¼ˆå®é™…ç”¨é‡ï¼‰
ç³»ç»Ÿå¤„ç†:
  1. ç›´æ¥æ‰£å‡: 48ç²’ - 6ç²’ = 42ç²’
  2. ä¸éœ€è¦è½¬æ¢ï¼â­

å­˜å‚¨:
  é™†å›­: quantity: 42ç²’, unit: ç²’

ç»“æœ: è¯åº“ = 8ç›’, é™†å›­ = 42ç²’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯åº“             â”‚    â”‚ é™†å›­             â”‚
â”‚ é˜¿è«è¥¿æ—: 8ç›’    â”‚    â”‚ é˜¿è«è¥¿æ—: 42ç²’   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ç¬¬4æ­¥: å†æ¬¡é—¨è¯Šæ¶ˆè€—
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: æ‚£è€…æœç”¨ 12ç²’
ç³»ç»Ÿå¤„ç†:
  1. ç›´æ¥æ‰£å‡: 42ç²’ - 12ç²’ = 30ç²’

ç»“æœ: è¯åº“ = 8ç›’, é™†å›­ = 30ç²’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯åº“             â”‚    â”‚ é™†å›­             â”‚
â”‚ é˜¿è«è¥¿æ—: 8ç›’    â”‚    â”‚ é˜¿è«è¥¿æ—: 30ç²’   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ç¬¬5æ­¥: å†æ¬¡è¡¥è´§åˆ°é™†å›­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: å‡ºåº“ 1ç›’ åˆ°é™†å›­
ç³»ç»Ÿå¤„ç†:
  1. è½¬æ¢è®¡ç®—: 1ç›’ Ã— 24 = 24ç²’
  2. è¯åº“æ‰£å‡: 8ç›’ - 1ç›’ = 7ç›’
  3. å›­åŒºå¢åŠ : 30ç²’ + 24ç²’ = 54ç²’

ç»“æœ: è¯åº“ = 7ç›’, é™†å›­ = 54ç²’

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯åº“             â”‚    â”‚ é™†å›­             â”‚
â”‚ é˜¿è«è¥¿æ—: 7ç›’    â”‚    â”‚ é˜¿è«è¥¿æ—: 54ç²’   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å…³é”®ä¼˜åŠ¿:
âœ… è¯åº“ç”¨åŒ…è£…å•ä½ï¼ˆç¬¦åˆä»“å‚¨ä¹ æƒ¯ï¼‰
âœ… å›­åŒºç”¨æœ€å°å•ä½ï¼ˆç¬¦åˆè¯Šç–—ç²¾åº¦ï¼‰
âœ… é—¨è¯Šæ¶ˆè€—æ— éœ€è½¬æ¢ï¼ˆç›´æ¥æ‰£å‡ï¼Œé€Ÿåº¦å¿«ï¼‰
âœ… æ•°æ®ç²¾ç¡®ï¼ˆé¿å…åå¤è½¬æ¢çš„ç²¾åº¦æŸå¤±ï¼‰
âœ… ç»Ÿè®¡æ–¹ä¾¿ï¼ˆå›­åŒºæ¶ˆè€—ç›´æ¥æ±‡æ€»ï¼‰
```

---

## ğŸ”§ æ­£åˆ™è¡¨è¾¾å¼è§£ææ–¹æ¡ˆï¼ˆå®Œæ•´ç‰ˆï¼‰

### è§„æ ¼è§£ææ ¸å¿ƒä»£ç 

```javascript
/**
 * å•ä½è½¬æ¢å·¥å…·ç±» v3.14 Ultimate
 * @file utils/unitConverter.js
 */
class UnitConverter {
  /**
   * è§„æ ¼è§£ææ­£åˆ™è¡¨è¾¾å¼ï¼ˆ4ç§æ¨¡å¼ï¼‰
   */
  static SPEC_PATTERNS = {
    // æ¨¡å¼1: æ ‡å‡†æ ¼å¼ - å‰‚é‡Ã—æ•°é‡å•ä½/åŒ…è£…å•ä½
    // ç¤ºä¾‹: 0.25gÃ—24ç²’/ç›’, 5mlÃ—10æ”¯/ç›’
    standard: /^(\d+\.?\d*)(mg|g|ml|Î¼g|mcg|ug)?\s*[Ã—xX*]\s*(\d+)\s*(ç‰‡|ç²’|æ”¯|ç“¶|è¢‹|ä¸¸|æ»´|ml|æ¯«å‡|ML)\s*[/ï¼]\s*(ç›’|ç“¶|è¢‹|æ¡¶|ç®±|åŒ…)$/i,
    
    // æ¨¡å¼2: ç®€åŒ–æ ¼å¼ - æ•°é‡å•ä½/åŒ…è£…å•ä½
    // ç¤ºä¾‹: 24ç²’/ç›’, 0.1Ã—12ç²’/ç›’
    simple: /^(\d+\.?\d*)?\s*[Ã—xX*]?\s*(\d+)\s*(ç‰‡|ç²’|æ”¯|ç“¶|è¢‹|ä¸¸|æ»´|ml|æ¯«å‡|ML)\s*[/ï¼]\s*(ç›’|ç“¶|è¢‹|æ¡¶|ç®±|åŒ…)$/i,
    
    // æ¨¡å¼3: å•ä¸€åŒ…è£… - å‰‚é‡/å•ä½
    // ç¤ºä¾‹: 20g/æ”¯, 100ml/ç“¶, 500mg/ç‰‡
    single: /^(\d+\.?\d*)(mg|g|ml|Î¼g|mcg|ug)\s*[/ï¼]\s*(æ”¯|ç“¶|è¢‹|æ¡¶|ç‰‡|ç²’|ä¸¸)$/i,
    
    // æ¨¡å¼4: çº¯æ•°é‡æ ¼å¼
    // ç¤ºä¾‹: 100ç‰‡, 50ç²’ï¼ˆé»˜è®¤1ç‰‡/ç‰‡ï¼Œ1ç²’/ç²’ï¼‰
    pure: /^(\d+)\s*(ç‰‡|ç²’|æ”¯|ç“¶|è¢‹|ä¸¸|æ»´|ml|æ¯«å‡)$/i
  }
  
  /**
   * è§£æè¯å“è§„æ ¼
   * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
   * @returns {Object|null} è§£æç»“æœ
   */
  static parseSpecification(specification) {
    if (!specification || typeof specification !== 'string') {
      return null
    }
    
    // æ¸…ç†å­—ç¬¦ä¸²ï¼ˆç»Ÿä¸€å…¨è§’/åŠè§’å­—ç¬¦ï¼‰
    const spec = specification.trim()
      .replace(/Ã—/g, 'Ã—')      // ç»Ÿä¸€ä¹˜å·
      .replace(/ï¼/g, '/')     // ç»Ÿä¸€æ–œæ 
      .replace(/\s+/g, ' ')    // ç»Ÿä¸€ç©ºæ ¼
    
    // å°è¯•æ¨¡å¼1: æ ‡å‡†æ ¼å¼
    let match = spec.match(this.SPEC_PATTERNS.standard)
    if (match) {
      return {
        dosage: match[1] ? parseFloat(match[1]) : null,           // 0.25
        dosageUnit: match[2] ? match[2].toLowerCase() : null,     // g
        conversionRate: parseInt(match[3]),                       // 24
        minUnit: this.normalizeUnit(match[4]),                    // ç²’
        packUnit: this.normalizeUnit(match[5]),                   // ç›’
        fullSpec: specification,
        pattern: 'standard'
      }
    }
    
    // å°è¯•æ¨¡å¼2: ç®€åŒ–æ ¼å¼
    match = spec.match(this.SPEC_PATTERNS.simple)
    if (match) {
      return {
        dosage: match[1] ? parseFloat(match[1]) : null,           // 0.1 (å¦‚æœæœ‰)
        dosageUnit: null,
        conversionRate: parseInt(match[2]),                       // 12
        minUnit: this.normalizeUnit(match[3]),                    // ç²’
        packUnit: this.normalizeUnit(match[4]),                   // ç›’
        fullSpec: specification,
        pattern: 'simple'
      }
    }
    
    // å°è¯•æ¨¡å¼3: å•ä¸€åŒ…è£…
    match = spec.match(this.SPEC_PATTERNS.single)
    if (match) {
      const unit = this.normalizeUnit(match[3])
      return {
        dosage: parseFloat(match[1]),                             // 20
        dosageUnit: match[2].toLowerCase(),                       // g
        conversionRate: 1,                                        // 1 (å•ä¸€åŒ…è£…)
        minUnit: unit,                                            // æ”¯
        packUnit: unit,                                           // æ”¯
        fullSpec: specification,
        pattern: 'single'
      }
    }
    
    // å°è¯•æ¨¡å¼4: çº¯æ•°é‡æ ¼å¼
    match = spec.match(this.SPEC_PATTERNS.pure)
    if (match) {
      const unit = this.normalizeUnit(match[2])
      return {
        dosage: null,
        dosageUnit: null,
        conversionRate: parseInt(match[1]),                       // 100
        minUnit: unit,                                            // ç‰‡
        packUnit: 'ç›’',                                           // é»˜è®¤ç›’
        fullSpec: specification,
        pattern: 'pure'
      }
    }
    
    // æ— æ³•è§£æ
    console.warn(`âš ï¸ æ— æ³•è§£æè§„æ ¼: ${specification}`)
    return null
  }
  
  /**
   * ç»Ÿä¸€å•ä½åç§°ï¼ˆå¤„ç†åŒä¹‰è¯ï¼‰
   * @param {String} unit - åŸå§‹å•ä½
   * @returns {String} æ ‡å‡†åŒ–å•ä½
   */
  static normalizeUnit(unit) {
    const unitMap = {
      'ML': 'ml',
      'æ¯«å‡': 'ml',
      'åŒ…': 'ç›’'
    }
    return unitMap[unit] || unit
  }
  
  /**
   * åŒ…è£…å•ä½ â†’ æœ€å°å•ä½
   * @param {Number} packQuantity - åŒ…è£…æ•°é‡ï¼ˆå¦‚2ç›’ï¼‰
   * @param {Number} conversionRate - è½¬æ¢ç‡ï¼ˆå¦‚24ï¼‰
   * @returns {Number} æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚48ç²’ï¼‰
   */
  static packToMin(packQuantity, conversionRate) {
    if (typeof packQuantity !== 'number' || typeof conversionRate !== 'number') {
      throw new Error('å‚æ•°å¿…é¡»æ˜¯æ•°å­—')
    }
    if (conversionRate <= 0) {
      throw new Error('è½¬æ¢ç‡å¿…é¡»å¤§äº0')
    }
    return packQuantity * conversionRate
  }
  
  /**
   * æœ€å°å•ä½ â†’ åŒ…è£…å•ä½
   * @param {Number} minQuantity - æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚48ç²’ï¼‰
   * @param {Number} conversionRate - è½¬æ¢ç‡ï¼ˆå¦‚24ï¼‰
   * @returns {Number} åŒ…è£…æ•°é‡ï¼ˆå¦‚2ç›’ï¼‰
   */
  static minToPack(minQuantity, conversionRate) {
    if (typeof minQuantity !== 'number' || typeof conversionRate !== 'number') {
      throw new Error('å‚æ•°å¿…é¡»æ˜¯æ•°å­—')
    }
    if (conversionRate <= 0) {
      throw new Error('è½¬æ¢ç‡å¿…é¡»å¤§äº0')
    }
    return minQuantity / conversionRate
  }
  
  /**
   * æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆæ™ºèƒ½åˆ¤æ–­ï¼‰
   * @param {Number} quantity - æ•°é‡
   * @param {String} unit - å•ä½
   * @param {Number} precision - å°æ•°ç²¾åº¦ï¼ˆé»˜è®¤2ä½ï¼‰
   * @returns {String} æ ¼å¼åŒ–å­—ç¬¦ä¸²
   */
  static formatQuantity(quantity, unit, precision = 2) {
    if (typeof quantity !== 'number') {
      return `0${unit}`
    }
    
    // æ•´æ•°æ˜¾ç¤º
    if (Number.isInteger(quantity)) {
      return `${quantity}${unit}`
    }
    
    // å°æ•°æ˜¾ç¤º
    return `${quantity.toFixed(precision)}${unit}`
  }
  
  /**
   * æ ¼å¼åŒ–åº“å­˜æ˜¾ç¤ºï¼ˆå¸¦æ¢ç®—ï¼‰
   * @param {Number} minQuantity - æœ€å°å•ä½æ•°é‡ï¼ˆå¦‚54ç²’ï¼‰
   * @param {Object} specInfo - è§„æ ¼ä¿¡æ¯
   * @returns {String} æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆå¦‚ "54ç²’ (2.25ç›’)"ï¼‰
   */
  static formatStockWithConversion(minQuantity, specInfo) {
    const { minUnit, packUnit, conversionRate } = specInfo
    
    // ä¸»æ˜¾ç¤ºï¼šæœ€å°å•ä½
    const mainDisplay = this.formatQuantity(minQuantity, minUnit)
    
    // å‰¯æ˜¾ç¤ºï¼šæ¢ç®—ä¸ºåŒ…è£…å•ä½
    const packQuantity = this.minToPack(minQuantity, conversionRate)
    
    // æ™ºèƒ½æ˜¾ç¤ºï¼šæ•´ç›’æ˜¾ç¤ºä¸ºæ•´æ•°ï¼Œé›¶æ•£æ˜¾ç¤ºä¸ºå°æ•°
    if (Number.isInteger(packQuantity)) {
      return `${mainDisplay} (${packQuantity}${packUnit})`
    } else {
      // æ··åˆæ˜¾ç¤ºï¼š8ç›’é›¶6ç²’
      const fullPacks = Math.floor(packQuantity)
      const remainMin = minQuantity % conversionRate
      
      if (fullPacks === 0) {
        // ä¸è¶³1ç›’
        return `${mainDisplay} (${packQuantity.toFixed(2)}${packUnit})`
      } else {
        // æ··åˆ
        return `${mainDisplay} (${fullPacks}${packUnit}é›¶${remainMin}${minUnit})`
      }
    }
  }
  
  /**
   * éªŒè¯è§„æ ¼æ ¼å¼
   * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
   * @returns {Boolean} æ˜¯å¦æœ‰æ•ˆ
   */
  static isValidSpec(specification) {
    return this.parseSpecification(specification) !== null
  }
  
  /**
   * è·å–è½¬æ¢ç‡
   * @param {String} specification - è§„æ ¼å­—ç¬¦ä¸²
   * @returns {Number|null} è½¬æ¢ç‡
   */
  static getConversionRate(specification) {
    const result = this.parseSpecification(specification)
    return result ? result.conversionRate : null
  }
  
  /**
   * æ‰¹é‡è§£æè§„æ ¼ï¼ˆç”¨äºæ•°æ®è¿ç§»ï¼‰
   * @param {Array} specifications - è§„æ ¼æ•°ç»„
   * @returns {Object} è§£æç»“æœç»Ÿè®¡
   */
  static batchParse(specifications) {
    const results = {
      success: [],
      failed: [],
      stats: {
        total: specifications.length,
        successCount: 0,
        failedCount: 0
      }
    }
    
    specifications.forEach(spec => {
      const parsed = this.parseSpecification(spec)
      if (parsed) {
        results.success.push({ spec, parsed })
        results.stats.successCount++
      } else {
        results.failed.push(spec)
        results.stats.failedCount++
      }
    })
    
    return results
  }
}

export default UnitConverter
```

### æµ‹è¯•ç”¨ä¾‹ï¼ˆå®Œæ•´ç‰ˆï¼‰

```javascript
/**
 * è§„æ ¼è§£ææµ‹è¯•å¥—ä»¶
 */
function runTests() {
  const testCases = [
    // æ ‡å‡†æ ¼å¼
    { spec: '0.25gÃ—24ç²’/ç›’', expected: { rate: 24, minUnit: 'ç²’', packUnit: 'ç›’', pattern: 'standard' } },
    { spec: '0.2gÃ—20ç‰‡/ç›’', expected: { rate: 20, minUnit: 'ç‰‡', packUnit: 'ç›’', pattern: 'standard' } },
    { spec: '5mlÃ—10æ”¯/ç›’', expected: { rate: 10, minUnit: 'æ”¯', packUnit: 'ç›’', pattern: 'standard' } },
    { spec: '10mlÃ—6ç“¶/ç›’', expected: { rate: 6, minUnit: 'ç“¶', packUnit: 'ç›’', pattern: 'standard' } },
    
    // ç®€åŒ–æ ¼å¼ï¼ˆå…³é”®æµ‹è¯•ï¼‰
    { spec: '0.1Ã—12ç²’/ç›’', expected: { rate: 12, minUnit: 'ç²’', packUnit: 'ç›’', pattern: 'simple' } },
    { spec: '24ç²’/ç›’', expected: { rate: 24, minUnit: 'ç²’', packUnit: 'ç›’', pattern: 'simple' } },
    { spec: '100ç‰‡/ç“¶', expected: { rate: 100, minUnit: 'ç‰‡', packUnit: 'ç“¶', pattern: 'simple' } },
    
    // å•ä¸€åŒ…è£…
    { spec: '20g/æ”¯', expected: { rate: 1, minUnit: 'æ”¯', packUnit: 'æ”¯', pattern: 'single' } },
    { spec: '100ml/ç“¶', expected: { rate: 1, minUnit: 'ç“¶', packUnit: 'ç“¶', pattern: 'single' } },
    { spec: '500mg/ç‰‡', expected: { rate: 1, minUnit: 'ç‰‡', packUnit: 'ç‰‡', pattern: 'single' } },
    
    // çº¯æ•°é‡æ ¼å¼
    { spec: '100ç‰‡', expected: { rate: 100, minUnit: 'ç‰‡', packUnit: 'ç›’', pattern: 'pure' } },
    { spec: '50ç²’', expected: { rate: 50, minUnit: 'ç²’', packUnit: 'ç›’', pattern: 'pure' } }
  ]
  
  console.log('â”'.repeat(80))
  console.log('ğŸ“‹ è§„æ ¼è§£ææµ‹è¯•å¼€å§‹')
  console.log('â”'.repeat(80))
  
  let passCount = 0
  let failCount = 0
  
  testCases.forEach((test, index) => {
    const result = UnitConverter.parseSpecification(test.spec)
    
    if (result) {
      const pass = 
        result.conversionRate === test.expected.rate &&
        result.minUnit === test.expected.minUnit &&
        result.packUnit === test.expected.packUnit &&
        result.pattern === test.expected.pattern
      
      if (pass) {
        console.log(`âœ… æµ‹è¯• ${index + 1}: ${test.spec}`)
        console.log(`   è½¬æ¢ç‡: ${result.conversionRate} (1${result.packUnit} = ${result.conversionRate}${result.minUnit})`)
        console.log(`   å‰‚é‡: ${result.dosage || 'æ— '}${result.dosageUnit || ''}`)
        console.log(`   æ¨¡å¼: ${result.pattern}`)
        passCount++
      } else {
        console.log(`âŒ æµ‹è¯• ${index + 1}: ${test.spec} - è§£æç»“æœä¸ç¬¦åˆé¢„æœŸ`)
        console.log(`   é¢„æœŸ: ${JSON.stringify(test.expected)}`)
        console.log(`   å®é™…: rate=${result.conversionRate}, minUnit=${result.minUnit}, packUnit=${result.packUnit}`)
        failCount++
      }
    } else {
      console.log(`âŒ æµ‹è¯• ${index + 1}: ${test.spec} - è§£æå¤±è´¥`)
      failCount++
    }
    console.log('â”€'.repeat(80))
  })
  
  console.log('â”'.repeat(80))
  console.log(`ğŸ“Š æµ‹è¯•ç»“æœ: é€šè¿‡ ${passCount}/${testCases.length}, å¤±è´¥ ${failCount}/${testCases.length}`)
  console.log('â”'.repeat(80))
  
  return { passCount, failCount, total: testCases.length }
}

// æ‰§è¡Œæµ‹è¯•
// runTests()
```

---

## ğŸ¨ ç•Œé¢è®¾è®¡ï¼ˆé‡æ–°è®¾è®¡ï¼‰

## è®¾è®¡1ï¼šå…¥åº“å•ç•Œé¢ï¼ˆåŒ…è£…å•ä½å…¥åº“ - ä¸å˜ï¼‰

### ç•Œé¢å¸ƒå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æ–°å»ºå…¥åº“å•                          [ä¿å­˜]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ“¦ å…¥åº“ä¿¡æ¯                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å…¥åº“å•å·  RK20251106001                 â”‚â”‚
â”‚ â”‚ å…¥åº“æ—¥æœŸ  2025-11-06 10:30              â”‚â”‚
â”‚ â”‚ æ“ä½œå‘˜    å¼ ä¸‰                          â”‚â”‚
â”‚ â”‚ ä¾›åº”å•†    [å›½è¯æ§è‚¡_______________] â–¼  â”‚â”‚  è¯´å‡ºä¾›åº”å•†çš„é€‰æ‹©æ–¹å¼  åœ¨ä¾›åº”å•†è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶  ä¸‹æ–¹æ˜¾ç¤ºä¾›åº”å•†å
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š è¯å“æ˜ç»† (3ç§)            [ğŸ“‹é€‰æ‹©][âœï¸æ–°å»º]â”‚  æ‹¼éŸ³ç®€ç   ç³»ç»Ÿ è¯å“è¦æœ‰IDå· å”¯ä¸€ç 
â”‚                                             â”‚
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚ â•‘ # â”‚ è¯å“åç§° â”‚ è§„æ ¼ â”‚ æ‰¹å· â”‚ ç”Ÿäº§ â”‚ æœ‰æ•ˆ â”‚ æ•°é‡ â”‚ å•ä½ â”‚ å•ä»· â”‚ é‡‘é¢ â”‚ ğŸ—‘ â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 1 â”‚ é˜¿è«è¥¿æ— â”‚ 0.25gâ”‚20250â”‚2025-â”‚2027-â”‚ 10  â”‚ ç›’  â”‚12.5 â”‚125  â”‚ ğŸ—‘ â•‘
â”‚ â•‘   â”‚ èƒ¶å›Š     â”‚Ã—24ç²’ â”‚101  â”‚01-01â”‚01-01â”‚     â”‚     â”‚     â”‚     â”‚    â•‘
â”‚ â•‘   â”‚          â”‚/ç›’   â”‚     â”‚730å¤©â”‚     â”‚     â”‚     â”‚     â”‚     â”‚    â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚ â•‘ 2 â”‚ å¸ƒæ´›èŠ¬ç‰‡ â”‚ 0.2g â”‚20250â”‚2025-â”‚2027-â”‚ 15  â”‚ ç›’  â”‚18.0 â”‚270  â”‚ ğŸ—‘ â•‘
â”‚ â•‘   â”‚          â”‚Ã—20ç‰‡ â”‚102  â”‚01-02â”‚01-02â”‚     â”‚     â”‚     â”‚     â”‚    â•‘
â”‚ â•‘   â”‚          â”‚/ç›’   â”‚     â”‚731å¤©â”‚     â”‚     â”‚     â”‚     â”‚     â”‚    â•‘
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                             â”‚
â”‚ ğŸ“Š æ±‡æ€»: 2ç§ | 25ç›’ | Â¥395.00              â”‚
â”‚                                             â”‚
â”‚ âœï¸ æ“ä½œå‘˜ç­¾å * [ç‚¹å‡»ç­¾å] æœªç­¾å          â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ’¾ ä¿å­˜è‰ç¨¿]              [âœ“ æäº¤å¤æ ¸]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®ç»“æ„
```javascript
// å…¥åº“è®°å½•
{
  recordNo: "RK20251106001",
  location: "drug_storage",
  items: [{
    drugId: "drug_001",
    quantity: 10,          // åŒ…è£…å•ä½
    unit: "ç›’"
  }]
}

// è¯åº“åº“å­˜
stock (location: drug_storage):
{
  drugId: "drug_001",
  quantity: 10,            // åŒ…è£…å•ä½
  unit: "ç›’"
}
```

---

## è®¾è®¡2ï¼šå‡ºåº“å•ç•Œé¢ï¼ˆå…³é”®è½¬æ¢ç‚¹ï¼‰â­

### ç•Œé¢å¸ƒå±€ï¼ˆæ™ºèƒ½è½¬æ¢ç‰ˆï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æ–°å»ºå‡ºåº“å•                          [ä¿å­˜]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ¯ å‡ºåº“ä¿¡æ¯                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å‡ºåº“å•å·  CK20251106001                 â”‚â”‚
â”‚ â”‚ å‡ºåº“æ—¥æœŸ  2025-11-06 14:30              â”‚â”‚
â”‚ â”‚ å‘è¯äºº    å¼ ä¸‰                          â”‚â”‚
â”‚ â”‚                                         â”‚â”‚
â”‚ â”‚ å‡ºåº“å›­åŒº * [è¯·é€‰æ‹©å›­åŒº____________] â–¼  â”‚â”‚  è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶  æ˜¾ç¤º ä¸‹æ‹‰åˆ—è¡¨  é™†å›­
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚                               æ°´å›­
â”‚ â”‚ â”‚ ğŸ¢ é™†å›­åŒ»åŠ¡å®¤                    â”‚  â”‚â”‚
â”‚ â”‚ â”‚ ğŸŒŠ æ°´å›­åŒ»åŠ¡å®¤                     â”‚  â”‚â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚ â”‚                                         â”‚â”‚
â”‚ â”‚ é¢†è¯äºº    [ç‹äº”___________________]    â”‚â”‚
â”‚ â”‚ å¤æ ¸äºº    [æåŒ»ç”Ÿ_________________]    â”‚â”‚
â”‚ â”‚ å¤‡æ³¨      [é™†å›­æ—¥å¸¸è¡¥å……____________]   â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š è¯å“æ˜ç»† (2ç§)            [ğŸ“‹é€‰æ‹©]      â”‚
â”‚                                             â”‚
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—â”‚
â”‚ â•‘ # â”‚ è¯å“åç§° â”‚ è§„æ ¼ â”‚ æ‰¹å· â”‚ è¯åº“ â”‚ å‡ºåº“ â”‚ å•ä½ â”‚ğŸ’¡è½¬æ¢ â”‚ å›­åŒºå…¥åº“ â”‚ ğŸ—‘ â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£â”‚
â”‚ â•‘ 1 â”‚ é˜¿è«è¥¿æ— â”‚ 0.25gâ”‚20250â”‚ 10ç›’â”‚ [2_]â”‚ ç›’  â”‚ 48ç²’ â”‚ +48ç²’   â”‚ ğŸ—‘ â•‘â—„â”€ è‡ªåŠ¨æ¢ç®—
â”‚ â•‘   â”‚ èƒ¶å›Š     â”‚Ã—24ç²’ â”‚101  â”‚  âœ“ â”‚     â”‚     â”‚â•â•â•â•â•â”‚         â”‚    â•‘
â”‚ â•‘   â”‚          â”‚/ç›’   â”‚     â”‚     â”‚     â”‚     â”‚è‡ªåŠ¨  â”‚         â”‚    â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£â”‚
â”‚ â•‘ 2 â”‚ å¸ƒæ´›èŠ¬ç‰‡ â”‚ 0.2g â”‚20250â”‚ 15ç›’â”‚ [3_]â”‚ ç›’  â”‚ 60ç‰‡ â”‚ +60ç‰‡   â”‚ ğŸ—‘ â•‘
â”‚ â•‘   â”‚          â”‚Ã—20ç‰‡ â”‚102  â”‚  âœ“ â”‚     â”‚     â”‚â•â•â•â•â•â”‚         â”‚    â•‘
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                             â”‚
â”‚ ğŸ’¡ è½¬æ¢è¯´æ˜                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â€¢ è¯åº“å‡ºåº“ï¼šæŒ‰åŒ…è£…å•ä½ï¼ˆç›’ï¼‰å¡«å†™        â”‚â”‚
â”‚ â”‚ â€¢ è‡ªåŠ¨è½¬æ¢ï¼šç³»ç»Ÿè‡ªåŠ¨è½¬æ¢ä¸ºæœ€å°å•ä½      â”‚â”‚
â”‚ â”‚ â€¢ å›­åŒºå…¥åº“ï¼šä»¥æœ€å°å•ä½ï¼ˆç²’/ç‰‡ï¼‰å…¥åº“     â”‚â”‚
â”‚ â”‚                                         â”‚â”‚
â”‚ â”‚ ç¤ºä¾‹ï¼šå‡ºåº“2ç›’ â†’ è‡ªåŠ¨è½¬æ¢48ç²’ â†’ å›­åŒº+48ç²’â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ âœï¸ ä¸‰æ–¹ç­¾å                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å‘è¯äºº: [å·²ç­¾å] âœ“ å¼ ä¸‰                 â”‚â”‚
â”‚ â”‚ é¢†è¯äºº: [ç‚¹å‡»ç­¾å] æœªç­¾å               â”‚â”‚
â”‚ â”‚ å¤æ ¸äºº: [ç‚¹å‡»ç­¾å] æœªç­¾å               â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ’¾ ä¿å­˜è‰ç¨¿]              [âœ“ æäº¤å¤æ ¸]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè½¬æ¢é€»è¾‘ï¼ˆå…³é”®ä»£ç ï¼‰

```javascript
/**
 * å‡ºåº“å•ä½è½¬æ¢ï¼ˆå…³é”®é€»è¾‘ï¼‰
 * @param {Array} items - è¯å“æ˜ç»†
 * @returns {Array} è½¬æ¢åçš„æ˜ç»†
 */
function convertOutboundItems(items) {
  return items.map(item => {
    // 1. è§£æè§„æ ¼
    const specInfo = UnitConverter.parseSpecification(item.specification)
    
    if (!specInfo) {
      throw new Error(`æ— æ³•è§£æè§„æ ¼: ${item.specification}`)
    }
    
    // 2. è½¬æ¢æ•°é‡ï¼ˆåŒ…è£…â†’æœ€å°ï¼‰
    const minQuantity = UnitConverter.packToMin(
      item.quantity,              // ç”¨æˆ·è¾“å…¥çš„åŒ…è£…æ•°é‡ï¼ˆå¦‚2ç›’ï¼‰
      specInfo.conversionRate     // è½¬æ¢ç‡ï¼ˆå¦‚24ï¼‰
    )
    
    // 3. è¿”å›è½¬æ¢åçš„æ•°æ®
    return {
      ...item,
      // è¯åº“æ‰£å‡ï¼ˆåŒ…è£…å•ä½ï¼‰
      packQuantity: item.quantity,
      packUnit: specInfo.packUnit,
      
      // å›­åŒºå…¥åº“ï¼ˆæœ€å°å•ä½ï¼‰â­ å…³é”®ï¼
      minQuantity: minQuantity,
      minUnit: specInfo.minUnit,
      
      // è§„æ ¼ä¿¡æ¯
      specInfo: specInfo
    }
  })
}

/**
 * æäº¤å‡ºåº“å•ï¼ˆå®Œæ•´æµç¨‹ï¼‰
 */
async function submitOutbound(outboundData) {
  const { items, fromLocation, toLocation } = outboundData
  
  // 1. è½¬æ¢è¯å“æ˜ç»†
  const convertedItems = convertOutboundItems(items)
  
  // 2. å¼€å¯äº‹åŠ¡
  const transaction = await db.startTransaction()
  
  try {
    // 3. æ‰£å‡è¯åº“åº“å­˜ï¼ˆåŒ…è£…å•ä½ï¼‰
    for (const item of convertedItems) {
      await transaction.collection('stock')
        .where({
          drugId: item.drugId,
          location: fromLocation,  // drug_storage
          batch: item.batch
        })
        .update({
          data: {
            quantity: _.inc(-item.packQuantity)  // æ‰£å‡åŒ…è£…æ•°é‡
          }
        })
    }
    
    // 4. å¢åŠ å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰â­ å…³é”®ï¼
    for (const item of convertedItems) {
      // æŸ¥è¯¢å›­åŒºæ˜¯å¦å·²æœ‰è¯¥æ‰¹æ¬¡
      const parkStock = await transaction.collection('stock')
        .where({
          drugId: item.drugId,
          location: toLocation,    // land_park / water_park
          batch: item.batch
        })
        .get()
      
      if (parkStock.data.length > 0) {
        // å·²å­˜åœ¨ï¼Œç´¯åŠ æœ€å°å•ä½
        await transaction.collection('stock')
          .doc(parkStock.data[0]._id)
          .update({
            data: {
              quantity: _.inc(item.minQuantity)  // å¢åŠ æœ€å°å•ä½
            }
          })
      } else {
        // ä¸å­˜åœ¨ï¼Œæ–°å»ºåº“å­˜è®°å½•ï¼ˆæœ€å°å•ä½ï¼‰
        await transaction.collection('stock').add({
          data: {
            drugId: item.drugId,
            drugName: item.drugName,
            specification: item.specification,
            batch: item.batch,
            productionDate: item.productionDate,
            expireDate: item.expireDate,
            location: toLocation,
            quantity: item.minQuantity,     // æœ€å°å•ä½ â­
            unit: item.minUnit,             // æœ€å°å•ä½ â­
            specInfo: item.specInfo,
            price: item.price
          }
        })
      }
    }
    
    // 5. åˆ›å»ºå‡ºåº“è®°å½•
    await transaction.collection('outRecords').add({
      data: {
        ...outboundData,
        items: convertedItems,
        createTime: new Date()
      }
    })
    
    // 6. æäº¤äº‹åŠ¡
    await transaction.commit()
    
    console.log('âœ… å‡ºåº“æˆåŠŸï¼Œè‡ªåŠ¨å®Œæˆå•ä½è½¬æ¢')
    return { success: true }
    
  } catch (error) {
    // 7. å›æ»šäº‹åŠ¡
    await transaction.rollback()
    console.error('âŒ å‡ºåº“å¤±è´¥:', error)
    throw error
  }
}
```

### æ•°æ®ç»“æ„ï¼ˆå®Œæ•´ç‰ˆï¼‰

```javascript
// å‡ºåº“è®°å½•
{
  recordNo: "CK20251106001",
  fromLocation: "drug_storage",
  toLocation: "land_park",
  items: [
    {
      drugId: "drug_001",
      drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
      specification: "0.25gÃ—24ç²’/ç›’",
      batch: "20250101",
      
      // è¯åº“æ‰£å‡ï¼ˆåŒ…è£…å•ä½ï¼‰
      packQuantity: 2,
      packUnit: "ç›’",
      
      // å›­åŒºå…¥åº“ï¼ˆæœ€å°å•ä½ï¼‰â­
      minQuantity: 48,
      minUnit: "ç²’",
      
      // è§„æ ¼ä¿¡æ¯
      specInfo: {
        conversionRate: 24,
        minUnit: "ç²’",
        packUnit: "ç›’"
      }
    }
  ]
}

// å‡ºåº“ååº“å­˜å˜åŒ–
// è¯åº“åº“å­˜ï¼ˆåŒ…è£…å•ä½ï¼‰
stock (location: drug_storage):
{
  drugId: "drug_001",
  quantity: 10 â†’ 8,    // æ‰£å‡2ç›’
  unit: "ç›’"
}

// å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰â­ å…³é”®ï¼
stock (location: land_park):
{
  drugId: "drug_001",
  quantity: 0 â†’ 48,    // å¢åŠ 48ç²’
  unit: "ç²’"           // æœ€å°å•ä½
}
```

---

## è®¾è®¡3ï¼šé—¨è¯Šæ¶ˆè€—ç•Œé¢ï¼ˆç›´æ¥æ‰£å‡ - æ— éœ€è½¬æ¢ï¼‰

### ç•Œé¢å¸ƒå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† é—¨è¯Šç™»è®°                            [ä¿å­˜]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ¥ æ‚£è€…ä¿¡æ¯                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å§“å  [å¼ ä¸‰___]  å¹´é¾„ [28] æ€§åˆ« âšªç”·âšªå¥³â”‚â”‚
â”‚ â”‚ ç—‡çŠ¶  [å‘çƒ­ã€å’³å—½__________________]    â”‚â”‚
â”‚ â”‚ å›­åŒº  ğŸ¢ é™†å›­åŒ»åŠ¡å®¤                  â–¼ â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š ç”¨è¯æ˜ç»† (2ç§)            [ğŸ“‹é€‰æ‹©]      â”‚
â”‚                                             â”‚
â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—â”‚
â”‚ â•‘ # â”‚ è¯å“åç§° â”‚ è§„æ ¼ â”‚ æ‰¹å· â”‚ å½“å‰åº“å­˜ â”‚ ç”¨é‡ â”‚ å•ä½ â”‚ å‰©ä½™ â”‚ ğŸ—‘ â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£â”‚
â”‚ â•‘ 1 â”‚ é˜¿è«è¥¿æ— â”‚ 0.25gâ”‚20250â”‚ 48ç²’    â”‚ [6_]â”‚ ç²’  â”‚ 42ç²’ â”‚ ğŸ—‘ â•‘â—„â”€ ç›´æ¥æ‰£å‡
â”‚ â•‘   â”‚ èƒ¶å›Š     â”‚Ã—24ç²’ â”‚101  â”‚(2ç›’)    â”‚     â”‚     â”‚(1.75)â”‚    â•‘
â”‚ â•‘   â”‚          â”‚/ç›’   â”‚     â”‚  âœ“     â”‚     â”‚     â”‚      â”‚    â•‘
â”‚ â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£â”‚
â”‚ â•‘ 2 â”‚ å¸ƒæ´›èŠ¬ç‰‡ â”‚ 0.2g â”‚20250â”‚ 60ç‰‡    â”‚ [4_]â”‚ ç‰‡  â”‚ 56ç‰‡ â”‚ ğŸ—‘ â•‘
â”‚ â•‘   â”‚          â”‚Ã—20ç‰‡ â”‚102  â”‚(3ç›’)    â”‚     â”‚     â”‚(2.8) â”‚    â•‘
â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                             â”‚
â”‚ ğŸ“ è¯Šæ–­  [ä¸Šå‘¼å¸é“æ„ŸæŸ“________________]    â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å–æ¶ˆ]                          [ä¿å­˜è®°å½•]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒé€»è¾‘ï¼ˆç®€åŒ–ç‰ˆ - æ— éœ€è½¬æ¢ï¼‰

```javascript
/**
 * é—¨è¯Šæ¶ˆè€—æ‰£å‡åº“å­˜ï¼ˆæ— éœ€è½¬æ¢ï¼‰â­
 * @param {String} drugId - è¯å“ID
 * @param {String} location - å›­åŒº
 * @param {String} batch - æ‰¹å·
 * @param {Number} quantity - æ¶ˆè€—æ•°é‡ï¼ˆæœ€å°å•ä½ï¼Œå¦‚6ç²’ï¼‰
 * @returns {Boolean} æ˜¯å¦æˆåŠŸ
 */
async function deductClinicStock(drugId, location, batch, quantity) {
  // 1. æŸ¥è¯¢å›­åŒºåº“å­˜
  const stock = await db.collection('stock')
    .where({
      drugId: drugId,
      location: location,  // land_park / water_park
      batch: batch
    })
    .get()
  
  if (stock.data.length === 0) {
    throw new Error('è¯¥å›­åŒºæ— æ­¤è¯å“åº“å­˜')
  }
  
  const currentStock = stock.data[0]
  
  // 2. éªŒè¯åº“å­˜ï¼ˆç›´æ¥æ¯”è¾ƒï¼Œæ— éœ€è½¬æ¢ï¼‰â­
  if (currentStock.quantity < quantity) {
    throw new Error(`åº“å­˜ä¸è¶³ï¼Œå½“å‰: ${currentStock.quantity}${currentStock.unit}ï¼Œéœ€è¦: ${quantity}${currentStock.unit}`)
  }
  
  // 3. ç›´æ¥æ‰£å‡ï¼ˆæ— éœ€è½¬æ¢ï¼‰â­
  await db.collection('stock').doc(currentStock._id).update({
    data: {
      quantity: _.inc(-quantity),  // ç›´æ¥æ‰£å‡æœ€å°å•ä½
      updateTime: new Date()
    }
  })
  
  console.log(`âœ… åº“å­˜æ‰£å‡æˆåŠŸ: ${quantity}${currentStock.unit}`)
  return true
}

/**
 * ä¼˜åŠ¿å¯¹æ¯”
 */
/*
æ—§æ–¹æ¡ˆï¼ˆå¤æ‚ï¼‰:
1. æŸ¥è¯¢åº“å­˜ï¼ˆåŒ…è£…å•ä½ï¼Œå¦‚2ç›’ï¼‰
2. è½¬æ¢ç”¨é‡ï¼ˆ6ç²’ Ã· 24 = 0.25ç›’ï¼‰
3. æ‰£å‡åº“å­˜ï¼ˆ2ç›’ - 0.25ç›’ = 1.75ç›’ï¼‰
4. å¤šæ¬¡è½¬æ¢ï¼Œç²¾åº¦æŸå¤±

æ–°æ–¹æ¡ˆï¼ˆç®€å•ï¼‰:
1. æŸ¥è¯¢åº“å­˜ï¼ˆæœ€å°å•ä½ï¼Œå¦‚48ç²’ï¼‰
2. ç›´æ¥æ‰£å‡ï¼ˆ48ç²’ - 6ç²’ = 42ç²’ï¼‰
3. ä¸€æ­¥å®Œæˆï¼Œç²¾åº¦é«˜
*/
```

---

## è®¾è®¡4ï¼šåº“å­˜åˆ—è¡¨ç•Œé¢ï¼ˆæ™ºèƒ½åŒå•ä½æ˜¾ç¤ºï¼‰

### ç•Œé¢å¸ƒå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† åº“å­˜ç®¡ç†                          [æœç´¢]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ğŸ¥ å›­åŒºç­›é€‰                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ â”‚ â— å…¨éƒ¨â”‚  é™†å›­ â”‚  æ°´å›­ â”‚  è¯åº“ â”‚         â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                             â”‚
â”‚ ğŸ“Š åº“å­˜ç»Ÿè®¡ï¼ˆæŒ‰å›­åŒºï¼‰                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ğŸ¢ é™†å›­        â”‚ ğŸŒŠ æ°´å›­        â”‚ ğŸ¥ è¯åº“  â”‚â”‚
â”‚ â”‚ å“ç§: 28      â”‚ å“ç§: 25      â”‚å“ç§: 95  â”‚â”‚
â”‚ â”‚ æ€»é‡: 1,260ç²’ â”‚ æ€»é‡: 980ç²’   â”‚æ€»é‡: 521ç›’â”‚â”‚â—„â”€ ä¸åŒå•ä½
â”‚ â”‚ (52.5ç›’)     â”‚ (40.8ç›’)      â”‚         â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ ğŸ’Š åº“å­˜æ˜ç»†                                  â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ é˜¿è«è¥¿æ—èƒ¶å›Š                 ğŸ¢ é™†å›­    â”‚â”‚
â”‚ â”‚ 0.25gÃ—24ç²’/ç›’ | æ‰¹å·: 20250101         â”‚â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚ â”‚ ğŸ’Š åº“å­˜: 42ç²’ (1ç›’é›¶18ç²’)          âœ“   â”‚â”‚â—„â”€ æ™ºèƒ½æ˜¾ç¤º
â”‚ â”‚ ğŸ“… æœ‰æ•ˆæœŸ: 2027-01-01 (730å¤©)          â”‚â”‚
â”‚ â”‚ ğŸ’° å•ä»·: Â¥0.52/ç²’                      â”‚â”‚
â”‚ â”‚                                  [è¯¦æƒ…]â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å¸ƒæ´›èŠ¬ç‰‡                     ğŸŒŠ æ°´å›­    â”‚â”‚
â”‚ â”‚ 0.2gÃ—20ç‰‡/ç›’ | æ‰¹å·: 20250102          â”‚â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚ â”‚ ğŸ’Š åº“å­˜: 56ç‰‡ (2ç›’é›¶16ç‰‡)          âœ“   â”‚â”‚
â”‚ â”‚ ğŸ“… æœ‰æ•ˆæœŸ: 2027-01-02 (731å¤©)          â”‚â”‚
â”‚ â”‚ ğŸ’° å•ä»·: Â¥0.90/ç‰‡                      â”‚â”‚
â”‚ â”‚                                  [è¯¦æƒ…]â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å¯¹ä¹™é…°æ°¨åŸºé…šç‰‡               ğŸ¥ è¯åº“    â”‚â”‚
â”‚ â”‚ 0.5gÃ—12ç‰‡/ç›’ | æ‰¹å·: 20250103          â”‚â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚â”‚
â”‚ â”‚ ğŸ’Š åº“å­˜: 104ç›’                     âœ“   â”‚â”‚â—„â”€ è¯åº“æ˜¾ç¤ºåŒ…è£…
â”‚ â”‚ ğŸ“… æœ‰æ•ˆæœŸ: 2027-01-03 (729å¤©)          â”‚â”‚
â”‚ â”‚ ğŸ’° å•ä»·: Â¥15.0/ç›’                      â”‚â”‚
â”‚ â”‚                                  [è¯¦æƒ…]â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ˜¾ç¤ºé€»è¾‘ï¼ˆæ™ºèƒ½åˆ¤æ–­ï¼‰

```javascript
/**
 * æ ¼å¼åŒ–åº“å­˜æ˜¾ç¤ºï¼ˆæ™ºèƒ½åˆ¤æ–­å›­åŒºç±»å‹ï¼‰
 * @param {Object} stock - åº“å­˜æ•°æ®
 * @returns {String} æ ¼å¼åŒ–å­—ç¬¦ä¸²
 */
function formatStockDisplay(stock) {
  const { quantity, unit, location, specInfo } = stock
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºè¯åº“
  if (location === 'drug_storage') {
    // è¯åº“ï¼šåªæ˜¾ç¤ºåŒ…è£…å•ä½
    return `${quantity}${unit}`
    // ç¤ºä¾‹: "104ç›’"
  } else {
    // å›­åŒºï¼šæ˜¾ç¤ºæœ€å°å•ä½ + æ¢ç®—
    return UnitConverter.formatStockWithConversion(quantity, specInfo)
    // ç¤ºä¾‹: "42ç²’ (1ç›’é›¶18ç²’)"
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const drugStorageStock = {
  quantity: 104,
  unit: 'ç›’',
  location: 'drug_storage'
}
console.log(formatStockDisplay(drugStorageStock))
// è¾“å‡º: "104ç›’"

const parkStock = {
  quantity: 42,
  unit: 'ç²’',
  location: 'land_park',
  specInfo: {
    conversionRate: 24,
    minUnit: 'ç²’',
    packUnit: 'ç›’'
  }
}
console.log(formatStockDisplay(parkStock))
// è¾“å‡º: "42ç²’ (1ç›’é›¶18ç²’)"
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡ï¼ˆæœ€ç»ˆä¼˜åŒ–ç‰ˆï¼‰

### stock é›†åˆï¼ˆå…³é”®ä¼˜åŒ–ï¼‰

```javascript
{
  _id: "stock_001",
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25gÃ—24ç²’/ç›’",
  batch: "20250101",
  productionDate: ISODate("2025-01-01"),
  expireDate: ISODate("2027-01-01"),
  
  // ===== å…³é”®å­—æ®µ =====
  location: "land_park",                // æ‰€å±å›­åŒº
  
  // æ•°é‡å’Œå•ä½ï¼ˆæ ¹æ®å›­åŒºç±»å‹ä¸åŒï¼‰â­
  quantity: 42,                         // é™†å›­: 42ç²’ï¼ˆæœ€å°å•ä½ï¼‰
  unit: "ç²’",                           // é™†å›­: ç²’
  
  // è§„æ ¼ä¿¡æ¯ï¼ˆå†—ä½™ï¼Œç”¨äºè½¬æ¢æ˜¾ç¤ºï¼‰
  specInfo: {
    conversionRate: 24,
    minUnit: "ç²’",
    packUnit: "ç›’",
    dosage: 0.25,
    dosageUnit: "g"
  },
  
  price: 12.5,                          // åŒ…è£…å•ä»·
  pricePerMin: 0.52,                    // æœ€å°å•ä½å•ä»·ï¼ˆä¾¿äºé—¨è¯Šè®¡è´¹ï¼‰
  
  lockQuantity: 0,
  createTime: ISODate("2025-01-06"),
  updateTime: ISODate("2025-11-06")
}

// å¦ä¸€ä¸ªç¤ºä¾‹ï¼ˆè¯åº“ï¼‰
{
  _id: "stock_002",
  drugId: "drug_001",
  location: "drug_storage",             // è¯åº“
  
  // è¯åº“ç”¨åŒ…è£…å•ä½ â­
  quantity: 104,                        // 104ç›’ï¼ˆåŒ…è£…å•ä½ï¼‰
  unit: "ç›’",
  
  specInfo: {
    conversionRate: 24,
    minUnit: "ç²’",
    packUnit: "ç›’"
  },
  
  price: 12.5
}

// ç´¢å¼•ä¼˜åŒ–
db.stock.createIndex({ "drugId": 1, "location": 1, "batch": 1 }, { unique: true })
db.stock.createIndex({ "location": 1, "quantity": 1 })
db.stock.createIndex({ "expireDate": 1 })
db.stock.createIndex({ "unit": 1 })  // æ–°å¢ï¼šæŒ‰å•ä½ç´¢å¼•
```

### outRecords é›†åˆï¼ˆå‡ºåº“è®°å½• - åŒ…å«è½¬æ¢ä¿¡æ¯ï¼‰

```javascript
{
  _id: "out_001",
  recordNo: "CK20251106001",
  fromLocation: "drug_storage",
  toLocation: "land_park",
  
  items: [
    {
      drugId: "drug_001",
      drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
      specification: "0.25gÃ—24ç²’/ç›’",
      batch: "20250101",
      
      // ===== åŒå•ä½è®°å½•ï¼ˆé‡è¦ï¼‰=====
      // è¯åº“æ‰£å‡
      packQuantity: 2,
      packUnit: "ç›’",
      
      // å›­åŒºå…¥åº“
      minQuantity: 48,
      minUnit: "ç²’",
      
      // è½¬æ¢ä¿¡æ¯
      specInfo: {
        conversionRate: 24,
        minUnit: "ç²’",
        packUnit: "ç›’"
      },
      
      // åº“å­˜å˜åŒ–è®°å½•
      drugStorageBefore: 10,    // è¯åº“å‡ºåº“å‰: 10ç›’
      drugStorageAfter: 8,      // è¯åº“å‡ºåº“å: 8ç›’
      parkBefore: 0,            // å›­åŒºå…¥åº“å‰: 0ç²’
      parkAfter: 48             // å›­åŒºå…¥åº“å: 48ç²’
    }
  ],
  
  dispenser: "å¼ ä¸‰",
  receiver: "ç‹äº”",
  reviewer: "æåŒ»ç”Ÿ",
  createTime: ISODate("2025-11-06T14:30:00"),
  status: "completed"
}

// ç´¢å¼•
db.outRecords.createIndex({ "recordNo": 1 }, { unique: true })
db.outRecords.createIndex({ "fromLocation": 1, "createTime": -1 })
db.outRecords.createIndex({ "toLocation": 1, "createTime": -1 })
```

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ï¼šå®Œæ•´å‡ºåº“æµç¨‹

```javascript
/**
 * å®Œæ•´å‡ºåº“æµç¨‹ç¤ºä¾‹
 */
async function completeOutboundExample() {
  // 1. å‡†å¤‡å‡ºåº“æ•°æ®
  const outboundData = {
    recordNo: "CK20251106001",
    fromLocation: "drug_storage",
    toLocation: "land_park",
    items: [
      {
        drugId: "drug_001",
        drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
        specification: "0.25gÃ—24ç²’/ç›’",
        batch: "20250101",
        quantity: 2,              // ç”¨æˆ·è¾“å…¥ï¼š2ç›’
        unit: "ç›’"
      }
    ],
    dispenser: "å¼ ä¸‰",
    receiver: "ç‹äº”",
    reviewer: "æåŒ»ç”Ÿ"
  }
  
  // 2. è½¬æ¢è¯å“æ˜ç»†
  const convertedItems = outboundData.items.map(item => {
    // è§£æè§„æ ¼
    const specInfo = UnitConverter.parseSpecification(item.specification)
    
    // è½¬æ¢æ•°é‡
    const minQuantity = UnitConverter.packToMin(item.quantity, specInfo.conversionRate)
    
    console.log(`ğŸ“¦ è½¬æ¢: ${item.quantity}${specInfo.packUnit} â†’ ${minQuantity}${specInfo.minUnit}`)
    
    return {
      ...item,
      packQuantity: item.quantity,
      packUnit: specInfo.packUnit,
      minQuantity: minQuantity,
      minUnit: specInfo.minUnit,
      specInfo: specInfo
    }
  })
  
  // 3. æ‰§è¡Œå‡ºåº“ï¼ˆå¸¦äº‹åŠ¡ï¼‰
  const transaction = await db.startTransaction()
  
  try {
    // 3.1 æ‰£å‡è¯åº“åº“å­˜ï¼ˆåŒ…è£…å•ä½ï¼‰
    for (const item of convertedItems) {
      const drugStockBefore = await transaction.collection('stock')
        .where({
          drugId: item.drugId,
          location: outboundData.fromLocation,
          batch: item.batch
        })
        .get()
      
      await transaction.collection('stock')
        .doc(drugStockBefore.data[0]._id)
        .update({
          data: {
            quantity: _.inc(-item.packQuantity)  // æ‰£å‡åŒ…è£…å•ä½
          }
        })
      
      console.log(`âœ… è¯åº“æ‰£å‡: ${item.packQuantity}${item.packUnit}`)
    }
    
    // 3.2 å¢åŠ å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰â­
    for (const item of convertedItems) {
      const parkStock = await transaction.collection('stock')
        .where({
          drugId: item.drugId,
          location: outboundData.toLocation,
          batch: item.batch
        })
        .get()
      
      if (parkStock.data.length > 0) {
        // å·²å­˜åœ¨ï¼Œç´¯åŠ 
        await transaction.collection('stock')
          .doc(parkStock.data[0]._id)
          .update({
            data: {
              quantity: _.inc(item.minQuantity)  // å¢åŠ æœ€å°å•ä½
            }
          })
      } else {
        // ä¸å­˜åœ¨ï¼Œæ–°å»ºï¼ˆæœ€å°å•ä½ï¼‰
        await transaction.collection('stock').add({
          data: {
            drugId: item.drugId,
            drugName: item.drugName,
            specification: item.specification,
            batch: item.batch,
            location: outboundData.toLocation,
            quantity: item.minQuantity,       // æœ€å°å•ä½ â­
            unit: item.minUnit,               // æœ€å°å•ä½ â­
            specInfo: item.specInfo
          }
        })
      }
      
      console.log(`âœ… å›­åŒºå¢åŠ : ${item.minQuantity}${item.minUnit}`)
    }
    
    // 3.3 åˆ›å»ºå‡ºåº“è®°å½•
    await transaction.collection('outRecords').add({
      data: {
        ...outboundData,
        items: convertedItems,
        createTime: new Date(),
        status: 'completed'
      }
    })
    
    // 3.4 æäº¤äº‹åŠ¡
    await transaction.commit()
    
    console.log('ğŸ‰ å‡ºåº“æˆåŠŸï¼')
    console.log('â”'.repeat(50))
    console.log('è¯åº“: 10ç›’ â†’ 8ç›’')
    console.log('å›­åŒº: 0ç²’ â†’ 48ç²’')
    
    return { success: true }
    
  } catch (error) {
    await transaction.rollback()
    console.error('âŒ å‡ºåº“å¤±è´¥:', error)
    throw error
  }
}

// æ‰§è¡Œç¤ºä¾‹
// await completeOutboundExample()
```

---

## âœ… æ–¹æ¡ˆæ€»ç»“ä¸ä¼˜åŠ¿

### æ ¸å¿ƒè®¾è®¡äº®ç‚¹

```
1ï¸âƒ£ åŒè½¨åˆ¶å­˜å‚¨ â­â­â­
   ğŸ¥ è¯åº“: åŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ã€è¢‹ï¼‰
   ğŸ¢ å›­åŒº: æœ€å°å•ä½ï¼ˆç²’ã€ç‰‡ã€mlï¼‰
   
   ä¼˜åŠ¿:
   âœ… ç¬¦åˆå®é™…ä¸šåŠ¡åœºæ™¯
   âœ… è¯åº“ä»“å‚¨ä¹ æƒ¯ï¼ˆæ•´ç®±æ•´ç›’ï¼‰
   âœ… å›­åŒºè¯Šç–—ç²¾åº¦ï¼ˆç²¾ç¡®åˆ°ç²’ï¼‰

2ï¸âƒ£ å•ç‚¹è½¬æ¢ â­â­â­
   åªåœ¨å‡ºåº“ç¯èŠ‚è½¬æ¢ï¼ˆè¯åº“â†’å›­åŒºï¼‰
   
   ä¼˜åŠ¿:
   âœ… è½¬æ¢é€»è¾‘é›†ä¸­ï¼Œæ˜“äºç»´æŠ¤
   âœ… å‡å°‘è½¬æ¢æ¬¡æ•°ï¼Œæé«˜ç²¾åº¦
   âœ… é—¨è¯Šæ¶ˆè€—æ— éœ€è½¬æ¢ï¼Œé€Ÿåº¦å¿«

3ï¸âƒ£ æ™ºèƒ½æ˜¾ç¤º â­â­â­
   è¯åº“: "104ç›’"
   å›­åŒº: "42ç²’ (1ç›’é›¶18ç²’)"
   
   ä¼˜åŠ¿:
   âœ… è¯åº“ç®€æ´æ˜äº†
   âœ… å›­åŒºç²¾ç¡®è¯¦ç»†
   âœ… è‡ªåŠ¨æ¢ç®—ä¾¿äºç†è§£

4ï¸âƒ£ æ­£åˆ™è§£æ â­â­â­
   æ”¯æŒ4ç§è§„æ ¼æ ¼å¼
   
   ä¼˜åŠ¿:
   âœ… å…¼å®¹æ€§å¼ºï¼ˆ0.1Ã—12ç²’/ç›’ï¼‰
   âœ… è‡ªåŠ¨æå–è½¬æ¢ç‡
   âœ… å¥å£®çš„é”™è¯¯å¤„ç†

5ï¸âƒ£ äº‹åŠ¡ä¿è¯ â­â­â­
   è¯åº“æ‰£å‡ + å›­åŒºå¢åŠ 
   
   ä¼˜åŠ¿:
   âœ… æ•°æ®ä¸€è‡´æ€§
   âœ… åŸå­æ€§æ“ä½œ
   âœ… å¼‚å¸¸è‡ªåŠ¨å›æ»š
```

### å®æ–½è·¯çº¿å›¾

```
ç¬¬1é˜¶æ®µï¼ˆ1å¤©ï¼‰- åŸºç¡€è®¾æ–½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¡ UnitConverter å·¥å…·ç±»
â–¡ è§„æ ¼è§£ææµ‹è¯•å¥—ä»¶
â–¡ æ•°æ®åº“å­—æ®µè°ƒæ•´

ç¬¬2é˜¶æ®µï¼ˆ2å¤©ï¼‰- æ ¸å¿ƒåŠŸèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¡ å…¥åº“é¡µé¢ï¼ˆåŒ…è£…å•ä½ï¼‰
â–¡ å‡ºåº“é¡µé¢ï¼ˆå•ä½è½¬æ¢é€»è¾‘ï¼‰
â–¡ é—¨è¯Šé¡µé¢ï¼ˆç›´æ¥æ‰£å‡ï¼‰

ç¬¬3é˜¶æ®µï¼ˆ1å¤©ï¼‰- æ˜¾ç¤ºä¼˜åŒ–
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¡ åº“å­˜åˆ—è¡¨ï¼ˆæ™ºèƒ½æ˜¾ç¤ºï¼‰
â–¡ ç»Ÿè®¡æŠ¥è¡¨ï¼ˆåŒå•ä½æ±‡æ€»ï¼‰
â–¡ æ•°æ®è¿ç§»è„šæœ¬

ç¬¬4é˜¶æ®µï¼ˆ1å¤©ï¼‰- æµ‹è¯•éªŒè¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â–¡ å•å…ƒæµ‹è¯•
â–¡ é›†æˆæµ‹è¯•
â–¡ ç”¨æˆ·éªŒæ”¶æµ‹è¯•
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.14 Ultimate  
**è®¾è®¡å®Œæˆ**: 2025-11-06  
**æ ¸å¿ƒåˆ›æ–°**: åŒè½¨åˆ¶å­˜å‚¨ + å•ç‚¹è½¬æ¢ + æ™ºèƒ½æ˜¾ç¤º

ğŸ¯ **ç»ˆææ–¹æ¡ˆå®Œæˆï¼è¯åº“ç”¨åŒ…è£…ï¼Œå›­åŒºç”¨æœ€å°ï¼Œå‡ºåº“è‡ªåŠ¨è½¬æ¢ï¼**

