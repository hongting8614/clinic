# 📖 部署云函数 - 超详细步骤

**目标**: 部署21个云函数到微信云开发  
**预计时间**: 25-40分钟  
**难度**: ⭐⭐☆☆☆ 简单

---

## 🎯 云函数清单

### 优先级1 - 核心功能（10个）⭐⭐⭐
1. `stockManage` - 库存管理（最重要，修复首页错误）
2. `drugManage` - 药品管理
3. `inRecords` - 入库管理
4. `outRecords` - 出库管理
5. `getDrugList` - 药品列表查询
6. `getStockList` - 库存列表查询
7. `clinicRecords` - 门诊用药登记
8. `reportService` - 报表服务
9. `queryService` - 查询服务
10. `login` - 用户登录

### 优先级2 - 定时任务（2个）⭐⭐
11. `dailySummary` - 每日统计（需配置触发器）
12. `expiryMonitor` - 效期预警（需配置触发器）

### 优先级3 - 辅助功能（9个）⭐
13. `consumeRecords` - 消耗记录管理
14. `requisitionRecords` - 请领记录管理
15. `updateStock` - 库存更新
16. `getUserList` - 用户列表查询
17. `addUser` - 添加用户
18. `updateUser` - 更新用户
19. `deleteUser` - 删除用户
20. `updateUserStatus` - 更新用户状态
21. `getMyOpenId` - 获取OpenID

---

## 📋 第一步：确认项目已正确打开

### 1.1 检查项目路径

确认微信开发者工具打开的是正确的目录：
```
正确路径：
D:\medicine_manager\AK-PMS\unpackage\dist\dev\mp-weixin
```

### 1.2 检查文件树

左侧文件树应该显示：
```
项目文件树：
├── app.js
├── app.json ← 必须有这个
├── pages/
├── components/
├── cloudfunctions/ ← 必须有这个
│   ├── stockManage/
│   ├── drugManage/
│   └── ...
└── static/
```

**如果看不到 cloudfunctions**：
- 参考：`✅【问题已解决】现在立即操作.txt`
- 需要重新导入项目到正确路径

---

## 📋 第二步：配置云开发环境

### 2.1 点击顶部"云开发"按钮

```
顶部工具栏：
┌─────────────────────────────────────┐
│ [文件] [编辑] [工具] [云开发] ← 点这里 │
└─────────────────────────────────────┘
```

### 2.2 右键 cloudfunctions 文件夹

在左侧文件树：
1. 找到 `cloudfunctions` 文件夹
2. **右键点击** cloudfunctions 文件夹
3. 在弹出菜单中选择：**当前环境**

```
右键菜单：
┌──────────────────────────┐
│ 新建云函数               │
│ 上传并部署：所有文件     │
│ 当前环境 ← 点这里        │
│ 更多设置                 │
│ 同步云函数列表           │
└──────────────────────────┘
```

### 2.3 选择云环境

在弹出的环境列表中：
```
┌────────────────────────────────┐
│ 选择云环境                     │
├────────────────────────────────┤
│                                │
│ ● cloud1-3gv7spppf7d2d0f4     │ ← 选择这个
│   ○ 其他环境（如果有）         │
│                                │
├────────────────────────────────┤
│              [确定]            │
└────────────────────────────────┘
```

选择：`cloud1-3gv7spppf7d2d0f4`

点击：**[确定]**

### 2.4 验证环境配置成功

右键 cloudfunctions 再次查看，应该显示：
```
当前环境: cloud1-3gv7spppf7d2d0f4 ✅
```

---

## 📋 第三步：部署第一个云函数 (stockManage)

**这是最重要的云函数，修复首页错误！**

### 3.1 找到 stockManage 文件夹

在文件树中展开：
```
cloudfunctions/
├── addUser/
├── clinicRecords/
├── ...
└── stockManage/ ← 找到这个
    ├── index.js
    └── package.json
```

### 3.2 右键 stockManage 文件夹

**⚠️ 注意**：
- 右键点击的是 **文件夹 stockManage**
- 不是 index.js 文件
- 不是 cloudfunctions 文件夹

### 3.3 选择上传并部署选项

在右键菜单中：
```
┌──────────────────────────────────┐
│ 上传并部署：云端安装依赖 ← 选这个！ │
│ 上传并部署：不校验依赖           │
│ 增量上传：云端安装依赖           │
│ 下载云端文件                     │
│ 创建云端安装依赖                 │
└──────────────────────────────────┘
```

**必须选择**：`上传并部署：云端安装依赖`

**为什么选这个**：
- "云端安装依赖"会自动安装 package.json 中的依赖
- "不校验依赖"可能导致云函数运行失败
- ✅ 推荐选择：云端安装依赖

### 3.4 观察上传进度

点击后，控制台会显示上传进度：

```
控制台输出：
┌────────────────────────────────────────┐
│ [云函数] [stockManage] 上传中...      │
│ [云函数] [stockManage] 上传成功        │
│ [云函数] [stockManage] 云端安装依赖中...│
│ [云函数] [stockManage] 部署成功 ✅     │
└────────────────────────────────────────┘

预计时间：1-2分钟
```

### 3.5 验证部署成功

**成功标志**：
- ✅ 控制台显示"部署成功"
- ✅ stockManage 文件夹图标变成云朵图标 ☁️
- ✅ 没有错误提示

### 3.6 编译项目

部署成功后，点击顶部：**[编译]** 按钮
```
顶部工具栏：
┌─────────────────────────────────────┐
│ [编译] [预览] [真机调试]  ← 点编译   │
└─────────────────────────────────────┘
```

### 3.7 验证首页错误已修复

查看模拟器和控制台：

**控制台应该显示**：
```
✅ App Launch
✅ 云开发初始化成功
✅ 首页 onLoad
✅ 今日统计加载成功
✅ 入库单: 0
✅ 出库单: 0
✅ 药品种类: 0
✅ 库存预警: 0
```

**不应该有**：
```
❌ Error: $ is not defined
❌ 云函数调用失败
```

---

## 📋 第四步：批量部署其他核心云函数

按相同步骤，依次部署以下云函数：

### 4.1 drugManage (药品管理)

1. 右键：`cloudfunctions/drugManage`
2. 选择：`上传并部署：云端安装依赖`
3. 等待：1-2分钟
4. 看到：`部署成功 ✅`

### 4.2 inRecords (入库管理)

1. 右键：`cloudfunctions/inRecords`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

### 4.3 outRecords (出库管理)

1. 右键：`cloudfunctions/outRecords`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

### 4.4 getDrugList (药品列表)

1. 右键：`cloudfunctions/getDrugList`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

### 4.5 getStockList (库存列表)

1. 右键：`cloudfunctions/getStockList`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

### 4.6 clinicRecords (门诊登记)

1. 右键：`cloudfunctions/clinicRecords`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

### 4.7 reportService (报表服务)

1. 右键：`cloudfunctions/reportService`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

### 4.8 queryService (查询服务)

1. 右键：`cloudfunctions/queryService`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

### 4.9 login (用户登录)

1. 右键：`cloudfunctions/login`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功

---

## 📋 第五步：部署定时任务云函数

### 5.1 dailySummary (每日统计)

1. 右键：`cloudfunctions/dailySummary`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功
4. ⚠️ 稍后需要配置触发器

### 5.2 expiryMonitor (效期预警)

1. 右键：`cloudfunctions/expiryMonitor`
2. 选择：`上传并部署：云端安装依赖`
3. 等待部署成功
4. ⚠️ 稍后需要配置触发器

---

## 📋 第六步：部署辅助功能云函数（可选）

这些云函数可以选择性部署，不影响核心功能：

```
可选部署列表：
□ consumeRecords      - 消耗记录
□ requisitionRecords  - 请领记录
□ updateStock         - 库存更新
□ getUserList         - 用户列表
□ addUser             - 添加用户
□ updateUser          - 更新用户
□ deleteUser          - 删除用户
□ updateUserStatus    - 用户状态
□ getMyOpenId         - 获取OpenID
```

按需部署，操作步骤相同：
1. 右键云函数文件夹
2. 上传并部署：云端安装依赖
3. 等待成功

---

## 📋 第七步：验证所有云函数部署状态

### 7.1 通过微信开发者工具查看

1. 点击顶部：`云开发`
2. 查看 cloudfunctions 文件夹
3. 已部署的云函数显示云朵图标 ☁️

### 7.2 通过云开发控制台查看

1. 浏览器访问：`https://console.cloud.tencent.com/tcb`
2. 选择环境：`cloud1-3gv7spppf7d2d0f4`
3. 点击：云函数
4. 查看云函数列表

应该看到：
```
┌─────────────────────────────────────────────────┐
│ 云函数列表                                      │
├──────────┬─────────┬──────────┬────────────────┤
│ 函数名称  │ 状态    │ 触发器   │ 操作           │
├──────────┼─────────┼──────────┼────────────────┤
│ stockManage│已部署✅│ 0个     │ [查看][删除]   │
│ drugManage │已部署✅│ 0个     │ [查看][删除]   │
│ inRecords  │已部署✅│ 0个     │ [查看][删除]   │
│ outRecords │已部署✅│ 0个     │ [查看][删除]   │
│ getDrugList│已部署✅│ 0个     │ [查看][删除]   │
│ getStockList│已部署✅│0个     │ [查看][删除]   │
│ clinicRecords│已部署✅│0个    │ [查看][删除]   │
│ reportService│已部署✅│0个    │ [查看][删除]   │
│ queryService│已部署✅│0个     │ [查看][删除]   │
│ login      │已部署✅│ 0个     │ [查看][删除]   │
│ dailySummary│已部署✅│0个     │ [查看][删除]   │
│ expiryMonitor│已部署✅│0个    │ [查看][删除]   │
└──────────┴─────────┴──────────┴────────────────┘
```

---

## 📋 第八步：测试云函数

### 8.1 编译项目

点击顶部：**[编译]** 按钮

### 8.2 测试首页功能

进入小程序首页，检查：
- [ ] 今日数据正常显示
- [ ] 无"$ is not defined"错误
- [ ] 无"云函数不存在"错误

### 8.3 测试药品选择器

1. 点击"药品入库"
2. 点击"添加药品"
3. 尝试搜索药品
4. 验证：调用 drugManage 云函数成功

### 8.4 测试门诊登记

1. 点击"门诊用药"
2. 选择园区
3. 添加药品
4. 验证：调用 clinicRecords 云函数成功

### 8.5 测试报表查询

1. 点击"报表中心"
2. 选择任意报表
3. 点击查询
4. 验证：调用 reportService 云函数成功

---

## ⚠️ 常见问题

### Q1: 右键没有"上传并部署"选项？

**原因**：
- 未配置云开发环境
- 或点击的不是云函数文件夹

**解决**：
1. 右键 cloudfunctions → 当前环境
2. 选择 cloud1-3gv7spppf7d2d0f4
3. 确认右键点击的是云函数文件夹

### Q2: 上传失败，提示网络错误？

**原因**：
- 网络连接问题
- VPN/代理干扰

**解决**：
1. 检查网络连接
2. 关闭VPN/代理
3. 重新上传

### Q3: 部署成功但调用失败？

**原因**：
- 云函数代码有错误
- 依赖未正确安装
- 权限配置问题

**解决**：
1. 查看云函数日志（云开发控制台 → 云函数 → 日志）
2. 检查错误信息
3. 重新上传（选择"云端安装依赖"）

### Q4: 如何查看云函数日志？

**步骤**：
1. 浏览器打开：https://console.cloud.tencent.com/tcb
2. 选择环境
3. 点击：云函数
4. 点击函数名称进入详情
5. 点击：日志 标签
6. 查看执行记录和错误信息

### Q5: 可以批量上传所有云函数吗？

**答**：
可以，但不推荐：
1. 右键 cloudfunctions 文件夹
2. 选择：上传并部署：所有文件
3. 等待全部上传完成

**不推荐的原因**：
- 一次上传21个云函数耗时很长
- 如果中途出错，不知道哪个失败了
- 建议分批上传，便于跟踪进度

---

## 📊 部署进度跟踪表

```
核心功能 (10个):
☑ stockManage      [████████████] 100% ✅
☑ drugManage       [████████████] 100% ✅
☑ inRecords        [████████████] 100% ✅
☑ outRecords       [████████████] 100% ✅
☑ getDrugList      [████████████] 100% ✅
☑ getStockList     [████████████] 100% ✅
☑ clinicRecords    [████████████] 100% ✅
☑ reportService    [████████████] 100% ✅
☑ queryService     [████████████] 100% ✅
☑ login            [████████████] 100% ✅

定时任务 (2个):
☑ dailySummary     [████████████] 100% ✅
☑ expiryMonitor    [████████████] 100% ✅

辅助功能 (9个):
☐ consumeRecords   [____________] 0%
☐ requisitionRecords [__________] 0%
☐ updateStock      [____________] 0%
☐ getUserList      [____________] 0%
☐ addUser          [____________] 0%
☐ updateUser       [____________] 0%
☐ deleteUser       [____________] 0%
☐ updateUserStatus [____________] 0%
☐ getMyOpenId      [____________] 0%

核心功能完成度: 12/12 (100%) ✅
总进度: 12/21 (57%)
```

---

## ⏱️ 时间统计

### 实际耗时

| 云函数 | 预计时间 | 实际时间 |
|--------|---------|---------|
| stockManage | 2分钟 | __分钟 |
| drugManage | 2分钟 | __分钟 |
| inRecords | 2分钟 | __分钟 |
| outRecords | 2分钟 | __分钟 |
| getDrugList | 2分钟 | __分钟 |
| getStockList | 2分钟 | __分钟 |
| clinicRecords | 2分钟 | __分钟 |
| reportService | 2分钟 | __分钟 |
| queryService | 2分钟 | __分钟 |
| login | 2分钟 | __分钟 |
| dailySummary | 2分钟 | __分钟 |
| expiryMonitor | 2分钟 | __分钟 |
| **总计** | **24分钟** | **__分钟** |

---

## ✅ 完成检查清单

- [ ] stockManage 已部署 ⭐⭐⭐
- [ ] drugManage 已部署
- [ ] inRecords 已部署
- [ ] outRecords 已部署
- [ ] getDrugList 已部署
- [ ] getStockList 已部署
- [ ] clinicRecords 已部署
- [ ] reportService 已部署
- [ ] queryService 已部署
- [ ] login 已部署
- [ ] dailySummary 已部署
- [ ] expiryMonitor 已部署
- [ ] 首页无"$ is not defined"错误
- [ ] 药品选择器可用
- [ ] 门诊登记功能正常
- [ ] 报表查询功能正常

---

## 🎉 部署完成！

### ✅ 已完成
- 12个核心云函数已全部部署
- 首页错误已修复
- 主要功能可以使用

### 📊 部署统计
```
核心云函数: 12/12 (100%) ✅
定时任务配置: 待配置
辅助云函数: 可选部署
状态: 核心功能可用 ✅
```

### 🎯 下一步
1. 配置定时触发器（参考：📖【超详细】配置定时触发器完整步骤.md）
2. 创建数据库集合（参考：📖【超详细】创建数据库集合完整步骤.md）
3. 测试所有功能
4. 导入测试数据

---

**部署日期**: ___________  
**部署人员**: ___________  
**完成时间**: ___________  
**核心功能**: ✅ 可用

**备注**:
_______________________________________
_______________________________________

