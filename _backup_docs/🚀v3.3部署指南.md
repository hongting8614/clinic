# 🚀 AK-PMS v3.3 部署指南

## 📋 目录
- [版本更新说明](#版本更新说明)
- [云函数部署](#云函数部署)
- [数据库配置](#数据库配置)
- [定时任务配置](#定时任务配置)
- [前端配置](#前端配置)
- [测试验证](#测试验证)
- [常见问题](#常见问题)

---

## 📝 版本更新说明

### v3.2 核心功能
- ✅ **门诊用药登记** - 支持分园区快速登记
- ✅ **智能批次管理** - FIFO自动选择最早批次
- ✅ **单位自动换算** - 最小单位↔包装单位智能换算

### v3.3 新增功能
- ✅ **5大核心报表** - 入库、出库、门诊、库存预警、盘点
- ✅ **6项查询功能** - 全方位数据查询
- ✅ **效期预警系统** - 60天临期标准自动预警
- ✅ **每日统计任务** - 自动汇总当日数据
- ✅ **规格字段支持** - 所有报表显示药品规格

---

## ☁️ 云函数部署

### 1. 新增云函数（5个）

#### 1.1 clinicRecords（门诊登记）
```bash
# 目录结构
cloudfunctions/
  └── clinicRecords/
      ├── index.js
      └── package.json

# 部署命令（微信开发者工具）
右键 clinicRecords 文件夹 → 上传并部署：云端安装依赖
```

**功能说明：**
- ✅ 添加门诊用药记录（支持分园区）
- ✅ 查询门诊记录列表（支持多条件筛选）
- ✅ 获取今日登记数量
- ✅ 统计分析（按日期/药品/园区）
- ✅ FIFO批次自动选择

**测试调用：**
```javascript
wx.cloud.callFunction({
  name: 'clinicRecords',
  data: {
    action: 'add',
    data: {
      drugId: 'DR001',
      location: 'land_park',
      quantityMin: 10,
      patient: '张三',
      minUnit: '片',
      packUnit: '盒',
      conversionRate: 12
    }
  }
}).then(res => {
  console.log('门诊登记成功', res);
});
```

#### 1.2 reportService（报表服务）
```bash
cloudfunctions/
  └── reportService/
      ├── index.js
      └── package.json

# 部署命令
右键 reportService 文件夹 → 上传并部署：云端安装依赖
```

**支持的报表类型：**
| 报表代码 | 报表名称 | 说明 |
|---------|---------|------|
| R1_inbound | 入库明细报表 | 包含规格、有效期、距有效期天数 |
| R2_outbound | 出库与请领汇总 | 按园区统计，支持饼图 |
| R3_clinic | 门诊用药统计 | 分园区统计，支持趋势图 |
| R4_stock | 库存预警报表 | 60天临期标准，三色预警 |
| R5_check | 盘点差异分析 | 盘盈盘亏统计 |

**测试调用：**
```javascript
wx.cloud.callFunction({
  name: 'reportService',
  data: {
    reportType: 'R4_stock',
    params: {
      location: 'land_park',
      expiryWarning: true  // 只显示临期/过期
    }
  }
}).then(res => {
  console.log('库存预警报表', res.result.data);
});
```

#### 1.3 queryService（查询服务）
```bash
cloudfunctions/
  └── queryService/
      ├── index.js
      └── package.json
```

**支持的查询类型：**
| 查询代码 | 查询名称 | 说明 |
|---------|---------|------|
| Q1_drug | 药品综合查询 | 药品信息+库存分布 |
| Q2_stock | 实时库存查询 | 支持有效期预警筛选 |
| Q3_clinic | 门诊用药查询 | 多维度筛选 |
| Q4_inbound | 入库记录查询 | 含距有效期天数 |
| Q5_outbound | 出库记录查询 | 含距有效期天数 |
| Q6_check | 盘点历史查询 | 含距有效期天数 |

#### 1.4 dailySummary（每日统计）⏰
```bash
cloudfunctions/
  └── dailySummary/
      ├── index.js
      └── package.json

# ⚠️ 需要配置定时触发器
```

**触发器配置：**
- 触发方式：定时触发器
- Cron表达式：`59 23 * * *`（每天23:59执行）
- 触发时区：Asia/Shanghai
- 云函数重试次数：3

**统计内容：**
- ✅ 入库统计（数量、金额）
- ✅ 出库统计（数量）
- ✅ 门诊统计（数量、患者数）
- ✅ 消耗统计（数量）
- ✅ 库存状态（总值、低库存、临期预警）

#### 1.5 expiryMonitor（效期预警）⏰
```bash
cloudfunctions/
  └── expiryMonitor/
      ├── index.js
      └── package.json

# ⚠️ 需要配置定时触发器
```

**触发器配置：**
- 触发方式：定时触发器
- Cron表达式：`10 0 * * *`（每天00:10执行）
- 触发时区：Asia/Shanghai
- 云函数重试次数：3

**功能说明：**
- ✅ 计算所有批次距有效期天数
- ✅ 更新库存表的 `daysToExpiry` 和 `expiryStatus` 字段
- ✅ 生成预警记录到 `alerts` 表
- ✅ 推送微信订阅消息（需配置模板ID）
- ✅ **60天临期标准** - 符合GSP规范

**预警规则：**
```javascript
if (daysToExpiry <= 0) {
  status = '过期';      // 红色预警 🔴
} else if (daysToExpiry <= 60) {
  status = '临期';      // 橙色预警 🟠
} else {
  status = '正常';      // 绿色 🟢
}
```

---

## 🗄️ 数据库配置

### 1. 新增数据集合

#### 1.1 clinic_usage（门诊用药记录）
```javascript
// 在云开发控制台 → 数据库 → 创建集合
集合名称: clinic_usage

// 索引配置
db.clinic_usage.createIndex({ location: 1, createTime: -1 });
db.clinic_usage.createIndex({ drugId: 1, createTime: -1 });
db.clinic_usage.createIndex({ patient: 1 });
```

**字段结构：**
```json
{
  "_id": "CU20251101001",
  "drugId": "DR001",
  "drugName": "阿莫西林胶囊",
  "specification": "0.5g*12粒/盒",
  "batchId": "BATCH001",
  "batch": "20250101",
  "location": "land_park",        // 园区：land_park | water_park | clinic_storage
  "quantityMin": 12,              // 最小单位数量（片）
  "quantityPack": 1,              // 包装单位数量（盒）
  "minUnit": "片",
  "packUnit": "盒",
  "patient": "张三",
  "symptom": "感冒发烧",
  "operatorId": "openid_xxx",
  "createTime": "2025-11-01T14:35:42Z"
}
```

#### 1.2 statistics（统计数据）
```javascript
集合名称: statistics

// 索引配置
db.statistics.createIndex({ date: 1, location: 1 });
db.statistics.createIndex({ month: 1, location: 1 });
```

**字段结构：**
```json
{
  "_id": "STAT20251101_land_park",
  "date": "2025-11-01",
  "location": "land_park",
  "type": "daily",
  "inbound": {
    "count": 5,
    "totalQuantity": 200,
    "totalAmount": 15000
  },
  "outbound": {
    "count": 3,
    "totalQuantity": 50
  },
  "clinic": {
    "count": 28,
    "totalQuantity": 156,
    "patientCount": 15
  },
  "stock": {
    "totalValue": 85000,
    "drugCount": 125,
    "lowStockCount": 8,
    "expiryWarningCount": 12
  },
  "createTime": "2025-11-01T23:59:30Z"
}
```

#### 1.3 alerts（预警记录）
```javascript
集合名称: alerts

// 索引配置
db.alerts.createIndex({ type: 1, createTime: -1 });
db.alerts.createIndex({ drugId: 1, location: 1 });
db.alerts.createIndex({ isRead: 1 });
```

**字段结构：**
```json
{
  "_id": "ALERT20251101001",
  "type": "expiry",              // expiry | low_stock
  "level": "warning",            // critical | warning | info
  "drugId": "DR001",
  "drugName": "阿莫西林胶囊",
  "specification": "0.5g*12粒/盒",
  "batch": "20250101",
  "location": "land_park",
  "expiryDate": "2025-12-31",
  "daysToExpiry": 55,
  "status": "临期",
  "message": "【临期预警】阿莫西林胶囊 (0.5g*12粒/盒) 批次20250101，距有效期 55 天",
  "createTime": "2025-11-01T00:10:15Z",
  "isRead": false
}
```

### 2. 更新现有集合字段

#### 2.1 stock（库存表）- 添加新字段
```javascript
// 需要为每条库存记录添加以下字段
db.stock.update({
  data: {
    specification: "0.5g*12粒/盒",     // 药品规格（必填）
    daysToExpiry: 55,                  // 距有效期天数（由定时任务自动更新）
    expiryStatus: "临期"               // 有效期状态：正常|临期|过期
  }
});
```

**迁移脚本：**
```javascript
// 在云开发控制台 → 数据库 → stock 集合 → 执行以下脚本
const db = cloud.database();
const _ = db.command;

// 1. 为所有库存记录添加 specification 字段
const stocks = await db.collection('stock').get();
for (const stock of stocks.data) {
  const drug = await db.collection('drugs').doc(stock.drugId).get();
  if (drug.data) {
    await db.collection('stock').doc(stock._id).update({
      data: {
        specification: drug.data.specification || '未知规格',
        daysToExpiry: 0,
        expiryStatus: '正常'
      }
    });
  }
}

// 2. 执行一次效期预警云函数，更新所有 daysToExpiry 和 expiryStatus
wx.cloud.callFunction({
  name: 'expiryMonitor'
});
```

---

## ⏰ 定时任务配置

### 配置步骤

1. **打开微信开发者工具**
2. **进入云开发控制台** → 云函数
3. **找到目标云函数** → 点击"定时触发器"标签

#### dailySummary 配置
```
触发器名称: dailySummary_trigger
触发周期: 自定义 Cron 表达式
Cron 表达式: 59 23 * * *
时区: Asia/Shanghai (中国标准时间)
描述: 每天23:59执行，汇总当日数据
```

#### expiryMonitor 配置
```
触发器名称: expiryMonitor_trigger
触发周期: 自定义 Cron 表达式
Cron 表达式: 10 0 * * *
时区: Asia/Shanghai (中国标准时间)
描述: 每天00:10执行，检查效期并发送预警
```

### Cron 表达式说明
```
格式: 分 时 日 月 周
示例:
- 59 23 * * *  → 每天23:59执行
- 10 0 * * *   → 每天00:10执行
- 0 */6 * * *  → 每6小时执行一次
- 0 9 * * 1    → 每周一09:00执行
```

---

## 💻 前端配置

### 1. 新增页面

#### 已创建的页面：
- ✅ `pages-sub/clinic/add.vue` - 门诊用药登记
- ✅ `pages-sub/clinic/list.vue` - 门诊记录列表
- ✅ `pages/index/index.vue` - 首页（已添加快捷入口）

#### pages.json 配置：
```json
{
  "root": "pages-sub/clinic",
  "pages": [
    {
      "path": "add",
      "style": {
        "navigationBarTitleText": "门诊用药登记",
        "enablePullDownRefresh": false
      }
    },
    {
      "path": "list",
      "style": {
        "navigationBarTitleText": "门诊用药记录",
        "enablePullDownRefresh": true
      }
    }
  ]
}
```

### 2. 首页快捷入口

已在首页添加两个新入口：

#### 门诊用药（绿色）
- 图标：听诊器
- 功能：快速跳转到门诊登记
- 路径：`/pages-sub/clinic/add`

#### 报表查询（紫色）
- 图标：数据图表
- 功能：跳转到报表中心
- 路径：`/pages-sub/report/index`

---

## ✅ 测试验证

### 1. 云函数测试

#### 测试 clinicRecords
```javascript
// 测试添加门诊记录
wx.cloud.callFunction({
  name: 'clinicRecords',
  data: {
    action: 'add',
    data: {
      drugId: 'DR001',
      drugName: '阿莫西林胶囊',
      specification: '0.5g*12粒/盒',
      location: 'land_park',
      quantityMin: 12,
      minUnit: '片',
      packUnit: '盒',
      conversionRate: 12,
      patient: '测试患者',
      symptom: '测试症状'
    }
  }
}).then(res => {
  console.log('✅ 门诊登记测试', res.result);
});
```

#### 测试 reportService
```javascript
// 测试库存预警报表
wx.cloud.callFunction({
  name: 'reportService',
  data: {
    reportType: 'R4_stock',
    params: {
      location: 'all',
      expiryWarning: true
    }
  }
}).then(res => {
  console.log('✅ 报表服务测试', res.result);
});
```

#### 测试定时任务
```javascript
// 手动触发每日统计
wx.cloud.callFunction({
  name: 'dailySummary'
}).then(res => {
  console.log('✅ 每日统计测试', res.result);
});

// 手动触发效期预警
wx.cloud.callFunction({
  name: 'expiryMonitor'
}).then(res => {
  console.log('✅ 效期预警测试', res.result);
});
```

### 2. 前端页面测试

#### 测试清单
- [ ] 首页显示新增的两个快捷入口
- [ ] 点击"门诊用药"跳转到登记页面
- [ ] 门诊登记页面可以：
  - [ ] 选择园区（陆园/水园/医务室）
  - [ ] 扫码或手动选择药品
  - [ ] 显示该园区该药品的可用库存
  - [ ] 输入用量自动换算单位
  - [ ] 输入患者信息
  - [ ] 保存后自动扣减库存
- [ ] 门诊记录列表可以：
  - [ ] 按园区筛选
  - [ ] 按日期筛选
  - [ ] 搜索药品/患者
  - [ ] 显示今日统计数据

### 3. 数据库验证

```javascript
// 验证 clinic_usage 集合
const clinicCount = await db.collection('clinic_usage').count();
console.log('门诊记录数：', clinicCount.total);

// 验证 statistics 集合
const statsCount = await db.collection('statistics').count();
console.log('统计记录数：', statsCount.total);

// 验证 alerts 集合
const alertsCount = await db.collection('alerts')
  .where({ isRead: false })
  .count();
console.log('未读预警数：', alertsCount.total);
```

---

## ❓ 常见问题

### Q1: 定时任务没有执行？
**A:** 检查以下项：
1. 触发器是否正确配置
2. Cron表达式是否正确
3. 时区是否设置为 Asia/Shanghai
4. 云函数是否部署成功
5. 查看云函数日志确认执行情况

### Q2: 门诊登记时提示"库存不足"？
**A:** 可能原因：
1. 该园区该药品确实库存不足
2. 批次未添加 location 字段
3. 需要先执行数据迁移脚本

### Q3: 效期预警不准确？
**A:** 请确认：
1. stock 表中 expiryDate 字段格式正确（ISO 8601）
2. 已执行过一次 expiryMonitor 云函数
3. daysToExpiry 和 expiryStatus 字段已更新

### Q4: 如何修改临期天数标准？
**A:** 修改 `expiryMonitor/index.js`：
```javascript
// 当前标准：60天
if (daysToExpiry <= 60) {
  status = '临期';
}

// 修改为90天
if (daysToExpiry <= 90) {
  status = '临期';
}
```

### Q5: 如何添加微信订阅消息？
**A:** 步骤：
1. 在微信公众平台申请订阅消息模板
2. 获取模板ID
3. 修改 `expiryMonitor/index.js` 中的 `TEMPLATE_ID_FOR_EXPIRY_WARNING`
4. 用户需要在小程序中订阅消息

---

## 📞 技术支持

如有问题，请参考以下文档：
- 📖 [功能与管理文档](./AK-PMS_v3.3_功能与管理文档.md)
- 🔧 [技术栈与实现说明](./AK-PMS_v3.3_技术栈与实现说明.md)
- 📚 [开发技术栈总结](./AK-PMS_开发技术栈总结.md)
- 📋 [需求与功能总结](./333需求与功能总结.md)

---

## 🎯 部署检查清单

### 云函数部署（5个）
- [ ] clinicRecords - 上传并部署成功
- [ ] reportService - 上传并部署成功
- [ ] queryService - 上传并部署成功
- [ ] dailySummary - 上传并部署 + 配置定时触发器
- [ ] expiryMonitor - 上传并部署 + 配置定时触发器

### 数据库配置（3个集合）
- [ ] clinic_usage - 创建集合 + 配置索引
- [ ] statistics - 创建集合 + 配置索引
- [ ] alerts - 创建集合 + 配置索引
- [ ] stock - 添加新字段（specification, daysToExpiry, expiryStatus）

### 前端部署
- [ ] pages-sub/clinic 目录创建
- [ ] clinic/add.vue 上传
- [ ] clinic/list.vue 上传
- [ ] pages.json 更新
- [ ] pages/index/index.vue 更新（首页快捷入口）

### 测试验证
- [ ] 门诊登记功能测试
- [ ] 报表查询功能测试
- [ ] 定时任务手动触发测试
- [ ] 效期预警功能测试

---

**部署完成后，AK-PMS v3.3 即可投入使用！** 🎉



