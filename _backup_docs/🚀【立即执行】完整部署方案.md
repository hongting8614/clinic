# 🚀 AK-PMS 完整部署方案

**部署时间**: 约30分钟  
**当前状态**: 代码就绪，等待部署  
**目标**: 将所有功能部署到微信云开发环境

---

## 📋 部署前检查清单

### ✅ 环境准备
- [ ] 已安装微信开发者工具
- [ ] 已登录微信开发者账号
- [ ] 项目已在微信开发者工具中打开
- [ ] 已开通云开发服务
- [ ] 云开发环境ID已配置

### ✅ 项目状态
- [x] 本地代码完整 (21个云函数)
- [x] 代码已修复 (stockManage 等)
- [x] 配置文件正确 (project.config.json)
- [ ] 云函数已上传
- [ ] 数据库已创建

---

## 🎯 第一步：批量上传云函数（20分钟）

### 核心云函数（必须部署）- 优先级 ⭐⭐⭐

#### 1. 库存管理相关（最重要）
```
□ stockManage          ← 🚨 当前报错，必须先部署
□ getStockList
□ updateStock
```

**操作步骤**:
```
1. 打开微信开发者工具
2. 点击顶部菜单：云开发
3. 左侧文件树找到：cloudfunctions/stockManage
4. 右键点击 stockManage 文件夹
5. 选择：上传并部署：云端安装依赖 ⚠️ 注意选对选项
6. 等待上传完成（约1-2分钟）
7. 看到"部署成功"提示
```

#### 2. 药品管理
```
□ drugManage
□ getDrugList
```

#### 3. 入库管理
```
□ inRecords
```

#### 4. 出库管理
```
□ outRecords
```

#### 5. 门诊管理（v3.2新增）
```
□ clinicRecords
```

#### 6. 报表系统（v3.3新增）
```
□ reportService
□ queryService
```

---

### 辅助云函数（建议部署）- 优先级 ⭐⭐

#### 7. 消耗与请领
```
□ consumeRecords
□ requisitionRecords
```

#### 8. 用户管理
```
□ login
□ getUserList
□ addUser
□ updateUser
□ deleteUser
□ updateUserStatus
□ getMyOpenId
```

---

### 定时任务云函数（重要）- 优先级 ⭐⭐⭐

#### 9. 自动化任务
```
□ dailySummary      ← 每日统计（23:59执行）
□ expiryMonitor     ← 效期预警（00:10执行）
```

**部署后需要配置触发器**（见第三步）

---

## 📊 云函数部署清单（完整版）

| 序号 | 云函数名称 | 功能说明 | 版本 | 优先级 | 状态 |
|------|-----------|---------|------|--------|------|
| 1 | **stockManage** | 库存管理（聚合查询） | v3.1 | ⭐⭐⭐ | ⚠️ 必须 |
| 2 | getStockList | 库存列表查询 | v3.1 | ⭐⭐⭐ | □ 待部署 |
| 3 | updateStock | 库存更新 | v3.1 | ⭐⭐⭐ | □ 待部署 |
| 4 | drugManage | 药品档案管理 | v3.1 | ⭐⭐⭐ | □ 待部署 |
| 5 | getDrugList | 药品列表查询 | v3.1 | ⭐⭐⭐ | □ 待部署 |
| 6 | inRecords | 入库记录管理 | v3.1 | ⭐⭐⭐ | □ 待部署 |
| 7 | outRecords | 出库记录管理 | v3.1 | ⭐⭐⭐ | □ 待部署 |
| 8 | clinicRecords | 门诊用药登记 | v3.2 | ⭐⭐⭐ | □ 待部署 |
| 9 | reportService | 报表服务 | v3.3 | ⭐⭐⭐ | □ 待部署 |
| 10 | queryService | 查询服务 | v3.3 | ⭐⭐⭐ | □ 待部署 |
| 11 | dailySummary | 每日统计任务 | v3.3 | ⭐⭐⭐ | □ 待部署 |
| 12 | expiryMonitor | 效期预警任务 | v3.3 | ⭐⭐⭐ | □ 待部署 |
| 13 | consumeRecords | 消耗记录管理 | v3.1 | ⭐⭐ | □ 待部署 |
| 14 | requisitionRecords | 请领记录管理 | v3.1 | ⭐⭐ | □ 待部署 |
| 15 | login | 用户登录 | v3.1 | ⭐⭐ | □ 待部署 |
| 16 | getUserList | 用户列表 | v3.1 | ⭐⭐ | □ 待部署 |
| 17 | addUser | 添加用户 | v3.1 | ⭐⭐ | □ 待部署 |
| 18 | updateUser | 更新用户 | v3.1 | ⭐⭐ | □ 待部署 |
| 19 | deleteUser | 删除用户 | v3.1 | ⭐⭐ | □ 待部署 |
| 20 | updateUserStatus | 更新用户状态 | v3.1 | ⭐⭐ | □ 待部署 |
| 21 | getMyOpenId | 获取OpenID | v3.1 | ⭐⭐ | □ 待部署 |

---

## 🗄️ 第二步：创建数据库集合（5分钟）

### 必需的数据库集合

```
1. 打开微信开发者工具
2. 点击：云开发 → 数据库
3. 依次创建以下集合
```

#### 核心集合（必须创建）

| 序号 | 集合名称 | 说明 | 权限设置 | 状态 |
|------|---------|------|---------|------|
| 1 | drugs | 药品档案 | 所有用户可读写 | □ |
| 2 | stock | 库存信息 | 所有用户可读写 | □ |
| 3 | in_records | 入库记录 | 所有用户可读写 | □ |
| 4 | out_records | 出库记录 | 所有用户可读写 | □ |
| 5 | clinic_usage | 门诊用药记录 (v3.2) | 所有用户可读写 | □ |
| 6 | consume_records | 消耗记录 | 所有用户可读写 | □ |
| 7 | requisition_records | 请领记录 | 所有用户可读写 | □ |
| 8 | users | 用户信息 | 所有用户可读写 | □ |
| 9 | statistics | 统计数据 (v3.3) | 所有用户可读写 | □ |
| 10 | alerts | 预警记录 (v3.3) | 所有用户可读写 | □ |
| 11 | operation_logs | 操作日志 | 所有用户可读写 | □ |
| 12 | stock_check | 盘点记录 | 所有用户可读写 | □ |

#### 创建步骤（每个集合）
```
1. 点击"添加集合"按钮
2. 输入集合名称（如：drugs）
3. 点击"确定"
4. 点击新建的集合
5. 点击"权限设置"标签
6. 选择"所有用户可读写"（开发阶段）
7. 点击"保存"
```

⚠️ **注意**: 生产环境需要修改为更严格的权限设置

---

## ⏰ 第三步：配置定时触发器（3分钟）

### 需要配置的定时任务

#### 1. dailySummary - 每日统计
```
功能: 每天23:59统计当日数据
触发器配置:
  - 名称: dailySummary
  - 触发周期: 自定义
  - Cron表达式: 0 59 23 * * * *
  - 说明: 每天23:59执行
```

#### 2. expiryMonitor - 效期预警
```
功能: 每天00:10扫描临期药品
触发器配置:
  - 名称: expiryMonitor
  - 触发周期: 自定义
  - Cron表达式: 0 10 0 * * * *
  - 说明: 每天00:10执行
```

#### 配置步骤
```
1. 云开发控制台 → 云函数
2. 找到 dailySummary 云函数
3. 点击"触发器"标签
4. 点击"添加触发器"
5. 填写配置信息
6. 点击"确定"
7. 重复以上步骤配置 expiryMonitor
```

---

## 🧪 第四步：编译并测试（5分钟）

### 4.1 编译项目

#### 方法1: 微信开发者工具
```
1. 点击顶部工具栏：编译
2. 等待编译完成
3. 查看控制台是否有错误
```

#### 方法2: 清除缓存重新编译
```
1. 点击：工具 → 清除缓存
2. 选择：清除全部缓存
3. 点击：编译
```

### 4.2 快速功能测试

#### 测试1: 首页数据加载（验证 stockManage）
```
✅ 操作:
1. 进入首页
2. 查看"今日数据"区域

✅ 预期结果:
- 入库单数量显示正常
- 出库单数量显示正常
- 药品种类显示正常
- 库存预警显示正常
- 控制台无 "$ is not defined" 错误

❌ 如果失败:
- 检查 stockManage 是否部署成功
- 查看云函数日志
```

#### 测试2: 药品选择器
```
✅ 操作:
1. 点击首页"药品入库"
2. 点击"添加药品"
3. 搜索"阿莫"

✅ 预期结果:
- 显示药品列表
- 可以选择药品

❌ 如果失败:
- 检查 drugManage 是否部署
- 检查 drugs 集合是否有数据
```

#### 测试3: 门诊用药登记
```
✅ 操作:
1. 点击首页"门诊用药"
2. 选择园区（陆园/水园/医务室）
3. 添加药品
4. 输入用量

✅ 预期结果:
- 园区选择正常
- 药品选择正常
- 单位换算正常
- 保存成功

❌ 如果失败:
- 检查 clinicRecords 是否部署
- 检查 clinic_usage 集合是否创建
```

#### 测试4: 报表查询
```
✅ 操作:
1. 点击首页"报表中心"
2. 选择任意报表
3. 点击"查询"

✅ 预期结果:
- 报表数据显示
- 图表渲染正常
- 可以导出Excel

❌ 如果失败:
- 检查 reportService 是否部署
- 检查 queryService 是否部署
```

---

## 📝 部署进度跟踪表

### 云函数部署进度

```
核心功能（12个）:
□ stockManage          [___________] 0%
□ getStockList         [___________] 0%
□ updateStock          [___________] 0%
□ drugManage           [___________] 0%
□ getDrugList          [___________] 0%
□ inRecords            [___________] 0%
□ outRecords           [___________] 0%
□ clinicRecords        [___________] 0%
□ reportService        [___________] 0%
□ queryService         [___________] 0%
□ dailySummary         [___________] 0%
□ expiryMonitor        [___________] 0%

辅助功能（9个）:
□ consumeRecords       [___________] 0%
□ requisitionRecords   [___________] 0%
□ login                [___________] 0%
□ getUserList          [___________] 0%
□ addUser              [___________] 0%
□ updateUser           [___________] 0%
□ deleteUser           [___________] 0%
□ updateUserStatus     [___________] 0%
□ getMyOpenId          [___________] 0%

总进度: 0/21 (0%)
```

### 数据库创建进度

```
□ drugs                [___________] 0%
□ stock                [___________] 0%
□ in_records           [___________] 0%
□ out_records          [___________] 0%
□ clinic_usage         [___________] 0%
□ consume_records      [___________] 0%
□ requisition_records  [___________] 0%
□ users                [___________] 0%
□ statistics           [___________] 0%
□ alerts               [___________] 0%
□ operation_logs       [___________] 0%
□ stock_check          [___________] 0%

总进度: 0/12 (0%)
```

### 定时任务配置进度

```
□ dailySummary 触发器  [___________] 0%
□ expiryMonitor 触发器 [___________] 0%

总进度: 0/2 (0%)
```

---

## ⚠️ 常见问题与解决方案

### 问题1: 右键没有"上传并部署"选项

**原因**: 
- 未打开云开发
- 未登录
- 不是云函数目录

**解决**:
```
1. 确认已点击顶部"云开发"按钮
2. 确认已登录微信开发者账号
3. 确认右键点击的是云函数文件夹（如 stockManage）
4. 不是点击 cloudfunctions 根目录
5. 不是点击 index.js 文件
```

### 问题2: 上传失败，提示"网络错误"

**解决**:
```
1. 检查网络连接
2. 关闭VPN/代理
3. 重启微信开发者工具
4. 重新登录
5. 重试上传
```

### 问题3: 部署成功但调用失败

**解决**:
```
1. 检查云函数日志（云开发控制台 → 云函数 → 日志）
2. 查看具体错误信息
3. 检查依赖是否安装成功
4. 重新上传云函数（选择"云端安装依赖"）
```

### 问题4: 首页还是报错 "$ is not defined"

**解决**:
```
1. 确认 stockManage 部署成功（云开发控制台查看）
2. 点击"编译"重新编译小程序
3. 清除缓存：工具 → 清除缓存 → 全部清除
4. 重新编译
5. 等待1-2分钟（云函数生效需要时间）
```

### 问题5: 数据库集合创建失败

**解决**:
```
1. 检查云开发环境是否开通
2. 检查环境配额是否已满
3. 刷新页面重试
4. 联系微信云开发技术支持
```

---

## 🎯 部署后验证清单

### ✅ 云函数验证
```
1. 打开：云开发控制台 → 云函数
2. 检查所有云函数状态为"部署成功"
3. 查看云函数日志，确认无错误
```

### ✅ 数据库验证
```
1. 打开：云开发控制台 → 数据库
2. 确认所有集合已创建
3. 检查权限设置正确
```

### ✅ 定时任务验证
```
1. 打开：云开发控制台 → 云函数 → dailySummary → 触发器
2. 确认触发器已配置
3. 可以手动触发测试
```

### ✅ 功能验证
```
□ 首页数据正常显示
□ 药品选择器可用
□ 入库功能正常
□ 出库功能正常
□ 门诊登记功能正常
□ 报表查询功能正常
□ 图表显示正常
□ Excel导出正常
```

---

## 📞 获取帮助

### 查看日志
```
云开发控制台 → 云函数 → 选择云函数 → 日志
可以看到详细的错误信息
```

### 相关文档
- [🚨必看-部署云函数3步.txt](./🚨必看-部署云函数3步.txt) - 简化版指南
- [⚡立即部署-3步完成.md](./⚡立即部署-3步完成.md) - 快速部署
- [🚀v3.3部署指南.md](./🚀v3.3部署指南.md) - 详细部署说明
- [📊项目状态总览.md](./📊项目状态总览.md) - 项目概况

---

## 🎊 部署完成后

### 立即可用的功能
- ✅ 药品档案管理
- ✅ 入库管理（扫码+手动）
- ✅ 出库管理（园区领用+FIFO批次）
- ✅ 门诊用药登记（分园区+单位换算）
- ✅ 库存查询（实时+预警）
- ✅ 报表中心（5大报表+6项查询）
- ✅ 数据可视化（3种图表）
- ✅ Excel导出
- ✅ 每日统计（自动）
- ✅ 效期预警（自动）

### 下一步工作
1. 📊 导入测试数据
2. 👥 添加用户账号
3. 🧪 全面功能测试
4. 📚 用户培训
5. 🚀 正式上线

---

**预计总耗时**: 30-40分钟  
**难度等级**: ⭐⭐⭐☆☆（中等）  
**成功率**: 95%+

**🎉 现在就开始部署吧！30分钟后系统就能完整运行了！🎉**

---

**部署日期**: ___________  
**部署人员**: ___________  
**完成时间**: ___________  
**验证结果**: □ 成功  □ 部分成功  □ 失败

