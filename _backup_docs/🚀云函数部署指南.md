# 🚀 云函数部署指南

## ✅ 问题已修复

已修复 `stockManage` 云函数中的 `$ is not defined` 错误。

**修复内容**：
- ✅ 在 `getList` 函数中添加了 `const $ = db.command.aggregate`
- ✅ 重写了 `getLowStockList` 函数，添加了降级方案

---

## 📋 需要部署的云函数

项目包含 16 个云函数，需要全部部署到云开发环境：

```
cloudfunctions/
├── addUser/              # 添加用户
├── clinicRecords/        # 门诊记录
├── consumeRecords/       # 消耗记录
├── dailySummary/         # 日统计
├── deleteUser/           # 删除用户
├── drugManage/           # 药品管理
├── expiryMonitor/        # 效期监控
├── getDrugList/          # 获取药品列表
├── getMyOpenId/          # 获取OpenID
├── getStockList/         # 获取库存列表
├── getUserList/          # 获取用户列表
├── inRecords/            # 入库记录
├── login/                # 登录
├── outRecords/           # 出库记录
├── queryService/         # 查询服务
├── reportService/        # 报表服务
├── requisitionRecords/   # 请领记录
├── stockManage/          # 库存管理 ⭐ 已修复
├── updateStock/          # 更新库存
├── updateUser/           # 更新用户
└── updateUserStatus/     # 更新用户状态
```

---

## 🎯 部署方法

### 方法一：使用微信开发者工具（推荐）⭐

#### 步骤：

1. **打开云开发控制台**
   ```
   微信开发者工具 → 顶部菜单 → 云开发
   ```

2. **进入云函数管理**
   ```
   云开发控制台 → 云函数 → 函数列表
   ```

3. **部署单个云函数（修复后的）**
   ```
   在左侧文件树中：
   右键点击 cloudfunctions/stockManage
   → 选择"上传并部署：云端安装依赖"
   → 等待部署完成（约1-2分钟）
   ```

4. **批量部署所有云函数**
   ```
   方式1：逐个右键部署
   - 右键每个云函数文件夹
   - 选择"上传并部署：云端安装依赖"
   
   方式2：使用命令行工具（见方法二）
   ```

---

### 方法二：使用 HBuilderX

如果您使用 HBuilderX 开发：

1. **打开项目**
   ```
   HBuilderX → 打开 AK-PMS 项目
   ```

2. **配置云函数**
   ```
   右键项目根目录 → 云服务空间初始化
   选择云服务空间：cloud1-3gv7spppf7d2d0f4
   ```

3. **上传云函数**
   ```
   右键 cloudfunctions 目录
   → 上传所有云函数并运行
   ```

---

### 方法三：使用命令行工具

如果您熟悉命令行：

1. **安装云开发 CLI**
   ```powershell
   npm install -g @cloudbase/cli
   ```

2. **登录**
   ```powershell
   tcb login
   ```

3. **部署云函数**
   ```powershell
   # 部署单个云函数
   tcb functions:deploy stockManage
   
   # 部署所有云函数
   cd cloudfunctions
   for /d %i in (*) do tcb functions:deploy %i
   ```

---

## ⚡ 快速修复当前问题

### 最快的方法：

1. **在微信开发者工具中**
   ```
   1. 点击顶部"云开发"按钮
   2. 左侧找到 cloudfunctions/stockManage
   3. 右键 → 上传并部署：云端安装依赖
   4. 等待部署完成
   5. 刷新小程序页面
   ```

2. **验证修复**
   ```
   刷新小程序首页
   查看控制台是否还有 "$ is not defined" 错误
   如果没有错误，说明修复成功！
   ```

---

## 📝 部署注意事项

### 1. 云函数依赖

每个云函数都需要安装依赖包：
```json
{
  "dependencies": {
    "wx-server-sdk": "latest"
  }
}
```

**部署时选择**：
- ✅ 推荐："上传并部署：云端安装依赖"
- ❌ 不推荐："上传并部署：不校验依赖"（可能导致运行错误）

### 2. 云开发环境

确保使用正确的环境ID：
```
环境ID: cloud1-3gv7spppf7d2d0f4
```

### 3. 部署时间

- 单个云函数：约 1-2 分钟
- 所有云函数：约 20-30 分钟

### 4. 部署顺序

建议按以下顺序部署：

**优先级1（核心功能）**：
1. `login` - 登录
2. `getMyOpenId` - 获取用户ID
3. `getUserList` - 用户列表

**优先级2（基础数据）**：
4. `drugManage` - 药品管理
5. `stockManage` - 库存管理 ⭐
6. `getDrugList` - 药品列表
7. `getStockList` - 库存列表

**优先级3（业务功能）**：
8. `inRecords` - 入库
9. `outRecords` - 出库
10. `consumeRecords` - 消耗
11. `clinicRecords` - 门诊
12. 其他...

---

## 🔍 部署后验证

### 1. 检查部署状态

在云开发控制台：
```
云函数 → 函数列表
查看每个函数的状态是否为"部署成功"
```

### 2. 测试云函数

在微信开发者工具控制台：
```javascript
// 测试 stockManage 云函数
wx.cloud.callFunction({
  name: 'stockManage',
  data: {
    action: 'getLowStockList',
    data: {}
  }
}).then(res => {
  console.log('测试成功:', res)
}).catch(err => {
  console.error('测试失败:', err)
})
```

### 3. 查看日志

在云开发控制台：
```
云函数 → 函数列表 → 选择函数 → 日志
查看是否有错误信息
```

---

## ❓ 常见问题

### Q1: 部署失败怎么办？

**A**: 检查以下几点：
1. 网络连接是否正常
2. 云开发环境是否已开通
3. 是否有权限部署云函数
4. 云函数代码是否有语法错误

### Q2: 部署后还是报错？

**A**: 
1. 清除小程序缓存（工具 → 清除缓存）
2. 重新编译项目
3. 刷新页面
4. 查看云函数日志

### Q3: 如何查看云函数版本？

**A**: 
```
云开发控制台 → 云函数 → 函数列表
点击函数名 → 版本管理
```

### Q4: 可以回滚到之前的版本吗？

**A**: 
```
可以！在版本管理中选择历史版本
点击"切换版本"即可回滚
```

---

## 🎯 下一步操作

### 立即执行：

1. **部署修复的云函数**
   ```
   右键 cloudfunctions/stockManage
   → 上传并部署：云端安装依赖
   ```

2. **刷新小程序**
   ```
   点击"编译"按钮重新编译
   ```

3. **验证修复**
   ```
   查看首页是否正常加载
   检查控制台是否还有错误
   ```

### 后续操作：

4. **部署其他云函数**
   ```
   按优先级逐个部署其他云函数
   ```

5. **初始化数据**
   ```
   添加测试药品
   添加测试库存
   测试各项功能
   ```

---

## 📞 需要帮助？

如果部署过程中遇到问题，请提供：
1. 错误信息截图
2. 云函数日志
3. 部署步骤说明

我会帮您解决！

---

**AK-PMS v3.4**  
**文档更新**: 2025-11-02  
**云函数修复**: stockManage


