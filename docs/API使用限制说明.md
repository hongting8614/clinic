# API使用限制说明

## 📊 API调用次数限制

为防止产生意外费用，系统已设置API调用次数上限。

---

## 🔒 限制规则

### **极速数据API：**
- ✅ 免费额度：100次
- ⚠️ 系统限制：99次
- 🛡️ 保护措施：达到99次后自动停用

**为什么是99次而不是100次？**
- 保留1次余地，防止边界问题
- 确保不会触发付费

---

## 📋 使用情况查询

### **在小程序控制台运行：**

```javascript
// 查看当前使用情况
wx.cloud.database().collection('api_usage')
  .where({ apiName: 'jisu_barcode' })
  .get()
  .then(res => {
    if (res.data.length > 0) {
      const usage = res.data[0]
      console.log('========================================')
      console.log('📊 API使用情况')
      console.log('========================================')
      console.log('已使用:', usage.count, '次')
      console.log('限制:', usage.limit, '次')
      console.log('剩余:', (usage.limit - usage.count), '次')
      console.log('========================================')
    }
  })
```

---

## 🎯 使用管理工具

已提供完整的管理脚本：`scripts/api_usage_manager.js`

### **使用方法：**

1. 打开 `d:\AK-PMS\scripts\api_usage_manager.js`
2. 复制全部内容
3. 在小程序控制台粘贴运行
4. 使用提供的命令

### **可用命令：**

```javascript
// 1. 查看使用情况
checkAPIUsage()

// 2. 查看调用历史
viewAPIHistory()

// 3. 导出使用报告
exportUsageReport()

// 4. 重置使用次数（谨慎！）
resetAPIUsage()
```

---

## ⚠️ 达到限制后

### **系统行为：**

```
扫码 → 查询流程：
  1. 本地药材档案
  2. 缓存数据库
  3. 条形码映射表
  4. ❌ API已停用（已达99次）
  5. 提示用户手动输入
```

### **日志显示：**

```
🔍 [第4级] 极速数据API查询...
⚠️ [第4级] API调用次数已达上限（99次），已停用
   当前已调用: 99 次
   为防止产生费用，已自动停用API
```

---

## 🔄 重置使用次数

### **⚠️ 警告：**

重置使用次数后，API将重新开始计费！

### **重置方法：**

```javascript
// 方法1：使用管理工具
resetAPIUsage()  // 有确认提示

// 方法2：手动重置
const db = wx.cloud.database()
const res = await db.collection('api_usage')
  .where({ apiName: 'jisu_barcode' })
  .get()

if (res.data.length > 0) {
  await db.collection('api_usage')
    .doc(res.data[0]._id)
    .update({
      data: {
        count: 0,
        lastUpdate: db.serverDate()
      }
    })
  console.log('✅ 已重置')
}
```

---

## 💰 成本控制建议

### **1. 优先使用免费数据：**
- ✅ 预先导入常用药材
- ✅ 建立条形码映射表
- ✅ 利用NMPA免费数据

### **2. 合理使用API：**
- ✅ 仅在必要时使用
- ✅ 查到后会自动缓存
- ✅ 避免重复查询

### **3. 监控使用情况：**
- ✅ 定期查看剩余次数
- ✅ 达到80%时警告
- ✅ 接近上限及时调整

---

## 📊 使用率警告

### **阈值设置：**

| 使用次数 | 使用率 | 提示 |
|---------|--------|------|
| 0-49 | 0-49% | ✅ 正常使用 |
| 50-79 | 50-79% | 💡 注意使用量 |
| 80-98 | 80-98% | ⚠️ 警告：接近上限 |
| 99 | 99% | 🛑 已达上限，自动停用 |

---

## 🎯 最佳实践

### **1. 批量录入常用药材**
```
先导入 → 32种常用药材
     → 扫码时直接匹配
     → 不消耗API次数
```

### **2. 智能首次录入**
```
第一次扫新药材：
  → 从已有药材选择（不消耗API）
  → 或输入药材名称查NMPA（免费）
  → 实在查不到才用API
```

### **3. 数据积累**
```
每次成功查询 → 自动保存
             → 下次免费使用
             → 越用越省钱
```

---

## 🆘 常见问题

### **Q1：为什么限制99次而不是100次？**
A：保留安全余地，防止边界问题导致超额扣费。

### **Q2：达到99次后怎么办？**
A：系统自动停用API，不会产生额外费用。可以继续使用其他查询方式（本地、缓存、映射表、NMPA）。

### **Q3：如何重新获得API额度？**
A：需要在极速数据平台充值或购买新的套餐。

### **Q4：已经查过的药材会重复扣费吗？**
A：不会！查到后会自动缓存，下次直接从缓存获取。

### **Q5：可以提高限制到100次吗？**
A：不建议。保留1次余地更安全。

---

## 📞 技术支持

如需调整限制或有其他问题，请：
1. 查看 `cloudfunctions/drugBarcodeQuery/index.js`
2. 修改第141行的限制值
3. 重新部署云函数

**当前设置：**
```javascript
if (apiUsage.count >= 99) {  // 这里可以修改限制
  // 停用API
}
```

---

## ✅ 总结

### **保护措施已到位：**
✅ 自动统计调用次数  
✅ 达到99次自动停用  
✅ 防止意外产生费用  
✅ 提供完整管理工具  
✅ 实时显示剩余次数  

### **数据安全有保障：**
✅ 已查询数据会缓存  
✅ 映射表持久保存  
✅ 不会丢失已有数据  

---

**放心使用！系统已做好成本控制！** 🛡️
