# 🔒 API次数限制快速参考

## 📋 核心限制

```
每日总限制: < 99次
单用户限制: ≤ 20次/天
时段限制: ≤ 15次/小时
警告阈值: 80次（警告）、90次（严重警告）
```

---

## 🔄 查询流程

```
扫码/输入条形码
  ↓
📦 第1级：查询本地药材档案（免费）
  ↓ 未找到
📊 第2级：检查API剩余次数
  ↓ 次数充足
📡 第3级：调用第三方API（付费，<99次）
  ↓ 自动保存到本地档案
  ↓ 次数不足
💡 提示：手动新建药材档案
```

---

## ⚠️ 提示规则

### 正常（< 80次）
```
✅ 已添加
```

### 警告（80-89次）
```
⚠️ 已添加（剩余X次API）
```

### 严重警告（90-98次）
```
🚫 API次数不足
今日API次数仅剩 X 次
是否继续扫码？
[继续] [取消]
```

### 已达上限（≥ 99次）
```
🚫 API次数已用完
今日API调用次数已达上限 (99/99)

建议：
1. 手动新建药材档案
2. 等待明天重置

[确定]
```

---

## 📊 统计显示

### ~~页面顶部提示条~~（已取消）
```
不显示API统计提示条
保持界面简洁
```

**说明**：
- ❌ 不在页面顶部显示API统计
- ✅ 仅在扫码时根据情况提示
- ✅ 保持界面整洁

---

## 💾 数据保存策略

### API查询成功后
```
1. 返回药材信息
2. 自动保存到本地药材档案
3. 下次扫描直接从本地获取（免费）
```

**效果**：
- 第1次：消耗1次API
- 第2次及以后：免费（从本地查询）

---

## 🔄 每日重置

### 定时任务
```
时间：每天 00:00
操作：
  1. 归档昨日数据
  2. 重置统计计数
  3. 新的一天从0开始
```

---

## 📈 使用建议

### 1. 提前录入常用药材
```
建议提前录入100种常用药材到本地档案
→ 95%的扫码都能从本地查询（免费）
→ 每天API调用 < 5次
```

### 2. 批量录入
```
集中时间录入新药材
→ 避免分散使用API次数
→ 一次性建立完整药材档案
```

### 3. 优先手动新建
```
对于不常见的药材
→ 直接手动新建
→ 不消耗API次数
```

---

## 🎯 成本优化

### 优化前
```
每次扫码都调用API
→ 每天入库10个药材
→ 每天消耗10次API
→ 月度消耗300次（超限）
```

### 优化后
```
优先查询本地档案
→ 每天入库10个药材
→ 第1次：消耗10次API
→ 第2次及以后：0次API
→ 月度消耗10次（远低于限制）
```

**节省**：97% API调用次数

---

## 📱 用户操作指南

### 场景1：正常扫码
```
1. 点击扫码图标
2. 扫描药材条形码
3. 自动添加到入库列表
4. 填写批号/日期/数量
```

### 场景2：API次数不足
```
1. 点击扫码图标
2. 提示"API次数不足"
3. 选择"手动新建"
4. 填写药材信息
5. 保存到药材档案
6. 自动添加到入库列表
```

### 场景3：未找到药材
```
1. 扫码查询
2. 提示"未找到药材"
3. 选择"新建"
4. 填写药材信息（条形码已填充）
5. 保存到药材档案
6. 自动添加到入库列表
```

---

## 🔧 技术实现

### 云函数检查
```javascript
// 每次API调用前检查
const usageCheck = await checkAPIUsage(userId)

if (!usageCheck.allowed) {
  return {
    success: false,
    reason: 'api_limit_exceeded',
    message: usageCheck.message
  }
}
```

### 前端提示
```javascript
if (result.reason === 'api_limit_exceeded') {
  uni.showModal({
    title: '🚫 API次数不足',
    content: result.message,
    confirmText: '手动新建',
    success: (res) => {
      if (res.confirm) {
        this.showCreateDrugDialog(barcode)
      }
    }
  })
}
```

---

## ✅ 保障措施

1. ✅ **硬性限制**：云函数强制检查，无法绕过
2. ✅ **实时监控**：每次调用前检查剩余次数
3. ✅ **分级警告**：80次警告，90次严重警告
4. ✅ **用户限制**：单用户每天最多20次
5. ✅ **时段限制**：每小时最多15次
6. ✅ **自动保存**：API结果自动保存到本地
7. ✅ **每日重置**：定时任务每天00:00重置

---

**详细文档**：`API次数管理方案.md`

