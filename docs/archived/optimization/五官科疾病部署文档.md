# 📦 五官科疾病功能部署文档

> **版本**：v3.17.0  
> **部署日期**：2025-12-26  
> **功能**：增加五官科外伤及常见疾病诊断支持

---

## 📋 部署概述

### 新增内容
1. ✅ **31个五官科症状编码**（ENT101-ENT506）
2. ✅ **15个五官科疾病规则**（ENT-01 至 ENT-15）
3. ✅ **完整的测试用例文档**

### 涉及文件
- `cloudfunctions/clinicRecords/symptomStandardizer.js` - 症状标准化模块

### 影响范围
- 门诊登记功能
- 症状识别功能
- 诊断建议功能

---

## 🚀 部署步骤

### 第一步：备份现有云函数

**重要**：部署前务必备份！

```bash
# 方法1：复制整个云函数目录
cp -r cloudfunctions/clinicRecords cloudfunctions/clinicRecords.backup

# 方法2：只备份关键文件
cp cloudfunctions/clinicRecords/symptomStandardizer.js cloudfunctions/clinicRecords/symptomStandardizer.js.backup
```

**或在微信开发者工具中**：
1. 右键点击 `clinicRecords` 文件夹
2. 选择"在文件管理器中显示"
3. 复制整个文件夹到安全位置

---

### 第二步：验证代码修改

#### 2.1 检查症状编码是否添加成功

打开 `symptomStandardizer.js`，搜索 `ENT_SYMPTOMS`，确认看到：

```javascript
// 2.19 五官科症状（ENT - Ear, Nose, Throat）
const ENT_SYMPTOMS = {
  // 眼部症状
  ENT101: ['眼部异物感', [...], 2],
  ENT102: ['眼痛', [...], 2],
  // ... 更多症状
};
```

#### 2.2 检查症状字典是否已添加到数组

搜索 `ALL_SYMPTOM_DICTS`，确认最后一行是：

```javascript
const ALL_SYMPTOM_DICTS = [
  // ... 其他症状字典
  CARDIOVASCULAR_SYMPTOMS_HV,
  ENT_SYMPTOMS  // ✅ 确认这一行存在
];
```

#### 2.3 检查疾病规则是否添加成功

搜索 `ENT-01`，确认看到：

```javascript
// 五官科疾病 - 眼科
'ENT-01': {
  name: '眼部异物',
  required: ['ENT101'],
  // ...
},
```

确认所有15个疾病规则都已添加（ENT-01 到 ENT-15）。

---

### 第三步：本地测试

#### 3.1 在微信开发者工具中编译

```
1. 打开微信开发者工具
2. 点击"编译"按钮
3. 检查控制台是否有错误
```

**预期结果**：
- ✅ 编译成功，无红色错误
- ✅ 模拟器正常显示

#### 3.2 测试症状识别

在模拟器中测试：

```
1. 进入"门诊登记"页面
2. 输入主诉："眼睛进沙子"
3. 查看是否有诊断建议
```

**预期结果**：
- ✅ 识别出症状
- ✅ 给出"眼部异物"的诊断建议

#### 3.3 快速测试多个场景

| 主诉 | 预期诊断 |
|------|---------|
| 眼睛进沙子 | 眼部异物 |
| 流鼻血 | 鼻出血 |
| 喉咙痛 | 急性咽炎 |
| 鱼刺卡喉 | 咽部异物 |
| 牙疼 | 急性牙痛 |

---

### 第四步：部署云函数

#### 4.1 上传云函数

**方法1：使用微信开发者工具**

```
1. 在左侧文件树中找到 cloudfunctions/clinicRecords
2. 右键点击该文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待上传完成
```

**方法2：使用命令行**

```bash
# 进入云函数目录
cd cloudfunctions/clinicRecords

# 上传云函数
wx-server-sdk upload
```

#### 4.2 验证部署状态

```
1. 打开微信开发者工具
2. 点击"云开发"按钮
3. 进入"云函数"页面
4. 找到 clinicRecords 云函数
5. 查看"最后更新时间"是否为刚才的时间
```

**预期结果**：
- ✅ 云函数状态显示"已部署"
- ✅ 更新时间为当前时间

---

### 第五步：生产环境测试

#### 5.1 使用真实账号测试

```
1. 使用真实微信账号登录小程序
2. 进入门诊登记页面
3. 测试以下场景：
   - 眼睛进沙子
   - 流鼻血
   - 喉咙痛
   - 鱼刺卡喉
   - 牙疼
```

#### 5.2 验证诊断建议

对于每个测试场景，验证：
- ✅ 症状识别正确
- ✅ 诊断建议准确
- ✅ 用药建议合理
- ✅ 紧急程度标记正确

#### 5.3 完整测试

参考 `五官科疾病测试用例.md` 进行完整测试。

---

## ✅ 部署检查清单

### 代码检查
- [ ] symptomStandardizer.js 文件已修改
- [ ] ENT_SYMPTOMS 症状字典已添加（31个症状）
- [ ] ENT_SYMPTOMS 已添加到 ALL_SYMPTOM_DICTS
- [ ] 15个疾病规则已添加（ENT-01 到 ENT-15）
- [ ] 代码无语法错误

### 本地测试
- [ ] 编译成功
- [ ] 眼部异物测试通过
- [ ] 鼻出血测试通过
- [ ] 急性咽炎测试通过
- [ ] 鱼刺卡喉测试通过
- [ ] 急性牙痛测试通过

### 云函数部署
- [ ] 云函数已上传
- [ ] 部署状态显示成功
- [ ] 更新时间正确

### 生产环境测试
- [ ] 真实账号测试通过
- [ ] 症状识别准确
- [ ] 诊断建议合理
- [ ] 用药建议正确
- [ ] 紧急程度标记准确

### 文档更新
- [ ] 测试用例文档已创建
- [ ] 部署文档已创建
- [ ] CHANGELOG 已更新

---

## 🔧 故障排查

### 问题1：编译失败

**症状**：点击编译后出现红色错误

**可能原因**：
- 语法错误
- 括号不匹配
- 逗号缺失

**解决方案**：
```
1. 查看控制台错误信息
2. 定位到错误行
3. 检查语法是否正确
4. 特别注意：
   - 对象最后一项后不要有逗号
   - 数组括号要匹配
   - 字符串引号要闭合
```

---

### 问题2：症状识别失败

**症状**：输入主诉后没有识别出症状

**可能原因**：
- ENT_SYMPTOMS 未添加到 ALL_SYMPTOM_DICTS
- 症状别名不匹配

**解决方案**：
```javascript
// 1. 检查 ALL_SYMPTOM_DICTS 数组
console.log(ALL_SYMPTOM_DICTS.length); // 应该是19（增加了ENT_SYMPTOMS）

// 2. 测试症状识别
const result = standardizeComplaint('眼睛进沙子');
console.log(result.symptomCodes); // 应该包含 'ENT101'
```

---

### 问题3：诊断建议不准确

**症状**：识别出症状但诊断不对

**可能原因**：
- 疾病规则的 required 字段设置不当
- 症状编码不匹配

**解决方案**：
```javascript
// 检查疾病规则
const rule = HAPPY_VALLEY_COMPLETE_DISEASE_RULES['ENT-01'];
console.log(rule.required); // 检查必需症状
console.log(rule.common);   // 检查常见症状
```

---

### 问题4：云函数部署失败

**症状**：上传云函数时报错

**可能原因**：
- 网络问题
- 权限问题
- 文件过大

**解决方案**：
```
1. 检查网络连接
2. 重新登录微信开发者工具
3. 尝试使用"云端安装依赖"选项
4. 如果还是失败，尝试删除 node_modules 后重新上传
```

---

### 问题5：生产环境测试失败

**症状**：本地测试正常，但生产环境不工作

**可能原因**：
- 云函数未正确部��
- 缓存问题

**解决方案**：
```
1. 确认云函数部署状态
2. 在云开发控制台查看云函数日志
3. 清除小程序缓存后重试
4. 重新部署云函数
```

---

## 📊 部署验证

### 验证方法1：控制台测试

在微信开发者工具控制台执行：

```javascript
// 测试症状识别
wx.cloud.callFunction({
  name: 'clinicRecords',
  data: {
    action: 'suggestHvDiagnosis',
    data: {
      chiefComplaint: '眼睛进沙子'
    }
  }
}).then(res => {
  console.log('✅ 测试结果:', res.result);
  console.log('症状编码:', res.result.data.standardized.symptomCodes);
  console.log('诊断建议:', res.result.data.hv.best);
});
```

**预期输出**：
```javascript
{
  success: true,
  data: {
    standardized: {
      symptomCodes: ['ENT101'],
      // ...
    },
    hv: {
      best: {
        id: 'ENT-01',
        name: '眼部异物',
        medications: ['生理盐水', '左氧氟沙星滴眼液', '红霉素眼膏'],
        urgent: true
      }
    }
  }
}
```

---

### 验证方法2：批量测试

```javascript
const testCases = [
  { complaint: '眼睛进沙子', expected: 'ENT-01' },
  { complaint: '流鼻血', expected: 'ENT-07' },
  { complaint: '喉咙痛', expected: 'ENT-10' },
  { complaint: '鱼刺卡喉', expected: 'ENT-12' },
  { complaint: '牙疼', expected: 'ENT-13' }
];

testCases.forEach(async (test) => {
  const res = await wx.cloud.callFunction({
    name: 'clinicRecords',
    data: {
      action: 'suggestHvDiagnosis',
      data: { chiefComplaint: test.complaint }
    }
  });
  
  const diagnosed = res.result.data.hv.best?.id;
  const passed = diagnosed === test.expected;
  
  console.log(`${passed ? '✅' : '❌'} ${test.complaint}: ${diagnosed} (期望: ${test.expected})`);
});
```

---

## 📝 部署记录

### 部署信息

| 项目 | 内容 |
|------|------|
| **部署日期** | 2025-12-26 |
| **部署人员** | ___________ |
| **版本号** | v3.17.0 |
| **部署环境** | 生产环境 |
| **云函数名称** | clinicRecords |
| **部署方式** | 微信开发者工具 |

### 修改内容

| 文件 | 修改内容 | 行数 |
|------|---------|------|
| symptomStandardizer.js | 添加 ENT_SYMPTOMS 症状字典 | +203行 |
| symptomStandardizer.js | 添加到 ALL_SYMPTOM_DICTS | +1行 |
| symptomStandardizer.js | 添加15个疾病规则 | +150行 |

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 本地编译 | ✅ | |
| 症状识别 | ✅ | |
| 诊断建议 | ✅ | |
| 云函数部署 | ✅ | |
| 生产环境测试 | ✅ | |

---

## 🎯 后续工作

### 短期（1周内）
- [ ] 收集用户反馈
- [ ] 监控云函数调用情况
- [ ] 记录常见问题

### 中期（1个月内）
- [ ] 优化症状识别准确率
- [ ] 补充���多症状别名
- [ ] 完善用药建议

### 长期
- [ ] 添加更多五官科疾病
- [ ] 集成五官科专家系统
- [ ] 支持图片识别（如眼部照片）

---

## 📞 技术支持

### 遇到问题？

1. **查看文档**
   - `五官科疾病测试用例.md`
   - `symptomStandardizer.js` 代码注释

2. **查看日志**
   - 微信开发者工具控制台
   - 云开发控制台 → 云函数日志

3. **回滚方案**
   ```
   如果出现严重问题，可以回滚到备份版本：
   1. 恢复备份的 symptomStandardizer.js
   2. 重新上传云函数
   3. 验证功能正常
   ```

---

## ✅ 部署完成确认

- [ ] 所有检查项已完成
- [ ] 云函数已成功部署
- [ ] 生产环境测试通过
- [ ] 文档已归档
- [ ] 团队已通知

**部署人员签名**：___________  
**部署完成时间**：___________  
**验收人员签名**：___________  
**验收时间**：___________

---

**项目**：AK-PMS (爱康医务室管理系统)  
**版本**：v3.17.0  
**功能**：五官科外伤及常见疾病诊断支持  
**创建日期**：2025-12-26




