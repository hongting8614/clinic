# ğŸš€ v3.14 åŒè½¨åˆ¶å­˜å‚¨ - è¯¦ç»†å‡†å¤‡æ­¥éª¤

**ç‰ˆæœ¬**: v3.14 Ultimate  
**é¢„è®¡æ—¶é—´**: 30-40åˆ†é’Ÿ  
**é‡è¦æ€§**: â­â­â­ å¿…é¡»æŒ‰é¡ºåºå®Œæˆ  

---

## ğŸ“‹ å‡†å¤‡æ­¥éª¤æ£€æŸ¥æ¸…å•

```
[ ] æ­¥éª¤1: æ•°æ®å¤‡ä»½ï¼ˆ5åˆ†é’Ÿï¼‰âš ï¸ é‡è¦
[ ] æ­¥éª¤2: éƒ¨ç½² UnitConverter å·¥å…·ç±»ï¼ˆ5åˆ†é’Ÿï¼‰
[ ] æ­¥éª¤3: æ›´æ–° inRecords äº‘å‡½æ•°ï¼ˆ5åˆ†é’Ÿï¼‰
[ ] æ­¥éª¤4: æ›´æ–° outRecords äº‘å‡½æ•°ï¼ˆ5åˆ†é’Ÿï¼‰
[ ] æ­¥éª¤5: æ‰§è¡Œæ•°æ®è¿ç§»ï¼ˆ10åˆ†é’Ÿï¼‰
[ ] æ­¥éª¤6: éªŒè¯è¿ç§»ç»“æœï¼ˆ5åˆ†é’Ÿï¼‰
[ ] æ­¥éª¤7: å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆ3åˆ†é’Ÿï¼‰
[ ] æ­¥éª¤8: å‡†å¤‡æµ‹è¯•è´¦å·ï¼ˆ2åˆ†é’Ÿï¼‰
```

---

## æ­¥éª¤1: æ•°æ®å¤‡ä»½ï¼ˆ5åˆ†é’Ÿï¼‰âš ï¸

### ä¸ºä»€ä¹ˆè¦å¤‡ä»½ï¼Ÿ
- æ•°æ®è¿ç§»ä¼šä¿®æ”¹ç°æœ‰æ•°æ®ç»“æ„
- å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿæ¢å¤
- è¿™æ˜¯**æœ€é‡è¦**çš„å®‰å…¨æªæ–½

### è¯¦ç»†æ“ä½œæ­¥éª¤ï¼š

#### 1.1 æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
```
1. å¯åŠ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. æ‰“å¼€ AK-PMS é¡¹ç›®
3. ç‚¹å‡»é¡¶éƒ¨èœå• "äº‘å¼€å‘" æŒ‰é’®
```

#### 1.2 è¿›å…¥äº‘å¼€å‘æ§åˆ¶å°
```
1. åœ¨å¼¹å‡ºçš„äº‘å¼€å‘ç•Œé¢ï¼Œç‚¹å‡» "æ•°æ®åº“"
2. ç­‰å¾…æ•°æ®åº“æ§åˆ¶å°åŠ è½½å®Œæˆ
```

#### 1.3 å¯¼å‡ºæ•°æ®é›†åˆ

**éœ€è¦å¤‡ä»½çš„é›†åˆ**ï¼š

```
âœ… drugsï¼ˆè¯ææ¡£æ¡ˆï¼‰    - æœ€é‡è¦
âœ… stockï¼ˆåº“å­˜æ•°æ®ï¼‰    - æœ€é‡è¦
âœ… locationsï¼ˆå›­åŒºé…ç½®ï¼‰
âœ… in_recordsï¼ˆå…¥åº“è®°å½•ï¼‰
âœ… out_recordsï¼ˆå‡ºåº“è®°å½•ï¼‰
```

**å¯¼å‡ºæ“ä½œï¼ˆæ¯ä¸ªé›†åˆéƒ½è¦åšï¼‰**ï¼š

```
1. åœ¨å·¦ä¾§é›†åˆåˆ—è¡¨ä¸­ï¼Œç‚¹å‡»é›†åˆåç§°ï¼ˆå¦‚ drugsï¼‰
2. ç‚¹å‡»å³ä¸Šè§’ "å¯¼å‡º" æŒ‰é’®
3. é€‰æ‹©å¯¼å‡ºæ ¼å¼: JSON
4. é€‰æ‹©å¯¼å‡ºå…¨éƒ¨æ•°æ®
5. ç‚¹å‡» "ç¡®å®š"
6. ç­‰å¾…å¯¼å‡ºå®Œæˆï¼ˆä¼šè‡ªåŠ¨ä¸‹è½½ .json æ–‡ä»¶ï¼‰
```

#### 1.4 ä¿å­˜å¤‡ä»½æ–‡ä»¶

**åˆ›å»ºå¤‡ä»½ç›®å½•**ï¼š
```
D:\AK-PMS\_backup_data\v3.14_before\
```

**ä¿å­˜æ–‡ä»¶**ï¼š
```
_backup_data/
â””â”€ v3.14_before/
   â”œâ”€ drugs_20251106.json
   â”œâ”€ stock_20251106.json
   â”œâ”€ locations_20251106.json
   â”œâ”€ in_records_20251106.json
   â””â”€ out_records_20251106.json
```

#### 1.5 éªŒè¯å¤‡ä»½

```
âœ… æ£€æŸ¥ï¼š5ä¸ª JSON æ–‡ä»¶éƒ½å­˜åœ¨
âœ… æ£€æŸ¥ï¼šæ¯ä¸ªæ–‡ä»¶å¤§å° > 0
âœ… æ£€æŸ¥ï¼šç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼Œèƒ½çœ‹åˆ° JSON æ•°æ®
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… 5ä¸ªå¤‡ä»½æ–‡ä»¶å·²ä¿å­˜
- [ ] âœ… æ–‡ä»¶å¯ä»¥æ­£å¸¸æ‰“å¼€
- [ ] âœ… è®°å½•äº†å¤‡ä»½æ—¶é—´å’Œä½ç½®

---

## æ­¥éª¤2: éƒ¨ç½² UnitConverter å·¥å…·ç±»ï¼ˆ5åˆ†é’Ÿï¼‰

### 2.1 ç¡®è®¤æ–‡ä»¶å­˜åœ¨

**æ£€æŸ¥æ–‡ä»¶ä½ç½®**ï¼š
```
D:\AK-PMS\utils\unitConverter.js
```

**æ‰“å¼€æ–‡ä»¶éªŒè¯**ï¼š
```javascript
// åº”è¯¥çœ‹åˆ°ç±»ä¼¼å†…å®¹ï¼š
export default class UnitConverter {
  static SPEC_PATTERNS = {
    standard: /^(\d+\.?\d*)(mg|g|ml)...
    // ...
  }
}
```

### 2.2 åœ¨å°ç¨‹åºä¸­æµ‹è¯•å¯¼å…¥

**åˆ›å»ºæµ‹è¯•é¡µé¢**ï¼ˆæˆ–åœ¨ç°æœ‰é¡µé¢æµ‹è¯•ï¼‰ï¼š

```
æ–‡ä»¶ä½ç½®: pages/test/unitConverter.vueï¼ˆæ–°å»ºï¼‰
```

**æµ‹è¯•ä»£ç **ï¼š
```vue
<template>
  <view class="container">
    <view class="test-section">
      <text class="title">UnitConverter å·¥å…·ç±»æµ‹è¯•</text>
      <button @click="testParse">æµ‹è¯•è§„æ ¼è§£æ</button>
      <button @click="testConvert">æµ‹è¯•å•ä½è½¬æ¢</button>
      <button @click="testDisplay">æµ‹è¯•æ ¼å¼åŒ–æ˜¾ç¤º</button>
      <view class="result">{{ result }}</view>
    </view>
  </view>
</template>

<script>
import UnitConverter from '@/utils/unitConverter.js'

export default {
  data() {
    return {
      result: 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•'
    }
  },
  
  methods: {
    testParse() {
      try {
        const spec = '0.25gÃ—24ç²’/ç›’'
        const parsed = UnitConverter.parseSpecification(spec)
        
        if (parsed) {
          this.result = `âœ… è§£ææˆåŠŸ\nè§„æ ¼: ${spec}\nè½¬æ¢ç‡: ${parsed.conversionRate}\næœ€å°å•ä½: ${parsed.minUnit}\nåŒ…è£…å•ä½: ${parsed.packUnit}`
        } else {
          this.result = 'âŒ è§£æå¤±è´¥'
        }
      } catch (error) {
        this.result = `âŒ é”™è¯¯: ${error.message}`
      }
    },
    
    testConvert() {
      try {
        const packQty = 2
        const rate = 24
        const minQty = UnitConverter.packToMin(packQty, rate)
        
        this.result = `âœ… è½¬æ¢æˆåŠŸ\n${packQty}ç›’ Ã— ${rate} = ${minQty}ç²’`
      } catch (error) {
        this.result = `âŒ é”™è¯¯: ${error.message}`
      }
    },
    
    testDisplay() {
      try {
        const specInfo = {
          conversionRate: 24,
          minUnit: 'ç²’',
          packUnit: 'ç›’'
        }
        const display = UnitConverter.formatStockWithConversion(42, specInfo)
        
        this.result = `âœ… æ˜¾ç¤ºæˆåŠŸ\n42ç²’ â†’ ${display}`
      } catch (error) {
        this.result = `âŒ é”™è¯¯: ${error.message}`
      }
    }
  }
}
</script>

<style scoped>
.container {
  padding: 20px;
}

.test-section {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
}

.title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 20px;
}

button {
  margin: 10px 0;
  width: 100%;
  padding: 15px;
  background: #07c160;
  color: #fff;
  border: none;
  border-radius: 5px;
}

.result {
  margin-top: 20px;
  padding: 15px;
  background: #f5f5f5;
  border-radius: 5px;
  white-space: pre-wrap;
}
</style>
```

### 2.3 æ·»åŠ é¡µé¢é…ç½®

**åœ¨ pages.json ä¸­æ·»åŠ **ï¼š
```json
{
  "pages": [
    // ... ç°æœ‰é¡µé¢
  ],
  "subPackages": [
    {
      "root": "pages/test",
      "pages": [
        {
          "path": "unitConverter",
          "style": {
            "navigationBarTitleText": "å·¥å…·ç±»æµ‹è¯•"
          }
        }
      ]
    }
  ]
}
```

### 2.4 è¿è¡Œæµ‹è¯•

```
1. ç¼–è¯‘å°ç¨‹åº
2. è®¿é—®æµ‹è¯•é¡µé¢: pages/test/unitConverter
3. ä¾æ¬¡ç‚¹å‡»3ä¸ªæŒ‰é’®
4. æŸ¥çœ‹ç»“æœæ˜¯å¦éƒ½æ˜¾ç¤º âœ…
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… è§„æ ¼è§£ææµ‹è¯•é€šè¿‡
- [ ] âœ… å•ä½è½¬æ¢æµ‹è¯•é€šè¿‡
- [ ] âœ… æ ¼å¼åŒ–æ˜¾ç¤ºæµ‹è¯•é€šè¿‡

---

## æ­¥éª¤3: æ›´æ–° inRecords äº‘å‡½æ•°ï¼ˆ5åˆ†é’Ÿï¼‰

### 3.1 æ‰¾åˆ°äº‘å‡½æ•°æ–‡ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š
```
D:\AK-PMS\cloudfunctions\inRecords\index.js
```

### 3.2 ç¡®è®¤æ–‡ä»¶å·²æ›´æ–°

**æ‰“å¼€æ–‡ä»¶æ£€æŸ¥å…³é”®ä»£ç **ï¼š

åº”è¯¥åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```javascript
// 1. é¡¶éƒ¨åº”è¯¥æœ‰ UnitConverter ç±»
class UnitConverter {
  static parseSpecification(specification) {
    // ... è§„æ ¼è§£æä»£ç 
  }
}

// 2. åœ¨ approve å‡½æ•°ä¸­ï¼Œåº”è¯¥æœ‰ï¼š
const specInfo = UnitConverter.parseSpecification(item.specification || item.spec)

await updateStock({
  // ...
  location: 'drug_storage', // ç»Ÿä¸€å…¥åº“åˆ°è¯åº“ â­
  specInfo: specInfo
})

// 3. åœ¨ updateStock å‡½æ•°ä¸­ï¼Œåº”è¯¥æœ‰ï¼š
pricePerMin: pricePerMin, // æœ€å°å•ä½å•ä»· â­
specInfo: specInfo || null, // è§„æ ¼è§£æä¿¡æ¯ â­
```

### 3.3 ä¸Šä¼ äº‘å‡½æ•°

**æ“ä½œæ­¥éª¤**ï¼š

```
1. åœ¨ VSCode/å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­
2. å³é”®ç‚¹å‡» cloudfunctions/inRecords æ–‡ä»¶å¤¹
3. é€‰æ‹© "ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
4. ç­‰å¾…ä¸Šä¼ å®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰
5. æŸ¥çœ‹æ§åˆ¶å°ï¼Œåº”æ˜¾ç¤º "ä¸Šä¼ æˆåŠŸ"
```

**å¦‚æœä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·**ï¼š
```
1. æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°
2. ç‚¹å‡» "äº‘å‡½æ•°"
3. æ‰¾åˆ° inRecords
4. ç‚¹å‡» "ä¸Šä¼ " æŒ‰é’®
5. ç­‰å¾…ä¸Šä¼ å®Œæˆ
```

### 3.4 æµ‹è¯•äº‘å‡½æ•°

**åœ¨å°ç¨‹åºä¸­è¿è¡Œæµ‹è¯•**ï¼š

```javascript
// åœ¨æ§åˆ¶å°æˆ–é¡µé¢ä¸­è¿è¡Œ
wx.cloud.callFunction({
  name: 'inRecords',
  data: {
    action: 'getCounts'
  }
}).then(res => {
  console.log('å…¥åº“äº‘å‡½æ•°æµ‹è¯•:', res)
  if (res.result.success) {
    console.log('âœ… äº‘å‡½æ•°æ­£å¸¸å·¥ä½œ')
    console.log('ç»Ÿè®¡æ•°æ®:', res.result)
  } else {
    console.log('âŒ äº‘å‡½æ•°å¼‚å¸¸:', res.result.message)
  }
}).catch(err => {
  console.error('âŒ è°ƒç”¨å¤±è´¥:', err)
})
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… äº‘å‡½æ•°ä¸Šä¼ æˆåŠŸ
- [ ] âœ… æµ‹è¯•è°ƒç”¨è¿”å›æˆåŠŸ
- [ ] âœ… æ²¡æœ‰é”™è¯¯ä¿¡æ¯

---

## æ­¥éª¤4: æ›´æ–° outRecords äº‘å‡½æ•°ï¼ˆ5åˆ†é’Ÿï¼‰

### 4.1 é‡å‘½åæ–°ç‰ˆæœ¬æ–‡ä»¶

**æ“ä½œæ­¥éª¤**ï¼š

```
1. æ‰¾åˆ°æ–‡ä»¶: cloudfunctions/outRecords/index_v3.14.js
2. å¤‡ä»½æ—§æ–‡ä»¶: 
   - å°† index.js é‡å‘½åä¸º index_old.js
3. é‡å‘½åæ–°æ–‡ä»¶:
   - å°† index_v3.14.js é‡å‘½åä¸º index.js
```

**æ–‡ä»¶ç»“æ„åº”è¯¥æ˜¯**ï¼š
```
cloudfunctions/
â””â”€ outRecords/
   â”œâ”€ index.js          â† æ–°ç‰ˆæœ¬ï¼ˆv3.14ï¼‰
   â”œâ”€ index_old.js      â† æ—§ç‰ˆæœ¬å¤‡ä»½
   â””â”€ package.json
```

### 4.2 ç¡®è®¤å…³é”®ä»£ç 

**æ‰“å¼€ index.js æ£€æŸ¥**ï¼š

åº”è¯¥åŒ…å«ä»¥ä¸‹å…³é”®åŠŸèƒ½ï¼š

```javascript
// 1. UnitConverter ç±»å­˜åœ¨
class UnitConverter {
  static parseSpecification(specification) {
    // ...
  }
  
  static packToMin(packQuantity, conversionRate) {
    return packQuantity * conversionRate
  }
}

// 2. createRecord å‡½æ•°ä¸­çš„è½¬æ¢é€»è¾‘
const specInfo = UnitConverter.parseSpecification(item.specification)
const minQuantity = UnitConverter.packToMin(item.quantity, specInfo.conversionRate)

convertedItems.push({
  // è¯åº“æ‰£å‡ï¼ˆåŒ…è£…å•ä½ï¼‰
  packQuantity: item.quantity,
  packUnit: specInfo.packUnit,
  
  // å›­åŒºå…¥åº“ï¼ˆæœ€å°å•ä½ï¼‰â­
  minQuantity: minQuantity,
  minUnit: specInfo.minUnit,
  // ...
})

// 3. complete å‡½æ•°ä¸­çš„åº“å­˜æ›´æ–°
// æ‰£å‡è¯åº“ï¼ˆåŒ…è£…å•ä½ï¼‰
quantity: _.inc(-item.packQuantity)

// å¢åŠ å›­åŒºï¼ˆæœ€å°å•ä½ï¼‰
quantity: item.minQuantity,
unit: item.minUnit,
```

### 4.3 ä¸Šä¼ äº‘å‡½æ•°

**æ“ä½œæ­¥éª¤**ï¼š

```
1. å³é”®ç‚¹å‡» cloudfunctions/outRecords æ–‡ä»¶å¤¹
2. é€‰æ‹© "ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
3. ç­‰å¾…ä¸Šä¼ å®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰
4. æŸ¥çœ‹æ§åˆ¶å°ç¡®è®¤ "ä¸Šä¼ æˆåŠŸ"
```

### 4.4 æµ‹è¯•äº‘å‡½æ•°

```javascript
wx.cloud.callFunction({
  name: 'outRecords',
  data: {
    action: 'getCounts'
  }
}).then(res => {
  console.log('å‡ºåº“äº‘å‡½æ•°æµ‹è¯•:', res)
  if (res.result.success) {
    console.log('âœ… äº‘å‡½æ•°æ­£å¸¸å·¥ä½œ')
  } else {
    console.log('âŒ äº‘å‡½æ•°å¼‚å¸¸:', res.result.message)
  }
}).catch(err => {
  console.error('âŒ è°ƒç”¨å¤±è´¥:', err)
})
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… æ–‡ä»¶å·²é‡å‘½å
- [ ] âœ… äº‘å‡½æ•°ä¸Šä¼ æˆåŠŸ
- [ ] âœ… æµ‹è¯•è°ƒç”¨è¿”å›æˆåŠŸ

---

## æ­¥éª¤5: æ‰§è¡Œæ•°æ®è¿ç§»ï¼ˆ10åˆ†é’Ÿï¼‰â­ é‡è¦

### 5.1 åˆ›å»ºè¿ç§»æµ‹è¯•é¡µé¢

**åˆ›å»ºæ–‡ä»¶**: `pages/test/migration.vue`

```vue
<template>
  <view class="container">
    <view class="header">
      <text class="title">ğŸ“¦ æ•°æ®è¿ç§» v3.14</text>
      <text class="subtitle">è¯·æŒ‰é¡ºåºç‚¹å‡»æŒ‰é’®</text>
    </view>
    
    <!-- æ­¥éª¤æŒ‡ç¤º -->
    <view class="steps">
      <view class="step" :class="{ active: currentStep >= 1 }">
        <text class="step-num">1</text>
        <text class="step-text">ç¯å¢ƒæ£€æŸ¥</text>
      </view>
      <view class="step" :class="{ active: currentStep >= 2 }">
        <text class="step-num">2</text>
        <text class="step-text">æ‰§è¡Œè¿ç§»</text>
      </view>
      <view class="step" :class="{ active: currentStep >= 3 }">
        <text class="step-num">3</text>
        <text class="step-text">éªŒè¯ç»“æœ</text>
      </view>
    </view>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="actions">
      <button 
        class="btn btn-info" 
        @click="checkEnvironment"
        :disabled="loading"
      >
        1ï¸âƒ£ ç¯å¢ƒæ£€æŸ¥
      </button>
      
      <button 
        class="btn btn-primary" 
        @click="runMigration"
        :disabled="loading || currentStep < 1"
      >
        2ï¸âƒ£ å¼€å§‹è¿ç§»
      </button>
      
      <button 
        class="btn btn-success" 
        @click="validateMigration"
        :disabled="loading || currentStep < 2"
      >
        3ï¸âƒ£ éªŒè¯ç»“æœ
      </button>
      
      <button 
        class="btn btn-warning" 
        @click="clearLog"
        :disabled="loading"
      >
        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
      </button>
    </view>
    
    <!-- æ—¥å¿—æ˜¾ç¤º -->
    <view class="log-container">
      <text class="log-title">ğŸ“‹ æ‰§è¡Œæ—¥å¿—</text>
      <scroll-view class="log-content" scroll-y>
        <text class="log-text">{{ log }}</text>
      </scroll-view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      log: 'å‡†å¤‡å°±ç»ªï¼Œè¯·å¼€å§‹æ“ä½œ...\n',
      loading: false,
      currentStep: 0
    }
  },
  
  methods: {
    addLog(message) {
      const time = new Date().toLocaleTimeString()
      this.log += `[${time}] ${message}\n`
    },
    
    clearLog() {
      this.log = 'æ—¥å¿—å·²æ¸…ç©º\n'
      this.currentStep = 0
    },
    
    // æ­¥éª¤1: ç¯å¢ƒæ£€æŸ¥
    async checkEnvironment() {
      this.loading = true
      this.addLog('â”'.repeat(30))
      this.addLog('å¼€å§‹ç¯å¢ƒæ£€æŸ¥...')
      
      try {
        const db = wx.cloud.database()
        
        // 1. æ£€æŸ¥è¯åº“é…ç½®
        this.addLog('æ£€æŸ¥è¯åº“é…ç½®...')
        const locations = await db.collection('locations')
          .where({ code: 'drug_storage' })
          .get()
        
        if (locations.data.length > 0) {
          this.addLog('âœ… è¯åº“é…ç½®å·²å­˜åœ¨')
        } else {
          this.addLog('âš ï¸ è¯åº“é…ç½®ä¸å­˜åœ¨ï¼Œè¿ç§»æ—¶ä¼šè‡ªåŠ¨åˆ›å»º')
        }
        
        // 2. æ£€æŸ¥è¯ææ•°é‡
        const drugs = await db.collection('drugs').count()
        this.addLog(`ğŸ“Š è¯ææ¡£æ¡ˆ: ${drugs.total} æ¡`)
        
        // 3. æ£€æŸ¥åº“å­˜æ•°é‡
        const stock = await db.collection('stock').count()
        this.addLog(`ğŸ“¦ åº“å­˜è®°å½•: ${stock.total} æ¡`)
        
        // 4. æ£€æŸ¥äº‘å‡½æ•°
        this.addLog('æ£€æŸ¥äº‘å‡½æ•°...')
        
        const inTest = await wx.cloud.callFunction({
          name: 'inRecords',
          data: { action: 'getCounts' }
        })
        this.addLog(inTest.result.success ? 'âœ… inRecords æ­£å¸¸' : 'âŒ inRecords å¼‚å¸¸')
        
        const outTest = await wx.cloud.callFunction({
          name: 'outRecords',
          data: { action: 'getCounts' }
        })
        this.addLog(outTest.result.success ? 'âœ… outRecords æ­£å¸¸' : 'âŒ outRecords å¼‚å¸¸')
        
        this.addLog('â”'.repeat(30))
        this.addLog('âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆï¼Œå¯ä»¥å¼€å§‹è¿ç§»')
        this.currentStep = 1
        
      } catch (error) {
        this.addLog(`âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥: ${error.message}`)
      } finally {
        this.loading = false
      }
    },
    
    // æ­¥éª¤2: æ‰§è¡Œè¿ç§»
    async runMigration() {
      this.loading = true
      this.addLog('â”'.repeat(30))
      this.addLog('å¼€å§‹æ•°æ®è¿ç§»...')
      
      try {
        const db = wx.cloud.database()
        const _ = db.command
        
        // è¿ç§»ç»Ÿè®¡
        let successCount = 0
        let failCount = 0
        
        // 1. æ·»åŠ è¯åº“é…ç½®
        this.addLog('æ­¥éª¤1: æ·»åŠ è¯åº“é…ç½®...')
        try {
          const existing = await db.collection('locations')
            .where({ code: 'drug_storage' })
            .get()
          
          if (existing.data.length === 0) {
            await db.collection('locations').add({
              data: {
                code: 'drug_storage',
                name: 'è¯åº“',
                icon: 'ğŸ¥',
                type: 'storage',
                status: 'active',
                sort: 0,
                createTime: new Date(),
                updateTime: new Date()
              }
            })
            this.addLog('âœ… è¯åº“é…ç½®æ·»åŠ æˆåŠŸ')
          } else {
            this.addLog('â„¹ï¸ è¯åº“é…ç½®å·²å­˜åœ¨ï¼Œè·³è¿‡')
          }
        } catch (error) {
          this.addLog(`âŒ æ·»åŠ è¯åº“é…ç½®å¤±è´¥: ${error.message}`)
        }
        
        // 2. è¿ç§»è¯ææ¡£æ¡ˆ
        this.addLog('æ­¥éª¤2: è¿ç§»è¯ææ¡£æ¡ˆ...')
        const drugs = await db.collection('drugs').get()
        this.addLog(`æ‰¾åˆ° ${drugs.data.length} ä¸ªè¯æ`)
        
        for (let i = 0; i < drugs.data.length; i++) {
          const drug = drugs.data[i]
          try {
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…ä½¿ç”¨ UnitConverter
            // ç”±äºå°ç¨‹åºç¯å¢ƒé™åˆ¶ï¼Œè¿™é‡Œåªåšå­—æ®µé‡å‘½å
            await db.collection('drugs').doc(drug._id).update({
              data: {
                specification: drug.spec || drug.specification || '',
                updateTime: new Date()
              }
            })
            successCount++
            
            if ((i + 1) % 10 === 0) {
              this.addLog(`è¿›åº¦: ${i + 1}/${drugs.data.length}`)
            }
          } catch (error) {
            failCount++
            this.addLog(`âŒ è¯æ ${drug.name} è¿ç§»å¤±è´¥`)
          }
        }
        
        this.addLog(`âœ… è¯æè¿ç§»å®Œæˆ: æˆåŠŸ ${successCount}, å¤±è´¥ ${failCount}`)
        
        // 3. è¿ç§»åº“å­˜æ•°æ®
        this.addLog('æ­¥éª¤3: è¿ç§»åº“å­˜æ•°æ®...')
        const stocks = await db.collection('stock').get()
        this.addLog(`æ‰¾åˆ° ${stocks.data.length} æ¡åº“å­˜`)
        
        successCount = 0
        failCount = 0
        
        for (let i = 0; i < stocks.data.length; i++) {
          const stock = stocks.data[i]
          try {
            await db.collection('stock').doc(stock._id).update({
              data: {
                specification: stock.spec || stock.specification || '',
                lockQuantity: stock.lockQuantity || 0,
                updateTime: new Date()
              }
            })
            successCount++
            
            if ((i + 1) % 10 === 0) {
              this.addLog(`è¿›åº¦: ${i + 1}/${stocks.data.length}`)
            }
          } catch (error) {
            failCount++
          }
        }
        
        this.addLog(`âœ… åº“å­˜è¿ç§»å®Œæˆ: æˆåŠŸ ${successCount}, å¤±è´¥ ${failCount}`)
        
        this.addLog('â”'.repeat(30))
        this.addLog('ğŸ‰ æ•°æ®è¿ç§»å®Œæˆï¼')
        this.currentStep = 2
        
      } catch (error) {
        this.addLog(`âŒ è¿ç§»å¤±è´¥: ${error.message}`)
      } finally {
        this.loading = false
      }
    },
    
    // æ­¥éª¤3: éªŒè¯ç»“æœ
    async validateMigration() {
      this.loading = true
      this.addLog('â”'.repeat(30))
      this.addLog('å¼€å§‹éªŒè¯è¿ç§»ç»“æœ...')
      
      try {
        const db = wx.cloud.database()
        
        // 1. éªŒè¯è¯åº“é…ç½®
        const locations = await db.collection('locations')
          .where({ code: 'drug_storage' })
          .get()
        
        if (locations.data.length > 0) {
          this.addLog('âœ… è¯åº“é…ç½®å­˜åœ¨')
        } else {
          this.addLog('âŒ è¯åº“é…ç½®ä¸å­˜åœ¨')
        }
        
        // 2. éªŒè¯è¯ææ¡£æ¡ˆ
        const drugs = await db.collection('drugs').get()
        const drugsWithSpec = drugs.data.filter(d => d.specification).length
        this.addLog(`ğŸ“Š è¯ææ¡£æ¡ˆ: ${drugsWithSpec}/${drugs.data.length} åŒ…å« specification å­—æ®µ`)
        
        // 3. éªŒè¯åº“å­˜æ•°æ®
        const stocks = await db.collection('stock').get()
        const stocksWithSpec = stocks.data.filter(s => s.specification).length
        this.addLog(`ğŸ“¦ åº“å­˜æ•°æ®: ${stocksWithSpec}/${stocks.data.length} åŒ…å« specification å­—æ®µ`)
        
        this.addLog('â”'.repeat(30))
        
        if (locations.data.length > 0 && 
            drugsWithSpec === drugs.data.length && 
            stocksWithSpec === stocks.data.length) {
          this.addLog('ğŸ‰ éªŒè¯é€šè¿‡ï¼æ‰€æœ‰æ•°æ®è¿ç§»æˆåŠŸ')
          this.currentStep = 3
        } else {
          this.addLog('âš ï¸ éƒ¨åˆ†éªŒè¯æœªé€šè¿‡ï¼Œè¯·æ£€æŸ¥')
        }
        
      } catch (error) {
        this.addLog(`âŒ éªŒè¯å¤±è´¥: ${error.message}`)
      } finally {
        this.loading = false
      }
    }
  }
}
</script>

<style scoped>
.container {
  padding: 20px;
  background: #f5f5f5;
  min-height: 100vh;
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  color: #fff;
}

.title {
  font-size: 20px;
  font-weight: bold;
  display: block;
  margin-bottom: 5px;
}

.subtitle {
  font-size: 14px;
  opacity: 0.9;
}

.steps {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}

.step {
  flex: 1;
  background: #fff;
  padding: 15px 10px;
  border-radius: 10px;
  text-align: center;
  margin: 0 5px;
  opacity: 0.5;
}

.step.active {
  opacity: 1;
  border: 2px solid #07c160;
}

.step-num {
  display: block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  background: #f0f0f0;
  border-radius: 50%;
  margin: 0 auto 5px;
  font-weight: bold;
}

.step.active .step-num {
  background: #07c160;
  color: #fff;
}

.step-text {
  font-size: 12px;
  display: block;
}

.actions {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.btn {
  width: 100%;
  margin-bottom: 10px;
  padding: 15px;
  border: none;
  border-radius: 5px;
  color: #fff;
  font-size: 16px;
}

.btn[disabled] {
  opacity: 0.5;
}

.btn-info {
  background: #1890ff;
}

.btn-primary {
  background: #07c160;
}

.btn-success {
  background: #52c41a;
}

.btn-warning {
  background: #fa8c16;
}

.log-container {
  background: #fff;
  border-radius: 10px;
  padding: 15px;
  height: 400px;
  display: flex;
  flex-direction: column;
}

.log-title {
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 10px;
}

.log-content {
  flex: 1;
  background: #f5f5f5;
  padding: 10px;
  border-radius: 5px;
  font-family: monospace;
}

.log-text {
  font-size: 12px;
  white-space: pre-wrap;
  word-break: break-all;
}
</style>
```

### 5.2 æ·»åŠ é¡µé¢é…ç½®

**åœ¨ pages.json ä¸­æ·»åŠ **ï¼š
```json
{
  "path": "test/migration",
  "style": {
    "navigationBarTitleText": "æ•°æ®è¿ç§»"
  }
}
```

### 5.3 æ‰§è¡Œè¿ç§»

```
1. ç¼–è¯‘å°ç¨‹åº
2. è®¿é—® pages/test/migration
3. æŒ‰é¡ºåºç‚¹å‡»ï¼š
   a) ç¯å¢ƒæ£€æŸ¥
   b) å¼€å§‹è¿ç§»
   c) éªŒè¯ç»“æœ
4. è§‚å¯Ÿæ—¥å¿—è¾“å‡º
5. ç¡®è®¤æ˜¾ç¤º "éªŒè¯é€šè¿‡"
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… è¯åº“é…ç½®å·²åˆ›å»º
- [ ] âœ… è¯ææ¡£æ¡ˆå…¨éƒ¨è¿ç§»æˆåŠŸ
- [ ] âœ… åº“å­˜æ•°æ®å…¨éƒ¨è¿ç§»æˆåŠŸ
- [ ] âœ… éªŒè¯ç»“æœé€šè¿‡

---

## æ­¥éª¤6: éªŒè¯è¿ç§»ç»“æœï¼ˆ5åˆ†é’Ÿï¼‰

### 6.1 æ‰‹åŠ¨æ£€æŸ¥æ•°æ®åº“

**åœ¨äº‘å¼€å‘æ§åˆ¶å°æ“ä½œ**ï¼š

#### æ£€æŸ¥ locations é›†åˆ
```
1. æ‰“å¼€ locations é›†åˆ
2. æŸ¥æ‰¾ code = 'drug_storage' çš„è®°å½•
3. ç¡®è®¤å­—æ®µï¼š
   âœ… name: "è¯åº“"
   âœ… type: "storage"
   âœ… status: "active"
```

#### æ£€æŸ¥ drugs é›†åˆ
```
1. æ‰“å¼€ drugs é›†åˆ
2. éšæœºæŸ¥çœ‹å‡ æ¡è®°å½•
3. ç¡®è®¤å­—æ®µï¼š
   âœ… specification å­—æ®µå­˜åœ¨
   âœ… spec å­—æ®µå¯èƒ½è¿˜åœ¨ï¼ˆå…¼å®¹ï¼‰
```

#### æ£€æŸ¥ stock é›†åˆ
```
1. æ‰“å¼€ stock é›†åˆ
2. æŸ¥çœ‹å‡ æ¡è®°å½•
3. ç¡®è®¤å­—æ®µï¼š
   âœ… specification å­—æ®µå­˜åœ¨
   âœ… lockQuantity å­—æ®µå­˜åœ¨
```

### 6.2 ä½¿ç”¨ä»£ç éªŒè¯

```javascript
const db = wx.cloud.database()

// ç»Ÿè®¡éªŒè¯
Promise.all([
  db.collection('locations').where({ code: 'drug_storage' }).count(),
  db.collection('drugs').count(),
  db.collection('drugs').where({ specification: _.exists(true) }).count(),
  db.collection('stock').count(),
  db.collection('stock').where({ specification: _.exists(true) }).count()
]).then(([locations, drugsTotal, drugsWithSpec, stockTotal, stockWithSpec]) => {
  console.log('â”'.repeat(50))
  console.log('ã€è¿ç§»éªŒè¯ç»“æœã€‘')
  console.log('â”'.repeat(50))
  console.log('è¯åº“é…ç½®:', locations.total, 'ä¸ª')
  console.log('è¯ææ€»æ•°:', drugsTotal.total)
  console.log('å«specification:', drugsWithSpec.total)
  console.log('åº“å­˜æ€»æ•°:', stockTotal.total)
  console.log('å«specification:', stockWithSpec.total)
  console.log('â”'.repeat(50))
  
  if (locations.total > 0 && 
      drugsWithSpec.total === drugsTotal.total &&
      stockWithSpec.total === stockTotal.total) {
    console.log('âœ… éªŒè¯é€šè¿‡ï¼')
  } else {
    console.log('âŒ éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥')
  }
})
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… è¯åº“é…ç½®æ•°é‡ = 1
- [ ] âœ… è¯æ specification å­—æ®µå®Œæ•´
- [ ] âœ… åº“å­˜ specification å­—æ®µå®Œæ•´

---

## æ­¥éª¤7: å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆ3åˆ†é’Ÿï¼‰

### 7.1 åˆ›å»ºæµ‹è¯•è¯æ

**å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰åˆé€‚çš„æµ‹è¯•æ•°æ®ï¼Œæ‰‹åŠ¨æ·»åŠ **ï¼š

**åœ¨äº‘å¼€å‘æ§åˆ¶å°æ“ä½œ**ï¼š

```
1. æ‰“å¼€ drugs é›†åˆ
2. ç‚¹å‡» "æ·»åŠ è®°å½•"
3. å¡«å†™æ•°æ®ï¼š
```

```json
{
  "_id": "test_drug_001",
  "name": "é˜¿è«è¥¿æ—èƒ¶å›Šï¼ˆæµ‹è¯•ï¼‰",
  "pinyin": "AMXLJN",
  "specification": "0.25gÃ—24ç²’/ç›’",
  "unit": "ç›’",
  "manufacturer": "æµ‹è¯•åˆ¶è¯æœ‰é™å…¬å¸",
  "category": "æŠ—ç”Ÿç´ ",
  "barcode": "TEST001",
  "isHighValue": false,
  "isEmergency": false,
  "safeStock": 50,
  "minStock": 20,
  "createTime": "å½“å‰æ—¶é—´",
  "updateTime": "å½“å‰æ—¶é—´"
}
```

### 7.2 å‡†å¤‡æµ‹è¯•æ‰¹æ¬¡ä¿¡æ¯

**è®°å½•æµ‹è¯•æ•°æ®**ï¼š
```
è¯æID: test_drug_001
è¯æåç§°: é˜¿è«è¥¿æ—èƒ¶å›Šï¼ˆæµ‹è¯•ï¼‰
è§„æ ¼: 0.25gÃ—24ç²’/ç›’
æ‰¹å·: TEST20251106
ç”Ÿäº§æ—¥æœŸ: 2025-11-01
æœ‰æ•ˆæœŸ: 2027-11-01
å…¥åº“æ•°é‡: 10ç›’
å•ä»·: 12.5å…ƒ
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… æµ‹è¯•è¯æå·²åˆ›å»º
- [ ] âœ… è§„æ ¼æ ¼å¼æ­£ç¡®
- [ ] âœ… è½¬æ¢ç‡æ˜¯24

---

## æ­¥éª¤8: å‡†å¤‡æµ‹è¯•è´¦å·ï¼ˆ2åˆ†é’Ÿï¼‰

### 8.1 ç¡®è®¤ç”¨æˆ·è§’è‰²

**éœ€è¦çš„æµ‹è¯•è´¦å·**ï¼š

```
è´¦å·1: æ“ä½œå‘˜
  - ç”¨é€”: åˆ›å»ºå…¥åº“å•
  - æƒé™: å…¥åº“æ¨¡å—

è´¦å·2: å¤æ ¸å‘˜
  - ç”¨é€”: å¤æ ¸å…¥åº“å•
  - æƒé™: å¤æ ¸æƒé™

è´¦å·3: å‘è¯äºº
  - ç”¨é€”: åˆ›å»ºå‡ºåº“å•
  - æƒé™: å‡ºåº“æ¨¡å—
```

### 8.2 æ£€æŸ¥è´¦å·æƒé™

**åœ¨å°ç¨‹åºä¸­æ“ä½œ**ï¼š

```
1. è¿›å…¥ "ç”¨æˆ·ç®¡ç†"
2. æ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘1ä¸ªç®¡ç†å‘˜è´¦å·
3. å¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ æµ‹è¯•è´¦å·
```

**æˆ–ä½¿ç”¨å½“å‰è´¦å·**ï¼š
```
å¦‚æœåªæœ‰ä¸€ä¸ªè´¦å·ï¼Œå¯ä»¥è‡ªå·±æ‰®æ¼”æ‰€æœ‰è§’è‰²
åªéœ€è®°å¾—åœ¨ä¸åŒæ“ä½œæ—¶åˆ‡æ¢"èº«ä»½"
```

**éªŒè¯é€šè¿‡æ ‡å¿—**ï¼š
- [ ] âœ… è‡³å°‘æœ‰1ä¸ªå¯ç”¨è´¦å·
- [ ] âœ… è´¦å·å¯ä»¥æ­£å¸¸ç™»å½•
- [ ] âœ… å¯ä»¥è®¿é—®å…¥åº“ã€å‡ºåº“æ¨¡å—

---

## âœ… å‡†å¤‡å®Œæˆæ£€æŸ¥

### æœ€ç»ˆæ£€æŸ¥æ¸…å•

```
å‡†å¤‡æ­¥éª¤éªŒè¯ï¼š
[ ] âœ… æ­¥éª¤1: æ•°æ®å·²å®Œæ•´å¤‡ä»½
[ ] âœ… æ­¥éª¤2: UnitConverter å·¥å…·ç±»æµ‹è¯•é€šè¿‡
[ ] âœ… æ­¥éª¤3: inRecords äº‘å‡½æ•°éƒ¨ç½²æˆåŠŸ
[ ] âœ… æ­¥éª¤4: outRecords äº‘å‡½æ•°éƒ¨ç½²æˆåŠŸ
[ ] âœ… æ­¥éª¤5: æ•°æ®è¿ç§»æ‰§è¡ŒæˆåŠŸ
[ ] âœ… æ­¥éª¤6: è¿ç§»ç»“æœéªŒè¯é€šè¿‡
[ ] âœ… æ­¥éª¤7: æµ‹è¯•æ•°æ®å‡†å¤‡å°±ç»ª
[ ] âœ… æ­¥éª¤8: æµ‹è¯•è´¦å·å‡†å¤‡å°±ç»ª
```

### å¦‚æœå…¨éƒ¨é€šè¿‡

**æ­å–œï¼æ‚¨å¯ä»¥å¼€å§‹æ­£å¼æµ‹è¯•äº†**

ä¸‹ä¸€æ­¥è¯·æŸ¥çœ‹ï¼š
```
docs/v3.14_æµ‹è¯•æŒ‡å—.md
```

---

## ğŸ”„ å¸¸è§é—®é¢˜

### Q1: å¤‡ä»½æ–‡ä»¶å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ

**A**: å¯ä»¥åªå¤‡ä»½å…³é”®å­—æ®µï¼š
```javascript
// åœ¨äº‘å‡½æ•°ä¸­å¯¼å‡º
db.collection('drugs').field({
  name: true,
  specification: true,
  spec: true
}).get()
```

### Q2: å·¥å…·ç±»å¯¼å…¥å¤±è´¥ï¼Ÿ

**A**: æ£€æŸ¥è·¯å¾„ï¼š
```javascript
// ç¡®ä¿è·¯å¾„æ­£ç¡®
import UnitConverter from '@/utils/unitConverter.js'

// æˆ–ä½¿ç”¨ç›¸å¯¹è·¯å¾„
import UnitConverter from '../../utils/unitConverter.js'
```

### Q3: äº‘å‡½æ•°ä¸Šä¼ å¤±è´¥ï¼Ÿ

**A**: å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š
```
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. é‡å¯å¾®ä¿¡å¼€å‘è€…å·¥å…·
3. æ‰‹åŠ¨åœ¨äº‘å¼€å‘æ§åˆ¶å°ä¸Šä¼ 
4. æ£€æŸ¥äº‘å‡½æ•°ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
```

### Q4: è¿ç§»è¿‡ç¨‹ä¸­æ–­ï¼Ÿ

**A**: å¯ä»¥é‡æ–°è¿è¡Œè¿ç§»ï¼š
```
è¿ç§»è„šæœ¬æ˜¯å¹‚ç­‰çš„ï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰
ä¸ä¼šé‡å¤æ·»åŠ è¯åº“é…ç½®
å­—æ®µæ›´æ–°ä¼šè¦†ç›–æ—§å€¼
```

---

**å‡†å¤‡æ—¶é—´**: 30-40åˆ†é’Ÿ  
**å…³é”®æ­¥éª¤**: æ­¥éª¤5ï¼ˆæ•°æ®è¿ç§»ï¼‰  
**ä¸‹ä¸€æ­¥**: å¼€å§‹æµ‹è¯• â†’ `docs/v3.14_æµ‹è¯•æŒ‡å—.md`

ğŸš€ **å‡†å¤‡å·¥ä½œå®Œæˆåï¼Œå°±å¯ä»¥å¼€å§‹æµ‹è¯•äº†ï¼**

