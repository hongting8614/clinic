# 📋 v3.14 双轨制存储 - 实施指南

**版本**: v3.14 Ultimate  
**更新日期**: 2025-11-06  
**预计实施时间**: 1-2小时  

---

## 📊 实施概览

```
┌─────────────────────────────────────────────────────────┐
│                    实施流程总览                          │
└─────────────────────────────────────────────────────────┘

第1阶段：备份数据（15分钟）
  ├─ 导出数据库
  └─ 保存备份文件

第2阶段：部署工具类（10分钟）
  ├─ 上传 unitConverter.js
  └─ 测试工具类

第3阶段：更新云函数（30分钟）
  ├─ 更新 inRecords
  ├─ 更新 outRecords
  └─ 测试云函数

第4阶段：数据迁移（20分钟）
  ├─ 运行迁移脚本
  ├─ 验证数据
  └─ 导出报告

第5阶段：更新界面（30分钟）
  ├─ 更新入库单界面
  ├─ 更新出库单界面
  └─ 更新库存列表

第6阶段：测试验证（30分钟）
  ├─ 入库测试
  ├─ 出库测试
  └─ 门诊消耗测试
```

---

## 🚀 详细步骤

### 第1阶段：备份数据（必须）⚠️

```bash
# 1. 进入微信开发者工具
# 2. 打开云开发控制台
# 3. 进入数据库管理
# 4. 依次导出以下集合：
#    - drugs（药材档案）
#    - stock（库存数据）
#    - in_records（入库记录）
#    - out_records（出库记录）
#    - locations（园区配置）
```

**重要**：备份文件保存到 `_backup_data/v3.14_before/` 目录

---

### 第2阶段：部署工具类

#### 2.1 上传 UnitConverter 工具类

**文件位置**：`utils/unitConverter.js`

**操作步骤**：
1. 确认文件已创建
2. 测试工具类功能

**测试代码**：
```javascript
// 在小程序控制台运行
import UnitConverter from '@/utils/unitConverter.js'

// 测试1: 规格解析
const spec1 = UnitConverter.parseSpecification('0.25g×24粒/盒')
console.log('测试1:', spec1)
// 预期输出: { conversionRate: 24, minUnit: '粒', packUnit: '盒', ... }

// 测试2: 单位转换
const minQty = UnitConverter.packToMin(2, 24)
console.log('测试2:', minQty)
// 预期输出: 48

// 测试3: 格式化显示
const display = UnitConverter.formatStockWithConversion(42, {
  minUnit: '粒',
  packUnit: '盒',
  conversionRate: 24
})
console.log('测试3:', display)
// 预期输出: "42粒 (1盒零18粒)"
```

---

### 第3阶段：更新云函数

#### 3.1 更新 inRecords 云函数

**文件位置**：`cloudfunctions/inRecords/index.js`

**操作步骤**：
1. 打开微信开发者工具
2. 右键云函数目录 `cloudfunctions/inRecords`
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成

**测试代码**：
```javascript
// 在小程序中测试
wx.cloud.callFunction({
  name: 'inRecords',
  data: {
    action: 'getCounts'
  }
}).then(res => {
  console.log('入库统计:', res.result)
})
```

#### 3.2 更新 outRecords 云函数

**文件位置**：`cloudfunctions/outRecords/index_v3.14.js`

**操作步骤**：
1. 将 `index_v3.14.js` 重命名为 `index.js`（覆盖旧文件）
2. 右键云函数目录 `cloudfunctions/outRecords`
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成

**测试代码**：
```javascript
// 在小程序中测试
wx.cloud.callFunction({
  name: 'outRecords',
  data: {
    action: 'getCounts'
  }
}).then(res => {
  console.log('出库统计:', res.result)
})
```

---

### 第4阶段：数据迁移（关键）⭐

#### 4.1 运行迁移脚本

**在小程序中创建测试页面**：`pages/test/migration.vue`

```vue
<template>
  <view class="container">
    <view class="section">
      <text class="title">数据迁移 v3.14</text>
      <button @click="runMigration">开始迁移</button>
      <button @click="validateMigration">验证结果</button>
      <button @click="exportReport">导出报告</button>
    </view>
    
    <view class="log">
      <text>{{ log }}</text>
    </view>
  </view>
</template>

<script>
import DataMigration from '@/utils/dataMigration_v3.14.js'

export default {
  data() {
    return {
      log: '准备就绪...'
    }
  },
  
  methods: {
    async runMigration() {
      this.log = '开始迁移...\n'
      try {
        const results = await DataMigration.runFullMigration()
        this.log += JSON.stringify(results, null, 2)
      } catch (error) {
        this.log += `迁移失败: ${error.message}`
      }
    },
    
    async validateMigration() {
      this.log = '验证中...\n'
      try {
        const validation = await DataMigration.validateMigration()
        this.log += JSON.stringify(validation, null, 2)
      } catch (error) {
        this.log += `验证失败: ${error.message}`
      }
    },
    
    async exportReport() {
      // 导出报告逻辑
      this.log = '报告已导出'
    }
  }
}
</script>
```

#### 4.2 执行迁移

1. 访问测试页面
2. 点击"开始迁移"按钮
3. 等待迁移完成（约5-10分钟）
4. 查看控制台日志

#### 4.3 验证迁移结果

```javascript
// 点击"验证结果"按钮
// 预期输出：
// ✅ 药库配置存在
// ✅ 药材档案: 95/95 包含 specInfo
// ✅ 库存数据: 280/280 包含 specInfo
// 🎉 验证通过！所有数据迁移成功
```

---

### 第5阶段：更新界面

#### 5.1 更新入库单界面

**无需修改** - 现有入库界面已兼容，统一入库到药库（包装单位）

#### 5.2 更新出库单界面

**关键修改**：添加自动转换提示

```vue
<!-- pages-sub/out/add.vue -->
<view class="conversion-hint">
  <text>💡 转换说明</text>
  <text>• 出库数量：按包装单位填写（如：2盒）</text>
  <text>• 自动转换：系统转换为最小单位</text>
  <text>• 园区入库：以最小单位入库（如：48粒）</text>
</view>
```

#### 5.3 更新库存列表界面

**关键修改**：智能双单位显示

```javascript
// pages/stock/list.vue
import UnitConverter from '@/utils/unitConverter.js'

methods: {
  formatStockDisplay(stock) {
    return UnitConverter.formatStockDisplay(stock)
    // 药库显示: "104盒"
    // 园区显示: "42粒 (1盒零18粒)"
  }
}
```

---

### 第6阶段：测试验证

#### 6.1 入库测试

**测试用例**：
```
测试数据：
- 药材：阿莫西林胶囊
- 规格：0.25g×24粒/盒
- 批号：20251106001
- 数量：10盒
- 单价：12.5元

预期结果：
- 药库库存增加：10盒
- 自动计算转换率：24
- 自动计算最小单位单价：0.52元/粒
- specInfo 字段正确保存
```

**验证步骤**：
1. 创建入库单
2. 复核通过
3. 查看药库库存：应显示 "10盒"
4. 查看数据库：确认 specInfo 字段存在

#### 6.2 出库测试（关键）⭐

**测试用例**：
```
测试数据：
- 从药库出库到陆园
- 药材：阿莫西林胶囊（药库现有10盒）
- 出库数量：2盒

预期结果：
- 药库库存减少：10盒 → 8盒
- 自动转换：2盒 × 24 = 48粒
- 陆园库存增加：0粒 → 48粒
- 出库记录包含双单位信息
```

**验证步骤**：
1. 创建出库单，选择陆园
2. 输入出库数量：2盒
3. 完成签名，提交
4. 查看药库库存：应显示 "8盒"
5. 查看陆园库存：应显示 "48粒 (2盒)"
6. 查看出库记录：确认 packQuantity 和 minQuantity 正确

#### 6.3 门诊消耗测试

**测试用例**：
```
测试数据：
- 园区：陆园（现有48粒）
- 患者用药：6粒

预期结果：
- 直接扣减：48粒 - 6粒 = 42粒
- 无需转换，速度快
- 显示：42粒 (1盒零18粒)
```

**验证步骤**：
1. 创建门诊记录
2. 记录用药：6粒
3. 保存
4. 查看陆园库存：应显示 "42粒 (1盒零18粒)"

---

## ✅ 验收标准

### 功能验收

- [ ] 入库统一到药库，使用包装单位
- [ ] 出库自动转换，药库扣减包装单位，园区增加最小单位
- [ ] 门诊消耗直接扣减最小单位
- [ ] 库存显示智能判断（药库显示包装，园区显示最小+换算）
- [ ] 所有规格正确解析（支持4种模式）

### 数据验收

- [ ] 所有药材包含 specInfo 字段
- [ ] 所有库存包含 specInfo 和 pricePerMin 字段
- [ ] 药库园区配置存在
- [ ] 出库记录包含双单位信息

### 性能验收

- [ ] 规格解析速度 < 10ms
- [ ] 出库转换速度 < 50ms
- [ ] 门诊消耗扣减速度 < 30ms
- [ ] 库存查询显示速度 < 100ms

---

## 🔧 问题排查

### 问题1：规格解析失败

**症状**：部分药材无法解析规格

**排查步骤**：
```javascript
// 查看失败的规格格式
const drugs = await db.collection('drugs').get()
drugs.data.forEach(drug => {
  const specInfo = UnitConverter.parseSpecification(drug.spec)
  if (!specInfo) {
    console.log('无法解析:', drug.name, drug.spec)
  }
})
```

**解决方案**：
1. 检查规格格式是否符合4种模式之一
2. 手动修正不规范的规格
3. 如需支持新格式，扩展正则表达式

### 问题2：出库转换错误

**症状**：出库后园区库存数量不对

**排查步骤**：
```javascript
// 查看出库记录
const record = await db.collection('out_records').doc('记录ID').get()
console.log('包装数量:', record.data.items[0].packQuantity)
console.log('转换率:', record.data.items[0].specInfo.conversionRate)
console.log('最小数量:', record.data.items[0].minQuantity)
// 验证: minQuantity = packQuantity × conversionRate
```

**解决方案**：
1. 检查 specInfo.conversionRate 是否正确
2. 检查出库云函数转换逻辑
3. 重新解析规格

### 问题3：库存显示异常

**症状**：园区库存显示格式不对

**排查步骤**：
```javascript
// 查看库存数据
const stock = await db.collection('stock')
  .where({ location: 'land_park' })
  .get()

console.log('库存单位:', stock.data[0].unit)  // 应为最小单位（粒/片/ml）
console.log('库存数量:', stock.data[0].quantity)
console.log('规格信息:', stock.data[0].specInfo)
```

**解决方案**：
1. 确认园区库存使用最小单位
2. 确认 specInfo 字段存在
3. 检查格式化函数逻辑

---

## 📞 技术支持

### 联系方式
- 邮箱: support@example.com
- 文档: `/docs/v3.14_实施指南.md`

### 相关文档
- [数据库设计 v3.14](./数据库设计_v3.14_双轨制.md)
- [界面设计 v3.14](../_backup_docs/📐分园区单位转换界面设计_v3.14_终极版.md)
- [单位转换工具文档](./unitConverter_API.md)

---

## 🔄 回滚方案（紧急）

**如果迁移出现严重问题，执行以下回滚步骤**：

```javascript
// 1. 运行回滚脚本
import DataMigration from '@/utils/dataMigration_v3.14.js'
await DataMigration.rollback()

// 2. 恢复云函数（使用备份版本）
// 手动上传旧版本云函数

// 3. 恢复数据库（从备份导入）
// 在云开发控制台导入备份数据

// 4. 验证回滚结果
// 检查系统功能是否恢复正常
```

---

**最后更新**: 2025-11-06  
**版本**: v3.14 Ultimate

