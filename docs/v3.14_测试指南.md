# 🧪 v3.14 双轨制存储 - 完整测试指南

**版本**: v3.14 Ultimate  
**测试日期**: 2025-11-06  
**预计时间**: 1-2小时  
**测试环境**: 微信开发者工具 + 真实数据  

---

## 📋 测试前准备

### ✅ 准备清单

- [ ] 已完成数据备份
- [ ] 已部署 UnitConverter 工具类
- [ ] 已更新 inRecords 云函数
- [ ] 已更新 outRecords 云函数
- [ ] 已执行数据迁移
- [ ] 已验证迁移结果
- [ ] 准备测试数据
- [ ] 准备测试账号

### 📊 测试环境检查

```javascript
// 在小程序控制台运行
console.log('=== 环境检查 ===')

// 1. 检查工具类
import UnitConverter from '@/utils/unitConverter.js'
console.log('工具类导入:', typeof UnitConverter)

// 2. 检查药库配置
wx.cloud.database().collection('locations')
  .where({ code: 'drug_storage' })
  .get()
  .then(res => {
    console.log('药库配置:', res.data.length > 0 ? '✅ 存在' : '❌ 不存在')
  })

// 3. 检查云函数
wx.cloud.callFunction({
  name: 'inRecords',
  data: { action: 'getCounts' }
}).then(res => {
  console.log('入库云函数:', res.result.success ? '✅ 正常' : '❌ 异常')
})

wx.cloud.callFunction({
  name: 'outRecords',
  data: { action: 'getCounts' }
}).then(res => {
  console.log('出库云函数:', res.result.success ? '✅ 正常' : '❌ 异常')
})
```

---

## 🧪 测试阶段一：工具类测试（15分钟）

### 测试1.1：规格解析测试

**目标**: 验证4种规格模式都能正确解析

```javascript
import UnitConverter from '@/utils/unitConverter.js'

console.log('━'.repeat(50))
console.log('测试1.1：规格解析测试')
console.log('━'.repeat(50))

// 测试用例
const testCases = [
  '0.25g×24粒/盒',    // 标准格式
  '0.1×12粒/盒',      // 简化格式（关键）
  '24粒/盒',          // 简化格式（无剂量）
  '20g/支',           // 单一包装
  '100片'             // 纯数量
]

testCases.forEach((spec, index) => {
  const result = UnitConverter.parseSpecification(spec)
  if (result) {
    console.log(`✅ 测试 ${index + 1}: ${spec}`)
    console.log(`   转换率: 1${result.packUnit} = ${result.conversionRate}${result.minUnit}`)
    console.log(`   模式: ${result.pattern}`)
  } else {
    console.log(`❌ 测试 ${index + 1}: ${spec} - 解析失败`)
  }
})
```

**预期结果**:
```
✅ 测试 1: 0.25g×24粒/盒
   转换率: 1盒 = 24粒
   模式: standard
   
✅ 测试 2: 0.1×12粒/盒
   转换率: 1盒 = 12粒
   模式: simple
   
✅ 测试 3: 24粒/盒
   转换率: 1盒 = 24粒
   模式: simple
   
✅ 测试 4: 20g/支
   转换率: 1支 = 1支
   模式: single
   
✅ 测试 5: 100片
   转换率: 1盒 = 100片
   模式: pure
```

---

### 测试1.2：单位转换测试

**目标**: 验证双向转换计算准确

```javascript
console.log('━'.repeat(50))
console.log('测试1.2：单位转换测试')
console.log('━'.repeat(50))

// 包装 → 最小
const test1 = UnitConverter.packToMin(2, 24)
console.log(`包装→最小: 2盒 × 24 = ${test1}粒`, test1 === 48 ? '✅' : '❌')

const test2 = UnitConverter.packToMin(3, 20)
console.log(`包装→最小: 3盒 × 20 = ${test2}片`, test2 === 60 ? '✅' : '❌')

// 最小 → 包装
const test3 = UnitConverter.minToPack(48, 24)
console.log(`最小→包装: 48粒 ÷ 24 = ${test3}盒`, test3 === 2 ? '✅' : '❌')

const test4 = UnitConverter.minToPack(42, 24)
console.log(`最小→包装: 42粒 ÷ 24 = ${test4}盒`, test4 === 1.75 ? '✅' : '❌')
```

**预期结果**:
```
✅ 包装→最小: 2盒 × 24 = 48粒 ✅
✅ 包装→最小: 3盒 × 20 = 60片 ✅
✅ 最小→包装: 48粒 ÷ 24 = 2盒 ✅
✅ 最小→包装: 42粒 ÷ 24 = 1.75盒 ✅
```

---

### 测试1.3：格式化显示测试

**目标**: 验证智能显示格式

```javascript
console.log('━'.repeat(50))
console.log('测试1.3：格式化显示测试')
console.log('━'.repeat(50))

const specInfo = {
  conversionRate: 24,
  minUnit: '粒',
  packUnit: '盒'
}

// 测试不同数量
const quantities = [48, 42, 18, 102]

quantities.forEach(qty => {
  const display = UnitConverter.formatStockWithConversion(qty, specInfo)
  console.log(`${qty}粒 → ${display}`)
})
```

**预期结果**:
```
48粒 → 48粒 (2盒)
42粒 → 42粒 (1盒零18粒)
18粒 → 18粒 (0.75盒)
102粒 → 102粒 (4盒零6粒)
```

---

## 🧪 测试阶段二：入库流程测试（20分钟）

### 测试2.1：创建入库单（包装单位）

**测试数据**:
```javascript
const testDrug = {
  drugId: 'test_drug_001',
  drugName: '阿莫西林胶囊（测试）',
  specification: '0.25g×24粒/盒',
  manufacturer: '测试制药',
  batch: 'TEST20251106',
  productionDate: '2025-11-01',
  expireDate: '2027-11-01',
  quantity: 10,          // 10盒（包装单位）
  unit: '盒',
  price: 12.5
}
```

**操作步骤**:

1. **进入入库页面**
   ```
   pages-sub/in/add.vue
   ```

2. **填写入库信息**
   - 供应商: 测试供应商
   - 选择药材: 阿莫西林胶囊（测试）
   - 批号: TEST20251106
   - 生产日期: 2025-11-01
   - 有效期: 2027-11-01
   - 数量: **10盒** ⭐
   - 单价: 12.5元

3. **操作员签名**

4. **提交复核**

**验证点**:

```javascript
// 1. 查看入库记录
wx.cloud.database().collection('in_records')
  .where({ recordNo: 'RK20251106XXX' })
  .get()
  .then(res => {
    const record = res.data[0]
    console.log('入库单号:', record.recordNo)
    console.log('药材数量:', record.items[0].quantity, record.items[0].unit)
    console.log('状态:', record.status)
    
    // 验证
    console.log('✅ 数量正确:', record.items[0].quantity === 10)
    console.log('✅ 单位正确:', record.items[0].unit === '盒')
  })
```

---

### 测试2.2：复核入库单（生成库存）

**操作步骤**:

1. **进入待复核列表**
2. **选择测试入库单**
3. **复核员签名**
4. **通过复核**

**验证点（关键）**:

```javascript
// 查看药库库存
wx.cloud.database().collection('stock')
  .where({ 
    batch: 'TEST20251106',
    location: 'drug_storage'  // 药库 ⭐
  })
  .get()
  .then(res => {
    const stock = res.data[0]
    console.log('━'.repeat(50))
    console.log('【药库库存验证】')
    console.log('━'.repeat(50))
    console.log('位置:', stock.location)
    console.log('数量:', stock.quantity, stock.unit)
    console.log('规格信息:', stock.specInfo)
    console.log('最小单位单价:', stock.pricePerMin)
    
    // 验证
    console.log('✅ 位置正确:', stock.location === 'drug_storage')
    console.log('✅ 数量正确:', stock.quantity === 10)
    console.log('✅ 单位正确:', stock.unit === '盒')
    console.log('✅ specInfo存在:', !!stock.specInfo)
    console.log('✅ 转换率:', stock.specInfo?.conversionRate === 24)
    console.log('✅ 最小单位单价:', stock.pricePerMin === 0.52)
    console.log('━'.repeat(50))
  })
```

**预期结果**:
```
【药库库存验证】
位置: drug_storage
数量: 10 盒
规格信息: { conversionRate: 24, minUnit: '粒', packUnit: '盒', ... }
最小单位单价: 0.5208333333333334

✅ 位置正确: true
✅ 数量正确: true
✅ 单位正确: true
✅ specInfo存在: true
✅ 转换率: true
✅ 最小单位单价: true
```

---

## 🧪 测试阶段三：出库流程测试（30分钟）⭐ 关键

### 测试3.1：创建出库单（自动转换）

**测试数据**:
```javascript
const outboundTest = {
  fromLocation: 'drug_storage',  // 从药库
  toLocation: 'land_park',       // 到陆园
  drugInfo: {
    drugId: 'test_drug_001',
    drugName: '阿莫西林胶囊（测试）',
    specification: '0.25g×24粒/盒',
    batch: 'TEST20251106',
    quantity: 2                   // 出库2盒 ⭐
  }
}
```

**操作步骤**:

1. **进入出库页面**
   ```
   pages-sub/out/add.vue
   ```

2. **填写出库信息**
   - 出库园区: **陆园医务室** ⭐
   - 选择药材: 阿莫西林胶囊（测试）
   - 批号: TEST20251106
   - 出库数量: **2盒** ⭐（用户输入包装单位）

3. **查看转换提示**
   - 应显示: "出库2盒 → 自动转换48粒 → 园区+48粒"

4. **签名**
   - 发药人签名
   - 领药人签名
   - 复核人签名

5. **提交完成**

**验证点1: 出库记录**

```javascript
wx.cloud.database().collection('out_records')
  .where({ recordNo: 'CK20251106XXX' })
  .get()
  .then(res => {
    const record = res.data[0]
    const item = record.items[0]
    
    console.log('━'.repeat(50))
    console.log('【出库记录验证】')
    console.log('━'.repeat(50))
    console.log('从:', record.fromLocation)
    console.log('到:', record.toLocation)
    console.log('包装数量:', item.packQuantity, item.packUnit)
    console.log('最小数量:', item.minQuantity, item.minUnit)
    console.log('转换率:', item.specInfo?.conversionRate)
    console.log('库存变化:')
    console.log('  药库: ', item.drugStorageBefore, '→', item.drugStorageAfter)
    console.log('  园区: ', item.parkBefore, '→', item.parkAfter)
    
    // 验证
    console.log('✅ 包装数量:', item.packQuantity === 2)
    console.log('✅ 最小数量:', item.minQuantity === 48)
    console.log('✅ 转换正确:', item.minQuantity === item.packQuantity * 24)
    console.log('✅ 药库扣减:', item.drugStorageBefore - item.drugStorageAfter === 2)
    console.log('✅ 园区增加:', item.parkAfter - item.parkBefore === 48)
    console.log('━'.repeat(50))
  })
```

**预期结果**:
```
【出库记录验证】
从: drug_storage
到: land_park
包装数量: 2 盒
最小数量: 48 粒
转换率: 24
库存变化:
  药库:  10 → 8
  园区:  0 → 48

✅ 包装数量: true
✅ 最小数量: true
✅ 转换正确: true
✅ 药库扣减: true
✅ 园区增加: true
```

---

### 测试3.2：验证库存变化（关键）⭐

**验证点2: 药库库存**

```javascript
wx.cloud.database().collection('stock')
  .where({ 
    batch: 'TEST20251106',
    location: 'drug_storage'
  })
  .get()
  .then(res => {
    const stock = res.data[0]
    console.log('━'.repeat(50))
    console.log('【药库库存验证】')
    console.log('━'.repeat(50))
    console.log('位置:', stock.location)
    console.log('数量:', stock.quantity, stock.unit)
    console.log('预期:', '8盒')
    console.log('✅ 正确扣减:', stock.quantity === 8)
    console.log('━'.repeat(50))
  })
```

**验证点3: 园区库存（关键）⭐**

```javascript
wx.cloud.database().collection('stock')
  .where({ 
    batch: 'TEST20251106',
    location: 'land_park'  // 陆园 ⭐
  })
  .get()
  .then(res => {
    const stock = res.data[0]
    console.log('━'.repeat(50))
    console.log('【园区库存验证】')
    console.log('━'.repeat(50))
    console.log('位置:', stock.location)
    console.log('数量:', stock.quantity, stock.unit)
    console.log('规格信息:', stock.specInfo)
    console.log('预期:', '48粒')
    
    // 验证
    console.log('✅ 位置正确:', stock.location === 'land_park')
    console.log('✅ 数量正确:', stock.quantity === 48)
    console.log('✅ 单位正确:', stock.unit === '粒')  // 最小单位 ⭐
    console.log('✅ specInfo存在:', !!stock.specInfo)
    
    // 格式化显示
    const display = UnitConverter.formatStockDisplay(stock)
    console.log('显示:', display)
    console.log('预期:', '48粒 (2盒)')
    console.log('━'.repeat(50))
  })
```

**预期结果**:
```
【园区库存验证】
位置: land_park
数量: 48 粒
规格信息: { conversionRate: 24, minUnit: '粒', packUnit: '盒' }
预期: 48粒

✅ 位置正确: true
✅ 数量正确: true
✅ 单位正确: true (最小单位：粒)
✅ specInfo存在: true

显示: 48粒 (2盒)
预期: 48粒 (2盒)
```

---

## 🧪 测试阶段四：门诊消耗测试（20分钟）

### 测试4.1：记录门诊用药（直接扣减）

**测试数据**:
```javascript
const clinicTest = {
  location: 'land_park',
  drugInfo: {
    drugId: 'test_drug_001',
    drugName: '阿莫西林胶囊（测试）',
    batch: 'TEST20251106',
    quantity: 6           // 用药6粒 ⭐（直接用最小单位）
  }
}
```

**操作步骤**:

1. **进入门诊页面**
2. **填写患者信息**
3. **选择用药**
   - 药材: 阿莫西林胶囊（测试）
   - 用量: **6粒** ⭐（直接输入最小单位）
4. **保存记录**

**验证点: 园区库存扣减**

```javascript
wx.cloud.database().collection('stock')
  .where({ 
    batch: 'TEST20251106',
    location: 'land_park'
  })
  .get()
  .then(res => {
    const stock = res.data[0]
    console.log('━'.repeat(50))
    console.log('【门诊消耗验证】')
    console.log('━'.repeat(50))
    console.log('消耗前: 48粒')
    console.log('消耗量: 6粒')
    console.log('消耗后:', stock.quantity, stock.unit)
    console.log('预期: 42粒')
    
    // 验证
    console.log('✅ 直接扣减:', stock.quantity === 42)  // 48 - 6 = 42
    console.log('✅ 无需转换:', stock.unit === '粒')
    
    // 格式化显示
    const display = UnitConverter.formatStockDisplay(stock)
    console.log('显示:', display)
    console.log('预期:', '42粒 (1盒零18粒)')
    console.log('━'.repeat(50))
  })
```

**预期结果**:
```
【门诊消耗验证】
消耗前: 48粒
消耗量: 6粒
消耗后: 42 粒
预期: 42粒

✅ 直接扣减: true
✅ 无需转换: true

显示: 42粒 (1盒零18粒)
预期: 42粒 (1盒零18粒)
```

---

### 测试4.2：再次消耗测试

**操作**: 再次记录用药12粒

**验证**: 库存应变为 30粒

```javascript
// 验证
console.log('消耗前: 42粒')
console.log('消耗量: 12粒')
console.log('消耗后: 30粒')
console.log('显示: 30粒 (1盒零6粒)')
```

---

## 🧪 测试阶段五：库存显示测试（15分钟）

### 测试5.1：药库库存显示

**验证**: 药库应显示包装单位（简洁）

```javascript
// 查询药库库存
const drugStorageStock = await db.collection('stock')
  .where({ location: 'drug_storage' })
  .get()

drugStorageStock.data.forEach(stock => {
  const display = UnitConverter.formatStockDisplay(stock)
  console.log(`${stock.drugName}: ${display}`)
  // 预期: "阿莫西林胶囊: 8盒"
})
```

---

### 测试5.2：园区库存显示（智能换算）

**验证**: 园区应显示最小单位+换算

```javascript
// 查询园区库存
const parkStock = await db.collection('stock')
  .where({ location: 'land_park' })
  .get()

parkStock.data.forEach(stock => {
  const display = UnitConverter.formatStockDisplay(stock)
  console.log(`${stock.drugName}: ${display}`)
  // 预期: "阿莫西林胶囊: 30粒 (1盒零6粒)"
})
```

---

## 📊 测试结果汇总

### 测试清单

| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| **工具类测试** | | | |
| 1.1 规格解析（4种模式） | 全部通过 | ___ | [ ] |
| 1.2 单位转换（双向） | 计算准确 | ___ | [ ] |
| 1.3 格式化显示 | 显示正确 | ___ | [ ] |
| **入库流程测试** | | | |
| 2.1 创建入库单 | 包装单位 | ___ | [ ] |
| 2.2 复核入库 | 药库库存+10盒 | ___ | [ ] |
| 2.3 specInfo生成 | 自动生成 | ___ | [ ] |
| **出库流程测试（关键）** | | | |
| 3.1 创建出库单 | 自动转换 | ___ | [ ] |
| 3.2 药库库存扣减 | -2盒（8盒） | ___ | [ ] |
| 3.3 园区库存增加 | +48粒 | ___ | [ ] |
| 3.4 双单位记录 | 完整记录 | ___ | [ ] |
| **门诊消耗测试** | | | |
| 4.1 第一次消耗 | -6粒（42粒） | ___ | [ ] |
| 4.2 第二次消耗 | -12粒（30粒） | ___ | [ ] |
| 4.3 直接扣减 | 无需转换 | ___ | [ ] |
| **显示测试** | | | |
| 5.1 药库显示 | "8盒" | ___ | [ ] |
| 5.2 园区显示 | "30粒 (1盒零6粒)" | ___ | [ ] |

---

## 🔍 常见问题排查

### 问题1: 规格解析返回 null

**症状**: `UnitConverter.parseSpecification()` 返回 null

**排查**:
```javascript
const spec = '你的规格字符串'
console.log('规格:', spec)
console.log('类型:', typeof spec)
console.log('长度:', spec.length)
console.log('首字符:', spec.charCodeAt(0))

// 尝试清理
const cleaned = spec.trim().replace(/×/g, '×').replace(/／/g, '/')
const result = UnitConverter.parseSpecification(cleaned)
console.log('清理后:', result)
```

---

### 问题2: 出库后园区库存为0

**症状**: 出库完成但园区没有库存

**排查**:
```javascript
// 1. 检查出库记录
const outRecord = await db.collection('out_records')
  .where({ recordNo: '出库单号' })
  .get()

console.log('fromLocation:', outRecord.data[0].fromLocation)
console.log('toLocation:', outRecord.data[0].toLocation)
console.log('minQuantity:', outRecord.data[0].items[0].minQuantity)

// 2. 检查园区库存
const parkStock = await db.collection('stock')
  .where({ 
    drugId: outRecord.data[0].items[0].drugId,
    location: outRecord.data[0].toLocation
  })
  .get()

console.log('园区库存记录:', parkStock.data)
```

---

### 问题3: 显示格式不对

**症状**: 库存显示没有换算提示

**排查**:
```javascript
const stock = await db.collection('stock').doc('库存ID').get()

console.log('location:', stock.data.location)
console.log('quantity:', stock.data.quantity)
console.log('unit:', stock.data.unit)
console.log('specInfo:', stock.data.specInfo)

// 测试显示
const display = UnitConverter.formatStockDisplay(stock.data)
console.log('显示:', display)
```

---

## ✅ 测试通过标准

### 必须满足的条件

1. **工具类**
   - ✅ 所有规格格式正确解析
   - ✅ 转换计算准确无误
   - ✅ 显示格式符合设计

2. **入库流程**
   - ✅ 统一入库到药库
   - ✅ 使用包装单位存储
   - ✅ 自动生成 specInfo

3. **出库流程（关键）**
   - ✅ 用户输入包装单位
   - ✅ 系统自动转换
   - ✅ 药库扣减包装单位
   - ✅ 园区增加最小单位
   - ✅ 双单位完整记录

4. **门诊消耗**
   - ✅ 直接扣减最小单位
   - ✅ 无需转换计算
   - ✅ 性能快速

5. **库存显示**
   - ✅ 药库显示包装单位
   - ✅ 园区显示最小单位+换算
   - ✅ 格式友好易读

---

## 📝 测试报告模板

```markdown
# v3.14 测试报告

**测试人员**: ___________
**测试日期**: ___________
**测试环境**: 微信开发者工具 / 真机

## 测试结果

### 工具类测试
- 规格解析: [ ] 通过 [ ] 失败
- 单位转换: [ ] 通过 [ ] 失败
- 格式化显示: [ ] 通过 [ ] 失败

### 业务流程测试
- 入库流程: [ ] 通过 [ ] 失败
- 出库流程: [ ] 通过 [ ] 失败
- 门诊消耗: [ ] 通过 [ ] 失败
- 库存显示: [ ] 通过 [ ] 失败

### 数据验证
- 药库库存正确: [ ] 是 [ ] 否
- 园区库存正确: [ ] 是 [ ] 否
- 单位转换正确: [ ] 是 [ ] 否
- 记录完整: [ ] 是 [ ] 否

## 发现的问题

1. 问题描述: _________________
   影响程度: [ ] 严重 [ ] 一般 [ ] 轻微
   
2. 问题描述: _________________
   影响程度: [ ] 严重 [ ] 一般 [ ] 轻微

## 测试结论

[ ] 测试通过，可以上线
[ ] 部分问题，需要修复
[ ] 测试失败，需要重测

## 测试人员签名

签名: ___________ 日期: ___________
```

---

**版本**: v3.14 Ultimate  
**测试时间**: 预计1-2小时  
**关键测试**: 出库流程（自动转换）

🎯 **测试重点**: 药库用包装，园区用最小，出库自动转换！

