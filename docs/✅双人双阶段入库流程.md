# ✅ 双人双阶段入库流程

## 📋 需求说明

### 问题
- 入库单录入和复核需要分开操作
- 操作员和复核人是不同的登录者
- 需要独立的复核页面

### 解决方案
实现**双人双阶段审批流程**：
1. **阶段1**：操作员录入 → 操作员签名 → 提交待复核
2. **阶段2**：复核人复核 → 复核人签名 → 通过入库/驳回

---

## 🔄 完整流程图

```
┌─────────────────────────────────────┐
│         阶段1: 操作员录入            │
└─────────────────────────────────────┘
              ↓
    操作员登录系统
              ↓
    首页 → 📦 新建入库单
              ↓
    扫码/搜索添加药品
              ↓
    填写批号、日期、数量
              ↓
    操作员签名 ✍️ (必填)
              ↓
    点击"提交复核"
              ↓
    状态: pending_review (待复核)
              ↓
┌─────────────────────────────────────┐
│         阶段2: 复核人复核            │
└─────────────────────────────────────┘
              ↓
    复核人登录系统
              ↓
    入库单列表 → 待复核标签
              ↓
    点击"去复核"按钮
              ↓
    进入复核页面
              ↓
    查看入库单明细
              ↓
    查看操作员签名
              ↓
    复核人签名 ✍️ (必填)
              ↓
    选择: 通过并入库 / 驳回
              ↓
    ┌─────────┴─────────┐
    ↓                   ↓
  通过                驳回
    ↓                   ↓
更新库存          返回操作员修改
    ↓                   ↓
状态: completed    状态: rejected
```

---

## 📱 界面设计

### 阶段1: 新建入库单页面 (操作员)

```
┌─────────────────────────────────────┐
│  药品入库          2025-11-08       │
├─────────────────────────────────────┤
│  单号: RK20251108001                │
│  操作人: 张三 (操作员)               │
│  供应商: [可选填]                    │
├─────────────────────────────────────┤
│  🔍 搜索/扫码药品        📷         │
├─────────────────────────────────────┤
│  药品列表 (新的在上)                 │
│  ┌─────────────────────────────┐   │
│  │ 阿莫西林胶囊          ✕     │   │
│  │ 批号: 20240101              │   │
│  │ 生产: 2024-01-01            │   │
│  │ 效期: 2026-01-01 (365天)    │   │
│  │ 数量: 100 盒                │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  品种: 2种  数量: 150  金额: ¥3,200 │
├─────────────────────────────────────┤
│  ✍️ 操作员签名 *                    │
│  [已签名图片]                        │
├─────────────────────────────────────┤
│  [保存草稿]  [提交复核]             │
└─────────────────────────────────────┘
```

**特点**：
- ✅ 只有操作员签名
- ✅ 无复核人签名
- ✅ 提交后状态为"待复核"

---

### 阶段2: 入库单复核页面 (复核人)

```
┌─────────────────────────────────────┐
│  入库单复核        2025-11-08       │
├─────────────────────────────────────┤
│  单号: RK20251108001                │
│  状态: [待复核]                      │
│  操作人: 张三                        │
│  创建时间: 2025-11-08 10:30         │
│  供应商: XX医药公司                  │
├─────────────────────────────────────┤
│  📦 药品明细             共 2 种     │
│  ┌─────────────────────────────┐   │
│  │ 阿莫西林胶囊          ①     │   │
│  │ 0.25g×24粒/盒               │   │
│  │ 批号: 20240101              │   │
│  │ 生产: 2024-01-01            │   │
│  │ 效期: 2026-01-01 (365天)    │   │
│  │ 数量: 100 盒                │   │
│  │ 单价: ¥15.00                │   │
│  │ 金额: ¥1,500.00             │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  ✍️ 操作员签名                      │
│  [操作员签名图片]                    │
│  签名人: 张三                        │
│  签名时间: 2025-11-08 10:35         │
├─────────────────────────────────────┤
│  品种: 2种  数量: 150  金额: ¥3,200 │
├─────────────────────────────────────┤
│  ✍️ 复核人签名 *                    │
│  [点击此处签名]                      │
├─────────────────────────────────────┤
│  [驳回]  [通过并入库]               │
└─────────────────────────────────────┘
```

**特点**：
- ✅ 显示完整入库单信息
- ✅ 显示操作员签名
- ✅ 复核人签名区域
- ✅ 通过/驳回按钮

---

## 🎯 功能特点

### 阶段1: 操作员录入

| 功能 | 说明 |
|------|------|
| 药品录入 | 扫码/搜索添加，新药品在最上方 |
| 信息填写 | 批号、日期、数量等必填项 |
| 操作员签名 | 必填，全屏竖屏签名 |
| 提交 | 提交后状态为"待复核" |
| 保存草稿 | 可保存未完成的入库单 |

### 阶段2: 复核人复核

| 功能 | 说明 |
|------|------|
| 查看明细 | 完整显示药品信息 |
| 查看签名 | 显示操作员签名和时间 |
| 复核签名 | 必填，全屏竖屏签名 |
| 通过入库 | 更新库存，状态变为"已完成" |
| 驳回 | 需填写驳回原因，返回操作员修改 |

---

## 📂 文件结构

### 新增文件
```
pages-sub/in/
├── add.vue          # 新建入库单 (操作员)
├── review.vue       # 入库单复核 (复核人) ⭐ 新增
├── list.vue         # 入库单列表
└── detail.vue       # 入库单详情
```

### 修改文件
```
pages-sub/in/add.vue     # 移除复核人签名
pages-sub/in/list.vue    # 修改"去复核"跳转
pages.json               # 添加review页面路由
```

---

## 🔐 权限控制

### 操作员权限
- ✅ 新建入库单
- ✅ 填写药品信息
- ✅ 操作员签名
- ✅ 提交待复核
- ✅ 查看自己的入库单

### 复核人权限
- ✅ 查看待复核入库单
- ✅ 查看入库单明细
- ✅ 复核签名
- ✅ 通过入库
- ✅ 驳回入库单

---

## 📊 状态流转

### 入库单状态

| 状态 | 说明 | 可操作 |
|------|------|--------|
| draft | 草稿 | 操作员继续编辑 |
| pending_review | 待复核 | 复核人复核 |
| completed | 已完成 | 查看详情 |
| rejected | 已驳回 | 操作员修改后重新提交 |

### 状态转换
```
draft (草稿)
  ↓ 操作员提交
pending_review (待复核)
  ↓
  ├→ 复核人通过 → completed (已完成)
  └→ 复核人驳回 → rejected (已驳回)
                      ↓ 操作员修改
                 pending_review (待复核)
```

---

## 🚀 使用流程

### 操作员操作流程

1. **登录系统**
   - 使用操作员账号登录

2. **新建入库单**
   - 首页点击 "📦 新建入库单"
   - 或 "入库管理" → "+" 按钮

3. **录入药品**
   - 扫码/搜索添加药品
   - 填写批号、日期、数量
   - 可添加多个药品

4. **操作员签名**
   - 点击签名框
   - 全屏签名
   - 确认保存

5. **提交复核**
   - 检查信息无误
   - 点击"提交复核"
   - 等待复核人审批

### 复核人操作流程

1. **登录系统**
   - 使用复核人账号登录

2. **查看待复核单据**
   - 首页 → "入库管理"
   - 点击"待复核"标签
   - 查看待复核列表

3. **进入复核页面**
   - 点击入库单
   - 点击"去复核"按钮

4. **查看明细**
   - 查看药品信息
   - 查看操作员签名
   - 核对数据准确性

5. **复核签名**
   - 点击签名框
   - 全屏签名
   - 确认保存

6. **做出决定**
   - **通过**：点击"通过并入库" → 更新库存
   - **驳回**：点击"驳回" → 填写驳回原因

---

## ⚠️ 注意事项

### 操作员注意
1. ✅ 确保药品信息准确
2. ✅ 批号、日期必须填写
3. ✅ 操作员签名必须完成
4. ✅ 提交前仔细检查
5. ❌ 不能自己复核自己的单据

### 复核人注意
1. ✅ 仔细核对药品信息
2. ✅ 检查批号、效期是否正确
3. ✅ 复核人签名必须完成
4. ✅ 驳回时必须说明原因
5. ❌ 通过后不可撤销

---

## 🔍 常见问题

### Q1: 操作员可以自己复核吗？
**A**: 不建议。系统设计为双人复核机制，操作员和复核人应该是不同的人。

### Q2: 驳回后如何处理？
**A**: 
1. 操作员在入库单列表看到"已驳回"状态
2. 点击查看驳回原因
3. 修改后重新提交复核

### Q3: 复核人签名后可以修改吗？
**A**: 不可以。复核签名后点击"通过并入库"即完成入库，库存会立即更新。

### Q4: 如何查看历史入库单？
**A**: 
- 入库管理 → 入库单列表
- 选择对应状态标签
- 点击单据查看详情

### Q5: 复核页面可以修改药品信息吗？
**A**: 不可以。复核页面只能查看和签名，不能修改。如需修改，应驳回让操作员修改。

---

## 📱 快速访问

### 操作员入口
```
首页 → 📦 新建入库单
```

### 复核人入口
```
首页 → 入库管理 → 待复核 → 去复核
```

---

## 🎨 界面特点

### 新建入库单页面
- 🎨 简洁清晰
- ✍️ 只有操作员签名
- 📦 新药品在最上方
- 💾 可保存草稿

### 复核页面
- 📋 完整显示明细
- 👁️ 只读模式
- ✍️ 显示操作员签名
- ✅ 复核人签名区域
- 🔘 通过/驳回按钮

---

## 📊 数据流

### 提交入库单
```javascript
{
  recordNo: 'RK20251108001',
  operator: '张三',
  operatorId: 'user_001',
  operatorSign: 'cloud://sign_001.png',
  operatorSignTime: '2025-11-08T10:35:00',
  supplier: 'XX医药公司',
  items: [...],
  status: 'pending_review'  // 待复核
}
```

### 复核通过
```javascript
{
  _id: 'record_001',
  reviewer: '李四',
  reviewerId: 'user_002',
  reviewerSign: 'cloud://sign_002.png',
  reviewerSignTime: '2025-11-08T11:00:00',
  status: 'completed'  // 已完成
}
```

### 复核驳回
```javascript
{
  _id: 'record_001',
  reviewer: '李四',
  reviewerId: 'user_002',
  reviewerSign: 'cloud://sign_002.png',
  reviewerSignTime: '2025-11-08T11:00:00',
  rejectReason: '批号填写不规范',
  status: 'rejected'  // 已驳回
}
```

---

## ✅ 完成清单

- [x] 修改新建入库单页面（移除复核人签名）
- [x] 创建独立的复核页面
- [x] 添加页面路由配置
- [x] 修改列表页面跳转
- [x] 实现双人双阶段流程
- [x] 通过/驳回功能
- [x] 签名功能完整
- [x] 状态流转正确

---

## 🎉 总结

**双人双阶段入库流程已完成！**

### 核心优势
1. ✅ **职责分离** - 录入和复核分开
2. ✅ **双人审批** - 提高数据准确性
3. ✅ **独立页面** - 操作清晰明确
4. ✅ **完整流程** - 从录入到入库
5. ✅ **可追溯** - 双签名记录

### 使用建议
- 操作员专注录入，确保数据准确
- 复核人仔细核对，把好质量关
- 驳回时说明原因，便于改进
- 定期查看历史记录，总结经验

---

**更新日期**：2025-11-08  
**版本**：v4.1  
**状态**：✅ 已完成

🎊 **双人双阶段入库流程，让入库更规范！**


