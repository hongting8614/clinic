# 🚀 云函数上传部署指南

## 📋 需要上传的云函数清单

### ✅ 新增云函数（必须上传）

1. **`changePassword`** - 修改密码
2. **`updateMyInfo`** - 更新个人信息（实名）
3. **`sendResetPasswordCode`** - 发送密码重置验证码
4. **`verifyResetPasswordCode`** - 验证密码重置验证码
5. **`resetPassword`** - 重置密码

### 🔄 更新的云函数（需要重新上传）

1. **`addUser`** - 添加用户（已添加实名和密码支持）
2. **`updateUser`** - 更新用户（已添加实名支持）
3. **`login`** - 登录（已添加实名返回）
4. **`getUserList`** - 获取用户列表（已添加实名返回和权限更新）

---

## 📝 上传步骤（详细版）

### 方法一：微信开发者工具上传（推荐）

#### 步骤1：打开微信开发者工具

1. 打开微信开发者工具
2. 打开项目：`D:\AK-PMS`
3. 确保已登录微信小程序账号

#### 步骤2：上传新增云函数

**逐个上传以下云函数：**

##### 1️⃣ `changePassword` - 修改密码

1. 在左侧文件树中找到 `cloudfunctions/changePassword` 文件夹
2. **右键点击** `changePassword` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待上传完成（约20-30秒）
5. 看到提示 "上传成功" 即可

##### 2️⃣ `updateMyInfo` - 更新个人信息

1. 找到 `cloudfunctions/updateMyInfo` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 3️⃣ `sendResetPasswordCode` - 发送验证码

1. 找到 `cloudfunctions/sendResetPasswordCode` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 4️⃣ `verifyResetPasswordCode` - 验证验证码

1. 找到 `cloudfunctions/verifyResetPasswordCode` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 5️⃣ `resetPassword` - 重置密码

1. 找到 `cloudfunctions/resetPassword` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

#### 步骤3：重新上传更新的云函数

**需要重新上传以下云函数：**

##### 1️⃣ `addUser` - 添加用户

1. 找到 `cloudfunctions/addUser` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 2️⃣ `updateUser` - 更新用户

1. 找到 `cloudfunctions/updateUser` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 3️⃣ `login` - 登录

1. 找到 `cloudfunctions/login` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 4️⃣ `getUserList` - 获取用户列表

1. 找到 `cloudfunctions/getUserList` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

---

## ⚙️ 重要配置

### 1. 微信订阅消息模板配置（密码重置功能）

**⚠️ 重要：** `sendResetPasswordCode` 云函数需要配置微信订阅消息模板。

#### 步骤1：申请订阅消息模板

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **功能** → **订阅消息**
3. 点击 **公共模板库**
4. 搜索 **"验证码"** 或 **"密码重置"**
5. 选择合适的模板，点击 **选用**
6. 配置模板参数：
   - `thing1` - 操作类型（如：密码重置验证码）
   - `number2` - 验证码（6位数字）
   - `time3` - 时间
7. 复制 **模板ID**

#### 步骤2：更新云函数代码

1. 打开 `cloudfunctions/sendResetPasswordCode/index.js`
2. 找到这一行：
   ```javascript
   templateId: 'YOUR_TEMPLATE_ID' // TODO: 替换为实际的订阅消息模板ID
   ```
3. 替换为你的模板ID：
   ```javascript
   templateId: '你的模板ID' // 例如：'abc123def456ghi789'
   ```
4. **重新上传** `sendResetPasswordCode` 云函数

---

## 🧪 测试步骤

### 1. 测试修改密码功能

1. 进入小程序
2. 进入 **设置** → **修改密码**
3. 输入当前密码和新密码
4. 点击 **确认修改**
5. 检查是否成功

### 2. 测试修改实名功能

1. 进入 **设置** → 点击实名旁边的 **修改** 按钮
2. 输入真实姓名（2-10个中文字符）
3. 点击 **确认修改**
4. 检查是否成功

### 3. 测试密码重置功能

1. 进入 **设置** → **修改密码** → 点击 **忘记密码？**
2. 输入微信号
3. 点击 **发送验证码**
4. 查收微信订阅消息中的验证码
5. 输入验证码
6. 输入新密码
7. 点击 **确认重置密码**
8. 检查是否成功

---

## ⚠️ 常见问题

### 1. 上传失败：依赖安装失败

**解决方法：**
1. 检查 `package.json` 文件是否存在
2. 检查网络连接
3. 尝试使用 **"上传并部署：全部文件"** 选项

### 2. 云函数调用失败：函数不存在

**解决方法：**
1. 确认云函数已成功上传
2. 在云开发控制台检查云函数列表
3. 确认云函数名称拼写正确

### 3. 订阅消息发送失败

**可能原因：**
1. 模板ID未配置或配置错误
2. 用户未授权订阅消息
3. 模板参数格式不正确

**解决方法：**
1. 检查模板ID是否正确
2. 确保用户已授权订阅消息
3. 检查模板参数格式

### 4. 验证码发送失败：未找到用户

**可能原因：**
1. 用户表中没有 `wechatId` 字段
2. 用户未设置微信号

**解决方法：**
1. 在用户表中添加 `wechatId` 字段
2. 用户首次登录时设置微信号
3. 或通过管理员在用户管理页面设置微信号

---

## 📊 上传顺序建议

### 推荐顺序：

1. **先上传基础功能：**
   - `changePassword` - 修改密码
   - `updateMyInfo` - 更新个人信息

2. **再上传用户管理相关：**
   - `addUser` - 添加用户（更新版）
   - `updateUser` - 更新用户（更新版）
   - `login` - 登录（更新版）
   - `getUserList` - 获取用户列表（更新版）

3. **最后上传密码重置功能：**
   - `sendResetPasswordCode` - 发送验证码
   - `verifyResetPasswordCode` - 验证验证码
   - `resetPassword` - 重置密码

---

## ✅ 上传完成检查清单

- [ ] `changePassword` 已上传
- [ ] `updateMyInfo` 已上传
- [ ] `sendResetPasswordCode` 已上传（已配置模板ID）
- [ ] `verifyResetPasswordCode` 已上传
- [ ] `resetPassword` 已上传
- [ ] `addUser` 已重新上传
- [ ] `updateUser` 已重新上传
- [ ] `login` 已重新上传
- [ ] `getUserList` 已重新上传
- [ ] 所有云函数测试通过

---

## 🔍 验证上传成功

### 方法1：云开发控制台

1. 打开微信开发者工具
2. 点击 **云开发** 按钮
3. 进入 **云函数** 页面
4. 检查云函数列表，确认所有云函数都已存在

### 方法2：测试调用

1. 在小程序中测试相关功能
2. 查看控制台是否有错误
3. 检查云函数日志

---

## 📝 注意事项

1. **上传前检查：**
   - 确保代码没有语法错误
   - 确保 `package.json` 文件存在
   - 确保环境变量已配置（如需要）

2. **上传后验证：**
   - 测试每个云函数的功能
   - 检查云函数日志
   - 确认没有报错

3. **订阅消息配置：**
   - 必须在微信公众平台申请模板
   - 必须更新云函数中的模板ID
   - 用户必须授权订阅消息

4. **数据库字段：**
   - 确保用户表中有 `wechatId` 字段
   - 确保用户表中有 `realName` 字段
   - 确保用户表中有 `password` 字段

---

## 🎯 快速上传命令（可选）

如果你熟悉命令行，也可以使用以下命令：

```bash
# 进入项目目录
cd D:\AK-PMS

# 上传单个云函数（需要在微信开发者工具中执行）
# 或者使用微信开发者工具的右键菜单上传
```

---

**最后更新：** 2025-11-09  
**版本：** v1.0

