# ☁️ 云函数部署指南

**版本**: v3.5  
**更新日期**: 2025-11-04

---

## 🎯 问题说明

当前测试遇到的错误：
```
Error: 加载失败
at list.vue:178
```

**原因**: 云函数 `inRecords` 尚未上传到云开发环境，或者云函数返回格式不匹配。

---

## 🚀 快速解决方案

### 方案1: 上传云函数（推荐）

#### 步骤1: 在HBuilderX中右键上传

```bash
1. 在项目中找到 cloudfunctions/inRecords 文件夹
2. 右键点击 inRecords
3. 选择"上传并部署：云端安装依赖"
4. 等待上传完成
```

#### 步骤2: 或在微信开发者工具中上传

```bash
1. 打开微信开发者工具
2. 点击"云开发"按钮
3. 进入"云函数"标签
4. 点击"上传云函数"
5. 选择 cloudfunctions/inRecords
6. 等待上传完成
```

#### 步骤3: 验证云函数

```bash
1. 在云开发控制台 -> 云函数列表
2. 找到 inRecords
3. 点击"测试"
4. 输入测试数据:
{
  "action": "getCounts",
  "data": {}
}
5. 点击"运行测试"
6. 查看返回结果
```

---

### 方案2: 使用模拟数据（临时）

如果暂时无法上传云函数，可以使用模拟数据进行UI测试。

#### 修改 `pages-sub/in/list.vue`

在 `loadRecords` 方法中添加模拟数据：

```javascript
async loadRecords() {
  uni.showLoading({ title: '加载中...' })
  
  try {
    // 临时使用模拟数据
    const mockData = [
      {
        _id: 'in_001',
        recordNo: 'RK20251104001',
        status: 'pending_review',
        operator: '张三',
        operatorId: 'user_001',
        createTime: '2025-11-04 10:00:00',
        supplier: 'XX医药公司',
        items: [
          { drugName: '阿莫西林胶囊', spec: '0.25g*24粒', quantity: 100 }
        ]
      }
    ]
    
    // 注释掉云函数调用
    // const result = await this.$api.callFunction('inRecords', { ... })
    
    // 使用模拟数据
    const result = {
      success: true,
      data: mockData
    }
    
    if (result.success) {
      const newData = result.data || []
      this.recordList = this.page === 1 ? newData : [...this.recordList, ...newData]
      this.hasMore = newData.length >= this.pageSize
    }
    
    uni.hideLoading()
  } catch (err) {
    console.error('加载失败:', err)
    uni.hideLoading()
    uni.showToast({
      title: err.message || '加载失败',
      icon: 'none'
    })
  }
}
```

---

## 📋 需要上传的云函数列表

### 1. inRecords（入库单管理）
**位置**: `cloudfunctions/inRecords/`

**功能**:
- 创建入库单（create）
- 更新入库单（update）
- 删除入库单（delete）
- 获取列表（getList）
- 获取详情（getDetail）
- 复核通过（approve）
- 复核驳回（reject）
- 获取数量统计（getCounts）

**是否已上传**: ❌（需要上传）

---

### 2. drugManage（药材管理）
**位置**: `cloudfunctions/drugManage/`（如果存在）

**功能**:
- 根据条形码查询药材（getByBarcode）
- 用于扫码功能

**是否已上传**: ❓（检查是否存在此云函数）

---

## 🔧 云函数上传步骤详解

### 在HBuilderX中上传

#### 步骤1: 配置云服务空间
```bash
1. 打开项目
2. 右键点击 cloudfunctions 文件夹
3. 选择"关联云服务空间或项目"
4. 选择已创建的云服务空间（cloud1-3gv7spppf7d2d0f4）
5. 点击确定
```

#### 步骤2: 上传云函数
```bash
1. 右键点击 cloudfunctions/inRecords
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成（可能需要1-2分钟）
4. 查看控制台输出，确认上传成功
```

#### 步骤3: 验证上传
```bash
1. 在HBuilderX控制台查看输出:
   "云函数 inRecords 上传成功"
2. 或在微信开发者工具 -> 云开发 -> 云函数
   确认 inRecords 出现在列表中
```

---

### 在微信开发者工具中上传

#### 方法1: 通过云开发控制台
```bash
1. 打开微信开发者工具
2. 点击顶部"云开发"按钮
3. 进入"云函数"标签
4. 点击"新建云函数"或"上传云函数"
5. 选择本地 cloudfunctions/inRecords 文件夹
6. 确认上传
```

#### 方法2: 通过右键菜单
```bash
1. 在微信开发者工具的文件树中
2. 找到 cloudfunctions/inRecords
3. 右键 -> 上传并部署：云端安装依赖
4. 等待完成
```

---

## 🧪 测试云函数

### 在云开发控制台测试

```bash
1. 打开云开发控制台
2. 云函数 -> inRecords -> 测试
3. 输入测试用例:
```

#### 测试用例1: 获取数量统计
```json
{
  "action": "getCounts",
  "data": {}
}
```

**期望返回**:
```json
{
  "success": true,
  "draft": 0,
  "pending_review": 0,
  "completed": 0,
  "rejected": 0,
  "all": 0,
  "today": 0
}
```

#### 测试用例2: 获取列表
```json
{
  "action": "getList",
  "data": {
    "status": "all",
    "page": 1,
    "pageSize": 10
  }
}
```

**期望返回**:
```json
{
  "success": true,
  "data": [],
  "total": 0
}
```

---

## ❓ 常见问题

### Q1: 云函数上传失败
**A**: 
1. 检查网络连接
2. 检查云服务空间是否已创建
3. 检查HBuilderX是否已关联云服务空间
4. 尝试重新登录微信开发者工具

### Q2: 云函数调用失败
**A**:
1. 检查云函数是否已上传
2. 检查云函数权限配置
3. 查看云函数日志（云开发控制台 -> 云函数 -> 日志）
4. 检查云函数代码是否有语法错误

### Q3: 数据库权限问题
**A**:
```bash
1. 打开云开发控制台
2. 数据库 -> 数据库设置
3. 权限设置 -> 修改为"所有用户可读写"（仅测试环境）
4. 或添加自定义权限规则
```

### Q4: 环境ID不匹配
**A**:
```javascript
// 检查 App.vue 中的环境ID
wx.cloud.init({
  env: 'cloud1-3gv7spppf7d2d0f4',
  traceUser: true
})

// 确保与云开发控制台中的环境ID一致
```

---

## ✅ 验证清单

上传云函数后，请验证：

- [ ] **云函数列表中显示 inRecords**
- [ ] **测试用例运行成功**
- [ ] **返回数据格式正确**
- [ ] **入库单列表页加载成功（无错误）**
- [ ] **可以创建入库单**
- [ ] **可以查看入库单详情**

---

## 🎯 下一步

云函数部署完成后：

1. **重新编译项目**
2. **测试入库单列表** - 应该显示空列表或已有数据
3. **测试新建入库单** - 创建并提交
4. **查看云数据库** - 确认数据已保存

---

## 📝 快速命令参考

```bash
# HBuilderX快捷操作
右键 cloudfunctions/inRecords -> 上传并部署：云端安装依赖

# 查看云函数日志
云开发控制台 -> 云函数 -> inRecords -> 日志

# 测试云函数
云开发控制台 -> 云函数 -> inRecords -> 测试

# 查看数据库
云开发控制台 -> 数据库 -> in_records
```

---

**部署完成后即可继续测试！** 🚀









