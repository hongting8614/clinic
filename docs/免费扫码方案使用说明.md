# 免费药材扫码方案使用说明

## 🎯 方案特点

### **✅ 完全免费**
- 不依赖任何付费API
- 使用国家药监局官方数据（NMPA）
- 长期可持续使用

### **✅ 数据权威**
- 药材数据来自国家药监局
- 批准文号、生产企业等信息准确
- 比付费API更可靠

### **✅ 越用越快**
- 首次录入后永久保存
- 建立条形码映射表
- 再次扫码立即识别

---

## 📊 查询流程

### **三级查询策略：**

```
扫描条形码
    ↓
【第1级】查询本地药材档案
    ↓ 未找到
【第2级】查询缓存数据库
    ↓ 未找到
【第3级】查询条形码映射表
    ↓ 未找到
【首次录入】智能引导用户
```

---

## 🚀 使用步骤

### **步骤1：批量导入常用药材** ⭐

**在小程序控制台运行：**

```javascript
// 打开 d:\AK-PMS\scripts\导入实际药材清单.js
// 复制全部内容到控制台运行

const db = wx.cloud.database()

const drugs = [
  {"name": "棉签", "specification": "2000支/包", "unit": "包"},
  {"name": "碘伏", "specification": "100ml/瓶", "unit": "瓶"},
  {"name": "海诺创可贴", "specification": "120片/盒", "unit": "盒"},
  // ... 32种药材
]

async function importRealDrugs() {
  // 批量导入逻辑
}

importRealDrugs()
```

**导入后：**
- ✅ 32种常用药材已入库
- ✅ 扫码可直接匹配
- ✅ 无需首次录入

---

### **步骤2：部署云函数** ⭐

**右键以下云函数 → 上传并部署：云端安装依赖**

1. `cloudfunctions/drugBarcodeQuery` - 条形码查询
2. `cloudfunctions/drugSearch` - 药材搜索

---

### **步骤3：开始使用** ⭐

#### **场景A：扫描已有药材**
```
扫码 → 立即识别 → 添加成功 ✅
```

#### **场景B：首次扫描新药材**
```
扫码 → 弹出选择框：

┌─────────────────────────┐
│  首次识别此条形码        │
├─────────────────────────┤
│ 1. 从已有药材中选择      │ ← 推荐！
│ 2. 输入药材名称          │
│ 3. 手动新建药材          │
└─────────────────────────┘
```

---

## 💡 三种录入方式详解

### **方式1：从已有药材中选择** ⭐⭐⭐（推荐）

**适用：**
- 已导入32种常用药材
- 药材已在系统中

**操作：**
1. 选择"从已有药材中选择"
2. 显示药材列表
3. 点击对应药材
4. 自动创建条形码映射
5. ✅ 完成！下次立即识别

**优势：**
- ⚡ 最快（3秒完成）
- ✅ 信息准确
- 🎯 推荐使用

---

### **方式2：输入药材名称** ⭐⭐

**适用：**
- 新药材，系统中没有
- 知道药材名称

**操作：**
1. 选择"输入药材名称"
2. 输入：布洛芬缓释胶囊
3. 自动查询NMPA（国家药监局）
4. 获取完整药材信息：
   - 批准文号 ✅
   - 生产企业 ✅
   - 批准日期 ✅
5. 自动创建映射
6. ✅ 完成！下次立即识别

**优势：**
- ✅ 数据权威（国家药监局）
- ✅ 信息完整
- ⏱️ 约10秒完成

---

### **方式3：手动新建药材** ⭐

**适用：**
- NMPA查不到（非药材、特殊药材）
- 需要自定义信息

**操作：**
1. 选择"手动新建药材"
2. 填写药材信息：
   - 药材名称 *
   - 规格
   - 单位 *
   - 生产厂商
   - 批准文号
   - 处方药类型
3. 保存
4. ✅ 完成！下次立即识别

**优势：**
- 🎯 完全自定义
- ✅ 适用所有情况

---

## 📋 实际操作示例

### **示例1：扫描布洛芬（首次）**

```
1. 点击"扫码"按钮
2. 扫描布洛芬条形码：6936435555607
3. 弹出选择框
4. 选择"输入药材名称"
5. 输入"布洛芬缓释胶囊"
6. 系统查询NMPA...
7. 显示结果：
   ✅ 药材名称：布洛芬缓释胶囊
   ✅ 生产企业：XX制药有限公司
   ✅ 批准文号：国药准字H...
8. 确认后自动添加到入库列表
9. ✅ 下次扫这个条形码，立即识别！
```

**首次耗时：** 约10秒  
**以后耗时：** < 1秒

---

### **示例2：扫描已导入药材**

```
1. 点击"扫码"按钮
2. 扫描碘伏条形码
3. ✅ 立即识别（已在32种药材中）
4. 自动添加到入库列表
```

**耗时：** < 1秒

---

### **示例3：扫描新药材（从已有药材选择）**

```
1. 点击"扫码"按钮
2. 扫描新条形码
3. 弹出选择框
4. 选择"从已有药材中选择"
5. 显示药材列表（32种）
6. 点击"布洛芬缓释胶囊"
7. ✅ 关联成功
8. 下次扫码立即识别
```

**首次耗时：** 约3秒  
**以后耗时：** < 1秒

---

## 🎯 使用技巧

### **技巧1：提前批量录入**

```
优势：
- 扫码立即识别
- 无需首次录入
- 体验最佳

操作：
1. 导入32种常用药材（已提供脚本）
2. 或手动添加常用药材到系统
3. 以后扫码都能立即识别
```

---

### **技巧2：优先选择已有药材**

```
好处：
- ⚡ 最快（3秒）
- ✅ 信息准确
- 💯 推荐

场景：
扫码后 → 选择"从已有药材中选择" → 快速关联
```

---

### **技巧3：使用语音输入**

```
场景：输入药材名称时

操作：
1. 点击输入框
2. 点击键盘上的"语音"按钮
3. 说出药材名称
4. ✅ 自动识别填入
```

---

### **技巧4：善用搜索功能**

```
选择已有药材时：
1. 列表顶部有搜索框
2. 输入药材名称关键词
3. 快速定位药材
```

---

## 📊 数据积累效果

### **使用越久，越方便：**

```
第1周：
- 录入20个新条形码
- 首次录入：10秒/个
- 再次扫码：<1秒

第2周：
- 录入15个新条形码
- 已有20个可立即识别

第3周：
- 录入10个新条形码
- 已有35个可立即识别

第4周：
- 录入5个新条形码
- 已有45个可立即识别 ✅

越用越快！
```

---

## 🔍 数据查询来源

### **1. 本地药材档案（drugs表）**
```
来源：手动添加、批量导入
优势：最快（本地查询）
数据：完整（所有字段）
```

### **2. 缓存数据库（barcode_cache）**
```
来源：之前的查询结果
优势：快速（已缓存）
数据：完整
```

### **3. 条形码映射表（barcode_mapping）**
```
来源：首次录入时创建
优势：永久保存
数据：完整
```

### **4. NMPA官方（首次录入时）**
```
来源：国家药监局
优势：权威、免费
数据：
  ✅ 药材名称
  ✅ 批准文号
  ✅ 生产企业
  ✅ 批准日期
```

---

## ✅ 系统优势

### **vs 付费API方案：**

| 对比项 | 付费API | 免费方案 ⭐ |
|--------|---------|-----------|
| **成本** | 💰 持续付费 | ✅ 完全免费 |
| **数据来源** | 第三方商业数据 | 国家药监局 |
| **数据准确性** | 一般 | ✅ 最权威 |
| **规格单位** | ❌ 经常缺失 | ✅ 完整 |
| **批准文号** | ❌ 无 | ✅ 有 |
| **首次识别** | 可能即时 | 需10秒录入 |
| **再次识别** | 需查询API | ✅ 立即识别 |
| **长期成本** | 持续增加 | ✅ 零成本 |
| **可持续性** | API可能停服 | ✅ 永久可用 |

---

## 🆘 常见问题

### **Q1：首次录入太慢？**

**A：** 
- 提前批量导入常用药材（32种）
- 选择"从已有药材中选择"（3秒）
- 录入一次，终身受益

---

### **Q2：NMPA查不到药材？**

**A：** 
- 选择"手动新建药材"
- 自己填写完整信息
- 同样可以建立映射

---

### **Q3：如何查看已录入的条形码？**

**A：** 
在控制台运行：
```javascript
wx.cloud.database()
  .collection('barcode_mapping')
  .get()
  .then(res => {
    console.log('已录入', res.data.length, '个条形码')
    res.data.forEach((item, i) => {
      console.log(`${i+1}. ${item.drugName} - ${item.barcode}`)
    })
  })
```

---

### **Q4：可以导出条形码库吗？**

**A：** 
可以！在云开发控制台：
1. 进入数据库
2. 打开 `barcode_mapping` 集合
3. 点击"导出"
4. 选择导出格式（CSV/JSON）

---

### **Q5：如何重置某个条形码？**

**A：** 
在控制台运行：
```javascript
// 删除指定条形码映射
wx.cloud.database()
  .collection('barcode_mapping')
  .where({ barcode: '6936435555607' })
  .remove()
  .then(() => {
    console.log('✅ 已删除，下次扫码可重新录入')
  })
```

---

## 📞 技术支持

### **相关文档：**
- 📄 `cloudfunctions/drugBarcodeQuery/README.md` - 云函数说明
- 📄 `docs/微信扫码API使用说明.md` - 扫码API文档
- 📄 `scripts/导入实际药材清单.js` - 批量导入脚本

### **数据库集合：**
- `drugs` - 药材档案
- `barcode_cache` - 查询缓存
- `barcode_mapping` - 条形码映射表

---

## 🎉 总结

### **免费方案特点：**

✅ **完全免费** - 零成本，长期可用  
✅ **数据权威** - 国家药监局官方数据  
✅ **越用越快** - 首次10秒，以后<1秒  
✅ **信息完整** - 批准文号、企业等  
✅ **可持续** - 不依赖付费服务  

### **使用建议：**

1. **先批量导入** 32种常用药材
2. **首次扫码** 选择"从已有药材中选择"
3. **新药材** 输入名称查NMPA
4. **特殊情况** 手动新建

### **预期效果：**

- 第1周：需要录入，稍慢
- 第2-3周：大部分可立即识别
- 第4周起：基本全部立即识别 ✅

---

**一次录入，终身受益！** 🎉

**完全免费，数据权威！** 💯
