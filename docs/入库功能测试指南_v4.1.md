# 🧪 入库功能测试指南 v4.1

## 📅 测试时间
2025-11-08

---

## 🎯 测试目标

验证入库功能优化后的所有功能是否正常工作。

---

## 📋 测试清单

### ✅ 测试前准备

#### 1. 编译项目
```bash
# 在微信开发者工具中
1. 打开项目：D:\AK-PMS
2. 点击"编译" 或 按 Ctrl+B
3. 等待编译完成
4. 检查是否有错误
```

#### 2. 检查云函数
```
确保以下云函数已部署：
- ✅ inRecords（入库单管理）
- ✅ drugBarcodeQuery（条形码查询）
- ✅ getDrugList（药品列表）
```

#### 3. 检查数据库
```
确保以下集合已创建：
- ✅ drugs（药品档案）
- ✅ in_records（入库记录）
- ✅ stock（库存）
- ✅ api_usage_logs（API使用日志）
- ✅ api_daily_stats（API每日统计）
```

---

## 🧪 功能测试

### 测试1：页面导航

#### 1.1 进入入库记录页面
```
操作：
1. 启动小程序
2. 点击底部"库存"标签
3. 点击"入库记录"

预期结果：
✅ 显示"入库记录"标题（不是"入库统计"）
✅ 显示统计面板（今日入库、本周入库等）
✅ 显示筛选标签（全部、草稿、待复核等）
✅ 显示入库记录列表
✅ 右下角显示➕浮动按钮
```

#### 1.2 进入新建入库页面
```
操作：
1. 在入库记录页面
2. 点击右下角➕按钮

预期结果：
✅ 跳转到"药品入库"页面
✅ 显示页面头部（绿色渐变）
✅ 显示基本信息卡片（单号、操作人、供应商）
✅ 显示智能搜索框
✅ 显示"入库明细"区域
✅ 显示签名区域
✅ 底部显示"保存草稿"和"提交复核"按钮
```

---

### 测试2：智能输入框

#### 2.1 搜索功能
```
操作：
1. 在搜索框输入"阿莫西林"
2. 等待300ms（防抖）
3. 观察下拉列表

预期结果：
✅ 输入时搜索框获得焦点（绿色边框）
✅ 300ms后显示搜索结果下拉列表
✅ 列表显示匹配的药品（名称+规格）
✅ 点击药品后添加到列表
✅ 搜索框自动清空
✅ 显示"已添加"提示
✅ 手机振动反馈
```

#### 2.2 无结果提示
```
操作：
1. 在搜索框输入"不存在的药品名称xyz123"
2. 等待搜索完成

预期结果：
✅ 显示"未找到'不存在的药品名称xyz123'"
✅ 显示"新建药品档案"按钮（绿色圆角）
✅ 点击按钮弹出新建药品弹窗
✅ 药品名称自动填充为搜索关键词
```

#### 2.3 清空搜索
```
操作：
1. 在搜索框输入任意内容
2. 点击搜索框内的✕图标

预期结果：
✅ 搜索框内容清空
✅ 下拉列表消失
✅ 恢复初始状态
```

#### 2.4 焦点状态
```
操作：
1. 点击搜索框（获取焦点）
2. 点击页面其他区域（失去焦点）

预期结果：
✅ 获取焦点时：绿色边框高亮
✅ 失去焦点时：恢复灰色边框
✅ 失去焦点后200ms下拉列表消失
✅ 界面保持整洁
```

---

### 测试3：扫码功能

#### 3.1 正常扫码（本地档案）
```
操作：
1. 点击搜索框右侧📷图标
2. 扫描已存在于药品档案的条形码

预期结果：
✅ 调起微信扫码功能
✅ 显示"识别中..."加载提示
✅ 查询本地药品档案（优先）
✅ 显示"✅ 已添加 (本地档案)"
✅ 药品自动添加到列表
✅ 手机振动反馈
✅ 不消耗API次数
```

#### 3.2 扫码调用API
```
操作：
1. 点击搜索框右侧📷图标
2. 扫描不存在于本地档案的条形码

预期结果：
✅ 先查询本地档案（未找到）
✅ 检查API剩余次数
✅ 如果次数充足：
   - 调用第三方API
   - 显示"✅ 已添加 (API查询)"
   - 如果剩余次数<20：显示"⚠️ 今日剩余X次API"
   - 药品自动添加到列表
   - 消耗1次API
✅ 如果次数不足：
   - 显示"🚫 API次数不足"弹窗
   - 提示手动新建
```

#### 3.3 扫码未找到
```
操作：
1. 点击搜索框右侧📷图标
2. 扫描无法识别的条形码

预期结果：
✅ 显示"💊 未找到药品"弹窗
✅ 显示条形码号码
✅ 询问"是否新建药品档案？"
✅ 点击"新建"：
   - 弹出新建药品弹窗
   - 条形码自动填充
```

#### 3.4 取消扫码
```
操作：
1. 点击搜索框右侧📷图标
2. 在扫码界面点击"取消"

预期结果：
✅ 关闭扫码界面
✅ 返回入库页面
✅ 不显示错误提示
✅ 不消耗API次数
```

---

### 测试4：新建药品

#### 4.1 打开新建弹窗
```
操作：
1. 搜索无结果时点击"新建药品档案"
   或
2. 扫码未找到时点击"新建"

预期结果：
✅ 弹出"新建药品档案"弹窗
✅ 显示药品名称输入框（必填）
✅ 显示规格输入框（必填）
✅ 显示单位选择器（必填）
✅ 如果是扫码触发：显示条形码信息
✅ 底部显示"取消"和"确定"按钮
```

#### 4.2 填写并提交
```
操作：
1. 填写药品名称："测试药品A"
2. 填写规格："0.5g×20片/盒"
3. 选择单位："盒"
4. 点击"确定"

预期结果：
✅ 验证必填字段
✅ 关闭弹窗
✅ 药品添加到入库列表
✅ 显示"已添加到列表"提示
✅ 药品标记为临时（isTemp: true）
```

#### 4.3 验证必填
```
操作：
1. 打开新建弹窗
2. 不填写任何信息
3. 点击"确定"

预期结果：
✅ 显示"请输入药品名称"提示
✅ 不关闭弹窗
✅ 不添加到列表
```

#### 4.4 取消新建
```
操作：
1. 打开新建弹窗
2. 点击"取消"或右上角✕

预期结果：
✅ 关闭弹窗
✅ 不添加药品
✅ 返回入库页面
```

---

### 测试5：连续添加药品

#### 5.1 添加多个药品
```
操作：
1. 搜索添加"阿莫西林胶囊"
2. 填写第1个药品的信息（批号、日期、数量）
3. 继续搜索添加"布洛芬缓释胶囊"
4. 填写第2个药品的信息
5. 继续添加第3个、第4个...

预期结果：
✅ 每次添加后药品列表增加一项
✅ 显示药品卡片（名称、规格）
✅ 每个卡片独立显示表单
✅ 右上角显示删除按钮
✅ 顶部"入库明细"显示药品数量
✅ 底部合计卡片显示总品种、总数量、总金额
```

#### 5.2 检查重复添加
```
操作：
1. 添加"阿莫西林胶囊"
2. 再次搜索并尝试添加"阿莫西林胶囊"

预期结果：
✅ 显示"该药品已添加"提示
✅ 不重复添加到列表
✅ 列表中只有一个"阿莫西林胶囊"
```

---

### 测试6：药品信息填写

#### 6.1 批号输入
```
操作：
1. 在批号输入框输入"A20250101"
2. 点击其他区域（失去焦点）

预期结果：
✅ 批号保存
✅ 触发验证
✅ 如果为空：卡片左侧显示红色边框
```

#### 6.2 日期选择
```
操作：
1. 点击"生产日期"选择器
2. 选择日期：2025-01-01
3. 点击"有效期"选择器
4. 选择日期：2027-01-01

预期结果：
✅ 弹出日期选择器
✅ 选择后日期显示在输入框
✅ 自动计算距有效期天数
✅ 显示有效期徽章：
   - 绿色：≥90天
   - 黄色：30-89天
   - 红色：<30天
   - 黑色：已过期
```

#### 6.3 数量输入
```
操作：
1. 在数量输入框输入"100"
2. 观察单位显示

预期结果：
✅ 数量保存
✅ 右侧显示单位（如"盒"）
✅ 如果填写了单价：自动计算金额
✅ 更新底部合计信息
```

#### 6.4 单价输入（选填）
```
操作：
1. 在单价输入框输入"25.50"
2. 观察金额计算

预期结果：
✅ 单价保存
✅ 自动计算金额（数量×单价）
✅ 显示金额：¥2,550.00
✅ 更新底部合计金额
```

---

### 测试7：表单验证

#### 7.1 必填项验证
```
操作：
1. 添加一个药品
2. 不填写任何信息
3. 点击"提交复核"

预期结果：
✅ 显示"第1行：批号不能为空"
✅ 不提交表单
✅ 卡片左侧显示红色边框
```

#### 7.2 过期药品验证
```
操作：
1. 添加一个药品
2. 填写批号："A20250101"
3. 填写生产日期：2023-01-01
4. 填写有效期：2024-01-01（已过期）
5. 填写数量：100
6. 点击"提交复核"

预期结果：
✅ 显示"第1行：药品已过期，不能入库"
✅ 不提交表单
✅ 有效期徽章显示黑色
```

#### 7.3 数量验证
```
操作：
1. 添加一个药品
2. 填写完整信息
3. 数量输入"0"或"-1"
4. 点击"提交复核"

预期结果：
✅ 显示"第1行：数量必须大于0"
✅ 不提交表单
```

---

### 测试8：删除药品

#### 8.1 删除单个药品
```
操作：
1. 添加2个药品
2. 点击第1个药品卡片右上角✕图标
3. 在确认弹窗点击"确定"

预期结果：
✅ 显示"确认删除"弹窗
✅ 点击确定后删除该药品
✅ 列表中只剩1个药品
✅ 更新药品数量显示
✅ 更新底部合计信息
```

#### 8.2 取消删除
```
操作：
1. 点击药品卡片右上角✕图标
2. 在确认弹窗点击"取消"

预期结果：
✅ 关闭弹窗
✅ 药品不被删除
✅ 保持原状态
```

---

### 测试9：签名功能

#### 9.1 打开签名
```
操作：
1. 点击"操作员签名"区域

预期结果：
✅ 弹出"手写签名"弹窗
✅ 显示签名画布
✅ 显示"清除"和"确定"按钮
```

#### 9.2 签名并确认
```
操作：
1. 在画布上手写签名
2. 点击"确定"

预期结果：
✅ 关闭弹窗
✅ 签名显示在签名区域
✅ 签名图片清晰可见
```

#### 9.3 清除签名
```
操作：
1. 打开签名弹窗
2. 手写签名
3. 点击"清除"

预期结果：
✅ 画布清空
✅ 可以重新签名
✅ 不关闭弹窗
```

#### 9.4 签名验证
```
操作：
1. 添加药品并填写信息
2. 不签名
3. 点击"提交复核"

预期结果：
✅ 显示"请先签名"提示
✅ 不提交表单
```

---

### 测试10：提交入库单

#### 10.1 正常提交
```
操作：
1. 添加2个药品
2. 填写完整信息（批号、日期、数量）
3. 操作员签名
4. 点击"提交复核"

预期结果：
✅ 显示"提交中..."加载提示
✅ 调用云函数创建入库单
✅ 显示"提交成功"提示
✅ 1.5秒后自动返回列表页
✅ 列表页显示新创建的入库单
✅ 状态为"待复核"（橙色）
```

#### 10.2 提交失败
```
操作：
1. 断开网络
2. 填写完整信息并签名
3. 点击"提交复核"

预期结果：
✅ 显示"提交失败"提示
✅ 不返回列表页
✅ 数据保留在页面
✅ 可以重新提交
```

---

### 测试11：入库记录列表

#### 11.1 查看列表
```
操作：
1. 进入入库记录页面
2. 观察列表显示

预期结果：
✅ 显示统计面板（今日、本周、本月、待复核）
✅ 显示筛选标签（全部、草稿、待复核、已完成、已驳回）
✅ 显示入库记录卡片（单号、状态、操作人、时间等）
✅ 状态徽章颜色正确：
   - 灰色：草稿
   - 橙色：待复核
   - 绿色：已完成
   - 红色：已驳回
```

#### 11.2 切换标签
```
操作：
1. 点击"待复核"标签
2. 观察列表变化

预期结果：
✅ 标签高亮（蓝色文字+底部横线）
✅ 列表只显示待复核的单据
✅ 标签右上角显示数量徽章
```

#### 11.3 下拉刷新
```
操作：
1. 在列表页下拉
2. 释放刷新

预期结果：
✅ 显示刷新动画
✅ 重新加载数据
✅ 更新统计数据
✅ 刷新完成后停止动画
```

---

### 测试12：入库单详情

#### 12.1 查看详情
```
操作：
1. 在列表页点击任意入库单

预期结果：
✅ 跳转到详情页
✅ 显示专业医疗表头（紫色渐变）
✅ 显示状态流程指示器（创建→复核→完成）
✅ 显示状态徽章
✅ 显示基本信息卡片（单号、时间、操作人、供应商）
✅ 显示药品明细卡片（药品列表）
✅ 显示操作员签名
✅ 如果已完成：显示复核员签名
```

---

### 测试13：复核功能

#### 13.1 复核通过
```
操作：
1. 打开待复核的入库单（不是自己创建的）
2. 查看药品明细
3. 在"复核操作"区域手写签名
4. 点击"通过复核"
5. 在确认弹窗点击"确定"

预期结果：
✅ 显示"处理中..."加载提示
✅ 调用云函数通过复核
✅ 自动更新库存
✅ 显示"复核通过"提示
✅ 1.5秒后返回列表页
✅ 单据状态变为"已完成"（绿色）
```

#### 13.2 复核驳回
```
操作：
1. 打开待复核的入库单
2. 在"驳回原因"输入框填写原因
3. 点击"驳回"
4. 在确认弹窗点击"确定"

预期结果：
✅ 验证驳回原因不为空
✅ 显示"处理中..."加载提示
✅ 调用云函数驳回
✅ 显示"已驳回"提示
✅ 1.5秒后返回列表页
✅ 单据状态变为"已驳回"（红色）
```

#### 13.3 权限检查
```
操作：
1. 打开自己创建的待复核单据
2. 尝试复核

预期结果：
✅ 不显示"复核操作"区域
✅ 不显示"通过复核"和"驳回"按钮
✅ 只能查看，不能复核
```

---

### 测试14：微信风格UI

#### 14.1 颜色方案
```
检查项：
✅ 主色调为微信绿（#07C160）
✅ 渐变色正确（#07C160 → #05a550）
✅ 背景色为微信灰（#f7f8fa）
✅ 文字颜色清晰可读
```

#### 14.2 组件风格
```
检查项：
✅ 按钮圆角（50rpx）
✅ 卡片圆角（16rpx）
✅ 按钮有渐变色
✅ 卡片有柔和阴影
```

#### 14.3 交互效果
```
检查项：
✅ 按钮按下时缩放（0.98）
✅ 扫码成功时振动反馈
✅ 焦点时边框高亮
✅ 动画流畅自然
```

#### 14.4 安全区域
```
检查项：
✅ 底部按钮适配安全区域
✅ iPhone X及以上机型显示正常
✅ 不被底部横条遮挡
```

---

## 📊 测试结果记录

### 测试环境
```
设备：__________
系统：__________
微信版本：__________
测试时间：__________
```

### 测试结果

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 1. 页面导航 | ⬜ 通过 / ⬜ 失败 | |
| 2. 智能输入框 | ⬜ 通过 / ⬜ 失败 | |
| 3. 扫码功能 | ⬜ 通过 / ⬜ 失败 | |
| 4. 新建药品 | ⬜ 通过 / ⬜ 失败 | |
| 5. 连续添加 | ⬜ 通过 / ⬜ 失败 | |
| 6. 信息填写 | ⬜ 通过 / ⬜ 失败 | |
| 7. 表单验证 | ⬜ 通过 / ⬜ 失败 | |
| 8. 删除药品 | ⬜ 通过 / ⬜ 失败 | |
| 9. 签名功能 | ⬜ 通过 / ⬜ 失败 | |
| 10. 提交入库 | ⬜ 通过 / ⬜ 失败 | |
| 11. 记录列表 | ⬜ 通过 / ⬜ 失败 | |
| 12. 单据详情 | ⬜ 通过 / ⬜ 失败 | |
| 13. 复核功能 | ⬜ 通过 / ⬜ 失败 | |
| 14. 微信风格 | ⬜ 通过 / ⬜ 失败 | |

---

## 🐛 问题记录

### 发现的问题

| 序号 | 问题描述 | 严重程度 | 状态 |
|------|---------|---------|------|
| 1 | | ⬜ 高 / ⬜ 中 / ⬜ 低 | ⬜ 待修复 / ⬜ 已修复 |
| 2 | | ⬜ 高 / ⬜ 中 / ⬜ 低 | ⬜ 待修复 / ⬜ 已修复 |
| 3 | | ⬜ 高 / ⬜ 中 / ⬜ 低 | ⬜ 待修复 / ⬜ 已修复 |

---

## ✅ 测试通过标准

### 必须通过的测试
- ✅ 智能输入框（搜索、扫码、新建）
- ✅ 连续添加多个药品
- ✅ 表单验证
- ✅ 签名功能
- ✅ 提交入库单
- ✅ 复核功能

### 可选测试
- ⬜ 草稿保存（功能未开发）
- ⬜ PDF导出（功能未开发）

---

## 🚀 测试完成后

### 1. 如果测试通过
```
✅ 标记所有测试项为"通过"
✅ 记录测试结果
✅ 准备部署到生产环境
```

### 2. 如果发现问题
```
❌ 记录问题详情
❌ 评估严重程度
❌ 修复问题后重新测试
```

---

**测试指南版本**：v4.1  
**创建时间**：2025-11-08  
**状态**：✅ 准备测试



