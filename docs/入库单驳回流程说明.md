# 📋 入库单驳回流程说明

## 🎯 驳回功能概述

**驳回功能**：当复核人员发现入库单存在问题时，可以驳回该单据，要求操作员重新修改。

---

## 🔄 完整流程

### **步骤1：操作员创建入库单**
```
操作员
  ↓
扫码/搜索添加药材
  ↓
填写批次、数量等信息
  ↓
操作员签名
  ↓
提交 → 状态变为"待复核"
```

---

### **步骤2：复核人复核**
```
复核人进入复核页面
  ↓
检查入库单信息
  ↓
发现问题（如：规格不正确）
  ↓
点击【驳回】按钮
```

---

### **步骤3：驳回操作**

#### **3.1 点击驳回按钮**
```
点击【驳回】
  ↓
弹出确认对话框：
┌─────────────────────┐
│   确认驳回           │
├─────────────────────┤
│ 确定要驳回这个       │
│ 入库单吗？           │
├─────────────────────┤
│  [取消]    [确定]   │
└─────────────────────┘
```

#### **3.2 输入驳回原因**
```
确认后：
  ↓
页面显示"驳回原因"输入框
  ↓
┌─────────────────────────┐
│ 📝 驳回原因 *            │
├─────────────────────────┤
│ ┌─────────────────────┐ │
│ │ 规格不正确          │ │
│ │                     │ │
│ └─────────────────────┘ │
│        5/200            │
└─────────────────────────┘
```

**必填字段**：
- ⭐ 驳回原因必须填写
- 📝 最多200字
- 🔍 会显示字符计数

#### **3.3 提交驳回**
```
填写驳回原因后：
  ↓
再次点击【驳回】按钮
  ↓
系统验证驳回原因是否填写
  ↓
提交到云函数
  ↓
更新入库单状态为"已驳回"
  ↓
显示提示："已驳回" ✅
  ↓
自动返回上一页
```

---

## 📊 驳回后的状态变化

### **数据库字段变化：**

| 字段 | 驳回前 | 驳回后 |
|------|--------|--------|
| `status` | `pending_review` | `rejected` ✅ |
| `reviewer` | 空 | 复核人姓名 |
| `reviewerId` | 空 | 复核人ID |
| `rejectReason` | 空 | **驳回原因** ✅ |
| `updateTime` | 旧时间 | 当前时间 |

---

## 🔍 驳回原因在哪里显示？

### **1. 入库单列表页（list.vue）**

```
┌─────────────────────────────┐
│ RK20251123001  ❌ 已驳回     │
│ 操作员：开发者               │
│ 2025-11-23                  │
├─────────────────────────────┤
│ 驳回原因：规格不正确 ⭐      │
└─────────────────────────────┘
```

**显示条件：**
```html
<view v-if="item.status === 'rejected'">
  <view class="reject-reason">
    驳回原因：{{ item.rejectReason }}
  </view>
</view>
```

---

### **2. 入库单详情页（detail.vue）**

```
┌─────────────────────────────┐
│ ⚠️ 驳回原因                 │
├─────────────────────────────┤
│ 规格不正确                  │
│                             │
│ 复核人：管理员              │
│ 2025-11-23 19:17           │
└─────────────────────────────┘
```

**显示条件：**
```html
<view v-if="record.status === 'rejected'" class="reject-card">
  <view class="reject-header">
    <text class="reject-icon">⚠️</text>
    <text class="reject-title">驳回原因</text>
  </view>
  <view class="reject-body">
    <text class="reject-reason">{{ record.rejectReason }}</text>
    <view class="reject-footer">
      <text>复核人：{{ record.reviewer }}</text>
      <text>{{ record.reviewerSignTime }}</text>
    </view>
  </view>
</view>
```

---

### **3. 复核页面（review.vue）**

**自己输入的驳回原因：**
```
┌─────────────────────────────┐
│ 📝 驳回原因 *               │
├─────────────────────────────┤
│ ┌─────────────────────────┐ │
│ │ 规格不正确              │ │
│ └─────────────────────────┘ │
│        5/200               │
└─────────────────────────────┘
```

---

## 💡 驳回确认提示

### **提示1：点击驳回按钮时**
```javascript
uni.showModal({
  title: '确认驳回',
  content: '确定要驳回这个入库单吗？',
  success: (res) => {
    if (res.confirm) {
      // 显示驳回原因输入框
      this.showRejectReason = true
      // 滚动到底部
      uni.pageScrollTo({
        scrollTop: 9999,
        duration: 300
      })
    }
  }
})
```

### **提示2：未填写驳回原因时**
```javascript
if (!this.rejectReason.trim()) {
  uni.showToast({
    title: '请输入驳回原因',
    icon: 'none'
  })
  return
}
```

### **提示3：驳回成功后**
```javascript
uni.showToast({
  title: '已驳回',
  icon: 'success'
})

setTimeout(() => {
  uni.navigateBack()
}, 1500)
```

---

## 🔧 云函数处理逻辑

### **reject函数（cloudfunctions/inRecords/index.js）**

```javascript
async function reject(data, wxContext) {
  const { 
    _id, 
    reviewer, 
    reviewerId, 
    rejectReason 
  } = data
  
  // 1. 验证参数
  if (!_id || !rejectReason) {
    throw new Error('参数不完整')
  }
  
  // 2. 检查记录状态
  const record = await db.collection('in_records').doc(_id).get()
  if (!record.data) {
    throw new Error('记录不存在')
  }
  
  if (record.data.status !== 'pending_review') {
    throw new Error('只能驳回待审核的单据')
  }
  
  // 3. 更新入库单状态
  await db.collection('in_records').doc(_id).update({
    data: {
      status: 'rejected',        // ⭐ 状态改为已驳回
      reviewer,                  // 复核人
      reviewerId,                // 复核人ID
      rejectReason,              // ⭐ 驳回原因
      updateTime: new Date()     // 更新时间
    }
  })
  
  return {
    success: true,
    message: '已驳回'
  }
}
```

---

## 📝 驳回后操作员可以做什么？

### **1. 查看驳回原因**
```
入库单列表
  ↓
找到"已驳回"的单据
  ↓
看到驳回原因："规格不正确"
```

### **2. 编辑修改**
```
点击已驳回的单据
  ↓
进入详情页
  ↓
点击【编辑】按钮
  ↓
修改错误信息（如：更正规格）
  ↓
操作员重新签名
  ↓
提交 → 状态变回"待复核"
```

### **3. 再次提交审核**
```
修改完成后
  ↓
提交给复核人
  ↓
复核人重新审核
  ↓
通过 → 状态变为"已完成"
或
再次驳回 → 继续修改
```

---

## 🎨 状态标识

### **各状态的显示：**

| 状态 | 显示文字 | 图标 | 颜色 |
|------|---------|------|------|
| `draft` | 草稿 | 📝 | 灰色 |
| `pending_review` | 待复核 | ⏳ | 橙色 |
| `completed` | 已完成 | ✅ | 绿色 |
| `rejected` | **已驳回** | **❌** | **红色** ⭐ |

---

## ⚠️ 注意事项

### **1. 驳回原因必填**
```
✅ 必须填写驳回原因
❌ 不能为空
📝 最多200字
```

### **2. 只能驳回待审核的单据**
```
✅ 可以驳回：status = 'pending_review'
❌ 不能驳回：
   - status = 'draft'（草稿）
   - status = 'completed'（已完成）
   - status = 'rejected'（已驳回）
```

### **3. 驳回后可以重新编辑**
```
已驳回的单据可以：
✅ 查看详情
✅ 编辑修改
✅ 重新提交审核

不能：
❌ 直接通过
❌ 删除（需要特殊权限）
```

---

## 🔄 完整循环流程

```
操作员创建 → 提交审核
       ↓
    复核人审核
       ↓
  ┌────✓────┐
  ↓         ↓
通过      驳回 ⭐
  ↓         ↓
已完成   填写驳回原因
         ↓
      状态=已驳回
         ↓
    操作员查看驳回原因
         ↓
      编辑修改
         ↓
    重新提交审核 ← 返回审核流程
```

---

## 📱 界面操作示意

### **复核页面底部按钮：**

```
┌─────────────────────────────┐
│                             │
│  [驳回]      [通过并入库]   │
│                             │
└─────────────────────────────┘

点击【驳回】：
1. 弹出确认框
2. 显示驳回原因输入框
3. 填写原因
4. 再次点击【驳回】提交
```

---

## 📊 数据统计

### **状态统计包含驳回数量：**

```javascript
{
  draft: 2,           // 草稿
  pending_review: 3,  // 待复核
  completed: 10,      // 已完成
  rejected: 1         // 已驳回 ⭐
}
```

### **列表页可按状态筛选：**
```
[全部] [草稿] [待复核] [已完成] [已驳回]
                                  ↑
                            点击查看所有驳回单据
```

---

## ✅ 总结

### **驳回功能的作用：**
✅ **质量控制** - 确保入库单准确  
✅ **可追溯** - 记录驳回原因  
✅ **可修正** - 允许重新编辑  
✅ **提示明确** - 操作员知道哪里错了  

### **驳回流程：**
```
点击驳回 → 确认 → 填写原因 → 提交
  ↓
状态变为"已驳回"
  ↓
列表和详情页显示驳回原因
  ↓
操作员可以编辑修改
  ↓
重新提交审核
```

### **提示位置：**
1. **点击驳回时** - 确认对话框
2. **未填原因时** - Toast提示
3. **驳回成功后** - 成功提示 + 自动返回
4. **列表页** - 显示驳回原因
5. **详情页** - 完整显示驳回信息

---

**驳回功能让入库流程更严谨！** ✅
