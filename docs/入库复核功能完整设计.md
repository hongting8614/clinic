# 📋 入库复核功能完整设计文档

## 🎯 功能概述

入库复核功能实现了**双人双阶段审批流程**，确保入库操作的准确性和可追溯性。

---

## 🔄 完整流程图

```
┌─────────────────────────────────────────┐
│        阶段1: 操作员录入                  │
└─────────────────────────────────────────┘
              ↓
    操作员登录系统
              ↓
    首页 → 📦 新建入库单
              ↓
    扫码/搜索添加药品
              ↓
    填写批号、日期、数量、单价
              ↓
    操作员签名 ✍️ (必填)
              ↓
    点击"提交入库"
              ↓
    状态: pending_review (待复核)
              ↓
┌─────────────────────────────────────────┐
│        阶段2: 复核人复核                  │
└─────────────────────────────────────────┘
              ↓
    复核人登录系统
              ↓
    入库管理 → 待复核标签
              ↓
    查看待复核列表
              ↓
    点击入库单 → 进入复核页面
              ↓
    查看入库单明细
              ↓
    查看操作员签名
              ↓
    复核人签名 ✍️ (必填)
              ↓
    ┌─────────┴─────────┐
    ↓                   ↓
  通过并入库          驳回
    ↓                   ↓
更新库存            状态: rejected
状态: completed       ↓
                     操作员修改后重新提交
```

---

## 📱 页面结构

### 1. **入库单列表页** (`pages-sub/in/list.vue`)

**功能：**
- 显示所有入库单
- 按状态筛选（全部/待复核/已完成/已驳回）
- 显示待复核数量提醒
- 点击进入详情或复核页面

**界面布局：**
```
┌─────────────────────────────────────────┐
│  📊 入库记录                             │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐      │
│  │今日 │ │本周 │ │本月 │ │待复核│      │
│  └─────┘ └─────┘ └─────┘ └─────┘      │
├─────────────────────────────────────────┤
│  🔍 [搜索单号/药品名称_______] 📅       │
├─────────────────────────────────────────┤
│  [全部] [待复核(3)] [已完成] [已驳回]   │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ RK20250109001        [待复核]      │ │
│  │ 操作人：张三                       │ │
│  │ 创建时间：2025-01-09 10:30        │ │
│  │ 药品种类：3种                     │ │
│  │ [查看详情] [去复核]                │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**关键代码：**
```javascript
// 切换标签
switchTab(value) {
  this.currentTab = value
  this.loadRecords()
}

// 进入复核页面
goReview(id) {
  uni.navigateTo({
    url: `/pages-sub/in/review?id=${id}`
  })
}
```

---

### 2. **复核页面** (`pages-sub/in/review.vue`)

**功能：**
- 显示入库单完整信息
- 显示药品明细
- 显示操作员签名（只读）
- 复核人签名（可编辑）
- 通过/驳回操作

**界面布局：**
```
┌─────────────────────────────────────────┐
│  ← 入库单复核                            │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ 单号：RK20250109001               │ │
│  │ 状态：[待复核]                    │ │
│  │ 操作人：张三                      │ │
│  │ 创建时间：2025-01-09 10:30       │ │
│  │ 供应商：XX医药公司                │ │
│  └───────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  📦 药品明细 (共3种)                   │
│  ┌───────────────────────────────────┐ │
│  │ 1. 阿莫西林胶囊 0.25g×24粒/盒    │ │
│  │ 批号：ABC123                       │ │
│  │ 生产日期：2024-01-01              │ │
│  │ 有效期：2026-12-31 (730天)        │ │
│  │ 数量：100 盒                       │ │
│  │ 单价：¥15.50                      │ │
│  │ 金额：¥1,550.00                   │ │
│  └───────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  📊 合计                               │
│  品种：3种  总数量：150  总金额：¥2,350│
├─────────────────────────────────────────┤
│  ✍️ 双签名确认                          │
│  ┌───────────────────────────────────┐ │
│  │ 操作员签名 [已签名]                │ │
│  │ ┌───────────────────────────────┐ │ │
│  │ │ [签名图片]                    │ │ │
│  │ └───────────────────────────────┘ │ │
│  │ 张三  2025-01-09 10:30           │ │
│  └───────────────────────────────────┘ │
│  ┌───────────────────────────────────┐ │
│  │ 复核人签名 [待签名]                │ │
│  │ ┌───────────────────────────────┐ │ │
│  │ │ 🖊️ 点击全屏签名                │ │ │
│  │ └───────────────────────────────┘ │ │
│  └───────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  [驳回]          [通过并入库] ✅        │
└─────────────────────────────────────────┘
```

**关键代码：**
```javascript
// 加载入库单详情
async loadRecord() {
  const result = await this.$api.callFunction('inRecords', {
    action: 'getDetail',
    data: { _id: this.recordId }
  })
  this.record = result.data
}

// 通过复核
async handleApprove() {
  if (!this.reviewerSign) {
    uni.showToast({ title: '请先签名', icon: 'none' })
    return
  }
  
  const result = await this.$api.callFunction('inRecords', {
    action: 'approve',
    data: {
      _id: this.recordId,
      reviewer: userInfo.name,
      reviewerId: userInfo._id,
      reviewerSign: this.reviewerSign,
      reviewerSignTime: new Date().toISOString()
    }
  })
}

// 驳回
async handleReject() {
  if (!this.rejectReason.trim()) {
    uni.showToast({ title: '请输入驳回原因', icon: 'none' })
    return
  }
  
  const result = await this.$api.callFunction('inRecords', {
    action: 'reject',
    data: {
      _id: this.recordId,
      reviewer: userInfo.name,
      reviewerId: userInfo._id,
      rejectReason: this.rejectReason
    }
  })
}
```

---

## 🔐 权限控制

### 操作员权限
- ✅ 新建入库单
- ✅ 填写药品信息
- ✅ 操作员签名
- ✅ 提交入库（状态变为 `pending_review`）
- ✅ 查看自己的入库单
- ❌ 不能复核自己的单据

### 复核人权限
- ✅ 查看待复核入库单列表
- ✅ 查看入库单详情
- ✅ 复核人签名
- ✅ 通过复核（状态变为 `completed`，自动更新库存）
- ✅ 驳回入库单（状态变为 `rejected`，需填写驳回原因）
- ❌ 不能复核自己的单据

---

## 📊 状态流转

### 入库单状态

| 状态 | 说明 | 可操作 | 操作人 |
|------|------|--------|--------|
| `draft` | 草稿 | 继续编辑 | 操作员 |
| `pending_review` | 待复核 | 复核 | 复核人 |
| `completed` | 已完成 | 查看详情 | 所有人 |
| `rejected` | 已驳回 | 修改后重新提交 | 操作员 |

### 状态转换图

```
draft (草稿)
  ↓ 操作员提交
pending_review (待复核)
  ↓
  ├→ 复核人通过 → completed (已完成) + 更新库存
  └→ 复核人驳回 → rejected (已驳回)
                      ↓ 操作员修改
                 pending_review (待复核)
```

---

## 🚀 详细操作流程

### 操作员操作流程

#### **步骤1：登录系统**
```
1. 使用操作员账号登录
2. 进入首页
```

#### **步骤2：新建入库单**
```
1. 点击 "📦 新建入库单"
2. 或 "入库管理" → "+" 按钮
3. 进入入库单录入页面
```

#### **步骤3：录入药品信息**
```
1. 扫码/搜索添加药品
2. 填写批号（必填）
3. 选择生产日期（必填）
4. 选择有效期（必填）
5. 填写数量（必填，>0）
6. 填写单价（选填）
7. 可添加多个药品
```

#### **步骤4：操作员签名**
```
1. 点击签名框
2. 弹出全屏签名界面
3. 在画布上签名
4. 点击"确认签名"
5. 签名图片保存并显示
```

#### **步骤5：提交入库**
```
1. 检查信息无误
2. 点击"提交入库"按钮
3. 系统验证：
   - 是否添加了药品
   - 是否填写了必填项
   - 是否已签名
4. 提交成功，状态变为 pending_review
5. 提示"提交成功，等待复核"
6. 返回列表页
```

---

### 复核人操作流程

#### **步骤1：登录系统**
```
1. 使用复核人账号登录
2. 进入首页
```

#### **步骤2：查看待复核单据**
```
1. 点击 "入库管理"
2. 进入入库单列表页
3. 点击"待复核"标签
4. 查看待复核列表
5. 显示待复核数量提醒
```

#### **步骤3：进入复核页面**
```
1. 点击待复核的入库单
2. 或点击"去复核"按钮
3. 进入复核页面
4. 查看入库单完整信息
```

#### **步骤4：查看明细**
```
1. 查看基本信息：
   - 单号
   - 操作人
   - 创建时间
   - 供应商
2. 查看药品明细：
   - 药品名称
   - 规格
   - 批号
   - 生产日期
   - 有效期（显示剩余天数）
   - 数量
   - 单价
   - 金额
3. 查看合计信息：
   - 品种数
   - 总数量
   - 总金额
4. 查看操作员签名（只读）
```

#### **步骤5：复核人签名**
```
1. 点击复核人签名框
2. 弹出全屏签名界面
3. 在画布上签名
4. 点击"确认签名"
5. 签名图片保存并显示
6. 状态变为"已签名"
```

#### **步骤6A：通过复核**
```
1. 确认信息无误
2. 点击"通过并入库"按钮
3. 系统验证：
   - 是否已签名
   - 是否为自己复核自己（不允许）
4. 弹出确认对话框
5. 确认后提交
6. 系统操作：
   - 更新入库单状态为 completed
   - 保存复核人信息
   - 保存复核人签名
   - 自动更新库存（每个药品）
7. 提示"已通过并入库"
8. 返回列表页
```

#### **步骤6B：驳回入库单**
```
1. 发现信息有误
2. 点击"驳回"按钮
3. 弹出确认对话框
4. 确认后显示驳回原因输入框
5. 填写驳回原因（必填，最多200字）
6. 点击"确认驳回"
7. 系统操作：
   - 更新入库单状态为 rejected
   - 保存复核人信息
   - 保存驳回原因
8. 提示"已驳回"
9. 返回列表页
10. 操作员可查看驳回原因并修改
```

---

## 💾 数据模型

### 入库单数据结构

```javascript
{
  _id: '记录ID',
  recordNo: 'RK20250109001',  // 单号
  operator: '张三',            // 操作员姓名
  operatorId: 'user_id_123',   // 操作员ID
  operatorSign: 'cloud://...', // 操作员签名图片URL
  operatorSignTime: '2025-01-09T10:30:00Z',  // 操作员签名时间
  reviewer: '李四',            // 复核人姓名（复核后）
  reviewerId: 'user_id_456',  // 复核人ID（复核后）
  reviewerSign: 'cloud://...', // 复核人签名图片URL（复核后）
  reviewerSignTime: '2025-01-09T14:20:00Z',  // 复核人签名时间（复核后）
  rejectReason: '批号填写错误', // 驳回原因（驳回时）
  supplier: 'XX医药公司',      // 供应商
  status: 'pending_review',    // 状态
  items: [                     // 药品明细
    {
      drugId: 'drug_id_123',
      drugName: '阿莫西林胶囊',
      specification: '0.25g×24粒/盒',
      batch: 'ABC123',
      productionDate: '2024-01-01',
      expireDate: '2026-12-31',
      quantity: 100,
      unit: '盒',
      price: 15.50
    }
  ],
  createTime: '2025-01-09T10:30:00Z',
  updateTime: '2025-01-09T10:30:00Z',
  completeTime: '2025-01-09T14:20:00Z'  // 完成时间（复核通过后）
}
```

---

## 🔧 云函数接口

### 1. **获取详情** (`getDetail`)

**请求：**
```javascript
{
  action: 'getDetail',
  data: {
    _id: '记录ID'
  }
}
```

**响应：**
```javascript
{
  success: true,
  data: { /* 入库单详情 */ }
}
```

---

### 2. **复核通过** (`approve`)

**请求：**
```javascript
{
  action: 'approve',
  data: {
    _id: '记录ID',
    reviewer: '复核人姓名',
    reviewerId: '复核人ID',
    reviewerSign: '签名图片URL',
    reviewerSignTime: '2025-01-09T14:20:00Z'
  }
}
```

**响应：**
```javascript
{
  success: true,
  message: '复核通过，库存已更新'
}
```

**业务逻辑：**
1. 验证参数完整性
2. 检查记录是否存在
3. 检查状态是否为 `pending_review`
4. 检查是否为自己复核自己（不允许）
5. 更新入库单状态为 `completed`
6. 保存复核人信息和签名
7. **自动更新库存**（遍历每个药品，调用 `updateStock`）
8. 返回成功

---

### 3. **复核驳回** (`reject`)

**请求：**
```javascript
{
  action: 'reject',
  data: {
    _id: '记录ID',
    reviewer: '复核人姓名',
    reviewerId: '复核人ID',
    rejectReason: '驳回原因'
  }
}
```

**响应：**
```javascript
{
  success: true,
  message: '已驳回'
}
```

**业务逻辑：**
1. 验证参数完整性（包括驳回原因）
2. 检查记录是否存在
3. 检查状态是否为 `pending_review`
4. 更新入库单状态为 `rejected`
5. 保存复核人信息和驳回原因
6. 返回成功

---

## ⚠️ 验证规则

### 复核通过验证
- ✅ 必须已签名（`reviewerSign` 不为空）
- ✅ 状态必须为 `pending_review`
- ✅ 不能自己复核自己（`operatorId !== reviewerId`）
- ✅ 记录必须存在

### 复核驳回验证
- ✅ 必须填写驳回原因（`rejectReason` 不为空）
- ✅ 状态必须为 `pending_review`
- ✅ 记录必须存在

---

## 🎨 UI/UX 设计要点

### 1. **状态标识**
- 待复核：橙色标签 `#ff9800`
- 已完成：绿色标签 `#4caf50`
- 已驳回：红色标签 `#f44336`

### 2. **签名显示**
- 操作员签名：只读，显示签名图片、姓名、时间
- 复核人签名：可编辑，未签名时显示占位符

### 3. **操作按钮**
- 通过按钮：绿色渐变，突出显示
- 驳回按钮：红色边框，次要操作

### 4. **信息层次**
- 基本信息 → 药品明细 → 合计 → 签名 → 操作按钮

---

## 📝 注意事项

### 1. **权限控制**
- 操作员不能复核自己的单据
- 只有复核人能看到待复核列表
- 已完成的单据不能再次复核

### 2. **库存更新**
- 只有在复核通过时才更新库存
- 驳回时不影响库存
- 库存更新使用包装单位

### 3. **签名要求**
- 操作员签名：提交时必填
- 复核人签名：复核时必填
- 签名图片上传到云存储

### 4. **状态管理**
- 状态变更后立即刷新列表
- 使用 `uni.navigateBack()` 返回列表页
- 列表页自动刷新数据

---

## 🔄 完整示例

### 操作员提交入库单

```javascript
// pages-sub/in/add.vue
async submit() {
  // 1. 验证
  if (!this.validateForm()) return
  
  // 2. 提交
  const result = await this.$api.callFunction('inRecords', {
    action: 'create',
    data: {
      recordNo: this.recordNo,
      items: this.drugList.map(item => ({
        drugId: item.drugId,
        drugName: item.drugName,
        specification: item.specification,
        batch: item.batch,
        productionDate: item.productionDate,
        expireDate: item.expireDate,
        quantity: Number(item.quantity),
        price: Number(item.price) || 0
      })),
      operator: this.operator,
      operatorId: userInfo._id,
      operatorSign: this.operatorSign,
      operatorSignTime: new Date().toISOString(),
      status: 'pending_review'  // 待复核
    }
  })
  
  // 3. 提示并返回
  uni.showToast({ title: '提交成功，等待复核' })
  uni.navigateBack()
}
```

### 复核人通过复核

```javascript
// pages-sub/in/review.vue
async handleApprove() {
  // 1. 验证签名
  if (!this.reviewerSign) {
    uni.showToast({ title: '请先签名', icon: 'none' })
    return
  }
  
  // 2. 确认对话框
  uni.showModal({
    title: '确认通过',
    content: '确认通过并入库吗？入库后将更新库存。',
    success: async (res) => {
      if (res.confirm) {
        // 3. 提交复核
        const result = await this.$api.callFunction('inRecords', {
          action: 'approve',
          data: {
            _id: this.recordId,
            reviewer: userInfo.name,
            reviewerId: userInfo._id,
            reviewerSign: this.reviewerSign,
            reviewerSignTime: new Date().toISOString()
          }
        })
        
        // 4. 提示并返回
        uni.showToast({ title: '已通过并入库', icon: 'success' })
        setTimeout(() => {
          uni.navigateBack()
        }, 1500)
      }
    }
  })
}
```

---

## ✅ 功能检查清单

- [x] 入库单列表页显示待复核数量
- [x] 待复核标签筛选功能
- [x] 点击入库单进入复核页面
- [x] 复核页面显示完整信息
- [x] 操作员签名只读显示
- [x] 复核人签名可编辑
- [x] 通过复核功能（更新库存）
- [x] 驳回功能（填写原因）
- [x] 权限验证（不能自己复核自己）
- [x] 状态流转正确
- [x] 错误提示完善

---

## 🎉 总结

入库复核功能实现了完整的双人双阶段审批流程，确保了：
- ✅ **准确性**：双人确认，减少错误
- ✅ **可追溯性**：双签名记录，完整追溯
- ✅ **安全性**：权限控制，防止误操作
- ✅ **自动化**：复核通过自动更新库存

---

**最后更新：** 2025-11-09  
**版本：** v1.0

