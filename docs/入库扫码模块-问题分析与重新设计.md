# ğŸ” å…¥åº“æ‰«ç æ¨¡å— - é—®é¢˜åˆ†æä¸é‡æ–°è®¾è®¡æ–¹æ¡ˆ

**åˆ†ææ—¶é—´ï¼š** 2026å¹´1æœˆ3æ—¥  
**é—®é¢˜æè¿°ï¼š** è¯ææ¡£æ¡ˆä¸­æœ‰æ­£ç¡®çš„æ¡å½¢ç ï¼Œä½†æ‰«ç æç¤ºå¤±è´¥

---

## ğŸ“Š å½“å‰æ¶æ„åˆ†æ

### 1. ç°æœ‰æ¶æ„æ¦‚è§ˆ

```
æ‰«ç æµç¨‹ï¼š
ç”¨æˆ·æ‰«ç  â†’ Scannerç»„ä»¶ â†’ drugBarcodeQueryäº‘å‡½æ•° â†’ ä¸‰çº§æŸ¥è¯¢ç­–ç•¥
                                                    â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â†“                               â†“
                            1. æœ¬åœ°è¯ææ¡£æ¡ˆ(drugs)          2. ç¼“å­˜æ•°æ®åº“
                                    â†“                               â†“
                            3. æ¡å½¢ç æ˜ å°„è¡¨(barcode_mapping)
                                    â†“
                            è¿”å›ç»“æœ / æç¤ºæœªæ‰¾åˆ°
```

### 2. æ¶‰åŠçš„å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ | çŠ¶æ€ |
|------|------|------|
| `components/scanner/index.vue` | æ‰«ç ç»„ä»¶ï¼ˆæœªä½¿ç”¨ï¼‰ | âš ï¸ æœªé›†æˆ |
| `pages-sub/in/add.vue` | å…¥åº“é¡µé¢ï¼ˆç›´æ¥è°ƒç”¨æ‰«ç ï¼‰ | âœ… ä½¿ç”¨ä¸­ |
| `cloudfunctions/drugBarcodeQuery/index.js` | æ¡å½¢ç æŸ¥è¯¢äº‘å‡½æ•° | âœ… å·²éƒ¨ç½² |
| `cloudfunctions/inRecords/index.js` | å…¥åº“å•ç®¡ç†äº‘å‡½æ•° | âœ… å·²éƒ¨ç½² |

---

## ğŸ› é—®é¢˜æ ¹æºåˆ†æ

### é—®é¢˜1ï¼šå­—æ®µåä¸ä¸€è‡´ â­â­â­â­â­

**ç°è±¡ï¼š** è¯ææ¡£æ¡ˆä¸­æœ‰æ¡å½¢ç ï¼Œä½†æ‰«ç æŸ¥è¯¢å¤±è´¥

**æ ¹æœ¬åŸå› ï¼š** æ•°æ®åº“ä¸­å­˜åœ¨ä¸¤ç§å­—æ®µå

```javascript
// è¯ææ¡£æ¡ˆè¡¨(drugs)ä¸­å¯èƒ½å­˜åœ¨çš„å­—æ®µåï¼š
{
  "barcode": "6901028075862",  // å°å†™ï¼ˆæ–°ç‰ˆï¼‰
  "barCode": "6901028075862"   // é©¼å³°ï¼ˆæ—§ç‰ˆï¼‰
}
```

**å½“å‰æŸ¥è¯¢é€»è¾‘ï¼š**
```javascript
// âœ… äº‘å‡½æ•°å·²å…¼å®¹ä¸¤ç§å­—æ®µå
const res = await db.collection('drugs')
  .where(_.or([
    { barcode: barcode },      // å°å†™å­—æ®µ
    { barCode: barcode }       // é©¼å³°å­—æ®µ
  ]))
  .get()
```

**ä½†æ˜¯ï¼š** å‰ç«¯ä¿å­˜æ—¶å¯èƒ½åªä¿å­˜äº†ä¸€ç§å­—æ®µåï¼

---

### é—®é¢˜2ï¼šæ¡å½¢ç æ ¼å¼ä¸ä¸€è‡´

**å¯èƒ½çš„é—®é¢˜ï¼š**
1. æ‰«ç ç»“æœåŒ…å«ç©ºæ ¼ã€æ¢è¡Œç¬¦
2. æ•°æ®åº“ä¸­çš„æ¡å½¢ç åŒ…å«ç‰¹æ®Šå­—ç¬¦
3. å¤§å°å†™ä¸ä¸€è‡´

**å½“å‰å¤„ç†ï¼š**
```javascript
// âœ… å‰ç«¯å·²åšæ¸…æ´—
let cleanBarcode = scanRes.result
  .trim()                    // å»é™¤é¦–å°¾ç©ºæ ¼
  .replace(/\s/g, '')        // å»é™¤æ‰€æœ‰ç©ºæ ¼
  .replace(/[\r\n]/g, '')    // å»é™¤æ¢è¡Œç¬¦
```

**ä½†æ˜¯ï¼š** æ•°æ®åº“ä¸­çš„æ¡å½¢ç å¯èƒ½æ²¡æœ‰æ¸…æ´—ï¼

---

### é—®é¢˜3ï¼šæ•°æ®åº“ç´¢å¼•ç¼ºå¤±

**å½±å“ï¼š** æŸ¥è¯¢é€Ÿåº¦æ…¢ï¼Œå¯èƒ½è¶…æ—¶

**å½“å‰çŠ¶æ€ï¼š** æœªçŸ¥æ˜¯å¦åˆ›å»ºç´¢å¼•

**å»ºè®®ï¼š** ä¸º `barcode` å’Œ `barCode` å­—æ®µåˆ›å»ºç´¢å¼•

---

### é—®é¢˜4ï¼šé”™è¯¯æç¤ºä¸å¤Ÿè¯¦ç»†

**å½“å‰æç¤ºï¼š**
```javascript
uni.showToast({
  title: 'æ‰«ç å¤±è´¥ï¼Œè¯·é‡è¯•',
  icon: 'none'
})
```

**é—®é¢˜ï¼š** ç”¨æˆ·ä¸çŸ¥é“ä¸ºä»€ä¹ˆå¤±è´¥ï¼Œæ— æ³•æ’æŸ¥é—®é¢˜

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç»Ÿä¸€å­—æ®µåï¼ˆæ¨èï¼‰â­â­â­â­â­

**ç›®æ ‡ï¼š** å°†æ‰€æœ‰è¯ææ¡£æ¡ˆçš„æ¡å½¢ç å­—æ®µç»Ÿä¸€ä¸º `barcode`ï¼ˆå°å†™ï¼‰

**æ­¥éª¤ï¼š**

#### 1.1 åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬

```javascript
// scripts/migrate-barcode-field.js
const cloud = require('wx-server-sdk')

cloud.init({ env: 'your-env-id' })
const db = cloud.database()

async function migrateBarcode() {
  console.log('å¼€å§‹è¿ç§»æ¡å½¢ç å­—æ®µ...')
  
  // æŸ¥è¯¢æ‰€æœ‰æœ‰ barCode å­—æ®µçš„è¯å“
  const res = await db.collection('drugs')
    .where({
      barCode: db.command.exists(true)
    })
    .get()
  
  console.log(`æ‰¾åˆ° ${res.data.length} æ¡éœ€è¦è¿ç§»çš„è®°å½•`)
  
  let successCount = 0
  let errorCount = 0
  
  for (const drug of res.data) {
    try {
      // å¦‚æœæ²¡æœ‰ barcode å­—æ®µï¼Œä» barCode å¤åˆ¶
      if (!drug.barcode && drug.barCode) {
        await db.collection('drugs').doc(drug._id).update({
          data: {
            barcode: drug.barCode  // å¤åˆ¶åˆ°å°å†™å­—æ®µ
          }
        })
        successCount++
        console.log(`âœ… ${drug.name}: ${drug.barCode}`)
      }
    } catch (err) {
      errorCount++
      console.error(`âŒ ${drug.name}: ${err.message}`)
    }
  }
  
  console.log('========================================')
  console.log(`è¿ç§»å®Œæˆï¼`)
  console.log(`æˆåŠŸ: ${successCount} æ¡`)
  console.log(`å¤±è´¥: ${errorCount} æ¡`)
  console.log('========================================')
}

migrateBarcode()
```

#### 1.2 ä¿®æ”¹ä¿å­˜é€»è¾‘ï¼ˆè¯å“æ¡£æ¡ˆï¼‰

```javascript
// pages-sub/drug/detail.vue
async saveDrug() {
  const updateData = {
    name: this.drugData.name,
    drugName: this.drugData.name,
    barcode: this.drugData.barcode,  // â­ ç»Ÿä¸€ä½¿ç”¨å°å†™
    // ä¸å†ä¿å­˜ barCode å­—æ®µ
    specification: this.drugData.specification,
    // ... å…¶ä»–å­—æ®µ
  }
  
  // ä½¿ç”¨äº‘å‡½æ•°ä¿å­˜
  await wx.cloud.callFunction({
    name: 'drugManage',
    data: {
      action: 'update',
      data: { _id: this.drugId, updateData }
    }
  })
}
```

#### 1.3 ä¿®æ”¹æŸ¥è¯¢é€»è¾‘ï¼ˆç®€åŒ–ï¼‰

```javascript
// cloudfunctions/drugBarcodeQuery/index.js
async function queryLocalDrugs(barcode) {
  // â­ åªæŸ¥è¯¢ barcode å­—æ®µï¼ˆå°å†™ï¼‰
  const res = await db.collection('drugs')
    .where({ barcode: barcode })
    .get()
  
  if (res.data && res.data.length > 0) {
    const drug = res.data[0]
    return {
      name: drug.name,
      specification: drug.specification,
      unit: drug.unit || 'ç›’',
      manufacturer: drug.manufacturer || '',
      barcode: drug.barcode,
      _id: drug._id
    }
  }
  
  return null
}
```

---

### æ–¹æ¡ˆ2ï¼šå¢å¼ºé”™è¯¯è¯Šæ–­ï¼ˆç«‹å³å®æ–½ï¼‰â­â­â­â­

**ç›®æ ‡ï¼š** æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©æ’æŸ¥é—®é¢˜

#### 2.1 ä¿®æ”¹äº‘å‡½æ•°ï¼Œå¢åŠ è°ƒè¯•æ—¥å¿—

```javascript
// cloudfunctions/drugBarcodeQuery/index.js
async function queryLocalDrugs(barcode) {
  try {
    console.log('========================================')
    console.log('ğŸ” å¼€å§‹æŸ¥è¯¢æœ¬åœ°è¯ææ¡£æ¡ˆ')
    console.log('æ¡å½¢ç :', barcode)
    console.log('æ¡å½¢ç é•¿åº¦:', barcode.length)
    console.log('æ¡å½¢ç ç±»å‹:', typeof barcode)
    console.log('========================================')
    
    // æŸ¥è¯¢ä¸¤ç§å­—æ®µå
    const _ = db.command
    const res = await db.collection('drugs')
      .where(_.or([
        { barcode: barcode },
        { barCode: barcode }
      ]))
      .get()
    
    console.log('æŸ¥è¯¢ç»“æœæ•°é‡:', res.data.length)
    
    if (res.data && res.data.length > 0) {
      const drug = res.data[0]
      console.log('âœ… æ‰¾åˆ°è¯å“:', drug.name)
      console.log('   - barcodeå­—æ®µ:', drug.barcode || 'æ— ')
      console.log('   - barCodeå­—æ®µ:', drug.barCode || 'æ— ')
      return formatDrugInfo(drug)
    }
    
    // â­ æœªæ‰¾åˆ°æ—¶ï¼ŒæŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ¡å½¢ç æ ·æœ¬
    console.log('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è¯å“')
    console.log('ğŸ’¡ æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ¡å½¢ç æ ·æœ¬...')
    
    const sampleRes = await db.collection('drugs')
      .field({ name: true, barcode: true, barCode: true })
      .limit(10)
      .get()
    
    console.log('ğŸ“‹ æ•°æ®åº“ä¸­çš„è¯å“æ¡å½¢ç æ ·æœ¬:')
    sampleRes.data.forEach((drug, index) => {
      if (drug.barcode || drug.barCode) {
        console.log(`  ${index + 1}. ${drug.name}`)
        console.log(`     - barcode: ${drug.barcode || 'æ— '}`)
        console.log(`     - barCode: ${drug.barCode || 'æ— '}`)
      }
    })
    
    // â­ æ¨¡ç³ŠåŒ¹é…ï¼ˆå®¹é”™ï¼‰
    console.log('ğŸ’¡ å°è¯•æ¨¡ç³ŠåŒ¹é…...')
    const fuzzyRes = await db.collection('drugs')
      .where(_.or([
        { barcode: db.RegExp({ regexp: barcode, options: 'i' }) },
        { barCode: db.RegExp({ regexp: barcode, options: 'i' }) }
      ]))
      .limit(5)
      .get()
    
    if (fuzzyRes.data.length > 0) {
      console.log('âš ï¸ æ‰¾åˆ°ç›¸ä¼¼çš„æ¡å½¢ç :')
      fuzzyRes.data.forEach((drug, index) => {
        console.log(`  ${index + 1}. ${drug.name}`)
        console.log(`     - barcode: ${drug.barcode || 'æ— '}`)
        console.log(`     - barCode: ${drug.barCode || 'æ— '}`)
      })
    }
    
    return null
  } catch (err) {
    console.error('âŒ æŸ¥è¯¢å¤±è´¥:', err)
    throw err
  }
}
```

#### 2.2 ä¿®æ”¹å‰ç«¯ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯

```javascript
// pages-sub/in/add.vue
async queryDrugByBarcode(barcode) {
  console.log('========================================')
  console.log('ğŸ” å¼€å§‹æŸ¥è¯¢æ¡å½¢ç :', barcode)
  console.log('========================================')
  
  uni.showLoading({ title: 'è¯†åˆ«ä¸­...', mask: true })
  
  try {
    const res = await wx.cloud.callFunction({
      name: 'drugBarcodeQuery',
      data: {
        action: 'queryByBarcode',
        barcode: barcode
      }
    })
    
    console.log('ğŸ“¡ äº‘å‡½æ•°è¿”å›:', res)
    
    uni.hideLoading()
    
    if (res.result && res.result.success) {
      // æ‰¾åˆ°è¯æ
      const drugInfo = res.result.data
      this.addDrugToList(drugInfo)
      
      uni.showToast({
        title: `âœ… å·²æ·»åŠ  (${res.result.source})`,
        icon: 'success'
      })
    } else {
      // â­ æœªæ‰¾åˆ° - æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
      console.log('âŒ æœªæ‰¾åˆ°è¯æ')
      
      uni.showModal({
        title: 'æœªæ‰¾åˆ°è¯æ',
        content: `æ¡å½¢ç ï¼š${barcode}\n\nå¯èƒ½çš„åŸå› ï¼š\n1. è¯¥è¯ææœªå½•å…¥ç³»ç»Ÿ\n2. æ¡å½¢ç æ ¼å¼ä¸åŒ¹é…\n3. æ•°æ®åº“å­—æ®µåä¸ä¸€è‡´\n\nè¯·é€‰æ‹©æ“ä½œï¼š`,
        confirmText: 'æ‰‹åŠ¨æ–°å»º',
        cancelText: 'æŸ¥çœ‹æ—¥å¿—',
        success: (modalRes) => {
          if (modalRes.confirm) {
            // æ‰‹åŠ¨æ–°å»º
            this.newDrug.barcode = barcode
            this.showCreateForm = true
            this.createFormSource = 'manual'
          } else if (modalRes.cancel) {
            // æŸ¥çœ‹æ—¥å¿—ï¼ˆå¼•å¯¼ç”¨æˆ·æŸ¥çœ‹æ§åˆ¶å°ï¼‰
            uni.showModal({
              title: 'è°ƒè¯•ä¿¡æ¯',
              content: 'è¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—\n\næ“ä½œæ­¥éª¤ï¼š\n1. ç‚¹å‡»å¼€å‘è€…å·¥å…·åº•éƒ¨çš„"Console"\n2. æŸ¥çœ‹çº¢è‰²é”™è¯¯ä¿¡æ¯\n3. æˆªå›¾å‘é€ç»™æŠ€æœ¯æ”¯æŒ',
              showCancel: false
            })
          }
        }
      })
    }
  } catch (err) {
    uni.hideLoading()
    console.error('âŒ æŸ¥è¯¢å¤±è´¥:', err)
    
    // â­ è¯¦ç»†çš„é”™è¯¯æç¤º
    let errorMsg = 'æŸ¥è¯¢å¤±è´¥'
    let errorDetail = ''
    
    if (err.errMsg) {
      if (err.errMsg.includes('cloud function not found')) {
        errorMsg = 'äº‘å‡½æ•°æœªéƒ¨ç½²'
        errorDetail = 'è¯·å…ˆéƒ¨ç½² drugBarcodeQuery äº‘å‡½æ•°'
      } else if (err.errMsg.includes('timeout')) {
        errorMsg = 'æŸ¥è¯¢è¶…æ—¶'
        errorDetail = 'ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'
      } else if (err.errMsg.includes('permission')) {
        errorMsg = 'æƒé™ä¸è¶³'
        errorDetail = 'æ•°æ®åº“æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
      } else {
        errorDetail = err.errMsg
      }
    }
    
    uni.showModal({
      title: errorMsg,
      content: errorDetail + '\n\næ˜¯å¦æ‰‹åŠ¨æ–°å»ºè¯æï¼Ÿ',
      confirmText: 'æ‰‹åŠ¨æ–°å»º',
      cancelText: 'å–æ¶ˆ',
      success: (modalRes) => {
        if (modalRes.confirm) {
          this.newDrug.barcode = barcode
          this.showCreateForm = true
          this.createFormSource = 'manual'
        }
      }
    })
  }
}
```

---

### æ–¹æ¡ˆ3ï¼šåˆ›å»ºæ•°æ®åº“ç´¢å¼•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰â­â­â­

**ç›®æ ‡ï¼š** æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼Œé¿å…è¶…æ—¶

**æ“ä½œæ­¥éª¤ï¼š**

1. æ‰“å¼€äº‘å¼€å‘æ§åˆ¶å°
2. è¿›å…¥æ•°æ®åº“ â†’ `drugs` é›†åˆ
3. ç‚¹å‡»"ç´¢å¼•ç®¡ç†"
4. æ·»åŠ ç´¢å¼•ï¼š

```json
{
  "ç´¢å¼•åç§°": "barcode_index",
  "å­—æ®µ": "barcode",
  "ç±»å‹": "å‡åº",
  "å”¯ä¸€": false
}
```

5. å¦‚æœéœ€è¦å…¼å®¹æ—§å­—æ®µï¼Œå†æ·»åŠ ï¼š

```json
{
  "ç´¢å¼•åç§°": "barCode_index",
  "å­—æ®µ": "barCode",
  "ç±»å‹": "å‡åº",
  "å”¯ä¸€": false
}
```

---

### æ–¹æ¡ˆ4ï¼šæ¡å½¢ç æ¸…æ´—å·¥å…·ï¼ˆæ•°æ®ä¿®å¤ï¼‰â­â­â­

**ç›®æ ‡ï¼š** æ¸…æ´—æ•°æ®åº“ä¸­çš„æ¡å½¢ç ï¼Œå»é™¤ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦

```javascript
// scripts/clean-barcodes.js
const cloud = require('wx-server-sdk')

cloud.init({ env: 'your-env-id' })
const db = cloud.database()

async function cleanBarcodes() {
  console.log('å¼€å§‹æ¸…æ´—æ¡å½¢ç ...')
  
  // æŸ¥è¯¢æ‰€æœ‰æœ‰æ¡å½¢ç çš„è¯å“
  const res = await db.collection('drugs')
    .where({
      barcode: db.command.exists(true)
    })
    .get()
  
  console.log(`æ‰¾åˆ° ${res.data.length} æ¡è®°å½•`)
  
  let cleanedCount = 0
  
  for (const drug of res.data) {
    const originalBarcode = drug.barcode
    
    // æ¸…æ´—æ¡å½¢ç 
    const cleanedBarcode = originalBarcode
      .trim()
      .replace(/\s/g, '')
      .replace(/[\r\n]/g, '')
    
    // å¦‚æœæ¸…æ´—åä¸åŒï¼Œæ›´æ–°æ•°æ®åº“
    if (cleanedBarcode !== originalBarcode) {
      await db.collection('drugs').doc(drug._id).update({
        data: {
          barcode: cleanedBarcode
        }
      })
      cleanedCount++
      console.log(`âœ… ${drug.name}: "${originalBarcode}" â†’ "${cleanedBarcode}"`)
    }
  }
  
  console.log(`æ¸…æ´—å®Œæˆï¼å…±æ¸…æ´— ${cleanedCount} æ¡è®°å½•`)
}

cleanBarcodes()
```

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šç«‹å³è¯Šæ–­ï¼ˆ5åˆ†é’Ÿï¼‰

1. âœ… æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. âœ… æ‰“å¼€æ§åˆ¶å°ï¼ˆConsoleï¼‰
3. âœ… æ‰«æä¸€ä¸ªå·²çŸ¥æœ‰æ¡å½¢ç çš„è¯å“
4. âœ… æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œæ‰¾åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š
   - æ‰«æçš„æ¡å½¢ç æ˜¯ä»€ä¹ˆï¼Ÿ
   - äº‘å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨ï¼Ÿ
   - æŸ¥è¯¢ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
   - æ•°æ®åº“ä¸­çš„æ¡å½¢ç å­—æ®µåæ˜¯ä»€ä¹ˆï¼Ÿ

**é¢„æœŸæ—¥å¿—ï¼š**
```
ğŸ” å¼€å§‹æŸ¥è¯¢æ¡å½¢ç : 6901028075862
ğŸ“¡ äº‘å‡½æ•°è¿”å›: { result: { success: false, message: "æœªæ‰¾åˆ°è¯æä¿¡æ¯" } }
âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è¯å“
ğŸ“‹ æ•°æ®åº“ä¸­çš„è¯å“æ¡å½¢ç æ ·æœ¬:
  1. å¸ƒæ´›èŠ¬ç¼“é‡Šèƒ¶å›Š
     - barcode: æ— 
     - barCode: 6901028075862  â† é—®é¢˜åœ¨è¿™é‡Œï¼
```

---

### é˜¶æ®µ2ï¼šå¿«é€Ÿä¿®å¤ï¼ˆ10åˆ†é’Ÿï¼‰

**å¦‚æœå‘ç°å­—æ®µåä¸ä¸€è‡´ï¼š**

1. âœ… è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬ï¼ˆæ–¹æ¡ˆ1.1ï¼‰
2. âœ… é‡æ–°æ‰«ç æµ‹è¯•

**å¦‚æœå‘ç°æ¡å½¢ç æ ¼å¼é—®é¢˜ï¼š**

1. âœ… è¿è¡Œæ¡å½¢ç æ¸…æ´—è„šæœ¬ï¼ˆæ–¹æ¡ˆ4ï¼‰
2. âœ… é‡æ–°æ‰«ç æµ‹è¯•

---

### é˜¶æ®µ3ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆ30åˆ†é’Ÿï¼‰

1. âœ… åˆ›å»ºæ•°æ®åº“ç´¢å¼•ï¼ˆæ–¹æ¡ˆ3ï¼‰
2. âœ… ä¿®æ”¹ä¿å­˜é€»è¾‘ï¼Œç»Ÿä¸€å­—æ®µåï¼ˆæ–¹æ¡ˆ1.2ï¼‰
3. âœ… å¢å¼ºé”™è¯¯è¯Šæ–­ï¼ˆæ–¹æ¡ˆ2ï¼‰
4. âœ… å…¨é¢æµ‹è¯•

---

## ğŸ“ æµ‹è¯•æ¸…å•

### æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸æ‰«ç 

- [ ] æ‰«æå·²å½•å…¥çš„è¯å“æ¡å½¢ç 
- [ ] éªŒè¯æ˜¯å¦æ­£ç¡®è¯†åˆ«
- [ ] éªŒè¯æ˜¯å¦æ­£ç¡®æ·»åŠ åˆ°å…¥åº“åˆ—è¡¨

### æµ‹è¯•åœºæ™¯2ï¼šé¦–æ¬¡æ‰«ç 

- [ ] æ‰«ææœªå½•å…¥çš„è¯å“æ¡å½¢ç 
- [ ] éªŒè¯æ˜¯å¦æç¤º"æœªæ‰¾åˆ°"
- [ ] éªŒè¯æ˜¯å¦å¯ä»¥æ‰‹åŠ¨æ–°å»º

### æµ‹è¯•åœºæ™¯3ï¼šé‡å¤æ‰«ç 

- [ ] æ‰«æå·²æ·»åŠ åˆ°åˆ—è¡¨çš„è¯å“
- [ ] éªŒè¯æ˜¯å¦æç¤º"å·²æ·»åŠ "

### æµ‹è¯•åœºæ™¯4ï¼šé”™è¯¯å¤„ç†

- [ ] æ‰«ææ— æ•ˆæ¡å½¢ç ï¼ˆå¦‚ï¼š123ï¼‰
- [ ] éªŒè¯æ˜¯å¦æç¤º"æ ¼å¼é”™è¯¯"
- [ ] æ‰«ææ—¶å–æ¶ˆ
- [ ] éªŒè¯æ˜¯å¦æ­£å¸¸è¿”å›

---

## ğŸ” è°ƒè¯•å·¥å…·

### å·¥å…·1ï¼šæ¡å½¢ç æ£€æŸ¥å™¨

```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
async function checkBarcode(barcode) {
  const db = wx.cloud.database()
  const _ = db.command
  
  console.log('========================================')
  console.log('ğŸ” æ¡å½¢ç æ£€æŸ¥å™¨')
  console.log('æ¡å½¢ç :', barcode)
  console.log('========================================')
  
  // æŸ¥è¯¢ barcode å­—æ®µ
  const res1 = await db.collection('drugs')
    .where({ barcode: barcode })
    .get()
  console.log('barcode å­—æ®µåŒ¹é…:', res1.data.length, 'æ¡')
  
  // æŸ¥è¯¢ barCode å­—æ®µ
  const res2 = await db.collection('drugs')
    .where({ barCode: barcode })
    .get()
  console.log('barCode å­—æ®µåŒ¹é…:', res2.data.length, 'æ¡')
  
  // æŸ¥è¯¢æ‰€æœ‰æ¡å½¢ç 
  const res3 = await db.collection('drugs')
    .field({ name: true, barcode: true, barCode: true })
    .limit(20)
    .get()
  
  console.log('========================================')
  console.log('æ•°æ®åº“ä¸­çš„æ¡å½¢ç æ ·æœ¬:')
  res3.data.forEach((drug, index) => {
    if (drug.barcode || drug.barCode) {
      console.log(`${index + 1}. ${drug.name}`)
      console.log(`   barcode: ${drug.barcode || 'æ— '}`)
      console.log(`   barCode: ${drug.barCode || 'æ— '}`)
    }
  })
  console.log('========================================')
}

// ä½¿ç”¨æ–¹æ³•ï¼š
checkBarcode('6901028075862')
```

### å·¥å…·2ï¼šå­—æ®µç»Ÿè®¡å™¨

```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
async function countBarcodeFields() {
  const db = wx.cloud.database()
  
  // ç»Ÿè®¡æœ‰ barcode å­—æ®µçš„è¯å“
  const count1 = await db.collection('drugs')
    .where({ barcode: db.command.exists(true) })
    .count()
  
  // ç»Ÿè®¡æœ‰ barCode å­—æ®µçš„è¯å“
  const count2 = await db.collection('drugs')
    .where({ barCode: db.command.exists(true) })
    .count()
  
  // ç»Ÿè®¡æ€»æ•°
  const total = await db.collection('drugs').count()
  
  console.log('========================================')
  console.log('ğŸ“Š æ¡å½¢ç å­—æ®µç»Ÿè®¡')
  console.log('========================================')
  console.log('æ€»è¯å“æ•°:', total.total)
  console.log('æœ‰ barcode å­—æ®µ:', count1.total)
  console.log('æœ‰ barCode å­—æ®µ:', count2.total)
  console.log('========================================')
}

countBarcodeFields()
```

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. å­—æ®µå‘½åè§„èŒƒ

**ç»Ÿä¸€ä½¿ç”¨å°å†™+ä¸‹åˆ’çº¿ï¼š**
```javascript
{
  "barcode": "6901028075862",      // âœ… æ¨è
  "drug_name": "å¸ƒæ´›èŠ¬ç¼“é‡Šèƒ¶å›Š",    // âœ… æ¨è
  "approval_number": "å›½è¯å‡†å­—..."  // âœ… æ¨è
}
```

**é¿å…é©¼å³°å‘½åï¼š**
```javascript
{
  "barCode": "6901028075862",      // âŒ ä¸æ¨è
  "drugName": "å¸ƒæ´›èŠ¬ç¼“é‡Šèƒ¶å›Š",    // âŒ ä¸æ¨è
  "approvalNumber": "å›½è¯å‡†å­—..."  // âŒ ä¸æ¨è
}
```

### 2. æ•°æ®éªŒè¯

**ä¿å­˜å‰éªŒè¯ï¼š**
```javascript
function validateBarcode(barcode) {
  // å»é™¤ç©ºæ ¼
  barcode = barcode.trim()
  
  // éªŒè¯æ ¼å¼ï¼ˆ8-14ä½æ•°å­—ï¼‰
  if (!/^\d{8,14}$/.test(barcode)) {
    throw new Error('æ¡å½¢ç æ ¼å¼é”™è¯¯')
  }
  
  return barcode
}
```

### 3. é”™è¯¯å¤„ç†

**æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼š**
```javascript
try {
  // æŸ¥è¯¢æ“ä½œ
} catch (err) {
  console.error('æŸ¥è¯¢å¤±è´¥:', err)
  
  // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„æç¤º
  if (err.code === 'DATABASE_PERMISSION_DENIED') {
    uni.showToast({ title: 'æ•°æ®åº“æƒé™ä¸è¶³' })
  } else if (err.code === 'DATABASE_TIMEOUT') {
    uni.showToast({ title: 'æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·é‡è¯•' })
  } else {
    uni.showToast({ title: 'æŸ¥è¯¢å¤±è´¥: ' + err.message })
  }
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯å“æ¡£æ¡ˆä¿å­˜é—®é¢˜-æœ€ç»ˆè§£å†³æ–¹æ¡ˆ.md](./è¯å“æ¡£æ¡ˆä¿å­˜é—®é¢˜-æœ€ç»ˆè§£å†³æ–¹æ¡ˆ.md)
- [ä¿®å¤-å¸ƒæ´›èŠ¬æ‰«ç é—®é¢˜-2026-01-02.md](../ä¿®å¤-å¸ƒæ´›èŠ¬æ‰«ç é—®é¢˜-2026-01-02.md)
- [äº‘å‡½æ•°éƒ¨ç½²æŒ‡å—.md](../äº‘å‡½æ•°éƒ¨ç½²æŒ‡å—.md)

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒé—®é¢˜

1. **å­—æ®µåä¸ä¸€è‡´** - `barcode` vs `barCode`
2. **æ¡å½¢ç æ ¼å¼ä¸ä¸€è‡´** - åŒ…å«ç©ºæ ¼ã€ç‰¹æ®Šå­—ç¬¦
3. **ç¼ºå°‘æ•°æ®åº“ç´¢å¼•** - æŸ¥è¯¢é€Ÿåº¦æ…¢
4. **é”™è¯¯æç¤ºä¸è¯¦ç»†** - æ— æ³•æ’æŸ¥é—®é¢˜

### è§£å†³æ–¹æ¡ˆä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ–¹æ¡ˆ | é¢„è®¡æ•ˆæœ | å®æ–½éš¾åº¦ |
|--------|------|----------|----------|
| ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ | å¢å¼ºé”™è¯¯è¯Šæ–­ | ç«‹å³å®šä½é—®é¢˜ | ä½ |
| ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ | ç»Ÿä¸€å­—æ®µå | å½»åº•è§£å†³é—®é¢˜ | ä¸­ |
| ğŸ”¥ğŸ”¥ğŸ”¥ | åˆ›å»ºæ•°æ®åº“ç´¢å¼• | æå‡æ€§èƒ½ | ä½ |
| ğŸ”¥ğŸ”¥ | æ¡å½¢ç æ¸…æ´— | æé«˜åŒ¹é…ç‡ | ä¸­ |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **ç«‹å³æ‰§è¡Œï¼š** æ‰“å¼€æ§åˆ¶å°ï¼Œæ‰«ç æŸ¥çœ‹æ—¥å¿—
2. âœ… **å¿«é€Ÿä¿®å¤ï¼š** æ ¹æ®æ—¥å¿—ç»“æœï¼Œè¿è¡Œå¯¹åº”çš„ä¿®å¤è„šæœ¬
3. âœ… **é•¿æœŸä¼˜åŒ–ï¼š** ç»Ÿä¸€å­—æ®µåï¼Œåˆ›å»ºç´¢å¼•ï¼Œå¢å¼ºé”™è¯¯å¤„ç†

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š** 2026å¹´1æœˆ3æ—¥  
**æœ€åæ›´æ–°æ—¶é—´ï¼š** 2026å¹´1æœˆ3æ—¥  
**çŠ¶æ€ï¼š** âœ… å¾…å®æ–½


