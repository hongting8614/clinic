# ğŸ“¦ å…¥åº“æ¨¡å—å®Œæ•´åŠŸèƒ½è¯´æ˜

**ç‰ˆæœ¬**: v3.5  
**å®Œæˆæ—¥æœŸ**: 2025-11-04  
**çŠ¶æ€**: âœ… å¼€å‘å®Œæˆ

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å…¥åº“æ¨¡å—å·²å®Œæˆä»æ—§å¡ç‰‡å¼UIåˆ°æ–°è¡¨æ ¼å¼UIçš„å…¨é¢é‡æ„ï¼Œå®ç°äº†å®Œæ•´çš„åŒç­¾åå®¡æ ¸æµç¨‹å’Œå¤šç§è¯æå½•å…¥æ–¹å¼ã€‚

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. è¯æå½•å…¥æ–¹å¼ï¼ˆä¸‰ç§ï¼‰

#### ğŸ“· æ‰«ç å…¥åº“
- è°ƒç”¨å¾®ä¿¡æ‰«ç API (`uni.scanCode`)
- è‡ªåŠ¨æŸ¥è¯¢äº‘æ•°æ®åº“ä¸­çš„è¯æä¿¡æ¯
- æ”¯æŒ**è¿ç»­æ‰«ç æ¨¡å¼**ï¼ˆè‡ªåŠ¨å†æ¬¡å”¤èµ·æ‰«ç ï¼‰
- æœªæ‰¾åˆ°è¯ææ—¶å¼•å¯¼æ‰‹åŠ¨å½•å…¥
- ç”¨æˆ·å–æ¶ˆæ‰«ç ä¸æ˜¾ç¤ºé”™è¯¯æç¤º

**å®ç°ä½ç½®**: `pages-sub/in/add.vue` - `handleScan()` æ–¹æ³•

```javascript
async handleScan() {
  this.scanning = true
  try {
    const res = await uni.scanCode({ onlyFromCamera: true })
    const barcode = res[1].result
    
    // è°ƒç”¨äº‘å‡½æ•°æŸ¥è¯¢è¯æ
    const result = await wx.cloud.callFunction({
      name: 'drugManage',
      data: { action: 'getByBarcode', data: { barcode } }
    })
    
    if (result.result.success && result.result.data) {
      this.addDrugToList(result.result.data, 'scan')
      
      // è¿ç»­æ‰«ç æ¨¡å¼
      if (this.continuousScan) {
        setTimeout(() => this.handleScan(), 500)
      }
    } else {
      // æœªæ‰¾åˆ°ï¼Œå¼•å¯¼æ‰‹åŠ¨å½•å…¥
      uni.showModal({
        title: 'æœªæ‰¾åˆ°è¯æ',
        content: 'è¯¥æ¡ç æœªåœ¨ç³»ç»Ÿä¸­æ‰¾åˆ°ï¼Œæ˜¯å¦æ‰‹åŠ¨å½•å…¥ï¼Ÿ',
        success: (res) => {
          if (res.confirm) this.handleCreateDrug(barcode)
        }
      })
    }
  } catch (err) {
    if (!err.errMsg?.includes('cancel')) {
      uni.showToast({ title: err.errMsg || 'æ‰«ç å¤±è´¥', icon: 'none' })
    }
  } finally {
    this.scanning = false
  }
}
```

#### ğŸ“‹ ä»æ¡£æ¡ˆé€‰æ‹©
- å¯¼èˆªåˆ°è¯æåˆ—è¡¨é¡µï¼ˆ`pages-sub/drug/list.vue?mode=select`ï¼‰
- æ”¯æŒæœç´¢ï¼ˆåç§°/æ‹¼éŸ³ï¼‰å’Œåˆ†ç±»ç­›é€‰
- ä½¿ç”¨å…¨å±€äº‹ä»¶ `uni.$emit('drugSelected')` ä¼ é€’æ•°æ®
- è‡ªåŠ¨è¿”å›å¹¶æ·»åŠ åˆ°æ˜ç»†è¡¨æ ¼

**å®ç°ä½ç½®**:
- å…¥åº“é¡µ: `pages-sub/in/add.vue` - `handleSelectDrug()`, `onDrugSelected()`
- è¯æåˆ—è¡¨é¡µ: `pages-sub/drug/list.vue` - `mode='select'`

```javascript
// å…¥åº“é¡µç›‘å¬
onLoad() {
  uni.$on('drugSelected', this.onDrugSelected)
}

onDrugSelected(drugInfo) {
  this.addDrugToList(drugInfo, 'select')
}

// è¯æåˆ—è¡¨é¡µè§¦å‘
selectDrug(item) {
  uni.$emit('drugSelected', {
    _id: item._id,
    drugCode: item.barcode || '',
    name: item.name,
    specification: item.spec,
    unit: item.unit,
    manufacturer: item.manufacturer,
    // ...å…¶ä»–å­—æ®µ
  })
  uni.navigateBack()
}
```

#### âœï¸ æ–°å»ºè¯æ
- å¯¼èˆªåˆ°æ–°å»ºè¯æé¡µé¢
- å¯é¢„å¡«æ¡å½¢ç ï¼ˆæ‰«ç æœªæ‰¾åˆ°æ—¶ï¼‰
- æ–°å»ºæˆåŠŸåè¿”å›ï¼ˆå¾…å®ç°å›è°ƒï¼‰

**å®ç°ä½ç½®**: `pages-sub/in/add.vue` - `handleCreateDrug()`

---

### 2. è¡¨æ ¼å¼æ˜ç»†å½•å…¥

#### è¡¨æ ¼åˆ—ç»“æ„

| åºå· | åˆ—å | å­—æ®µ | å¿…å¡« | ç±»å‹ | è¯´æ˜ |
|------|------|------|------|------|------|
| 1 | # | index | - | æ–‡æœ¬ | è‡ªåŠ¨åºå· |
| 2 | è¯æåç§° | drugName | âœ… | æ–‡æœ¬ | å·¦å¯¹é½ï¼Œå¯çœç•¥æ˜¾ç¤º |
| 3 | æ¡å½¢ç  | drugCode | - | æ–‡æœ¬ | ç­‰å®½å­—ä½“ï¼Œæ— æ•°æ®æ˜¾ç¤º"-" |
| 4 | è§„æ ¼ | specification | âœ… | æ–‡æœ¬ | å¯çœç•¥æ˜¾ç¤º |
| 5 | å•ä½ | unit | âœ… | æ–‡æœ¬ | - |
| 6 | å‚å®¶ | manufacturer | - | æ–‡æœ¬ | å¯çœç•¥æ˜¾ç¤º |
| 7 | æ‰¹å· | batch | âœ… | è¾“å…¥æ¡† | å¯ç¼–è¾‘ |
| 8 | ç”Ÿäº§æ—¥æœŸ | productionDate | âœ… | æ—¥æœŸé€‰æ‹©å™¨ | é™åˆ¶èŒƒå›´ï¼š2020-01-01 ~ ä»Šå¤© |
| 9 | æœ‰æ•ˆæœŸ | expireDate | âœ… | æ—¥æœŸé€‰æ‹©å™¨ | é™åˆ¶èŒƒå›´ï¼šä»Šå¤© ~ 2030-12-31 |
| 10 | è·æœ‰æ•ˆæœŸ(å¤©) | daysToExpiry | - | è®¡ç®—å­—æ®µ | è‡ªåŠ¨è®¡ç®—ï¼Œé¢œè‰²æ ‡è¯† |
| 11 | åº“å­˜/æ¨è | stockQuantity | - | æ–‡æœ¬ | æ˜¾ç¤ºå½“å‰åº“å­˜ |
| 12 | å…¥åº“æ•°é‡ | quantity | âœ… | æ•°å­—è¾“å…¥æ¡† | å¿…é¡»>0 |
| 13 | å•ä»· | price | - | é‡‘é¢è¾“å…¥æ¡† | ä¸èƒ½ä¸ºè´Ÿæ•° |
| 14 | é‡‘é¢ | amount | - | è®¡ç®—å­—æ®µ | quantity Ã— price |
| 15 | æ“ä½œ | - | - | æŒ‰é’® | åˆ é™¤ï¼ˆäºŒæ¬¡ç¡®è®¤ï¼‰ |

**å®ç°ç»„ä»¶**: `components/in-entry-table/index.vue`

#### è¡¨æ ¼ç‰¹æ€§
- âœ… æ¨ªå‘æ»šåŠ¨æ”¯æŒ (`scroll-view`)
- âœ… å›ºå®šè¡¨å¤´ (`position: sticky`)
- âœ… å¿…å¡«é¡¹çº¢è‰²æ˜Ÿå·æ ‡è¯†
- âœ… é”™è¯¯è¡Œé«˜äº®èƒŒæ™¯è‰² (`has-error`)
- âœ… è¿‘æ•ˆæœŸè¯ææ©™è‰²è­¦å‘Šï¼ˆâ‰¤60å¤©ï¼‰
- âœ… è¿‡æœŸè¯æçº¢è‰²è­¦å‘Šï¼ˆâ‰¤0å¤©ï¼‰
- âœ… ç­‰å®½å­—ä½“æ˜¾ç¤ºæ¡å½¢ç 
- âœ… å®æ—¶è®¡ç®—æ€»å“ç§æ•°ã€æ€»æ•°é‡ã€æ€»é‡‘é¢
- âœ… åº•éƒ¨æ˜¾ç¤ºéªŒè¯é”™è¯¯åˆ—è¡¨

---

### 3. å®æ—¶éªŒè¯

#### éªŒè¯è§„åˆ™
```javascript
// æ‰¹å·éªŒè¯
if (!item.batch) {
  errorMessage = 'æ‰¹å·ä¸èƒ½ä¸ºç©º'
}

// ç”Ÿäº§æ—¥æœŸéªŒè¯
if (!item.productionDate) {
  errorMessage = 'ç”Ÿäº§æ—¥æœŸä¸èƒ½ä¸ºç©º'
}

// æœ‰æ•ˆæœŸéªŒè¯
if (!item.expireDate) {
  errorMessage = 'æœ‰æ•ˆæœŸä¸èƒ½ä¸ºç©º'
}
if (item.productionDate && item.expireDate && 
    new Date(item.productionDate) > new Date(item.expireDate)) {
  errorMessage = 'æœ‰æ•ˆæœŸä¸èƒ½æ—©äºç”Ÿäº§æ—¥æœŸ'
}

// æ•°é‡éªŒè¯
if (!item.quantity || item.quantity <= 0) {
  errorMessage = 'æ•°é‡å¿…é¡»å¤§äº0'
}

// å•ä»·éªŒè¯
if (item.price !== '' && (isNaN(item.price) || item.price < 0)) {
  errorMessage = 'å•ä»·ä¸èƒ½ä¸ºè´Ÿæ•°'
}
```

#### éªŒè¯è§¦å‘æ—¶æœº
- è¾“å…¥æ¡†å¤±ç„¦æ—¶ (`@blur`)
- æ—¥æœŸé€‰æ‹©å™¨å˜æ›´æ—¶ (`@change`)
- æäº¤å‰å…¨é‡éªŒè¯

#### éªŒè¯ç»“æœ
```javascript
{
  valid: Boolean,
  errors: [
    { rowIndex: 0, field: 'batch', message: 'æ‰¹å·ä¸èƒ½ä¸ºç©º' },
    { rowIndex: 1, field: 'quantity', message: 'æ•°é‡å¿…é¡»å¤§äº0' }
  ]
}
```

**å®ç°ä½ç½®**: `components/in-entry-table/index.vue` - `validateField()`, `validateAll()`

---

### 4. åŒç­¾åå®¡æ ¸æµç¨‹

#### æµç¨‹çŠ¶æ€
```
draft (è‰ç¨¿)
  â†“ ä¿å­˜è‰ç¨¿
draft (è‰ç¨¿)
  â†“ æäº¤å¤æ ¸ + æ“ä½œå‘˜ç­¾å
pending_review (å¾…å¤æ ¸)
  â†“ å¤æ ¸é€šè¿‡ + å¤æ ¸å‘˜ç­¾å
completed (å·²å®Œæˆ) + è‡ªåŠ¨æ›´æ–°åº“å­˜
  â†“ æˆ–é©³å›
rejected (å·²é©³å›)
```

#### æ“ä½œå‘˜ç­¾å
- **æ—¶æœº**: ç‚¹å‡»"æäº¤å¤æ ¸"æ—¶
- **ç»„ä»¶**: `components/signature/index.vue`
- **å­˜å‚¨**: ç­¾åå›¾ç‰‡ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ŒURLä¿å­˜åˆ° `operatorSign` å­—æ®µ
- **éªŒè¯**: å¿…é¡»ç­¾åæ‰èƒ½æäº¤

```javascript
async submitReview() {
  if (!this.operatorSign) {
    uni.showToast({ title: 'è¯·å…ˆç­¾å', icon: 'none' })
    return
  }
  
  const result = await this.$api.callFunction('inRecords', {
    action: 'create',
    data: {
      recordNo: this.recordNo,
      items: this.drugList.map(drug => ({ ... })),
      operator: this.operator,
      operatorId: userInfo._id,
      operatorSign: this.operatorSign,
      operatorSignTime: new Date(),
      status: 'pending_review'
    }
  })
}
```

#### å¤æ ¸å‘˜ç­¾å
- **æ—¶æœº**: åœ¨è¯¦æƒ…é¡µç‚¹å‡»"é€šè¿‡å¤æ ¸"æ—¶
- **ç»„ä»¶**: `components/signature/index.vue`
- **å­˜å‚¨**: ç­¾åå›¾ç‰‡URLä¿å­˜åˆ° `reviewerSign` å­—æ®µ
- **éªŒè¯**: å¿…é¡»ç­¾åä¸”ä¸èƒ½å¤æ ¸è‡ªå·±çš„å•æ®

```javascript
async handleApprove() {
  if (!this.reviewerSign) {
    uni.showToast({ title: 'è¯·å…ˆç­¾å', icon: 'none' })
    return
  }
  
  await callFunction('inRecords', {
    action: 'approve',
    data: {
      _id: this.recordId,
      reviewer: 'å¤æ ¸å‘˜',
      reviewerId: this.currentUserId,
      reviewerSign: this.reviewerSign,
      reviewerSignTime: new Date()
    }
  })
}
```

**äº‘å‡½æ•°é€»è¾‘** (`cloudfunctions/inRecords/index.js`):
```javascript
async function approve(data, wxContext) {
  const { _id, reviewer, reviewerId, reviewerSign } = data
  
  // æ£€æŸ¥è®°å½•çŠ¶æ€
  const record = await db.collection('in_records').doc(_id).get()
  
  if (record.data.status !== 'pending_review') {
    throw new Error('åªèƒ½å¤æ ¸å¾…å®¡æ ¸çš„å•æ®')
  }
  
  // ä¸èƒ½è‡ªå·±å¤æ ¸è‡ªå·±çš„å•æ®
  if (record.data.operatorId === reviewerId) {
    throw new Error('ä¸èƒ½è‡ªå·±å¤æ ¸è‡ªå·±çš„å•æ®')
  }
  
  // æ›´æ–°çŠ¶æ€
  await db.collection('in_records').doc(_id).update({
    data: {
      status: 'completed',
      reviewer,
      reviewerId,
      reviewerSign,
      reviewerSignTime: new Date(),
      completeTime: new Date()
    }
  })
  
  // è‡ªåŠ¨æ›´æ–°åº“å­˜
  for (const item of record.data.items) {
    await updateStock({ ...item, action: 'in' })
  }
  
  return { success: true, message: 'å¤æ ¸é€šè¿‡ï¼Œåº“å­˜å·²æ›´æ–°' }
}
```

---

### 5. åº“å­˜è‡ªåŠ¨æ›´æ–°

#### æ›´æ–°æ—¶æœº
- å¤æ ¸é€šè¿‡ï¼ˆ`status: completed`ï¼‰æ—¶è‡ªåŠ¨è§¦å‘
- ç”±äº‘å‡½æ•° `inRecords/approve` è°ƒç”¨ `updateStock`

#### æ›´æ–°é€»è¾‘
```javascript
async function updateStock(data) {
  const { drugId, batch, location, quantity, action } = data
  
  // æŸ¥æ‰¾æ‰¹æ¬¡
  const stockQuery = await db.collection('stock').where({
    drugId,
    batch,
    location
  }).get()
  
  if (stockQuery.data.length > 0) {
    // å·²å­˜åœ¨ï¼Œç´¯åŠ æ•°é‡
    const stock = stockQuery.data[0]
    const newQuantity = action === 'in' 
      ? stock.quantity + quantity 
      : stock.quantity - quantity
    
    await db.collection('stock').doc(stock._id).update({
      data: { quantity: newQuantity, updateTime: new Date() }
    })
  } else {
    // ä¸å­˜åœ¨ï¼Œæ–°å¢åº“å­˜è®°å½•
    await db.collection('stock').add({
      data: {
        drugId,
        drugName,
        batch,
        quantity,
        expireDate,
        status: calculateStatus(expireDate), // 'normal', 'near_expire', 'expired'
        createTime: new Date()
      }
    })
  }
}
```

#### æ•ˆæœŸçŠ¶æ€è®¡ç®—
```javascript
const daysToExpire = Math.floor((new Date(expireDate) - new Date()) / (1000 * 60 * 60 * 24))

let status = 'normal'
if (daysToExpire < 0) {
  status = 'expired'
} else if (daysToExpire <= 90) {
  status = 'near_expire'
}
```

---

## ğŸ“„ é¡µé¢ç»“æ„

### å…¥åº“å•åˆ—è¡¨é¡µ (`pages-sub/in/list.vue`)

#### åŠŸèƒ½
- âœ… æ ‡ç­¾ç­›é€‰ï¼ˆå…¨éƒ¨ã€è‰ç¨¿ã€å¾…å¤æ ¸ã€å·²å®Œæˆã€å·²é©³å›ï¼‰
- âœ… å®æ—¶æ•°é‡å¾½ç« 
- âœ… ä¸‹æ‹‰åˆ·æ–°
- âœ… åˆ†é¡µåŠ è½½
- âœ… æƒé™åˆ¤æ–­ï¼ˆåªèƒ½ç¼–è¾‘è‡ªå·±çš„è‰ç¨¿ã€åªèƒ½å¤æ ¸åˆ«äººçš„å•æ®ï¼‰

#### çŠ¶æ€æ ·å¼
```scss
.status-draft { background-color: #999999; }
.status-pending_review { background-color: #FF9800; }
.status-completed { background-color: #4CAF50; }
.status-rejected { background-color: #FF6B6B; }
```

---

### å…¥åº“å•è¯¦æƒ…é¡µ (`pages-sub/in/detail.vue`)

#### åŠŸèƒ½
- âœ… æµç¨‹æŒ‡ç¤ºå™¨ï¼ˆåˆ›å»º â†’ å¤æ ¸ â†’ å®Œæˆï¼‰
- âœ… çŠ¶æ€å¾½ç« 
- âœ… åŸºæœ¬ä¿¡æ¯å±•ç¤º
- âœ… è¯ææ˜ç»†å±•ç¤ºï¼ˆå¡ç‰‡å¼ï¼‰
- âœ… æ“ä½œå‘˜ç­¾åå±•ç¤º
- âœ… å¤æ ¸å‘˜ç­¾åå±•ç¤ºï¼ˆå·²å®Œæˆæ—¶ï¼‰
- âœ… é©³å›åŸå› å±•ç¤ºï¼ˆå·²é©³å›æ—¶ï¼‰
- âœ… å¤æ ¸æ“ä½œåŒºï¼ˆå¾…å¤æ ¸ + action=reviewæ—¶ï¼‰
- âœ… åº•éƒ¨æ“ä½œæŒ‰é’®ï¼ˆç¼–è¾‘ã€åˆ é™¤ã€é€šè¿‡ã€é©³å›ï¼‰

#### æ“ä½œæƒé™
```javascript
computed: {
  canEdit() {
    return (this.record.status === 'draft' || this.record.status === 'rejected') && 
           this.record.operatorId === this.currentUserId
  },
  
  showActions() {
    return (this.isReviewAction && this.record.status === 'pending_review') || 
           this.canEdit || 
           this.record.status === 'completed'
  }
}
```

---

### å…¥åº“å•æ–°å»ºé¡µ (`pages-sub/in/add.vue`)

#### é¡µé¢ç»“æ„
```vue
<template>
  <view class="container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <view class="page-header">
      <view class="page-title">çˆ±åº·åŒ»åŠ¡å®¤ç®¡ç†ç³»ç»Ÿ</view>
      <view class="page-subtitle">åŒ—äº¬æ¬¢ä¹è°·åŒ»åŠ¡å®¤ Â· è¯æå…¥åº“å•</view>
    </view>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      <view class="form-item">å…¥åº“å•å·ï¼š{{ recordNo || 'è‡ªåŠ¨ç”Ÿæˆ' }}</view>
      <view class="form-item">å…¥åº“æ—¶é—´ï¼š{{ currentTime }}</view>
      <view class="form-item">æ“ä½œäººï¼š{{ operator }}</view>
      <input v-model="supplier" placeholder="è¯·è¾“å…¥ä¾›åº”å•†åç§°ï¼ˆé€‰å¡«ï¼‰" />
    </view>
    
    <!-- è¯ææ˜ç»† -->
    <view class="form-section">
      <view class="section-title">è¯ææ˜ç»†</view>
      
      <!-- å·¥å…·æ¡ -->
      <in-entry-toolbar
        :loading-scan="scanning"
        :continuous="continuousScan"
        @scan="handleScan"
        @select="handleSelectDrug"
        @create="handleCreateDrug"
        @clear="handleClearAll"
        @update:continuous="continuousScan = $event"
      ></in-entry-toolbar>
      
      <!-- æ˜ç»†è¡¨æ ¼ -->
      <in-entry-table
        v-model="drugList"
        @validate="onValidate"
        @delete-row="onDeleteRow"
      ></in-entry-table>
    </view>
    
    <!-- ç­¾ååŒºåŸŸ -->
    <view class="form-section">
      <view class="section-title">æ“ä½œå‘˜ç­¾å *</view>
      <signature v-model="operatorSign" title="æ“ä½œå‘˜ç­¾å"></signature>
    </view>
    
    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="bottom-actions">
      <u-button type="info" text="ä¿å­˜è‰ç¨¿" plain @click="saveDraft"></u-button>
      <u-button type="primary" text="æäº¤å¤æ ¸" @click="submitReview"></u-button>
    </view>
  </view>
</template>
```

---

## ğŸ”§ ç»„ä»¶è¯´æ˜

### 1. `components/in-entry-toolbar/index.vue`

è¯æå½•å…¥å·¥å…·æ¡ç»„ä»¶

**Props**:
```javascript
{
  loadingScan: Boolean, // æ‰«ç åŠ è½½çŠ¶æ€
  continuous: Boolean   // è¿ç»­æ‰«ç æ¨¡å¼
}
```

**Events**:
```javascript
{
  '@scan': () => {},         // æ‰«ç 
  '@select': () => {},       // ä»æ¡£æ¡ˆé€‰æ‹©
  '@create': () => {},       // æ–°å»ºè¯æ
  '@clear': () => {},        // æ¸…ç©ºæ˜ç»†
  '@update:continuous': (val) => {} // è¿ç»­æ‰«ç çŠ¶æ€æ›´æ–°
}
```

---

### 2. `components/in-entry-table/index.vue`

å¯ç¼–è¾‘æ˜ç»†è¡¨æ ¼ç»„ä»¶

**Props**:
```javascript
{
  value: Array // v-modelç»‘å®šçš„è¯æåˆ—è¡¨
}
```

**Events**:
```javascript
{
  '@input': (newVal) => {},       // æ•°æ®å˜æ›´
  '@validate': (result) => {},    // æ ¡éªŒç»“æœ
  '@delete-row': (index) => {}    // åˆ é™¤è¡Œ
}
```

**æ•°æ®ç»“æ„**:
```javascript
[
  {
    drugId: 'drug_001',
    drugCode: '6901234567890',
    drugName: 'é˜¿è«è¥¿æ—èƒ¶å›Š',
    specification: '0.25g*24ç²’',
    unit: 'ç›’',
    manufacturer: 'XXåˆ¶è¯',
    batch: '20250101',
    productionDate: '2025-01-01',
    expireDate: '2027-01-01',
    daysToExpiry: 730,
    stockQuantity: undefined,
    quantity: 100,
    price: 12.5,
    isHighValue: false,
    isEmergency: false,
    source: 'scan', // 'scan' | 'select' | 'manual'
    tempId: '1730723456789.123' // å‰ç«¯ä¸´æ—¶ID
  }
]
```

---

## ğŸ“¡ äº‘å‡½æ•° API

### `inRecords` äº‘å‡½æ•°

**Actions**:

#### 1. `create` - åˆ›å»ºå…¥åº“å•
```javascript
{
  action: 'create',
  data: {
    recordNo: 'RK20251104001',
    supplier: 'XXåŒ»è¯å…¬å¸',
    items: [...],
    operator: 'å¼ ä¸‰',
    operatorId: 'user_001',
    operatorSign: 'https://...',
    operatorSignTime: new Date(),
    status: 'pending_review' // 'draft' | 'pending_review'
  }
}
```

#### 2. `update` - æ›´æ–°å…¥åº“å•
```javascript
{
  action: 'update',
  data: {
    _id: 'in_001',
    supplier: 'æ–°ä¾›åº”å•†',
    items: [...],
    // åªèƒ½æ›´æ–°è‰ç¨¿æˆ–å·²é©³å›çš„å•æ®
  }
}
```

#### 3. `getList` - è·å–åˆ—è¡¨
```javascript
{
  action: 'getList',
  data: {
    status: 'pending_review', // 'all' | 'draft' | 'pending_review' | 'completed' | 'rejected'
    page: 1,
    pageSize: 10
  }
}
```

#### 4. `getDetail` - è·å–è¯¦æƒ…
```javascript
{
  action: 'getDetail',
  data: { _id: 'in_001' }
}
```

#### 5. `approve` - å¤æ ¸é€šè¿‡
```javascript
{
  action: 'approve',
  data: {
    _id: 'in_001',
    reviewer: 'æå››',
    reviewerId: 'user_002',
    reviewerSign: 'https://...',
    reviewerSignTime: new Date()
  }
}
// è‡ªåŠ¨æ›´æ–°åº“å­˜
```

#### 6. `reject` - å¤æ ¸é©³å›
```javascript
{
  action: 'reject',
  data: {
    _id: 'in_001',
    reviewer: 'æå››',
    reviewerId: 'user_002',
    rejectReason: 'æ‰¹å·å¡«å†™ä¸è§„èŒƒ'
  }
}
```

#### 7. `delete` - åˆ é™¤
```javascript
{
  action: 'delete',
  data: { _id: 'in_001' }
  // åªèƒ½åˆ é™¤è‰ç¨¿
}
```

#### 8. `getCounts` - è·å–æ•°é‡ç»Ÿè®¡
```javascript
{
  action: 'getCounts',
  data: {}
}
// è¿”å›: { draft: 2, pending_review: 5, completed: 100, rejected: 3, all: 110, today: 8 }
```

---

## ğŸ¨ UI/UX è®¾è®¡äº®ç‚¹

### 1. é¢œè‰²ç³»ç»Ÿ
```scss
// ä¸»è‰²è°ƒ
$primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

// çŠ¶æ€è‰²
$draft: #999999;
$pending: #FF9800;
$completed: #4CAF50;
$rejected: #FF6B6B;

// è­¦å‘Šè‰²
$warning: #FF9800;  // è¿‘æ•ˆæœŸ
$danger: #FF4500;   // å·²è¿‡æœŸ
```

### 2. å“åº”å¼è®¾è®¡
- è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ï¼Œé€‚é…çª„å±å¹•
- å·¥å…·æ¡è‡ªåŠ¨æ¢è¡Œ
- åº•éƒ¨æ“ä½œæ å›ºå®šå®šä½

### 3. äº¤äº’ç»†èŠ‚
- æ‰«ç æŒ‰é’®loadingçŠ¶æ€
- åˆ é™¤æ“ä½œäºŒæ¬¡ç¡®è®¤
- æ¸…ç©ºæ˜ç»†äºŒæ¬¡ç¡®è®¤
- æäº¤å‰å…¨é‡éªŒè¯
- æˆåŠŸ/å¤±è´¥toastæç¤º
- 1.5ç§’åè‡ªåŠ¨è¿”å›

### 4. å¯è®¿é—®æ€§
- å¿…å¡«é¡¹çº¢è‰²æ˜Ÿå·
- é”™è¯¯è¡Œé«˜äº®èƒŒæ™¯
- é”™è¯¯åˆ—è¡¨åº•éƒ¨æ˜¾ç¤º
- ç­‰å®½å­—ä½“æ˜¾ç¤ºæ¡å½¢ç 
- è¿‘æ•ˆæœŸ/è¿‡æœŸé¢œè‰²è­¦å‘Š

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### `in_records` è¡¨

```javascript
{
  _id: String,
  recordNo: String,              // å…¥åº“å•å·
  status: String,                // 'draft' | 'pending_review' | 'completed' | 'rejected'
  items: [                       // è¯ææ˜ç»†
    {
      drugId: String,
      drugCode: String,
      drugName: String,
      specification: String,
      unit: String,
      manufacturer: String,
      batch: String,
      productionDate: String,    // YYYY-MM-DD
      expireDate: String,        // YYYY-MM-DD
      quantity: Number,
      price: Number,
      isHighValue: Boolean,
      isEmergency: Boolean
    }
  ],
  supplier: String,              // ä¾›åº”å•†ï¼ˆé€‰å¡«ï¼‰
  operator: String,              // æ“ä½œå‘˜å§“å
  operatorId: String,            // æ“ä½œå‘˜ID
  operatorSign: String,          // æ“ä½œå‘˜ç­¾åURL
  operatorSignTime: Date,        // æ“ä½œå‘˜ç­¾åæ—¶é—´
  reviewer: String,              // å¤æ ¸å‘˜å§“å
  reviewerId: String,            // å¤æ ¸å‘˜ID
  reviewerSign: String,          // å¤æ ¸å‘˜ç­¾åURL
  reviewerSignTime: Date,        // å¤æ ¸å‘˜ç­¾åæ—¶é—´
  rejectReason: String,          // é©³å›åŸå› 
  createTime: Date,              // åˆ›å»ºæ—¶é—´
  updateTime: Date,              // æ›´æ–°æ—¶é—´
  completeTime: Date             // å®Œæˆæ—¶é—´
}
```

**ç´¢å¼•**:
- `_id`: ä¸»é”®
- `recordNo`: å”¯ä¸€ç´¢å¼•
- `status`: æ™®é€šç´¢å¼•
- `createTime`: æ™®é€šç´¢å¼•

---

## ğŸš€ å¾…æ‰©å±•åŠŸèƒ½

### 1. å¤–éƒ¨APIå¯¹æ¥ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰
- é›†æˆå›½å®¶è¯ç›‘å±€API
- é€šè¿‡æ¡å½¢ç æŸ¥è¯¢å®˜æ–¹è¯ææ•°æ®
- è‡ªåŠ¨å¡«å……è¯æä¿¡æ¯
- æ•°æ®ç¼“å­˜æœºåˆ¶

### 2. æ‰¹é‡æ“ä½œï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
- æ‰¹é‡å¯¼å…¥Excel
- æ‰¹é‡å®¡æ ¸
- æ‰¹é‡å¯¼å‡ºPDF

### 3. æ‰“å°åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
- æ‰“å°å…¥åº“å•ï¼ˆæ ‡å‡†æ ¼å¼ï¼‰
- æ‰“å°éªŒæ”¶æŠ¥å‘Š
- å¯¼å‡ºPDF

### 4. ç»Ÿè®¡æŠ¥è¡¨ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
- æŒ‰ä¾›åº”å•†ç»Ÿè®¡
- æŒ‰æ—¶é—´æ®µç»Ÿè®¡
- æŒ‰è¯æåˆ†ç±»ç»Ÿè®¡

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### æ“ä½œå‘˜æµç¨‹

1. è¿›å…¥"å…¥åº“ç®¡ç†"
2. ç‚¹å‡»"+"æ–°å»ºå…¥åº“å•
3. å¡«å†™ä¾›åº”å•†ï¼ˆé€‰å¡«ï¼‰
4. æ·»åŠ è¯æï¼ˆæ‰«ç /é€‰æ‹©/æ–°å»ºï¼‰
5. å¡«å†™æ‰¹æ¬¡ä¿¡æ¯ï¼ˆæ‰¹å·ã€ç”Ÿäº§æ—¥æœŸã€æœ‰æ•ˆæœŸã€æ•°é‡ã€å•ä»·ï¼‰
6. æ‰‹å†™ç­¾å
7. æäº¤å¤æ ¸

### å¤æ ¸å‘˜æµç¨‹

1. è¿›å…¥"å…¥åº“ç®¡ç†"
2. ç‚¹å‡»"å¾…å¤æ ¸"æ ‡ç­¾
3. é€‰æ‹©å¾…å¤æ ¸å•æ®
4. æ£€æŸ¥è¯ææ˜ç»†
5. æ‰‹å†™ç­¾å
6. ç‚¹å‡»"é€šè¿‡å¤æ ¸"ï¼ˆæˆ–"é©³å›"ï¼‰

### è‰ç¨¿ç®¡ç†

- éšæ—¶ä¿å­˜è‰ç¨¿ï¼ˆä¸éœ€è¦ç­¾åï¼‰
- å¯ç¼–è¾‘è‰ç¨¿
- å¯åˆ é™¤è‰ç¨¿

### é©³å›å¤„ç†

- æŸ¥çœ‹é©³å›åŸå› 
- é‡æ–°ç¼–è¾‘
- é‡æ–°æäº¤

---

## ğŸ”’ æƒé™æ§åˆ¶

| è§’è‰² | åˆ›å»º | ç¼–è¾‘è‰ç¨¿ | åˆ é™¤è‰ç¨¿ | æäº¤å¤æ ¸ | å¤æ ¸é€šè¿‡/é©³å› |
|------|------|---------|---------|---------|--------------|
| æ“ä½œå‘˜ | âœ… | âœ…ï¼ˆè‡ªå·±çš„ï¼‰ | âœ…ï¼ˆè‡ªå·±çš„ï¼‰ | âœ… | âŒ |
| å¤æ ¸å‘˜ | âœ… | âœ…ï¼ˆè‡ªå·±çš„ï¼‰ | âœ…ï¼ˆè‡ªå·±çš„ï¼‰ | âœ… | âœ…ï¼ˆåˆ«äººçš„ï¼‰ |

**è§„åˆ™**:
- âœ… åªèƒ½ç¼–è¾‘/åˆ é™¤è‡ªå·±åˆ›å»ºçš„è‰ç¨¿æˆ–è¢«é©³å›çš„å•æ®
- âœ… ä¸èƒ½å¤æ ¸è‡ªå·±åˆ›å»ºçš„å•æ®
- âœ… åªæœ‰å¾…å¤æ ¸çŠ¶æ€çš„å•æ®æ‰èƒ½è¢«å¤æ ¸

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

1. **ç»„ä»¶åŒ–**: å·¥å…·æ å’Œè¡¨æ ¼ç‹¬ç«‹ç»„ä»¶ï¼Œä¾¿äºå¤ç”¨å’Œç»´æŠ¤
2. **v-modelåŒå‘ç»‘å®š**: å‡å°‘äº‹ä»¶ä¼ é€’ï¼Œç®€åŒ–æ•°æ®æµ
3. **æŒ‰éœ€éªŒè¯**: è¾“å…¥æ¡†å¤±ç„¦æ—¶éªŒè¯ï¼Œé¿å…é¢‘ç¹éªŒè¯
4. **åˆ†é¡µåŠ è½½**: åˆ—è¡¨é¡µåˆ†é¡µåŠ è½½ï¼Œé¿å…ä¸€æ¬¡åŠ è½½å¤§é‡æ•°æ®
5. **äº‹ä»¶æ¸…ç†**: `onUnload` æ—¶ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬ï¼Œé¿å…å†…å­˜æ³„æ¼

---

## ğŸ› å·²çŸ¥é—®é¢˜

æ— 

---

## âœ… æµ‹è¯•æ¸…å•

- [ ] æ‰«ç æ·»åŠ è¯æï¼ˆæ­£å¸¸æµç¨‹ï¼‰
- [ ] æ‰«ç æœªæ‰¾åˆ°è¯æï¼ˆå¼•å¯¼æ‰‹åŠ¨å½•å…¥ï¼‰
- [ ] è¿ç»­æ‰«ç æ¨¡å¼
- [ ] ä»æ¡£æ¡ˆé€‰æ‹©è¯æ
- [ ] æ–°å»ºè¯æ
- [ ] æ¸…ç©ºæ˜ç»†
- [ ] å¿…å¡«é¡¹éªŒè¯
- [ ] æ—¥æœŸé€»è¾‘éªŒè¯ï¼ˆç”Ÿäº§æ—¥æœŸ<æœ‰æ•ˆæœŸï¼‰
- [ ] æ•°é‡éªŒè¯ï¼ˆ>0ï¼‰
- [ ] å•ä»·éªŒè¯ï¼ˆâ‰¥0ï¼‰
- [ ] ä¿å­˜è‰ç¨¿
- [ ] æäº¤å¤æ ¸ï¼ˆæ— ç­¾åï¼‰
- [ ] æäº¤å¤æ ¸ï¼ˆæœ‰ç­¾åï¼‰
- [ ] å¤æ ¸é€šè¿‡ï¼ˆè‡ªå·±çš„å•æ®ï¼‰
- [ ] å¤æ ¸é€šè¿‡ï¼ˆåˆ«äººçš„å•æ®ï¼‰
- [ ] å¤æ ¸é©³å›
- [ ] ç¼–è¾‘å·²é©³å›å•æ®
- [ ] åˆ é™¤è‰ç¨¿
- [ ] åº“å­˜è‡ªåŠ¨æ›´æ–°

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-04  
**ç»´æŠ¤äºº**: AI Assistant









