# 📋 入库功能测试脚本

> 在微信开发者工具的 Console 控制台中执行以下脚本

---

## 🚀 测试1：快速测试入库云函数

**目的**：验证 inRecords 云函数是否正常工作

```javascript
// 测试入库云函数
wx.cloud.callFunction({
  name: 'inRecords',
  data: { 
    action: 'getCounts' 
  }
}).then(res => {
  console.log('✅ inRecords 云函数测试成功！')
  console.log('结果:', res)
}).catch(err => {
  console.error('❌ inRecords 云函数测试失败:', err)
})
```

**预期结果**：
```javascript
✅ inRecords 云函数测试成功！
结果: {
  errMsg: "cloud.callFunction:ok",
  result: {
    success: true,
    data: { draft: 0, pending: 0, approved: 0, rejected: 0 }
  }
}
```

---

## 🧪 测试2：创建测试入库单（完整流程）

**目的**：模拟完整的入库流程

```javascript
(async function testInRecord() {
  console.log('━'.repeat(50))
  console.log('🧪 开始测试入库功能')
  console.log('━'.repeat(50))
  
  const db = wx.cloud.database()
  
  try {
    // ============= 步骤1：检查药材是否存在 =============
    console.log('\n📋 【步骤1】检查测试药材...')
    
    let testDrug = await db.collection('drugs')
      .where({ name: '阿莫西林胶囊' })
      .get()
    
    let drugId
    if (testDrug.data.length === 0) {
      console.log('   ⚠️  药材不存在，正在创建...')
      
      // 创建测试药材
      const addResult = await db.collection('drugs').add({
        data: {
          name: '阿莫西林胶囊',
          specification: '0.25g×24粒/盒',
          unit: '盒',
          category: '抗生素',
          manufacturer: '华北制药',
          approvalNumber: '国药准字H12345678',
          price: 15.80,
          status: 'active',
          createTime: new Date(),
          updateTime: new Date()
        }
      })
      
      drugId = addResult._id
      console.log('   ✅ 药材创建成功，ID:', drugId)
    } else {
      drugId = testDrug.data[0]._id
      console.log('   ✅ 药材已存在，ID:', drugId)
    }
    
    // ============= 步骤2：检查供应商 =============
    console.log('\n🏢 【步骤2】检查测试供应商...')
    
    let supplier = await db.collection('suppliers')
      .where({ name: '康美药业' })
      .get()
    
    if (supplier.data.length === 0) {
      console.log('   ⚠️  供应商不存在，正在创建...')
      
      await db.collection('suppliers').add({
        data: {
          name: '康美药业',
          code: 'SUP001',
          contact: '张经理',
          phone: '13800138000',
          address: '北京市朝阳区',
          status: 'active',
          createTime: new Date(),
          updateTime: new Date()
        }
      })
      
      console.log('   ✅ 供应商创建成功')
    } else {
      console.log('   ✅ 供应商已存在')
    }
    
    // ============= 步骤3：生成入库单号 =============
    console.log('\n🔢 【步骤3】生成入库单号...')
    
    const now = new Date()
    const dateStr = now.getFullYear() + 
                    String(now.getMonth() + 1).padStart(2, '0') + 
                    String(now.getDate()).padStart(2, '0')
    const timeStr = String(now.getHours()).padStart(2, '0') + 
                    String(now.getMinutes()).padStart(2, '0') + 
                    String(now.getSeconds()).padStart(2, '0')
    const recordNo = `RK${dateStr}${timeStr}`
    
    console.log('   ✅ 入库单号:', recordNo)
    
    // ============= 步骤4：准备入库数据 =============
    console.log('\n📦 【步骤4】准备入库数据...')
    
    const inRecordData = {
      recordNo: recordNo,
      recordType: 'purchase',
      supplier: '康美药业',
      supplierContact: '张经理',
      supplierPhone: '13800138000',
      location: 'drug_storage', // v3.14: 统一入库到药库
      operator: '测试用户',
      operatorSign: '',
      reviewer: '',
      reviewerSign: '',
      status: 'draft',
      items: [{
        drugId: drugId,
        drugName: '阿莫西林胶囊',
        specification: '0.25g×24粒/盒',
        manufacturer: '华北制药',
        approvalNumber: '国药准字H12345678',
        batch: 'LOT20251106001',
        productionDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // 30天前
        expireDate: new Date(Date.now() + 730 * 24 * 60 * 60 * 1000), // 730天后(2年)
        quantity: 10, // 包装单位：10盒
        unit: '盒',
        price: 15.80, // 每盒单价
        totalPrice: 158.00,
        specInfo: {
          dosage: 0.25,
          dosageUnit: 'g',
          conversionRate: 24,
          minUnit: '粒',
          packUnit: '盒',
          fullSpec: '0.25g×24粒/盒',
          pattern: 'standard'
        },
        pricePerMin: (15.80 / 24).toFixed(4) // 最小单位单价
      }],
      totalQuantity: 10,
      totalAmount: 158.00,
      remark: '测试入库单',
      createTime: new Date(),
      updateTime: new Date()
    }
    
    console.log('   ✅ 入库数据准备完成')
    console.log('   - 药材：阿莫西林胶囊')
    console.log('   - 规格：0.25g×24粒/盒')
    console.log('   - 数量：10盒（包装单位）')
    console.log('   - 批号：LOT20251106001')
    console.log('   - 金额：¥158.00')
    
    // ============= 步骤5：调用云函数创建入库单 =============
    console.log('\n☁️  【步骤5】调用云函数创建入库单...')
    
    const result = await wx.cloud.callFunction({
      name: 'inRecords',
      data: {
        action: 'create',
        record: inRecordData
      }
    })
    
    if (result.result.success) {
      console.log('   ✅ 入库单创建成功！')
      console.log('   - 记录ID:', result.result.id)
      console.log('   - 单据号:', recordNo)
      
      // ============= 步骤6：验证数据 =============
      console.log('\n🔍 【步骤6】验证入库数据...')
      
      const checkRecord = await db.collection('in_records')
        .doc(result.result.id)
        .get()
      
      console.log('   ✅ 数据验证通过')
      console.log('   - 状态:', checkRecord.data.status)
      console.log('   - 药材数:', checkRecord.data.items.length)
      console.log('   - 总金额:', checkRecord.data.totalAmount)
      
      // ============= 步骤7：查看库存（应该还未更新） =============
      console.log('\n📊 【步骤7】检查库存状态...')
      
      const stockCheck = await db.collection('stock')
        .where({
          drugId: drugId,
          location: 'drug_storage',
          batch: 'LOT20251106001'
        })
        .get()
      
      if (stockCheck.data.length === 0) {
        console.log('   ℹ️  库存未更新（正常，需要复核通过后才更新）')
      } else {
        console.log('   ⚠️  库存已更新:', stockCheck.data[0].quantity, '盒')
      }
      
      // ============= 完成 =============
      console.log('\n' + '━'.repeat(50))
      console.log('🎉 入库功能测试完成！')
      console.log('━'.repeat(50))
      console.log('\n📝 测试结果总结：')
      console.log('   ✅ 药材档案检查通过')
      console.log('   ✅ 供应商检查通过')
      console.log('   ✅ 入库单号生成成功')
      console.log('   ✅ 入库数据准备完成')
      console.log('   ✅ 云函数调用成功')
      console.log('   ✅ 数据验证通过')
      console.log('\n💡 下一步操作：')
      console.log('   1. 查看入库单列表')
      console.log('   2. 测试复核流程（通过后库存才会更新）')
      console.log('   3. 测试出库功能（验证单位转换）')
      console.log('')
      
      // 显示成功提示
      wx.showToast({
        title: '测试成功！',
        icon: 'success',
        duration: 2000
      })
      
      return {
        success: true,
        recordId: result.result.id,
        recordNo: recordNo
      }
      
    } else {
      console.error('   ❌ 入库单创建失败:', result.result.message)
      
      wx.showToast({
        title: '创建失败',
        icon: 'none'
      })
    }
    
  } catch (error) {
    console.error('\n❌ 测试失败:', error)
    console.error('错误详情:', error.message)
    
    wx.showToast({
      title: '测试失败',
      icon: 'none'
    })
  }
})()
```

**预期输出**：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🧪 开始测试入库功能
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 【步骤1】检查测试药材...
   ✅ 药材已存在，ID: xxx

🏢 【步骤2】检查测试供应商...
   ✅ 供应商已存在

🔢 【步骤3】生成入库单号...
   ✅ 入库单号: RK20251106153045

📦 【步骤4】准备入库数据...
   ✅ 入库数据准备完成
   - 药材：阿莫西林胶囊
   - 规格：0.25g×24粒/盒
   - 数量：10盒（包装单位）
   - 批号：LOT20251106001
   - 金额：¥158.00

☁️  【步骤5】调用云函数创建入库单...
   ✅ 入库单创建成功！
   - 记录ID: xxx
   - 单据号: RK20251106153045

🔍 【步骤6】验证入库数据...
   ✅ 数据验证通过
   - 状态: draft
   - 药材数: 1
   - 总金额: 158

📊 【步骤7】检查库存状态...
   ℹ️  库存未更新（正常，需要复核通过后才更新）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎉 入库功能测试完成！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 测试结果总结：
   ✅ 药材档案检查通过
   ✅ 供应商检查通过
   ✅ 入库单号生成成功
   ✅ 入库数据准备完成
   ✅ 云函数调用成功
   ✅ 数据验证通过

💡 下一步操作：
   1. 查看入库单列表
   2. 测试复核流程（通过后库存才会更新）
   3. 测试出库功能（验证单位转换）
```

---

## 🖥️ 测试3：通过界面测试入库

**目的**：测试实际用户操作流程

### 步骤1：跳转到入库页面

在控制台执行：

```javascript
wx.navigateTo({
  url: '/pages-sub/in/add'
})
```

### 步骤2：手动填写入库单

1. **供应商**：输入 "康美药业"
2. **选择药材**：点击 "📋 选择药材"
   - 如果没有药材，先运行测试2创建药材
3. **填写明细**：
   - 批号：LOT20251106001
   - 生产日期：选择30天前
   - 有效期：选择2年后
   - 数量：10
   - 单价：15.80
4. **提交**：点击底部 "💾 保存草稿" 或 "📤 提交复核"

### 步骤3：验证结果

在控制台执行：

```javascript
// 查看最新的入库单
const db = wx.cloud.database()
db.collection('in_records')
  .orderBy('createTime', 'desc')
  .limit(1)
  .get()
  .then(res => {
    console.log('最新入库单：')
    console.log(res.data[0])
  })
```

---

## 🧪 测试4：复核入库单（更新库存）

**目的**：测试复核流程和库存自动更新

```javascript
(async function testApprove() {
  console.log('━'.repeat(50))
  console.log('🧪 开始测试入库复核功能')
  console.log('━'.repeat(50))
  
  const db = wx.cloud.database()
  
  try {
    // 查找最新的草稿或待复核入库单
    const records = await db.collection('in_records')
      .where({
        status: db.command.in(['draft', 'pending'])
      })
      .orderBy('createTime', 'desc')
      .limit(1)
      .get()
    
    if (records.data.length === 0) {
      console.log('❌ 没有找到待复核的入库单')
      console.log('💡 请先运行测试2创建入库单')
      return
    }
    
    const record = records.data[0]
    console.log('✅ 找到待复核入库单:', record.recordNo)
    console.log('   - 状态:', record.status)
    console.log('   - 药材数:', record.items.length)
    console.log('   - 总金额:', record.totalAmount)
    
    // 调用云函数复核通过
    console.log('\n☁️  正在调用云函数复核...')
    
    const result = await wx.cloud.callFunction({
      name: 'inRecords',
      data: {
        action: 'approve',
        id: record._id,
        reviewer: '复核员',
        reviewerSign: 'test-sign-url'
      }
    })
    
    if (result.result.success) {
      console.log('✅ 复核成功！')
      
      // 检查库存是否更新
      console.log('\n📊 检查库存更新...')
      
      const drugId = record.items[0].drugId
      const batch = record.items[0].batch
      
      const stockCheck = await db.collection('stock')
        .where({
          drugId: drugId,
          location: 'drug_storage',
          batch: batch
        })
        .get()
      
      if (stockCheck.data.length > 0) {
        console.log('✅ 库存已更新！')
        console.log('   - 药材:', stockCheck.data[0].drugName)
        console.log('   - 批号:', stockCheck.data[0].batch)
        console.log('   - 数量:', stockCheck.data[0].quantity, stockCheck.data[0].unit)
        console.log('   - 地点: 药库（包装单位）')
      } else {
        console.log('⚠️  库存未找到，可能更新失败')
      }
      
      console.log('\n━'.repeat(50))
      console.log('🎉 入库复核测试完成！')
      console.log('━'.repeat(50))
      
      wx.showToast({
        title: '复核成功！',
        icon: 'success'
      })
      
    } else {
      console.error('❌ 复核失败:', result.result.message)
    }
    
  } catch (error) {
    console.error('❌ 测试失败:', error)
  }
})()
```

---

## 📊 测试5：查看入库统计

```javascript
// 获取入库统计数据
wx.cloud.callFunction({
  name: 'inRecords',
  data: {
    action: 'getCounts'
  }
}).then(res => {
  console.log('📊 入库统计：')
  console.log('   - 草稿:', res.result.data.draft, '条')
  console.log('   - 待复核:', res.result.data.pending, '条')
  console.log('   - 已通过:', res.result.data.approved, '条')
  console.log('   - 已驳回:', res.result.data.rejected, '条')
})
```

---

## ✅ 完整测试流程

### 推荐顺序：

```javascript
// 1️⃣ 先测试云函数
// 复制 测试1 的代码到控制台执行

// 2️⃣ 创建测试入库单
// 复制 测试2 的代码到控制台执行

// 3️⃣ 复核入库单（更新库存）
// 复制 测试4 的代码到控制台执行

// 4️⃣ 查看统计数据
// 复制 测试5 的代码到控制台执行

// 5️⃣ 通过界面测试（可选）
// 执行 测试3 的步骤
```

---

## 🔍 调试技巧

### 查看数据库内容

```javascript
// 查看所有入库单
const db = wx.cloud.database()
db.collection('in_records').get().then(res => {
  console.log('入库单总数:', res.data.length)
  console.table(res.data)
})

// 查看药库库存
db.collection('stock')
  .where({ location: 'drug_storage' })
  .get()
  .then(res => {
    console.log('药库库存:', res.data.length, '条')
    console.table(res.data)
  })

// 查看药材档案
db.collection('drugs').get().then(res => {
  console.log('药材总数:', res.data.length)
  console.table(res.data)
})
```

---

## ⚠️ 常见问题

### 问题1：云函数调用失败

**错误信息**：
```
errCode: -1, errMsg: "cloud.callFunction:fail"
```

**解决方案**：
1. 检查云函数是否已上传
2. 在云开发控制台查看云函数状态
3. 重新上传云函数

### 问题2：数据库找不到集合

**错误信息**：
```
errCode: -502003, errMsg: "database collection not exists"
```

**解决方案**：
```javascript
// 在云开发控制台手动创建以下集合：
// - drugs (药材档案)
// - suppliers (供应商)
// - in_records (入库单)
// - stock (库存)
```

### 问题3：库存没有更新

**原因**：入库单状态为 draft 或 pending，需要复核通过

**解决方案**：运行测试4复核入库单

---

## 📝 测试清单

完成以下测试后打勾：

- [ ] 测试1：云函数基本调用
- [ ] 测试2：创建入库单
- [ ] 测试3：界面操作测试
- [ ] 测试4：复核入库单
- [ ] 测试5：查看统计数据
- [ ] 验证库存已更新
- [ ] 验证数据完整性

---

**测试完成后，请继续测试出库功能以验证单位转换！** 🚀





