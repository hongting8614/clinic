# 入库页面优化补丁 - 高优先级功能

**日期：** 2026年1月2日  
**版本：** v1.0  
**适用文件：** `/pages-sub/in/add.vue`

---

## 🎯 优化内容

### 1. 添加重复检查（创建前）
### 2. 添加条形码重复检查
### 3. 优化错误提示信息
### 4. 补充默认字段值

---

## 📝 修改说明

### 修改位置：`confirmCreate()` 方法

**原代码（第 438-490 行）：**

```javascript
// 确认创建并添加 ⭐⭐⭐
async confirmCreate() {
	// 验证必填项
	if (!this.newDrug.name || !this.newDrug.spec || !this.newDrug.unit) {
		uni.showToast({
			title: '请填写完整信息',
			icon: 'none'
		})
		return
	}
	
	uni.showLoading({ title: '创建中...', mask: true })
	
	try {
		const db = wx.cloud.database()
		
		// 1. 创建药材档案
		const result = await db.collection('drugs').add({
			data: {
				name: this.newDrug.name,
				spec: this.newDrug.spec,
				specification: this.newDrug.spec,  // 兼容字段
				packUnit: this.newDrug.unit,
				unit: this.newDrug.unit,  // 兼容字段
				barcode: this.newDrug.barcode || '',
				manufacturer: this.newDrug.manufacturer || '',
				approvalNumber: this.newDrug.approvalNumber || '',
				createTime: new Date(),
				createSource: this.createFormSource  // 记录来源：api 或 manual
			}
		})
		
		// ... 后续代码
```

**新代码（替换为）：**

```javascript
// 确认创建并添加 ⭐⭐⭐
async confirmCreate() {
	// 验证必填项
	if (!this.newDrug.name || !this.newDrug.spec || !this.newDrug.unit) {
		uni.showToast({
			title: '请填写：名称、规格、单位',
			icon: 'none',
			duration: 2000
		})
		return
	}
	
	uni.showLoading({ title: '检查中...', mask: true })
	
	try {
		const db = wx.cloud.database()
		
		// ⭐ 1. 检查是否已存在相同药品（名称+规格）
		const existCheck = await db.collection('drugs')
			.where({
				name: this.newDrug.name,
				spec: this.newDrug.spec
			})
			.get()
		
		if (existCheck.data.length > 0) {
			uni.hideLoading()
			uni.showModal({
				title: '药品已存在',
				content: `系统中已存在"${this.newDrug.name}"（${this.newDrug.spec}）\n\n是否直接使用现有档案？`,
				confirmText: '使用现有',
				cancelText: '重新填写',
				success: (res) => {
					if (res.confirm) {
						// 使用现有药品
						const existingDrug = existCheck.data[0]
						this.addDrugToList(existingDrug)
						this.cancelCreate()
						this.searchKeyword = ''
						
						uni.showToast({
							title: '已使用现有档案',
							icon: 'success',
							duration: 1500
						})
					}
				}
			})
			return
		}
		
		// ⭐ 2. 检查条形码是否重复
		if (this.newDrug.barcode) {
			const barcodeCheck = await db.collection('drugs')
				.where({ barcode: this.newDrug.barcode })
				.get()
			
			if (barcodeCheck.data.length > 0) {
				uni.hideLoading()
				uni.showModal({
					title: '条形码已存在',
					content: `该条形码已被"${barcodeCheck.data[0].name}"使用\n\n请检查条形码是否正确`,
					showCancel: false,
					confirmText: '重新填写'
				})
				return
			}
		}
		
		// 3. 创建药材档案
		uni.showLoading({ title: '创建中...', mask: true })
		
		const result = await db.collection('drugs').add({
			data: {
				name: this.newDrug.name,
				spec: this.newDrug.spec,
				specification: this.newDrug.spec,  // 兼容字段
				packUnit: this.newDrug.unit,
				unit: this.newDrug.unit,  // 兼容字段
				barcode: this.newDrug.barcode || '',
				manufacturer: this.newDrug.manufacturer || '',
				approvalNumber: this.newDrug.approvalNumber || '',
				category: '',  // 分类可后续完善
				image: '',  // 图片可后续上传
				isHighValue: false,  // 默认非高值
				isEmergency: false,  // 默认非急救
				safeStock: 50,  // 默认安全库存
				minStock: 20,  // 默认最低库存
				createTime: new Date(),
				createSource: this.createFormSource  // 记录来源：api 或 manual
			}
		})
		
		// ... 后续代码保持不变
```

---

## 🔧 新增辅助方法

在 `methods` 中添加以下方法：

```javascript
// 添加药品到列表（统一方法）
addDrugToList(drug) {
	// 检查是否已添加
	const exists = this.drugList.some(item => item.drugId === drug._id)
	if (exists) {
		uni.showToast({
			title: '该药材已添加',
			icon: 'none'
		})
		return
	}
	
	// 添加到列表最前面
	this.drugList.unshift({
		drugId: drug._id,
		drugName: drug.name,
		specification: drug.spec || drug.specification,
		unit: drug.packUnit || drug.unit || '盒',
		manufacturer: drug.manufacturer || '',
		batch: '',
		productionDate: '',
		expireDate: '',
		daysToExpiry: null,
		quantity: '',
		price: '',
		amount: 0,
		hasError: false
	})
	
	// 用户反馈
	uni.showToast({
		title: '已添加到列表',
		icon: 'success',
		duration: 1500
	})
	
	// 振动反馈
	wx.vibrateShort({ type: 'light' })
}
```

---

## 📋 完整的 confirmCreate() 方法

```javascript
// 确认创建并添加 ⭐⭐⭐
async confirmCreate() {
	// 验证必填项
	if (!this.newDrug.name || !this.newDrug.spec || !this.newDrug.unit) {
		uni.showToast({
			title: '请填写：名称、规格、单位',
			icon: 'none',
			duration: 2000
		})
		return
	}
	
	uni.showLoading({ title: '检查中...', mask: true })
	
	try {
		const db = wx.cloud.database()
		
		// ⭐ 1. 检查是否已存在相同药品（名称+规格）
		const existCheck = await db.collection('drugs')
			.where({
				name: this.newDrug.name,
				spec: this.newDrug.spec
			})
			.get()
		
		if (existCheck.data.length > 0) {
			uni.hideLoading()
			uni.showModal({
				title: '药品已存在',
				content: `系统中已存在"${this.newDrug.name}"（${this.newDrug.spec}）\n\n是否直接使用现有档案？`,
				confirmText: '使用现有',
				cancelText: '重新填写',
				success: (res) => {
					if (res.confirm) {
						// 使用现有药品
						const existingDrug = existCheck.data[0]
						this.addDrugToList(existingDrug)
						this.cancelCreate()
						this.searchKeyword = ''
						
						uni.showToast({
							title: '已使用现有档案',
							icon: 'success',
							duration: 1500
						})
					}
				}
			})
			return
		}
		
		// ⭐ 2. 检查条形码是否重复
		if (this.newDrug.barcode) {
			const barcodeCheck = await db.collection('drugs')
				.where({ barcode: this.newDrug.barcode })
				.get()
			
			if (barcodeCheck.data.length > 0) {
				uni.hideLoading()
				uni.showModal({
					title: '条形码已存在',
					content: `该条形码已被"${barcodeCheck.data[0].name}"使用\n\n请检查条形码是否正确`,
					showCancel: false,
					confirmText: '重新填写'
				})
				return
			}
		}
		
		// 3. 创建药材档案
		uni.showLoading({ title: '创建中...', mask: true })
		
		const result = await db.collection('drugs').add({
			data: {
				name: this.newDrug.name,
				spec: this.newDrug.spec,
				specification: this.newDrug.spec,  // 兼容字段
				packUnit: this.newDrug.unit,
				unit: this.newDrug.unit,  // 兼容字段
				barcode: this.newDrug.barcode || '',
				manufacturer: this.newDrug.manufacturer || '',
				approvalNumber: this.newDrug.approvalNumber || '',
				category: '',  // 分类可后续完善
				image: '',  // 图片可后续上传
				isHighValue: false,  // 默认非高值
				isEmergency: false,  // 默认非急救
				safeStock: 50,  // 默认安全库存
				minStock: 20,  // 默认最低库存
				createTime: new Date(),
				createSource: this.createFormSource  // 记录来源：api 或 manual
			}
		})
		
		// 4. 如果有条形码，创建条形码映射
		if (this.newDrug.barcode) {
			try {
				await db.collection('barcode_mapping').add({
					data: {
						barcode: this.newDrug.barcode,
						drugName: this.newDrug.name,
						specification: this.newDrug.spec,
						unit: this.newDrug.unit,
						manufacturer: this.newDrug.manufacturer || '',
						approvalNumber: this.newDrug.approvalNumber || '',
						source: 'manual',
						createTime: db.serverDate()
					}
				})
				console.log('✅ 条形码映射创建成功')
			} catch (err) {
				console.error('创建条形码映射失败:', err)
				// 不影响主流程，继续执行
			}
		}
		
		uni.hideLoading()
		
		if (result._id) {
			uni.showToast({
				title: '✅ 创建成功',
				icon: 'success',
				duration: 1500
			})
			
			// 5. 自动添加到入库列表 ⭐⭐⭐
			const newDrugItem = {
				drugId: result._id,
				drugName: this.newDrug.name,
				specification: this.newDrug.spec,
				unit: this.newDrug.unit,
				manufacturer: this.newDrug.manufacturer || '',
				batch: '',
				productionDate: '',
				expireDate: '',
				daysToExpiry: null,
				quantity: '',
				price: '',
				amount: '',
				hasError: false
			}
			
			// 添加到列表最前面（新的在上）
			this.drugList.unshift(newDrugItem)
			
			// 重置表单
			this.cancelCreate()
			this.searchKeyword = ''
			
			// 如果是扫码创建的，提示下次可直接识别
			if (this.newDrug.barcode) {
				setTimeout(() => {
					uni.showToast({
						title: '下次扫码可直接识别',
						icon: 'none',
						duration: 2000
					})
				}, 1500)
			}
		}
		
	} catch (error) {
		console.error('创建失败:', error)
		uni.hideLoading()
		uni.showToast({
			title: '创建失败: ' + error.message,
			icon: 'none'
		})
	}
}
```

---

## ✅ 优化效果

### 1. 避免重复创建
- ✅ 创建前检查药品名称+规格是否已存在
- ✅ 如果存在，提示用户使用现有档案
- ✅ 避免数据库中出现重复药品

### 2. 条形码唯一性
- ✅ 创建前检查条形码是否已被使用
- ✅ 如果重复，提示用户重新填写
- ✅ 保证条形码的唯一性

### 3. 更好的用户体验
- ✅ 分步骤显示加载状态（检查中 → 创建中）
- ✅ 明确的错误提示信息
- ✅ 智能建议使用现有档案

### 4. 数据完整性
- ✅ 补充默认字段值（category, image, isHighValue等）
- ✅ 设置合理的默认库存阈值
- ✅ 记录创建来源（manual/api）

---

## 🧪 测试场景

### 场景1：创建新药品（正常流程）
1. 搜索"阿莫西林"
2. 未找到，显示创建表单
3. 填写：名称、规格、单位
4. 点击"确认创建并添加"
5. ✅ 检查通过，创建成功，自动添加到列表

### 场景2：重复创建（名称+规格相同）
1. 搜索"板蓝根颗粒"
2. 未找到，显示创建表单
3. 填写：名称="板蓝根颗粒"，规格="10g×10袋/盒"
4. 点击"确认创建并添加"
5. ⚠️ 检测到重复，提示"药品已存在"
6. 用户选择"使用现有" → 使用现有档案
7. 用户选择"重新填写" → 返回修改

### 场景3：条形码重复
1. 扫码创建药品
2. 填写信息，条形码="6901234567010"
3. 点击"确认创建并添加"
4. ⚠️ 检测到条形码重复
5. 提示"该条形码已被'板蓝根颗粒'使用"
6. 用户重新填写正确的条形码

---

## 📝 后续优化建议

### 中优先级（下周实施）
1. 添加档案完整度显示
2. 在搜索结果中显示缺失字段
3. 提供"完善档案"快捷入口

### 低优先级（下月实施）
1. 智能判断修改权限
2. 批量完善功能
3. 档案质量评分

---

**补丁版本：** v1.0  
**创建日期：** 2026年1月2日  
**测试状态：** 待测试  
**部署状态：** 待部署





