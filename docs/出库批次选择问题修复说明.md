# 出库批次选择问题修复说明

## 问题描述

用户报告在出库页面选择批次时出现以下问题：

### 1. **双重按钮问题**
- ✅ 已修复：药材卡片上有一个蓝色"选择批次"按钮
- ✅ 已修复：点击一次触发两次 showDialog 事件

### 2. **布局混乱问题**
- ❌ 待验证：批次选择器弹窗打开时，"出库数量"输入框显示在弹窗底部
- ❌ 待验证：无法在正确位置输入出库数量

---

## 根本原因

### **技术原因：**

1. **双重事件绑定**
   ```vue
   <view @tap="showDialog" @click="showDialog">
   ```
   - 在微信小程序中，同时绑定 `tap` 和 `click` 会触发两次
   - 解决：只保留 `@tap` 事件

2. **层级(z-index)冲突**
   ```scss
   // 底部操作栏
   z-index: 100
   
   // 批次选择器弹窗（原来）
   z-index: 999
   
   // 批次选择器弹窗（修复后）
   z-index: 9999
   ```

3. **u-popup 组件配置不完整**
   - 缺少 `overlay` 遮罩层配置
   - 缺少 `overlayStyle` 样式配置
   - z-index 设置过低

---

## 修复内容

### **1. 移除重复事件绑定**

**文件：** `components/batch-selector/index.vue`

```vue
<!-- 修改前 -->
<view 
  class="batch-selector-button"
  @tap="showDialog"
  @click="showDialog"  <!-- ❌ 导致双重触发 -->
>

<!-- 修改后 -->
<view 
  class="batch-selector-button"
  @tap="showDialog"  <!-- ✅ 只保留 tap -->
>
```

### **2. 增强弹窗配置**

**文件：** `components/batch-selector/index.vue`

```vue
<u-popup 
  :show="visible" 
  mode="center"
  :round="20"
  width="90%"
  height="65%"
  :closeable="true"                                           <!-- ✅ 显示关闭按钮 -->
  :overlay="true"                                             <!-- ✅ 显示遮罩层 -->
  :closeOnClickOverlay="true"                                 <!-- ✅ 点击遮罩关闭 -->
  :zIndex="9999"                                              <!-- ✅ 提高层级 -->
  :overlayStyle="{ backgroundColor: 'rgba(0, 0, 0, 0.5)' }"  <!-- ✅ 遮罩样式 -->
  @close="handleClose"
>
```

### **3. 增强弹窗容器样式**

**文件：** `components/batch-selector/index.vue`

```scss
.batch-selector-popup {
  display: flex;
  flex-direction: column;
  height: 100%;
  background-color: #FFFFFF;
  border-radius: 20rpx;
  position: relative;   // ✅ 新增
  z-index: 1000;        // ✅ 新增
  overflow: hidden;     // ✅ 新增：防止内容溢出
}
```

### **4. 修复规格字段显示**

**文件：** `components/batch-selector/index.vue`

```vue
<!-- 修改前 -->
<text class="info-value">{{ drugInfo.spec }}</text>

<!-- 修改后 -->
<text class="info-value">{{ drugInfo.specification || drugInfo.spec }}</text>
```

---

## 测试步骤

### **1. 重新编译**
```bash
点击微信开发者工具的"编译"按钮
```

### **2. 清除缓存（可选）**
```
开发工具 → 清缓存 → 全部清除
```

### **3. 测试流程**

#### **测试A：批次选择器打开正常**
1. 进入出库页面
2. 添加"棉签"药材
3. 点击"🔍 选择批次"按钮
4. **预期结果：**
   - ✅ 弹窗正常打开
   - ✅ 有半透明黑色遮罩层
   - ✅ 弹窗完全覆盖页面内容
   - ✅ 弹窗内**不应该显示**"出库数量"输入框
   - ✅ 控制台只显示一次 "showDialog 被调用"

#### **测试B：批次选择功能正常**
1. 在弹窗中点击批次项
2. **预期结果：**
   - ✅ 弹窗关闭
   - ✅ 药材卡片上显示已选批次信息
   - ✅ 显示批次的有效期、库存、单价

#### **测试C：出库数量输入正常**
1. 选择批次后，弹窗关闭
2. 在药材卡片上找到"出库数量"输入框
3. 点击输入框并输入数字
4. **预期结果：**
   - ✅ 输入框在药材卡片上（不在弹窗里）
   - ✅ 可以正常输入数字
   - ✅ 显示正确的占位符（如"最多 1 包"）

---

## 预期页面布局

### **药材卡片结构：**

```
┌─────────────────────────────────────┐
│ 棉签                          [删除] │
│ 📦 2000支/包 · 单位: 包              │
│ 🔍 drugId: 479859146922d12104...    │
│                                      │
│ [🔍 选择批次]  ← 点击打开弹窗         │
│                                      │
│ ⏰ 有效期: 2027-11-23                │
│ 📊 库存: 1 包                        │
│                                      │
│ 出库数量 * [____] 包  ← 这里输入！   │
└─────────────────────────────────────┘
```

### **批次选择器弹窗结构：**

```
┌─────────────────────────────────────┐
│ 选择批次                         ✕  │
├─────────────────────────────────────┤
│ 药材：棉签                           │
│ 规格：2000支/包                      │
├─────────────────────────────────────┤
│ 💡 已按先进先出(FIFO)排序，优先使用最早批次 │
├─────────────────────────────────────┤
│ ┌───────────────────────────────┐  │
│ │ [推荐]                         │  │
│ │ 批号：221443      库存: 1 包  │  │
│ │ 生产日期：2025-09-23           │  │
│ │ 有效期至：2027-11-23           │  │
│ └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

**注意：弹窗内**不应该有**"出库数量"输入框！**

---

## 可能的遗留问题

如果修复后问题仍然存在，可能的原因：

### **1. uView 组件版本问题**
- 检查项目中 uView 的版本
- 查阅 u-popup 组件文档
- 考虑升级或降级版本

### **2. 微信小程序基础库问题**
- 尝试切换基础库版本
- 工具栏 → 详情 → 本地设置 → 调试基础库版本

### **3. 页面滚动问题**
```vue
<!-- 如果问题仍存在，尝试在弹窗打开时禁用页面滚动 -->
<script>
methods: {
  showDialog() {
    // ...
    this.visible = true
    // 禁用页面滚动
    uni.pageScrollTo({ scrollTop: 0, duration: 0 })
  }
}
</script>
```

### **4. 替代方案：使用原生 modal**

如果 u-popup 问题无法解决，可以考虑：
- 使用微信原生的 `<modal>` 组件
- 或自己实现弹窗（view + CSS + 动画）

---

## 日志分析

### **修复前的日志（有问题）：**
```javascript
=== 批次选择器 showDialog 被调用 ===
=== 批次选择器调试 ===
=== 批次选择器 showDialog 被调用 ===  // ❌ 重复触发
=== 批次选择器调试 ===                  // ❌ 重复触发
云函数返回: {success: true, data: Array(1)}
```

### **修复后的日志（预期）：**
```javascript
=== 批次选择器 showDialog 被调用 ===    // ✅ 只触发一次
this.drugId: 479859146922d12104b49f445aa8edb2
this.drugInfo: {name: "棉签", specification: "2000支/包", unit: "包"}
✅ drugId 存在，打开批次选择器

=== 批次选择器调试 ===
药材ID (drugId): 479859146922d12104b49f445aa8edb2
药材名称: 棉签
默认园区 (location): drug_storage
启用FIFO: true
云函数返回: {success: true, data: Array(1)}
批次数量: 1
✅ 找到批次: [{…}]
```

---

## 总结

### **已修复的问题：**
- ✅ 双重事件触发（移除 @click）
- ✅ 弹窗层级过低（z-index: 9999）
- ✅ 缺少遮罩层（增加 overlay 配置）
- ✅ 规格字段显示错误（修复字段名）

### **待验证的问题：**
- ⏳ "出库数量"是否显示在正确位置
- ⏳ 输入框是否可以正常输入

### **下一步：**
1. **重新编译并测试**
2. **如果问题仍存在，提供新的截图和日志**
3. **考虑替代方案**

---

## 修改文件清单

- ✅ `components/batch-selector/index.vue` - 批次选择器组件
  - 移除重复事件绑定
  - 增强弹窗配置
  - 修复规格字段
  - 增强样式

---

**创建时间：** 2025-11-23 20:14  
**问题状态：** 部分修复，待测试验证  
**下次更新：** 根据测试结果调整
