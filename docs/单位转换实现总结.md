# 单位转换实现总结

## ✅ 已完成的核心功能

### 1. 出库单位转换 🔥

**文件：** `cloudfunctions/outRecords/index.js`

**核心逻辑：**
```javascript
// 审核通过时的单位转换流程
async function approve(data, wxContext) {
  for (const item of record.data.items) {
    // 1. 从总库扣减（整包装）
    await deductFromMainStock({
      drugId: item.drugId,
      batch: item.batch,
      quantity: item.quantity,  // 10盒
      unit: item.unit,          // 盒
      location: 'clinic_storage'
    })
    
    // 2. 单位转换
    const quantityMin = item.quantity * conversionRate  // 10 × 24 = 240粒
    const priceMin = item.price / conversionRate        // 25.50 / 24 = 1.0625元/粒
    
    // 3. 向园区增加（最小单位）
    await addToParkStock({
      drugId: item.drugId,
      location: 'land_park',  // 陆园
      quantity: quantityMin,   // 240粒
      unit: minUnit,          // 粒
      price: priceMin
    })
  }
}
```

**实现的功能：**
- ✅ 从总库扣减整包装单位（盒/瓶）
- ✅ 自动转换为最小单位（片/粒）
- ✅ 向园区库存增加最小单位
- ✅ 价格同步转换
- ✅ 批次追溯（记录来源出库单）
- ✅ 库存累加（多次出库到同一园区）

---

### 2. 门诊登记直接扣减 ✅

**文件：** `cloudfunctions/clinicRecords/index.js`

**核心逻辑：**
```javascript
async function addRecord(data, wxContext) {
  // 验证园区库存（最小单位）
  if (batch.quantity < quantityMin) {
    return {
      success: false,
      error: `库存不足，当前库存：${batch.quantity}${minUnit}`
    }
  }
  
  // 直接扣减园区库存（最小单位）
  await db.collection('stock').doc(batch._id).update({
    data: {
      quantity: _.inc(-quantityMin),  // 直接扣减6粒
      updateTime: now
    }
  })
}
```

**实现的功能：**
- ✅ 从园区库存扣减（最小单位）
- ✅ 无需转换，直接扣减
- ✅ FIFO批次选择
- ✅ 库存验证（最小单位）

---

### 3. 出库前端转换提示 ✅

**文件：** `pages-sub/out/add.vue`

**UI效果：**
```html
<!-- 单位转换提示 -->
<view v-if="item.quantity && item.conversionRate" class="convert-hint">
  <text class="hint-icon">🔄</text>
  <text class="hint-text">
    将转换为 {{ item.quantity * item.conversionRate }} {{ item.minUnit }} 存入{{ currentLocation.label }}
  </text>
</view>
```

**显示效果：**
```
出库数量: 10 盒

🔄 将转换为 240 粒 存入陆园
```

**实现的功能：**
- ✅ 实时显示转换结果
- ✅ 提示目标园区
- ✅ 视觉清晰（蓝色渐变背景）

---

## 📋 库存数据结构

### 总库房记录（clinic_storage）

```javascript
{
  _id: "stock_001",
  drugId: "drug_001",
  drugName: "阿莫西林胶囊",
  specification: "0.25g*24粒",
  batch: "BATCH20251104",
  location: "clinic_storage",  // 总库房
  quantity: 40,                // 40盒（整包装）
  unit: "盒",                  // 包装单位
  packUnit: "盒",
  minUnit: "粒",
  conversionRate: 24,
  price: 25.50,                // 元/盒
  productionDate: "2025-01-01",
  expiryDate: "2027-11-04"
}
```

### 园区库存记录（land_park/water_park）

```javascript
{
  _id: "stock_002",
  drugId: "drug_001",
  drugName: "阿莫西林胶囊",
  specification: "0.25g*24粒",
  batch: "BATCH20251104",
  location: "land_park",       // 陆园
  quantity: 240,               // 240粒（最小单位）
  unit: "粒",                  // 最小单位
  packUnit: "盒",
  minUnit: "粒",
  conversionRate: 24,
  price: 1.0625,               // 元/粒（25.50/24）
  sourceRecordId: "OUT202511040001",  // 来源出库单
  sourceBatch: "BATCH20251104",       // 来源批次
  productionDate: "2025-01-01",
  expiryDate: "2027-11-04"
}
```

---

## 🔄 完整的业务流程

### 场景1：采购入库 → 总库房

```
📦 采购 50盒阿莫西林
    ↓
✅ 入库审核通过
    ↓
📊 总库房库存
   阿莫西林：50盒
```

### 场景2：出库到陆园

```
📤 出库 10盒 → 陆园
    ↓
🔄 单位转换
   10盒 × 24 = 240粒
    ↓
✅ 审核通过
    ↓
📊 库存变化
   总库房：40盒（-10盒）
   陆园：240粒（+240粒）
```

### 场景3：门诊使用

```
💊 患者就诊（陆园）
   用药：阿莫西林 6粒
    ↓
✅ 登记成功
    ↓
📊 陆园库存
   阿莫西林：234粒（-6粒）
```

---

## 🎯 核心优势

### 1. 管理规范
- ✅ 总库按整包装管理（符合采购习惯）
- ✅ 园区按最小单位管理（符合使用习惯）
- ✅ 自动转换，无需人工计算

### 2. 数据准确
- ✅ 自动转换，避免人为错误
- ✅ 价格同步转换，成本准确
- ✅ 批次完整追溯

### 3. 操作便捷
- ✅ 出库：按盒输入，系统自动转换
- ✅ 门诊：按粒输入，直接扣减
- ✅ 实时提示转换结果

### 4. 库存精确
- ✅ 支持小数单位（0.5盒 = 12粒）
- ✅ 精确到最小单位
- ✅ 库存实时准确

---

## 📝 待完善功能

### 1. 库存查询优化

**需求：** 根据location显示对应单位

```javascript
// 总库显示整包装
location: 'clinic_storage'
→ 显示：50 盒

// 园区显示最小单位（可选显示换算）
location: 'land_park'
→ 显示：240 粒 (约 10.00 盒)
```

### 2. 日消耗统计

**需求：** 支持小数单位统计

```javascript
// 门诊消耗汇总
{
  drugName: "阿莫西林胶囊",
  totalUsedMin: 72,        // 72粒
  totalUsedPack: 3.00,     // 3盒（72/24）
  displayText: "72粒 (3盒)"
}
```

### 3. 盘点功能

**需求：** 分别盘点总库和园区

```javascript
// 总库盘点（整包装）
location: 'clinic_storage'
unit: '盒'

// 园区盘点（最小单位）
location: 'land_park'
unit: '粒'
```

---

## 🔧 关键函数说明

### `deductFromMainStock` - 总库扣减

**功能：** 从总库扣减整包装单位

**参数：**
- `drugId`: 药材ID
- `batch`: 批次号
- `quantity`: 整包装数量（盒/瓶）
- `unit`: 包装单位

**逻辑：**
1. 查找总库（location = 'clinic_storage'）
2. 验证库存充足
3. 扣减quantity
4. 记录日志

### `addToParkStock` - 园区增加

**功能：** 向园区增加最小单位库存

**参数：**
- `drugId`: 药材ID
- `batch`: 批次号
- `location`: 目标园区（land_park/water_park）
- `quantity`: 最小单位数量（粒/片）
- `unit`: 最小单位
- `price`: 最小单位价格
- `sourceRecordId`: 来源出库单ID

**逻辑：**
1. 查找园区是否已有该批次
2. 存在 → 累加quantity
3. 不存在 → 新增记录
4. 记录追溯信息

---

## 🧪 测试用例

### 用例1：基本转换

```
输入：
  出库 10盒
  conversionRate: 24
  
预期：
  总库：-10盒
  园区：+240粒
```

### 用例2：小数转换

```
输入：
  出库 0.5盒
  conversionRate: 24
  
预期：
  总库：-0.5盒
  园区：+12粒
```

### 用例3：价格转换

```
输入：
  出库 10盒
  price: 25.50元/盒
  conversionRate: 24
  
预期：
  园区price: 1.0625元/粒（25.50/24）
```

### 用例4：门诊扣减

```
前置：
  园区库存：240粒
  
输入：
  使用 6粒
  
预期：
  园区库存：234粒（-6粒）
```

### 用例5：库存不足

```
前置：
  园区库存：5粒
  
输入：
  使用 6粒
  
预期：
  提示："库存不足，当前库存：5粒，需要：6粒"
```

---

## 📊 数据一致性检查

### 检查点1：总库 + 所有园区 = 采购总量

```sql
总库库存（盒） + 陆园库存/conversionRate + 水园库存/conversionRate 
= 采购总量（盒） - 报废数量（盒）
```

### 检查点2：园区消耗统计

```sql
门诊记录SUM(quantityMin) 
= 园区初始库存 - 园区当前库存
```

### 检查点3：批次追溯

```sql
园区库存.sourceBatch = 总库库存.batch
园区库存.sourceRecordId = 出库单._id
```

---

## 🚨 注意事项

### 1. 单位配置必须完整

```javascript
// 药材档案必须配置
{
  packUnit: "盒",
  minUnit: "粒",
  conversionRate: 24
}

// 缺少任何一个都会导致转换失败
```

### 2. 价格精度

```javascript
// 使用toFixed(4)保留4位小数
priceMin = (packPrice / conversionRate).toFixed(4)

// 避免：
priceMin = packPrice / conversionRate  // 可能产生无限小数
```

### 3. 库存负数检查

```javascript
// 扣减前必须验证
if (stock.quantity < deductQuantity) {
  throw new Error('库存不足')
}
```

### 4. location字段必填

```javascript
// 所有库存记录必须指定location
{
  location: 'clinic_storage' | 'land_park' | 'water_park'
}
```

---

## 📄 相关文档

- [药材单位转换规范 v2.0](./药材单位转换规范_v2.md)
- [药材字段统一规范](./药材字段统一规范.md)
- [数据库设计文档](./数据库设计.md)

---

**最后更新：** 2025-11-04  
**版本：** v1.0  
**状态：** ✅ 核心功能已实现

