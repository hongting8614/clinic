# 药材单位转换 - 快速入门

## 🎯 核心概念（3分钟理解）

### 为什么需要单位转换？

```
采购进货：按【盒/瓶】买         ← 整包装（方便盘点）
临床使用：按【片/粒】开         ← 最小单位（精确使用）
```

**解决方案：** 两级库存管理 + 自动单位转换

---

## 📊 库存分级

```
┌─────────────────────────────────────────────┐
│                总库房（仓库）                 │
│         存储单位：整包装（盒/瓶）              │
│         用途：采购入库、盘点清算              │
│         示例：阿莫西林 50盒                   │
└───────────────┬─────────────────────────────┘
                │ 🔄 出库时自动转换
                │ 10盒 × 24粒/盒 = 240粒
                ↓
┌─────────────────────────────────────────────┐
│          园区库存（药房）                     │
│      存储单位：最小单位（片/粒/支）            │
│      用途：门诊登记、日常使用                  │
│      示例：阿莫西林 240粒                     │
└─────────────────────────────────────────────┘
```

---

## 🚀 操作流程

### 第1步：药材档案配置

**必须配置单位转换信息：**

```javascript
药材名称：阿莫西林胶囊
规格：0.25g*24粒

包装单位（packUnit）：盒        ← 总库用
最小单位（minUnit）：粒          ← 园区用
换算率（conversionRate）：24    ← 1盒=24粒
```

**配置入口：** 药材档案 → 添加/编辑药材

---

### 第2步：采购入库

**操作：** 入库管理 → 新建入库单

```
📦 采购阿莫西林 50盒
    ↓
✍️ 填写入库单（按【盒】输入）
    - 数量：50
    - 单位：盒
    ↓
✅ 审核通过
    ↓
📊 总库房库存：50盒
```

**单位：** 整包装（盒/瓶）

---

### 第3步：出库到园区 🔥

**操作：** 出库管理 → 新建出库单

```
1️⃣ 选择园区
   [🏞️ 陆园] [🌊 水园]

2️⃣ 添加药材
   阿莫西林胶囊

3️⃣ 输入数量（按【盒】输入）
   数量：10 盒
   
4️⃣ 系统显示转换提示
   🔄 将转换为 240 粒 存入陆园
   
5️⃣ 提交审核
   
6️⃣ 接收人审核通过
   ✅ 自动执行单位转换
   
7️⃣ 库存变化
   总库房：40盒（-10盒）
   陆园：240粒（+240粒）
```

**重点：**
- ✅ 输入：按【盒】（整包装）
- ✅ 转换：系统自动计算
- ✅ 存储：按【粒】（最小单位）到园区

---

### 第4步：门诊登记

**操作：** 门诊登记 → 新建登记

```
1️⃣ 选择园区
   [🏞️ 陆园]

2️⃣ 填写患者信息
   姓名：张三
   诊断：上呼吸道感染

3️⃣ 选择药材
   阿莫西林胶囊

4️⃣ 输入用药数量（按【粒】输入）
   数量：6 粒
   
5️⃣ 保存登记
   ✅ 直接从陆园扣减6粒
   
6️⃣ 库存变化
   陆园：234粒（-6粒）
```

**重点：**
- ✅ 直接输入【粒】
- ✅ 无需转换
- ✅ 精确扣减

---

## 💡 常见问题

### Q1: 为什么出库要先输入【盒】，再转换成【粒】？

**A:** 因为出库是从总库领取，总库按整包装管理（符合盘点习惯）。转换后存入园区，方便临床按【粒】使用。

---

### Q2: 门诊使用不满一盒怎么办？

**A:** 没问题！园区库存是【粒】，支持任意数量使用。

```
例如：使用6粒（0.25盒）
园区库存：240粒 → 234粒（直接-6粒）
```

---

### Q3: 库存如何查看？

**A:** 根据园区不同，显示对应单位：

```
总库房：50盒
陆园：240粒
水园：120粒
```

---

### Q4: 出库小数怎么办？

**A:** 支持小数出库！

```
出库：0.5盒
转换：0.5 × 24 = 12粒
园区：+12粒
```

---

### Q5: 如何追溯来源？

**A:** 园区库存记录了来源信息：

```
{
  batch: "BATCH20251104",
  sourceRecordId: "OUT202511040001",  // 来源出库单
  sourceBatch: "BATCH20251104"        // 来源批次
}
```

可以反查是哪张出库单转换过来的。

---

## ⚠️ 重要提醒

### 1. 药材档案必须配置

```
❌ 错误：
packUnit: 空
minUnit: 空
conversionRate: 0

✅ 正确：
packUnit: "盒"
minUnit: "粒"
conversionRate: 24
```

**不配置将无法转换！**

---

### 2. 出库单位使用整包装

```
❌ 错误：
出库 240粒（使用最小单位）

✅ 正确：
出库 10盒（使用整包装）
```

**出库必须按盒/瓶输入！**

---

### 3. 门诊单位使用最小单位

```
❌ 错误：
门诊使用 0.25盒

✅ 正确：
门诊使用 6粒
```

**门诊必须按粒/片输入！**

---

### 4. 不能跨园区使用

```
❌ 错误：
陆园出库 → 门诊选择水园

✅ 正确：
陆园出库 → 门诊选择陆园
```

**哪个园区出库，就在哪个园区使用！**

---

## 📋 操作检查清单

### 新药材入库前

- [ ] 药材档案已创建
- [ ] packUnit 已配置（盒/瓶/袋）
- [ ] minUnit 已配置（粒/片/支/ml）
- [ ] conversionRate 已配置（数字）

### 出库到园区时

- [ ] 选择了正确的园区
- [ ] 数量按【整包装】输入
- [ ] 查看转换提示是否正确
- [ ] 审核通过后检查园区库存

### 门诊登记时

- [ ] 选择了正确的园区
- [ ] 数量按【最小单位】输入
- [ ] 查看园区库存是否充足
- [ ] 登记后检查库存扣减

---

## 🎯 快速示例

### 完整流程演示

```
📦 步骤1：采购入库
   阿莫西林 50盒 → 总库房

📤 步骤2：出库到陆园
   10盒 → 自动转换 → 陆园 240粒
   
   库存状态：
   总库房：40盒
   陆园：240粒

💊 步骤3：门诊使用
   患者张三，使用 6粒
   
   库存状态：
   总库房：40盒
   陆园：234粒

💊 步骤4：再次门诊
   患者李四，使用 12粒
   
   库存状态：
   总库房：40盒
   陆园：222粒

📤 步骤5：再次出库到陆园
   5盒 → 自动转换 → 陆园 120粒
   
   最终库存：
   总库房：35盒
   陆园：342粒（222+120）
```

---

## 🔧 故障排查

### 问题1：出库后园区库存没增加

**检查：**
1. 出库单是否审核通过？
2. 药材是否配置了conversionRate？
3. 查看云函数日志是否有报错

---

### 问题2：门诊提示库存不足

**检查：**
1. 选择的园区是否正确？
2. 该园区是否有库存？
3. 库存单位是否是最小单位？

---

### 问题3：转换数量不对

**检查：**
1. conversionRate 配置是否正确？
2. 出库数量是否按整包装输入？

**示例：**
```
❌ 错误：
conversionRate: 1（应该是24）
出库10盒 → 只转换10粒

✅ 正确：
conversionRate: 24
出库10盒 → 转换240粒
```

---

## 📞 技术支持

遇到问题？查看详细文档：

- [药材单位转换规范 v2.0](./药材单位转换规范_v2.md)
- [单位转换实现总结](./单位转换实现总结.md)
- [药材字段统一规范](./药材字段统一规范.md)

---

**祝您使用愉快！** ✅🎉

