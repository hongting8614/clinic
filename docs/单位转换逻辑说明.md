# è¯æå•ä½è½¬æ¢é€»è¾‘è¯´æ˜æ–‡æ¡£

## ğŸ“‹ ä¸šåŠ¡éœ€æ±‚

### æ ¸å¿ƒéœ€æ±‚
- **å…¥åº“**ï¼šä»¥åŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ç­‰ï¼‰å…¥åº“åˆ°è¯åº“
- **å‡ºåº“**ï¼šä»¥åŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ç­‰ï¼‰ä»è¯åº“å‡ºåº“åˆ°å›­åŒº
- **å›­åŒºåº“å­˜**ï¼šè‡ªåŠ¨è½¬æ¢ä¸ºæœ€å°å•ä½ï¼ˆç‰‡ã€ç²’ç­‰ï¼‰å­˜å‚¨å’Œæ˜¾ç¤º
- **é—¨è¯Šç”¨è¯**ï¼šä½¿ç”¨æœ€å°å•ä½ï¼ˆç‰‡ã€ç²’ç­‰ï¼‰ç™»è®°å’Œæ‰£å‡

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### åŒè½¨åˆ¶å­˜å‚¨æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¯åº“ (drug_storage)                    â”‚
â”‚                     å­˜å‚¨å•ä½ï¼šåŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ï¼‰                â”‚
â”‚                     ç¤ºä¾‹ï¼š100ç›’ã€50ç“¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ å‡ºåº“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å•ä½è‡ªåŠ¨è½¬æ¢       â”‚
                    â”‚   ç›’ â†’ ç‰‡/ç²’        â”‚
                    â”‚   2ç›’ â†’ 48ç²’        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å›­åŒºåº“å­˜ (land_park/water_park)            â”‚
â”‚                     å­˜å‚¨å•ä½ï¼šæœ€å°å•ä½ï¼ˆç‰‡ã€ç²’ï¼‰                â”‚
â”‚                     ç¤ºä¾‹ï¼š2400ç‰‡ã€1200ç²’                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ é—¨è¯Šç”¨è¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é—¨è¯Šç™»è®°                               â”‚
â”‚                     ä½¿ç”¨å•ä½ï¼šæœ€å°å•ä½ï¼ˆç‰‡ã€ç²’ï¼‰                â”‚
â”‚                     ç¤ºä¾‹ï¼šæ‚£è€…æœç”¨3ç‰‡ã€2ç²’                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. è§„æ ¼è§£æå·¥å…· (`utils/unitConverter.js`)

#### æ”¯æŒçš„è§„æ ¼æ ¼å¼

| æ ¼å¼ç±»å‹ | ç¤ºä¾‹ | è§£æç»“æœ |
|---------|------|---------|
| **æ ‡å‡†æ ¼å¼** | `0.25gÃ—24ç²’/ç›’` | conversionRate: 24<br>minUnit: ç²’<br>packUnit: ç›’ |
| **ç®€åŒ–æ ¼å¼** | `24ç²’/ç›’` | conversionRate: 24<br>minUnit: ç²’<br>packUnit: ç›’ |
| **å•ä¸€åŒ…è£…** | `20g/æ”¯` | conversionRate: 1<br>minUnit: æ”¯<br>packUnit: æ”¯ |
| **çº¯æ•°é‡** | `100ç‰‡` | conversionRate: 100<br>minUnit: ç‰‡<br>packUnit: ç›’ |

#### æ ¸å¿ƒæ–¹æ³•

```javascript
// 1. è§£æè§„æ ¼
const specInfo = UnitConverter.parseSpecification('0.25gÃ—24ç²’/ç›’')
// è¿”å›ï¼š
// {
//   dosage: 0.25,
//   dosageUnit: 'g',
//   conversionRate: 24,  // è½¬æ¢ç‡
//   minUnit: 'ç²’',       // æœ€å°å•ä½
//   packUnit: 'ç›’',      // åŒ…è£…å•ä½
//   pattern: 'standard'
// }

// 2. åŒ…è£… â†’ æœ€å°å•ä½
const minQuantity = UnitConverter.packToMin(2, 24)  // 2ç›’ Ã— 24 = 48ç²’

// 3. æœ€å° â†’ åŒ…è£…å•ä½
const packQuantity = UnitConverter.minToPack(48, 24)  // 48ç²’ Ã· 24 = 2ç›’

// 4. æ ¼å¼åŒ–æ˜¾ç¤º
const display = UnitConverter.formatStockWithConversion(54, specInfo)
// è¿”å›ï¼š"54ç²’ (2ç›’é›¶6ç²’)"
```

---

### 2. å…¥åº“æµç¨‹ (`cloudfunctions/inRecords/index.js`)

#### æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯æï¼šé˜¿è«è¥¿æ—èƒ¶å›Š                    â”‚
â”‚ è§„æ ¼ï¼š0.25gÃ—24ç²’/ç›’                  â”‚
â”‚ æ‰¹å·ï¼š20250101                       â”‚
â”‚ æ•°é‡ï¼š100 ç›’  â† åŒ…è£…å•ä½              â”‚
â”‚ å•ä»·ï¼š12.5 å…ƒ/ç›’                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ å¤æ ¸é€šè¿‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¥åº“åˆ°è¯åº“ (drug_storage)            â”‚
â”‚ - æ•°é‡ï¼š100 ç›’  â† ä¿æŒåŒ…è£…å•ä½        â”‚
â”‚ - å•ä½ï¼šç›’                           â”‚
â”‚ - å•ä»·ï¼š12.5 å…ƒ/ç›’                   â”‚
â”‚ - specInfo: { conversionRate: 24 }  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®ä»£ç 

```javascript
// cloudfunctions/inRecords/index.js (ç¬¬ 240-260 è¡Œ)
async function approve(data, wxContext) {
  // ... å¤æ ¸é€šè¿‡å
  
  // å¢åŠ åº“å­˜åˆ°è¯åº“ï¼ˆä½¿ç”¨åŒ…è£…å•ä½ï¼‰â­
  for (const item of record.data.items) {
    const specInfo = UnitConverter.parseSpecification(item.specification)
    
    await updateStock({
      drugId: item.drugId,
      drugName: item.drugName,
      specification: item.specification,
      unit: item.unit,           // åŒ…è£…å•ä½ï¼ˆç›’ï¼‰â­
      quantity: item.quantity,   // åŒ…è£…æ•°é‡ï¼ˆ100ï¼‰â­
      price: item.price,         // åŒ…è£…å•ä»·ï¼ˆ12.5å…ƒ/ç›’ï¼‰
      location: 'drug_storage',  // è¯åº“
      action: 'in',
      specInfo: specInfo         // è§„æ ¼ä¿¡æ¯
    })
  }
}
```

---

### 3. å‡ºåº“æµç¨‹ (`cloudfunctions/outRecords/index.js`)

#### æµç¨‹å›¾

```
ç”¨æˆ·é€‰æ‹©è¯æ
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»è¯åº“é€‰æ‹©æ‰¹æ¬¡                        â”‚
â”‚ - è¯æï¼šé˜¿è«è¥¿æ—èƒ¶å›Š                  â”‚
â”‚ - æ‰¹å·ï¼š20250101                     â”‚
â”‚ - è¯åº“åº“å­˜ï¼š100 ç›’                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¾“å…¥å‡ºåº“æ•°é‡                      â”‚
â”‚ - æ•°é‡ï¼š2 ç›’  â† åŒ…è£…å•ä½              â”‚
â”‚ - ç›®æ ‡ï¼šé™†å›­                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½â”˜
  â†“ è‡ªåŠ¨è½¬æ¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿè®¡ç®—è½¬æ¢                          â”‚
â”‚ - åŒ…è£…æ•°é‡ï¼š2 ç›’                      â”‚
â”‚ - æœ€å°æ•°é‡ï¼š2 Ã— 24 = 48 ç²’            â”‚
â”‚ - æç¤ºï¼šå°†è½¬æ¢ä¸º 48ç²’ å­˜å…¥é™†å›­         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ æ¥æ”¶ç¡®è®¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº“å­˜å˜æ›´                              â”‚
â”‚ 1. è¯åº“æ‰£å‡ï¼š100ç›’ - 2ç›’ = 98ç›’       â”‚
â”‚ 2. é™†å›­å¢åŠ ï¼š0ç²’ + 48ç²’ = 48ç²’        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®ä»£ç 

```javascript
// cloudfunctions/outRecords/index.js (ç¬¬ 88-120 è¡Œ)
async function createRecord(data, wxContext) {
  const convertedItems = []
  
  for (const item of items) {
    // 1. è§£æè§„æ ¼
    const specInfo = UnitConverter.parseSpecification(item.specification)
    
    // 2. è½¬æ¢æ•°é‡ï¼ˆåŒ…è£…â†’æœ€å°ï¼‰â­
    const minQuantity = UnitConverter.packToMin(
      item.quantity,              // 2ç›’
      specInfo.conversionRate     // 24
    )  // = 48ç²’
    
    // 3. æ„å»ºè½¬æ¢åçš„è®°å½•
    convertedItems.push({
      // è¯åº“æ‰£å‡ï¼ˆåŒ…è£…å•ä½ï¼‰
      packQuantity: item.quantity,      // 2ç›’
      packUnit: specInfo.packUnit,      // ç›’
      
      // å›­åŒºå…¥åº“ï¼ˆæœ€å°å•ä½ï¼‰â­
      minQuantity: minQuantity,         // 48ç²’
      minUnit: specInfo.minUnit,        // ç²’
      
      // è§„æ ¼ä¿¡æ¯
      specInfo: specInfo,
      conversionRate: specInfo.conversionRate
    })
  }
  
  // ä¿å­˜å‡ºåº“å•
  await db.collection('out_records').add({
    data: {
      items: convertedItems,
      // ...
    }
  })
}

// å®Œæˆå‡ºåº“ï¼ˆæ‰§è¡Œåº“å­˜å˜æ›´ï¼‰
async function complete(data, wxContext) {
  // 1. æ‰£å‡è¯åº“åº“å­˜ï¼ˆåŒ…è£…å•ä½ï¼‰â­
  await db.collection('stock').doc(stock._id).update({
    data: {
      quantity: _.inc(-item.packQuantity),  // -2ç›’
    }
  })
  
  // 2. å¢åŠ å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰â­
  await db.collection('stock').add({
    data: {
      drugId: item.drugId,
      location: record.data.toLocation,  // é™†å›­
      unit: item.minUnit,                // ç²’
      quantity: item.minQuantity,        // 48ç²’
      specInfo: item.specInfo,
      // ...
    }
  })
}
```

---

### 4. é—¨è¯Šç™»è®°æµç¨‹ (`cloudfunctions/clinicRecords/index.js`)

#### æµç¨‹å›¾

```
åŒ»ç”Ÿå¼€å¤„æ–¹
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©è¯æ                              â”‚
â”‚ - è¯æï¼šé˜¿è«è¥¿æ—èƒ¶å›Š                  â”‚
â”‚ - å›­åŒºï¼šé™†å›­                         â”‚
â”‚ - å›­åŒºåº“å­˜ï¼š48 ç²’  â† æœ€å°å•ä½         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥ç”¨è¯æ•°é‡                          â”‚
â”‚ - æ•°é‡ï¼š3 ç²’  â† æœ€å°å•ä½              â”‚
â”‚ - æ‚£è€…ï¼šå¼ ä¸‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ ä¿å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº“å­˜æ‰£å‡                              â”‚
â”‚ - é™†å›­åº“å­˜ï¼š48ç²’ - 3ç²’ = 45ç²’         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®ä»£ç 

```javascript
// cloudfunctions/clinicRecords/index.js (ç¬¬ 150-160 è¡Œ)
async function addRecord(data, wxContext) {
  // é—¨è¯Šç”¨è¯ä½¿ç”¨æœ€å°å•ä½
  const clinicRecordData = {
    drugId: drugId,
    drugName: drugName,
    quantityMin: quantityMin,      // 3ç²’ â­
    minUnit: minUnit,              // ç²’ â­
    location: location,            // é™†å›­
    // ...
  }
  
  // ä¿å­˜è®°å½•
  await db.collection('clinic_records').add({
    data: clinicRecordData
  })
  
  // æ‰£å‡å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰â­
  await db.collection('stock').doc(batch._id).update({
    data: {
      quantity: _.inc(-quantityMin),  // -3ç²’
    }
  })
}
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### stock é›†åˆï¼ˆåº“å­˜è¡¨ï¼‰

```javascript
{
  _id: "stock_001",
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25gÃ—24ç²’/ç›’",
  batch: "20250101",
  location: "drug_storage",  // è¯åº“
  
  // åŒ…è£…å•ä½å­˜å‚¨ â­
  unit: "ç›’",
  quantity: 98,              // 98ç›’
  price: 12.5,               // 12.5å…ƒ/ç›’
  
  // è§„æ ¼ä¿¡æ¯ï¼ˆç”¨äºè½¬æ¢ï¼‰
  specInfo: {
    conversionRate: 24,
    minUnit: "ç²’",
    packUnit: "ç›’"
  },
  
  // æœ€å°å•ä½å•ä»·ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
  pricePerMin: 0.52,         // 12.5 Ã· 24 = 0.52å…ƒ/ç²’
  
  // ...
}

{
  _id: "stock_002",
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25gÃ—24ç²’/ç›’",
  batch: "20250101",
  location: "land_park",     // é™†å›­
  
  // æœ€å°å•ä½å­˜å‚¨ â­
  unit: "ç²’",
  quantity: 45,              // 45ç²’
  price: 12.5,               // åŸåŒ…è£…å•ä»·ï¼ˆç”¨äºè¿½æº¯ï¼‰
  
  // è§„æ ¼ä¿¡æ¯
  specInfo: {
    conversionRate: 24,
    minUnit: "ç²’",
    packUnit: "ç›’"
  },
  
  // æœ€å°å•ä½å•ä»·
  pricePerMin: 0.52,         // 0.52å…ƒ/ç²’
  
  // ...
}
```

---

## ğŸ¨ å‰ç«¯æ˜¾ç¤º

### åº“å­˜æ˜¾ç¤ºè§„åˆ™

```javascript
// ä½¿ç”¨ UnitConverter.formatStockDisplay()

// 1. è¯åº“æ˜¾ç¤ºï¼ˆåŒ…è£…å•ä½ï¼‰
formatStockDisplay({
  quantity: 98,
  unit: 'ç›’',
  location: 'drug_storage'
})
// è¿”å›ï¼š"98ç›’"

// 2. å›­åŒºæ˜¾ç¤ºï¼ˆæœ€å°å•ä½ + æ¢ç®—ï¼‰
formatStockDisplay({
  quantity: 45,
  unit: 'ç²’',
  location: 'land_park',
  specInfo: { conversionRate: 24, minUnit: 'ç²’', packUnit: 'ç›’' }
})
// è¿”å›ï¼š"45ç²’ (1ç›’é›¶21ç²’)"
```

### å‰ç«¯ç»„ä»¶ç¤ºä¾‹

```vue
<!-- å›­åŒºåº“å­˜æ˜¾ç¤º -->
<view class="stock-display">
  <text class="main-unit">{{ stock.quantity }}{{ stock.unit }}</text>
  <text class="sub-unit" v-if="stock.specInfo">
    ({{ formatConversion(stock) }})
  </text>
</view>

<script>
export default {
  methods: {
    formatConversion(stock) {
      const { quantity, specInfo } = stock
      const packQty = quantity / specInfo.conversionRate
      const fullPacks = Math.floor(packQty)
      const remainMin = quantity % specInfo.conversionRate
      
      if (fullPacks === 0) {
        return `${packQty.toFixed(2)}${specInfo.packUnit}`
      } else {
        return `${fullPacks}${specInfo.packUnit}é›¶${remainMin}${specInfo.minUnit}`
      }
    }
  }
}
</script>
```

---

## âœ… éªŒè¯æ¸…å•

### å…¥åº“éªŒè¯
- [ ] ç”¨æˆ·è¾“å…¥åŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ï¼‰
- [ ] è¯åº“åº“å­˜ä»¥åŒ…è£…å•ä½å­˜å‚¨
- [ ] specInfo æ­£ç¡®ä¿å­˜

### å‡ºåº“éªŒè¯
- [ ] ç”¨æˆ·è¾“å…¥åŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ï¼‰
- [ ] è¯åº“æ‰£å‡åŒ…è£…å•ä½
- [ ] å›­åŒºå¢åŠ æœ€å°å•ä½
- [ ] è½¬æ¢æç¤ºæ­£ç¡®æ˜¾ç¤º

### é—¨è¯ŠéªŒè¯
- [ ] å›­åŒºåº“å­˜æ˜¾ç¤ºæœ€å°å•ä½
- [ ] ç”¨æˆ·è¾“å…¥æœ€å°å•ä½
- [ ] åº“å­˜æ‰£å‡æœ€å°å•ä½

### åº“å­˜æŸ¥è¯¢éªŒè¯
- [ ] è¯åº“æ˜¾ç¤ºï¼š98ç›’
- [ ] å›­åŒºæ˜¾ç¤ºï¼š45ç²’ (1ç›’é›¶21ç²’)

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¯åº“ç”¨åŒ…è£…å•ä½ï¼Œå›­åŒºç”¨æœ€å°å•ä½ï¼Ÿ

**A:** 
- **è¯åº“**ï¼šé‡‡è´­ã€å…¥åº“ã€ç›˜ç‚¹éƒ½æ˜¯æŒ‰åŒ…è£…å•ä½ï¼ˆç›’ã€ç“¶ï¼‰ï¼Œä¾¿äºç®¡ç†
- **å›­åŒº**ï¼šé—¨è¯Šç”¨è¯æ˜¯æŒ‰ç‰‡ã€ç²’å‘æ”¾ï¼Œä½¿ç”¨æœ€å°å•ä½æ›´ç²¾ç¡®

### Q2: å¦‚ä½•å¤„ç†æ— æ³•è§£æçš„è§„æ ¼ï¼Ÿ

**A:** 
```javascript
const specInfo = UnitConverter.parseSpecification(spec)
if (!specInfo) {
  // é™çº§å¤„ç†ï¼šé»˜è®¤è½¬æ¢ç‡ä¸º1
  specInfo = {
    conversionRate: 1,
    minUnit: item.unit,
    packUnit: item.unit
  }
}
```

### Q3: å¦‚ä½•å¤„ç†å°æ•°æ•°é‡ï¼Ÿ

**A:** 
- **å…¥åº“**ï¼šåªå…è®¸æ•´æ•°åŒ…è£…ï¼ˆå¦‚ï¼š100ç›’ï¼‰
- **å‡ºåº“**ï¼šåªå…è®¸æ•´æ•°åŒ…è£…ï¼ˆå¦‚ï¼š2ç›’ï¼‰
- **é—¨è¯Š**ï¼šå…è®¸å°æ•°æœ€å°å•ä½ï¼ˆå¦‚ï¼š2.5ç‰‡ï¼‰

### Q4: å¦‚ä½•è¿ç§»æ—§æ•°æ®ï¼Ÿ

**A:** 
```javascript
// æ‰¹é‡æ›´æ–°åº“å­˜ï¼Œæ·»åŠ  specInfo
const stocks = await db.collection('stock').get()
for (const stock of stocks.data) {
  const specInfo = UnitConverter.parseSpecification(stock.specification)
  if (specInfo) {
    await db.collection('stock').doc(stock._id).update({
      data: {
        specInfo: specInfo,
        pricePerMin: UnitConverter.calcMinUnitPrice(stock.price, specInfo.conversionRate)
      }
    })
  }
}
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒåŸåˆ™
1. **è¯åº“**ï¼šåŒ…è£…å•ä½å­˜å‚¨ï¼ˆç›’ã€ç“¶ï¼‰
2. **å›­åŒº**ï¼šæœ€å°å•ä½å­˜å‚¨ï¼ˆç‰‡ã€ç²’ï¼‰
3. **å‡ºåº“**ï¼šè‡ªåŠ¨è½¬æ¢ï¼ˆåŒ…è£…â†’æœ€å°ï¼‰
4. **é—¨è¯Š**ï¼šæœ€å°å•ä½ä½¿ç”¨ï¼ˆç‰‡ã€ç²’ï¼‰

### ä¼˜åŠ¿
- âœ… ç¬¦åˆå®é™…ä¸šåŠ¡æµç¨‹
- âœ… æ•°æ®ç²¾ç¡®ï¼Œé¿å…è¯¯å·®
- âœ… æ˜¾ç¤ºç›´è§‚ï¼Œæ˜“äºç†è§£
- âœ… è‡ªåŠ¨è½¬æ¢ï¼Œå‡å°‘äººå·¥è®¡ç®—

### æ³¨æ„äº‹é¡¹
- âš ï¸ è§„æ ¼å¿…é¡»æ ‡å‡†åŒ–ï¼ˆå¦‚ï¼š0.25gÃ—24ç²’/ç›’ï¼‰
- âš ï¸ è½¬æ¢ç‡å¿…é¡»æ­£ç¡®
- âš ï¸ å•ä½å¿…é¡»ç»Ÿä¸€ï¼ˆç‰‡ã€ç²’ã€æ”¯ç­‰ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `utils/unitConverter.js` - å•ä½è½¬æ¢å·¥å…·ç±»
- `cloudfunctions/inRecords/index.js` - å…¥åº“äº‘å‡½æ•°
- `cloudfunctions/outRecords/index.js` - å‡ºåº“äº‘å‡½æ•°
- `cloudfunctions/clinicRecords/index.js` - é—¨è¯Šç™»è®°äº‘å‡½æ•°
- `pages-sub/in/add.vue` - å…¥åº“é¡µé¢
- `pages-sub/out/add.vue` - å‡ºåº“é¡µé¢
- `pages-sub/clinic/add.vue` - é—¨è¯Šç™»è®°é¡µé¢

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.14  
**æ›´æ–°æ—¥æœŸ**: 2025-12-23  
**ç»´æŠ¤äººå‘˜**: AI Assistant








