# 📱 双微信开发快速切换指南

## 🎯 核心问题

**问题：** 开发时需要测试管理员和项目经理两个角色，但一个微信只有一个身份，怎么办？

**答案：** 使用**微信开发者工具的"自定义编译"功能** + 两个微信账号

---

## 📋 完整流程概览

```
步骤1：准备两个微信账号
   ↓
步骤2：在小程序后台添加成员（重要！）
   ├─ 添加账号A为开发者
   └─ 添加账号B为开发者
   ↓
步骤3：获取两个账号的OpenID
   ├─ 用账号A登录开发者工具 → 获取OpenID A
   └─ 用账号B登录开发者工具 → 获取OpenID B
   ↓
步骤4：在数据库中添加用户
   ├─ 添加账号A（role: admin）
   └─ 添加账号B（role: project_manager）
   ↓
步骤5：开始测试
   ├─ 用账号A测试管理员功能
   └─ 用账号B测试项目经理功能
```

**⚠️ 重要提示：**
- ✅ 必须先在小程序后台添加成员，才能登录开发者工具
- ✅ 必须先获取OpenID，才能添加到数据库
- ✅ 必须添加到数据库，才能在小程序中登录

---

## 🚀 最佳方案：自定义编译模式（强烈推荐）

### 📋 准备工作（只需做一次）

#### 1️⃣ 准备两个微信账号

```
微信账号A（您的主账号）：管理员角色
微信账号B（备用账号）：项目经理角色
```

**获取备用账号的方法：**
- ✅ 方法1：借用家人/朋友的微信（最简单）
- ✅ 方法2：使用企业微信账号
- ✅ 方法3：注册新微信号（需要新手机号）

---

#### 2️⃣ 在小程序后台添加开发者/体验者（重要！）

**⚠️ 重要：必须先在小程序后台添加成员，才能用该账号登录开发者工具！**

**步骤：**

1. **打开微信公众平台**
   ```
   访问：https://mp.weixin.qq.com/
   用管理员账号登录
   ```

2. **进入成员管理**
   ```
   左侧菜单 → 管理 → 成员管理
   或直接访问：https://mp.weixin.qq.com/wxamp/basicprofile/index
   ```

3. **添加账号A为开发者**
   ```
   在"项目成员"区域：
   1. 点击"添加"按钮
   2. 选择添加方式：
      - 方式1：扫码添加（推荐）
        → 用账号A的微信扫码
        → 选择角色：开发者
        → 确定
      
      - 方式2：输入微信号添加
        → 输入账号A的微信号
        → 选择角色：开发者
        → 确定
   
   3. 账号A的微信会收到通知
   4. 在微信"服务通知"中确认加入
   ```

4. **添加账号B为开发者或体验者**
   ```
   重复步骤3，添加账号B：
   - 角色选择：开发者（可开发调试）
   或
   - 角色选择：体验者（只能体验版本）
   
   推荐：都设为"开发者"，方便测试
   ```

5. **确认添加成功**
   ```
   在成员管理页面查看：
   - 账号A应该显示在"项目成员"列表中
   - 账号B也应该显示在列表中
   - 角色显示为"开发者"
   ```

**💡 说明：**
- ✅ **开发者**：可以登录开发者工具，进行开发调试
- ✅ **体验者**：只能体验已发布的版本，不能开发
- ✅ **管理员**：自动拥有所有权限，无需添加

---

#### 3️⃣ 获取两个账号的 OpenID

**步骤A：获取账号A的 OpenID**

1. 打开**微信开发者工具**
2. 用**账号A**扫码登录（现在可以登录了！）
3. 点击顶部的**"编译"**按钮，运行小程序
4. 打开**"控制台"**标签（底部）
5. 在控制台输入以下代码并回车：

```javascript
// 先检查云开发是否已初始化
if (wx && wx.cloud) {
  wx.cloud.callFunction({
    name: 'login',
    success: res => {
      console.log('========================================')
      console.log('✅ 您的OpenID是：')
      console.log(res.result.openid || res.result.userInfo?.openid)
      console.log('========================================')
    },
    fail: err => {
      console.error('调用失败:', err)
    }
  })
} else {
  console.error('❌ 云开发未初始化，请等待小程序启动完成')
  console.log('提示：请先在小程序中进入"我的"页面，点击"点击登录"')
}
```

6. **复制显示的 OpenID**（例如：`oXYZ123abc...`）
7. **保存到记事本**，标记为"账号A - 管理员"

**步骤B：获取账号B的 OpenID**

1. 在微信开发者工具中，点击右上角的**头像图标**
2. 选择**"退出登录"**
3. 用**账号B**扫码登录
4. 重复上面的步骤3-7
5. **保存到记事本**，标记为"账号B - 项目经理"

---

#### 4️⃣ 在数据库中添加两个用户

1. 打开浏览器，访问 [云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择您的环境（例如：`cloud1-3gv7spppf7d2d0f4`）
3. 点击左侧菜单 **"数据库"**
4. 找到 **"users"** 集合

**添加账号A（管理员）：**

点击**"添加记录"**，切换到**"导入"**模式，粘贴：

```json
{
  "openid": "账号A的OpenID",
  "name": "管理员张三",
  "realName": "张三",
  "nickname": "张三",
  "phone": "13800138000",
  "wechatId": "wxid_a123",
  "role": "admin",
  "password": null,
  "status": "active",
  "createTime": "2025-11-09T12:00:00.000Z",
  "updateTime": "2025-11-09T12:00:00.000Z",
  "lastLogin": null
}
```

**添加账号B（项目经理）：**

再次点击**"添加记录"**，粘贴：

```json
{
  "openid": "oo0gO0SXSMjnT1vZf16A8KwUgjME",
  "name": "项目经理杨",
  "realName": "杨经理",
  "nickname": "杨经理",
  "phone": "13900139000",
  "wechatId": "wxid_b456",
  "role": "project_manager",
  "password": null,
  "status": "active",
  "createTime": "2025-11-09T12:00:00.000Z",
  "updateTime": "2025-11-09T12:00:00.000Z",
  "lastLogin": null
}
```

⚠️ **记得替换：**
- `"账号A的OpenID"` → 替换为真实的OpenID
- `"账号B的OpenID"` → 替换为真实的OpenID
- 手机号、微信号等信息根据实际情况填写

---

## 🔄 快速切换操作（日常使用）

### 方法1：使用"自定义编译"（最快）⚡

**一次性设置（只需做一次）：**

1. 在微信开发者工具中，点击顶部的**"编译"**按钮旁边的**下拉箭头**
2. 选择**"添加编译模式"**

**创建模式1 - 管理员：**
```
模式名称：管理员模式
启动页面：pages/index/index
启动参数：（留空）
```
点击**"确定"**

**创建模式2 - 项目经理：**
```
模式名称：项目经理模式
启动页面：pages/index/index
启动参数：（留空）
```
点击**"确定"**

**日常切换：**

```
测试管理员功能：
1. 点击"编译"下拉菜单
2. 选择"管理员模式"
3. 用账号A扫码（如果需要）
4. ✅ 以管理员身份登录

测试项目经理功能：
1. 点击右上角头像 → "退出登录"
2. 点击"编译"下拉菜单
3. 选择"项目经理模式"
4. 用账号B扫码
5. ✅ 以项目经理身份登录
```

---

### 方法2：直接切换微信账号

**步骤：**

1. 在微信开发者工具中，点击右上角的**头像**
2. 选择**"退出登录"**
3. 用另一个微信账号扫码登录
4. 点击**"编译"**按钮
5. ✅ 自动以新账号的身份登录

**优点：** 简单直接
**缺点：** 每次都要扫码

---

### 方法3：使用真机调试（最真实）

**步骤：**

1. 点击顶部工具栏的**"真机调试"**按钮
2. 用**账号A**扫码 → 在真机上以管理员身份测试
3. 结束后，再次点击**"真机调试"**
4. 用**账号B**扫码 → 在真机上以项目经理身份测试

**优点：** 最接近真实使用场景
**缺点：** 需要两部手机或频繁切换

---

## 📊 角色权限对照表

| 角色 | role值 | 可以做什么 |
|------|--------|-----------|
| **管理员** | `admin` | ✅ **所有功能**<br>✅ 用户管理<br>✅ 药品入库<br>✅ 入库复核<br>✅ 药品出库<br>✅ 门诊登记<br>✅ 查看报表<br>✅ 系统设置 |
| **项目经理** | `project_manager` | ✅ **用户管理**（重要）<br>✅ **入库复核**（重要）<br>✅ 药品入库<br>✅ 门诊登记<br>✅ 查看报表<br>❌ 药品出库（只能查看）<br>❌ 系统设置 |
| **医生** | `doctor` | ✅ **门诊登记**<br>❌ 其他功能（可查看记录） |
| **药房人员** | `pharmacy` | ✅ **药品管理**<br>✅ **药品入库**<br>✅ **药品出库**<br>❌ 用户管理<br>❌ 入库复核 |
| **查看者** | `viewer` | ✅ **仅查看**所有记录<br>❌ 不能进行任何操作 |

---

## 🎯 实际测试流程示例

### 测试场景1：入库和复核功能

**步骤1：以药房人员身份入库**

```
1. 用账号A登录（药房人员）
2. 进入"新建入库单"
3. 添加药品，提交入库
4. 记录入库单号：INB20251110001
```

**步骤2：切换到项目经理复核**

```
1. 点击右上角头像 → "退出登录"
2. 用账号B扫码登录（项目经理）
3. 进入"入库记录"
4. 找到刚才的入库单
5. 点击"复核"
6. ✅ 复核成功（项目经理可以复核）
```

**步骤3：测试项目经理不能出库**

```
1. 保持项目经理登录状态
2. 尝试进入"新建出库单"
3. ✅ 应该提示"权限不足"或不显示此功能
```

---

### 测试场景2：用户管理权限

**步骤1：以项目经理身份管理用户**

```
1. 用账号B登录（项目经理）
2. 进入"我的" → "用户管理"
3. 点击"添加用户"
4. ✅ 可以正常添加用户（项目经理有用户管理权限）
```

**步骤2：切换到医生**

```
1. 切换到账号C（医生）
2. 进入"我的"页面
3. ✅ 应该看不到"用户管理"入口（医生无此权限）
```

---

## ⚠️ 注意事项

### 1. 同一个人能否既入库又复核？

**可以！** 如果您有以下权限之一：
- ✅ **管理员**：可以入库、可以复核
- ✅ **项目经理**：可以入库、可以复核
- ❌ **药房人员**：可以入库、❌不能复核
- ❌ **医生**：❌不能入库、❌不能复核

**重要说明：**
- 系统会记录操作人员和复核人员
- 复核是项目经理的核心功能之一
- 管理员拥有所有权限

**业务建议：**
- 生产环境建议分开操作（药房入库，项目经理复核）
- 开发测试时管理员可以自己完成全流程

### 2. 如何快速查看当前登录角色？

在小程序中：
```
进入"我的"页面
顶部会显示：姓名 + 角色
例如："张三 | 管理员"
```

在控制台中：
```javascript
// 查看当前登录信息
const userInfo = uni.getStorageSync('userInfo')
console.log('当前角色:', userInfo.role, userInfo.roleText)
```

### 3. 如果忘记了某个账号的OpenID？

**方法A：在数据库中查看**
```
1. 打开云开发控制台
2. 数据库 → users 集合
3. 查找对应的用户记录
4. 复制 openid 字段
```

**方法B：重新获取**
```
1. 用该账号登录开发者工具
2. 在控制台运行获取OpenID的代码
3. 复制新的OpenID
```

---

## 🎉 总结

### 推荐方案：

```
✅ 日常开发：方法1（自定义编译模式）
   - 最快速
   - 一键切换

✅ 功能测试：方法2（直接切换账号）
   - 最真实
   - 完整流程

✅ 发布前测试：方法3（真机调试）
   - 最接近实际使用
   - 发现真机特有问题
```

### 快速参考：

| 需求 | 推荐方法 | 耗时 |
|------|---------|------|
| 快速切换角色 | 自定义编译 | 5秒 |
| 完整功能测试 | 切换账号 | 30秒 |
| 真机环境测试 | 真机调试 | 1分钟 |

---

## 🆘 常见问题

**Q1：无法用账号B登录开发者工具，提示"该账号无权限"？**

A：需要先在小程序后台添加成员
```
解决步骤：
1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 管理 → 成员管理
3. 在"项目成员"区域点击"添加"
4. 用账号B扫码或输入微信号
5. 选择角色：开发者
6. 账号B在微信中确认加入
7. 重新尝试登录开发者工具
```

**Q2：切换账号后还是显示之前的角色？**

A：清除缓存重新登录
```
在小程序中：
1. 进入"我的"页面
2. 点击"退出登录"
3. 重新进入小程序
```

**Q3：提示"您不在系统白名单内"？**

A：检查数据库
```
1. 确认该OpenID已添加到users集合
2. 确认status字段为"active"
3. 确认role字段不为空
```

**Q4：两个账号能用同一个手机号吗？**

A：可以，但不推荐
```
✅ 技术上可以
❌ 实际使用中可能混淆
建议：使用不同的手机号或虚拟号码
```

**Q5：在小程序后台找不到"成员管理"？**

A：检查权限和位置
```
可能原因：
1. 您不是管理员
   → 需要管理员账号登录

2. 菜单位置不同
   → 左侧菜单 → 管理 → 成员管理
   → 或直接访问：https://mp.weixin.qq.com/wxamp/basicprofile/index

3. 小程序类型限制
   → 个人小程序可能不支持成员管理
   → 需要企业/组织类型的小程序
```

---

**最后更新：** 2025年11月10日
**适用版本：** AK-PMS v1.0+

