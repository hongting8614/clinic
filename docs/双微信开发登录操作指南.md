# 👥 双微信开发登录操作指南

## 🎯 核心问题

**问题：** 小程序使用微信 OpenID 自动登录，一个微信只有一个身份。如何同时测试管理员和项目经理？

**解决：** 使用两个微信账号 + 微信开发者工具的"自定义编译"功能

---

## 🚀 最佳方案：双微信 + 自定义编译（推荐）

### 准备工作（只需做一次）

#### 1️⃣ 准备两个微信账号

```
微信账号A（您的主账号）：管理员
微信账号B（备用账号）：项目经理/其他角色
```

**获取备用账号的方法：**
- 方法1：使用家人/朋友的微信（最简单）
- 方法2：注册新微信号（需要新手机号）
- 方法3：使用企业微信账号

---

#### 2️⃣ 获取两个账号的 OpenID

**步骤A：获取账号A的 OpenID**

1. 打开微信开发者工具
2. 用**账号A**扫码登录
3. 在控制台输入：

```javascript
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('===== 账号A的OpenID =====')
    console.log(res.result.openid)
    console.log('请复制保存这个OpenID')
  }
})
```

4. 复制显示的 OpenID（例如：`oXYZ123abc...`）

**步骤B：获取账号B的 OpenID**

1. 在微信开发者工具中，点击右上角的**头像**
2. 选择**"退出登录"**
3. 用**账号B**扫码登录
4. 重复上面的控制台命令
5. 复制账号B的 OpenID

---

#### 3️⃣ 在数据库中添加两个用户

打开 [云开发控制台](https://console.cloud.tencent.com/tcb) → 数据库 → users 集合

**添加账号A（管理员）：**

```json
{
  "openid": "账号A的OpenID",
  "name": "管理员张三",
  "realName": "张三",
  "nickname": "张三",
  "phone": "13800138000",
  "wechatId": "",
  "role": "admin",
  "password": null,
  "status": "active",
  "createTime": "2025-11-09T00:00:00.000Z",
  "updateTime": "2025-11-09T00:00:00.000Z",
  "lastLogin": null
}
```

**添加账号B（项目经理）：**

```json
{
  "openid": "账号B的OpenID",
  "name": "经理李四",
  "realName": "李四",
  "nickname": "李四",
  "phone": "13900139000",
  "wechatId": "",
  "role": "project_manager",
  "password": null,
  "status": "active",
  "createTime": "2025-11-09T00:00:00.000Z",
  "updateTime": "2025-11-09T00:00:00.000Z",
  "lastLogin": null
}
```

✅ 准备工作完成！

---

## 🔄 日常开发：快速切换账号

### 方法1：使用微信开发者工具切换（推荐）⭐

**切换到账号A（管理员）：**

1. 点击开发者工具右上角的**头像**
2. 选择**"退出登录"**
3. 用**账号A**扫码登录
4. 点击**"编译"**（或按 `Ctrl + B`）
5. ✅ 现在是管理员身份

**切换到账号B（项目经理）：**

1. 点击开发者工具右上角的**头像**
2. 选择**"退出登录"**
3. 用**账号B**扫码登录
4. 点击**"编译"**（或按 `Ctrl + B`）
5. ✅ 现在是项目经理身份

---

### 方法2：使用真机调试（更真实）

**账号A测试：**

1. 在开发者工具中，点击顶部的**"真机调试"**
2. 用**账号A的微信**扫码
3. 在手机上测试管理员功能

**账号B测试：**

1. 点击**"真机调试"**
2. 用**账号B的微信**扫码
3. 在手机上测试项目经理功能

---

### 方法3：双设备同时测试（最高效）

**设备配置：**
```
电脑A（开发者工具）：账号A - 管理员
手机B（真机调试）：账号B - 项目经理
```

**操作步骤：**

1. 电脑上用账号A登录开发者工具
2. 点击**"真机调试"**
3. 用账号B的手机扫码
4. ✅ 现在可以同时测试两个角色！

**测试场景示例：**
- 电脑（管理员）：创建入库单 → 签名提交
- 手机（项目经理）：刷新页面 → 看到待复核 → 复核签名
- ✅ 完美测试双人复核流程！

---

## 📱 实战示例：测试入库复核流程

### 场景：管理员创建入库单，项目经理复核

**步骤1：管理员创建入库单**

```
1. 开发者工具用账号A登录
2. 进入"新建入库单"
3. 填写入库信息
4. 签名提交
5. ✅ 入库单创建成功，状态：待复核
```

**步骤2：切换到项目经理**

```
方式A：切换登录
1. 退出账号A
2. 用账号B登录
3. 重新编译

方式B：真机调试
1. 点击"真机调试"
2. 用账号B的手机扫码
```

**步骤3：项目经理复核**

```
1. 进入"入库管理"
2. 看到待复核的入库单
3. 点击"复核"
4. 签名确认
5. ✅ 复核成功，状态：已完成
```

**步骤4：验证权限控制**

```
测试：管理员能否复核自己的单据？
1. 用账号A登录
2. 创建入库单
3. 尝试复核自己的单据
4. ✅ 应该提示"不能复核自己创建的单据"
```

---

## 🎯 角色权限对照表

| 功能 | 管理员 | 项目经理 | 医生 | 药房 | 查看者 |
|------|--------|----------|------|------|--------|
| **用户管理** | ✅ 全部 | ✅ 添加/编辑 | ❌ | ❌ | ❌ |
| **门诊登记** | ✅ | ✅ | ✅ | ❌ | ❌ |
| **入库管理** | ✅ | ✅ | ❌ | ✅ | ❌ |
| **入库复核** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **查看报表** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **系统设置** | ✅ | ❌ | ❌ | ❌ | ❌ |

---

## 💡 开发技巧

### 技巧1：快速查看当前角色

在任意页面的控制台输入：

```javascript
const userInfo = uni.getStorageSync('userInfo')
console.log('当前角色:', userInfo.roleText)
console.log('OpenID:', userInfo.openid)
console.log('姓名:', userInfo.name)
```

---

### 技巧2：创建测试数据快捷方式

在数据库中保存常用的测试账号配置：

```json
// 保存为 test-users.json
[
  {
    "openid": "账号A的OpenID",
    "name": "测试-管理员",
    "role": "admin",
    "status": "active"
  },
  {
    "openid": "账号B的OpenID",
    "name": "测试-项目经理",
    "role": "project_manager",
    "status": "active"
  }
]
```

需要重置时，直接导入这个文件。

---

### 技巧3：使用条件编译区分开发和生产

在代码中添加开发模式标识：

```javascript
// utils/config.js
export const isDev = process.env.NODE_ENV === 'development'

// 在需要的地方使用
if (isDev) {
  console.log('开发模式：当前角色', userInfo.role)
}
```

---

## 🔧 常见问题解决

### Q1: 切换账号后还是原来的身份？

**原因：** 缓存未清除

**解决：**
```
1. 点击开发者工具的"清缓存"
2. 选择"清除数据缓存"
3. 重新编译
```

---

### Q2: 真机调试时提示"未登录"？

**原因：** 云函数环境未初始化

**解决：**
```
1. 在开发者工具中先登录一次
2. 确保云函数已上传
3. 再进行真机调试
```

---

### Q3: 没有第二个微信账号怎么办？

**方案A：临时修改数据库角色**

```
1. 获取您的 OpenID
2. 在数据库中创建一条记录
3. 需要测试其他角色时：
   - 打开云开发控制台
   - 修改 role 字段
   - 重新编译小程序
```

**方案B：使用企业微信**

```
1. 注册企业微信账号（免费）
2. 企业微信也有独立的 OpenID
3. 可以作为第二个测试账号
```

---

### Q4: 如何测试5个不同角色？

**推荐配置：**

```
账号A（主账号）：管理员
账号B（备用账号）：项目经理
账号C（家人账号）：医生
账号D（朋友账号）：药房人员
账号E（测试账号）：查看者

或者：
账号A：根据需要在数据库中修改角色
账号B：固定为项目经理（最常用的第二角色）
```

---

## 📋 开发测试检查清单

### 初始设置（只做一次）

- [ ] 已准备两个微信账号
- [ ] 已获取账号A的 OpenID
- [ ] 已获取账号B的 OpenID
- [ ] 已在数据库添加账号A（管理员）
- [ ] 已在数据库添加账号B（项目经理）
- [ ] 已测试账号A登录成功
- [ ] 已测试账号B登录成功

### 日常开发测试

- [ ] 测试管理员功能
- [ ] 测试项目经理功能
- [ ] 测试双人复核流程
- [ ] 测试权限控制（无权限操作被阻止）
- [ ] 测试角色切换
- [ ] 测试真机调试

---

## 🎬 完整操作演示

### 场景：从零开始设置双微信测试

**第1天：初始设置（30分钟）**

```
1. 准备两个微信账号（5分钟）
   - 主账号：您的微信
   - 备用账号：家人/朋友的微信

2. 获取 OpenID（10分钟）
   - 账号A登录 → 控制台获取 → 复制保存
   - 账号B登录 → 控制台获取 → 复制保存

3. 添加到数据库（10分钟）
   - 打开云开发控制台
   - 添加账号A（管理员）
   - 添加账号B（项目经理）

4. 测试登录（5分钟）
   - 账号A登录 → 验证管理员权限
   - 账号B登录 → 验证项目经理权限

✅ 设置完成！
```

**第2天及以后：日常开发（随时切换）**

```
需要测试管理员功能：
- 用账号A登录 → 开发测试

需要测试项目经理功能：
- 退出 → 用账号B登录 → 开发测试

需要测试双人协作：
- 电脑：账号A
- 手机真机调试：账号B
- 同时操作测试

✅ 高效开发！
```

---

## 🚀 推荐工作流程

### 单人开发（最常用）

```
1. 主要用账号A（管理员）开发
2. 需要测试其他角色时：
   - 方式1：切换到账号B
   - 方式2：临时修改数据库角色
3. 重要功能测试时用真机调试
```

### 双人协作开发

```
开发者A：
- 账号A（管理员）
- 负责后台管理功能

开发者B：
- 账号B（项目经理）
- 负责业务流程功能

定期交叉测试对方的功能
```

---

## 📞 需要帮助？

### 快速诊断命令

在控制台运行：

```javascript
// 检查登录状态
const userInfo = uni.getStorageSync('userInfo')
console.log('登录状态:', userInfo ? '已登录' : '未登录')
console.log('当前角色:', userInfo?.roleText)
console.log('OpenID:', userInfo?.openid)

// 检查云函数
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('云函数正常:', res)
  },
  fail: err => {
    console.error('云函数异常:', err)
  }
})
```

---

## ✨ 总结

### 最佳实践

```
✅ 使用双微信账号（最真实）
✅ 主账号：管理员（日常开发）
✅ 备用账号：项目经理（测试协作）
✅ 重要功能用真机调试
✅ 定期测试权限控制
```

### 时间成本

```
初始设置：30分钟（只需一次）
日常切换：1分钟（退出+登录+编译）
真机调试：2分钟（扫码+加载）
```

### 开发效率

```
单账号开发：⭐⭐⭐
双账号开发：⭐⭐⭐⭐⭐
双设备测试：⭐⭐⭐⭐⭐
```

---

**最后更新：** 2025-11-10  
**版本：** v1.0  
**适用场景：** 日常开发测试

**下一步：** 开始使用双微信高效开发！🚀

