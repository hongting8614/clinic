# 园区管理说明文档

## 📍 园区概述

北京欢乐谷医务室管理系统支持**陆园**和**水园**两个园区的独立管理。

### 园区代码
- **陆园**：`land_park`（默认）
- **水园**：`water_park`

---

## 🏥 园区管理规则

### 1. 库存按园区存储
- 每个药品的每个批次在不同园区分别存储
- `stock` 表通过 `location` 字段区分园区
- 同一药品、同一批号在陆园和水园可以有不同的库存数量

**示例**：
```javascript
// 陆园的阿莫西林批次
{
  drugId: "drug_001",
  batch: "20250101",
  location: "land_park",
  quantity: 500
}

// 水园的阿莫西林批次
{
  drugId: "drug_001",
  batch: "20250101",
  location: "water_park",
  quantity: 300
}
```

---

## 📋 各业务模块园区规则

### ✅ 需要选择园区的操作

| 业务模块 | 是否需要园区 | 默认值 | 说明 |
|---------|-------------|--------|------|
| 药品入库 | ❌ 不需要 | - | 入库默认进入陆园，可在代码中配置 |
| 药品出库 | ✅ 需要 | 陆园 | 从指定园区扣减库存 |
| 园区调拨 | ✅ 需要 | - | 需要选择调出园区和调入园区 |
| 药房日消耗 | ✅ 需要 | 陆园 | 从指定园区扣减库存 |
| 部门请领 | ✅ 需要 | 陆园 | 从指定园区扣减库存 |
| 库存盘点 | 🔶 建议需要 | - | 建议按园区盘点 |
| 药品报损 | 🔶 建议需要 | - | 建议区分园区 |
| 药品退货 | 🔶 建议需要 | - | 建议区分园区 |

**说明**：
- ✅ 已实现园区选择功能
- 🔶 建议添加但当前未实现
- ❌ 不需要区分园区

---

## 🔄 园区间调拨

### 调拨流程
1. 选择调出园区（陆园/水园）
2. 选择调入园区（水园/陆园）
3. 扫码或选择药品及批次
4. 填写调拨数量
5. 双人分步签名
6. 调出方库存减少，调入方库存增加

### 调拨规则
- 调出园区库存不足时无法调拨
- 如果调入园区没有该批次，自动创建新库存记录
- 如果调入园区已有该批次，累加数量

---

## 💾 数据库字段

### 需要 location 字段的表

```javascript
// out_records (出库记录)
{
  location: "land_park",
  locationName: "陆园",
  ...
}

// consume_records (消耗记录)
{
  location: "land_park",
  locationName: "陆园",
  ...
}

// requisition_records (请领记录)
{
  location: "land_park",
  locationName: "陆园",
  ...
}

// transfer_records (调拨记录)
{
  fromLocation: "land_park",
  fromLocationName: "陆园",
  toLocation: "water_park",
  toLocationName: "水园",
  ...
}
```

### 建议添加 location 字段的表

```javascript
// damage_records (报损记录) - 建议添加
{
  location: "land_park",
  locationName: "陆园",
  ...
}

// return_records (退货记录) - 建议添加
{
  location: "land_park",
  locationName: "陆园",
  ...
}

// inventory_records (盘点记录) - 建议添加
{
  location: "land_park",
  locationName: "陆园",
  ...
}
```

---

## 🎯 云函数处理逻辑

### 出库类操作（需指定园区）

```javascript
// 出库、消耗、请领
await db.collection('stock')
  .where({
    drugId: item.drugId,
    batch: item.batch,
    location: location  // ⚠️ 必须指定园区
  })
  .update({
    data: {
      quantity: _.inc(-item.quantity)
    }
  })
```

### 调拨操作（涉及两个园区）

```javascript
// 1. 调出方库存减少
await db.collection('stock')
  .where({
    drugId: item.drugId,
    batch: item.batch,
    location: fromLocation  // 调出园区
  })
  .update({
    data: { quantity: _.inc(-item.quantity) }
  })

// 2. 调入方库存增加（如果批次不存在则新建）
// ... (详见云函数代码)
```

---

## 📊 统计与报表

### 按园区统计
- 出库统计：可按园区维度统计出库量
- 消耗统计：可按园区维度统计消耗量
- 请领统计：可按园区维度统计请领量
- 库存统计：可按园区查看当前库存

### 查询示例

```javascript
// 查询陆园库存
db.collection('stock')
  .where({ location: 'land_park' })
  .get()

// 查询水园出库记录
db.collection('out_records')
  .where({ location: 'water_park' })
  .get()
```

---

## ⚠️ 注意事项

### 1. 默认园区
- 所有需要选择园区的页面，默认选中"陆园"
- 用户可手动切换为"水园"

### 2. 入库默认园区
- 当前入库默认进入陆园（代码中硬编码）
- 如需修改，可在云函数 `handleInStock` 中调整

### 3. 库存不足提醒
- 查询批次库存时，必须同时指定 `drugId + batch + location`
- 避免从错误的园区扣减库存

### 4. 数据一致性
- 所有扣减库存的操作，必须确保 location 字段正确传递
- 前端选择的园区必须保存到数据库记录中

---

## 🔮 未来扩展

### 可能的扩展需求

1. **支持更多园区**
   - 当前仅支持陆园和水园
   - 可在 `locations` 表中添加新园区

2. **跨园区库存查询**
   - 支持查看同一药品在所有园区的总库存
   - 支持汇总统计

3. **智能调拨建议**
   - 根据消耗情况，自动建议调拨数量
   - 平衡两个园区的库存

4. **园区权限管理**
   - 用户可能只能管理特定园区
   - 添加园区级别的权限控制

---

## 📝 修改记录

| 日期 | 版本 | 修改内容 | 修改人 |
|------|------|---------|--------|
| 2025-01-27 | v1.0 | 初始版本，明确园区管理规则 | - |

---

**文档版本**：v1.0  
**最后更新**：2025-01-27





























