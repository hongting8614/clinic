# å¤æ ¸é¡µé¢ç­¾ååç§»é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡**ï¼š
- âœ… æ–°å»ºå…¥åº“å•é¡µé¢çš„ç­¾ååŠŸèƒ½æ­£å¸¸
- âŒ å¤æ ¸é¡µé¢çš„ç­¾ååä¸‹ï¼Œæ‰‹æŒ‡ç‚¹å‡»ä½ç½®ä¸å®é™…ç»˜åˆ¶ä½ç½®ä¸ä¸€è‡´

**åŸå› åˆ†æ**ï¼š
å¤æ ¸é¡µé¢é€šå¸¸æœ‰è¾ƒé•¿çš„å†…å®¹éœ€è¦æ»šåŠ¨æŸ¥çœ‹ã€‚å½“ç”¨æˆ·æ»šåŠ¨é¡µé¢åï¼š
1. Canvas å…ƒç´ ç›¸å¯¹äºè§†å£ï¼ˆviewportï¼‰çš„ä½ç½®å‘ç”Ÿäº†å˜åŒ–
2. ä½†æˆ‘ä»¬åªåœ¨åˆå§‹åŒ–æ—¶è·å–äº†ä¸€æ¬¡ canvas ä½ç½®
3. å¯¼è‡´è§¦æ‘¸äº‹ä»¶çš„åæ ‡è®¡ç®—å‡ºç°åå·®

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**åœ¨æ¯æ¬¡è§¦æ‘¸å¼€å§‹æ—¶ï¼Œå®æ—¶è·å– canvas çš„æœ€æ–°ä½ç½®**ï¼Œè€Œä¸æ˜¯åªåœ¨åˆå§‹åŒ–æ—¶è·å–ä¸€æ¬¡ã€‚

### å…·ä½“å®ç°

#### 1. æ–°å¢ `updateCanvasPosition()` æ–¹æ³•

```javascript
// æ›´æ–° canvas ä½ç½®ï¼ˆç”¨äºå¤„ç†é¡µé¢æ»šåŠ¨ç­‰æƒ…å†µï¼‰
updateCanvasPosition() {
  return new Promise((resolve) => {
    try {
      const query = uni.createSelectorQuery().in(this)
      query.select('#signatureCanvas').boundingClientRect((rect) => {
        if (rect) {
          this.canvasOffsetX = rect.left
          this.canvasOffsetY = rect.top
          console.log('æ›´æ–°Canvasä½ç½®:', {
            left: rect.left,
            top: rect.top
          })
        }
        resolve()
      }).exec()
    } catch (err) {
      console.warn('æ›´æ–°Canvasä½ç½®å¤±è´¥:', err)
      resolve()
    }
  })
}
```

**å…³é”®ç‚¹**ï¼š
- è¿”å› Promiseï¼Œç¡®ä¿å¼‚æ­¥æ“ä½œå®Œæˆ
- å®æ—¶æŸ¥è¯¢ canvas çš„ `boundingClientRect`
- æ›´æ–° `canvasOffsetX` å’Œ `canvasOffsetY`

#### 2. ä¿®æ”¹ `touchStart()` æ–¹æ³•

```javascript
async touchStart(e) {
  if (!this.ctx) {
    console.error('Canvasæœªåˆå§‹åŒ–')
    return
  }
  
  // æ¯æ¬¡è§¦æ‘¸æ—¶é‡æ–°è·å– canvas ä½ç½®ï¼ˆé˜²æ­¢é¡µé¢æ»šåŠ¨å¯¼è‡´åç§»ï¼‰
  await this.updateCanvasPosition()
  
  const touch = e.touches[0]
  // è·å–è§¦æ‘¸ç‚¹åæ ‡ï¼ˆå…¼å®¹ x/y å’Œ clientX/clientYï¼‰
  const touchX = touch.clientX || touch.x || 0
  const touchY = touch.clientY || touch.y || 0
  
  // è®¡ç®—ç›¸å¯¹äº canvas çš„åæ ‡
  const x = touchX - this.canvasOffsetX
  const y = touchY - this.canvasOffsetY
  
  // ... ç»˜åˆ¶é€»è¾‘
}
```

**å…³é”®ç‚¹**ï¼š
- æ–¹æ³•æ”¹ä¸º `async`
- ä½¿ç”¨ `await this.updateCanvasPosition()` ç­‰å¾…ä½ç½®æ›´æ–°
- ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„åç§»å€¼è®¡ç®—ç›¸å¯¹åæ ‡

---

## ğŸ“Š åæ ‡è®¡ç®—åŸç†

### åæ ‡ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æµè§ˆå™¨è§†å£ (Viewport)     â”‚  â† ç”¨æˆ·çœ‹åˆ°çš„åŒºåŸŸ
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   é¡µé¢å†…å®¹ï¼ˆå¯æ»šåŠ¨ï¼‰          â”‚â”‚
â”‚  â”‚                              â”‚â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚â”‚
â”‚  â”‚   â”‚  Canvas ç­¾åæ¡†   â”‚       â”‚â”‚  â† ç»˜åˆ¶åŒºåŸŸ
â”‚  â”‚   â”‚                  â”‚       â”‚â”‚
â”‚  â”‚   â”‚   è§¦æ‘¸ç‚¹ â—       â”‚       â”‚â”‚
â”‚  â”‚   â”‚                  â”‚       â”‚â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚â”‚
â”‚  â”‚                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åæ ‡è½¬æ¢å…¬å¼

```javascript
// è§¦æ‘¸ç‚¹ç›¸å¯¹äºè§†å£çš„åæ ‡
touchX = touch.clientX  // å¦‚: 150px
touchY = touch.clientY  // å¦‚: 300px

// Canvas ç›¸å¯¹äºè§†å£çš„åæ ‡
canvasOffsetX = rect.left  // å¦‚: 20px
canvasOffsetY = rect.top   // å¦‚: 200pxï¼ˆæ»šåŠ¨åä¼šå˜åŒ–ï¼‰

// è§¦æ‘¸ç‚¹ç›¸å¯¹äº Canvas çš„åæ ‡
relativeX = touchX - canvasOffsetX  // 150 - 20 = 130px
relativeY = touchY - canvasOffsetY  // 300 - 200 = 100px
```

### æ»šåŠ¨å½±å“

**æ»šåŠ¨å‰**ï¼š
- Canvas top: 200px
- è§¦æ‘¸ç‚¹: (150, 300)
- ç›¸å¯¹åæ ‡: (130, 100) âœ…

**æ»šåŠ¨åï¼ˆå‘ä¸‹æ»šåŠ¨ 100pxï¼‰**ï¼š
- Canvas top: 100pxï¼ˆCanvas å‘ä¸Šç§»åŠ¨äº†ï¼‰
- è§¦æ‘¸ç‚¹: (150, 300)
- å¦‚æœä¸æ›´æ–°: (130, 200) âŒ åä¸‹ 100px
- æ›´æ–°åè®¡ç®—: (130, 100) âœ… æ­£ç¡®

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æµ‹è¯•æ–°å»ºé¡µé¢ï¼ˆå‚ç…§å¯¹æ¯”ï¼‰

1. è¿›å…¥æ–°å»ºå…¥åº“å•é¡µé¢
2. åœ¨ç­¾åæ¡†ä¸­ç»˜åˆ¶
3. ç¡®è®¤ç­¾åä½ç½®å‡†ç¡® âœ…

### 2. æµ‹è¯•å¤æ ¸é¡µé¢ï¼ˆé‡ç‚¹ï¼‰

1. ç™»å½•é¡¹ç›®ç»ç†è´¦å·ï¼ˆæˆ–æœ‰å¤æ ¸æƒé™çš„è´¦å·ï¼‰
2. è¿›å…¥å¾…å¤æ ¸çš„å…¥åº“å•
3. **å‘ä¸‹æ»šåŠ¨é¡µé¢**ï¼Œè®©å¤æ ¸ç­¾åæ¡†ç§»åŠ¨åˆ°å±å¹•ä¸­å¤®
4. åœ¨å¤æ ¸å‘˜ç­¾åæ¡†ä¸­ç»˜åˆ¶ç­¾å
5. è§‚å¯Ÿç­¾åæ˜¯å¦å‡†ç¡®å‡ºç°åœ¨ç‚¹å‡»/è§¦æ‘¸ä½ç½®

### 3. å¤šæ¬¡æ»šåŠ¨æµ‹è¯•

1. å‘ä¸‹æ»šåŠ¨ â†’ ç­¾å â†’ æ£€æŸ¥ä½ç½®
2. å‘ä¸Šæ»šåŠ¨ â†’ ç­¾å â†’ æ£€æŸ¥ä½ç½®
3. æ»šåŠ¨åˆ°ä¸åŒä½ç½® â†’ ç­¾å â†’ æ£€æŸ¥ä½ç½®

æ‰€æœ‰æƒ…å†µä¸‹ç­¾åéƒ½åº”è¯¥å‡†ç¡®ï¼Œæ— åç§»ï¼

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `components/signature/index.vue` - ç­¾åç»„ä»¶ï¼ˆå·²ä¿®å¤ï¼‰
- `pages-sub/in/review.vue` - å¤æ ¸é¡µé¢ï¼ˆä½¿ç”¨ç­¾åç»„ä»¶ï¼‰
- `pages-sub/in/add.vue` - æ–°å»ºé¡µé¢ï¼ˆä½¿ç”¨ç­¾åç»„ä»¶ï¼‰

---

## âœ… é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼š
- âœ… æ–°å»ºé¡µé¢ç­¾åï¼šå‡†ç¡®
- âœ… å¤æ ¸é¡µé¢ç­¾åï¼šå‡†ç¡®
- âœ… é¡µé¢æ»šåŠ¨åï¼šå‡†ç¡®
- âœ… ä»»ä½•æ»šåŠ¨ä½ç½®ï¼šå‡†ç¡®

---

## ğŸ” è°ƒè¯•æ—¥å¿—

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°çš„ä»¥ä¸‹æ—¥å¿—ï¼š

```javascript
// 1. åˆå§‹åŒ–æ—¶
console.log('Canvasä½ç½®:', { offsetX, offsetY, width, height })

// 2. æ¯æ¬¡è§¦æ‘¸æ—¶
console.log('æ›´æ–°Canvasä½ç½®:', { left, top })

// 3. å¼€å§‹ç»˜åˆ¶æ—¶
console.log('å¼€å§‹ç»˜åˆ¶:', { 
  touchX,    // è§¦æ‘¸ç‚¹åæ ‡
  touchY, 
  offsetX,   // Canvas åç§»
  offsetY, 
  relativeX, // ç›¸å¯¹åæ ‡
  relativeY 
})
```

å¯¹æ¯” `offsetY` åœ¨æ»šåŠ¨å‰åçš„å˜åŒ–ï¼Œç¡®è®¤ä½ç½®æ›´æ–°æ˜¯å¦ç”Ÿæ•ˆã€‚

---

## ğŸ“… ä¿®å¤æ—¥æœŸ

2025-11-10

---

## ğŸ¯ æ€»ç»“

é€šè¿‡åœ¨æ¯æ¬¡è§¦æ‘¸æ—¶åŠ¨æ€è·å– canvas ä½ç½®ï¼Œè§£å†³äº†é¡µé¢æ»šåŠ¨å¯¼è‡´çš„ç­¾ååç§»é—®é¢˜ã€‚è¿™ä¸ªæ–¹æ¡ˆé€‚ç”¨äºæ‰€æœ‰æœ‰æ»šåŠ¨çš„é¡µé¢åœºæ™¯ã€‚

