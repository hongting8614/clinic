# 📖 密码重置功能操作指南

## 🎯 功能概述

本系统实现了完整的密码管理功能：
- ✅ 修改密码（需要输入当前密码）
- ✅ 修改实名（2-10个中文字符）
- ✅ 密码重置（通过验证码，忘记密码时使用）

---

## 📋 第一步：上传云函数

### 需要上传的云函数清单

#### 新增云函数（5个）

1. **`changePassword`** - 修改密码
2. **`updateMyInfo`** - 更新个人信息（实名）
3. **`sendResetPasswordCode`** - 发送密码重置验证码
4. **`verifyResetPasswordCode`** - 验证密码重置验证码
5. **`resetPassword`** - 重置密码

#### 更新的云函数（4个）

1. **`addUser`** - 添加用户（已添加实名和密码支持）
2. **`updateUser`** - 更新用户（已添加实名支持）
3. **`login`** - 登录（已添加实名返回）
4. **`getUserList`** - 获取用户列表（已添加实名返回和权限更新）

---

### 上传步骤（详细）

#### 步骤1：打开微信开发者工具

1. 打开微信开发者工具
2. 打开项目：`D:\AK-PMS`
3. 确保已登录微信小程序账号

#### 步骤2：上传新增云函数

**逐个上传以下云函数：**

##### 1️⃣ `changePassword` - 修改密码

1. 在左侧文件树中找到 `cloudfunctions/changePassword` 文件夹
2. **右键点击** `changePassword` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待上传完成（约20-30秒）
5. 看到提示 "上传成功" 即可

##### 2️⃣ `updateMyInfo` - 更新个人信息

1. 找到 `cloudfunctions/updateMyInfo` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 3️⃣ `sendResetPasswordCode` - 发送验证码

1. 找到 `cloudfunctions/sendResetPasswordCode` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 4️⃣ `verifyResetPasswordCode` - 验证验证码

1. 找到 `cloudfunctions/verifyResetPasswordCode` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 5️⃣ `resetPassword` - 重置密码

1. 找到 `cloudfunctions/resetPassword` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

#### 步骤3：重新上传更新的云函数

**需要重新上传以下云函数：**

##### 1️⃣ `addUser` - 添加用户

1. 找到 `cloudfunctions/addUser` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 2️⃣ `updateUser` - 更新用户

1. 找到 `cloudfunctions/updateUser` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 3️⃣ `login` - 登录

1. 找到 `cloudfunctions/login` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

##### 4️⃣ `getUserList` - 获取用户列表

1. 找到 `cloudfunctions/getUserList` 文件夹
2. **右键点击** → **"上传并部署：云端安装依赖"**
3. 等待上传完成

---

### 验证上传成功

#### 方法1：云开发控制台

1. 打开微信开发者工具
2. 点击 **云开发** 按钮
3. 进入 **云函数** 页面
4. 检查云函数列表，确认所有云函数都已存在

#### 方法2：测试调用

1. 在小程序中测试相关功能
2. 查看控制台是否有错误
3. 检查云函数日志

---

## 🧪 第二步：测试功能

### 测试1：修改密码功能

#### 操作步骤：

1. **进入小程序**
   - 打开微信小程序
   - 确保已登录

2. **进入设置页面**
   - 点击底部导航栏的 **"设置"** 或 **"我的"**
   - 进入 **"系统设置"** 页面

3. **进入修改密码页面**
   - 在 **"安全设置"** 卡片中
   - 点击 **"修改密码"**

4. **输入密码**
   - 输入当前密码
   - 输入新密码（不少于8位，包含大小写字母和数字）
   - 确认新密码

5. **提交修改**
   - 点击 **"确认修改"** 按钮
   - 等待提示 "密码修改成功"

#### 预期结果：

- ✅ 密码修改成功
- ✅ 提示 "密码修改成功"
- ✅ 自动返回设置页面

---

### 测试2：修改实名功能

#### 操作步骤：

1. **进入设置页面**
   - 打开小程序
   - 进入 **"系统设置"** 页面

2. **进入修改实名页面**
   - 在 **"个人信息"** 卡片中
   - 找到 **"实名"** 字段
   - 点击旁边的 **"修改"** 按钮

3. **输入实名**
   - 输入真实姓名（2-10个中文字符）
   - 例如：`张三`、`李四`、`王五`

4. **提交修改**
   - 点击 **"确认修改"** 按钮
   - 等待提示 "实名修改成功"

#### 预期结果：

- ✅ 实名修改成功
   - 提示 "实名修改成功"
   - 自动返回设置页面
   - 设置页面显示新的实名

---

### 测试3：密码重置功能

#### 操作步骤：

1. **进入密码重置页面**
   - 进入 **"系统设置"** → **"修改密码"**
   - 点击右上角的 **"忘记密码？"** 链接
   - 或直接访问：`/pages-sub/setting/reset-password`

2. **输入微信号**
   - 输入注册时使用的微信号
   - 微信号格式：6-20个字符（字母、数字、下划线、减号）
   - 例如：`zhangsan123`、`user_001`

3. **发送验证码**
   - 点击 **"下一步：发送验证码"** 按钮
   - 等待验证码生成

4. **查看验证码**
   - 系统会弹出验证码提示框：
     ```
     ┌─────────────────────┐
     │  验证码已生成        │
     ├─────────────────────┤
     │ 您的验证码是：123456 │
     │                     │
     │ 请妥善保管，5分钟内有效│
     ├─────────────────────┤
     │      [我知道了]      │
     └─────────────────────┘
     ```
   - 复制验证码（6位数字）

5. **输入验证码**
   - 在验证码输入框中粘贴或输入验证码
   - 点击 **"验证验证码"** 按钮

6. **输入新密码**
   - 验证通过后，进入密码输入页面
   - 输入新密码（不少于8位，包含大小写字母和数字）
   - 确认新密码

7. **完成重置**
   - 点击 **"确认重置密码"** 按钮
   - 等待提示 "密码重置成功"
   - 自动跳转到登录页面

#### 预期结果：

- ✅ 验证码生成成功
- ✅ 验证码显示在弹窗中
- ✅ 验证码验证成功
- ✅ 密码重置成功
- ✅ 自动跳转到登录页面

---

## 📝 第三步：使用说明

### 功能1：修改密码

**适用场景：**
- 用户已登录
- 知道当前密码
- 想要修改密码

**操作步骤：**
1. 进入 **设置** → **修改密码**
2. 输入当前密码
3. 输入新密码（不少于8位，包含大小写字母和数字）
4. 确认新密码
5. 点击 **确认修改**

**密码要求：**
- ✅ 不少于8位
- ✅ 包含至少一个大写字母（A-Z）
- ✅ 包含至少一个小写字母（a-z）
- ✅ 包含至少一个数字（0-9）

**示例密码：**
- ✅ `Password123`
- ✅ `MyPass2024`
- ✅ `Test1234`
- ❌ `password`（缺少大写字母和数字）
- ❌ `PASSWORD123`（缺少小写字母）
- ❌ `Pass123`（少于8位）

---

### 功能2：修改实名

**适用场景：**
- 用户已登录
- 想要修改或设置实名
- 实名用于系统实名认证

**操作步骤：**
1. 进入 **设置** → 点击实名旁边的 **修改** 按钮
2. 输入真实姓名（2-10个中文字符）
3. 点击 **确认修改**

**实名要求：**
- ✅ 2-10个中文字符
- ✅ 只能包含中文
- ❌ 不能包含英文、数字、特殊字符

**示例实名：**
- ✅ `张三`
- ✅ `李四`
- ✅ `王五`
- ✅ `欧阳修`
- ❌ `张三123`（包含数字）
- ❌ `Zhang San`（包含英文）
- ❌ `张`（少于2个字符）

---

### 功能3：密码重置

**适用场景：**
- 用户忘记密码
- 无法登录系统
- 需要通过验证码重置密码

**操作步骤：**
1. 进入 **设置** → **修改密码** → 点击 **忘记密码？**
2. 输入微信号
3. 点击 **发送验证码**
4. 查看验证码（弹窗显示）
5. 输入验证码
6. 输入新密码
7. 确认新密码
8. 点击 **确认重置密码**

**验证码说明：**
- ✅ 6位数字
- ✅ 5分钟内有效
- ✅ 使用后立即失效
- ✅ 每个微信号每分钟最多发送1次

**微信号要求：**
- ✅ 6-20个字符
- ✅ 只能包含字母、数字、下划线、减号
- ❌ 不能包含中文、特殊字符

**示例微信号：**
- ✅ `zhangsan123`
- ✅ `user_001`
- ✅ `test-user`
- ❌ `张三123`（包含中文）
- ❌ `user@123`（包含特殊字符）

---

## ⚠️ 常见问题

### 问题1：云函数上传失败

**错误信息：**
```
上传失败：依赖安装失败
```

**解决方法：**
1. 检查网络连接
2. 检查 `package.json` 文件是否存在
3. 尝试使用 **"上传并部署：全部文件"** 选项
4. 检查云开发环境是否正常

---

### 问题2：验证码不显示

**错误信息：**
```
验证码已生成，但弹窗不显示
```

**解决方法：**
1. 检查云函数是否上传成功
2. 检查云函数日志，查看是否有错误
3. 检查前端代码是否正确
4. 尝试重新发送验证码

---

### 问题3：验证码验证失败

**错误信息：**
```
验证码错误或已过期
```

**解决方法：**
1. 检查验证码是否在5分钟内
2. 检查验证码是否已使用
3. 检查验证码输入是否正确
4. 重新发送验证码

---

### 问题4：密码格式不正确

**错误信息：**
```
密码格式不正确
```

**解决方法：**
1. 检查密码长度是否不少于8位
2. 检查是否包含大写字母
3. 检查是否包含小写字母
4. 检查是否包含数字
5. 参考密码要求重新输入

---

### 问题5：未找到用户

**错误信息：**
```
未找到该微信号对应的用户
```

**解决方法：**
1. 检查微信号输入是否正确
2. 检查用户表中是否有 `wechatId` 字段
3. 检查用户是否已设置微信号
4. 联系管理员添加微信号

---

## 📊 功能检查清单

### 云函数上传
- [ ] `changePassword` 已上传
- [ ] `updateMyInfo` 已上传
- [ ] `sendResetPasswordCode` 已上传
- [ ] `verifyResetPasswordCode` 已上传
- [ ] `resetPassword` 已上传
- [ ] `addUser` 已重新上传
- [ ] `updateUser` 已重新上传
- [ ] `login` 已重新上传
- [ ] `getUserList` 已重新上传

### 功能测试
- [ ] 修改密码功能正常
- [ ] 修改实名功能正常
- [ ] 密码重置功能正常
- [ ] 验证码显示正常
- [ ] 验证码验证正常
- [ ] 密码格式验证正常

---

## 🎯 快速开始

### 5分钟快速测试

1. **上传云函数**（3分钟）
   - 上传 `sendResetPasswordCode`
   - 上传 `verifyResetPasswordCode`
   - 上传 `resetPassword`

2. **测试功能**（2分钟）
   - 进入密码重置页面
   - 输入微信号
   - 发送验证码
   - 查看验证码
   - 输入验证码
   - 重置密码

---

## 📞 技术支持

如果遇到问题，请检查：
1. 云函数是否上传成功
2. 云函数日志是否有错误
3. 前端控制台是否有错误
4. 数据库字段是否正确

---

**最后更新：** 2025-11-09  
**版本：** v1.0

