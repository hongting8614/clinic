# 🔍 库存架构分析 - "有库存显示无库存"问题

## 📊 问题描述

根据两张截图：

### **图1：选择药材页面**
```
✅ 显示药材列表：
- 布洛芬缓释胶囊（0.3g×20粒/盒）
- 棉签（2000支/包）
- 碘伏（100ml/瓶）
- 阿莫西林胶囊（0.25g×24粒/盒）

说明：这些药材有库存
```

### **图2：批次选择器**
```
❌ 布洛芬缓释胶囊
   → 显示："该药材暂无库存"

✅ 棉签
   → 有批次可选
```

**矛盾：**
- 选择药材页面显示"布洛芬缓释胶囊"有库存
- 但批次选择器显示该药材无库存

---

## 🏗️ 系统架构

### **数据库表结构：**

#### **1. drugs（药材档案表）**
```javascript
{
  _id: "drug_001",
  name: "布洛芬缓释胶囊",
  specification: "0.3g×20粒/盒",
  unit: "盒",
  manufacturer: "华北制药",
  // ... 其他字段
}
```

#### **2. stock（库存表）**
```javascript
{
  _id: "stock_001",
  drugId: "drug_001",           // 药材ID
  drugName: "布洛芬缓释胶囊",
  batch: "20241101",            // 批次号
  quantity: 50,                 // 库存数量 ⭐
  location: "land_park",        // 存放园区
  expireDate: "2026-11-01",     // 有效期
  createTime: Date,
  // ... 其他字段
}
```

**关键字段：**
- `drugId`: 关联到 drugs 表的 _id
- `quantity`: 当前批次的库存数量
- **一个药材可以有多个批次（多条 stock 记录）**

---

## 🔄 两个查询流程

### **流程1：选择药材页面（select-drug.vue）**

#### **查询逻辑：**
```javascript
// 步骤1：查询所有有库存的记录
const stockResult = await db.collection('stock')
  .where({
    quantity: db.command.gt(0)  // quantity > 0
  })
  .get()

// 步骤2：提取药材ID列表（去重）
const drugIds = [...new Set(stockResult.data.map(item => item.drugId))]

// 步骤3：只显示这些药材
this.drugList = allDrugs.filter(drug => 
  drugIds.includes(drug._id)
)
```

#### **查询结果示例：**
```javascript
stockResult.data = [
  { _id: "s1", drugId: "drug_001", batch: "A", quantity: 50 },
  { _id: "s2", drugId: "drug_002", batch: "B", quantity: 100 },
  { _id: "s3", drugId: "drug_003", batch: "C", quantity: 30 },
  { _id: "s4", drugId: "drug_004", batch: "D", quantity: 80 }
]

drugIds = ["drug_001", "drug_002", "drug_003", "drug_004"]

显示药材：
✅ 布洛芬缓释胶囊 (drugId: drug_001)
✅ 棉签 (drugId: drug_002)
✅ 碘伏 (drugId: drug_003)
✅ 阿莫西林胶囊 (drugId: drug_004)
```

---

### **流程2：批次选择器（batch-selector）**

#### **查询逻辑：**
```javascript
// 在 stockManage 云函数中
async function getBatchesByDrugId(data) {
  const { drugId, location, enableFIFO = true } = data
  
  let where = {
    drugId: drugId,              // ⭐ 精确匹配药材ID
    quantity: _.gt(0)            // quantity > 0
  }
  
  // 可选：按园区过滤
  if (location) {
    where.location = location
  }
  
  const result = await db.collection('stock')
    .where(where)
    .orderBy('expireDate', 'asc')  // FIFO排序
    .get()
  
  return {
    success: true,
    data: result.data
  }
}
```

#### **查询结果示例：**

**正常情况（棉签）：**
```javascript
drugId: "drug_002"
查询条件：drugId = "drug_002" AND quantity > 0

结果：
[
  { batch: "20241101", quantity: 50, expireDate: "2026-11-01" },
  { batch: "20241015", quantity: 30, expireDate: "2026-10-15" }
]

显示：✅ 有2个批次可选
```

**异常情况（布洛芬）：**
```javascript
drugId: "drug_001"
查询条件：drugId = "drug_001" AND quantity > 0

结果：[]  // 空数组

显示：❌ 该药材暂无库存
```

---

## 🐛 问题根源分析

### **为什么会出现不一致？**

#### **原因1：drugId 不匹配** ⭐⭐⭐

```
选择药材页面查询到的 drugId：
  "布洛芬缓释胶囊_temp_12345"  (临时ID)

批次选择器查询的 drugId：
  "drug_001"  (真实ID)

不匹配 → 查询不到
```

**验证方法：**
```javascript
// 在 select-drug.vue 中打印
console.log('选中的药材:', drug)
console.log('药材ID:', drug._id)

// 在 batch-selector 中打印
console.log('查询批次的 drugId:', this.drugId)
```

---

#### **原因2：数据同步问题**

```
时间线：
T1: 查询药材列表 → stock 表有库存 quantity = 50
T2: 其他用户出库 → quantity 减少到 0
T3: 点击选择批次 → 查询到 quantity = 0

导致：选择时有库存，点击时无库存
```

---

#### **原因3：园区筛选问题**

```
选择药材页面：
查询条件：quantity > 0  (不限园区)
结果：陆园有库存 50，水园无库存

批次选择器：
查询条件：drugId = xxx AND quantity > 0 AND location = "water_park"
结果：水园无库存 → 显示暂无库存
```

---

#### **原因4：stock 表数据不完整**

```javascript
// 可能的情况
stock 表中：
{
  _id: "s1",
  drugId: "drug_001",
  drugName: "布洛芬缓释胶囊",
  batch: "",              // ❌ 批次为空
  quantity: 50,
  // ...
}

查询时：
- 流程1：只查 quantity > 0 → 找到了
- 流程2：查 drugId AND quantity > 0 → 找到了，但batch为空
  → 显示"暂无库存"（因为没有有效批次）
```

---

## 🔍 调试步骤

### **步骤1：打印查询条件**

#### **在 select-drug.vue 中：**
```javascript
async loadDrugList() {
  // ...
  const stockResult = await db.collection('stock')
    .where({ quantity: db.command.gt(0) })
    .get()
  
  console.log('=== 选择药材页面 ===')
  console.log('库存记录数:', stockResult.data.length)
  console.log('库存记录:', stockResult.data)
  
  const drugIds = [...new Set(stockResult.data.map(item => item.drugId))]
  console.log('药材ID列表:', drugIds)
  
  // 找到"布洛芬缓释胶囊"的记录
  const target = stockResult.data.find(s => s.drugName.includes('布洛芬'))
  console.log('布洛芬库存记录:', target)
  console.log('布洛芬 drugId:', target?.drugId)
}
```

#### **在 batch-selector 组件中：**
```javascript
async loadBatches() {
  console.log('=== 批次选择器 ===')
  console.log('查询的 drugId:', this.drugId)
  console.log('查询的 location:', this.defaultLocation)
  
  const result = await wx.cloud.callFunction({
    name: 'stockManage',
    data: {
      action: 'getBatchList',
      data: {
        drugId: this.drugId,
        location: this.defaultLocation,
        enableFIFO: this.enableFIFO
      }
    }
  })
  
  console.log('查询结果:', result.result)
  console.log('批次数量:', result.result.data?.length || 0)
}
```

---

### **步骤2：对比 drugId**

```javascript
// 预期结果：
选择药材页面：drugId = "drug_001"
批次选择器：drugId = "drug_001"
✅ 匹配

// 问题情况：
选择药材页面：drugId = "布洛芬_temp_12345"
批次选择器：drugId = "drug_001"
❌ 不匹配！
```

---

### **步骤3：直接查询数据库**

```javascript
// 在云开发控制台执行
db.collection('stock')
  .where({
    drugName: db.RegExp({
      regexp: '布洛芬',
      options: 'i'
    })
  })
  .get()
  .then(res => {
    console.log('布洛芬的所有库存记录:', res.data)
  })
```

---

## 🔧 解决方案

### **方案1：统一 drugId 来源** ⭐⭐⭐

#### **问题：**
选择药材页面的 drug._id 可能是临时ID，不是真实的药材档案ID

#### **修复：**
```javascript
// 在 select-drug.vue 中
onConfirm() {
  if (this.selectedDrugs.length === 0) {
    uni.showToast({ title: '请选择药材', icon: 'none' })
    return
  }
  
  // ⭐ 确保传递正确的 drugId
  const drugsWithCorrectId = this.selectedDrugs.map(drug => ({
    ...drug,
    drugId: drug._id,  // 确保 drugId 字段正确
    _originalId: drug._id  // 保留原始ID
  }))
  
  console.log('传递的药材数据:', drugsWithCorrectId)
  uni.setStorageSync('selectedDrugsForOut', drugsWithCorrectId)
  uni.navigateBack()
}
```

---

### **方案2：增强批次选择器调试**

```javascript
// 在 batch-selector 组件中
async loadBatches() {
  this.loading = true
  
  console.log('🔍 批次选择器调试信息:')
  console.log('  - drugId:', this.drugId)
  console.log('  - drugName:', this.drugName)
  console.log('  - location:', this.defaultLocation)
  
  try {
    const result = await wx.cloud.callFunction({
      name: 'stockManage',
      data: {
        action: 'getBatchList',
        data: {
          drugId: this.drugId,
          location: this.defaultLocation,
          enableFIFO: this.enableFIFO
        }
      }
    })
    
    console.log('  - 查询结果:', result.result)
    console.log('  - 批次数量:', result.result.data?.length || 0)
    
    if (result.result.success) {
      this.batchList = result.result.data
      
      if (this.batchList.length === 0) {
        console.warn('⚠️ 该药材暂无库存，但选择页面显示有库存')
        console.warn('  - 可能原因：drugId 不匹配或库存已被消耗')
      }
    }
  } catch (err) {
    console.error('❌ 加载批次失败:', err)
  } finally {
    this.loading = false
  }
}
```

---

### **方案3：添加数据验证**

```javascript
// 在 stockManage 云函数中
async function getBatchesByDrugId(data) {
  const { drugId, location, enableFIFO = true } = data
  
  console.log('📊 getBatchesByDrugId 调试:')
  console.log('  - drugId:', drugId)
  console.log('  - location:', location)
  
  if (!drugId) {
    return { success: false, message: '药材ID不能为空' }
  }
  
  let where = {
    drugId: drugId,
    quantity: _.gt(0)
  }
  
  if (location) {
    where.location = location
  }
  
  console.log('  - 查询条件:', where)
  
  const result = await db.collection('stock').where(where).get()
  
  console.log('  - 查询结果数量:', result.data.length)
  console.log('  - 查询结果:', result.data)
  
  // 如果没有找到，尝试不限园区查询
  if (result.data.length === 0 && location) {
    console.log('  - 尝试不限园区查询...')
    const allLocationResult = await db.collection('stock')
      .where({
        drugId: drugId,
        quantity: _.gt(0)
      })
      .get()
    
    console.log('  - 不限园区结果:', allLocationResult.data.length)
    
    if (allLocationResult.data.length > 0) {
      return {
        success: false,
        message: `该药材在其他园区有库存，当前园区（${location}）无库存`
      }
    }
  }
  
  // ... 后续代码
}
```

---

## ✅ 验证方法

### **1. 添加完整日志**
```javascript
// 在出库页面选择药材后
console.log('=== 选中药材信息 ===')
this.selectedDrugs.forEach(drug => {
  console.log(`药材: ${drug.name}`)
  console.log(`  - _id: ${drug._id}`)
  console.log(`  - drugId: ${drug.drugId || '无'}`)
  console.log(`  - specification: ${drug.specification}`)
})
```

### **2. 数据库直接验证**
```sql
-- 查询布洛芬的所有库存
SELECT * FROM stock 
WHERE drugName LIKE '%布洛芬%'

-- 查询特定 drugId 的库存
SELECT * FROM stock 
WHERE drugId = 'drug_001' AND quantity > 0
```

---

## 📝 最可能的问题

根据截图分析，**最可能的原因**是：

### **drugId 不匹配**

```
选择药材页面：
  - 从 drugs 表查询药材
  - 从 stock 表查询有库存的 drugId
  - 关联两者，显示有库存的药材

批次选择器：
  - 接收传入的 drugId
  - 在 stock 表中查询该 drugId 的批次

问题：
  传入的 drugId 与 stock 表中的 drugId 不一致
```

**验证：**
```javascript
// 在选择药材后打印
console.log('选中的药材:', drug)
console.log('药材_id:', drug._id)
console.log('药材drugId:', drug.drugId)

// 在批次选择器打印
console.log('查询批次的drugId:', this.drugId)

// 如果不一致，说明找到问题了！
```

---

## 🎯 建议

1. **立即添加调试日志** - 找出 drugId 不匹配的原因
2. **统一数据结构** - 确保 drug._id 始终是正确的药材档案ID
3. **添加错误提示** - 告诉用户具体是哪个园区无库存
4. **数据验证** - 在云函数中验证 drugId 的有效性

---

**这是一个典型的数据关联不一致问题！** 🔍
