# 🔄 开发测试多角色登录指南

## 🎯 问题说明

小程序使用**微信 OpenID 自动登录**，一个微信账号只有一个 OpenID。如果需要测试不同角色（管理员、项目经理等），需要特殊处理。

---

## 💡 解决方案（3种方法）

### 方法1：使用两个微信账号（推荐）⭐

**适用场景：** 最真实的测试环境

#### 操作步骤：

**1. 准备两个微信账号**
- 微信账号A：作为管理员
- 微信账号B：作为项目经理
- 可以用家人或朋友的微信账号协助测试

**2. 分别获取 OpenID**

**账号A（管理员）：**
```javascript
// 在微信开发者工具中，使用账号A登录
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('账号A的OpenID:', res.result.openid)
    // 复制这个OpenID
  }
})
```

**账号B（项目经理）：**
```javascript
// 切换到账号B，重新运行
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('账号B的OpenID:', res.result.openid)
    // 复制这个OpenID
  }
})
```

**3. 在数据库中添加两个用户**

在云开发控制台 → 数据库 → users 集合：

**管理员账号：**
```json
{
  "openid": "账号A的OpenID",
  "name": "管理员张三",
  "realName": "张三",
  "phone": "13800138000",
  "role": "admin",
  "status": "active",
  "password": null
}
```

**项目经理账号：**
```json
{
  "openid": "账号B的OpenID",
  "name": "经理李四",
  "realName": "李四",
  "phone": "13900139000",
  "role": "project_manager",
  "status": "active",
  "password": null
}
```

**4. 测试切换**
- 使用账号A登录 → 看到管理员权限
- 使用账号B登录 → 看到项目经理权限

---

### 方法2：临时修改角色（快速测试）⚡

**适用场景：** 单人开发，快速切换角色测试

#### 操作步骤：

**1. 获取您的 OpenID**
```javascript
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('我的OpenID:', res.result.openid)
  }
})
```

**2. 在数据库中创建您的用户记录**
```json
{
  "openid": "您的OpenID",
  "name": "开发者",
  "realName": "开发者",
  "phone": "13800138000",
  "role": "admin",  // 初始角色：管理员
  "status": "active"
}
```

**3. 需要测试项目经理时**

打开云开发控制台 → 数据库 → users 集合 → 找到您的记录：

**修改 role 字段：**
```json
"role": "project_manager"  // 改为项目经理
```

**4. 重新登录小程序**
- 在开发者工具中：点击"编译"或按 `Ctrl + B`
- 系统会重新登录，此时您就是项目经理角色了

**5. 切换回管理员**
- 再次修改数据库中的 `role` 为 `"admin"`
- 重新编译小程序

---

### 方法3：多账号数据库配置（专业方式）👨‍💻

**适用场景：** 需要频繁测试多个角色

#### 操作步骤：

**1. 在数据库中创建多个测试账号**

```json
[
  {
    "openid": "您的真实OpenID",
    "name": "开发者-管理员",
    "role": "admin",
    "status": "active"
  },
  {
    "openid": "test-openid-pm",
    "name": "测试-项目经理",
    "role": "project_manager",
    "status": "active"
  },
  {
    "openid": "test-openid-doctor",
    "name": "测试-医生",
    "role": "doctor",
    "status": "active"
  }
]
```

**2. 在开发环境中添加角色切换功能**

创建一个调试页面 `pages/test/role-switcher.vue`：

```vue
<template>
  <view class="role-switcher">
    <text class="title">开发模式 - 角色切换</text>
    
    <button @click="switchRole('admin')">
      切换为 管理员
    </button>
    
    <button @click="switchRole('project_manager')">
      切换为 项目经理
    </button>
    
    <button @click="switchRole('doctor')">
      切换为 医生
    </button>
  </view>
</template>

<script>
export default {
  methods: {
    async switchRole(role) {
      // 临时修改本地存储的用户信息
      const userInfo = uni.getStorageSync('userInfo')
      if (userInfo) {
        userInfo.role = role
        userInfo.roleText = this.getRoleText(role)
        uni.setStorageSync('userInfo', userInfo)
        
        uni.showToast({
          title: `已切换为${this.getRoleText(role)}`,
          icon: 'success'
        })
        
        // 重新加载页面
        setTimeout(() => {
          uni.reLaunch({
            url: '/pages/index/index'
          })
        }, 1000)
      }
    },
    
    getRoleText(role) {
      const map = {
        'admin': '管理员',
        'project_manager': '项目经理',
        'doctor': '医生'
      }
      return map[role] || '未知'
    }
  }
}
</script>
```

**注意：** 这种方法仅修改本地存储，不修改数据库，适合快速测试UI和权限控制。

---

## 📋 各方法对比

| 方法 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **双微信账号** | ✅ 真实环境<br>✅ 测试完整流程<br>✅ 不需要频繁修改 | ⚠️ 需要两个微信账号<br>⚠️ 切换略麻烦 | ⭐⭐⭐⭐⭐ |
| **临时修改角色** | ✅ 单人开发友好<br>✅ 操作简单 | ⚠️ 需要手动改数据库<br>⚠️ 需要重新登录 | ⭐⭐⭐⭐ |
| **调试切换工具** | ✅ 切换快速<br>✅ 开发效率高 | ⚠️ 不够真实<br>⚠️ 需要写代码 | ⭐⭐⭐ |

---

## 🎯 推荐方案

### 场景1：有条件使用两个微信
→ **使用方法1（双微信账号）**

### 场景2：单人开发测试
→ **使用方法2（临时修改角色）**

### 场景3：需要频繁测试多角色
→ **结合方法1和方法2**

---

## 📝 实战示例

### 完整测试流程：

**1. 准备阶段**
```
开发者（您）：管理员角色
家人微信账号：项目经理角色
```

**2. 测试管理员功能**
- 使用您的账号登录
- 测试：
  - ✅ 用户管理（添加、编辑、删除）
  - ✅ 入库复核
  - ✅ 查看报表
  - ✅ 系统设置

**3. 测试项目经理功能**
- 让家人用他们的微信登录
- 或切换到项目经理账号
- 测试：
  - ✅ 用户管理（添加、编辑）
  - ✅ 入库复核
  - ✅ 查看报表
  - ❌ 无系统设置权限

**4. 测试双人复核**
- 管理员创建入库单 → 签名提交
- 切换到项目经理
- 项目经理复核 → 签名批准
- ✅ 验证不能自己复核自己的单据

---

## 🔍 查看当前角色

在任何页面的控制台输入：

```javascript
// 查看当前用户信息
const userInfo = uni.getStorageSync('userInfo')
console.log('当前角色:', userInfo.role)
console.log('角色名称:', userInfo.roleText)
console.log('OpenID:', userInfo.openid)
```

---

## ⚠️ 注意事项

### 1. OpenID 的唯一性
- 一个微信账号 = 一个 OpenID
- OpenID 不会变化
- 不同小程序的 OpenID 不同

### 2. 权限测试要点
- ✅ 测试有权限的操作能成功
- ✅ 测试无权限的操作被阻止
- ✅ 测试页面级权限控制
- ✅ 测试操作级权限控制

### 3. 双人复核测试
- ✅ 必须用两个不同的账号
- ✅ 测试自己不能复核自己
- ✅ 测试复核流程完整性

---

## 🚀 快速开始（5分钟）

**1分钟：获取 OpenID**
```javascript
wx.cloud.callFunction({name: 'login'}).then(res => {
  console.log(res.result.openid)
})
```

**2分钟：添加用户到数据库**
```json
{
  "openid": "您的OpenID",
  "name": "管理员",
  "role": "admin",
  "status": "active"
}
```

**1分钟：重新登录**
- 点击"编译"或按 `Ctrl + B`

**1分钟：验证权限**
- 打开"我的"页面
- 查看角色显示
- 尝试访问"用户管理"

---

## 🎬 视频教程（步骤说明）

### 切换角色的完整步骤：

```
1. 打开云开发控制台
   ↓
2. 进入数据库 → users 集合
   ↓
3. 找到您的用户记录
   ↓
4. 点击"编辑"
   ↓
5. 修改 "role" 字段
   - admin → 管理员
   - project_manager → 项目经理
   - doctor → 医生
   ↓
6. 点击"确定"保存
   ↓
7. 回到开发者工具
   ↓
8. 点击"编译"（Ctrl + B）
   ↓
9. 小程序重新加载
   ↓
10. 角色切换成功 ✅
```

---

## 📞 常见问题

### Q1: 切换角色后还是原来的权限？
**A:** 需要重新登录（重新编译小程序），系统会重新获取用户信息。

### Q2: 可以用一个微信测试所有角色吗？
**A:** 可以，使用方法2（临时修改角色），但需要手动改数据库。

### Q3: 如何获取其他人的 OpenID？
**A:** 让对方打开小程序，系统会在登录失败信息中显示 OpenID。

### Q4: 测试时修改了角色，会影响生产环境吗？
**A:** 不会，开发环境和生产环境是独立的数据库。

---

## ✅ 检查清单

开发测试前的准备：

- [ ] 已创建至少2个测试账号（不同角色）
- [ ] 已获取所有账号的 OpenID
- [ ] 已在数据库中添加用户记录
- [ ] 已设置正确的角色
- [ ] 已测试登录成功
- [ ] 已验证角色权限

---

**最后更新：** 2025-11-09  
**版本：** v1.0  
**适用场景：** 开发测试阶段

