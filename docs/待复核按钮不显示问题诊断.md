# ğŸ” å¾…å¤æ ¸æŒ‰é’®ä¸æ˜¾ç¤ºé—®é¢˜è¯Šæ–­

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡ï¼š**
- å…¥åº“å•çŠ¶æ€æ˜¾ç¤º"å¾…å¤æ ¸"
- ä½†æ˜¯æ²¡æœ‰æ˜¾ç¤º"é€šè¿‡"å’Œ"é©³å›"æŒ‰é’®
- ç”¨æˆ·æ— æ³•è¿›è¡Œå¤æ ¸æ“ä½œ

---

## ğŸ” é—®é¢˜åŸå› åˆ†æ

### åŸå› 1ï¼šè¿›å…¥äº†é”™è¯¯çš„é¡µé¢

ç³»ç»Ÿæœ‰ä¸¤ä¸ªé¡µé¢ï¼š
1. **`detail.vue`** - è¯¦æƒ…é¡µï¼ˆåªæŸ¥çœ‹ï¼Œä¸èƒ½å¤æ ¸ï¼‰
2. **`review.vue`** - å¤æ ¸é¡µï¼ˆå¯ä»¥å¤æ ¸ï¼‰

**å¦‚æœè¿›å…¥çš„æ˜¯ `detail.vue`ï¼Œå°±ä¸ä¼šæ˜¾ç¤ºå¤æ ¸æŒ‰é’®ã€‚**

---

### åŸå› 2ï¼šæƒé™æ£€æŸ¥å¤±è´¥

`canReview()` æ–¹æ³•çš„æ£€æŸ¥é€»è¾‘ï¼š

```javascript
canReview(item) {
  // 1. æ£€æŸ¥çŠ¶æ€æ˜¯å¦ä¸ºå¾…å¤æ ¸
  if (item.status !== 'pending_review') {
    return false
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±åˆ›å»ºçš„ï¼ˆä¸èƒ½è‡ªå·±å¤æ ¸è‡ªå·±ï¼‰
  if (item.operatorId === this.currentUserId) {
    return false
  }
  
  // 3. æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦æœ‰å¤æ ¸æƒé™
  const userRole = userInfo?.role || ''
  return userRole === 'admin' || userRole === 'project_manager'
}
```

**å¯èƒ½çš„é—®é¢˜ï¼š**
- `operatorId` å’Œ `currentUserId` ç›¸åŒï¼ˆè‡ªå·±åˆ›å»ºçš„ï¼‰
- `currentUserId` æœªæ­£ç¡®è·å–
- ç”¨æˆ·è§’è‰²ä¸æ˜¯ admin æˆ– project_manager

---

## ğŸ”§ å·²æ·»åŠ çš„è°ƒè¯•ä»£ç 

### ä½ç½®ï¼š`pages-sub/in/list.vue` (lines 516-541)

```javascript
canReview(item) {
  console.log('ğŸ” å¤æ ¸æƒé™æ£€æŸ¥:', {
    itemStatus: item.status,
    operatorId: item.operatorId,
    currentUserId: this.currentUserId,
    isSameUser: item.operatorId === this.currentUserId
  })
  
  if (item.status !== 'pending_review' || item.operatorId === this.currentUserId) {
    console.log('âŒ ä¸èƒ½å¤æ ¸: çŠ¶æ€ä¸å¯¹æˆ–æ˜¯è‡ªå·±åˆ›å»ºçš„')
    return false
  }
  
  const userInfo = uni.getStorageSync('userInfo')
  const userRole = userInfo?.role || ''
  const hasPermission = userRole === 'admin' || userRole === 'project_manager'
  
  console.log('âœ… å¤æ ¸æƒé™ç»“æœ:', {
    userRole,
    hasPermission
  })
  
  return hasPermission
}
```

---

## ğŸ§ª è¯Šæ–­æ­¥éª¤

### 1. é‡æ–°ç¼–è¯‘å°ç¨‹åº

### 2. ä½¿ç”¨é¡¹ç›®ç»ç†è´¦æˆ·ç™»å½•

### 3. è¿›å…¥å¾…å¤æ ¸åˆ—è¡¨

**æ–¹å¼1ï¼š** ç‚¹å‡»é¦–é¡µçš„"å¾…å¤æ ¸å…¥åº“å•"  
**æ–¹å¼2ï¼š** ç‚¹å‡»"å…¥åº“ç®¡ç†" â†’ "å¾…å¤æ ¸"æ ‡ç­¾

### 4. æŸ¥çœ‹æ§åˆ¶å°

**åº”è¯¥çœ‹åˆ°ï¼š**
```
ğŸ” å¤æ ¸æƒé™æ£€æŸ¥: {
  itemStatus: "pending_review",
  operatorId: "xxx",
  currentUserId: "yyy",
  isSameUser: false
}
âœ… å¤æ ¸æƒé™ç»“æœ: {
  userRole: "project_manager",
  hasPermission: true
}
```

### 5. ç‚¹å‡»å…¥åº“å•

**å¦‚æœæƒé™æ­£ç¡®ï¼š**
- åº”è¯¥è·³è½¬åˆ° `/pages-sub/in/review?id=xxx`
- æ˜¾ç¤ºå¤æ ¸é¡µé¢ï¼Œæœ‰"é€šè¿‡"å’Œ"é©³å›"æŒ‰é’®

**å¦‚æœæƒé™ä¸æ­£ç¡®ï¼š**
- è·³è½¬åˆ° `/pages-sub/in/detail?id=xxx`
- åªæ˜¾ç¤ºè¯¦æƒ…ï¼Œæ²¡æœ‰å¤æ ¸æŒ‰é’®

---

## ğŸ” å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šoperatorId å’Œ currentUserId ç›¸åŒ

**ç°è±¡ï¼š**
```
ğŸ” å¤æ ¸æƒé™æ£€æŸ¥: {
  operatorId: "abc123",
  currentUserId: "abc123",
  isSameUser: true
}
âŒ ä¸èƒ½å¤æ ¸: çŠ¶æ€ä¸å¯¹æˆ–æ˜¯è‡ªå·±åˆ›å»ºçš„
```

**åŸå› ï¼š** ç”¨åŒä¸€ä¸ªè´¦æˆ·åˆ›å»ºå’Œå¤æ ¸

**è§£å†³ï¼š** ä½¿ç”¨ä¸åŒçš„è´¦æˆ·
- ç”¨åŒ»ç”Ÿè´¦æˆ·åˆ›å»ºå…¥åº“å•
- ç”¨é¡¹ç›®ç»ç†è´¦æˆ·å¤æ ¸

---

### é—®é¢˜2ï¼šcurrentUserId æœªè·å–

**ç°è±¡ï¼š**
```
ğŸ” å¤æ ¸æƒé™æ£€æŸ¥: {
  operatorId: "abc123",
  currentUserId: "",
  isSameUser: false
}
```

**åŸå› ï¼š** ç”¨æˆ·ä¿¡æ¯æœªæ­£ç¡®ä¿å­˜

**è§£å†³ï¼š** é‡æ–°ç™»å½•

---

### é—®é¢˜3ï¼šç”¨æˆ·è§’è‰²ä¸å¯¹

**ç°è±¡ï¼š**
```
âœ… å¤æ ¸æƒé™ç»“æœ: {
  userRole: "doctor",
  hasPermission: false
}
```

**åŸå› ï¼š** åŒ»ç”Ÿæ²¡æœ‰å¤æ ¸æƒé™

**è§£å†³ï¼š** ä½¿ç”¨é¡¹ç›®ç»ç†æˆ–ç®¡ç†å‘˜è´¦æˆ·

---

## ğŸ“Š æƒé™è§„åˆ™

### è°å¯ä»¥å¤æ ¸ï¼Ÿ

| è§’è‰² | å¯ä»¥å¤æ ¸ | è¯´æ˜ |
|------|---------|------|
| ç®¡ç†å‘˜ | âœ… | å¯ä»¥å¤æ ¸ä»»ä½•äººåˆ›å»ºçš„å•æ® |
| é¡¹ç›®ç»ç† | âœ… | å¯ä»¥å¤æ ¸ä»»ä½•äººåˆ›å»ºçš„å•æ® |
| åŒ»ç”Ÿ | âŒ | ä¸èƒ½å¤æ ¸ |
| è¯å¸ˆ | âŒ | ä¸èƒ½å¤æ ¸ |

### é™åˆ¶è§„åˆ™

- âŒ **ä¸èƒ½è‡ªå·±å¤æ ¸è‡ªå·±åˆ›å»ºçš„å•æ®**
- âœ… åªèƒ½å¤æ ¸çŠ¶æ€ä¸º"å¾…å¤æ ¸"çš„å•æ®
- âœ… å¿…é¡»æœ‰å¤æ ¸æƒé™ï¼ˆadmin æˆ– project_managerï¼‰

---

## ğŸ”„ æ­£ç¡®çš„æ“ä½œæµç¨‹

### æ­¥éª¤1ï¼šåŒ»ç”Ÿåˆ›å»ºå…¥åº“å•

1. ä½¿ç”¨**åŒ»ç”Ÿè´¦æˆ·**ç™»å½•
2. ç‚¹å‡»"æ–°å»ºå…¥åº“å•"
3. å¡«å†™è¯å“ä¿¡æ¯å¹¶ç­¾å
4. æäº¤å…¥åº“å•
5. çŠ¶æ€å˜ä¸º"å¾…å¤æ ¸"

### æ­¥éª¤2ï¼šé¡¹ç›®ç»ç†å¤æ ¸

1. ä½¿ç”¨**é¡¹ç›®ç»ç†è´¦æˆ·**ç™»å½•
2. ç‚¹å‡»é¦–é¡µ"å¾…å¤æ ¸å…¥åº“å•"
3. ç‚¹å‡»å¾…å¤æ ¸çš„å…¥åº“å•
4. **åº”è¯¥è¿›å…¥å¤æ ¸é¡µé¢**ï¼ˆ`review.vue`ï¼‰
5. æ˜¾ç¤º"é€šè¿‡"å’Œ"é©³å›"æŒ‰é’®
6. ç­¾åå¹¶é€‰æ‹©é€šè¿‡æˆ–é©³å›

---

## ğŸ¯ å¿«é€Ÿæ£€æŸ¥æ¸…å•

### æ£€æŸ¥1ï¼šå½“å‰ç”¨æˆ·

```javascript
const userInfo = uni.getStorageSync('userInfo')
console.log('å½“å‰ç”¨æˆ·:', {
  name: userInfo.name,
  role: userInfo.role,
  userId: userInfo.userId || userInfo._id
})
```

**æœŸæœ›ï¼š**
- è§’è‰²æ˜¯ `project_manager` æˆ– `admin`
- userId æœ‰å€¼

---

### æ£€æŸ¥2ï¼šå…¥åº“å•ä¿¡æ¯

```javascript
console.log('å…¥åº“å•ä¿¡æ¯:', {
  status: item.status,
  operator: item.operator,
  operatorId: item.operatorId
})
```

**æœŸæœ›ï¼š**
- status æ˜¯ `pending_review`
- operatorId ä¸å½“å‰ç”¨æˆ·IDä¸åŒ

---

### æ£€æŸ¥3ï¼šè·³è½¬URL

```javascript
console.log('è·³è½¬URL:', url)
```

**æœŸæœ›ï¼š**
- åº”è¯¥æ˜¯ `/pages-sub/in/review?id=xxx`
- è€Œä¸æ˜¯ `/pages-sub/in/detail?id=xxx`

---

## ğŸ’¡ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### å¦‚æœæƒé™æ£€æŸ¥æœ‰é—®é¢˜

**æ–¹æ¡ˆ1ï¼šç›´æ¥è·³è½¬åˆ°å¤æ ¸é¡µé¢**

ä¿®æ”¹ `goDetail` æ–¹æ³•ï¼š

```javascript
goDetail(id, item) {
  // å¦‚æœæ˜¯å¾…å¤æ ¸çŠ¶æ€ï¼Œç›´æ¥è·³è½¬åˆ°å¤æ ¸é¡µé¢
  if (item && item.status === 'pending_review') {
    this.goReview(id)
  } else {
    uni.navigateTo({
      url: `/pages-sub/in/detail?id=${id}`
    })
  }
}
```

**æ–¹æ¡ˆ2ï¼šåœ¨è¯¦æƒ…é¡µæ·»åŠ å¤æ ¸æŒ‰é’®**

ä¿®æ”¹ `detail.vue`ï¼Œæ·»åŠ æƒé™æ£€æŸ¥ï¼š

```javascript
computed: {
  canReview() {
    const userInfo = uni.getStorageSync('userInfo')
    const userRole = userInfo?.role || ''
    const isNotSelf = this.record.operatorId !== this.currentUserId
    return (userRole === 'admin' || userRole === 'project_manager') && isNotSelf
  }
}
```

---

## ğŸ“ è¯Šæ–­ç»“æœè®°å½•

### æµ‹è¯•1ï¼šæ§åˆ¶å°æ—¥å¿—

**å¤åˆ¶æ§åˆ¶å°è¾“å‡ºï¼š**
```
[åœ¨è¿™é‡Œç²˜è´´æ§åˆ¶å°æ—¥å¿—]
```

### æµ‹è¯•2ï¼šè·³è½¬URL

**å®é™…è·³è½¬åˆ°ï¼š**
```
[åœ¨è¿™é‡Œè®°å½•å®é™…çš„URL]
```

### æµ‹è¯•3ï¼šç”¨æˆ·ä¿¡æ¯

**å½“å‰ç”¨æˆ·ï¼š**
```
name: [è®°å½•]
role: [è®°å½•]
userId: [è®°å½•]
```

**å…¥åº“å•åˆ›å»ºè€…ï¼š**
```
operator: [è®°å½•]
operatorId: [è®°å½•]
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

æ ¹æ®è¯Šæ–­ç»“æœï¼š

### å¦‚æœæ˜¯æƒé™é—®é¢˜

1. ç¡®ä¿ä½¿ç”¨é¡¹ç›®ç»ç†æˆ–ç®¡ç†å‘˜è´¦æˆ·
2. ç¡®ä¿ä¸æ˜¯è‡ªå·±åˆ›å»ºçš„å•æ®

### å¦‚æœæ˜¯é¡µé¢è·³è½¬é—®é¢˜

1. æ£€æŸ¥ `canReview()` æ–¹æ³•çš„è¿”å›å€¼
2. ç¡®ä¿è·³è½¬åˆ° `review.vue` è€Œä¸æ˜¯ `detail.vue`

---

**è¯·é‡æ–°ç¼–è¯‘å°ç¨‹åºï¼Œä½¿ç”¨é¡¹ç›®ç»ç†è´¦æˆ·ç™»å½•ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œç„¶åå‘Šè¯‰æˆ‘çœ‹åˆ°äº†ä»€ä¹ˆï¼** ğŸ”

