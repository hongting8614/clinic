# 🚀 AK-PMS 快速部署指南

本指南将帮助你快速部署和运行 AK-PMS 药品管理系统。

---

## 📋 前置条件

### 1. 开发工具
- ✅ [HBuilderX](https://www.dcloud.io/hbuilderx.html) 或 VSCode + uni-app插件
- ✅ [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)

### 2. 账号准备
- ✅ 微信小程序账号（[注册地址](https://mp.weixin.qq.com/)）
- ✅ 微信云开发环境（小程序后台开通）

### 3. 开发环境
- Node.js v16+
- npm v8+

---

## 🔧 部署步骤

### 步骤 1：获取代码

```bash
# 进入项目目录
cd D:\medicine_manager\AK-PMS
```

### 步骤 2：配置小程序 AppID

编辑 `manifest.json` 文件：

```json
{
  "mp-weixin": {
    "appid": "你的小程序AppID",
    "setting": {
      "urlCheck": false
    }
  }
}
```

或在 HBuilderX 中：
1. 点击菜单：发行 → 小程序-微信
2. 填入你的小程序 AppID

### 步骤 3：开通云开发

1. 打开微信开发者工具
2. 点击工具栏"云开发"按钮
3. 按提示开通云开发（免费版即可）
4. 记录环境ID（后续需要）

### 步骤 4：创建数据库集合

在云开发控制台 → 数据库，创建以下集合：

#### 必需集合（5个）
1. **users** - 用户表
2. **drugs** - 药品档案表
3. **stock** - 库存表
4. **in_records** - 入库记录表
5. **out_records** - 出库记录表

#### 可选集合（暂不需要）
- transfer_records - 调拨记录
- consume_records - 消耗记录
- requisition_records - 请领记录
- inventory_records - 盘点记录
- damage_records - 报损记录
- return_records - 退货记录
- departments - 部门表
- locations - 园区配置表
- system_config - 系统配置表

### 步骤 5：上传云函数

在微信开发者工具中：

1. **入库单管理云函数**
   - 右键 `cloudfunctions/inRecords`
   - 选择"上传并部署：云端安装依赖"

2. **出库单管理云函数**
   - 右键 `cloudfunctions/outRecords`
   - 选择"上传并部署：云端安装依赖"

3. **药品查询云函数**
   - 右键 `cloudfunctions/getDrugList`
   - 选择"上传并部署：云端安装依赖"

4. **库存查询云函数**
   - 右键 `cloudfunctions/getStockList`
   - 选择"上传并部署：云端安装依赖"

5. **用户管理相关云函数**（如果已有）
   - `cloudfunctions/login`
   - `cloudfunctions/getUserList`
   - `cloudfunctions/addUser`
   - `cloudfunctions/updateUser`
   - `cloudfunctions/deleteUser`
   - `cloudfunctions/updateUserStatus`
   - `cloudfunctions/getMyOpenId`
   - `cloudfunctions/updateStock`

等待所有云函数部署完成（右上角会显示部署进度）。

### 步骤 6：导入初始数据

#### 6.1 创建测试用户

在云开发控制台 → 数据库 → users 集合，添加记录：

```json
{
  "openid": "test_openid_001",
  "name": "张三",
  "phone": "13800138000",
  "role": "admin",
  "status": "active",
  "createTime": "2025-10-28T00:00:00.000Z",
  "updateTime": "2025-10-28T00:00:00.000Z"
}
```

```json
{
  "openid": "test_openid_002",
  "name": "李四",
  "phone": "13800138001",
  "role": "admin",
  "status": "active",
  "createTime": "2025-10-28T00:00:00.000Z",
  "updateTime": "2025-10-28T00:00:00.000Z"
}
```

#### 6.2 创建测试药品

在 drugs 集合，添加记录：

```json
{
  "name": "阿莫西林胶囊",
  "pinyin": "AMXLJN",
  "spec": "0.25g*24粒",
  "unit": "盒",
  "manufacturer": "XX制药有限公司",
  "category": "抗生素",
  "barcode": "6901234567890",
  "image": "",
  "isHighValue": false,
  "isEmergency": false,
  "safeStock": 100,
  "minStock": 50,
  "createTime": "2025-10-28T00:00:00.000Z",
  "updateTime": "2025-10-28T00:00:00.000Z"
}
```

```json
{
  "name": "布洛芬缓释胶囊",
  "pinyin": "BLFHSJN",
  "spec": "0.3g*20粒",
  "unit": "盒",
  "manufacturer": "YY制药有限公司",
  "category": "感冒药",
  "barcode": "6901234567891",
  "image": "",
  "isHighValue": false,
  "isEmergency": false,
  "safeStock": 100,
  "minStock": 50,
  "createTime": "2025-10-28T00:00:00.000Z",
  "updateTime": "2025-10-28T00:00:00.000Z"
}
```

```json
{
  "name": "速效救心丸",
  "pinyin": "SXJXW",
  "spec": "40mg*60粒",
  "unit": "瓶",
  "manufacturer": "ZZ制药有限公司",
  "category": "心血管",
  "barcode": "6901234567892",
  "image": "",
  "isHighValue": true,
  "isEmergency": true,
  "safeStock": 50,
  "minStock": 20,
  "createTime": "2025-10-28T00:00:00.000Z",
  "updateTime": "2025-10-28T00:00:00.000Z"
}
```

### 步骤 7：设置数据库权限

在云开发控制台 → 数据库 → 数据库设置：

为每个集合设置权限：
- 开发阶段：选择"所有用户可读写"（方便测试）
- 生产环境：选择"仅创建者可读写"或自定义权限

### 步骤 8：创建数据库索引（可选，提升性能）

在云开发控制台 → 数据库 → 索引管理：

#### drugs 表索引
```javascript
{ name: 1 }
{ pinyin: 1 }
{ barcode: 1 } // 唯一索引
```

#### stock 表索引
```javascript
{ drugId: 1, batch: 1, location: 1 } // 联合索引
{ expireDate: 1 }
```

#### in_records 表索引
```javascript
{ status: 1 }
{ createTime: -1 }
{ recordNo: 1 } // 唯一索引
```

#### out_records 表索引
```javascript
{ status: 1 }
{ location: 1 }
{ createTime: -1 }
{ recordNo: 1 } // 唯一索引
```

### 步骤 9：运行项目

#### 方式一：HBuilderX
1. 打开 HBuilderX
2. 打开项目文件夹
3. 点击：运行 → 运行到小程序模拟器 → 微信开发者工具

#### 方式二：微信开发者工具
1. 打开微信开发者工具
2. 导入项目
3. 选择项目目录：`D:\medicine_manager\AK-PMS`
4. 填入 AppID
5. 点击"编译"

### 步骤 10：测试功能

#### 10.1 测试用户登录
- 小程序会自动获取 openid
- 如果没有测试数据，需要先在 storage 中手动设置

#### 10.2 测试入库流程
1. 首页 → 点击"入库管理"
2. 点击右下角"+"按钮
3. 扫码或手动添加药品
4. 填写批次信息
5. 操作员签名
6. 提交复核
7. 在列表中找到刚创建的单据
8. 点击"去复核"
9. 接收人签名
10. 点击"通过复核"
11. 查看库存是否增加

#### 10.3 测试出库流程
1. 首页 → 点击"出库管理"
2. 选择园区（陆园/水园）
3. 扫码或手动添加药品
4. 选择批次（会显示FIFO推荐）
5. 填写出库数量
6. 发放人签名
7. 提交复核
8. 接收人确认
9. 查看库存是否扣减

---

## ⚠️ 常见问题

### Q1：云函数调用失败
**原因**：
- 云函数未上传
- 环境ID未配置
- 权限不足

**解决**：
1. 检查云函数是否上传成功
2. 检查 `project.config.json` 中的环境ID
3. 检查云开发权限设置

### Q2：无法获取用户信息
**原因**：
- openid 未正确获取
- users 表无对应记录

**解决**：
1. 调用 `getMyOpenId` 云函数获取 openid
2. 在 users 表中添加对应记录
3. 或使用测试数据手动设置 storage

### Q3：扫码功能无法使用
**原因**：
- 真机需要相机权限
- 模拟器不支持扫码

**解决**：
1. 使用真机测试扫码功能
2. 或使用"手动添加"功能

### Q4：签名无法显示
**原因**：
- Canvas 组件初始化失败
- 云存储未配置

**解决**：
1. 检查 Canvas API 是否正常
2. 配置云存储权限
3. 查看控制台错误信息

### Q5：库存未更新
**原因**：
- 云函数执行失败
- 数据库权限不足
- updateStock 逻辑错误

**解决**：
1. 查看云函数日志
2. 检查数据库权限
3. 调试 updateStock 云函数

---

## 🔍 调试技巧

### 1. 查看云函数日志
云开发控制台 → 云函数 → 选择函数 → 日志

### 2. 查看数据库数据
云开发控制台 → 数据库 → 选择集合 → 查看记录

### 3. 使用控制台调试
微信开发者工具 → 控制台 → 查看 console.log 输出

### 4. 模拟数据测试
- 当前代码使用模拟数据
- 可先不连接云函数进行UI测试
- 功能验证通过后再对接云函数

---

## 📊 性能优化建议

### 1. 数据库优化
- 创建必要的索引
- 定期清理过期数据
- 使用聚合查询

### 2. 云函数优化
- 合并相似查询
- 使用并发请求
- 添加缓存机制

### 3. 前端优化
- 分页加载
- 图片懒加载
- 防抖节流

---

## 🚀 上线发布

### 1. 代码审查
- [ ] 移除调试代码
- [ ] 移除 console.log
- [ ] 检查敏感信息
- [ ] 验证所有功能

### 2. 性能测试
- [ ] 压力测试
- [ ] 响应时间
- [ ] 错误处理

### 3. 提交审核
1. 微信开发者工具 → 上传代码
2. 填写版本号和更新说明
3. 登录小程序后台
4. 版本管理 → 提交审核
5. 等待审核通过
6. 发布上线

---

## 📞 技术支持

如遇问题，请参考：
- [开发进展报告](../DEVELOPMENT_PROGRESS.md)
- [需求文档](./需求文档_最终版.md)
- [数据库设计](./数据库设计.md)

或联系开发团队获取支持。

---

**祝部署顺利！** 🎉

