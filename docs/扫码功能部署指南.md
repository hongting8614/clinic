# 📱 扫码添加药品功能 - 部署指南

## 🎯 功能说明

通过扫描药品条形码，自动查询并填充药品信息（名称、规格、单位、厂家等）。

### ⚠️ 重要说明

使用**微信扫码**功能，调用**中国物品编码中心**第三方API获取药品信息。

### 数据来源（三级查询策略）

1. **本地药品档案** - 优先查询系统中已录入的药品（秒级，免费）
2. **缓存数据库** - 查询之前扫码过的药品（秒级，免费）
3. **第三方API** - 阿里云/聚合数据商品条码查询（约¥0.01/次）

### 💡 核心特性

- ✅ **微信扫码**：调用微信原生扫码功能（wx.scanCode）
- ✅ **权威数据**：接入中国物品编码中心数据源
- ✅ **智能缓存**：查询过的药品自动缓存，提升速度
- ✅ **成本低廉**：本地缓存优先，API调用成本约3元/月
- ✅ **智能降级**：API失败时可手动填写并保存映射

---

## 📋 部署步骤

### 🔑 步骤0：配置第三方API（推荐）

**⚠️ 建议配置API密钥，可自动查询新药品信息！**

详细配置教程：**[第三方API配置指南.md](./第三方API配置指南.md)**

**快速配置（5分钟）：**

1. **购买阿里云API**
   - 访问：https://market.aliyun.com/
   - 搜索"商品条码查询"
   - 购买按量付费（约¥0.01/次，月成本约3元）

2. **获取APPCODE**
   - 阿里云控制台 → 云市场 → 已购买的服务
   - 复制你的APPCODE

3. **配置环境变量**
   - 上传云函数后，在云开发控制台配置
   - 或在上传前在微信开发者工具中配置

**💡 提示**：不配置也能用，但新药品需要手动填写（系统会自动记录）。

---

### 步骤1：上传云函数

在**微信开发者工具**中：

1. 找到 `cloudfunctions/drugBarcodeQuery` 文件夹
2. **右键点击** `drugBarcodeQuery` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待上传完成（约20-30秒）

**验证上传**：
- 打开云开发控制台
- 点击"云函数"
- 查看 `drugBarcodeQuery` 状态为"部署成功"

---

### 步骤2：创建数据库集合

在**云开发控制台 → 数据库**中创建：

#### 集合1：`drug_barcode_cache`（条形码缓存表）

```json
{
  "_id": "cache_xxx",
  "barcode": "6901028075916",
  "drugInfo": {
    "name": "阿莫西林胶囊",
    "specification": "0.25g×24粒",
    "unit": "盒",
    "manufacturer": "XX制药厂",
    "barcode": "6901028075916"
  },
  "queryCount": 1,
  "cacheTime": Date,
  "lastQueryTime": Date,
  "createTime": Date
}
```

**操作**：
1. 点击"添加集合"
2. 集合名称：`drug_barcode_cache`
3. 点击"确定"

---

### 步骤3：为现有药品添加条形码

在 `drugs` 集合中，为药品记录添加 `barcode` 字段：

```json
{
  "_id": "drug_xxx",
  "drugName": "阿莫西林胶囊",
  "specification": "0.25g×24粒",
  "packUnit": "盒",
  "barcode": "6901028075916",  // ← 添加这个字段
  "status": "active"
}
```

**批量添加方法**：

在云开发控制台 → 数据库 → `drugs` 集合中，点击某条记录：
1. 点击"编辑"
2. 点击"添加字段"
3. 字段名：`barcode`
4. 字段值：输入条形码（如 `6901028075916`）
5. 点击"保存"

---

## 🧪 测试步骤

### 测试1：扫描已录入的药品

1. 打开入库单页面
2. 点击"新建药品"
3. 点击绿色扫码卡片
4. 扫描药品包装上的条形码
5. **预期结果**：自动填充药品信息，提示"识别成功！(本地档案)"

### 测试2：扫描未录入的药品（智能学习）

1. 扫描一个数据库中没有的药品条形码
2. 系统查询失败，弹窗提示"未找到药品"
3. **手动填写**药品名称、规格、单位
4. 点击"确定添加"
5. **系统自动记录**该条形码与药品的对应关系
6. **下次扫描同样的条形码，直接填充！**

### 测试3：再次扫描相同条形码

1. 扫描之前手动填写过的药品
2. **预期结果**：提示"识别成功！(缓存数据)"，自动填充

### 测试4：真机测试（推荐）

**模拟器扫码可能有限制，建议真机测试：**

1. 点击微信开发者工具顶部 **【预览】**
2. 用手机微信扫描二维码
3. 在真机上测试扫码功能

---

## 🔧 常见问题

### Q1：提示"云函数不存在"

**原因**：云函数未上传或部署失败

**解决方法**：
1. 检查 `cloudfunctions/drugBarcodeQuery` 文件夹是否存在
2. 重新上传云函数
3. 在云开发控制台查看云函数状态

---

### Q2：扫码后提示"查询失败"

**可能原因**：
1. 网络问题
2. 码上放心API暂时不可用
3. 条形码格式不正确

**解决方法**：
1. 检查网络连接
2. 查看云函数日志（云开发控制台 → 云函数 → 日志）
3. 重试或手动填写

---

### Q3：想使用聚合数据API

**配置方法**：

1. 注册聚合数据账号：https://www.juhe.cn/
2. 申请"药品查询"API，获取API KEY
3. 在云函数中配置环境变量：
   - 云开发控制台 → 云函数 → `drugBarcodeQuery`
   - 点击"配置"
   - 添加环境变量：
     - 键：`JUHE_API_KEY`
     - 值：你的API KEY
4. 保存并重新部署云函数

---

### Q4：码上放心API返回空数据

**原因**：
- 码上放心数据库可能没有该药品
- 条形码非标准药品条形码

**解决方法**：
- 使用聚合数据API作为备用
- 或手动录入药品信息

---

## 📊 数据来源对比

| 数据源 | 优势 | 劣势 | 费用 |
|--------|------|------|------|
| **本地档案** | 速度最快，100%准确 | 需要预先录入 | 免费 |
| **缓存数据** | 速度快，减少API调用 | 需要先扫一次 | 免费 |
| **码上放心** | 官方权威，免费 | 数据不全，速度较慢 | 免费 |
| **聚合数据** | 数据全，速度快 | 需要付费 | ¥500-2000/年 |

---

## 🚀 优化建议

1. **批量导入常用药品条形码**
   - 提前录入医院常用的100-200种药品
   - 扫码时直接命中本地数据库，速度最快

2. **定期清理缓存**
   - 缓存有效期设置为30天
   - 超过30天的缓存自动删除

3. **监控API调用次数**
   - 在云开发控制台查看云函数调用量
   - 避免超出免费额度

4. **备用方案**
   - 配置多个API作为备用
   - 一个失败自动切换到下一个

---

## ✅ 部署检查清单

- [ ] 云函数 `drugBarcodeQuery` 已上传
- [ ] 云函数状态显示"部署成功"
- [ ] 数据库集合 `drug_barcode_cache` 已创建
- [ ] 至少一个药品添加了 `barcode` 字段
- [ ] 测试扫码功能正常
- [ ] 查看云函数日志无报错

---

## 📞 技术支持

如遇问题，请查看：
1. 云函数日志（云开发控制台 → 云函数 → 日志）
2. 小程序控制台日志（微信开发者工具 → Console）
3. 网络请求状态（微信开发者工具 → Network）

---

**部署完成后，扫码功能即可正常使用！** 🎉

