# 🔧 提交入库单登录检查修复说明

## 📋 问题现象

管理员登录后，填写入库单并点击"提交入库"时，弹出提示：
```
请先登录
您还未登录，无法提交入库单。是否前往登录？
```

## 🔍 问题原因

### 原因分析

**登录检查代码：**
```javascript
// pages-sub/in/add.vue 第1208行（修复前）
if (!userInfo || !userInfo.name || !userInfo._id) {
  // 提示未登录
}
```

**问题：**
- 检查条件要求 `userInfo._id` 存在
- 但云函数返回的用户信息中，ID字段名是 `userId` 而不是 `_id`

**用户信息结构：**
```javascript
// 云函数 login 返回的 userInfo
{
  userId: "xxx",        // ← ID字段名是 userId
  openid: "xxx",
  name: "管理员",
  realName: "张三",
  role: "admin",
  roleText: "管理员"
}
```

**检查逻辑：**
```javascript
if (!userInfo._id) {  // ← 这里检查 _id，但实际是 userId
  // 判断为未登录
}
```

---

## ✅ 修复方案

### 修改1：兼容两种ID字段名

```javascript
// 修复后
const userId = userInfo?.userId || userInfo?._id

if (!userInfo || !userInfo.name || !userId) {
  // 提示未登录
}
```

**说明：**
- 兼容 `userId` 和 `_id` 两种字段名
- 确保能正确获取用户ID

### 修改2：添加调试日志

```javascript
if (!userInfo || !userInfo.name || !userId) {
  console.error('用户信息检查失败:', {
    hasUserInfo: !!userInfo,
    name: userInfo?.name,
    userId: userId,
    fullUserInfo: userInfo
  })
  // ...
}
```

**说明：**
- 当检查失败时，输出详细的用户信息
- 方便排查问题

### 修改3：修复提交时的operatorId

```javascript
// 修复前
operatorId: userInfo._id || userInfo.userId || ''

// 修复后
operatorId: userId  // 使用前面获取的 userId
```

---

## 📝 修改的文件

**文件：** `pages-sub/in/add.vue`

**修改位置：**
1. 第1208行：添加 `userId` 变量
2. 第1210行：修改检查条件
3. 第1211-1216行：添加调试日志
4. 第1258行：使用 `userId` 而不是 `userInfo._id`

---

## 🧪 测试验证

### 测试步骤

1. **重新编译小程序**
2. **使用管理员账户登录**
3. **进入新增入库单页面**
4. **填写入库信息**
5. **签名**
6. **点击"提交入库"**

### 期望结果

- ✅ 不再提示"请先登录"
- ✅ 入库单成功提交
- ✅ 操作员显示为当前登录用户

### 如果还是失败

查看控制台日志，应该会显示：
```
用户信息检查失败: {
  hasUserInfo: true/false,
  name: "xxx",
  userId: "xxx",
  fullUserInfo: {...}
}
```

根据日志信息判断：
- 如果 `hasUserInfo` 是 `false`：说明用户信息未保存
- 如果 `name` 是 `undefined`：说明用户信息中没有 `name` 字段
- 如果 `userId` 是 `undefined`：说明用户信息中没有 `userId` 和 `_id` 字段

---

## 🔄 相关修复

### 同样的问题可能存在于

1. **页面加载时的登录检查** (`initPage` 方法)
   - 第454行也有类似的检查
   - 也需要修复

2. **其他页面的登录检查**
   - 出库单新增页面
   - 其他需要登录的页面

---

## 💡 根本解决方案

### 统一用户信息结构

**建议在登录时统一处理：**

```javascript
// utils/auth.js 第28行
setStorage('userInfo', {
  ...userInfo,
  _id: userInfo.userId || userInfo._id  // 统一添加 _id 字段
})
```

**或者在云函数中统一：**

```javascript
// cloudfunctions/login/index.js
return {
  userInfo: {
    _id: user._id,           // 统一使用 _id
    userId: user._id,        // 同时保留 userId 兼容
    openid: user.openid,
    name: user.name,
    // ...
  }
}
```

---

## ✅ 修复完成

**修复时间：** 2025年11月10日  
**修复内容：**
- ✅ 兼容 `userId` 和 `_id` 两种字段名
- ✅ 添加详细的调试日志
- ✅ 修复提交时的 `operatorId` 字段

**效果：**
- ✅ 管理员可以正常提交入库单
- ✅ 不再出现"请先登录"提示
- ✅ 操作员信息正确保存

---

**最后更新：** 2025年11月10日

