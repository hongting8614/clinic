# æ•°æ®åº“è®¾è®¡æ–‡æ¡£ v3.14 - åŒè½¨åˆ¶å­˜å‚¨

## æ ¸å¿ƒå˜æ›´è¯´æ˜

**ç‰ˆæœ¬**: v3.14 Ultimate  
**æ›´æ–°æ—¥æœŸ**: 2025-11-06  
**æ ¸å¿ƒæ”¹åŠ¨**: æ”¯æŒåŒè½¨åˆ¶å­˜å‚¨ï¼ˆè¯åº“ç”¨åŒ…è£…å•ä½ï¼Œå›­åŒºç”¨æœ€å°å•ä½ï¼‰

### ä¸»è¦å˜æ›´
1. âœ… `stock` è¡¨ï¼šæ ¹æ® `location` ä¸åŒï¼Œä½¿ç”¨ä¸åŒå•ä½å­˜å‚¨
2. âœ… `out_records` è¡¨ï¼šè®°å½•åŒå•ä½è½¬æ¢ä¿¡æ¯
3. âœ… æ–°å¢ `specInfo` å­—æ®µï¼šå­˜å‚¨è§„æ ¼è§£æä¿¡æ¯
4. âœ… æ–°å¢ `drug_storage` å›­åŒºï¼šè¯åº“ä¸“ç”¨

---

## ğŸ“Š æ ¸å¿ƒè¡¨ç»“æ„å˜æ›´

### 1. stock (åº“å­˜è¡¨) - é‡å¤§å˜æ›´ â­â­â­

**å˜æ›´è¯´æ˜**: 
- è¯åº“ï¼ˆdrug_storageï¼‰ï¼šä½¿ç”¨åŒ…è£…å•ä½å­˜å‚¨ï¼ˆç›’ã€ç“¶ã€è¢‹ï¼‰
- å›­åŒºï¼ˆland_park/water_parkï¼‰ï¼šä½¿ç”¨æœ€å°å•ä½å­˜å‚¨ï¼ˆç²’ã€ç‰‡ã€mlï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« | å˜æ›´ |
|-------|------|------|------|------|
| _id | String | åº“å­˜ID | âœ… | - |
| drugId | String | è¯æID | âœ… | - |
| drugName | String | è¯æåç§°(å†—ä½™) | âœ… | - |
| specification | String | è§„æ ¼(ç»Ÿä¸€å­—æ®µå) | âœ… | ğŸ”§ æ”¹å |
| unit | String | å•ä½(åŠ¨æ€ï¼šåŒ…è£…æˆ–æœ€å°) | âœ… | ğŸ”§ è¯­ä¹‰å˜æ›´ |
| manufacturer | String | ç”Ÿäº§å‚å®¶(å†—ä½™) | âœ… | - |
| batch | String | æ‰¹å· | âœ… | - |
| productionDate | Date | ç”Ÿäº§æ—¥æœŸ | âœ… | - |
| expireDate | Date | æœ‰æ•ˆæœŸ | âœ… | - |
| quantity | Number | åº“å­˜æ•°é‡(åŠ¨æ€å•ä½) | âœ… | ğŸ”§ è¯­ä¹‰å˜æ›´ |
| **specInfo** | **Object** | **è§„æ ¼è§£æä¿¡æ¯** | âœ… | â­ æ–°å¢ |
| price | Number | åŒ…è£…å•ä»· | âŒ | - |
| **pricePerMin** | **Number** | **æœ€å°å•ä½å•ä»·** | âŒ | â­ æ–°å¢ |
| **location** | **String** | **æ‰€å±ä½ç½®** | âœ… | ğŸ”§ æ‰©å±•å€¼ |
| lockQuantity | Number | é”å®šæ•°é‡ | âœ… | - |
| status | String | çŠ¶æ€ | âœ… | - |
| createTime | Date | åˆ›å»ºæ—¶é—´ | âœ… | - |
| updateTime | Date | æ›´æ–°æ—¶é—´ | âœ… | - |

**location å¯é€‰å€¼**:
- `drug_storage`: è¯åº“ï¼ˆä½¿ç”¨åŒ…è£…å•ä½ï¼‰â­ æ–°å¢
- `land_park`: é™†å›­ï¼ˆä½¿ç”¨æœ€å°å•ä½ï¼‰
- `water_park`: æ°´å›­ï¼ˆä½¿ç”¨æœ€å°å•ä½ï¼‰

**specInfo å¯¹è±¡ç»“æ„**:
```javascript
{
  conversionRate: 24,           // è½¬æ¢ç‡ï¼š1ç›’=24ç²’
  minUnit: "ç²’",                // æœ€å°å•ä½
  packUnit: "ç›’",               // åŒ…è£…å•ä½
  dosage: 0.25,                 // å‰‚é‡ï¼ˆå¯é€‰ï¼‰
  dosageUnit: "g",              // å‰‚é‡å•ä½ï¼ˆå¯é€‰ï¼‰
  pattern: "standard"           // è§£ææ¨¡å¼
}
```

#### ç¤ºä¾‹æ•°æ®å¯¹æ¯”

**è¯åº“åº“å­˜ï¼ˆåŒ…è£…å•ä½ï¼‰**:
```json
{
  "_id": "stock_drug_001",
  "drugId": "drug_001",
  "drugName": "é˜¿è«è¥¿æ—èƒ¶å›Š",
  "specification": "0.25gÃ—24ç²’/ç›’",
  "batch": "20250101",
  "productionDate": "2025-01-01T00:00:00.000Z",
  "expireDate": "2027-01-01T00:00:00.000Z",
  
  "location": "drug_storage",
  "quantity": 104,
  "unit": "ç›’",
  
  "specInfo": {
    "conversionRate": 24,
    "minUnit": "ç²’",
    "packUnit": "ç›’",
    "dosage": 0.25,
    "dosageUnit": "g",
    "pattern": "standard"
  },
  
  "price": 12.5,
  "pricePerMin": 0.52,
  "lockQuantity": 0,
  "status": "normal",
  "createTime": "2025-01-06T00:00:00.000Z",
  "updateTime": "2025-11-06T00:00:00.000Z"
}
```

**å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰**:
```json
{
  "_id": "stock_land_001",
  "drugId": "drug_001",
  "drugName": "é˜¿è«è¥¿æ—èƒ¶å›Š",
  "specification": "0.25gÃ—24ç²’/ç›’",
  "batch": "20250101",
  "productionDate": "2025-01-01T00:00:00.000Z",
  "expireDate": "2027-01-01T00:00:00.000Z",
  
  "location": "land_park",
  "quantity": 42,
  "unit": "ç²’",
  
  "specInfo": {
    "conversionRate": 24,
    "minUnit": "ç²’",
    "packUnit": "ç›’",
    "dosage": 0.25,
    "dosageUnit": "g",
    "pattern": "standard"
  },
  
  "price": 12.5,
  "pricePerMin": 0.52,
  "lockQuantity": 0,
  "status": "normal",
  "createTime": "2025-01-06T00:00:00.000Z",
  "updateTime": "2025-11-06T14:30:00.000Z"
}
```

**ç´¢å¼•ä¼˜åŒ–**:
```javascript
// å¤åˆç´¢å¼•ï¼ˆä¿è¯å”¯ä¸€æ€§ï¼‰
db.stock.createIndex({ "drugId": 1, "location": 1, "batch": 1 }, { unique: true })

// æŸ¥è¯¢ç´¢å¼•
db.stock.createIndex({ "location": 1, "quantity": 1 })
db.stock.createIndex({ "expireDate": 1 })
db.stock.createIndex({ "unit": 1 })  // æ–°å¢ï¼šæŒ‰å•ä½ç´¢å¼•
db.stock.createIndex({ "status": 1 })
```

---

### 2. out_records (å‡ºåº“è®°å½•è¡¨) - é‡å¤§å˜æ›´ â­â­â­

**å˜æ›´è¯´æ˜**: è®°å½•åŒå•ä½è½¬æ¢ä¿¡æ¯ï¼ˆå…³é”®è½¬æ¢ç‚¹ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¿…å¡« | å˜æ›´ |
|-------|------|------|------|------|
| _id | String | è®°å½•ID | âœ… | - |
| recordNo | String | å‡ºåº“å•å· | âœ… | - |
| status | String | çŠ¶æ€ | âœ… | - |
| **fromLocation** | **String** | **å‡ºåº“æ¥æº** | âœ… | ğŸ”§ æ”¹å |
| **toLocation** | **String** | **å‡ºåº“ç›®æ ‡** | âœ… | â­ æ–°å¢ |
| items | Array | è¯ææ˜ç»†åˆ—è¡¨ | âœ… | ğŸ”§ ç»“æ„å˜æ›´ |
| remark | String | å¤‡æ³¨ | âŒ | - |
| dispenser | String | å‘è¯äººå§“å | âœ… | - |
| dispenserId | String | å‘è¯äººID | âœ… | - |
| dispenserSign | String | å‘è¯äººç­¾åURL | âœ… | - |
| dispenserSignTime | Date | å‘è¯äººç­¾åæ—¶é—´ | âœ… | - |
| receiver | String | é¢†è¯äººå§“å | âŒ | - |
| receiverId | String | é¢†è¯äººID | âŒ | - |
| receiverSign | String | é¢†è¯äººç­¾åURL | âŒ | - |
| receiverSignTime | Date | é¢†è¯äººç­¾åæ—¶é—´ | âŒ | - |
| **reviewer** | **String** | **å¤æ ¸äººå§“å** | âŒ | â­ æ–°å¢ |
| **reviewerId** | **String** | **å¤æ ¸äººID** | âŒ | â­ æ–°å¢ |
| **reviewerSign** | **String** | **å¤æ ¸äººç­¾åURL** | âŒ | â­ æ–°å¢ |
| **reviewerSignTime** | **Date** | **å¤æ ¸äººç­¾åæ—¶é—´** | âŒ | â­ æ–°å¢ |
| createTime | Date | åˆ›å»ºæ—¶é—´ | âœ… | - |
| completeTime | Date | å®Œæˆæ—¶é—´ | âŒ | - |

**items æ•°ç»„ç»“æ„ï¼ˆåŒå•ä½è®°å½•ï¼‰**:
```javascript
{
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25gÃ—24ç²’/ç›’",
  batch: "20250101",
  productionDate: "2025-01-01",
  expireDate: "2027-01-01",
  
  // ===== è¯åº“æ‰£å‡ï¼ˆåŒ…è£…å•ä½ï¼‰=====
  packQuantity: 2,              // å‡ºåº“åŒ…è£…æ•°é‡
  packUnit: "ç›’",               // åŒ…è£…å•ä½
  
  // ===== å›­åŒºå…¥åº“ï¼ˆæœ€å°å•ä½ï¼‰===== â­ å…³é”®ï¼
  minQuantity: 48,              // è½¬æ¢åæœ€å°å•ä½æ•°é‡
  minUnit: "ç²’",                // æœ€å°å•ä½
  
  // ===== è§„æ ¼ä¿¡æ¯ =====
  specInfo: {
    conversionRate: 24,
    minUnit: "ç²’",
    packUnit: "ç›’",
    dosage: 0.25,
    dosageUnit: "g",
    pattern: "standard"
  },
  
  // ===== åº“å­˜å˜åŒ–è®°å½•ï¼ˆä¾¿äºå®¡è®¡ï¼‰=====
  drugStorageBefore: 10,        // è¯åº“å‡ºåº“å‰
  drugStorageAfter: 8,          // è¯åº“å‡ºåº“å
  parkBefore: 0,                // å›­åŒºå…¥åº“å‰
  parkAfter: 48                 // å›­åŒºå…¥åº“å
}
```

#### å®Œæ•´ç¤ºä¾‹æ•°æ®

```json
{
  "_id": "out_001",
  "recordNo": "CK20251106001",
  "status": "completed",
  "fromLocation": "drug_storage",
  "toLocation": "land_park",
  
  "items": [
    {
      "drugId": "drug_001",
      "drugName": "é˜¿è«è¥¿æ—èƒ¶å›Š",
      "specification": "0.25gÃ—24ç²’/ç›’",
      "batch": "20250101",
      "productionDate": "2025-01-01",
      "expireDate": "2027-01-01",
      
      "packQuantity": 2,
      "packUnit": "ç›’",
      
      "minQuantity": 48,
      "minUnit": "ç²’",
      
      "specInfo": {
        "conversionRate": 24,
        "minUnit": "ç²’",
        "packUnit": "ç›’",
        "dosage": 0.25,
        "dosageUnit": "g",
        "pattern": "standard"
      },
      
      "drugStorageBefore": 10,
      "drugStorageAfter": 8,
      "parkBefore": 0,
      "parkAfter": 48
    }
  ],
  
  "remark": "é™†å›­æ—¥å¸¸è¡¥å……",
  
  "dispenser": "å¼ ä¸‰",
  "dispenserId": "user_001",
  "dispenserSign": "cloud://sign1.png",
  "dispenserSignTime": "2025-11-06T14:30:00.000Z",
  
  "receiver": "ç‹äº”",
  "receiverId": "user_002",
  "receiverSign": "cloud://sign2.png",
  "receiverSignTime": "2025-11-06T14:35:00.000Z",
  
  "reviewer": "æåŒ»ç”Ÿ",
  "reviewerId": "user_003",
  "reviewerSign": "cloud://sign3.png",
  "reviewerSignTime": "2025-11-06T14:40:00.000Z",
  
  "createTime": "2025-11-06T14:30:00.000Z",
  "completeTime": "2025-11-06T14:40:00.000Z"
}
```

**ç´¢å¼•ä¼˜åŒ–**:
```javascript
db.out_records.createIndex({ "recordNo": 1 }, { unique: true })
db.out_records.createIndex({ "fromLocation": 1, "createTime": -1 })
db.out_records.createIndex({ "toLocation": 1, "createTime": -1 })
db.out_records.createIndex({ "status": 1 })
```

---

### 3. in_records (å…¥åº“è®°å½•è¡¨) - å°å¹…è°ƒæ•´

**å˜æ›´è¯´æ˜**: å…¥åº“ç»Ÿä¸€åˆ°è¯åº“ï¼Œä½¿ç”¨åŒ…è£…å•ä½

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å˜æ›´ |
|-------|------|------|------|
| **location** | **String** | **å…¥åº“ä½ç½®ï¼ˆå›ºå®šï¼šdrug_storageï¼‰** | â­ æ–°å¢ |
| specification | String | è§„æ ¼(ç»Ÿä¸€å­—æ®µå) | ğŸ”§ æ”¹å |
| **specInfo** | **Object** | **è§„æ ¼è§£æä¿¡æ¯** | â­ æ–°å¢ |

**items æ•°ç»„ç»“æ„**:
```javascript
{
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25gÃ—24ç²’/ç›’",
  batch: "20250101",
  productionDate: "2025-01-01",
  expireDate: "2027-01-01",
  
  quantity: 10,                 // åŒ…è£…å•ä½æ•°é‡
  unit: "ç›’",                   // åŒ…è£…å•ä½
  
  specInfo: {
    conversionRate: 24,
    minUnit: "ç²’",
    packUnit: "ç›’",
    dosage: 0.25,
    dosageUnit: "g",
    pattern: "standard"
  },
  
  price: 12.5,                  // åŒ…è£…å•ä»·
  pricePerMin: 0.52             // æœ€å°å•ä½å•ä»·
}
```

---

### 4. locations (å›­åŒºé…ç½®è¡¨) - æ–°å¢è¯åº“

**æ–°å¢æ•°æ®**:
```json
{
  "_id": "loc_000",
  "code": "drug_storage",
  "name": "è¯åº“",
  "icon": "ğŸ¥",
  "type": "storage",
  "status": "active",
  "sort": 0,
  "createTime": "2025-11-06T00:00:00.000Z"
}
```

**å®Œæ•´å›­åŒºåˆ—è¡¨**:
```json
[
  {
    "_id": "loc_000",
    "code": "drug_storage",
    "name": "è¯åº“",
    "icon": "ğŸ¥",
    "type": "storage",
    "status": "active",
    "sort": 0
  },
  {
    "_id": "loc_001",
    "code": "land_park",
    "name": "é™†å›­åŒ»åŠ¡å®¤",
    "icon": "ğŸ¢",
    "type": "clinic",
    "status": "active",
    "sort": 1
  },
  {
    "_id": "loc_002",
    "code": "water_park",
    "name": "æ°´å›­åŒ»åŠ¡å®¤",
    "icon": "ğŸŒŠ",
    "type": "clinic",
    "status": "active",
    "sort": 2
  }
]
```

---

### 5. drugs (è¯ææ¡£æ¡ˆè¡¨) - å°å¹…è°ƒæ•´

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å˜æ›´ |
|-------|------|------|------|
| specification | String | è§„æ ¼(ç»Ÿä¸€å­—æ®µå) | ğŸ”§ æ”¹å |
| **specInfo** | **Object** | **è§„æ ¼è§£æä¿¡æ¯** | â­ æ–°å¢ |

---

## ğŸ”„ æ•°æ®æµç¤ºä¾‹

### å®Œæ•´ä¸šåŠ¡æµç¨‹

```
1ï¸âƒ£ å…¥åº“åˆ°è¯åº“ï¼ˆåŒ…è£…å•ä½ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: å…¥åº“ 10ç›’ é˜¿è«è¥¿æ—
å­˜å‚¨: 
  location: drug_storage
  quantity: 10
  unit: ç›’

è¯åº“åº“å­˜: 10ç›’


2ï¸âƒ£ å‡ºåº“åˆ°é™†å›­ï¼ˆå…³é”®è½¬æ¢ï¼‰â­
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: å‡ºåº“ 2ç›’ åˆ°é™†å›­
è½¬æ¢: 2ç›’ Ã— 24 = 48ç²’
å­˜å‚¨:
  è¯åº“: quantity: 8ç›’, unit: ç›’
  é™†å›­: quantity: 48ç²’, unit: ç²’ â­

è¯åº“åº“å­˜: 8ç›’
é™†å›­åº“å­˜: 48ç²’


3ï¸âƒ£ é—¨è¯Šæ¶ˆè€—ï¼ˆç›´æ¥æ‰£å‡ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ“ä½œ: æ‚£è€…æœç”¨ 6ç²’
æ‰£å‡: 48ç²’ - 6ç²’ = 42ç²’ï¼ˆæ— éœ€è½¬æ¢ï¼‰â­

è¯åº“åº“å­˜: 8ç›’
é™†å›­åº“å­˜: 42ç²’
```

---

## ğŸ“ æ•°æ®è¿ç§»æŒ‡å—

### è¿ç§»ç­–ç•¥

```javascript
// 1. æ·»åŠ  drug_storage å›­åŒºé…ç½®
db.locations.add({
  _id: "loc_000",
  code: "drug_storage",
  name: "è¯åº“",
  icon: "ğŸ¥",
  type: "storage",
  status: "active",
  sort: 0,
  createTime: new Date()
})

// 2. æ›´æ–° stock è¡¨
// 2.1 ä¸ºæ‰€æœ‰åº“å­˜æ·»åŠ  specInfo
const stocks = await db.collection('stock').get()
for (const stock of stocks.data) {
  const specInfo = UnitConverter.parseSpecification(stock.spec)
  
  await db.collection('stock').doc(stock._id).update({
    data: {
      specification: stock.spec,  // é‡å‘½åå­—æ®µ
      specInfo: specInfo,
      pricePerMin: stock.price ? stock.price / specInfo.conversionRate : 0
    }
  })
}

// 2.2 åˆ›å»ºè¯åº“åº“å­˜ï¼ˆä»ç°æœ‰åº“å­˜æ±‡æ€»ï¼‰
// æ ¹æ®å®é™…æƒ…å†µå†³å®šè¯åº“åˆå§‹åº“å­˜

// 3. æ›´æ–° drugs è¡¨
const drugs = await db.collection('drugs').get()
for (const drug of drugs.data) {
  const specInfo = UnitConverter.parseSpecification(drug.spec)
  
  await db.collection('drugs').doc(drug._id).update({
    data: {
      specification: drug.spec,
      specInfo: specInfo
    }
  })
}

// 4. æ›´æ–°å†å²å‡ºåº“è®°å½•ï¼ˆå¯é€‰ï¼‰
// ä¸ºå†å²æ•°æ®æ·»åŠ è½¬æ¢ä¿¡æ¯ï¼ˆç”¨äºå®¡è®¡ï¼‰
```

---

## âœ… ä¼˜åŠ¿æ€»ç»“

### åŒè½¨åˆ¶å­˜å‚¨ä¼˜åŠ¿

```
âœ… ç¬¦åˆå®é™…ä¸šåŠ¡
   - è¯åº“ä»“å‚¨ä¹ æƒ¯ï¼ˆæ•´ç®±æ•´ç›’ï¼‰
   - å›­åŒºè¯Šç–—ç²¾åº¦ï¼ˆç²¾ç¡®åˆ°ç²’ï¼‰

âœ… æé«˜æ€§èƒ½
   - é—¨è¯Šæ¶ˆè€—æ— éœ€è½¬æ¢ï¼ˆç›´æ¥æ‰£å‡ï¼‰
   - å‡å°‘è®¡ç®—å¤æ‚åº¦

âœ… æ•°æ®ç²¾ç¡®
   - é¿å…åå¤è½¬æ¢çš„ç²¾åº¦æŸå¤±
   - å®¡è®¡è¿½è¸ªå®Œæ•´

âœ… æ˜“äºç»Ÿè®¡
   - å›­åŒºæ¶ˆè€—ç›´æ¥æ±‡æ€»
   - è¯åº“é‡‡è´­ç›´æ¥ç»Ÿè®¡
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v3.14  
**æœ€åæ›´æ–°**: 2025-11-06  
**æ ¸å¿ƒåˆ›æ–°**: åŒè½¨åˆ¶å­˜å‚¨ + å•ç‚¹è½¬æ¢ + æ™ºèƒ½æ˜¾ç¤º







