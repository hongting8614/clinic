# æƒé™å®ç°ç¤ºä¾‹ä»£ç 

## ğŸ“± å°ç¨‹åºç«¯å®ç°

### 1. App.js - åº”ç”¨å¯åŠ¨æ—¶ç™»å½•

```javascript
// App.js
import { login } from './utils/auth.js'

App({
  async onLaunch() {
    // åˆå§‹åŒ–äº‘å¼€å‘
    wx.cloud.init({
      env: 'your-env-id',
      traceUser: true
    })
    
    // è‡ªåŠ¨ç™»å½•
    const loginResult = await login()
    
    if (!loginResult.success) {
      // ä¸åœ¨ç™½åå•ï¼Œè·³è½¬åˆ°æç¤ºé¡µ
      wx.showModal({
        title: 'è®¿é—®å—é™',
        content: loginResult.message || 'æ‚¨ä¸åœ¨ç³»ç»Ÿç™½åå•å†…ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
        showCancel: false,
        success: () => {
          // å¯ä»¥è·³è½¬åˆ°ä¸€ä¸ªè¯´æ˜é¡µé¢
          wx.reLaunch({
            url: '/pages/unauthorized/index'
          })
        }
      })
    } else {
      console.log('ç™»å½•æˆåŠŸ:', loginResult.userInfo)
    }
  }
})
```

---

### 2. é¡µé¢çº§æƒé™æ§åˆ¶

#### æ–¹å¼ä¸€ï¼šåœ¨ onLoad ä¸­éªŒè¯

```javascript
// pages-sub/drug/add.vue
import { requirePermission } from '@/utils/auth.js'

export default {
  onLoad() {
    // æ£€æŸ¥æ˜¯å¦æœ‰åˆ›å»ºè¯å“çš„æƒé™
    const hasAuth = requirePermission('drug.create', {
      title: 'æƒé™ä¸è¶³',
      message: 'ä»…ç®¡ç†å‘˜å’Œè¯æˆ¿äººå‘˜å¯æ·»åŠ è¯å“',
      redirectTo: 'back'
    })
    
    if (!hasAuth) {
      return // æ— æƒé™ä¼šè‡ªåŠ¨è·³è½¬
    }
    
    // æœ‰æƒé™ï¼Œç»§ç»­åŠ è½½é¡µé¢
    this.loadData()
  },
  
  methods: {
    loadData() {
      // åŠ è½½é¡µé¢æ•°æ®
    }
  }
}
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨æ··å…¥ï¼ˆæ¨èï¼‰

```javascript
// pages-sub/drug/add.vue
import { authMixin } from '@/utils/auth.js'

export default {
  mixins: [authMixin],
  
  onLoad() {
    // ä½¿ç”¨æ··å…¥æä¾›çš„æ–¹æ³•æ£€æŸ¥æƒé™
    if (!this.requirePermission('drug.create', 'ä»…ç®¡ç†å‘˜å’Œè¯æˆ¿äººå‘˜å¯æ·»åŠ è¯å“')) {
      return
    }
    
    this.loadData()
  },
  
  methods: {
    loadData() {
      // å¯ä»¥ä½¿ç”¨æ··å…¥æä¾›çš„ this.userInfoã€this.isAdmin ç­‰å±æ€§
      console.log('å½“å‰ç”¨æˆ·:', this.userInfo.name)
      console.log('æ˜¯å¦ç®¡ç†å‘˜:', this.isAdmin)
    }
  }
}
```

---

### 3. æŒ‰é’®çº§æƒé™æ§åˆ¶

```vue
<template>
  <view class="page">
    <!-- ä»…ç®¡ç†å‘˜å¯è§çš„æŒ‰é’® -->
    <button v-if="isAdmin" @click="deleteUser">åˆ é™¤ç”¨æˆ·</button>
    
    <!-- ç®¡ç†å‘˜å’Œè¯æˆ¿äººå‘˜å¯è§ -->
    <button v-if="canOperate" @click="createRecord">æ–°å»ºå•æ®</button>
    
    <!-- æ‰€æœ‰äººå¯è§ -->
    <button @click="viewStock">æŸ¥çœ‹åº“å­˜</button>
    
    <!-- æ ¹æ®å…·ä½“æƒé™åˆ¤æ–­ -->
    <button v-if="hasPermission('drug.import')" @click="importDrugs">
      æ‰¹é‡å¯¼å…¥
    </button>
  </view>
</template>

<script>
import { authMixin } from '@/utils/auth.js'

export default {
  mixins: [authMixin],
  
  methods: {
    deleteUser() {
      // åˆ é™¤ç”¨æˆ·é€»è¾‘
    },
    
    createRecord() {
      // åˆ›å»ºå•æ®é€»è¾‘
    },
    
    viewStock() {
      // æŸ¥çœ‹åº“å­˜é€»è¾‘
    },
    
    importDrugs() {
      // å¯¼å…¥è¯å“é€»è¾‘
    }
  }
}
</script>
```

---

### 4. èœå•æƒé™æ§åˆ¶

```javascript
// pages/user/index.vue - æˆ‘çš„é¡µé¢
import { authMixin } from '@/utils/auth.js'

export default {
  mixins: [authMixin],
  
  data() {
    return {
      menuList: []
    }
  },
  
  onLoad() {
    this.buildMenuList()
  },
  
  methods: {
    buildMenuList() {
      const allMenus = [
        {
          title: 'æŠ¥è¡¨ä¸­å¿ƒ',
          icon: 'chart',
          url: '/pages-sub/report/index',
          permission: 'report.read'
        },
        {
          title: 'ç”¨æˆ·ç®¡ç†',
          icon: 'account',
          url: '/pages-sub/setting/user',
          permission: 'user.list'
        },
        {
          title: 'ç³»ç»Ÿè®¾ç½®',
          icon: 'setting',
          url: '/pages-sub/setting/index',
          permission: 'system.config'
        },
        {
          title: 'æ•°æ®å¤‡ä»½',
          icon: 'download',
          url: '/pages-sub/setting/backup',
          permission: 'system.backup'
        }
      ]
      
      // æ ¹æ®æƒé™è¿‡æ»¤èœå•
      this.menuList = allMenus.filter(menu => 
        this.hasPermission(menu.permission)
      )
    },
    
    navigateTo(url) {
      wx.navigateTo({ url })
    }
  }
}
```

---

### 5. ç”¨æˆ·ç®¡ç†é¡µé¢ï¼ˆç®¡ç†å‘˜ä¸“å±ï¼‰

```vue
<template>
  <view class="user-management">
    <!-- æ·»åŠ ç”¨æˆ·è¡¨å• -->
    <view class="add-user-form">
      <input v-model="form.openid" placeholder="ç”¨æˆ·OpenID" />
      <input v-model="form.name" placeholder="å§“å" />
      <input v-model="form.phone" placeholder="æ‰‹æœºå·" />
      
      <picker 
        :range="roleOptions" 
        :range-key="'text'"
        @change="onRoleChange"
      >
        <view>è§’è‰²ï¼š{{ selectedRoleText }}</view>
      </picker>
      
      <button @click="addUser">æ·»åŠ ç”¨æˆ·</button>
    </view>
    
    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <view class="user-list">
      <view 
        v-for="user in userList" 
        :key="user._id"
        class="user-item"
      >
        <text>{{ user.name }}</text>
        <text>{{ user.roleText }}</text>
        <button @click="editUser(user)">ç¼–è¾‘</button>
        <button @click="deleteUser(user)">åˆ é™¤</button>
      </view>
    </view>
  </view>
</template>

<script>
import { authMixin } from '@/utils/auth.js'

export default {
  mixins: [authMixin],
  
  data() {
    return {
      form: {
        openid: '',
        name: '',
        phone: '',
        role: 'viewer'
      },
      roleOptions: [
        { value: 'admin', text: 'ç®¡ç†å‘˜' },
        { value: 'pharmacy', text: 'è¯æˆ¿äººå‘˜' },
        { value: 'viewer', text: 'æŸ¥çœ‹è€…' }
      ],
      selectedRoleText: 'æŸ¥çœ‹è€…',
      userList: []
    }
  },
  
  onLoad() {
    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    if (!this.requirePermission('user.list', 'ä»…ç®¡ç†å‘˜å¯è®¿é—®ç”¨æˆ·ç®¡ç†')) {
      return
    }
    
    this.loadUserList()
  },
  
  methods: {
    onRoleChange(e) {
      const index = e.detail.value
      this.form.role = this.roleOptions[index].value
      this.selectedRoleText = this.roleOptions[index].text
    },
    
    async addUser() {
      // éªŒè¯è¡¨å•
      if (!this.form.openid || !this.form.name || !this.form.phone) {
        uni.showToast({
          title: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯',
          icon: 'none'
        })
        return
      }
      
      // è°ƒç”¨äº‘å‡½æ•°æ·»åŠ ç”¨æˆ·
      uni.showLoading({ title: 'æ·»åŠ ä¸­...' })
      
      try {
        const res = await wx.cloud.callFunction({
          name: 'addUser',
          data: this.form
        })
        
        uni.hideLoading()
        
        if (res.result.code === 0) {
          uni.showToast({
            title: 'æ·»åŠ æˆåŠŸ',
            icon: 'success'
          })
          
          // æ¸…ç©ºè¡¨å•
          this.form = {
            openid: '',
            name: '',
            phone: '',
            role: 'viewer'
          }
          
          // åˆ·æ–°åˆ—è¡¨
          this.loadUserList()
        } else {
          uni.showToast({
            title: res.result.message,
            icon: 'none'
          })
        }
      } catch (err) {
        uni.hideLoading()
        uni.showToast({
          title: 'æ·»åŠ å¤±è´¥',
          icon: 'none'
        })
      }
    },
    
    async loadUserList() {
      // è°ƒç”¨äº‘å‡½æ•°è·å–ç”¨æˆ·åˆ—è¡¨
      try {
        const res = await wx.cloud.callFunction({
          name: 'getUserList',
          data: {}
        })
        
        if (res.result.code === 0) {
          this.userList = res.result.data
        }
      } catch (err) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err)
      }
    },
    
    editUser(user) {
      // ç¼–è¾‘ç”¨æˆ·
    },
    
    deleteUser(user) {
      // åˆ é™¤ç”¨æˆ·
      uni.showModal({
        title: 'ç¡®è®¤åˆ é™¤',
        content: `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${user.name} å—ï¼Ÿ`,
        success: async (res) => {
          if (res.confirm) {
            // è°ƒç”¨åˆ é™¤äº‘å‡½æ•°
          }
        }
      })
    }
  }
}
</script>
```

---

## â˜ï¸ äº‘å‡½æ•°å®ç°

### 6. getUserList äº‘å‡½æ•°

```javascript
// cloudfunctions/getUserList/index.js
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  
  try {
    // éªŒè¯æƒé™ï¼šä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
    const adminRes = await db.collection('users')
      .where({
        openid: wxContext.OPENID,
        role: 'admin',
        status: 'active'
      })
      .get()
    
    if (adminRes.data.length === 0) {
      return {
        code: 403,
        message: 'æƒé™ä¸è¶³ï¼Œä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨'
      }
    }
    
    // è·å–æ‰€æœ‰ç”¨æˆ·
    const userRes = await db.collection('users')
      .orderBy('createTime', 'desc')
      .get()
    
    // å¤„ç†æ•°æ®
    const users = userRes.data.map(user => ({
      _id: user._id,
      openid: user.openid,
      name: user.name,
      nickname: user.nickname,
      phone: user.phone,
      role: user.role,
      roleText: getRoleText(user.role),
      status: user.status,
      statusText: user.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨',
      createTime: user.createTime,
      lastLogin: user.lastLogin
    }))
    
    return {
      code: 0,
      message: 'è·å–æˆåŠŸ',
      data: users
    }
  } catch (err) {
    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', err)
    return {
      code: -1,
      message: 'è·å–å¤±è´¥',
      error: err.message
    }
  }
}

function getRoleText(role) {
  const roleMap = {
    'admin': 'ç®¡ç†å‘˜',
    'pharmacy': 'è¯æˆ¿äººå‘˜',
    'viewer': 'æŸ¥çœ‹è€…'
  }
  return roleMap[role] || 'æœªçŸ¥è§’è‰²'
}
```

---

### 7. å…¶ä»–äº‘å‡½æ•°ä¸­æ·»åŠ æƒé™éªŒè¯

```javascript
// ç¤ºä¾‹ï¼šcloudfunctions/deleteDrug/index.js
const cloud = require('wx-server-sdk')
const { checkPermissionInCloud } = require('./utils/permission')

cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { drugId } = event
  
  // éªŒè¯æƒé™ï¼šä»…ç®¡ç†å‘˜å¯åˆ é™¤è¯å“
  const permission = await checkPermissionInCloud(
    wxContext.OPENID, 
    'drug.delete'
  )
  
  if (!permission.authorized) {
    return {
      code: 403,
      message: permission.message
    }
  }
  
  // æ‰§è¡Œåˆ é™¤
  try {
    await db.collection('drugs').doc(drugId).remove()
    
    // è®°å½•æ“ä½œæ—¥å¿—
    await db.collection('operation_logs').add({
      data: {
        operator: wxContext.OPENID,
        operatorName: permission.user.name,
        action: 'delete_drug',
        target: drugId,
        timestamp: db.serverDate()
      }
    })
    
    return {
      code: 0,
      message: 'åˆ é™¤æˆåŠŸ'
    }
  } catch (err) {
    return {
      code: -1,
      message: 'åˆ é™¤å¤±è´¥',
      error: err.message
    }
  }
}
```

---

## ğŸ“ ä½¿ç”¨æ€»ç»“

### åœ¨é¡µé¢ä¸­ä½¿ç”¨æƒé™æ§åˆ¶çš„æ­¥éª¤ï¼š

1. **å¯¼å…¥æƒé™æ··å…¥**
```javascript
import { authMixin } from '@/utils/auth.js'
```

2. **ä½¿ç”¨æ··å…¥**
```javascript
export default {
  mixins: [authMixin]
}
```

3. **åœ¨ onLoad ä¸­æ£€æŸ¥é¡µé¢æƒé™**
```javascript
onLoad() {
  if (!this.requirePermission('drug.create')) {
    return
  }
  // ç»§ç»­åŠ è½½
}
```

4. **åœ¨æ¨¡æ¿ä¸­æ§åˆ¶æŒ‰é’®æ˜¾ç¤º**
```vue
<button v-if="isAdmin">ç®¡ç†å‘˜æŒ‰é’®</button>
<button v-if="canOperate">æ“ä½œæŒ‰é’®</button>
<button v-if="hasPermission('drug.delete')">åˆ é™¤</button>
```

5. **åœ¨æ–¹æ³•ä¸­äºŒæ¬¡éªŒè¯**
```javascript
async deleteDrug() {
  if (!this.hasPermission('drug.delete')) {
    uni.showToast({ title: 'æƒé™ä¸è¶³', icon: 'none' })
    return
  }
  // æ‰§è¡Œåˆ é™¤
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-27





























