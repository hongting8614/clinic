# 🧪 权限控制测试指南

## 📋 测试目标

验证系统的权限控制是否按照设计正确实现。

---

## 🎯 测试角色和权限

### 权限对照表

| 角色 | 创建入库单 | 复核入库单 | 查看入库单 |
|------|-----------|-----------|-----------|
| **管理员** | ✅ | ✅ | ✅ |
| **项目经理** | ❌ | ✅ | ✅ |
| **医生** | ✅ | ❌ | ✅ |
| **药房人员** | ✅ | ❌ | ✅ |
| **查看者** | ❌ | ❌ | ✅ |

---

## 🧪 测试用例

### 测试1：管理员权限（全部权限）

**测试账号：** 管理员账户

**期望行为：**
- ✅ 首页显示"新建入库单"按钮
- ✅ 可以进入新建入库单页面
- ✅ 可以创建入库单并签名
- ✅ 可以看到"待复核"列表
- ✅ 可以进入复核页面
- ✅ 可以通过/驳回入库单

**测试步骤：**
1. 使用管理员账户登录
2. 查看首页，确认显示"新建入库单"按钮
3. 点击"新建入库单"，创建一个入库单
4. 签名并提交
5. 切换到其他账户（或等待其他人创建）
6. 进入"待复核"页面
7. 选择一个待复核的入库单
8. 点击"通过"或"驳回"

**验证点：**
```javascript
// 在控制台查看权限
const userInfo = uni.getStorageSync('userInfo')
console.log('角色:', userInfo.role)  // 应该是 'admin'
console.log('可创建:', hasPermission(userInfo.role, 'in.create'))  // true
console.log('可复核:', canReview(userInfo.role))  // true
```

---

### 测试2：项目经理权限（只能复核）

**测试账号：** 项目经理账户（杨经理）

**期望行为：**
- ❌ 首页**不显示**"新建入库单"按钮
- ❌ 入库管理页面**不显示**"新增"按钮
- ✅ 可以看到"待复核"列表
- ✅ 可以进入复核页面
- ✅ 可以通过/驳回入库单
- ✅ 可以查看所有入库单

**测试步骤：**
1. 使用项目经理账户登录
2. 查看首页，确认**没有**"新建入库单"按钮
3. 进入"入库管理"页面，确认**没有**"新增"按钮
4. 进入"待复核"页面
5. 选择一个待复核的入库单
6. 确认有"通过"和"驳回"按钮
7. 进行复核操作

**验证点：**
```javascript
// 在控制台查看权限
const userInfo = uni.getStorageSync('userInfo')
console.log('角色:', userInfo.role)  // 应该是 'project_manager'
console.log('可创建:', hasPermission(userInfo.role, 'in.create'))  // false
console.log('可复核:', canReview(userInfo.role))  // true
```

**关键测试：**
- 尝试直接访问 `/pages-sub/in/add`（应该被拦截或提示无权限）
- 首页应该没有"新建入库单"按钮

---

### 测试3：医生权限（只能创建）

**测试账号：** 医生账户

**期望行为：**
- ✅ 首页显示"新建入库单"按钮
- ✅ 可以进入新建入库单页面
- ✅ 可以创建入库单并签名
- ❌ 看**不到**"待复核"入口
- ❌ 进入详情页**没有**复核按钮
- ✅ 可以查看入库单

**测试步骤：**
1. 使用医生账户登录
2. 查看首页，确认显示"新建入库单"按钮
3. 点击"新建入库单"，创建一个入库单
4. 签名并提交
5. 确认**看不到**"待复核"入口
6. 进入入库单详情页
7. 确认**没有**"通过"和"驳回"按钮

**验证点：**
```javascript
// 在控制台查看权限
const userInfo = uni.getStorageSync('userInfo')
console.log('角色:', userInfo.role)  // 应该是 'doctor'
console.log('可创建:', hasPermission(userInfo.role, 'in.create'))  // true
console.log('可复核:', canReview(userInfo.role))  // false
```

**关键测试：**
- 首页应该显示"新建入库单"按钮
- 不应该看到"待复核"相关入口

---

### 测试4：药房人员权限（只能创建）

**测试账号：** 药房人员账户

**期望行为：**
- ✅ 首页显示"新建入库单"按钮
- ✅ 可以创建入库单并签名
- ❌ 看**不到**"待复核"入口
- ❌ 进入详情页**没有**复核按钮

**测试步骤：**
同医生权限测试

**验证点：**
```javascript
const userInfo = uni.getStorageSync('userInfo')
console.log('角色:', userInfo.role)  // 应该是 'pharmacy'
console.log('可创建:', hasPermission(userInfo.role, 'in.create'))  // true
console.log('可复核:', canReview(userInfo.role))  // false
```

---

### 测试5：查看者权限（只能查看）

**测试账号：** 查看者账户

**期望行为：**
- ❌ 首页**不显示**"新建入库单"按钮
- ❌ 看**不到**"待复核"入口
- ✅ 可以查看入库单列表
- ✅ 可以查看入库单详情
- ❌ 详情页**没有**任何操作按钮

**测试步骤：**
1. 使用查看者账户登录
2. 查看首页，确认**没有**"新建入库单"按钮
3. 进入"入库管理"页面
4. 可以查看入库单列表
5. 进入详情页，确认没有任何操作按钮

**验证点：**
```javascript
const userInfo = uni.getStorageSync('userInfo')
console.log('角色:', userInfo.role)  // 应该是 'viewer'
console.log('可创建:', hasPermission(userInfo.role, 'in.create'))  // false
console.log('可复核:', canReview(userInfo.role))  // false
```

---

## 🔍 权限检查方法

### 方法1：在控制台检查权限

```javascript
// 导入权限函数
import { hasPermission, canReview } from '@/utils/permission.js'

// 获取当前用户
const userInfo = uni.getStorageSync('userInfo')

// 检查权限
console.log('========== 权限检查 ==========')
console.log('用户:', userInfo.name)
console.log('角色:', userInfo.role)
console.log('可创建入库单:', hasPermission(userInfo.role, 'in.create'))
console.log('可复核入库单:', canReview(userInfo.role))
console.log('可查看入库单:', hasPermission(userInfo.role, 'in.read'))
console.log('================================')
```

### 方法2：在页面中检查

在任意页面的 `onLoad` 或 `onShow` 中添加：

```javascript
onLoad() {
  const userInfo = uni.getStorageSync('userInfo')
  console.log('当前用户角色:', userInfo?.role)
  console.log('页面权限:', {
    canCreate: hasPermission(userInfo?.role, 'in.create'),
    canReview: canReview(userInfo?.role)
  })
}
```

---

## 📋 测试检查清单

### 首页权限控制

- [ ] 管理员：显示"新建入库单"按钮
- [ ] 项目经理：**不显示**"新建入库单"按钮
- [ ] 医生：显示"新建入库单"按钮
- [ ] 药房：显示"新建入库单"按钮
- [ ] 查看者：**不显示**"新建入库单"按钮

### 入库管理页面

- [ ] 管理员：显示"新增"按钮
- [ ] 项目经理：**不显示**"新增"按钮
- [ ] 医生：显示"新增"按钮
- [ ] 药房：显示"新增"按钮
- [ ] 查看者：**不显示**"新增"按钮

### 待复核页面

- [ ] 管理员：可以看到"待复核"入口
- [ ] 项目经理：可以看到"待复核"入口
- [ ] 医生：**看不到**"待复核"入口
- [ ] 药房：**看不到**"待复核"入口
- [ ] 查看者：**看不到**"待复核"入口

### 入库详情页

- [ ] 管理员：显示"通过"和"驳回"按钮（待复核状态）
- [ ] 项目经理：显示"通过"和"驳回"按钮（待复核状态）
- [ ] 医生：**不显示**复核按钮
- [ ] 药房：**不显示**复核按钮
- [ ] 查看者：**不显示**复核按钮

---

## 🐛 常见问题排查

### 问题1：权限检查不生效

**原因：** 用户信息未正确加载

**解决：**
```javascript
// 检查用户信息
const userInfo = uni.getStorageSync('userInfo')
console.log('用户信息:', userInfo)

// 如果为空，需要重新登录
if (!userInfo) {
  uni.navigateTo({ url: '/pages/login/index' })
}
```

### 问题2：按钮仍然显示

**原因：** 页面未刷新或缓存问题

**解决：**
1. 重新编译小程序
2. 清除缓存：工具 → 清除缓存 → 清除所有缓存
3. 重新登录

### 问题3：权限判断错误

**原因：** 权限配置文件未更新

**解决：**
1. 确认 `utils/permission.js` 已更新
2. 重新编译小程序
3. 检查云函数是否已上传

---

## ✅ 测试通过标准

### 全部测试通过的标志：

1. ✅ 每个角色的权限都符合设计
2. ✅ 不应该看到的按钮确实不显示
3. ✅ 应该看到的功能都正常工作
4. ✅ 控制台没有权限相关错误
5. ✅ 职责分离：项目经理不能创建，医生不能复核

---

## 📝 测试记录模板

```
测试日期：2025年11月10日
测试人员：[姓名]

| 测试项 | 角色 | 期望结果 | 实际结果 | 通过 |
|--------|------|---------|---------|------|
| 首页-新建入库单按钮 | 管理员 | 显示 | 显示 | ✅ |
| 首页-新建入库单按钮 | 项目经理 | 不显示 | 不显示 | ✅ |
| 首页-新建入库单按钮 | 医生 | 显示 | 显示 | ✅ |
| 待复核入口 | 项目经理 | 显示 | 显示 | ✅ |
| 待复核入口 | 医生 | 不显示 | 不显示 | ✅ |
| 复核按钮 | 项目经理 | 显示 | 显示 | ✅ |
| 复核按钮 | 医生 | 不显示 | 不显示 | ✅ |

总结：[全部通过/部分通过/未通过]
问题：[列出发现的问题]
```

---

**最后更新：** 2025年11月10日  
**状态：** 待测试

