# æƒé™è®¾è®¡æ–¹æ¡ˆ

## ğŸ“Œ è§’è‰²å®šä¹‰

### 1. adminï¼ˆç®¡ç†å‘˜ï¼‰
**æƒé™çº§åˆ«**ï¼šæœ€é«˜  
**äººå‘˜å®šä½**ï¼šåŒ»åŠ¡å®¤ä¸»ä»»ã€ç³»ç»Ÿç®¡ç†å‘˜  
**æ ¸å¿ƒèŒè´£**ï¼šç³»ç»Ÿç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€æ•°æ®å®¡æ ¸

### 2. pharmacyï¼ˆè¯æˆ¿äººå‘˜ï¼‰
**æƒé™çº§åˆ«**ï¼šä¸­ç­‰  
**äººå‘˜å®šä½**ï¼šè¯æˆ¿å·¥ä½œäººå‘˜ã€è¯å¸ˆ  
**æ ¸å¿ƒèŒè´£**ï¼šæ—¥å¸¸å‡ºå…¥åº“æ“ä½œã€è¯æç®¡ç†

### 3. viewerï¼ˆæŸ¥çœ‹è€…ï¼‰
**æƒé™çº§åˆ«**ï¼šæœ€ä½  
**äººå‘˜å®šä½**ï¼šç›¸å…³éƒ¨é—¨äººå‘˜ã€è´¢åŠ¡äººå‘˜  
**æ ¸å¿ƒèŒè´£**ï¼šæŸ¥è¯¢åº“å­˜ã€æŸ¥çœ‹æŠ¥è¡¨

---

## ğŸ” æƒé™çŸ©é˜µ

### åŠŸèƒ½æƒé™å¯¹ç…§è¡¨

| åŠŸèƒ½æ¨¡å— | admin | pharmacy | viewer | è¯´æ˜ |
|---------|-------|----------|--------|------|
| **ç”¨æˆ·ç®¡ç†** |
| æ·»åŠ ç”¨æˆ· | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯æ·»åŠ  |
| ç¼–è¾‘ç”¨æˆ· | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯ç¼–è¾‘ |
| åˆ é™¤ç”¨æˆ· | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯åˆ é™¤ |
| æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹ |
| **è¯ææ¡£æ¡ˆ** |
| æ·»åŠ è¯æ | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ·»åŠ  |
| ç¼–è¾‘è¯æ | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯ç¼–è¾‘ |
| åˆ é™¤è¯æ | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯åˆ é™¤ |
| æŸ¥çœ‹è¯æ | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| æ‰¹é‡å¯¼å…¥è¯æ | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯å¯¼å…¥ |
| **å…¥åº“ç®¡ç†** |
| æ–°å»ºå…¥åº“å• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| æ“ä½œå‘˜ç­¾å | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯ç­¾å |
| å¤æ ¸å‘˜ç­¾å | âœ… | âœ… | âŒ | éœ€å¤æ ¸æƒé™ |
| é©³å›å…¥åº“å• | âœ… | âœ… | âŒ | å¤æ ¸äººå‘˜å¯é©³å› |
| æŸ¥çœ‹å…¥åº“å• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| åˆ é™¤è‰ç¨¿ | âœ… | âœ… | âŒ | åˆ›å»ºäººå¯åˆ é™¤ |
| **å‡ºåº“ç®¡ç†** |
| æ–°å»ºå‡ºåº“å• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| å‘æ”¾äººç­¾å | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯ç­¾å |
| æ¥æ”¶äººç­¾å | âœ… | âœ… | âŒ | æ¥æ”¶äººå¯ç­¾å |
| æŸ¥çœ‹å‡ºåº“å• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **å›­åŒºè°ƒæ‹¨** |
| æ–°å»ºè°ƒæ‹¨å• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| è°ƒæ‹¨ç­¾å | âœ… | âœ… | âŒ | åŒæ–¹äººå‘˜ç­¾å |
| æŸ¥çœ‹è°ƒæ‹¨å• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **è¯æˆ¿æ—¥æ¶ˆè€—** |
| æ–°å»ºæ¶ˆè€—è®°å½• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| ç¼–è¾‘æ¶ˆè€—è®°å½• | âœ… | âœ… | âŒ | å½“å¤©å¯ä¿®æ”¹ |
| åˆ é™¤æ¶ˆè€—è®°å½• | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯åˆ é™¤ |
| æŸ¥çœ‹æ¶ˆè€—è®°å½• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **éƒ¨é—¨è¯·é¢†** |
| æ–°å»ºè¯·é¢†å• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| è¯·é¢†ç­¾å | âœ… | âœ… | âŒ | åŒæ–¹äººå‘˜ç­¾å |
| æŸ¥çœ‹è¯·é¢†å• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **åº“å­˜ç›˜ç‚¹** |
| æ–°å»ºç›˜ç‚¹å• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| ç›˜ç‚¹ç­¾å | âœ… | âœ… | âŒ | åŒæ–¹äººå‘˜ç­¾å |
| ä¿®æ”¹ç›˜ç‚¹å·®å¼‚ | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯ä¿®æ”¹ |
| æŸ¥çœ‹ç›˜ç‚¹å• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **è¯ææŠ¥æŸ** |
| æ–°å»ºæŠ¥æŸå• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| æŠ¥æŸç­¾å | âœ… | âœ… | âŒ | æŠ¥æŸäººç­¾å |
| æŸ¥çœ‹æŠ¥æŸå• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **è¯æé€€è´§** |
| æ–°å»ºé€€è´§å• | âœ… | âœ… | âŒ | è¯æˆ¿äººå‘˜å¯æ“ä½œ |
| é€€è´§ç­¾å | âœ… | âœ… | âŒ | åŒæ–¹äººå‘˜ç­¾å |
| æŸ¥çœ‹é€€è´§å• | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **åº“å­˜æŸ¥è¯¢** |
| æŸ¥çœ‹åº“å­˜æ€»è§ˆ | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| æŸ¥çœ‹æ‰¹æ¬¡æ˜ç»† | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| æŸ¥çœ‹åº“å­˜æµæ°´ | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| **åº“å­˜é¢„è­¦** |
| æŸ¥çœ‹é¢„è­¦ä¿¡æ¯ | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| é…ç½®é¢„è­¦å‚æ•° | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯é…ç½® |
| **æŠ¥è¡¨ç»Ÿè®¡** |
| æŸ¥çœ‹æ‰€æœ‰æŠ¥è¡¨ | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯æŸ¥çœ‹ |
| å¯¼å‡ºPDF | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯å¯¼å‡º |
| å¯¼å‡ºExcel | âœ… | âœ… | âœ… | æ‰€æœ‰äººå¯å¯¼å‡º |
| **ç³»ç»Ÿè®¾ç½®** |
| éƒ¨é—¨ç®¡ç† | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯ç®¡ç† |
| å›­åŒºç®¡ç† | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯ç®¡ç† |
| ç³»ç»Ÿå‚æ•°é…ç½® | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯é…ç½® |
| æ•°æ®å¤‡ä»½/å¯¼å…¥ | âœ… | âŒ | âŒ | ä»…ç®¡ç†å‘˜å¯æ“ä½œ |

---

## ğŸ¯ æƒé™æ§åˆ¶ç­–ç•¥

### 1. å‰ç«¯æƒé™æ§åˆ¶

#### é¡µé¢çº§æ§åˆ¶
```javascript
// åœ¨é¡µé¢ onLoad æ—¶æ£€æŸ¥æƒé™
onLoad() {
  const userRole = wx.getStorageSync('userRole')
  
  // ç®¡ç†å‘˜ä¸“å±é¡µé¢
  if (['user-management', 'system-config'].includes(this.pageName)) {
    if (userRole !== 'admin') {
      wx.showModal({
        title: 'æƒé™ä¸è¶³',
        content: 'ä»…ç®¡ç†å‘˜å¯è®¿é—®æ­¤åŠŸèƒ½',
        showCancel: false,
        success: () => wx.navigateBack()
      })
    }
  }
  
  // æ“ä½œäººå‘˜é¡µé¢ï¼ˆadmin + pharmacyï¼‰
  if (['drug-add', 'stock-in', 'stock-out'].includes(this.pageName)) {
    if (!['admin', 'pharmacy'].includes(userRole)) {
      wx.showModal({
        title: 'æƒé™ä¸è¶³',
        content: 'æ‚¨æ— æƒè¿›è¡Œæ­¤æ“ä½œ',
        showCancel: false,
        success: () => wx.navigateBack()
      })
    }
  }
}
```

#### åŠŸèƒ½æŒ‰é’®æ§åˆ¶
```vue
<template>
  <!-- ä»…ç®¡ç†å‘˜å¯è§ -->
  <button v-if="isAdmin" @click="deleteUser">åˆ é™¤ç”¨æˆ·</button>
  
  <!-- ç®¡ç†å‘˜å’Œè¯æˆ¿äººå‘˜å¯è§ -->
  <button v-if="canOperate" @click="createInRecord">æ–°å»ºå…¥åº“</button>
  
  <!-- æ‰€æœ‰äººå¯è§ -->
  <button @click="viewStock">æŸ¥çœ‹åº“å­˜</button>
</template>

<script>
export default {
  computed: {
    userRole() {
      return uni.getStorageSync('userRole')
    },
    isAdmin() {
      return this.userRole === 'admin'
    },
    canOperate() {
      return ['admin', 'pharmacy'].includes(this.userRole)
    }
  }
}
</script>
```

---

### 2. åç«¯æƒé™æ§åˆ¶ï¼ˆäº‘å‡½æ•°ï¼‰

#### æƒé™éªŒè¯ä¸­é—´ä»¶
```javascript
// utils/permission.js
const db = cloud.database()

/**
 * éªŒè¯ç”¨æˆ·æƒé™
 * @param {string} openid - ç”¨æˆ·openid
 * @param {string|array} requiredRole - æ‰€éœ€è§’è‰²ï¼ˆå•ä¸ªæˆ–æ•°ç»„ï¼‰
 */
async function checkPermission(openid, requiredRole) {
  const user = await db.collection('users')
    .where({ openid, status: 'active' })
    .get()
  
  if (user.data.length === 0) {
    return { authorized: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«ç¦ç”¨' }
  }
  
  const userRole = user.data[0].role
  const roles = Array.isArray(requiredRole) ? requiredRole : [requiredRole]
  
  if (!roles.includes(userRole)) {
    return { authorized: false, message: 'æƒé™ä¸è¶³' }
  }
  
  return { authorized: true, user: user.data[0] }
}

module.exports = { checkPermission }
```

#### åœ¨äº‘å‡½æ•°ä¸­ä½¿ç”¨
```javascript
// cloudfunctions/deleteUser/index.js
const cloud = require('wx-server-sdk')
const { checkPermission } = require('./utils/permission')

cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { userId } = event
  
  // éªŒè¯æƒé™ï¼šä»…ç®¡ç†å‘˜å¯åˆ é™¤ç”¨æˆ·
  const permission = await checkPermission(wxContext.OPENID, 'admin')
  if (!permission.authorized) {
    return { code: 403, message: permission.message }
  }
  
  // æ‰§è¡Œåˆ é™¤æ“ä½œ
  try {
    await db.collection('users').doc(userId).remove()
    return { code: 0, message: 'ç”¨æˆ·åˆ é™¤æˆåŠŸ' }
  } catch (err) {
    return { code: -1, message: err.message }
  }
}
```

---

## ğŸ”§ å®ç°æ­¥éª¤

### é˜¶æ®µ1ï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆ1å¤©ï¼‰

1. **æ›´æ–° users è¡¨å­—æ®µ**
```javascript
// è¿ç§»è„šæœ¬ï¼šä¸ºç°æœ‰ç”¨æˆ·æ·»åŠ  nickname å’Œ lastLogin å­—æ®µ
db.collection('users').get().then(res => {
  res.data.forEach(user => {
    db.collection('users').doc(user._id).update({
      data: {
        nickname: user.name, // é»˜è®¤æ˜µç§°ä¸ºå§“å
        lastLogin: new Date(),
        role: 'admin' // é»˜è®¤ç°æœ‰ç”¨æˆ·ä¸ºç®¡ç†å‘˜
      }
    })
  })
})
```

2. **åˆ›å»ºæƒé™é…ç½®è¡¨ï¼ˆå¯é€‰ï¼‰**
```javascript
// permissions è¡¨ï¼ˆç”¨äºåŠ¨æ€é…ç½®æƒé™ï¼‰
{
  _id: "perm_001",
  module: "user_management",    // æ¨¡å—æ ‡è¯†
  action: "create",             // æ“ä½œï¼šcreate/read/update/delete
  roles: ["admin"],             // å…è®¸çš„è§’è‰²
  description: "æ·»åŠ ç”¨æˆ·"
}
```

---

### é˜¶æ®µ2ï¼šäº‘å‡½æ•°å¼€å‘ï¼ˆ2-3å¤©ï¼‰

1. **åˆ›å»º login äº‘å‡½æ•°**ï¼ˆç”¨æˆ·ç™»å½•ï¼‰
2. **åˆ›å»º addUser äº‘å‡½æ•°**ï¼ˆç®¡ç†å‘˜æ·»åŠ ç”¨æˆ·ï¼‰
3. **åˆ›å»º updateUser äº‘å‡½æ•°**ï¼ˆç®¡ç†å‘˜ç¼–è¾‘ç”¨æˆ·ï¼‰
4. **åˆ›å»º deleteUser äº‘å‡½æ•°**ï¼ˆç®¡ç†å‘˜åˆ é™¤ç”¨æˆ·ï¼‰
5. **åˆ›å»º getUserList äº‘å‡½æ•°**ï¼ˆè·å–ç”¨æˆ·åˆ—è¡¨ï¼‰
6. **å°è£…æƒé™éªŒè¯å·¥å…·å‡½æ•°**

---

### é˜¶æ®µ3ï¼šå‰ç«¯å®ç°ï¼ˆ3-4å¤©ï¼‰

1. **ç™»å½•æµç¨‹æ”¹é€ **
   - App.js å¯åŠ¨æ—¶è°ƒç”¨ login äº‘å‡½æ•°
   - éªŒè¯ç™½åå•
   - ä¿å­˜ç”¨æˆ·è§’è‰²åˆ°æœ¬åœ°å­˜å‚¨

2. **ç”¨æˆ·ç®¡ç†é¡µé¢**ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
   - ç”¨æˆ·åˆ—è¡¨
   - æ·»åŠ ç”¨æˆ·è¡¨å•
   - è§’è‰²é€‰æ‹©
   - çŠ¶æ€åˆ‡æ¢

3. **æƒé™æ§åˆ¶ç»„ä»¶**
   - å°è£…æƒé™åˆ¤æ–­æ–¹æ³•
   - é¡µé¢çº§æƒé™å®ˆå«
   - æŒ‰é’®çº§æƒé™æ˜¾ç¤º

4. **å„ä¸šåŠ¡é¡µé¢æ·»åŠ æƒé™æ§åˆ¶**
   - è¯æç®¡ç†
   - å‡ºå…¥åº“
   - ç›˜ç‚¹
   - æŠ¥è¡¨

---

### é˜¶æ®µ4ï¼šæµ‹è¯•ä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰

1. åˆ›å»ºæµ‹è¯•è´¦å·ï¼ˆ3ç§è§’è‰²å„1ä¸ªï¼‰
2. æµ‹è¯•å„è§’è‰²æƒé™æ˜¯å¦æ­£ç¡®
3. æµ‹è¯•éæ³•è¶Šæƒæ“ä½œ
4. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

---

## ğŸ“ é…ç½®å»ºè®®

### è§’è‰²æƒé™å¯é…ç½®åŒ–ï¼ˆè¿›é˜¶ï¼‰

å¦‚æœæœªæ¥è§’è‰²å¯èƒ½å¢åŠ æˆ–æƒé™éœ€è¦åŠ¨æ€è°ƒæ•´ï¼Œå»ºè®®ï¼š

1. **åˆ›å»º role_permissions é…ç½®è¡¨**
```javascript
{
  _id: "role_001",
  role: "pharmacy",
  permissions: [
    "drug.create",
    "drug.update",
    "drug.read",
    "stock_in.create",
    "stock_in.sign",
    "stock_out.create",
    "stock_out.sign",
    // ...æ›´å¤šæƒé™
  ]
}
```

2. **åŠ¨æ€æƒé™æ£€æŸ¥**
```javascript
async function hasPermission(userId, permission) {
  const user = await db.collection('users').doc(userId).get()
  const rolePerms = await db.collection('role_permissions')
    .where({ role: user.data.role })
    .get()
  
  return rolePerms.data[0].permissions.includes(permission)
}
```

---

## âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. é˜²æ­¢æƒé™ç»•è¿‡
- âœ… å‰ç«¯å’Œåç«¯éƒ½è¦éªŒè¯æƒé™ï¼ˆåŒé‡éªŒè¯ï¼‰
- âœ… ä¸è¦ä»…ä¾èµ–å‰ç«¯éšè—æŒ‰é’®
- âœ… äº‘å‡½æ•°å¿…é¡»éªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™

### 2. é˜²æ­¢æ¨ªå‘è¶Šæƒ
```javascript
// é”™è¯¯ç¤ºä¾‹ï¼šæœªéªŒè¯æ•°æ®æ‰€æœ‰æƒ
exports.main = async (event) => {
  const { recordId } = event
  await db.collection('records').doc(recordId).update(...)
}

// æ­£ç¡®ç¤ºä¾‹ï¼šéªŒè¯æ“ä½œäºº
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { recordId } = event
  
  const record = await db.collection('records').doc(recordId).get()
  if (record.data.operatorId !== wxContext.OPENID) {
    return { code: 403, message: 'æ— æƒä¿®æ”¹ä»–äººåˆ›å»ºçš„è®°å½•' }
  }
  
  await db.collection('records').doc(recordId).update(...)
}
```

### 3. æ•æ„Ÿæ“ä½œæ—¥å¿—
```javascript
// è®°å½•å…³é”®æ“ä½œ
await db.collection('operation_logs').add({
  data: {
    operator: wxContext.OPENID,
    action: 'delete_user',
    targetId: userId,
    ip: wxContext.CLIENTIP,
    timestamp: new Date()
  }
})
```

---

## ğŸš€ æœªæ¥æ‰©å±•

### 1. æ›´ç»†ç²’åº¦çš„æƒé™
- å›­åŒºçº§æƒé™ï¼ˆç”¨æˆ·åªèƒ½ç®¡ç†ç‰¹å®šå›­åŒºï¼‰
- æ•°æ®èŒƒå›´æƒé™ï¼ˆåªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„å•æ®ï¼‰

### 2. å®¡æ‰¹æµç¨‹
- é«˜å€¼è¯æå‡ºåº“éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹
- å¤§æ‰¹é‡å…¥åº“éœ€è¦äºŒçº§å®¡æ‰¹

### 3. æ“ä½œå®¡è®¡
- å®Œæ•´çš„æ“ä½œæ—¥å¿—
- æ•°æ®å˜æ›´è¿½æº¯
- å¼‚å¸¸è¡Œä¸ºç›‘æ§

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-27  
**ç»´æŠ¤è€…**ï¼šç³»ç»Ÿå¼€å‘å›¢é˜Ÿ





























