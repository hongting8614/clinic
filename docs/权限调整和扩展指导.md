# æƒé™è°ƒæ•´å’Œæ‰©å±•æŒ‡å¯¼

## ğŸ“‹ ç›®å½•

1. [è°ƒæ•´ç°æœ‰æƒé™](#è°ƒæ•´ç°æœ‰æƒé™)
2. [æ·»åŠ æ–°è§’è‰²](#æ·»åŠ æ–°è§’è‰²)
3. [æ·»åŠ æ–°æƒé™](#æ·»åŠ æ–°æƒé™)
4. [å›­åŒºçº§æƒé™](#å›­åŒºçº§æƒé™)
5. [æ•°æ®èŒƒå›´æƒé™](#æ•°æ®èŒƒå›´æƒé™)
6. [å®¡æ‰¹æµç¨‹](#å®¡æ‰¹æµç¨‹)

---

## ğŸ”§ è°ƒæ•´ç°æœ‰æƒé™

### åœºæ™¯1ï¼šä¿®æ”¹æŸä¸ªåŠŸèƒ½çš„æƒé™è¦æ±‚

**ç¤ºä¾‹**ï¼šå°†"åˆ é™¤è¯å“"æƒé™ä»"ä»…ç®¡ç†å‘˜"æ”¹ä¸º"ç®¡ç†å‘˜å’Œè¯æˆ¿ä¸»ä»»"

#### æ­¥éª¤1ï¼šä¿®æ”¹æƒé™é…ç½®

```javascript
// utils/permission.js

const PERMISSIONS = {
  // ... å…¶ä»–æƒé™
  
  // ä¿®æ”¹å‰ï¼š
  // 'drug.delete': [ROLES.ADMIN],
  
  // ä¿®æ”¹åï¼šæ·»åŠ è¯æˆ¿ä¸»ä»»è§’è‰²
  'drug.delete': [ROLES.ADMIN, ROLES.PHARMACY_MANAGER],
  
  // ... å…¶ä»–æƒé™
}
```

#### æ­¥éª¤2ï¼šæ›´æ–°å‰ç«¯UI

```vue
<!-- pages-sub/drug/list.vue -->
<template>
  <button 
    v-if="hasPermission('drug.delete')" 
    @click="deleteDrug"
  >
    åˆ é™¤è¯å“
  </button>
</template>
```

#### æ­¥éª¤3ï¼šæ›´æ–°äº‘å‡½æ•°éªŒè¯

```javascript
// cloudfunctions/deleteDrug/index.js
const { checkPermissionInCloud } = require('./utils/permission')

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  
  // éªŒè¯æƒé™
  const permission = await checkPermissionInCloud(
    wxContext.OPENID,
    'drug.delete'  // ä¼šè‡ªåŠ¨æ£€æŸ¥æœ€æ–°çš„æƒé™é…ç½®
  )
  
  if (!permission.authorized) {
    return { code: 403, message: permission.message }
  }
  
  // æ‰§è¡Œåˆ é™¤...
}
```

---

### åœºæ™¯2ï¼šæ”¾å¼€æŸä¸ªåªè¯»åŠŸèƒ½ç»™æ‰€æœ‰è§’è‰²

**ç¤ºä¾‹**ï¼šå…è®¸æ‰€æœ‰äººæŸ¥çœ‹æŠ¥è¡¨ï¼ˆåŸæœ¬å¯èƒ½åªæœ‰ç®¡ç†å‘˜å’Œè¯æˆ¿äººå‘˜ï¼‰

```javascript
// utils/permission.js

const PERMISSIONS = {
  // ä¿®æ”¹å‰ï¼š
  // 'report.read': [ROLES.ADMIN, ROLES.PHARMACY],
  
  // ä¿®æ”¹åï¼š
  'report.read': [ROLES.ADMIN, ROLES.PHARMACY, ROLES.VIEWER],
}
```

---

## ğŸ†• æ·»åŠ æ–°è§’è‰²

### ç¤ºä¾‹ï¼šæ·»åŠ "è¯æˆ¿ä¸»ä»»"è§’è‰²

#### æ­¥éª¤1ï¼šå®šä¹‰è§’è‰²å¸¸é‡

```javascript
// utils/permission.js

const ROLES = {
  ADMIN: 'admin',
  PHARMACY_MANAGER: 'pharmacy_manager',  // âœ… æ–°å¢
  PHARMACY: 'pharmacy',
  VIEWER: 'viewer'
}

const ROLE_TEXT = {
  [ROLES.ADMIN]: 'ç®¡ç†å‘˜',
  [ROLES.PHARMACY_MANAGER]: 'è¯æˆ¿ä¸»ä»»',  // âœ… æ–°å¢
  [ROLES.PHARMACY]: 'è¯æˆ¿äººå‘˜',
  [ROLES.VIEWER]: 'æŸ¥çœ‹è€…'
}

const ROLE_LEVEL = {
  [ROLES.VIEWER]: 1,
  [ROLES.PHARMACY]: 2,
  [ROLES.PHARMACY_MANAGER]: 3,  // âœ… æ–°å¢ï¼Œæƒé™é«˜äºè¯æˆ¿äººå‘˜
  [ROLES.ADMIN]: 4
}
```

#### æ­¥éª¤2ï¼šé…ç½®è§’è‰²æƒé™

```javascript
// utils/permission.js

const PERMISSIONS = {
  // è¯å“ç®¡ç†
  'drug.create': [ROLES.ADMIN, ROLES.PHARMACY_MANAGER, ROLES.PHARMACY],
  'drug.update': [ROLES.ADMIN, ROLES.PHARMACY_MANAGER, ROLES.PHARMACY],
  'drug.delete': [ROLES.ADMIN, ROLES.PHARMACY_MANAGER],  // åªæœ‰ä¸»ä»»å’Œç®¡ç†å‘˜å¯åˆ é™¤
  
  // ç›˜ç‚¹ç®¡ç†
  'inventory.create': [ROLES.ADMIN, ROLES.PHARMACY_MANAGER, ROLES.PHARMACY],
  'inventory.update': [ROLES.ADMIN, ROLES.PHARMACY_MANAGER],  // åªæœ‰ä¸»ä»»å¯ä¿®æ”¹å·®å¼‚
  
  // ... å…¶ä»–æƒé™
}
```

#### æ­¥éª¤3ï¼šæ›´æ–°ç”¨æˆ·ç®¡ç†é¡µé¢

```javascript
// pages-sub/setting/user-list.vue

data() {
  return {
    roleOptions: [
      { value: 'admin', text: 'ç®¡ç†å‘˜', desc: 'æ‹¥æœ‰å…¨éƒ¨æƒé™' },
      { 
        value: 'pharmacy_manager', 
        text: 'è¯æˆ¿ä¸»ä»»', 
        desc: 'ç®¡ç†è¯æˆ¿æ—¥å¸¸å·¥ä½œï¼Œå¯ä¿®æ”¹ç›˜ç‚¹å·®å¼‚'  // âœ… æ–°å¢
      },
      { value: 'pharmacy', text: 'è¯æˆ¿äººå‘˜', desc: 'å¯è¿›è¡Œæ—¥å¸¸å‡ºå…¥åº“æ“ä½œ' },
      { value: 'viewer', text: 'æŸ¥çœ‹è€…', desc: 'ä»…å¯æŸ¥çœ‹æ•°æ®' }
    ]
  }
}
```

#### æ­¥éª¤4ï¼šæ›´æ–°ç­›é€‰å™¨

```javascript
// pages-sub/setting/user-list.vue

data() {
  return {
    roleFilter: [
      { value: 'all', text: 'å…¨éƒ¨è§’è‰²' },
      { value: 'admin', text: 'ç®¡ç†å‘˜' },
      { value: 'pharmacy_manager', text: 'è¯æˆ¿ä¸»ä»»' },  // âœ… æ–°å¢
      { value: 'pharmacy', text: 'è¯æˆ¿äººå‘˜' },
      { value: 'viewer', text: 'æŸ¥çœ‹è€…' }
    ]
  }
}
```

#### æ­¥éª¤5ï¼šæµ‹è¯•æ–°è§’è‰²

1. æ·»åŠ ä¸€ä¸ªè¯æˆ¿ä¸»ä»»æµ‹è¯•è´¦å·
2. æµ‹è¯•å„é¡¹æƒé™æ˜¯å¦æ­£å¸¸
3. ç¡®è®¤UIæ˜¾ç¤ºæ­£ç¡®

---

## ğŸ¯ æ·»åŠ æ–°æƒé™

### ç¤ºä¾‹ï¼šæ·»åŠ "å¯¼å‡ºè´¢åŠ¡æŠ¥è¡¨"æƒé™

#### æ­¥éª¤1ï¼šå®šä¹‰æƒé™

```javascript
// utils/permission.js

const PERMISSIONS = {
  // ... å…¶ä»–æƒé™
  
  // æ–°å¢è´¢åŠ¡æŠ¥è¡¨æƒé™
  'report.finance': [ROLES.ADMIN],  // ä»…ç®¡ç†å‘˜å¯å¯¼å‡ºè´¢åŠ¡æŠ¥è¡¨
  'report.finance.view': [ROLES.ADMIN, ROLES.VIEWER],  // ç®¡ç†å‘˜å’ŒæŸ¥çœ‹è€…å¯æŸ¥çœ‹
}
```

#### æ­¥éª¤2ï¼šåœ¨é¡µé¢ä¸­ä½¿ç”¨

```vue
<!-- pages-sub/report/finance.vue -->
<template>
  <view class="finance-report">
    <!-- æŸ¥çœ‹æƒé™ -->
    <view v-if="hasPermission('report.finance.view')">
      <view>è´¢åŠ¡æŠ¥è¡¨å†…å®¹...</view>
    </view>
    
    <!-- å¯¼å‡ºæƒé™ -->
    <button 
      v-if="hasPermission('report.finance')" 
      @click="exportReport"
    >
      å¯¼å‡ºæŠ¥è¡¨
    </button>
  </view>
</template>

<script>
import { authMixin } from '@/utils/auth.js'

export default {
  mixins: [authMixin],
  
  onLoad() {
    // æ£€æŸ¥æŸ¥çœ‹æƒé™
    if (!this.requirePermission('report.finance.view')) {
      return
    }
    
    this.loadData()
  },
  
  methods: {
    exportReport() {
      // äºŒæ¬¡æ£€æŸ¥å¯¼å‡ºæƒé™
      if (!this.hasPermission('report.finance')) {
        uni.showToast({
          title: 'æ‚¨æ— æƒå¯¼å‡ºæ­¤æŠ¥è¡¨',
          icon: 'none'
        })
        return
      }
      
      // è°ƒç”¨äº‘å‡½æ•°å¯¼å‡º
      this.callExportFunction()
    }
  }
}
</script>
```

#### æ­¥éª¤3ï¼šåˆ›å»ºäº‘å‡½æ•°

```javascript
// cloudfunctions/exportFinanceReport/index.js
const cloud = require('wx-server-sdk')
const { checkPermissionInCloud } = require('./utils/permission')

cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  
  // éªŒè¯æƒé™
  const permission = await checkPermissionInCloud(
    wxContext.OPENID,
    'report.finance'
  )
  
  if (!permission.authorized) {
    return {
      code: 403,
      message: 'æ‚¨æ— æƒå¯¼å‡ºè´¢åŠ¡æŠ¥è¡¨'
    }
  }
  
  // æ‰§è¡Œå¯¼å‡ºé€»è¾‘...
  try {
    // ç”ŸæˆæŠ¥è¡¨
    const reportData = await generateFinanceReport()
    
    // è®°å½•æ“ä½œæ—¥å¿—
    await db.collection('operation_logs').add({
      data: {
        operator: wxContext.OPENID,
        operatorName: permission.user.name,
        action: 'export_finance_report',
        timestamp: db.serverDate()
      }
    })
    
    return {
      code: 0,
      message: 'å¯¼å‡ºæˆåŠŸ',
      data: reportData
    }
  } catch (err) {
    return {
      code: -1,
      message: 'å¯¼å‡ºå¤±è´¥',
      error: err.message
    }
  }
}
```

---

## ğŸ¢ å›­åŒºçº§æƒé™

### åœºæ™¯ï¼šç”¨æˆ·åªèƒ½ç®¡ç†ç‰¹å®šå›­åŒº

#### æ­¥éª¤1ï¼šæ‰©å±•ç”¨æˆ·è¡¨ç»“æ„

```javascript
// åœ¨æ•°æ®åº“ users è¡¨ä¸­æ·»åŠ å­—æ®µ
{
  _id: "user_001",
  openid: "oXXXX",
  name: "å¼ ä¸‰",
  role: "pharmacy",
  
  // âœ… æ–°å¢å›­åŒºæƒé™å­—æ®µ
  locations: ["land_park"],  // å¯ç®¡ç†çš„å›­åŒºåˆ—è¡¨
  // æˆ–è€…
  defaultLocation: "land_park",  // é»˜è®¤å›­åŒº
  
  // å¦‚æœä¸ºç©ºæˆ–åŒ…å« "all"ï¼Œè¡¨ç¤ºå¯ç®¡ç†æ‰€æœ‰å›­åŒº
  // locations: ["all"]
}
```

#### æ­¥éª¤2ï¼šåˆ›å»ºæƒé™éªŒè¯å‡½æ•°

```javascript
// utils/location-permission.js

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å›­åŒºæƒé™
 * @param {object} userInfo - ç”¨æˆ·ä¿¡æ¯
 * @param {string} location - å›­åŒºä»£ç 
 * @returns {boolean}
 */
export function hasLocationPermission(userInfo, location) {
  // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰å›­åŒºæƒé™
  if (userInfo.role === 'admin') {
    return true
  }
  
  // æ£€æŸ¥ç”¨æˆ·çš„å›­åŒºæƒé™åˆ—è¡¨
  if (!userInfo.locations || userInfo.locations.length === 0) {
    return false
  }
  
  // å¦‚æœåŒ…å« "all"ï¼Œè¡¨ç¤ºæ‰€æœ‰å›­åŒº
  if (userInfo.locations.includes('all')) {
    return true
  }
  
  // æ£€æŸ¥ç‰¹å®šå›­åŒº
  return userInfo.locations.includes(location)
}

/**
 * è·å–ç”¨æˆ·å¯ç®¡ç†çš„å›­åŒºåˆ—è¡¨
 */
export function getUserLocations(userInfo) {
  if (userInfo.role === 'admin') {
    return ['land_park', 'water_park']  // æ‰€æœ‰å›­åŒº
  }
  
  return userInfo.locations || []
}
```

#### æ­¥éª¤3ï¼šåœ¨é¡µé¢ä¸­ä½¿ç”¨

```vue
<!-- pages-sub/out/add.vue - å‡ºåº“é¡µé¢ -->
<template>
  <view>
    <picker 
      :range="availableLocations" 
      :range-key="'name'"
      @change="onLocationChange"
    >
      <view>å›­åŒºï¼š{{ selectedLocationName }}</view>
    </picker>
  </view>
</template>

<script>
import { authMixin } from '@/utils/auth.js'
import { getUserLocations, hasLocationPermission } from '@/utils/location-permission.js'

export default {
  mixins: [authMixin],
  
  data() {
    return {
      allLocations: [
        { code: 'land_park', name: 'é™†å›­' },
        { code: 'water_park', name: 'æ°´å›­' }
      ],
      availableLocations: [],
      selectedLocation: ''
    }
  },
  
  onLoad() {
    // æ ¹æ®ç”¨æˆ·æƒé™ç­›é€‰å¯ç”¨å›­åŒº
    const userLocations = getUserLocations(this.userInfo)
    
    this.availableLocations = this.allLocations.filter(loc => 
      userLocations.includes(loc.code)
    )
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªå¯ç”¨å›­åŒºï¼Œç›´æ¥é€‰ä¸­
    if (this.availableLocations.length === 1) {
      this.selectedLocation = this.availableLocations[0].code
    }
  },
  
  methods: {
    onLocationChange(e) {
      const index = e.detail.value
      this.selectedLocation = this.availableLocations[index].code
    },
    
    async submitForm() {
      // æäº¤å‰å†æ¬¡éªŒè¯å›­åŒºæƒé™
      if (!hasLocationPermission(this.userInfo, this.selectedLocation)) {
        uni.showToast({
          title: 'æ‚¨æ— æƒæ“ä½œæ­¤å›­åŒº',
          icon: 'none'
        })
        return
      }
      
      // æäº¤è¡¨å•...
    }
  }
}
</script>
```

#### æ­¥éª¤4ï¼šäº‘å‡½æ•°éªŒè¯

```javascript
// cloudfunctions/createOutRecord/index.js

async function validateLocationPermission(openid, location) {
  const user = await db.collection('users')
    .where({ openid })
    .get()
  
  if (user.data.length === 0) {
    return { valid: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨' }
  }
  
  const userData = user.data[0]
  
  // ç®¡ç†å‘˜æœ‰æ‰€æœ‰æƒé™
  if (userData.role === 'admin') {
    return { valid: true }
  }
  
  // æ£€æŸ¥å›­åŒºæƒé™
  if (!userData.locations || !userData.locations.includes(location)) {
    return { 
      valid: false, 
      message: `æ‚¨æ— æƒæ“ä½œ${location === 'land_park' ? 'é™†å›­' : 'æ°´å›­'}` 
    }
  }
  
  return { valid: true }
}

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { location, items } = event
  
  // éªŒè¯å›­åŒºæƒé™
  const locationAuth = await validateLocationPermission(
    wxContext.OPENID, 
    location
  )
  
  if (!locationAuth.valid) {
    return {
      code: 403,
      message: locationAuth.message
    }
  }
  
  // åˆ›å»ºå‡ºåº“å•...
}
```

---

## ğŸ“Š æ•°æ®èŒƒå›´æƒé™

### åœºæ™¯ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹/ä¿®æ”¹è‡ªå·±åˆ›å»ºçš„å•æ®

#### æ­¥éª¤1ï¼šä¿®æ”¹æŸ¥è¯¢é€»è¾‘

```javascript
// åœ¨åˆ—è¡¨é¡µé¢
async loadRecordList() {
  const userRole = this.userRole
  const userId = this.userInfo.userId
  
  let query = db.collection('in_records')
  
  // éç®¡ç†å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„å•æ®
  if (userRole !== 'admin') {
    query = query.where({ operatorId: userId })
  }
  
  const res = await query.orderBy('createTime', 'desc').get()
  this.recordList = res.data
}
```

#### æ­¥éª¤2ï¼šä¿®æ”¹æ“ä½œæŒ‰é’®æ˜¾ç¤º

```vue
<template>
  <view class="record-item">
    <!-- åªæœ‰åˆ›å»ºäººæˆ–ç®¡ç†å‘˜å¯ç¼–è¾‘ -->
    <button 
      v-if="canEditRecord(record)" 
      @click="editRecord(record)"
    >
      ç¼–è¾‘
    </button>
    
    <!-- åªæœ‰ç®¡ç†å‘˜å¯åˆ é™¤ -->
    <button 
      v-if="isAdmin" 
      @click="deleteRecord(record)"
    >
      åˆ é™¤
    </button>
  </view>
</template>

<script>
export default {
  methods: {
    canEditRecord(record) {
      // ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘æ‰€æœ‰è®°å½•
      if (this.isAdmin) {
        return true
      }
      
      // åˆ›å»ºäººå¯ä»¥ç¼–è¾‘è‡ªå·±çš„è®°å½•ï¼ˆè‰ç¨¿çŠ¶æ€ï¼‰
      return record.operatorId === this.userInfo.userId && 
             record.status === 'draft'
    }
  }
}
</script>
```

#### æ­¥éª¤3ï¼šäº‘å‡½æ•°éªŒè¯

```javascript
// cloudfunctions/updateInRecord/index.js

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { recordId, ...updateData } = event
  
  // è·å–è®°å½•
  const record = await db.collection('in_records').doc(recordId).get()
  
  if (!record.data) {
    return { code: 404, message: 'è®°å½•ä¸å­˜åœ¨' }
  }
  
  // è·å–å½“å‰ç”¨æˆ·
  const user = await db.collection('users')
    .where({ openid: wxContext.OPENID })
    .get()
  
  const userData = user.data[0]
  
  // éªŒè¯ä¿®æ”¹æƒé™
  const canEdit = userData.role === 'admin' ||  // ç®¡ç†å‘˜å¯ä¿®æ”¹
                  (record.data.operatorId === userData._id &&  // åˆ›å»ºäººå¯ä¿®æ”¹
                   record.data.status === 'draft')  // ä»…è‰ç¨¿çŠ¶æ€
  
  if (!canEdit) {
    return {
      code: 403,
      message: 'æ‚¨æ— æƒä¿®æ”¹æ­¤è®°å½•'
    }
  }
  
  // æ‰§è¡Œæ›´æ–°...
}
```

---

## ğŸ”„ å®¡æ‰¹æµç¨‹

### åœºæ™¯ï¼šé«˜å€¼è¯å“å‡ºåº“éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹

#### æ­¥éª¤1ï¼šæ‰©å±•å•æ®çŠ¶æ€

```javascript
// åŸçŠ¶æ€ï¼šdraft â†’ pending_review â†’ completed
// æ–°çŠ¶æ€ï¼šdraft â†’ pending_review â†’ pending_approval â†’ completed

const RECORD_STATUS = {
  DRAFT: 'draft',                      // è‰ç¨¿
  PENDING_REVIEW: 'pending_review',     // å¾…å¤æ ¸
  PENDING_APPROVAL: 'pending_approval', // âœ… å¾…å®¡æ‰¹ï¼ˆé«˜å€¼è¯å“ï¼‰
  APPROVED: 'approved',                 // âœ… å·²å®¡æ‰¹
  COMPLETED: 'completed',               // å·²å®Œæˆ
  REJECTED: 'rejected'                  // å·²é©³å›
}
```

#### æ­¥éª¤2ï¼šä¿®æ”¹å‡ºåº“æµç¨‹

```vue
<!-- pages-sub/out/add.vue -->
<script>
export default {
  methods: {
    async submitRecord() {
      // æ£€æŸ¥æ˜¯å¦åŒ…å«é«˜å€¼è¯å“
      const hasHighValue = this.items.some(item => item.isHighValue)
      
      // æ™®é€šè¯å“ï¼šæäº¤åç›´æ¥è¿›å…¥å¾…å¤æ ¸
      // é«˜å€¼è¯å“ï¼šæäº¤åè¿›å…¥å¾…å®¡æ‰¹
      const status = hasHighValue ? 'pending_approval' : 'pending_review'
      
      const res = await wx.cloud.callFunction({
        name: 'createOutRecord',
        data: {
          ...this.formData,
          status,
          needApproval: hasHighValue  // æ ‡è®°éœ€è¦å®¡æ‰¹
        }
      })
      
      if (res.result.code === 0) {
        const message = hasHighValue 
          ? 'æäº¤æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹' 
          : 'æäº¤æˆåŠŸ'
        
        uni.showToast({ title: message })
      }
    }
  }
}
</script>
```

#### æ­¥éª¤3ï¼šåˆ›å»ºå®¡æ‰¹é¡µé¢

```vue
<!-- pages-sub/approval/list.vue -->
<template>
  <view class="approval-list">
    <view 
      v-for="record in pendingList" 
      :key="record._id"
      class="approval-item"
    >
      <view class="record-info">
        <text>å•å·ï¼š{{ record.recordNo }}</text>
        <text>ç±»å‹ï¼šé«˜å€¼è¯å“å‡ºåº“</text>
        <text>æ€»é‡‘é¢ï¼šÂ¥{{ record.totalAmount }}</text>
      </view>
      
      <view class="approval-actions">
        <button @click="approveRecord(record)">æ‰¹å‡†</button>
        <button @click="rejectRecord(record)">é©³å›</button>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      pendingList: []
    }
  },
  
  onLoad() {
    // ä»…ç®¡ç†å‘˜å¯è®¿é—®
    if (!this.isAdmin) {
      uni.showModal({
        title: 'æƒé™ä¸è¶³',
        content: 'ä»…ç®¡ç†å‘˜å¯å®¡æ‰¹',
        showCancel: false,
        success: () => uni.navigateBack()
      })
      return
    }
    
    this.loadPendingList()
  },
  
  methods: {
    async loadPendingList() {
      const res = await wx.cloud.callFunction({
        name: 'getPendingApprovals',
        data: {}
      })
      
      if (res.result.code === 0) {
        this.pendingList = res.result.data
      }
    },
    
    async approveRecord(record) {
      uni.showModal({
        title: 'ç¡®è®¤æ‰¹å‡†',
        content: `ç¡®å®šæ‰¹å‡†æ­¤å‡ºåº“å•å—ï¼Ÿ`,
        success: async (res) => {
          if (res.confirm) {
            await this.doApprove(record._id, 'approved')
          }
        }
      })
    },
    
    async rejectRecord(record) {
      // è¾“å…¥é©³å›åŸå› 
      // ...
      await this.doApprove(record._id, 'rejected', reason)
    },
    
    async doApprove(recordId, action, reason = '') {
      const res = await wx.cloud.callFunction({
        name: 'approveOutRecord',
        data: { recordId, action, reason }
      })
      
      if (res.result.code === 0) {
        uni.showToast({ title: 'æ“ä½œæˆåŠŸ' })
        this.loadPendingList()
      }
    }
  }
}
</script>
```

#### æ­¥éª¤4ï¼šåˆ›å»ºå®¡æ‰¹äº‘å‡½æ•°

```javascript
// cloudfunctions/approveOutRecord/index.js

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { recordId, action, reason } = event
  
  // éªŒè¯ç®¡ç†å‘˜æƒé™
  const admin = await db.collection('users')
    .where({ openid: wxContext.OPENID, role: 'admin' })
    .get()
  
  if (admin.data.length === 0) {
    return { code: 403, message: 'ä»…ç®¡ç†å‘˜å¯å®¡æ‰¹' }
  }
  
  // è·å–è®°å½•
  const record = await db.collection('out_records').doc(recordId).get()
  
  if (!record.data) {
    return { code: 404, message: 'è®°å½•ä¸å­˜åœ¨' }
  }
  
  // æ›´æ–°çŠ¶æ€
  const updateData = {
    status: action,  // approved æˆ– rejected
    approver: admin.data[0].name,
    approverId: admin.data[0]._id,
    approveTime: db.serverDate()
  }
  
  if (action === 'rejected') {
    updateData.rejectReason = reason
  }
  
  await db.collection('out_records').doc(recordId).update({
    data: updateData
  })
  
  // å¦‚æœæ‰¹å‡†ï¼Œæ‰§è¡Œåº“å­˜æ‰£å‡
  if (action === 'approved') {
    await wx.cloud.callFunction({
      name: 'updateStock',
      data: {
        type: 'out',
        recordId
      }
    })
  }
  
  // è®°å½•æ—¥å¿—
  await db.collection('operation_logs').add({
    data: {
      operator: wxContext.OPENID,
      operatorName: admin.data[0].name,
      action: action === 'approved' ? 'approve_record' : 'reject_record',
      target: recordId,
      details: { reason },
      timestamp: db.serverDate()
    }
  })
  
  return {
    code: 0,
    message: action === 'approved' ? 'å·²æ‰¹å‡†' : 'å·²é©³å›'
  }
}
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æƒé™é…ç½®é›†ä¸­ç®¡ç†

```javascript
// âœ… æ¨èï¼šæ‰€æœ‰æƒé™é…ç½®åœ¨ utils/permission.js
const PERMISSIONS = {
  'drug.create': [ROLES.ADMIN, ROLES.PHARMACY],
  'drug.delete': [ROLES.ADMIN],
  // ...
}

// âŒ ä¸æ¨èï¼šæƒé™åˆ†æ•£åœ¨å„ä¸ªé¡µé¢
if (role === 'admin' || role === 'pharmacy') {
  // ...
}
```

### 2. å‰åç«¯åŒé‡éªŒè¯

```javascript
// âœ… å‰ç«¯éªŒè¯ï¼ˆç”¨æˆ·ä½“éªŒï¼‰
if (!this.hasPermission('drug.delete')) {
  uni.showToast({ title: 'æƒé™ä¸è¶³' })
  return
}

// âœ… åç«¯éªŒè¯ï¼ˆå®‰å…¨ä¿éšœï¼‰
const permission = await checkPermissionInCloud(openid, 'drug.delete')
if (!permission.authorized) {
  return { code: 403, message: 'æƒé™ä¸è¶³' }
}
```

### 3. è¯¦ç»†çš„æ“ä½œæ—¥å¿—

```javascript
// âœ… è®°å½•å…³é”®ä¿¡æ¯
await db.collection('operation_logs').add({
  data: {
    operator: openid,
    operatorName: user.name,
    action: 'delete_drug',
    target: drugId,
    details: {
      drugName: drug.name,
      reason: 'è¿‡æœŸè¯å“'
    },
    timestamp: db.serverDate(),
    ip: wxContext.CLIENTIP  // è®°å½•IPåœ°å€
  }
})
```

### 4. æƒé™é”™è¯¯å‹å¥½æç¤º

```javascript
// âœ… æ¸…æ™°çš„é”™è¯¯æç¤º
return {
  code: 403,
  message: 'æ‚¨æ— æƒåˆ é™¤è¯å“ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
}

// âŒ æ¨¡ç³Šçš„æç¤º
return {
  code: 403,
  message: 'æ“ä½œå¤±è´¥'
}
```

---

## ğŸ”® æ‰©å±•å»ºè®®

### 1. åŠ¨æ€æƒé™é…ç½®

å°†æƒé™é…ç½®å­˜å‚¨åˆ°æ•°æ®åº“ï¼Œæ”¯æŒè¿è¡Œæ—¶ä¿®æ”¹ï¼š

```javascript
// role_permissions è¡¨
{
  _id: "perm_001",
  role: "pharmacy",
  permissions: [
    "drug.create",
    "drug.update",
    "stock_in.create",
    // ...
  ],
  updateTime: "2025-01-27"
}
```

### 2. æƒé™ç¼“å­˜

```javascript
// å‡å°‘æ•°æ®åº“æŸ¥è¯¢
const PERMISSION_CACHE_TIME = 5 * 60 * 1000  // 5åˆ†é’Ÿ

let permissionCache = {}

async function getUserPermissions(userId) {
  const now = Date.now()
  
  // æ£€æŸ¥ç¼“å­˜
  if (permissionCache[userId] && 
      now - permissionCache[userId].time < PERMISSION_CACHE_TIME) {
    return permissionCache[userId].data
  }
  
  // ä»æ•°æ®åº“è·å–
  const permissions = await fetchPermissionsFromDB(userId)
  
  // æ›´æ–°ç¼“å­˜
  permissionCache[userId] = {
    data: permissions,
    time: now
  }
  
  return permissions
}
```

### 3. æƒé™å˜æ›´é€šçŸ¥

```javascript
// å½“ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·æƒé™æ—¶ï¼Œé€šçŸ¥ç”¨æˆ·
async function notifyPermissionChange(userId, oldRole, newRole) {
  await sendSubscribeMessage(userId, {
    thing1: { value: 'æƒé™å˜æ›´é€šçŸ¥' },
    thing2: { value: `è§’è‰²ä»${oldRole}å˜æ›´ä¸º${newRole}` },
    time3: { value: formatTime(new Date()) }
  })
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-27  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ





























