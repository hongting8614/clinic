# 🚀 测试数据自动生成指南

## ✅ 已完成的准备工作

1. ✅ 创建了数据生成脚本：`utils/generateTestData_v3.14.js`
2. ✅ 创建了数据生成页面：`pages/test/generate-data.vue`
3. ✅ 添加了页面配置：`pages.json`

---

## 📦 将生成的数据

### 1. 地点配置（3个）
- 🏥 药库（drug_storage）
- 🏢 陆地园区（land_park）
- 🏊 水上园区（water_park）

### 2. 供应商（4个）
- 康美药业
- 九州通医药
- 华润医药
- 国药集团

### 3. 药品档案（14种）
包含规格信息，支持单位转换：
- 抗生素类：阿莫西林、头孢克肟、青霉素等
- 解热镇痛类：布洛芬、对乙酰氨基酚等
- 呼吸系统：甘草口服液、蒲地蓝等
- 外用药：红霉素软膏、碘伏等
- 中成药：板蓝根、感冒清热颗粒等

### 4. 药库库存（28-42条）
- **存储单位**：包装单位（盒、瓶、支）
- **每种药品**：2-3个批次
- **数量范围**：10-60个包装单位
- **包含字段**：specInfo、pricePerMin、批号、生产日期、有效期

### 5. 园区库存（约16-24条）
- **存储单位**：最小单位（粒、片、ml、支）
- **覆盖范围**：约60%的药品
- **数量范围**：20-120个最小单位
- **符合双轨制**：与药库区分存储

---

## 🚀 快速开始

### 方式1: 使用页面操作（推荐）⭐

#### 步骤1: 重新编译小程序
```
在微信开发者工具中点击 "编译" 按钮
```

#### 步骤2: 访问生成页面
在控制台输入：
```javascript
wx.navigateTo({
  url: '/pages/test/generate-data'
})
```

#### 步骤3: 一键生成
点击页面上的 **"🚀 一键生成测试数据"** 按钮

#### 步骤4: 等待完成
- 查看日志输出
- 等待 "🎉 测试数据生成完成！" 提示
- 约需 30-60 秒

---

### 方式2: 控制台直接执行

在微信开发者工具控制台执行以下代码：

```javascript
// 快速生成脚本
(async function() {
  const db = wx.cloud.database()
  
  // 1. 添加地点
  const locations = [
    { code: 'drug_storage', name: '药库', icon: '🏥', type: 'storage' },
    { code: 'land_park', name: '陆地园区', icon: '🏢', type: 'park' },
    { code: 'water_park', name: '水上园区', icon: '🏊', type: 'park' }
  ]
  
  for (let loc of locations) {
    const exists = await db.collection('locations').where({ code: loc.code }).count()
    if (exists.total === 0) {
      await db.collection('locations').add({
        data: { ...loc, status: 'active', sort: 0, createTime: new Date() }
      })
      console.log(`✅ 添加: ${loc.name}`)
    }
  }
  
  // 2. 添加供应商
  const suppliers = [
    { name: '康美药业', code: 'SUP001', contact: '张经理', phone: '13800138000' },
    { name: '九州通医药', code: 'SUP002', contact: '李经理', phone: '13800138001' }
  ]
  
  for (let sup of suppliers) {
    const exists = await db.collection('suppliers').where({ code: sup.code }).count()
    if (exists.total === 0) {
      await db.collection('suppliers').add({
        data: { ...sup, status: 'active', createTime: new Date() }
      })
      console.log(`✅ 添加: ${sup.name}`)
    }
  }
  
  console.log('🎉 基础数据生成完成！')
  console.log('💡 建议使用页面继续生成完整数据')
})()
```

---

## 📊 验证生成结果

### 在云开发控制台验证

#### 验证地点
```javascript
db.collection('locations').get()
// 应该看到 3 条记录
```

#### 验证供应商
```javascript
db.collection('suppliers').get()
// 应该看到 4 条记录
```

#### 验证药品
```javascript
db.collection('drugs').count()
// 应该有 14 种药品
```

#### 验证药库库存
```javascript
db.collection('stock')
  .where({ location: 'drug_storage' })
  .get()
// 应该看到包装单位存储（盒、瓶、支）
```

#### 验证园区库存
```javascript
db.collection('stock')
  .where({ location: 'land_park' })
  .get()
// 应该看到最小单位存储（粒、片、ml）
```

---

## 🔍 数据结构示例

### 药库库存示例
```json
{
  "drugName": "阿莫西林胶囊",
  "specification": "0.25g×24粒/盒",
  "specInfo": {
    "dosage": 0.25,
    "dosageUnit": "g",
    "conversionRate": 24,
    "minUnit": "粒",
    "packUnit": "盒"
  },
  "location": "drug_storage",
  "quantity": 50,
  "unit": "盒",
  "price": 15.8,
  "pricePerMin": "0.6583"
}
```

### 园区库存示例
```json
{
  "drugName": "阿莫西林胶囊",
  "specification": "0.25g×24粒/盒",
  "specInfo": {
    "dosage": 0.25,
    "dosageUnit": "g",
    "conversionRate": 24,
    "minUnit": "粒",
    "packUnit": "盒"
  },
  "location": "land_park",
  "quantity": 80,
  "unit": "粒",
  "price": 15.8,
  "pricePerMin": "0.6583"
}
```

---

## 🗑️ 清空测试数据

### 使用页面清空
点击页面上的 **"🗑️ 清空测试数据"** 按钮

### 使用控制台清空
```javascript
// 仅清空库存数据
const db = wx.cloud.database()
db.collection('stock').where({}).remove()
  .then(res => {
    console.log(`✅ 删除库存: ${res.removed} 条`)
  })
```

---

## ⚠️ 注意事项

### 1. 数据冲突
- 生成前会检查是否已存在
- 相同名称和规格的药品不会重复添加
- 可以多次执行，不会产生重复数据

### 2. 性能考虑
- 生成过程需要 30-60 秒
- 不要在生成过程中关闭页面
- 观察日志输出，确认每步成功

### 3. 数据完整性
- 每条库存都包含 `specInfo` 字段
- 每条库存都有 `pricePerMin` 字段
- 符合 v3.14 双轨制存储要求

---

## 🎯 生成后的测试流程

### 1. 验证数据
```javascript
wx.navigateTo({ url: '/pages/test/generate-data' })
// 点击 "📊 查看统计" 按钮
```

### 2. 测试入库
```javascript
wx.navigateTo({ url: '/pages-sub/in/add' })
// 创建入库单，查看库存变化
```

### 3. 测试出库
```javascript
wx.navigateTo({ url: '/pages-sub/out/add' })
// 从药库出库到园区，验证单位转换
```

### 4. 测试门诊
```javascript
wx.navigateTo({ url: '/pages-sub/clinic/add' })
// 记录门诊消耗，验证园区库存减少
```

---

## 📖 相关文档

- 🚀 **测试数据生成指南**（本文档）
- 📦 **数据迁移操作指南**：`docs/迁移操作指南.md`
- 📋 **入库单优化指南**：`docs/入库单优化指南.md`
- 🎯 **v3.14 测试指南**：`docs/v3.14_测试指南.md`
- 📐 **设计文档**：`_backup_docs/📐分园区单位转换界面设计_v3.14_终极版.md`

---

## 💡 常见问题

### Q1: 生成失败怎么办？
**A**: 查看日志中的错误信息，通常是网络或权限问题。可以：
1. 检查云开发是否正常
2. 确认数据库权限配置
3. 重新执行生成

### Q2: 数据可以重复生成吗？
**A**: 可以。脚本会检查现有数据，不会重复添加相同的记录。

### Q3: 如何完全重新生成？
**A**: 
1. 先点击 "🗑️ 清空测试数据"
2. 再点击 "🚀 一键生成测试数据"

### Q4: 生成的数据符合 v3.14 规范吗？
**A**: 完全符合！
- ✅ 药库使用包装单位
- ✅ 园区使用最小单位
- ✅ 包含完整的 specInfo
- ✅ 计算了 pricePerMin

---

**准备好了吗？开始生成测试数据吧！** 🚀

