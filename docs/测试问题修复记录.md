# 🔧 测试问题修复记录

**测试日期**: 2025-11-04  
**版本**: v3.5

---

## ❌ 问题 1: API 调用失败

### 错误信息
```
TypeError: Cannot read property 'callFunction' of undefined
at list.vue:164
```

### 原因分析
- `pages-sub/in/list.vue` 和 `pages-sub/in/add.vue` 使用了 `this.$api.callFunction()`
- 但 `main.js` 中没有全局注入 API 工具
- 导致 `this.$api` 为 `undefined`

### 修复方案
在 `main.js` 中添加全局 API 注入：

```javascript
import * as api from './utils/api.js'

// 全局注入 API
Vue.prototype.$api = api
```

### 修复文件
- ✅ `main.js` - 添加 API 全局注入

### 验证方法
```bash
1. 重新编译项目
2. 访问入库单列表页面 /pages-sub/in/list
3. 观察控制台，不应再有 callFunction 错误
4. 列表应该正常加载
```

---

## ⚠️ 警告 1: SharedArrayBuffer 弃用警告

### 警告信息
```
[Deprecation] SharedArrayBuffer will require cross-origin isolation as of M92
```

### 原因分析
- 这是 Chrome 的弃用警告
- 与项目代码无关
- 通常由第三方库（如微信开发者工具）触发

### 处理方案
- 可以忽略，不影响功能
- 如需消除，需等待微信开发者工具更新

---

## ⚠️ 警告 2: wx.getSystemInfoSync 弃用警告

### 警告信息
```
wx.getSystemInfoSync is deprecated.
Please use wx.getSystemSetting/wx.getAppAuthorizeSetting/
wx.getDeviceInfo/wx.getWindowInfo/wx.getAppBaseInfo instead.
```

### 原因分析
- 微信API更新，`wx.getSystemInfoSync` 已弃用
- 可能由 uView Plus 或其他UI库调用

### 处理方案
- 可以忽略，不影响功能
- 如需修复，需更新 uView Plus 到最新版本

---

## ⚠️ 警告 3: batch-selector 样式警告

### 警告信息
```
[pages-sub/in/add] Some selectors are not allowed in component wxss
./components/batch-selector/index.wxss:172:13
```

### 原因分析
- `batch-selector` 组件的样式中使用了不允许的选择器
- 小程序组件样式不支持标签选择器、ID选择器、属性选择器

### 处理方案
- 入库页面已不使用 `batch-selector` 组件
- 此警告来自其他页面（如出库页面）
- 可以忽略，不影响入库功能

---

## ✅ 修复后状态

### 编译状态
- ✅ 编译成功
- ✅ 云开发初始化成功
- ✅ 主页面加载正常

### 功能状态
- ✅ 入库单列表应该可以正常加载
- ✅ 入库单新建页面应该可以正常访问
- ✅ API 调用应该正常工作

---

## 🔄 下一步测试

修复完成后，请按以下顺序测试：

### 1. 重新编译（必须）
```bash
# HBuilderX: 停止运行 -> 重新运行
# 或在微信开发者工具中点击"编译"
```

### 2. 测试入库单列表
```
1. 访问入库单列表页面
2. 观察控制台，确认无错误
3. 检查列表是否正常显示（或显示空状态）
```

### 3. 测试入库单新建
```
1. 点击"新建入库单"
2. 测试"从档案选择"功能
3. 添加药品到明细
4. 填写批号、日期、数量
5. 签名并提交
```

### 4. 测试完整流程
参考 `docs/快速测试指南.md`

---

## 📊 修复总结

| 问题类型 | 数量 | 状态 |
|---------|------|------|
| 严重错误 | 1 | ✅ 已修复 |
| 警告 | 3 | ⚠️ 可忽略 |

**总体状态**: ✅ 核心问题已修复，可以继续测试

---

## 📝 备注

### 关于 API 注入
- 已在 `main.js` 全局注入 `$api`
- 所有页面和组件都可以使用 `this.$api.callFunction()`
- 也可以使用具名导出的方法，如 `this.$api.createInRecord()`

### 关于警告
- SharedArrayBuffer 警告：浏览器/工具警告，可忽略
- wx.getSystemInfoSync 警告：API弃用警告，功能正常，可忽略
- batch-selector 警告：其他页面的警告，不影响入库模块

### 测试建议
1. 先测试基本功能（列表、新建、提交）
2. 再测试扫码功能（需真机）
3. 最后测试复核流程（需双账号）

---

**修复完成时间**: 2025-11-04  
**修复人员**: AI Assistant









