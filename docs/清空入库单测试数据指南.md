# 🗑️ 清空入库单测试数据指南

## 🎯 功能说明

用于测试入库与复核功能时，清空所有入库单和复核单数据。

**注意：** 此操作会删除所有入库单，包括：
- ✅ 草稿状态的入库单
- ✅ 待复核的入库单
- ✅ 已复核的入库单
- ✅ 已驳回的入库单

---

## 🚀 方法1：使用云函数（推荐）⭐⭐⭐

### 步骤1：上传云函数

```
1. 在微信开发者工具中
2. 找到 cloudfunctions/clearInRecords
3. 右键点击文件夹
4. 选择"上传并部署：云端安装依赖"
5. 等待上传完成
```

### 步骤2：调用云函数

**方式A：在控制台调用**

```javascript
// 在微信开发者工具控制台运行
wx.cloud.callFunction({
  name: 'clearInRecords',
  success: res => {
    console.log('========================================')
    console.log('✅ 删除结果：', res.result)
    console.log('删除数量：', res.result.deletedCount)
    console.log('========================================')
  },
  fail: err => {
    console.error('❌ 删除失败：', err)
  }
})
```

**方式B：在小程序中调用**

```javascript
// 在页面中调用
async clearAllInRecords() {
  try {
    uni.showLoading({
      title: '删除中...'
    })
    
    const res = await wx.cloud.callFunction({
      name: 'clearInRecords'
    })
    
    uni.hideLoading()
    
    if (res.result.success) {
      uni.showToast({
        title: `已删除 ${res.result.deletedCount} 条记录`,
        icon: 'success'
      })
    } else {
      uni.showToast({
        title: res.result.message || '删除失败',
        icon: 'error'
      })
    }
  } catch (err) {
    console.error('删除失败：', err)
    uni.hideLoading()
    uni.showToast({
      title: '删除失败',
      icon: 'error'
    })
  }
}
```

---

## 🖥️ 方法2：在云开发控制台手动删除

### 步骤1：打开云开发控制台

```
1. 访问：https://console.cloud.tencent.com/tcb
2. 选择您的环境（如：cloud1-3gv7spppf7d2d0f4）
3. 点击左侧菜单"数据库"
```

### 步骤2：删除入库单数据

```
1. 找到 in_records 集合
2. 点击集合名称进入
3. 查看所有记录
4. 选择删除方式：

方式A：删除所有记录
  - 点击"删除"按钮（如果有批量删除功能）
  - 或逐个删除

方式B：使用数据库命令（高级）
  - 点击"数据库" → "数据库操作"
  - 输入以下命令：
  
  db.collection('in_records').remove({})
  
  - 点击"执行"
```

---

## 🔧 方法3：使用数据库命令（高级）

### 在云开发控制台执行

```
1. 打开云开发控制台
2. 数据库 → 数据库操作
3. 选择 in_records 集合
4. 输入命令：

// 删除所有入库单
db.collection('in_records').remove({})

5. 点击"执行"
6. 确认删除
```

---

## ⚠️ 重要提示

### 删除前检查

```
□ 确认这是测试环境
□ 确认不需要保留任何数据
□ 确认已备份重要数据（如需要）
□ 确认当前登录的是管理员账号
```

### 权限要求

```
✅ 只有管理员（admin）可以执行删除操作
❌ 其他角色（项目经理、医生等）无法执行
```

### 删除范围

```
会删除：
✅ 所有状态的入库单（草稿、待复核、已复核、已驳回）
✅ 所有复核记录
✅ 所有签名信息

不会删除：
❌ 药品档案（drugs）
❌ 库存信息（stock）
❌ 用户信息（users）
❌ 出库记录（out_records）
```

---

## 📊 删除后验证

### 检查是否删除成功

**方式1：在云开发控制台查看**

```
1. 打开云开发控制台
2. 数据库 → in_records 集合
3. 查看记录数量
4. ✅ 应该显示 0 条记录
```

**方式2：在小程序中查看**

```
1. 进入"单据"页面
2. 查看"入库记录"
3. ✅ 应该显示"暂无数据"
```

**方式3：使用云函数查询**

```javascript
// 在控制台运行
wx.cloud.callFunction({
  name: 'inRecords',
  data: {
    action: 'list',
    page: 1,
    pageSize: 10
  },
  success: res => {
    console.log('入库单数量：', res.result.total || 0)
    console.log('入库单列表：', res.result.list || [])
  }
})
```

---

## 🆘 常见问题

### Q1：提示"只有管理员可以执行此操作"？

**A：** 检查当前登录账号的角色

```
解决步骤：
1. 在小程序中进入"我的"页面
2. 查看显示的角色
3. 如果不是"管理员"，需要：
   - 切换到管理员账号
   - 或在数据库中修改当前账号的role为"admin"
```

### Q2：删除后库存还在吗？

**A：** 库存不会自动删除

```
说明：
- 删除入库单不会影响库存
- 如果入库单已复核并更新了库存，库存数据仍然存在
- 如需清空库存，需要单独操作 stock 集合
```

### Q3：如何只删除特定状态的入库单？

**A：** 修改云函数或使用数据库命令

**修改云函数：**

```javascript
// 在 clearInRecords/index.js 中修改
// 只删除特定状态的记录
const recordsRes = await db.collection('in_records')
  .where({
    status: 'pending_review'  // 只删除待复核的
    // 或 status: 'completed'  // 只删除已复核的
  })
  .get()
```

**使用数据库命令：**

```javascript
// 只删除待复核的入库单
db.collection('in_records').remove({
  status: 'pending_review'
})

// 只删除已复核的入库单
db.collection('in_records').remove({
  status: 'completed'
})
```

---

## 📝 完整操作流程

### 测试入库与复核的完整流程

```
步骤1：清空所有入库单
  → 使用云函数 clearInRecords
  → 或手动删除

步骤2：创建新的入库单
  → 进入"新建入库单"
  → 添加药品
  → 提交入库

步骤3：复核入库单
  → 切换到项目经理账号
  → 进入"入库记录"
  → 找到待复核的单据
  → 点击"复核"

步骤4：验证结果
  → 检查入库单状态
  → 检查库存是否更新
  → 检查签名是否正确

步骤5：再次清空（如需要）
  → 重复步骤1
```

---

## 🎯 快速操作脚本

### 一键清空（复制到控制台）

```javascript
// 完整版：带检查和提示
(function() {
  if (!wx || !wx.cloud) {
    console.error('❌ 云开发未初始化')
    return
  }
  
  console.log('⚠️ 即将删除所有入库单，请确认！')
  
  wx.cloud.callFunction({
    name: 'clearInRecords',
    success: res => {
      if (res.result.success) {
        console.log('========================================')
        console.log('✅ 删除成功！')
        console.log('删除数量：', res.result.deletedCount)
        console.log('========================================')
      } else {
        console.error('❌ 删除失败：', res.result.message)
      }
    },
    fail: err => {
      console.error('❌ 调用失败：', err)
    }
  })
})()
```

---

## ✅ 操作检查清单

```
□ 已上传 clearInRecords 云函数
□ 确认当前登录的是管理员账号
□ 确认不需要保留任何入库单数据
□ 已执行删除操作
□ 已验证删除成功（记录数为0）
□ 可以开始新的测试
```

---

**最后更新：** 2025年11月10日  
**适用场景：** 测试入库与复核功能前清理数据  
**权限要求：** 管理员（admin）


