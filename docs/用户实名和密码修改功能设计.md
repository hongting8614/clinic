# 📋 用户实名和密码修改功能设计文档

## 🎯 需求概述

实现用户实名和密码修改功能：

1. **用户实名**：用户必须设置实名（2-10个中文字符）
2. **密码修改**：登录用户可自行修改密码
3. **密码要求**：不少于8位，包含大小写字母和数字

---

## 🔐 功能设计

### 1. 用户实名

#### **实名要求**
- ✅ 必填项
- ✅ 2-10个中文字符
- ✅ 格式验证：`/^[\u4e00-\u9fa5]{2,10}$/`
- ✅ 用户可自行修改

#### **实名字段**
- 数据库字段：`realName`
- 显示位置：设置页面、用户管理页面
- 用途：系统实名认证

---

### 2. 密码修改

#### **密码要求**
- ✅ 不少于8位
- ✅ 包含至少一个大写字母（A-Z）
- ✅ 包含至少一个小写字母（a-z）
- ✅ 包含至少一个数字（0-9）

#### **密码验证规则**
```javascript
// 密码格式验证
function validatePassword(password) {
  if (password.length < 8) {
    return { valid: false, message: '密码长度不能少于8位' }
  }
  
  if (!/[A-Z]/.test(password)) {
    return { valid: false, message: '密码必须包含至少一个大写字母' }
  }
  
  if (!/[a-z]/.test(password)) {
    return { valid: false, message: '密码必须包含至少一个小写字母' }
  }
  
  if (!/[0-9]/.test(password)) {
    return { valid: false, message: '密码必须包含至少一个数字' }
  }
  
  return { valid: true, message: '密码格式正确' }
}
```

#### **密码加密**
- 使用SHA256加密
- 存储加密后的密码哈希值
- 不存储明文密码

---

## 📱 页面设计

### 1. 设置页面 (`pages-sub/setting/index.vue`)

**功能：**
- 显示个人信息（姓名、实名、手机号、角色）
- 修改实名入口
- 修改密码入口
- 用户管理入口（管理员和项目经理）

**界面布局：**
```
┌─────────────────────────────────────────┐
│  ← 设置                                  │
├─────────────────────────────────────────┤
│  👤 个人信息                             │
│  ┌───────────────────────────────────┐ │
│  │ 姓名：张三                          │ │
│  │ 实名：张三 [修改]                   │ │
│  │ 手机号：13800138000                 │ │
│  │ 角色：管理员                        │ │
│  └───────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  🔒 安全设置                             │
│  ┌───────────────────────────────────┐ │
│  │ 🔑 修改密码                    ›   │ │
│  └───────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  ⚙️ 其他                                 │
│  ┌───────────────────────────────────┐ │
│  │ 👥 用户管理                    ›   │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

### 2. 修改密码页面 (`pages-sub/setting/change-password.vue`)

**功能：**
- 输入当前密码
- 输入新密码
- 确认新密码
- 实时密码强度提示
- 密码格式验证

**界面布局：**
```
┌─────────────────────────────────────────┐
│  ← 修改密码                              │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ 当前密码 *                          │ │
│  │ [________________] 👁️              │ │
│  ├───────────────────────────────────┤ │
│  │ 新密码 *                            │ │
│  │ [________________] 👁️              │ │
│  │                                     │ │
│  │ 密码强度提示：                      │ │
│  │ ✓ 至少8位                           │ │
│  │ ✓ 包含大写字母                      │ │
│  │ ✓ 包含小写字母                      │ │
│  │ ✓ 包含数字                          │ │
│  ├───────────────────────────────────┤ │
│  │ 确认新密码 *                        │ │
│  │ [________________] 👁️              │ │
│  └───────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │        确认修改                     │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**密码强度提示：**
- 实时显示密码强度要求
- 满足要求时显示绿色✓
- 未满足时显示灰色○

---

### 3. 修改实名页面 (`pages-sub/setting/edit-realname.vue`)

**功能：**
- 输入实名
- 实名格式验证
- 提交修改

**界面布局：**
```
┌─────────────────────────────────────────┐
│  ← 修改实名                              │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ 实名 *                              │ │
│  │ [________________]                 │ │
│  │ 💡 请输入您的真实姓名，用于系统实名认证│ │
│  └───────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │        确认修改                     │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 💾 数据模型

### 用户数据结构

```javascript
{
  _id: '用户ID',
  openid: '微信OpenID',
  name: '姓名',
  realName: '张三',  // 实名（新增）
  nickname: '昵称',
  phone: '13800138000',
  password: 'sha256加密后的密码',  // 密码（新增）
  role: 'admin',
  status: 'active',
  createTime: '2025-01-09T10:00:00Z',
  updateTime: '2025-01-09T10:00:00Z',
  lastLogin: '2025-01-09T10:00:00Z'
}
```

---

## 🔧 云函数接口

### 1. **修改密码** (`changePassword`)

**请求：**
```javascript
{
  oldPassword: '当前密码',
  newPassword: '新密码'
}
```

**响应：**
```javascript
{
  code: 0,
  success: true,
  message: '密码修改成功'
}
```

**业务逻辑：**
1. 验证参数完整性
2. 验证新密码格式（8位+大小写+数字）
3. 查询用户
4. 验证当前密码（如果已设置）
5. 验证新密码不能与旧密码相同
6. 加密新密码（SHA256）
7. 更新密码
8. 记录操作日志

---

### 2. **更新个人信息** (`updateMyInfo`)

**请求：**
```javascript
{
  realName: '张三'
}
```

**响应：**
```javascript
{
  code: 0,
  success: true,
  message: '实名修改成功'
}
```

**业务逻辑：**
1. 验证实名格式（2-10个中文字符）
2. 查询用户
3. 更新实名
4. 记录操作日志

---

### 3. **添加用户** (`addUser`) - 更新

**新增参数：**
```javascript
{
  openid: '微信OpenID',
  name: '姓名',
  realName: '张三',  // 新增：实名（必填）
  phone: '13800138000',
  role: 'admin',
  password: '初始密码'  // 新增：可选
}
```

**验证规则：**
- `realName` 必填
- `realName` 格式：2-10个中文字符
- `password` 可选，如果提供则验证格式

---

### 4. **更新用户** (`updateUser`) - 更新

**新增参数：**
```javascript
{
  userId: '用户ID',
  name: '姓名',
  realName: '张三',  // 新增：实名
  phone: '13800138000',
  role: 'admin'
}
```

**验证规则：**
- `realName` 可选，如果提供则验证格式

---

## 📝 验证规则

### 1. 实名验证

```javascript
// 实名格式验证
function validateRealName(name) {
  if (!name) {
    return { valid: false, message: '实名不能为空' }
  }
  
  if (!/^[\u4e00-\u9fa5]{2,10}$/.test(name)) {
    return { valid: false, message: '实名格式不正确，请输入2-10个中文字符' }
  }
  
  return { valid: true, message: '格式正确' }
}
```

### 2. 密码验证

```javascript
// 密码格式验证
function validatePassword(password) {
  if (!password) {
    return { valid: false, message: '密码不能为空' }
  }
  
  if (password.length < 8) {
    return { valid: false, message: '密码长度不能少于8位' }
  }
  
  if (!/[A-Z]/.test(password)) {
    return { valid: false, message: '密码必须包含至少一个大写字母' }
  }
  
  if (!/[a-z]/.test(password)) {
    return { valid: false, message: '密码必须包含至少一个小写字母' }
  }
  
  if (!/[0-9]/.test(password)) {
    return { valid: false, message: '密码必须包含至少一个数字' }
  }
  
  return { valid: true, message: '密码格式正确' }
}
```

---

## 🔄 操作流程

### 1. 修改密码流程

```
1. 进入设置页面
   ↓
2. 点击"修改密码"
   ↓
3. 输入当前密码
   ↓
4. 输入新密码
   ↓
5. 实时显示密码强度提示
   ↓
6. 确认新密码
   ↓
7. 验证：
   - 当前密码是否正确
   - 新密码格式是否符合要求
   - 两次输入是否一致
   - 新密码不能与旧密码相同
   ↓
8. 提交修改
   ↓
9. 密码加密并保存
   ↓
10. 提示修改成功
```

### 2. 修改实名流程

```
1. 进入设置页面
   ↓
2. 点击"修改"按钮（实名旁边）
   ↓
3. 输入实名
   ↓
4. 验证实名格式（2-10个中文字符）
   ↓
5. 提交修改
   ↓
6. 更新实名
   ↓
7. 更新本地用户信息
   ↓
8. 提示修改成功
```

---

## 🎨 UI/UX 设计

### 1. 密码强度提示

**实时反馈：**
```
输入新密码时，实时显示：
○ 至少8位
○ 包含大写字母
○ 包含小写字母
○ 包含数字

满足要求后变为：
✓ 至少8位（绿色）
✓ 包含大写字母（绿色）
✓ 包含小写字母（绿色）
✓ 包含数字（绿色）
```

### 2. 密码显示/隐藏

**功能：**
- 点击眼睛图标切换显示/隐藏
- 默认隐藏密码
- 方便用户确认输入

### 3. 错误提示

**提示信息：**
- 密码格式不正确时，显示具体错误
- 两次密码不一致时，显示红色提示
- 当前密码错误时，提示"当前密码错误"

---

## 🔐 安全设计

### 1. 密码加密

**加密方式：**
- 使用SHA256哈希算法
- 不存储明文密码
- 密码不可逆

**代码：**
```javascript
const crypto = require('crypto')

function hashPassword(password) {
  return crypto.createHash('sha256').update(password).digest('hex')
}
```

### 2. 密码验证

**验证流程：**
1. 用户输入当前密码
2. 加密当前密码
3. 与数据库中的密码哈希值比较
4. 匹配则允许修改

### 3. 操作日志

**记录内容：**
- 操作人
- 操作时间
- 操作类型（修改密码/修改实名）
- 操作详情

---

## 📋 功能检查清单

### 用户实名
- [x] 添加实名字段到用户数据模型
- [x] 实名格式验证（2-10个中文字符）
- [x] 用户可自行修改实名
- [x] 管理员可设置用户实名
- [x] 实名显示在设置页面
- [x] 实名显示在用户管理页面

### 密码修改
- [x] 密码格式验证（8位+大小写+数字）
- [x] 密码强度实时提示
- [x] 密码显示/隐藏功能
- [x] 当前密码验证
- [x] 新密码不能与旧密码相同
- [x] 两次密码输入一致性验证
- [x] 密码加密存储（SHA256）
- [x] 操作日志记录

---

## ✅ 完成状态

**状态**：✅ 功能实现完成  
**实名功能**：✅ 完全可用  
**密码修改**：✅ 完全可用  
**安全性**：⭐⭐⭐⭐⭐  

**核心功能：**
1. ✅ 用户实名（必填，2-10个中文字符）
2. ✅ 用户可自行修改实名
3. ✅ 用户可自行修改密码
4. ✅ 密码格式验证（8位+大小写+数字）
5. ✅ 密码强度实时提示
6. ✅ 密码加密存储
7. ✅ 操作日志记录

---

## 📝 使用说明

### 1. 修改密码

**操作步骤：**
1. 进入"设置"页面
2. 点击"修改密码"
3. 输入当前密码
4. 输入新密码（不少于8位，包含大小写字母和数字）
5. 确认新密码
6. 点击"确认修改"

**注意事项：**
- 首次设置密码时，当前密码可以为空
- 新密码必须满足格式要求
- 新密码不能与当前密码相同

### 2. 修改实名

**操作步骤：**
1. 进入"设置"页面
2. 在"实名"旁边点击"修改"按钮
3. 输入真实姓名（2-10个中文字符）
4. 点击"确认修改"

**注意事项：**
- 实名必须为2-10个中文字符
- 实名用于系统实名认证
- 管理员添加用户时必须填写实名

---

**最后更新：** 2025-11-09  
**版本：** v1.0

