# 📋 用户管理功能完善设计文档

## 🎯 需求概述

完善用户管理功能，实现三种角色的权限控制：

1. **医生（doctor）**：无管理员功能，无入库复核功能
2. **项目经理（project_manager）**：有入库复核功能，可查看各种报表，可管理用户
3. **管理员（admin）**：所有功能，包括用户管理和系统设置

---

## 🔐 角色权限定义

### 1. 管理员（admin）

**权限级别**：最高（4级）  
**人员定位**：系统管理员、医务室主任  
**核心职责**：系统管理、用户管理、数据审核

**权限列表：**
- ✅ **用户管理**
  - 添加用户
  - 编辑用户
  - 删除用户
  - 查看用户列表
  - 启用/禁用用户
  - **注意**：管理员和项目经理都有用户管理权限
- ✅ **药品管理**
  - 添加、编辑、删除药品
  - 查看药品
  - 批量导入药品
- ✅ **入库管理**
  - 新建入库单
  - 操作员签名
  - **入库复核** ✅
  - 驳回入库单
  - 查看入库单
  - 删除草稿
- ✅ **出库管理**
  - 新建出库单
  - 发放人签名
  - 查看出库单
- ✅ **报表统计**
  - 查看所有报表
  - 导出报表
  - **门诊登记报表** ✅
  - **库存报表** ✅
  - **出库报表** ✅
  - **入库报表** ✅
- ✅ **系统设置**
  - 部门管理
  - 位置管理
  - 系统配置

---

### 2. 项目经理（project_manager）

**权限级别**：高（3级）  
**人员定位**：项目经理、项目负责人  
**核心职责**：项目审核、报表查看、数据统计、用户管理

**权限列表：**
- ✅ **用户管理**
  - 添加用户
  - 编辑用户
  - 删除用户
  - 查看用户列表
  - 启用/禁用用户
- ✅ **药品管理**
  - 查看药品
  - 不能删除药品
- ✅ **入库管理**
  - 新建入库单
  - 操作员签名
  - **入库复核** ✅（核心功能）
  - **驳回入库单** ✅（核心功能）
  - 查看入库单
  - 删除草稿
- ✅ **出库管理**
  - 查看出库单
  - 不能新建出库单
- ✅ **报表统计**
  - 查看所有报表
  - 导出报表
  - **门诊登记报表** ✅
  - **库存报表** ✅
  - **出库报表** ✅
  - **入库报表** ✅
- ❌ **系统设置**
  - 无系统设置权限

---

### 3. 医生（doctor）

**权限级别**：中（2级）  
**人员定位**：医生、医护人员  
**核心职责**：日常诊疗、查看数据

**权限列表：**
- ❌ **用户管理**
  - 无用户管理权限
- ✅ **药品管理**
  - 查看药品
  - 不能添加、编辑、删除药品
- ✅ **入库管理**
  - 查看入库单
  - **不能新建入库单** ❌
  - **不能操作员签名** ❌
  - **不能入库复核** ❌
  - **不能驳回入库单** ❌
- ✅ **出库管理**
  - 查看出库单
  - 不能新建出库单
- ✅ **报表统计**
  - 查看基础报表
  - 不能查看详细报表
  - **不能查看门诊登记报表** ❌
  - **不能查看库存报表** ❌
  - **不能查看出库报表** ❌
  - **不能查看入库报表** ❌
- ❌ **系统设置**
  - 无系统设置权限

---

## 📊 权限矩阵表

| 功能模块 | 管理员 | 项目经理 | 医生 | 说明 |
|---------|--------|----------|------|------|
| **用户管理** |
| 添加用户 | ✅ | ✅ | ❌ | 管理员和项目经理 |
| 编辑用户 | ✅ | ✅ | ❌ | 管理员和项目经理 |
| 删除用户 | ✅ | ✅ | ❌ | 管理员和项目经理 |
| 查看用户列表 | ✅ | ✅ | ❌ | 管理员和项目经理 |
| **药品管理** |
| 添加药品 | ✅ | ❌ | ❌ | 管理员和药房人员 |
| 编辑药品 | ✅ | ❌ | ❌ | 管理员和药房人员 |
| 删除药品 | ✅ | ❌ | ❌ | 仅管理员 |
| 查看药品 | ✅ | ✅ | ✅ | 所有人 |
| **入库管理** |
| 新建入库单 | ✅ | ✅ | ❌ | 管理员和项目经理 |
| 操作员签名 | ✅ | ✅ | ❌ | 管理员和项目经理 |
| **入库复核** | ✅ | ✅ | ❌ | **核心区别** |
| 驳回入库单 | ✅ | ✅ | ❌ | **核心区别** |
| 查看入库单 | ✅ | ✅ | ✅ | 所有人 |
| 删除草稿 | ✅ | ✅ | ❌ | 管理员和项目经理 |
| **报表统计** |
| 门诊登记报表 | ✅ | ✅ | ❌ | **核心区别** |
| 库存报表 | ✅ | ✅ | ❌ | **核心区别** |
| 出库报表 | ✅ | ✅ | ❌ | **核心区别** |
| 入库报表 | ✅ | ✅ | ❌ | **核心区别** |
| 基础报表 | ✅ | ✅ | ✅ | 所有人 |
| **系统设置** |
| 系统配置 | ✅ | ❌ | ❌ | 仅管理员 |

---

## 🔧 技术实现

### 1. 权限配置文件更新

**文件：** `utils/permission.js`

#### **新增角色定义：**
```javascript
const ROLES = {
  ADMIN: 'admin',              // 管理员
  PROJECT_MANAGER: 'project_manager', // 项目经理
  DOCTOR: 'doctor',            // 医生
  PHARMACY: 'pharmacy',        // 药房人员（保留兼容）
  VIEWER: 'viewer'              // 查看者（保留兼容）
}

const ROLE_TEXT = {
  [ROLES.ADMIN]: '管理员',
  [ROLES.PROJECT_MANAGER]: '项目经理',
  [ROLES.DOCTOR]: '医生',
  [ROLES.PHARMACY]: '药房人员',
  [ROLES.VIEWER]: '查看者'
}

const ROLE_LEVEL = {
  [ROLES.VIEWER]: 1,
  [ROLES.DOCTOR]: 2,
  [ROLES.PROJECT_MANAGER]: 3,
  [ROLES.PHARMACY]: 3,  // 保留兼容
  [ROLES.ADMIN]: 4
}
```

#### **权限配置：**
```javascript
const PERMISSIONS = {
  // 用户管理（管理员和项目经理）
  'user.create': [ROLES.ADMIN, ROLES.PROJECT_MANAGER],
  'user.update': [ROLES.ADMIN, ROLES.PROJECT_MANAGER],
  'user.delete': [ROLES.ADMIN, ROLES.PROJECT_MANAGER],
  'user.list': [ROLES.ADMIN, ROLES.PROJECT_MANAGER],
  
  // 入库管理
  'in.create': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.PHARMACY],
  'in.sign': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.PHARMACY],
  'in.review': [ROLES.ADMIN, ROLES.PROJECT_MANAGER], // 入库复核：管理员和项目经理
  'in.reject': [ROLES.ADMIN, ROLES.PROJECT_MANAGER], // 驳回：管理员和项目经理
  'in.read': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.DOCTOR, ROLES.PHARMACY, ROLES.VIEWER],
  'in.delete': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.PHARMACY],
  
  // 报表统计
  'report.read': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.PHARMACY, ROLES.VIEWER],
  'report.export': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.PHARMACY, ROLES.VIEWER],
  // 具体报表权限
  'report.clinic': [ROLES.ADMIN, ROLES.PROJECT_MANAGER], // 门诊登记报表
  'report.stock': [ROLES.ADMIN, ROLES.PROJECT_MANAGER], // 库存报表
  'report.out': [ROLES.ADMIN, ROLES.PROJECT_MANAGER],   // 出库报表
  'report.in': [ROLES.ADMIN, ROLES.PROJECT_MANAGER],    // 入库报表
}
```

#### **新增辅助函数：**
```javascript
/**
 * 检查是否可以复核（管理员或项目经理）
 */
function canReview(role) {
  return [ROLES.ADMIN, ROLES.PROJECT_MANAGER].includes(role)
}

/**
 * 检查是否可以查看报表（管理员或项目经理）
 */
function canViewReports(role) {
  return [ROLES.ADMIN, ROLES.PROJECT_MANAGER].includes(role)
}
```

---

### 2. 用户管理页面更新

**文件：** `pages-sub/setting/user-list.vue`

#### **角色选项更新：**
```javascript
roleOptions: [
  { value: 'admin', text: '管理员', desc: '拥有全部权限，包括用户管理' },
  { value: 'project_manager', text: '项目经理', desc: '有入库复核功能，可查看各种报表' },
  { value: 'doctor', text: '医生', desc: '无管理员功能，无入库复核功能' },
  { value: 'pharmacy', text: '药房人员', desc: '可进行日常出入库操作' },
  { value: 'viewer', text: '查看者', desc: '仅可查看数据' }
]
```

#### **筛选器更新：**
```javascript
roleFilter: [
  { value: 'all', text: '全部角色' },
  { value: 'admin', text: '管理员' },
  { value: 'project_manager', text: '项目经理' },
  { value: 'doctor', text: '医生' },
  { value: 'pharmacy', text: '药房人员' },
  { value: 'viewer', text: '查看者' }
]
```

---

### 3. 入库列表页面权限判断

**文件：** `pages-sub/in/list.vue`

#### **复核权限判断：**
```javascript
canReview(item) {
  // 待复核的单据，且不是自己创建的，且当前用户有复核权限
  if (item.status !== 'pending_review' || item.operatorId === this.currentUserId) {
    return false
  }
  
  // 检查用户角色是否有复核权限（管理员或项目经理）
  const userInfo = uni.getStorageSync('userInfo')
  const userRole = userInfo?.role || ''
  return userRole === 'admin' || userRole === 'project_manager'
}
```

---

## 📱 界面权限控制

### 1. 入库复核按钮显示

**入库列表页面：**
```vue
<!-- 待复核时显示操作按钮 -->
<view v-if="item.status === 'pending_review' && canReview(item)" class="record-actions">
  <u-button 
    text="去复核" 
    type="primary" 
    size="small"
    @click.stop="goReview(item._id)"
  ></u-button>
</view>
```

**判断逻辑：**
- 状态必须是 `pending_review`
- 不是自己创建的
- 用户角色是 `admin` 或 `project_manager`

---

### 2. 报表菜单显示

**首页/菜单页面：**
```vue
<!-- 报表菜单 -->
<view v-if="canViewReports(userRole)" class="menu-item">
  <text>📊 报表统计</text>
  <view class="sub-menu">
    <view v-if="hasPermission('report.clinic')" @click="goClinicReport">
      门诊登记报表
    </view>
    <view v-if="hasPermission('report.stock')" @click="goStockReport">
      库存报表
    </view>
    <view v-if="hasPermission('report.out')" @click="goOutReport">
      出库报表
    </view>
    <view v-if="hasPermission('report.in')" @click="goInReport">
      入库报表
    </view>
  </view>
</view>
```

---

### 3. 用户管理菜单显示

**设置页面：**
```vue
<!-- 用户管理（仅管理员可见） -->
<view v-if="hasPermission('user.list')" class="menu-item" @click="goUserList">
  <text>👥 用户管理</text>
</view>
```

---

## 🔄 权限验证流程

### 1. 前端权限验证

```javascript
// 使用权限工具
import { hasPermission, canReview, canViewReports } from '@/utils/permission.js'

// 检查权限
if (hasPermission(userRole, 'in.review')) {
  // 显示复核按钮
}

// 检查复核权限
if (canReview(userRole)) {
  // 显示复核功能
}

// 检查报表权限
if (canViewReports(userRole)) {
  // 显示报表菜单
}
```

### 2. 云函数权限验证

```javascript
// 云函数中验证权限
const { hasPermission } = require('./utils/permission.js')

// 检查用户权限
if (!hasPermission(user.role, 'in.review')) {
  throw new Error('权限不足，无法复核')
}
```

---

## 📋 功能检查清单

### 管理员功能
- [x] 用户管理（增删改查）
- [x] 入库复核
- [x] 所有报表查看
- [x] 系统设置

### 项目经理功能
- [x] 用户管理（增删改查） ✅
- [x] 入库复核 ✅
- [x] 门诊登记报表 ✅
- [x] 库存报表 ✅
- [x] 出库报表 ✅
- [x] 入库报表 ✅
- [ ] 无系统设置权限 ✅

### 医生功能
- [ ] 无用户管理权限 ✅
- [ ] 无入库复核功能 ✅
- [ ] 无详细报表查看 ✅
- [x] 可查看基础数据 ✅

---

## 🎯 使用示例

### 1. 创建用户

**管理员操作：**
```
1. 进入"用户管理"
2. 点击"添加用户"
3. 填写用户信息
4. 选择角色：
   - 管理员：所有功能
   - 项目经理：复核+报表
   - 医生：基础查看
5. 保存
```

### 2. 入库复核

**项目经理操作：**
```
1. 登录系统（项目经理账号）
2. 进入"入库管理"
3. 查看"待复核"标签
4. 点击待复核的入库单
5. 自动跳转到复核页面
6. 查看明细
7. 复核人签名
8. 选择：通过并入库 / 驳回
```

### 3. 查看报表

**项目经理操作：**
```
1. 登录系统（项目经理账号）
2. 进入"报表统计"
3. 查看：
   - 门诊登记报表
   - 库存报表
   - 出库报表
   - 入库报表
4. 导出报表
```

---

## ✅ 完成状态

**状态**：✅ 权限配置完成  
**功能**：✅ 三种角色权限已定义  
**代码**：✅ 权限判断逻辑已实现  
**界面**：✅ 用户管理页面已更新  

**核心改进：**
1. ✅ 新增项目经理角色
2. ✅ 新增医生角色
3. ✅ 完善权限配置
4. ✅ 更新用户管理页面
5. ✅ 实现权限判断逻辑

---

## 📝 注意事项

### 1. 角色兼容性
- 保留了 `pharmacy` 和 `viewer` 角色，确保向后兼容
- 新角色不影响现有用户

### 2. 权限验证
- 前端和云函数都需要验证权限
- 不能仅依赖前端验证

### 3. 数据安全
- 用户角色存储在云数据库
- 权限验证在云函数中执行
- 前端仅做UI控制

---

**最后更新：** 2025-11-09  
**版本：** v1.0

