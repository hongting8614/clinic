# 📡 第三方条码查询API配置指南

## 🎯 概述

由于**中国物品编码中心（GS1中国）**没有提供公开免费的API接口，我们集成了两个第三方商业API作为数据源：

1. **阿里云市场 - 商品条码查询API**（推荐）
2. **聚合数据 - 商品条码查询API**（备用）

---

## 📋 方案对比

| API服务 | 数据来源 | 价格 | 准确率 | 推荐度 |
|---------|---------|------|--------|--------|
| **阿里云市场** | 中国物品编码中心 | 约¥0.01/次 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **聚合数据** | 商品数据库 | 约¥0.02/次 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **手动录入** | 人工填写 | 免费 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

**建议**：优先配置**阿里云市场**，数据更权威。

---

## 🔧 方案1：阿里云市场（推荐）

### **1.1 购买API服务**

1. 访问阿里云市场：https://market.aliyun.com/
2. 搜索"**商品条码查询**"或"**条形码查询**"
3. 选择合适的套餐（推荐：按量付费）
4. 购买并开通服务

### **1.2 获取APPCODE**

1. 登录阿里云控制台
2. 进入**云市场** → **已购买的服务**
3. 找到条码查询API，点击**查看详情**
4. 复制 **APPCODE**（格式：`xxxxxxxxxxxxxxxxxxxxxxxx`）

### **1.3 配置云函数环境变量**

#### **在微信开发者工具中：**

1. 打开微信开发者工具
2. 点击左侧 **云开发** 图标
3. 进入 **云函数** 标签
4. 右键点击 `drugBarcodeQuery` → **云函数配置**
5. 找到 **环境变量** 部分
6. 添加：
   ```
   变量名：ALIYUN_APPCODE
   变量值：（粘贴你的APPCODE）
   ```
7. 保存配置

#### **或通过云开发控制台：**

1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入 **开发** → **云开发** → **云函数**
3. 选择 `drugBarcodeQuery` 函数
4. 点击 **版本管理** → **配置**
5. 添加环境变量：
   ```json
   {
     "ALIYUN_APPCODE": "你的APPCODE"
   }
   ```
6. 保存并重新部署

### **1.4 测试API**

```bash
# 在云函数中会自动调用，无需手动测试
# 扫码后查看云函数日志，应该显示：
✅ 阿里云条码查询API响应成功
```

---

## 🔧 方案2：聚合数据（备用）

### **2.1 注册并购买**

1. 访问聚合数据：https://www.juhe.cn/
2. 注册账号并登录
3. 搜索"**商品条码查询**"
4. 选择套餐并购买（有免费试用）

### **2.2 获取API KEY**

1. 进入 **个人中心** → **我的数据**
2. 找到"商品条码查询"服务
3. 复制 **AppKey**

### **2.3 配置云函数环境变量**

同上，添加环境变量：
```
变量名：JUHE_API_KEY
变量值：（粘贴你的AppKey）
```

---

## 🚀 部署步骤

### **步骤1：配置环境变量**

在云函数中配置至少一个API密钥（推荐阿里云）：

```
ALIYUN_APPCODE=你的阿里云APPCODE
```

或

```
JUHE_API_KEY=你的聚合数据AppKey
```

或**同时配置两个**（推荐）：

```
ALIYUN_APPCODE=你的阿里云APPCODE
JUHE_API_KEY=你的聚合数据AppKey
```

### **步骤2：上传云函数**

```
右键 cloudfunctions/drugBarcodeQuery
→ 上传并部署：云端安装依赖
```

### **步骤3：创建数据库**

```
云开发控制台
→ 数据库
→ 创建集合：drug_barcode_cache
```

### **步骤4：测试**

1. 编译小程序
2. 打开入库单页面
3. 点击"新建药品"
4. 扫描药品条形码
5. 查看是否自动填充信息

---

## 📊 查询逻辑

```
微信扫码获取条形码
    ↓
查询本地药品档案（drugs）
    ↓ 未找到
查询缓存数据库（drug_barcode_cache）
    ↓ 未找到
调用阿里云API
    ↓ 失败或未配置
调用聚合数据API
    ↓ 失败或未配置
提示手动填写
```

---

## 💰 成本估算

### **假设场景：**
- 医院每天入库 **50** 种药品
- 其中 **10** 种是新药品（需要调用API）
- 其余 **40** 种命中缓存

### **月成本：**
```
每天API调用：10次
每月API调用：10 × 30 = 300次
成本：300 × 0.01元 = 3元/月
```

**第2个月开始：**
```
缓存命中率提升到90%
每天API调用：5次
每月成本：约1.5元/月
```

**非常便宜！** 💰

---

## 🔍 测试示例

### **测试1：扫描常见药品**

条形码示例：`6901028075916`（阿莫西林）

**预期结果：**
```json
{
  "name": "阿莫西林胶囊",
  "specification": "0.25g×24粒",
  "unit": "盒",
  "manufacturer": "某某制药有限公司",
  "barcode": "6901028075916"
}
```

### **测试2：查看云函数日志**

```
开始查询条形码: 6901028075916
尝试本地药品档案...
尝试缓存数据库...
尝试阿里云条码查询API...
✅ 阿里云API响应成功
✅ 已保存到缓存数据库
```

---

## ❓ 常见问题

### Q1：不配置API密钥可以用吗？

**答案**：可以，但有限制：
- ✅ 本地已录入的药品可以识别
- ✅ 之前扫码过的药品可以识别
- ❌ 新药品无法自动识别（需要手动填写）

**建议**：配置API密钥，体验更好。

### Q2：API调用失败怎么办？

**解决方法**：
1. 检查环境变量是否配置正确
2. 检查API余额是否充足
3. 查看云函数日志排查错误
4. 如果都失败，可以手动填写

### Q3：如何降低成本？

**方法**：
1. **预先录入常用药品**（设置条形码字段）
2. **利用缓存机制**（自动保存查询结果）
3. **配置多个API**（主用+备用）

### Q4：数据准确吗？

**答案**：
- 阿里云API：⭐⭐⭐⭐⭐（数据来自官方）
- 聚合数据API：⭐⭐⭐⭐（商业数据库）
- 手动填写：⭐⭐⭐⭐⭐（最准确）

---

## 🎯 推荐方案

### **初期（第1-2周）：**
```
配置阿里云API
→ 快速建立药品条码库
→ 提升工作效率
```

### **稳定期（第3周+）：**
```
缓存命中率提升到90%+
→ API调用大幅减少
→ 成本降低
```

### **长期：**
```
本地药品档案完善
→ 基本不需要调用API
→ 接近零成本
```

---

## ✅ 快速配置步骤

### **5分钟快速配置：**

1. **购买API**（2分钟）
   - 访问阿里云市场
   - 搜索"商品条码查询"
   - 购买按量付费套餐

2. **获取密钥**（1分钟）
   - 云市场 → 已购买的服务
   - 复制APPCODE

3. **配置云函数**（2分钟）
   - 云开发 → 云函数 → drugBarcodeQuery
   - 环境变量 → 添加 ALIYUN_APPCODE
   - 保存并重新部署

**完成！** 🎉

---

## 📞 技术支持

### **阿里云市场客服：**
- 官网：https://market.aliyun.com/
- 工单系统：阿里云控制台 → 工单

### **聚合数据客服：**
- 官网：https://www.juhe.cn/
- QQ客服：见官网

---

**建议：先配置阿里云API，数据最权威！** ✅




