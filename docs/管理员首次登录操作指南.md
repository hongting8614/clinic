# 👤 管理员首次登录操作指南

## 🎯 登录方式说明

### 微信小程序自动登录

**本系统使用微信小程序自动登录，无需输入密码！**

**登录原理：**
- 通过微信小程序的 `openid` 自动识别用户
- 系统检查 `openid` 是否在用户白名单中
- 如果在白名单中，自动登录成功
- 如果不在白名单中，提示"您不在系统白名单内"

---

## 📋 管理员首次登录步骤

### 场景1：已有管理员添加您（推荐）⭐

**适用情况：**
- 系统中已有其他管理员
- 其他管理员可以添加新用户

**操作步骤：**

1. **联系现有管理员**
   - 联系系统中的现有管理员
   - 提供您的微信 `openid`

2. **管理员添加您**
   - 现有管理员进入 **"我的"** → **"用户管理"**
   - 点击 **"添加用户"**
   - 填写您的信息：
     - **用户OpenID**：您的微信 `openid`（必填）
     - **姓名**：您的姓名（必填）
     - **实名**：您的真实姓名，2-10个中文字符（必填）
     - **手机号**：您的手机号（必填）
     - **角色**：选择 **"管理员"**
     - **初始密码**：可选（如果设置，您可以使用该密码；如果不设置，首次登录后需要设置密码）

3. **打开小程序**
   - 打开微信小程序
   - 系统自动通过 `openid` 识别您
   - 自动登录成功

4. **首次登录后操作**
   - 如果设置了初始密码：可以直接使用
   - 如果没有设置密码：建议立即设置密码
   - 进入 **"我的"** → **"系统设置"** → **"修改密码"**
   - 设置您的密码（不少于8位，包含大小写字母和数字）

---

### 场景2：第一个管理员（系统初始化）

**适用情况：**
- 系统刚部署，还没有任何管理员
- 需要创建第一个管理员账号

**操作步骤：**

#### 方法1：通过数据库手动添加（推荐）⭐

1. **获取您的微信 `openid`**
   - 打开微信开发者工具
   - 打开小程序项目
   - 在控制台输入：`wx.getUserInfo()` 或查看云函数日志
   - 复制您的 `openid`

2. **在数据库中手动添加管理员**
   - 打开云开发控制台
   - 进入 **"数据库"** → **"users"** 集合
   - 点击 **"添加记录"**
   - 填写以下信息：
     ```json
     {
       "openid": "您的openid",
       "name": "管理员姓名",
       "realName": "管理员实名",
       "nickname": "管理员昵称",
       "phone": "13800138000",
       "wechatId": "",
       "role": "admin",
       "password": null,  // 首次登录后设置
       "status": "active",
       "createTime": "当前时间",
       "updateTime": "当前时间",
       "lastLogin": null
     }
     ```

3. **打开小程序**
   - 打开微信小程序
   - 系统自动识别您的 `openid`
   - 自动登录成功

4. **设置密码**
   - 进入 **"我的"** → **"系统设置"** → **"修改密码"**
   - 设置您的密码（首次登录，当前密码可以为空）

---

#### 方法2：通过云函数添加（需要技术能力）

1. **调用 `addUser` 云函数**
   - 在微信开发者工具中调用云函数
   - 传入您的信息
   - 注意：需要先有一个管理员账号才能调用此云函数

---

## 🔍 如何获取微信 OpenID

### 方法1：微信开发者工具控制台

1. 打开微信开发者工具
2. 打开小程序项目
3. 在控制台输入：
   ```javascript
   wx.cloud.callFunction({
     name: 'login',
     success: res => {
       console.log('OpenID:', res.result.openid)
     }
   })
   ```

### 方法2：查看云函数日志

1. 打开云开发控制台
2. 进入 **"云函数"** → **"login"**
3. 查看云函数日志
4. 日志中会显示 `openid`

### 方法3：小程序代码中获取

在任意页面中：
```javascript
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('OpenID:', res.result.openid)
    // 或者查看返回的错误信息中的openid
  }
})
```

---

## 📝 首次登录后必做事项

### 1. 设置密码（如果未设置）

**操作步骤：**
1. 进入 **"我的"** → **"系统设置"** → **"修改密码"**
2. 当前密码：留空（首次设置）
3. 新密码：输入您的密码（不少于8位，包含大小写字母和数字）
4. 确认新密码：再次输入
5. 点击 **"确认修改"**

**密码要求：**
- ✅ 不少于8位
- ✅ 包含至少一个大写字母（A-Z）
- ✅ 包含至少一个小写字母（a-z）
- ✅ 包含至少一个数字（0-9）

**示例密码：**
- `Admin123` ✅
- `Password2024` ✅
- `MyPass123` ✅

---

### 2. 设置实名（如果未设置）

**操作步骤：**
1. 进入 **"我的"** → **"系统设置"**
2. 在 **"实名"** 旁边点击 **"修改"** 按钮
3. 输入真实姓名（2-10个中文字符）
4. 点击 **"确认修改"**

---

### 3. 设置微信号（用于密码重置）

**操作步骤：**
1. 进入 **"我的"** → **"系统设置"** → **"用户管理"**
2. 找到自己的账号
3. 点击 **"编辑"**
4. 设置微信号（6-20个字符，字母、数字、下划线、减号）
5. 保存

**注意：**
- 微信号用于密码重置功能
- 如果忘记密码，可以通过微信号重置密码

---

## ⚠️ 常见问题

### 问题1：提示"您不在系统白名单内"

**原因：**
- 您的 `openid` 不在 `users` 表中
- 或者您的账号状态为 `inactive`（已禁用）

**解决方法：**
1. 联系现有管理员添加您的账号
2. 或者通过数据库手动添加您的账号
3. 确保账号状态为 `active`

---

### 问题2：登录失败

**原因：**
- 云函数未上传
- 网络问题
- 云开发环境配置错误

**解决方法：**
1. 检查云函数是否已上传
2. 检查网络连接
3. 检查云开发环境ID是否正确

---

### 问题3：无法获取 OpenID

**原因：**
- 未在微信开发者工具中运行
- 云开发未初始化

**解决方法：**
1. 确保在微信开发者工具中运行
2. 确保云开发已初始化
3. 检查 `App.vue` 中的云开发环境ID

---

## 🎯 快速开始（5分钟）

### 如果您是第一个管理员：

1. **获取 OpenID**（1分钟）
   - 在微信开发者工具控制台获取

2. **在数据库中添加管理员**（2分钟）
   - 打开云开发控制台
   - 在 `users` 集合中添加记录
   - 设置 `role: "admin"`

3. **打开小程序**（1分钟）
   - 自动登录成功

4. **设置密码**（1分钟）
   - 进入设置 → 修改密码
   - 设置您的密码

---

## 📊 登录流程

```
1. 打开微信小程序
   ↓
2. 系统获取微信 openid
   ↓
3. 调用 login 云函数
   ↓
4. 查询 users 表
   - 如果找到：登录成功
   - 如果未找到：提示"不在白名单内"
   ↓
5. 保存用户信息到本地
   ↓
6. 显示用户信息
   ↓
7. 可以使用系统功能
```

---

## ✅ 登录成功标志

**登录成功后，您会看到：**
- ✅ "我的"页面显示您的真实姓名和角色
- ✅ 可以访问所有功能菜单
- ✅ 可以进入用户管理页面（管理员）
- ✅ 系统提示"登录成功"

---

## 🔐 安全建议

1. **首次登录后立即设置密码**
   - 使用强密码（8位+大小写+数字）
   - 不要使用简单密码

2. **设置实名**
   - 用于系统实名认证
   - 便于管理

3. **设置微信号**
   - 用于密码重置功能
   - 忘记密码时可以重置

4. **定期修改密码**
   - 建议每3个月修改一次密码
   - 提高账户安全性

---

## 📞 需要帮助？

如果遇到问题：
1. 检查云函数是否已上传
2. 检查数据库中的用户记录
3. 检查用户状态是否为 `active`
4. 查看云函数日志，查看错误信息

---

**最后更新：** 2025-11-09  
**版本：** v1.0

