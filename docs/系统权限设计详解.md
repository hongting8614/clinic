# 🔐 爱康医疗药材管理系统 - 权限设计详解

## 📊 角色定义

### 角色列表

| 角色代码 | 角色名称 | 权限级别 | 说明 |
|---------|---------|---------|------|
| `admin` | 管理员 | 4 | 最高权限，可管理所有功能 |
| `project_manager` | 项目经理 | 3 | 管理权限，可复核、查看报表 |
| `pharmacy` | 药房人员 | 3 | 操作权限，可创建单据 |
| `doctor` | 医生 | 2 | 查看权限，可查看入库记录 |
| `viewer` | 查看者 | 1 | 只读权限，仅查看 |

---

## 🎯 核心功能权限对照表

### 1. 入库管理权限

| 功能 | 管理员 | 项目经理 | 药房人员 | 医生 | 查看者 |
|------|--------|---------|---------|------|--------|
| **创建入库单** | ✅ | ❌ | ✅ | ✅ | ❌ |
| **签名确认** | ✅ | ❌ | ✅ | ✅ | ❌ |
| **复核入库单** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **驳回入库单** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **查看入库单** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **删除草稿** | ✅ | ❌ | ✅ | ✅ | ❌ |

**权限代码：**
```javascript
'in.create': [ROLES.ADMIN, ROLES.DOCTOR, ROLES.PHARMACY]  // 创建：管理员、医生、药房
'in.sign': [ROLES.ADMIN, ROLES.DOCTOR, ROLES.PHARMACY]    // 签名：管理员、医生、药房
'in.review': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]         // 复核：管理员、项目经理
'in.reject': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]         // 驳回：管理员、项目经理
'in.read': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.DOCTOR, ROLES.PHARMACY, ROLES.VIEWER]
'in.delete': [ROLES.ADMIN, ROLES.DOCTOR, ROLES.PHARMACY]  // 删除草稿：管理员、医生、药房
```

**关键说明：**
- ✅ **项目经理有复核权限，但不能创建入库单**（职责分离）
- ✅ **医生可以创建入库单，但不能复核**
- ✅ 复核人必须与操作员不是同一人

---

### 2. 出库管理权限

| 功能 | 管理员 | 项目经理 | 药房人员 | 医生 | 查看者 |
|------|--------|---------|---------|------|--------|
| **创建出库单** | ✅ | ❌ | ✅ | ❌ | ❌ |
| **签名确认** | ✅ | ❌ | ✅ | ❌ | ❌ |
| **查看出库单** | ✅ | ❌ | ✅ | ❌ | ✅ |

**权限代码：**
```javascript
'out.create': [ROLES.ADMIN, ROLES.PHARMACY]
'out.sign': [ROLES.ADMIN, ROLES.PHARMACY]
'out.read': [ROLES.ADMIN, ROLES.PHARMACY, ROLES.VIEWER]
```

---

### 3. 用户管理权限

| 功能 | 管理员 | 项目经理 | 药房人员 | 医生 | 查看者 |
|------|--------|---------|---------|------|--------|
| **创建用户** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **编辑用户** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **删除用户** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **查看用户列表** | ✅ | ✅ | ❌ | ❌ | ❌ |

**权限代码：**
```javascript
'user.create': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
'user.update': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
'user.delete': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
'user.list': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
```

---

### 4. 药材管理权限

| 功能 | 管理员 | 项目经理 | 药房人员 | 医生 | 查看者 |
|------|--------|---------|---------|------|--------|
| **创建药材** | ✅ | ❌ | ✅ | ❌ | ❌ |
| **编辑药材** | ✅ | ❌ | ✅ | ❌ | ❌ |
| **删除药材** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **查看药材** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **导入药材** | ✅ | ❌ | ❌ | ❌ | ❌ |

**权限代码：**
```javascript
'drug.create': [ROLES.ADMIN, ROLES.PHARMACY]
'drug.update': [ROLES.ADMIN, ROLES.PHARMACY]
'drug.delete': [ROLES.ADMIN]
'drug.read': [ROLES.ADMIN, ROLES.PHARMACY, ROLES.VIEWER]
'drug.import': [ROLES.ADMIN]
```

---

### 5. 报表统计权限

| 功能 | 管理员 | 项目经理 | 药房人员 | 医生 | 查看者 |
|------|--------|---------|---------|------|--------|
| **查看报表** | ✅ | ✅ | ✅ | ❌ | ✅ |
| **导出报表** | ✅ | ✅ | ✅ | ❌ | ✅ |
| **门诊登记报表** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **库存报表** | ✅ | ✅ | ❌ | ❌ | ❌ |
| **出入库报表** | ✅ | ✅ | ❌ | ❌ | ❌ |

**权限代码：**
```javascript
'report.read': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.PHARMACY, ROLES.VIEWER]
'report.export': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.PHARMACY, ROLES.VIEWER]
'report.clinic': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
'report.stock': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
'report.out': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
'report.in': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
```

---

### 6. 其他业务权限

| 功能模块 | 管理员 | 项目经理 | 药房人员 | 医生 | 查看者 |
|---------|--------|---------|---------|------|--------|
| **调拨管理** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **消耗管理** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **请领管理** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **盘点管理** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **报损管理** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **退货管理** | ✅ | ❌ | ✅ | ❌ | ✅ |
| **库存查询** | ✅ | ❌ | ✅ | ❌ | ✅ |

---

### 7. 系统设置权限

| 功能 | 管理员 | 项目经理 | 药房人员 | 医生 | 查看者 |
|------|--------|---------|---------|------|--------|
| **部门管理** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **地点管理** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **系统配置** | ✅ | ❌ | ❌ | ❌ | ❌ |
| **数据备份** | ✅ | ❌ | ❌ | ❌ | ❌ |

**权限代码：**
```javascript
'system.dept': [ROLES.ADMIN]
'system.location': [ROLES.ADMIN]
'system.config': [ROLES.ADMIN]
'system.backup': [ROLES.ADMIN]
```

---

## 🔑 权限验证函数

### 1. 基础权限检查

```javascript
// 检查用户是否有指定权限
hasPermission(userRole, 'in.review')

// 示例
hasPermission('project_manager', 'in.review')  // true
hasPermission('doctor', 'in.review')           // false
```

### 2. 角色级别检查

```javascript
// 检查角色级别
checkRoleLevel(userRole, requiredRole)

// 示例
checkRoleLevel('admin', 'project_manager')     // true (4 >= 3)
checkRoleLevel('doctor', 'project_manager')    // false (2 < 3)
```

### 3. 快捷检查函数

```javascript
// 是否为管理员
isAdmin(role)                    // role === 'admin'

// 是否可操作（管理员、项目经理或药房人员）
canOperate(role)                 // 可创建单据

// 是否可复核（管理员或项目经理）
canReview(role)                  // 可复核入库单

// 是否可查看报表（管理员或项目经理）
canViewReports(role)             // 可查看报表
```

---

## 📋 典型场景权限说明

### 场景1：入库单复核流程

**角色权限：**
1. ✅ **管理员** - 可创建、可复核
2. ⚠️ **项目经理** - 不可创建、可复核（专职复核）
3. ✅ **医生** - 可创建、不可复核
4. ✅ **药房人员** - 可创建、不可复核
5. ❌ **查看者** - 不可创建、不可复核（只能查看）

**业务规则：**
- ✅ 复核人必须与操作员不是同一人
- ✅ 只有"待复核"状态的入库单才能复核
- ✅ 复核通过后，入库单状态变为"已完成"
- ✅ 驳回后，入库单状态变为"已驳回"

**权限验证代码：**
```javascript
// 检查是否可以复核
if (!canReview(user.role)) {
  return { success: false, message: '权限不足' }
}

// 检查是否为同一人
if (record.operatorId === reviewerId) {
  return { success: false, message: '不能复核自己创建的入库单' }
}
```

---

### 场景2：用户管理

**角色权限：**
1. ✅ **管理员** - 可管理所有用户
2. ✅ **项目经理** - 可管理所有用户
3. ❌ **其他角色** - 无权限

**业务规则：**
- ✅ 可创建、编辑、删除用户
- ✅ 可设置用户角色
- ✅ 可启用/禁用用户

---

### 场景3：报表查看

**角色权限：**
1. ✅ **管理员** - 可查看所有报表
2. ✅ **项目经理** - 可查看所有报表
3. ⚠️ **药房人员** - 可查看基础报表，不可查看门诊、库存等高级报表
4. ❌ **医生** - 无报表权限
5. ✅ **查看者** - 可查看基础报表

---

## 🎯 权限设计原则

### 1. 最小权限原则
- 每个角色只拥有完成其工作所需的最小权限
- 避免权限过度授予

### 2. 职责分离原则
- 创建和复核由不同角色完成
- 避免一人既创建又复核

### 3. 层级管理原则
- 权限级别：管理员 > 项目经理 = 药房人员 > 医生 > 查看者
- 高级别角色拥有低级别角色的所有权限

### 4. 灵活扩展原则
- 权限配置集中管理
- 易于添加新角色和新权限

---

## 🔧 如何修改权限

### 修改文件：`utils/permission.js`

### 示例1：给医生添加复核权限

```javascript
// 修改前
'in.review': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]

// 修改后
'in.review': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.DOCTOR]
```

### 示例2：添加新权限

```javascript
// 在 PERMISSIONS 对象中添加
'newFeature.create': [ROLES.ADMIN, ROLES.PROJECT_MANAGER]
'newFeature.read': [ROLES.ADMIN, ROLES.PROJECT_MANAGER, ROLES.VIEWER]
```

### 示例3：添加新角色

```javascript
// 1. 在 ROLES 中添加
const ROLES = {
  // ... 现有角色
  NURSE: 'nurse'  // 新增护士角色
}

// 2. 在 ROLE_TEXT 中添加
const ROLE_TEXT = {
  // ... 现有文本
  [ROLES.NURSE]: '护士'
}

// 3. 在 ROLE_LEVEL 中添加
const ROLE_LEVEL = {
  // ... 现有级别
  [ROLES.NURSE]: 2  // 设置权限级别
}

// 4. 在 PERMISSIONS 中配置权限
'某功能': [ROLES.ADMIN, ROLES.NURSE]
```

---

## 📝 权限验证示例代码

### 前端验证

```javascript
import { hasPermission, canReview } from '@/utils/permission.js'

// 获取当前用户
const userInfo = uni.getStorageSync('userInfo')

// 检查是否可以复核
if (canReview(userInfo.role)) {
  // 显示复核按钮
  this.showReviewButton = true
}

// 检查具体权限
if (hasPermission(userInfo.role, 'in.review')) {
  // 允许复核操作
}
```

### 云函数验证

```javascript
const { hasPermission, canReview } = require('./permission.js')

// 在云函数中验证权限
async function reviewInRecord(data, wxContext) {
  // 获取用户信息
  const user = await getUserByOpenId(wxContext.OPENID)
  
  // 验证权限
  if (!canReview(user.role)) {
    return {
      success: false,
      message: '权限不足，无法复核'
    }
  }
  
  // 执行复核逻辑
  // ...
}
```

---

## ✅ 权限检查清单

### 开发新功能时的权限检查

- [ ] 确定哪些角色可以访问此功能
- [ ] 在 `PERMISSIONS` 中添加权限配置
- [ ] 在前端页面添加权限验证
- [ ] 在云函数中添加权限验证
- [ ] 测试各角色的访问权限
- [ ] 更新权限文档

---

**最后更新：** 2025年11月10日  
**维护者：** 系统管理员

