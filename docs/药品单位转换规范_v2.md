# è¯æå•ä½è½¬æ¢è§„èŒƒ v2.0

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### ä¸¤çº§åº“å­˜ç®¡ç†ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      è½¬æ¢      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ€»åº“æˆ¿ï¼ˆä»“åº“ï¼‰  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚  å›­åŒºåº“å­˜ï¼ˆè¯æˆ¿ï¼‰ â”‚
â”‚  æ•´åŒ…è£…å•ä½      â”‚               â”‚  æœ€å°å•ä½         â”‚
â”‚  ç›’/ç“¶/è¢‹        â”‚               â”‚  ç‰‡/ç²’/æ”¯/ml      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸå› 

**ä¸ºä»€ä¹ˆæ€»åº“ç”¨æ•´åŒ…è£…ï¼Ÿ**
- âœ… ç¬¦åˆé‡‡è´­ä¹ æƒ¯ï¼ˆæ‰¹å‘å•†æŒ‰ç›’ä¾›è´§ï¼‰
- âœ… ä¾¿äºç›˜ç‚¹æ¸…ç®—ï¼ˆæ•°ç›’æ¯”æ•°ç²’å¿«ï¼‰
- âœ… å‡å°‘è¯¯å·®ï¼ˆæŒ‰ç›’è®°å½•æ›´å‡†ç¡®ï¼‰
- âœ… æ˜“äºç®¡ç†ï¼ˆè§„æ ¼ç»Ÿä¸€ï¼‰

**ä¸ºä»€ä¹ˆå›­åŒºç”¨æœ€å°å•ä½ï¼Ÿ**
- âœ… ç¬¦åˆä¸´åºŠä½¿ç”¨ï¼ˆåŒ»ç”Ÿå¼€"å‡ ç‰‡"ä¸å¼€"å‡ ç›’"ï¼‰
- âœ… ç²¾ç¡®æ¶ˆè€—ç»Ÿè®¡ï¼ˆå‡†ç¡®åˆ°æ¯ç‰‡æ¯ç²’ï¼‰
- âœ… é—¨è¯Šç™»è®°æ–¹ä¾¿ï¼ˆç›´æ¥è¾“å…¥ä½¿ç”¨æ•°é‡ï¼‰
- âœ… é¿å…æµªè´¹ï¼ˆæ‹†é›¶ä½¿ç”¨æ›´çµæ´»ï¼‰

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
                        è¯æç”Ÿå‘½å‘¨æœŸå•ä½è½¬æ¢æµç¨‹
                        
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  1ï¸âƒ£ å…¥åº“ï¼ˆæ€»åº“æˆ¿ï¼‰                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ“¦ é‡‡è´­å…¥åº“ï¼š50ç›’ï¼ˆæ•´åŒ…è£…ï¼‰                    â”‚             â”‚
â”‚  â”‚ è§„æ ¼ï¼šé˜¿è«è¥¿æ—èƒ¶å›Š 0.25g*24ç²’/ç›’               â”‚             â”‚
â”‚  â”‚ æ‰¹æ¬¡ï¼šBATCH20251104                           â”‚             â”‚
â”‚  â”‚ æœ‰æ•ˆæœŸï¼š2027-11-04                            â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                      â†“                                          â”‚
â”‚              ğŸ“Š æ€»åº“æˆ¿åº“å­˜                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚         â”‚ é˜¿è«è¥¿æ—èƒ¶å›Š          â”‚                              â”‚
â”‚         â”‚ åº“å­˜ï¼š50 ç›’           â”‚ â† æ•´åŒ…è£…å•ä½                  â”‚
â”‚         â”‚ BATCH20251104         â”‚                              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                      â†“                                          â”‚
â”‚  2ï¸âƒ£ å‡ºåº“åˆ°å›­åŒºï¼ˆå•ä½è½¬æ¢å‘ç”Ÿï¼‰                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ“¤ å‡ºåº“ï¼š10ç›’ â†’ é™†å›­                           â”‚             â”‚
â”‚  â”‚ è½¬æ¢ï¼š10ç›’ Ã— 24ç²’/ç›’ = 240ç²’                   â”‚ â† ğŸ”¥ è½¬æ¢ç‚¹ â”‚
â”‚  â”‚ æ‰¹æ¬¡ï¼šBATCH20251104                           â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                      â†“                                          â”‚
â”‚              ğŸ“Š åº“å­˜å˜åŒ–                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚         â”‚ æ€»åº“æˆ¿ï¼ˆclinic_storageï¼‰â”‚    â”‚ é™†å›­ï¼ˆland_parkï¼‰     â”‚ â”‚
â”‚         â”‚ é˜¿è«è¥¿æ—ï¼š40 ç›’       â”‚    â”‚ é˜¿è«è¥¿æ—ï¼š240 ç²’      â”‚ â”‚
â”‚         â”‚  â†“ -10ç›’             â”‚    â”‚  â†‘ +240ç²’            â”‚ â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â†“                  â”‚
â”‚  3ï¸âƒ£ é—¨è¯Šä½¿ç”¨ï¼ˆç›´æ¥æ‰£å‡æœ€å°å•ä½ï¼‰                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ’Š é—¨è¯Šç™»è®°                                    â”‚             â”‚
â”‚  â”‚ æ‚£è€…ï¼šå¼ ä¸‰                                     â”‚             â”‚
â”‚  â”‚ è¯Šæ–­ï¼šä¸Šå‘¼å¸é“æ„ŸæŸ“                             â”‚             â”‚
â”‚  â”‚ ç”¨è¯ï¼šé˜¿è«è¥¿æ—èƒ¶å›Š 6ç²’                         â”‚ â† æœ€å°å•ä½  â”‚
â”‚  â”‚ å›­åŒºï¼šé™†å›­                                     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                      â†“                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚         â”‚ é™†å›­åº“å­˜              â”‚                              â”‚
â”‚         â”‚ é˜¿è«è¥¿æ—ï¼š234 ç²’      â”‚ â† ç›´æ¥æ‰£å‡6ç²’                 â”‚
â”‚         â”‚  â†“ -6ç²’              â”‚                              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¢ æ•°æ®ç»“æ„è®¾è®¡

### 1. è¯ææ¡£æ¡ˆï¼ˆdrugs è¡¨ï¼‰

```javascript
{
  _id: "drug_001",
  name: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25g*24ç²’",
  
  // å•ä½ä¿¡æ¯
  packUnit: "ç›’",           // åŒ…è£…å•ä½ï¼ˆæ€»åº“ç”¨ï¼‰
  minUnit: "ç²’",            // æœ€å°å•ä½ï¼ˆå›­åŒºç”¨ï¼‰
  conversionRate: 24,       // æ¢ç®—ç‡ï¼š1ç›’ = 24ç²’
  
  manufacturer: "XXåˆ¶è¯",
  barcode: "6901234567890",
  category: "æŠ—ç”Ÿç´ ",
  
  // åº“å­˜é¢„è­¦ï¼ˆæŒ‰åŒ…è£…å•ä½ï¼‰
  safeStock: 100,           // å®‰å…¨åº“å­˜ï¼š100ç›’
  minStock: 50              // æœ€ä½åº“å­˜ï¼š50ç›’
}
```

### 2. åº“å­˜è¡¨ï¼ˆstock è¡¨ï¼‰

**å…³é”®å­—æ®µï¼šlocation**
- `clinic_storage`ï¼šæ€»åº“æˆ¿ï¼ˆæ•´åŒ…è£…å•ä½ï¼‰
- `land_park`ï¼šé™†å›­ï¼ˆæœ€å°å•ä½ï¼‰
- `water_park`ï¼šæ°´å›­ï¼ˆæœ€å°å•ä½ï¼‰

```javascript
// æ€»åº“æˆ¿åº“å­˜è®°å½•
{
  _id: "stock_001",
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25g*24ç²’",
  batch: "BATCH20251104",
  
  location: "clinic_storage",  // æ€»åº“æˆ¿
  quantity: 50,                // 50ç›’ï¼ˆæ•´åŒ…è£…ï¼‰
  unit: "ç›’",                  // åŒ…è£…å•ä½
  
  productionDate: "2025-01-01",
  expiryDate: "2027-11-04",
  price: 25.50,
  createTime: ISODate(),
  updateTime: ISODate()
}

// é™†å›­åº“å­˜è®°å½•
{
  _id: "stock_002",
  drugId: "drug_001",
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25g*24ç²’",
  batch: "BATCH20251104",
  
  location: "land_park",       // é™†å›­
  quantity: 240,               // 240ç²’ï¼ˆæœ€å°å•ä½ï¼‰
  unit: "ç²’",                  // æœ€å°å•ä½
  
  // å…³è”ä¿¡æ¯
  sourceBatch: "BATCH20251104",  // æ¥æºæ‰¹æ¬¡
  sourceRecordId: "out_xxx",     // æ¥æºå‡ºåº“å•
  
  productionDate: "2025-01-01",
  expiryDate: "2027-11-04",
  price: 1.0625,              // å•ä»·éœ€æ¢ç®—ï¼š25.50/24 = 1.0625å…ƒ/ç²’
  createTime: ISODate(),
  updateTime: ISODate()
}
```

---

## ğŸ”„ å„æ¨¡å—å®ç°ç»†èŠ‚

### æ¨¡å—1ï¼šå…¥åº“ç®¡ç† âœ…

**å•ä½ï¼šæ•´åŒ…è£…**

```javascript
// å‰ç«¯ - pages-sub/in/add.vue
{
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  specification: "0.25g*24ç²’",
  quantity: 50,           // è¾“å…¥ï¼š50ç›’
  unit: "ç›’",             // æ˜¾ç¤ºï¼šç›’
  batch: "BATCH20251104",
  productionDate: "2025-01-01",
  expiryDate: "2027-11-04",
  price: 25.50            // å•ä»·ï¼š25.50å…ƒ/ç›’
}

// åç«¯ - cloudfunctions/inRecords/index.js
// å®¡æ ¸é€šè¿‡åï¼Œå¢åŠ æ€»åº“æˆ¿åº“å­˜
await db.collection('stock').add({
  data: {
    drugId: item.drugId,
    drugName: item.drugName,
    specification: item.specification,
    batch: item.batch,
    location: 'clinic_storage',  // æ€»åº“æˆ¿
    quantity: item.quantity,      // 50ç›’ï¼ˆæ•´åŒ…è£…ï¼‰
    unit: item.unit,              // ç›’
    productionDate: item.productionDate,
    expiryDate: item.expiryDate,
    price: item.price,
    createTime: now,
    updateTime: now
  }
});
```

---

### æ¨¡å—2ï¼šå‡ºåº“åˆ°å›­åŒº ğŸ”¥ æ ¸å¿ƒè½¬æ¢ç‚¹

**è¾“å…¥ï¼šæ•´åŒ…è£… â†’ è½¬æ¢ â†’ è¾“å‡ºï¼šæœ€å°å•ä½**

```javascript
// å‰ç«¯ - pages-sub/out/add.vue
// UIç•Œé¢
<view class="form-item">
  <text class="label">å‡ºåº“æ•°é‡ *</text>
  <input 
    v-model.number="item.quantity" 
    type="number"
    placeholder="è¯·è¾“å…¥æ•°é‡"
  />
  <text class="unit">{{ item.unit }}</text>  <!-- æ˜¾ç¤º"ç›’" -->
</view>

// ç”¨æˆ·è¾“å…¥ï¼š10ç›’
// æ˜¾ç¤ºè½¬æ¢æç¤º
<view class="convert-hint" v-if="item.conversionRate">
  ğŸ’¡ çº¦ç­‰äº {{ item.quantity * item.conversionRate }} {{ item.minUnit }}
  <!-- æ˜¾ç¤ºï¼šğŸ’¡ çº¦ç­‰äº 240 ç²’ -->
</view>

// æ•°æ®ç»“æ„
{
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  batch: "BATCH20251104",
  location: "land_park",         // ç›®æ ‡å›­åŒº
  
  // åŸå§‹è¾“å…¥ï¼ˆæ•´åŒ…è£…ï¼‰
  quantity: 10,                  // 10ç›’
  unit: "ç›’",                    // åŒ…è£…å•ä½
  
  // è½¬æ¢ä¿¡æ¯
  conversionRate: 24,            // 1ç›’ = 24ç²’
  minUnit: "ç²’",                 // æœ€å°å•ä½
  quantityMin: 240               // è½¬æ¢åï¼š240ç²’
}
```

```javascript
// åç«¯ - cloudfunctions/outRecords/index.js
async function completeOutRecord(recordId, reviewerSign, reviewerSignTime) {
  const record = await db.collection('out_records').doc(recordId).get();
  const items = record.data.items;
  const targetLocation = record.data.location;  // ç›®æ ‡å›­åŒº
  
  for (const item of items) {
    // 1. ä»æ€»åº“æˆ¿æ‰£å‡ï¼ˆæ•´åŒ…è£…ï¼‰
    await db.collection('stock')
      .where({
        drugId: item.drugId,
        batch: item.batch,
        location: 'clinic_storage'  // æ€»åº“æˆ¿
      })
      .update({
        data: {
          quantity: _.inc(-item.quantity),  // æ‰£å‡10ç›’
          updateTime: now
        }
      });
    
    // 2. ğŸ”¥ å•ä½è½¬æ¢ï¼šæ•´åŒ…è£… â†’ æœ€å°å•ä½
    const quantityMin = item.quantity * item.conversionRate;  // 10 Ã— 24 = 240ç²’
    const priceMin = item.price / item.conversionRate;        // 25.50 / 24 = 1.0625å…ƒ/ç²’
    
    // 3. å¢åŠ å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰
    // æŸ¥è¯¢å›­åŒºæ˜¯å¦å·²æœ‰è¯¥æ‰¹æ¬¡
    const parkStock = await db.collection('stock')
      .where({
        drugId: item.drugId,
        batch: item.batch,
        location: targetLocation
      })
      .get();
    
    if (parkStock.data.length > 0) {
      // å·²å­˜åœ¨ï¼Œç´¯åŠ 
      await db.collection('stock').doc(parkStock.data[0]._id).update({
        data: {
          quantity: _.inc(quantityMin),  // +240ç²’
          updateTime: now
        }
      });
    } else {
      // ä¸å­˜åœ¨ï¼Œæ–°å¢
      await db.collection('stock').add({
        data: {
          drugId: item.drugId,
          drugName: item.drugName,
          specification: item.specification,
          batch: item.batch,
          location: targetLocation,     // é™†å›­/æ°´å›­
          quantity: quantityMin,        // 240ç²’ï¼ˆæœ€å°å•ä½ï¼‰
          unit: item.minUnit,           // ç²’
          productionDate: item.productionDate,
          expiryDate: item.expiryDate,
          price: priceMin,              // 1.0625å…ƒ/ç²’
          sourceBatch: item.batch,
          sourceRecordId: recordId,
          createTime: now,
          updateTime: now
        }
      });
    }
  }
  
  // æ›´æ–°å‡ºåº“å•çŠ¶æ€
  await db.collection('out_records').doc(recordId).update({
    data: {
      status: 'completed',
      reviewerSign,
      reviewerSignTime,
      completeTime: now,
      updateTime: now
    }
  });
  
  return { success: true, message: 'å‡ºåº“å®Œæˆ' };
}
```

---

### æ¨¡å—3ï¼šé—¨è¯Šç™»è®° âœ…

**å•ä½ï¼šæœ€å°å•ä½ï¼ˆç›´æ¥æ‰£å‡ï¼Œæ— éœ€è½¬æ¢ï¼‰**

```javascript
// å‰ç«¯ - pages-sub/clinic/add.vue
// ç”¨æˆ·ç›´æ¥è¾“å…¥æœ€å°å•ä½
<view class="quantity-input">
  <input 
    v-model.number="form.quantity" 
    type="number"
    placeholder="è¯·è¾“å…¥æ•°é‡"
  />
  <text class="unit">{{ selectedDrug.minUnit }}</text>  <!-- æ˜¾ç¤º"ç²’" -->
</view>

// æ•°æ®
{
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  location: "land_park",      // å°±è¯Šå›­åŒº
  quantity: 6,                // 6ç²’ï¼ˆæœ€å°å•ä½ï¼‰
  unit: "ç²’",                 // æœ€å°å•ä½
  patient: "å¼ ä¸‰",
  diagnosis: "ä¸Šå‘¼å¸é“æ„ŸæŸ“"
}
```

```javascript
// åç«¯ - cloudfunctions/clinicRecords/index.js
async function addRecord(data) {
  const { drugId, location, quantity, batchId } = data;
  
  // éªŒè¯ï¼šå›­åŒºåº“å­˜æ˜¯å¦å……è¶³ï¼ˆæœ€å°å•ä½ï¼‰
  const batch = await db.collection('stock')
    .where({
      drugId,
      location,     // å›­åŒº
      _id: batchId
    })
    .get();
  
  if (batch.data[0].quantity < quantity) {
    return { success: false, error: 'åº“å­˜ä¸è¶³' };
  }
  
  // åˆ›å»ºé—¨è¯Šè®°å½•
  await db.collection('clinic_records').add({
    data: {
      ...data,
      quantity,        // 6ç²’ï¼ˆæœ€å°å•ä½ï¼‰
      unit: data.unit, // ç²’
      createTime: now
    }
  });
  
  // æ‰£å‡å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼Œç›´æ¥æ‰£å‡ï¼‰
  await db.collection('stock').doc(batchId).update({
    data: {
      quantity: _.inc(-quantity),  // ç›´æ¥æ‰£å‡6ç²’
      updateTime: now
    }
  });
  
  return { success: true, message: 'ç™»è®°æˆåŠŸ' };
}
```

---

### æ¨¡å—4ï¼šåº“å­˜æŸ¥è¯¢

**æ ¹æ® location æ˜¾ç¤ºä¸åŒå•ä½**

```javascript
// å‰ç«¯ - pages-sub/stock/list.vue
<view class="stock-item">
  <text class="drug-name">{{ item.drugName }}</text>
  <text class="location">
    {{ item.location === 'clinic_storage' ? 'æ€»åº“' : 'é™†å›­' }}
  </text>
  <text class="quantity">
    åº“å­˜ï¼š{{ item.quantity }} 
    {{ item.location === 'clinic_storage' ? item.packUnit : item.minUnit }}
    <!-- æ€»åº“æ˜¾ç¤º"ç›’"ï¼Œå›­åŒºæ˜¾ç¤º"ç²’" -->
  </text>
</view>

// åç«¯æŸ¥è¯¢
async function getStockList(data) {
  const { location } = data;
  
  const stocks = await db.collection('stock')
    .where({
      location: location || _.neq('')  // å¯ç­›é€‰å›­åŒº
    })
    .get();
  
  return {
    success: true,
    data: stocks.data.map(item => ({
      ...item,
      displayUnit: item.location === 'clinic_storage' ? item.packUnit : item.minUnit
    }))
  };
}
```

---

## ğŸ“Š å•ä½è½¬æ¢è®¡ç®—å…¬å¼

### 1. å‡ºåº“è½¬æ¢ï¼ˆæ•´åŒ…è£… â†’ æœ€å°å•ä½ï¼‰

```javascript
// è¾“å…¥
const packQuantity = 10;           // æ•´åŒ…è£…æ•°é‡ï¼š10ç›’
const conversionRate = 24;         // æ¢ç®—ç‡ï¼š24ç²’/ç›’
const packPrice = 25.50;           // åŒ…è£…å•ä»·ï¼š25.50å…ƒ/ç›’

// è½¬æ¢
const minQuantity = packQuantity * conversionRate;      // 10 Ã— 24 = 240ç²’
const minPrice = packPrice / conversionRate;            // 25.50 / 24 = 1.0625å…ƒ/ç²’

// è¾“å‡ºåˆ°å›­åŒº
{
  quantity: 240,        // æœ€å°å•ä½æ•°é‡
  unit: "ç²’",           // æœ€å°å•ä½
  price: 1.0625         // æœ€å°å•ä½ä»·æ ¼
}
```

### 2. é—¨è¯Šä½¿ç”¨ï¼ˆæœ€å°å•ä½ç›´æ¥æ‰£å‡ï¼‰

```javascript
// æ— éœ€è½¬æ¢ï¼Œç›´æ¥æ‰£å‡
const useQuantity = 6;             // ä½¿ç”¨6ç²’
const stockQuantity = 240;         // åº“å­˜240ç²’

// æ‰£å‡å
const newStock = stockQuantity - useQuantity;  // 240 - 6 = 234ç²’
```

### 3. åº“å­˜å±•ç¤ºï¼ˆæ™ºèƒ½æ˜¾ç¤ºï¼‰

```javascript
function formatStock(stock) {
  if (stock.location === 'clinic_storage') {
    // æ€»åº“ï¼šæ˜¾ç¤ºæ•´åŒ…è£…
    return `${stock.quantity} ${stock.packUnit}`;  // "50 ç›’"
  } else {
    // å›­åŒºï¼šæ˜¾ç¤ºæœ€å°å•ä½ï¼Œå¯é€‰æ˜¾ç¤ºæ¢ç®—
    const packCount = (stock.quantity / stock.conversionRate).toFixed(2);
    return `${stock.quantity} ${stock.minUnit} (çº¦ ${packCount} ${stock.packUnit})`;
    // "240 ç²’ (çº¦ 10.00 ç›’)"
  }
}
```

---

## ğŸ¯ å…³é”®éªŒè¯ç‚¹

### 1. å…¥åº“éªŒè¯ âœ…
```javascript
// å¿…é¡»å¡«å†™æ•´åŒ…è£…å•ä½
if (!item.quantity || item.unit !== drug.packUnit) {
  throw new Error('è¯·è¾“å…¥æ­£ç¡®çš„åŒ…è£…å•ä½');
}
```

### 2. å‡ºåº“éªŒè¯ ğŸ”¥
```javascript
// æ£€æŸ¥æ€»åº“åº“å­˜ï¼ˆæ•´åŒ…è£…ï¼‰
const clinicStock = await getStock(drugId, batch, 'clinic_storage');
if (clinicStock.quantity < outQuantity) {
  throw new Error('æ€»åº“åº“å­˜ä¸è¶³');
}

// æ£€æŸ¥æ˜¯å¦é…ç½®äº†è½¬æ¢ç‡
if (!drug.conversionRate || !drug.minUnit) {
  throw new Error('è¯¥è¯ææœªé…ç½®å•ä½è½¬æ¢ä¿¡æ¯');
}
```

### 3. é—¨è¯ŠéªŒè¯ âœ…
```javascript
// æ£€æŸ¥å›­åŒºåº“å­˜ï¼ˆæœ€å°å•ä½ï¼‰
const parkStock = await getStock(drugId, batch, location);
if (parkStock.quantity < useQuantity) {
  throw new Error(`${location}åº“å­˜ä¸è¶³`);
}
```

---

## ğŸ“ˆ æŠ¥è¡¨ç»Ÿè®¡

### 1. åº“å­˜æŠ¥è¡¨
```javascript
// æ€»åº“æŠ¥è¡¨ï¼ˆæ•´åŒ…è£…ï¼‰
SELECT drugName, SUM(quantity) as totalQuantity, packUnit
FROM stock
WHERE location = 'clinic_storage'
GROUP BY drugId

// å›­åŒºæŠ¥è¡¨ï¼ˆæœ€å°å•ä½ï¼‰
SELECT drugName, location, SUM(quantity) as totalQuantity, minUnit
FROM stock
WHERE location IN ('land_park', 'water_park')
GROUP BY drugId, location
```

### 2. æ¶ˆè€—ç»Ÿè®¡
```javascript
// é—¨è¯Šæ¶ˆè€—ï¼ˆæœ€å°å•ä½ï¼‰
SELECT drugName, SUM(quantity) as totalUsed, minUnit, location
FROM clinic_records
WHERE createTime >= startDate AND createTime <= endDate
GROUP BY drugId, location

// è½¬æ¢ä¸ºæ•´åŒ…è£…æ˜¾ç¤º
{
  drugName: "é˜¿è«è¥¿æ—èƒ¶å›Š",
  totalUsedMin: 72,                    // 72ç²’
  totalUsedPack: 3.00,                 // 3ç›’ï¼ˆ72/24ï¼‰
  displayText: "72ç²’ (3ç›’)"
}
```

---

## ğŸ”§ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```javascript
// stock è¡¨ç´¢å¼•
db.stock.createIndex({ 
  drugId: 1, 
  batch: 1, 
  location: 1 
}, { unique: true });  // å¤åˆå”¯ä¸€ç´¢å¼•

db.stock.createIndex({ location: 1, quantity: 1 });  // åº“å­˜æŸ¥è¯¢
db.stock.createIndex({ expiryDate: 1, location: 1 }); // æ•ˆæœŸæŸ¥è¯¢

// clinic_records è¡¨ç´¢å¼•
db.clinic_records.createIndex({ location: 1, createTime: -1 });  // å›­åŒº+æ—¶é—´
db.clinic_records.createIndex({ drugId: 1, createTime: -1 });    // è¯ææ¶ˆè€—ç»Ÿè®¡
```

---

## âœ… å®Œæ•´æ€§æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ
- [ ] è¯ææ¡£æ¡ˆå¿…é¡»é…ç½® `packUnit`ã€`minUnit`ã€`conversionRate`
- [ ] å…¥åº“å•ä½¿ç”¨ `packUnit`
- [ ] å‡ºåº“å•æ˜¾ç¤ºè½¬æ¢æç¤º
- [ ] å‡ºåº“å®¡æ ¸åæ‰§è¡Œå•ä½è½¬æ¢
- [ ] å›­åŒºåº“å­˜ä½¿ç”¨ `minUnit`
- [ ] é—¨è¯Šç™»è®°ä½¿ç”¨ `minUnit`

### æµ‹è¯•é˜¶æ®µ
- [ ] æµ‹è¯•å‡ºåº“è½¬æ¢å‡†ç¡®æ€§ï¼ˆ10ç›’ = 240ç²’ï¼‰
- [ ] æµ‹è¯•å›­åŒºåº“å­˜ç´¯åŠ ï¼ˆå¤šæ¬¡å‡ºåº“ï¼‰
- [ ] æµ‹è¯•é—¨è¯Šæ‰£å‡ï¼ˆåº“å­˜å……è¶³/ä¸è¶³ï¼‰
- [ ] æµ‹è¯•å°æ•°å•ä½ï¼ˆå¦‚ï¼š0.5ç›’ = 12ç²’ï¼‰
- [ ] æµ‹è¯•ä»·æ ¼æ¢ç®—ï¼ˆå•ä»·ä¿æŒä¸€è‡´æ€§ï¼‰
- [ ] æµ‹è¯•æ‰¹æ¬¡è¿½æº¯ï¼ˆå›­åŒºæ‰¹æ¬¡å…³è”æ€»åº“æ‰¹æ¬¡ï¼‰

### ä¸Šçº¿é˜¶æ®µ
- [ ] æ•°æ®è¿ç§»ï¼šç°æœ‰åº“å­˜æŒ‰å›­åŒºåˆ†é…æœ€å°å•ä½
- [ ] ç”¨æˆ·åŸ¹è®­ï¼šè¯´æ˜å•ä½è½¬æ¢é€»è¾‘
- [ ] ç›‘æ§å¼‚å¸¸ï¼šåº“å­˜è´Ÿæ•°ã€è½¬æ¢é”™è¯¯
- [ ] å®šæœŸç›˜ç‚¹ï¼šæ ¸å¯¹ç†è®ºåº“å­˜ä¸å®é™…åº“å­˜

---

## ğŸ“ ç”¨æˆ·æ“ä½œæŒ‡å—

### å…¥åº“äººå‘˜
```
1. æ‰«ç /æ‰‹åŠ¨æ·»åŠ è¯æ
2. è¾“å…¥æ•°é‡ï¼šæŒ‰ã€ç›’/ç“¶ã€‘è¾“å…¥ï¼ˆæ•´åŒ…è£…ï¼‰
3. å¡«å†™æ‰¹æ¬¡ã€æ•ˆæœŸ
4. æäº¤å®¡æ ¸
```

### å‡ºåº“äººå‘˜
```
1. é€‰æ‹©ç›®æ ‡å›­åŒºï¼ˆé™†å›­/æ°´å›­ï¼‰
2. æ‰«ç /é€‰æ‹©è¯æ
3. è¾“å…¥æ•°é‡ï¼šæŒ‰ã€ç›’/ç“¶ã€‘è¾“å…¥ï¼ˆæ•´åŒ…è£…ï¼‰
4. ç³»ç»Ÿæç¤ºï¼šå°†è½¬æ¢ä¸ºã€XXç²’ã€‘å­˜å…¥å›­åŒº
5. æäº¤å®¡æ ¸
```

### é—¨è¯ŠåŒ»ç”Ÿ
```
1. é€‰æ‹©å°±è¯Šå›­åŒº
2. é€‰æ‹©è¯æ
3. è¾“å…¥æ•°é‡ï¼šæŒ‰ã€ç²’/ç‰‡ã€‘è¾“å…¥ï¼ˆæœ€å°å•ä½ï¼‰
4. ç³»ç»Ÿè‡ªåŠ¨ä»å›­åŒºæ‰£å‡
```

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. å°æ•°å¤„ç†
```javascript
// å‡ºåº“æ”¯æŒå°æ•°åŒ…è£…
outQuantity = 0.5;  // 0.5ç›’
minQuantity = 0.5 * 24 = 12;  // 12ç²’

// å›­åŒºåº“å­˜æ”¯æŒå°æ•°
parkStock = 234.5;  // 234.5ç²’ï¼ˆçº¦9.77ç›’ï¼‰
```

### 2. ä»·æ ¼ä¸€è‡´æ€§
```javascript
// ç¡®ä¿ä»·æ ¼æ¢ç®—æ­£ç¡®
packPrice = 25.50;  // å…ƒ/ç›’
minPrice = 25.50 / 24 = 1.0625;  // å…ƒ/ç²’

// éªŒè¯ï¼š6ç²’æˆæœ¬
cost = 6 * 1.0625 = 6.375å…ƒ
// ç­‰ä»·äºï¼š(6/24) * 25.50 = 6.375å…ƒ âœ…
```

### 3. æ‰¹æ¬¡è¿½æº¯
```javascript
// å›­åŒºåº“å­˜è®°å½•æ¥æº
{
  batch: "BATCH20251104",
  sourceBatch: "BATCH20251104",      // å¯¹åº”æ€»åº“æ‰¹æ¬¡
  sourceRecordId: "OUT202511040001",  // å¯¹åº”å‡ºåº“å•
  location: "land_park"
}

// å¯è¿½æº¯ï¼šè¿™æ‰¹è¯ä»å“ªä¸ªå‡ºåº“å•æ¥çš„
```

---

**æœ¬è§„èŒƒç‰ˆæœ¬ï¼šv2.0**  
**æ›´æ–°æ—¥æœŸï¼š2025-11-04**  
**é€‚ç”¨ç³»ç»Ÿï¼šçˆ±åº·åŒ»åŠ¡å®¤ç®¡ç†ç³»ç»Ÿ AK-PMS**

