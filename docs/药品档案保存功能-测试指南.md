# 🧪 药品档案保存功能 - 完整测试指南

**测试时间：** 2026年1月3日  
**测试目的：** 验证药品档案保存功能是否正常工作

---

## 📋 测试前准备

### 1. 确认文件已修改

✅ 已修改的文件：
- `cloudfunctions/drugManage/index.js` - 云函数支持 updateData 格式
- `pages-sub/drug/detail.vue` - 前端改用云函数保存

### 2. 确认云函数已部署

⚠️ **这是最关键的一步！**

**操作步骤：**
1. 在微信开发者工具中，找到左侧的 `cloudfunctions` 文件夹
2. 展开后找到 `drugManage` 文件夹
3. **右键点击** `drugManage` 文件夹
4. 选择 **"上传并部署：云端安装依赖"**
5. 等待控制台显示 **"上传成功"**

**预期结果：**
```
[云函数] [drugManage] 上传中...
[云函数] [drugManage] 上传成功
[云函数] [drugManage] 部署中...
[云函数] [drugManage] 部署成功
```

---

## 🧪 测试步骤

### 测试 1：基本保存功能

#### 步骤 1：打开药品档案详情页

1. 启动小程序
2. 进入 **"药品管理"** 或 **"药品档案"** 页面
3. 选择任意一个药品，点击进入详情页

#### 步骤 2：进入编辑模式

1. 点击页面右上角的 **"编辑"** 按钮
2. 确认输入框变为可编辑状态

#### 步骤 3：修改条形码

1. 找到 **"条形码"** 输入框
2. 记录当前的条形码值（例如：`6921392904045`）
3. 修改为测试值：`1234567890`

#### 步骤 4：保存修改

1. 点击 **"保存"** 按钮
2. 观察控制台输出

**预期日志：**
```
💾 开始保存药品档案...
药品ID: xxx
保存数据: { name: "xxx", barcode: "1234567890", ... }
更新数据: { name: "xxx", barcode: "1234567890", barCode: "1234567890", ... }
✅ 云函数返回结果: { errMsg: "cloud.callFunction:ok", result: { success: true, message: "更新成功" } }
✅ 保存成功
```

**预期界面提示：**
- 显示 **"保存成功"** 提示
- 1.5秒后自动重新加载数据

#### 步骤 5：验证界面显示

1. 等待页面自动重新加载（约1.5秒）
2. 查看条形码输入框
3. 确认显示为 `1234567890`

**预期日志：**
```
📖 加载药品详情，ID: xxx
📖 数据库返回: { barcode: "1234567890", barCode: "1234567890", ... }
📖 解析后的数据: { barcode: "1234567890", ... }
```

---

### 测试 2：数据持久化验证

#### 步骤 1：返回列表页

1. 点击左上角的 **"返回"** 按钮
2. 回到药品列表页

#### 步骤 2：重新进入详情页

1. 再次点击刚才修改的药品
2. 进入详情页

#### 步骤 3：验证数据

1. 查看条形码是否显示为 `1234567890`
2. 如果显示正确 → **测试通过！✅**
3. 如果显示旧值 → **测试失败！❌**

---

### 测试 3：数据库验证

#### 步骤 1：打开云开发控制台

1. 在微信开发者工具顶部菜单栏
2. 点击 **"云开发"** 按钮
3. 进入云开发控制台

#### 步骤 2：查看数据库记录

1. 点击左侧的 **"数据库"** 菜单
2. 选择 `drugs` 集合
3. 找到刚才修改的药品记录（可以通过药品名称搜索）

#### 步骤 3：验证字段值

查看记录中的字段：

**预期结果：**
```json
{
  "_id": "xxx",
  "name": "药品名称",
  "barcode": "1234567890",      // ✅ 已更新
  "barCode": "1234567890",      // ✅ 已更新（兼容字段）
  "updateTime": {
    "$date": "2026-01-03T02:30:00.000Z"  // ✅ 时间已更新
  }
}
```

**如果字段值正确 → 测试通过！✅**

---

### 测试 4：错误处理测试

#### 测试 4.1：云函数未部署

**模拟场景：** 云函数未部署或部署失败

**预期结果：**
- 显示错误提示：**"云函数未部署"**
- 提示部署步骤

**解决方案：**
1. 右键点击 `cloudfunctions/drugManage` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成

---

#### 测试 4.2：条形码重复

**测试步骤：**
1. 修改条形码为已存在的值（例如：另一个药品的条形码）
2. 点击保存

**预期结果：**
- 显示错误提示：**"该条码已被其他药材使用"**
- 数据未保存

---

#### 测试 4.3：必填项为空

**测试步骤：**
1. 清空 **"药品名称"** 或 **"规格"** 等必填项
2. 点击保存

**预期结果：**
- 显示错误提示：**"请填写必填项"**
- 数据未保存

---

## 📊 测试结果记录表

| 测试项 | 测试内容 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|----------|------|
| 测试1 | 基本保存功能 | 保存成功，界面显示新值 | ⬜ 待测试 | ⬜ |
| 测试2 | 数据持久化 | 重新打开显示新值 | ⬜ 待测试 | ⬜ |
| 测试3 | 数据库验证 | 数据库记录已更新 | ⬜ 待测试 | ⬜ |
| 测试4.1 | 云函数未部署 | 显示友好错误提示 | ⬜ 待测试 | ⬜ |
| 测试4.2 | 条形码重复 | 显示重复错误提示 | ⬜ 待测试 | ⬜ |
| 测试4.3 | 必填项为空 | 显示必填项提示 | ⬜ 待测试 | ⬜ |

---

## 🔍 常见问题排查

### 问题 1：保存后界面显示新值，但重新打开显示旧值

**可能原因：**
- 云函数未部署
- 云函数代码有误
- 数据库权限不足

**排查步骤：**
1. 检查云函数是否已部署
2. 查看云函数日志（云开发控制台 → 云函数 → 日志）
3. 查看数据库记录是否真的更新了

---

### 问题 2：点击保存后提示"云函数未部署"

**原因：** 云函数未上传到云端

**解决方案：**
1. 右键点击 `cloudfunctions/drugManage` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成后重试

---

### 问题 3：保存时提示"权限不足"

**原因：** 数据库权限配置问题

**解决方案：**
- 使用云函数保存（已实现）
- 云函数拥有管理员权限，可以绕过权限限制

---

### 问题 4：控制台没有日志输出

**可能原因：**
- 控制台被清空
- 日志级别设置过滤了 console.log

**解决方案：**
1. 确保控制台的日志级别设置为 **"全部"**
2. 重新执行保存操作
3. 观察控制台输出

---

## 📝 测试报告模板

完成测试后，请按照以下格式提供测试结果：

```
【测试报告】

测试时间：2026年1月3日 XX:XX

1. 云函数部署状态：
   ✅ 已部署 / ❌ 未部署

2. 基本保存功能：
   ✅ 通过 / ❌ 失败
   控制台日志：
   [粘贴完整的控制台日志]

3. 数据持久化：
   ✅ 通过 / ❌ 失败
   说明：重新打开后条形码显示为 [实际值]

4. 数据库验证：
   ✅ 通过 / ❌ 失败
   数据库记录截图：[可选]

5. 遇到的问题：
   [描述遇到的任何问题]

6. 错误信息：
   [如果有错误，粘贴完整的错误信息]
```

---

## 🎯 测试通过标准

### ✅ 所有测试通过的标志

1. **保存成功**
   - 控制台显示 `✅ 保存成功`
   - 界面提示 "保存成功"

2. **界面更新**
   - 保存后自动重新加载
   - 界面显示新的条形码值

3. **数据持久化**
   - 返回列表页后重新进入
   - 仍然显示新的条形码值

4. **数据库更新**
   - 数据库记录中的 `barcode` 和 `barCode` 字段已更新
   - `updateTime` 字段已更新为最新时间

---

## 💡 下一步行动

### 如果测试全部通过 ✅

恭喜！问题已完全解决！

**建议：**
1. 将测试值改回原来的条形码
2. 继续使用系统
3. 如有其他问题，随时反馈

---

### 如果测试失败 ❌

**请提供以下信息：**

1. **完整的控制台日志**（从点击"保存"到重新加载的所有日志）
2. **错误提示截图**（如果有错误提示）
3. **数据库记录截图**（保存前后的对比）
4. **云函数部署状态**（是否显示"部署成功"）

我会根据这些信息继续帮您分析和解决问题！

---

**文档创建时间：** 2026年1月3日  
**文档类型：** 测试指南  
**状态：** ✅ 完成




