# 🔍 药品档案保存问题 - 诊断指南

**问题：** 修改药品档案后保存，提示已保存，但再次打开还是原来的数据

---

## 📋 诊断步骤

### 步骤 1：检查控制台日志

打开微信开发者工具的控制台，执行以下操作：

1. 进入药品档案详情页
2. 点击"编辑"按钮
3. 修改任意字段（如：条形码）
4. 点击"保存"按钮
5. **查看控制台输出**

---

#### 情况 A：看到完整的保存日志 ✅

```
💾 开始保存药品档案...
药品ID: da8988ea692e7e0d05ed8729183805be
保存数据: { name: "藿香正气水", barcode: "6902952130965", ... }
更新数据: { name: "藿香正气水", drugName: "藿香正气水", barcode: "6902952130965", barCode: "6902952130965", ... }
✅ 保存成功，更新结果: { stats: { updated: 1 }, errMsg: "document.update:ok" }
📖 加载药品详情，ID: da8988ea692e7e0d05ed8729183805be
📖 数据库返回: { ... }
📖 解析后的数据: { ... }
```

**说明：** 保存功能正常工作

**下一步：** 检查 `📖 数据库返回` 和 `📖 解析后的数据` 中的字段值是否正确

---

#### 情况 B：看到权限错误 ❌

```
💾 开始保存药品档案...
❌ 保存失败: { errMsg: "permission denied" }
错误详情: permission denied
```

**原因：** 数据库权限不足

**解决方案：** 跳转到 [步骤 2：检查数据库权限](#步骤-2检查数据库权限)

---

#### 情况 C：看到网络超时 ❌

```
💾 开始保存药品档案...
❌ 保存失败: { errMsg: "timeout" }
错误详情: timeout
```

**原因：** 网络连接超时

**解决方案：**
1. 检查网络连接
2. 重新保存
3. 如果仍然超时，检查云开发环境是否正常

---

#### 情况 D：没有看到任何日志 ❌

**原因：** 代码可能没有正确更新

**解决方案：**
1. 确认文件已保存（Ctrl+S）
2. 点击"编译"按钮重新编译
3. 清除缓存后重新打开页面

---

### 步骤 2：检查数据库权限

在微信开发者工具中：

1. 点击左侧 **"云开发"** 图标
2. 进入 **"数据库"** 标签
3. 找到 **`drugs`** 集合
4. 点击 **"权限设置"** 标签

---

#### 推荐权限设置

**方案 A：所有用户可读写（推荐用于开发测试）**

```json
{
  "read": true,
  "write": true
}
```

**方案 B：仅创建者可写（推荐用于生产环境）**

```json
{
  "read": true,
  "write": "doc._openid == auth.openid"
}
```

**方案 C：管理员可写（推荐用于生产环境）**

```json
{
  "read": true,
  "write": "get(`database.users.${auth.openid}`).role == 'admin'"
}
```

---

#### 如何修改权限

1. 在权限设置页面，选择合适的权限方案
2. 点击"保存"按钮
3. 等待权限更新完成
4. 重新测试保存功能

---

### 步骤 3：检查数据库记录

在微信开发者工具中：

1. 点击左侧 **"云开发"** 图标
2. 进入 **"数据库"** 标签
3. 找到 **`drugs`** 集合
4. 搜索您修改的药品（如：藿香正气水）
5. 查看记录详情

---

#### 检查要点

**A. 检查 `updateTime` 字段**

```json
{
  "_id": "da8988ea692e7e0d05ed8729183805be",
  "name": "藿香正气水",
  "updateTime": "2026-01-02T11:20:33.000Z"  // ← 检查时间是否更新
}
```

- ✅ 如果时间已更新 → 说明保存成功
- ❌ 如果时间未更新 → 说明保存失败，检查权限

---

**B. 检查修改的字段**

假设您修改了条形码：

```json
{
  "_id": "da8988ea692e7e0d05ed8729183805be",
  "name": "藿香正气水",
  "barcode": "6902952130965",      // ← 检查是否更新
  "barCode": "6902952130965",      // ← 检查是否更新（兼容字段）
  "updateTime": "2026-01-02T11:20:33.000Z"
}
```

- ✅ 如果 `barcode` 和 `barCode` 都已更新 → 保存成功
- ⚠️ 如果只有 `barcode` 更新，`barCode` 未更新 → 代码可能未正确更新
- ❌ 如果两个字段都未更新 → 保存失败，检查权限

---

**C. 检查字段名**

查看数据库中该记录的所有字段名：

```json
{
  "_id": "da8988ea692e7e0d05ed8729183805be",
  "name": "藿香正气水",           // ← 小写
  "drugName": "藿香正气水",       // ← 驼峰（兼容）
  "barcode": "6902952130965",     // ← 小写
  "barCode": "6902952130965",     // ← 驼峰（兼容）
  "specification": "10ml*10支",   // ← 小写
  "spec": "10ml*10支",            // ← 简写（兼容）
  "unit": "盒",                   // ← 小写
  "packUnit": "盒"                // ← 驼峰（兼容）
}
```

**重要：** 确认数据库中同时存在两种字段名（小写和驼峰）

---

### 步骤 4：检查加载逻辑

如果保存成功，但再次打开时显示旧数据，可能是加载逻辑的问题。

在控制台中查看加载日志：

```
📖 加载药品详情，ID: da8988ea692e7e0d05ed8729183805be
📖 数据库返回: {
  _id: "da8988ea692e7e0d05ed8729183805be",
  name: "藿香正气水",
  barcode: "6902952130965",      // ← 检查这里的值
  barCode: "6902952130965",      // ← 检查这里的值
  ...
}
📖 解析后的数据: {
  name: "藿香正气水",
  barcode: "6902952130965",      // ← 检查这里的值
  ...
}
```

---

#### 问题诊断

**情况 A：数据库返回的是新值，但解析后是旧值**

**原因：** 加载逻辑有问题

**解决方案：** 检查 `loadDrugDetail()` 方法中的字段映射逻辑

---

**情况 B：数据库返回的就是旧值**

**原因：** 保存没有真正成功

**解决方案：** 返回 [步骤 2：检查数据库权限](#步骤-2检查数据库权限)

---

**情况 C：数据库返回的是新值，解析后也是新值，但界面显示旧值**

**原因：** 界面没有正确更新

**解决方案：** 检查数据绑定是否正确

---

## 🔧 常见问题和解决方案

### 问题 1：权限不足

**现象：**
- 控制台显示 `permission denied`
- 提示"权限不足，无法保存"

**解决方案：**

**方法 A：修改数据库权限（推荐）**

1. 进入云开发控制台
2. 数据库 → `drugs` 集合 → 权限设置
3. 将 `write` 权限改为 `true`
4. 保存并重新测试

**方法 B：使用云函数更新（绕过权限限制）**

创建云函数 `drugManage`：

```javascript
// cloudfunctions/drugManage/index.js
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const { action, data } = event
  
  if (action === 'update') {
    try {
      const result = await db.collection('drugs')
        .doc(data._id)
        .update({
          data: data.updateData
        })
      
      return {
        success: true,
        result
      }
    } catch (err) {
      return {
        success: false,
        error: err.message
      }
    }
  }
}
```

修改 `detail.vue` 中的保存方法：

```javascript
// 使用云函数保存
const result = await wx.cloud.callFunction({
  name: 'drugManage',
  data: {
    action: 'update',
    data: {
      _id: this.drugId,
      updateData: updateData
    }
  }
})

if (result.result.success) {
  console.log('✅ 保存成功')
} else {
  console.error('❌ 保存失败:', result.result.error)
}
```

---

### 问题 2：字段名不匹配

**现象：**
- 保存成功，但再次打开时数据未更新
- 数据库中只有 `barCode`，没有 `barcode`

**原因：**
- 保存时只更新了 `barcode`（小写）
- 数据库中使用的是 `barCode`（驼峰）
- 加载时读取的是 `barcode`，但数据库中没有这个字段

**解决方案：**

✅ **已修复！** 现在保存时会同时更新两种字段名：

```javascript
const updateData = {
  barcode: this.drugData.barcode,   // 小写
  barCode: this.drugData.barcode,   // 驼峰（兼容）
}
```

加载时也会兼容两种字段名：

```javascript
const barcodeValue = result.data.barcode || result.data.barCode || ''
```

---

### 问题 3：缓存问题

**现象：**
- 数据库中已更新
- 控制台日志显示加载的是新数据
- 但界面显示的是旧数据

**原因：** 浏览器或小程序缓存了旧数据

**解决方案：**

1. **清除缓存**
   - 微信开发者工具 → 工具 → 清除缓存
   - 选择"清除数据缓存"
   - 重新编译

2. **强制刷新**
   - 关闭详情页
   - 重新进入详情页
   - 查看是否显示最新数据

3. **添加时间戳**（防止缓存）
   ```javascript
   uni.navigateTo({
     url: `/pages-sub/drug/detail?id=${item._id}&t=${Date.now()}`
   })
   ```

---

### 问题 4：网络超时

**现象：**
- 控制台显示 `timeout`
- 提示"网络超时，请重试"

**原因：** 网络连接不稳定或云开发环境响应慢

**解决方案：**

1. **检查网络连接**
   - 确保网络连接正常
   - 尝试访问其他网站

2. **增加超时时间**
   ```javascript
   const result = await db.collection('drugs')
     .doc(this.drugId)
     .update({
       data: updateData
     })
     .timeout(10000) // 增加到 10 秒
   ```

3. **重试机制**
   ```javascript
   let retryCount = 0
   const maxRetry = 3
   
   while (retryCount < maxRetry) {
     try {
       const result = await db.collection('drugs')
         .doc(this.drugId)
         .update({ data: updateData })
       break // 成功，退出循环
     } catch (err) {
       retryCount++
       if (retryCount >= maxRetry) {
         throw err // 重试次数用完，抛出错误
       }
       await new Promise(resolve => setTimeout(resolve, 1000)) // 等待 1 秒后重试
     }
   }
   ```

---

## 📊 完整的测试流程

### 测试 1：保存功能

1. ✅ 打开控制台
2. ✅ 进入药品档案详情页
3. ✅ 点击"编辑"按钮
4. ✅ 修改条形码（如：改为 `1234567890123`）
5. ✅ 点击"保存"按钮
6. ✅ 查看控制台日志

**预期日志：**
```
💾 开始保存药品档案...
药品ID: xxx
保存数据: { barcode: "1234567890123", ... }
更新数据: { barcode: "1234567890123", barCode: "1234567890123", ... }
✅ 保存成功，更新结果: { stats: { updated: 1 } }
```

7. ✅ 等待 1.5 秒（自动重新加载）
8. ✅ 查看控制台日志

**预期日志：**
```
📖 加载药品详情，ID: xxx
📖 数据库返回: { barcode: "1234567890123", barCode: "1234567890123", ... }
📖 解析后的数据: { barcode: "1234567890123", ... }
```

9. ✅ 查看界面上的条形码是否显示为 `1234567890123`

---

### 测试 2：数据库验证

1. ✅ 打开云开发控制台
2. ✅ 进入数据库 → `drugs` 集合
3. ✅ 搜索该药品
4. ✅ 查看记录详情

**预期结果：**
```json
{
  "_id": "xxx",
  "name": "藿香正气水",
  "barcode": "1234567890123",      // ← 已更新
  "barCode": "1234567890123",      // ← 已更新
  "updateTime": "2026-01-02T11:30:00.000Z"  // ← 时间已更新
}
```

---

### 测试 3：重新打开验证

1. ✅ 返回药品列表页
2. ✅ 再次进入该药品详情页
3. ✅ 查看控制台日志

**预期日志：**
```
📖 加载药品详情，ID: xxx
📖 数据库返回: { barcode: "1234567890123", ... }
📖 解析后的数据: { barcode: "1234567890123", ... }
```

4. ✅ 查看界面上的条形码是否显示为 `1234567890123`

---

## 🎯 快速诊断清单

请按顺序检查以下项目：

- [ ] 文件已保存（Ctrl+S）
- [ ] 已重新编译（点击"编译"按钮）
- [ ] 控制台显示保存日志
- [ ] 保存日志显示 `updated: 1`
- [ ] 数据库权限设置为 `write: true`
- [ ] 数据库中 `updateTime` 已更新
- [ ] 数据库中修改的字段已更新
- [ ] 数据库中同时存在 `barcode` 和 `barCode` 字段
- [ ] 重新加载后控制台显示最新数据
- [ ] 界面显示最新数据

---

## 💬 如果问题仍然存在

请提供以下信息：

1. **完整的控制台日志**（从点击"保存"到重新加载的所有日志）
2. **数据库截图**（保存前后的记录对比）
3. **权限设置截图**（`drugs` 集合的权限设置）
4. **操作步骤**（详细的操作流程）
5. **修改的字段**（您修改了哪些字段）

我会根据这些信息精准定位问题！🔍

---

**文档创建时间：** 2026年1月2日  
**最后更新时间：** 2026年1月2日  
**状态：** ✅ 完整版





