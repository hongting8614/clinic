# 权限系统详细开发步骤

## 📋 开发准备清单

### ✅ 确认已安装
- [ ] HBuilderX（最新版）
- [ ] 微信开发者工具（最新版）
- [ ] 已注册微信小程序账号
- [ ] 已开通云开发环境

### ✅ 确认项目状态
- [ ] 项目已在 HBuilderX 中打开
- [ ] 项目根目录：`D:\medicine_manager\AK-PMS`
- [ ] 已有基础页面和文件

---

## 🎯 总体流程（约2小时）

```
第一阶段：环境准备 ⏱️ 20分钟
  → 配置云开发
  → 创建数据表
  → 添加管理员账号

第二阶段：云函数部署 ⏱️ 30分钟
  → 创建6个云函数
  → 上传并部署
  → 测试验证

第三阶段：前端集成 ⏱️ 40分钟
  → 复制工具类
  → 配置App.js
  → 创建用户管理页面
  → 添加导航入口

第四阶段：测试验证 ⏱️ 30分钟
  → 登录测试
  → 权限测试
  → 用户管理测试
```

---

## 第一阶段：环境准备（20分钟）

### 步骤1.1：获取云开发环境ID（2分钟）

1. **打开微信开发者工具**
2. **点击顶部菜单：云开发**
3. **点击"开通"**（如果已开通，点击"云开发控制台"）
4. **复制环境ID**

```
环境ID示例：cloud1-xxx（记下来，后面要用）
```

> 💡 **提示**：环境ID通常在控制台顶部显示，格式类似 `cloud1-xxx`

---

### 步骤1.2：创建数据表（3分钟）

#### 1.2.1 创建 operation_logs 表

1. 在云开发控制台，点击左侧 **"数据库"**
2. 点击 **"添加集合"**
3. 集合名称：`operation_logs`
4. 点击 **"确定"**

#### 1.2.2 设置权限

1. 点击 `operation_logs` 表
2. 点击 **"权限设置"**
3. 选择：**"仅创建者可读写"**
4. 点击 **"保存"**

#### 1.2.3 检查已有表

确认以下表已存在（如果没有需要创建）：
- ✅ `users` - 用户表
- ✅ `drugs` - 药品表
- ✅ `stock` - 库存表
- ✅ `in_records` - 入库记录表
- ✅ `out_records` - 出库记录表
- ✅ `consume_records` - 消耗记录表
- ✅ `requisition_records` - 请领记录表

---

### 步骤1.3：获取你的OpenID（5分钟）

#### 方法1：创建临时云函数获取（推荐）

1. **在微信开发者工具中**，展开 `cloudfunctions` 目录
2. **右键** `cloudfunctions` → **新建 Node.js 云函数**
3. **函数名称**：`getMyOpenId`
4. **创建后，编辑 index.js**：

```javascript
// cloudfunctions/getMyOpenId/index.js
const cloud = require('wx-server-sdk')
cloud.init()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  
  return {
    openid: wxContext.OPENID,
    appid: wxContext.APPID,
    unionid: wxContext.UNIONID
  }
}
```

5. **右键该云函数** → **上传并部署：云端安装依赖**
6. **在小程序任意页面（如 pages/index/index.vue）临时添加**：

```javascript
onLoad() {
  wx.cloud.callFunction({
    name: 'getMyOpenId',
    success: res => {
      console.log('===== 你的OpenID =====')
      console.log(res.result.openid)
      console.log('====================')
      
      // 弹窗显示
      wx.showModal({
        title: '你的OpenID',
        content: res.result.openid,
        confirmText: '复制',
        success: (modalRes) => {
          if (modalRes.confirm) {
            wx.setClipboardData({
              data: res.result.openid
            })
          }
        }
      })
    }
  })
}
```

7. **在微信开发者工具中编译运行**
8. **查看控制台或弹窗，复制OpenID**
9. **完成后删除测试代码**

---

### 步骤1.4：添加第一个管理员账号（10分钟）

1. **在云开发控制台** → **数据库** → **users**
2. **点击"添加记录"**
3. **填写数据**（⚠️ 注意替换你的OpenID）：

```json
{
  "openid": "你刚才复制的OpenID",
  "name": "系统管理员",
  "nickname": "管理员",
  "phone": "13800138000",
  "role": "admin",
  "status": "active"
}
```

4. **点击"确定"**
5. **验证**：刷新页面，应该能看到这条记录

> ⚠️ **重要**：确保 `openid` 填写正确，这是你登录的凭证！

---

## 第二阶段：云函数部署（30分钟）

### 步骤2.1：创建云函数目录结构（5分钟）

确保 `cloudfunctions` 目录下有以下文件夹：

```
cloudfunctions/
├── login/
├── addUser/
├── getUserList/
├── updateUser/
├── deleteUser/
└── updateUserStatus/
```

**如果没有，按照以下步骤创建：**

1. 在微信开发者工具中
2. 右键 `cloudfunctions` → **新建 Node.js 云函数**
3. 输入函数名称（如 `login`）
4. 重复6次，创建所有云函数

---

### 步骤2.2：复制云函数代码（15分钟）

#### 2.2.1 login 云函数

**文件**：`cloudfunctions/login/index.js`

```javascript
// 云函数：用户登录验证
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const openid = wxContext.OPENID
  
  try {
    // 查询用户信息
    const userRes = await db.collection('users')
      .where({ openid, status: 'active' })
      .get()
    
    // 用户不存在或已被禁用
    if (userRes.data.length === 0) {
      return {
        code: 403,
        authorized: false,
        message: '您不在系统白名单内，请联系管理员添加',
        openid
      }
    }
    
    const user = userRes.data[0]
    
    // 更新最后登录时间
    await db.collection('users').doc(user._id).update({
      data: {
        lastLogin: db.serverDate(),
        updateTime: db.serverDate()
      }
    })
    
    // 返回用户信息
    return {
      code: 0,
      authorized: true,
      message: '登录成功',
      userInfo: {
        userId: user._id,
        openid: user.openid,
        name: user.name,
        nickname: user.nickname || user.name,
        phone: user.phone,
        role: user.role,
        roleText: getRoleText(user.role)
      }
    }
  } catch (err) {
    console.error('登录失败:', err)
    return {
      code: -1,
      authorized: false,
      message: '登录失败，请重试',
      error: err.message
    }
  }
}

// 获取角色中文名称
function getRoleText(role) {
  const roleMap = {
    'admin': '管理员',
    'pharmacy': '药房人员',
    'viewer': '查看者'
  }
  return roleMap[role] || '未知角色'
}
```

**文件**：`cloudfunctions/login/package.json`

```json
{
  "name": "login",
  "version": "1.0.0",
  "description": "用户登录验证云函数",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

#### 2.2.2 addUser 云函数

**文件**：`cloudfunctions/addUser/index.js`

```javascript
// 云函数：添加用户（仅管理员）
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { openid, name, phone, nickname, role = 'viewer' } = event
  
  try {
    // 1. 验证操作者权限（必须是管理员）
    const adminRes = await db.collection('users')
      .where({
        openid: wxContext.OPENID,
        role: 'admin',
        status: 'active'
      })
      .get()
    
    if (adminRes.data.length === 0) {
      return {
        code: 403,
        message: '权限不足，仅管理员可添加用户'
      }
    }
    
    // 2. 验证参数
    if (!openid || !name || !phone) {
      return {
        code: 400,
        message: '参数不完整，openid、name、phone 为必填项'
      }
    }
    
    // 验证角色是否合法
    const validRoles = ['admin', 'pharmacy', 'viewer']
    if (!validRoles.includes(role)) {
      return {
        code: 400,
        message: `角色不合法，只能是：${validRoles.join(', ')}`
      }
    }
    
    // 3. 检查用户是否已存在
    const existRes = await db.collection('users')
      .where({ openid })
      .get()
    
    if (existRes.data.length > 0) {
      return {
        code: 409,
        message: '该用户已存在，请勿重复添加'
      }
    }
    
    // 4. 添加用户
    const result = await db.collection('users').add({
      data: {
        openid,
        name,
        nickname: nickname || name,
        phone,
        role,
        status: 'active',
        createTime: db.serverDate(),
        updateTime: db.serverDate(),
        lastLogin: null
      }
    })
    
    // 5. 记录操作日志
    await db.collection('operation_logs').add({
      data: {
        operator: wxContext.OPENID,
        operatorName: adminRes.data[0].name,
        action: 'add_user',
        target: result._id,
        details: {
          name,
          role,
          phone
        },
        timestamp: db.serverDate()
      }
    })
    
    return {
      code: 0,
      message: '用户添加成功',
      userId: result._id
    }
  } catch (err) {
    console.error('添加用户失败:', err)
    return {
      code: -1,
      message: '添加用户失败',
      error: err.message
    }
  }
}
```

**文件**：`cloudfunctions/addUser/package.json`

```json
{
  "name": "addUser",
  "version": "1.0.0",
  "description": "添加用户云函数（仅管理员）",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

> 💡 **提示**：其他4个云函数（getUserList、updateUser、deleteUser、updateUserStatus）的代码已经在前面创建好了，直接复制到对应目录即可。

---

### 步骤2.3：批量上传云函数（10分钟）

**在微信开发者工具中，依次上传每个云函数：**

1. **右键 `cloudfunctions/login`**
2. **点击"上传并部署：云端安装依赖"**
3. **等待上传完成**（约1-2分钟）
4. **重复以上步骤，上传所有6个云函数：**
   - ✅ login
   - ✅ addUser
   - ✅ getUserList
   - ✅ updateUser
   - ✅ deleteUser
   - ✅ updateUserStatus

**验证上传成功：**
- 在云开发控制台 → 云函数
- 应该能看到6个云函数
- 状态显示为"部署成功"

---

## 第三阶段：前端集成（40分钟）

### 步骤3.1：确认文件存在（2分钟）

确保以下文件已存在（如果没有，需要创建）：

```
✅ utils/permission.js  （已创建）
✅ utils/auth.js        （已创建）
✅ pages-sub/setting/user-list.vue  （已创建）
```

**如果文件不存在，说明前面的代码没有正确保存，需要重新创建这些文件。**

---

### 步骤3.2：配置 App.js（5分钟）

**打开 `App.vue`**，修改为：

```vue
<script>
import { login } from './utils/auth.js'

export default {
  async onLaunch() {
    console.log('App Launch')
    
    // 初始化云开发
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力')
    } else {
      wx.cloud.init({
        env: 'your-env-id',  // ⚠️ 替换为你的云开发环境ID
        traceUser: true
      })
      console.log('云开发初始化成功')
    }
    
    // 用户登录验证
    console.log('开始验证用户身份...')
    const loginResult = await login()
    
    if (!loginResult.success) {
      // 不在白名单
      console.log('用户验证失败:', loginResult.message)
      wx.showModal({
        title: '访问受限',
        content: loginResult.message || '您不在系统白名单内，请联系管理员',
        showCancel: false
      })
    } else {
      console.log('登录成功:', loginResult.userInfo)
    }
  },
  
  onShow() {
    console.log('App Show')
  },
  
  onHide() {
    console.log('App Hide')
  }
}
</script>

<style lang="scss">
/* 全局样式 */
</style>
```

> ⚠️ **重要**：记得替换 `your-env-id` 为你在步骤1.1中获取的环境ID！

---

### 步骤3.3：配置 pages.json（5分钟）

**打开 `pages.json`**，在 `subPackages` 中添加用户管理页面：

找到 `pages-sub/setting` 部分，添加用户管理页面：

```json
{
  "root": "pages-sub/setting",
  "pages": [
    {
      "path": "index",
      "style": {
        "navigationBarTitleText": "系统设置"
      }
    },
    {
      "path": "user-list",
      "style": {
        "navigationBarTitleText": "用户管理"
      }
    },
    {
      "path": "department",
      "style": {
        "navigationBarTitleText": "部门管理"
      }
    },
    {
      "path": "location",
      "style": {
        "navigationBarTitleText": "园区管理"
      }
    }
  ]
}
```

**如果 `pages-sub/setting` 不存在，需要添加整个配置：**

```json
{
  "subPackages": [
    // ... 其他分包
    {
      "root": "pages-sub/setting",
      "pages": [
        {
          "path": "user-list",
          "style": {
            "navigationBarTitleText": "用户管理"
          }
        }
      ]
    }
  ]
}
```

---

### 步骤3.4：添加导航入口（10分钟）

**打开 `pages/user/index.vue`**（"我的"页面），添加用户管理入口：

```vue
<template>
  <view class="user-page">
    <!-- 用户信息卡片 -->
    <view class="user-card">
      <view class="avatar">{{ userName.substr(0, 1) }}</view>
      <view class="info">
        <text class="name">{{ userName }}</text>
        <text class="role">{{ userRoleText }}</text>
      </view>
    </view>
    
    <!-- 管理员专属菜单 -->
    <view v-if="isAdmin" class="menu-section">
      <text class="section-title">管理员功能</text>
      <view class="menu-item" @click="navigateToUserManagement">
        <text class="menu-icon">👥</text>
        <text class="menu-title">用户管理</text>
        <text class="menu-arrow">→</text>
      </view>
    </view>
    
    <!-- 通用功能菜单 -->
    <view class="menu-section">
      <text class="section-title">功能菜单</text>
      
      <view class="menu-item" @click="navigateToReport">
        <text class="menu-icon">📊</text>
        <text class="menu-title">报表中心</text>
        <text class="menu-arrow">→</text>
      </view>
      
      <view class="menu-item" @click="navigateToSettings">
        <text class="menu-icon">⚙️</text>
        <text class="menu-title">系统设置</text>
        <text class="menu-arrow">→</text>
      </view>
    </view>
    
    <!-- 退出登录 -->
    <view class="logout-section">
      <button class="logout-btn" @click="handleLogout">退出登录</button>
    </view>
    
    <!-- 版本信息 -->
    <view class="version">
      <text>版本 v1.0.0</text>
    </view>
  </view>
</template>

<script>
import { authMixin, logout } from '@/utils/auth.js'

export default {
  mixins: [authMixin],
  
  data() {
    return {
      userName: '',
      userRoleText: ''
    }
  },
  
  onLoad() {
    this.loadUserAuth()
    this.loadUserInfo()
  },
  
  methods: {
    loadUserInfo() {
      if (this.userInfo) {
        this.userName = this.userInfo.name || '未知用户'
        this.userRoleText = this.userInfo.roleText || '未知角色'
      }
    },
    
    navigateToUserManagement() {
      uni.navigateTo({
        url: '/pages-sub/setting/user-list'
      })
    },
    
    navigateToReport() {
      uni.navigateTo({
        url: '/pages-sub/report/index'
      })
    },
    
    navigateToSettings() {
      uni.navigateTo({
        url: '/pages-sub/setting/index'
      })
    },
    
    handleLogout() {
      uni.showModal({
        title: '确认退出',
        content: '确定要退出登录吗？',
        success: (res) => {
          if (res.confirm) {
            logout()
          }
        }
      })
    }
  }
}
</script>

<style lang="scss" scoped>
.user-page {
  min-height: 100vh;
  background: #f5f7fa;
  padding: 20rpx;
}

.user-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20rpx;
  padding: 40rpx;
  display: flex;
  align-items: center;
  margin-bottom: 20rpx;
  
  .avatar {
    width: 100rpx;
    height: 100rpx;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40rpx;
    color: #fff;
    font-weight: bold;
    margin-right: 20rpx;
  }
  
  .info {
    flex: 1;
    
    .name {
      display: block;
      font-size: 36rpx;
      color: #fff;
      font-weight: bold;
      margin-bottom: 8rpx;
    }
    
    .role {
      font-size: 24rpx;
      color: rgba(255, 255, 255, 0.8);
    }
  }
}

.menu-section {
  background: #fff;
  border-radius: 20rpx;
  padding: 20rpx;
  margin-bottom: 20rpx;
  
  .section-title {
    display: block;
    font-size: 24rpx;
    color: #999;
    padding: 10rpx 20rpx;
    margin-bottom: 10rpx;
  }
  
  .menu-item {
    display: flex;
    align-items: center;
    padding: 30rpx 20rpx;
    border-bottom: 1px solid #f0f0f0;
    
    &:last-child {
      border-bottom: none;
    }
    
    .menu-icon {
      font-size: 40rpx;
      margin-right: 20rpx;
    }
    
    .menu-title {
      flex: 1;
      font-size: 28rpx;
      color: #333;
    }
    
    .menu-arrow {
      font-size: 28rpx;
      color: #999;
    }
  }
}

.logout-section {
  padding: 20rpx;
  
  .logout-btn {
    background: #fff;
    border: 1px solid #ff4d4f;
    color: #ff4d4f;
    border-radius: 16rpx;
    padding: 28rpx;
    font-size: 28rpx;
  }
}

.version {
  text-align: center;
  padding: 40rpx;
  color: #999;
  font-size: 24rpx;
}
</style>
```

---

### 步骤3.5：测试基础登录（10分钟）

1. **在微信开发者工具中编译小程序**
2. **打开"我的"页面**
3. **查看控制台输出**

**预期看到：**
```
云开发初始化成功
开始验证用户身份...
登录成功: {userId: "xxx", name: "系统管理员", role: "admin", ...}
```

**如果看到"访问受限"：**
- 检查 users 表中的 openid 是否正确
- 确认 status 字段为 "active"
- 检查云函数 login 是否正确部署

**如果看到"用户管理"菜单：**
- ✅ 说明登录成功且是管理员
- ✅ 可以进入下一步

---

### 步骤3.6：测试用户管理页面（8分钟）

1. **点击"用户管理"菜单**
2. **应该能看到：**
   - 用户统计卡片
   - 用户列表（显示你的管理员账号）
   - "添加用户"按钮

3. **点击"添加用户"**
4. **填写测试用户信息：**
   - OpenID: `test_pharmacy_001`（测试用的）
   - 姓名: `测试药房人员`
   - 手机号: `13900000001`
   - 角色: `pharmacy`（药房人员）

5. **点击"添加"**

**预期结果：**
- ✅ 显示"添加成功"
- ✅ 列表自动刷新
- ✅ 能看到新添加的用户

**如果失败：**
- 查看控制台错误信息
- 检查云函数 addUser 是否正确部署
- 检查 operation_logs 表是否创建

---

## 第四阶段：全面测试（30分钟）

### 测试4.1：用户管理功能（10分钟）

#### 测试项1：编辑用户
1. 点击用户的"编辑"按钮
2. 修改姓名
3. 点击"保存"
4. ✅ 应该显示"保存成功"

#### 测试项2：禁用用户
1. 点击"禁用"按钮
2. 确认操作
3. ✅ 用户状态变为半透明

#### 测试项3：启用用户
1. 点击"启用"按钮
2. 确认操作
3. ✅ 用户状态恢复正常

#### 测试项4：删除用户
1. 点击"删除"按钮
2. 确认操作
3. ✅ 用户从列表消失

#### 测试项5：不能操作自己
1. 尝试编辑自己的账号
2. ✅ "编辑"按钮应该是禁用状态
3. ✅ "禁用"和"删除"按钮也是禁用状态

---

### 测试4.2：权限控制（10分钟）

#### 测试项1：管理员权限
1. 使用管理员账号登录
2. ✅ 能看到"用户管理"菜单
3. ✅ 能打开用户管理页面
4. ✅ 能进行所有操作

#### 测试项2：非管理员权限
由于是测试环境，我们可以临时修改代码模拟：

在 `pages/user/index.vue` 中临时添加：

```javascript
// 临时测试代码
data() {
  return {
    // 临时修改角色进行测试
    testRole: 'pharmacy'  // 改为 pharmacy 或 viewer 测试
  }
},

computed: {
  isAdmin() {
    // 使用测试角色
    return this.testRole === 'admin'
  }
}
```

**测试：**
- testRole = 'pharmacy': ✅ 应该看不到"用户管理"菜单
- testRole = 'viewer': ✅ 应该看不到"用户管理"菜单

**测试完成后删除测试代码**

---

### 测试4.3：数据验证（5分钟）

#### 在云开发控制台检查：

1. **users 表**
   - ✅ 能看到新添加的用户
   - ✅ lastLogin 字段有更新

2. **operation_logs 表**
   - ✅ 能看到操作日志
   - ✅ 包含：add_user、update_user、delete_user 等

---

### 测试4.4：错误处理（5分钟）

#### 测试项1：重复添加
1. 尝试添加已存在的 openid
2. ✅ 应该显示"该用户已存在"

#### 测试项2：手机号格式
1. 输入错误格式的手机号（如：123）
2. ✅ 应该显示"手机号格式不正确"

#### 测试项3：必填项
1. 不填写姓名，直接提交
2. ✅ 应该显示"请填写完整信息"

---

## 🎉 完成检查清单

完成所有步骤后，确认以下内容：

### 云开发环境
- [ ] 环境ID已配置到 App.vue
- [ ] 6个云函数已部署
- [ ] operation_logs 表已创建
- [ ] users 表有管理员账号

### 功能测试
- [ ] 能正常登录
- [ ] 管理员能看到用户管理菜单
- [ ] 能添加用户
- [ ] 能编辑用户
- [ ] 能禁用/启用用户
- [ ] 能删除用户
- [ ] 不能操作自己的账号

### 数据验证
- [ ] operation_logs 有操作记录
- [ ] users 表数据正确
- [ ] lastLogin 有更新

---

## 🐛 常见问题排查

### 问题1：云函数调用失败

**现象**：控制台显示 `errCode: -1`

**排查步骤：**
1. 检查云开发环境ID是否正确
2. 在云开发控制台 → 云函数 → 查看日志
3. 检查云函数是否正确上传
4. 尝试重新上传云函数

---

### 问题2：登录显示"访问受限"

**现象**：总是提示不在白名单

**排查步骤：**
1. 检查 users 表中的 openid 是否正确
2. 确认 status 字段为 "active"
3. 删除 users 表中的记录，重新添加
4. 重新获取 openid，确保一致

---

### 问题3：看不到用户管理菜单

**现象**：管理员登录后看不到菜单

**排查步骤：**
1. 检查用户角色是否为 "admin"
2. 查看控制台 console.log 输出的角色
3. 清除小程序缓存，重新登录
4. 检查 authMixin 是否正确引入

---

### 问题4：添加用户失败

**现象**：点击添加后无反应或报错

**排查步骤：**
1. 查看控制台错误信息
2. 检查 addUser 云函数日志
3. 确认 operation_logs 表已创建
4. 检查网络连接

---

## 📞 获取帮助

如果遇到无法解决的问题：

1. **查看控制台日志**
   - 浏览器控制台
   - 微信开发者工具控制台
   - 云函数日志

2. **检查文档**
   - 部署和测试指导.md
   - 权限实现示例.md

3. **逐步排查**
   - 从最基础的步骤开始检查
   - 确认每一步都正确完成

4. **记录错误信息**
   - 截图错误提示
   - 复制错误日志
   - 向我咨询时提供详细信息

---

## 🎊 恭喜你！

如果所有测试都通过，说明权限系统已经成功搭建！

接下来你可以：
1. 添加更多测试用户
2. 在其他页面中使用权限控制
3. 根据实际需求调整权限配置
4. 参考《权限调整和扩展指导.md》添加新功能

祝你开发顺利！🚀

---

**文档版本**：v1.0  
**创建日期**：2025-01-27  
**更新日期**：2025-01-27





























