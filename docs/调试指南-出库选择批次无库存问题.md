# 🔍 调试指南 - 出库选择批次无库存问题

## 📋 问题描述

**现象：**
- 选择药材页面显示"布洛芬缓释胶囊"有库存 ✅
- 但选择批次时显示"该药材暂无库存" ❌

**目标：**
找出 drugId 为什么不匹配，定位问题根源。

---

## 🚀 测试步骤

### **步骤1：编译小程序**

```bash
1. 点击微信开发者工具的"编译"按钮
2. 等待编译完成
```

---

### **步骤2：上传云函数**

```bash
1. 右键 cloudfunctions/stockManage 文件夹
2. 点击"上传并部署：云端安装依赖"
3. 等待上传完成
```

---

### **步骤3：清空控制台**

```bash
1. 打开微信开发者工具的控制台
2. 点击"Clear"按钮清空日志
3. 确保能看到新的日志
```

---

### **步骤4：重现问题**

#### **4.1 进入出库页面**
```
首页 → 点击"出库管理" → 点击右上角"+"
```

#### **4.2 选择药材**
```
1. 点击"+ 添加药材"按钮
2. 在列表中勾选"布洛芬缓释胶囊"
3. 点击"确定"
```

**查看控制台日志1：**
```javascript
=== 选择药材确认 ===
选中数量: 1
药材1: 布洛芬缓释胶囊
  - _id: ?????              ← 记录这个值！
  - drugId: ?????           ← 记录这个值！
  - specification: 0.3g×20粒/盒
  - 完整数据: {...}
```

#### **4.3 返回出库页面**
```
自动返回到出库页面
```

**查看控制台日志2：**
```javascript
=== 出库页面 onShow ===
从缓存读取的药材数量: 1
药材1: 布洛芬缓释胶囊
  - drug._id: ?????         ← 对比这个值
  - drug.drugId: ?????      ← 对比这个值
  - 最终使用的 drugId: ????? ← 这是传给批次选择器的值！
  - 完整数据: {...}
当前药材列表: [...]
```

#### **4.4 选择批次**
```
点击"🔍 选择批次"按钮
```

**查看控制台日志3：**
```javascript
=== 批次选择器调试 ===
药材ID (drugId): ?????     ← 对比这个值
药材名称 (drugName): 布洛芬缓释胶囊
默认园区 (location): drug_storage
启用FIFO: true
```

**查看控制台日志4（云函数）：**
```javascript
📊 [云函数] getBatchesByDrugId 调试:
  - drugId: ?????           ← 对比这个值
  - location: drug_storage
  - enableFIFO: true
  - 查询条件: {"drugId":"?????","quantity":{...}}
  - 查询结果数量: 0

⚠️ 未找到库存批次
  - 该药材所有批次数量: ?
  - 所有批次: [...]
  - 有库存的批次数量: ?
```

---

## 📊 数据对比分析

### **关键数据点：**

将上面记录的值填入下表：

| 位置 | 字段 | 值 | 说明 |
|------|------|-----|------|
| 选择药材确认 | drug._id | _______ | 药材档案ID |
| 选择药材确认 | drug.drugId | _______ | 可能为空 |
| 出库页onShow | drug._id | _______ | 应该和上面一样 |
| 出库页onShow | 最终drugId | _______ | **传给批次选择器** |
| 批次选择器 | this.drugId | _______ | **应该和上面一样** |
| 云函数查询 | drugId | _______ | **应该和上面一样** |
| 云函数结果 | 所有批次数量 | _______ | 如果>0说明有数据 |
| 云函数结果 | 有库存批次数量 | _______ | 如果>0但查不到，是园区问题 |

---

## 🎯 问题诊断

### **情况1：drugId 完全一致，但查询结果为0**

```
选择药材: _id = "drug_001"
出库页面: drugId = "drug_001"
批次选择器: drugId = "drug_001"
云函数查询: drugId = "drug_001"
查询结果: 0

✅ drugId 一致
❌ 但数据库中没有这个 drugId 的库存记录
```

**可能原因：**
- stock表中的drugId字段值不对
- 或者location筛选导致无库存

**解决方法：**
```javascript
// 查看云函数日志中的"所有批次"
// 如果"所有批次数量"为0，说明stock表中根本没有这个drugId的记录
// 如果"所有批次数量">0，但"有库存批次"=0，说明quantity都是0

// 如果"有库存批次">0，但查询结果=0，说明是location筛选问题
```

---

### **情况2：drugId 不一致**

```
选择药材: _id = "drug_001"
出库页面: drugId = "drug_001"
批次选择器: drugId = "temp_12345"  ← 不一致！
云函数查询: drugId = "temp_12345"
```

**可能原因：**
- 批次选择器的props传递错误
- 或者组件内部修改了drugId

**解决方法：**
```javascript
// 检查 pages-sub/out/add.vue 第123行
:drug-id="item.drugId"

// 打印 item.drugId 是否正确
```

---

### **情况3：stock表中drugId不匹配**

```
云函数日志显示：
  - 查询条件: {"drugId":"drug_001","quantity":{...}}
  - 查询结果数量: 0
  - 该药材所有批次数量: 0   ← 关键！
  ⚠️ 数据库中完全没有该药材的批次记录
  - 可能是 drugId 不匹配
```

**可能原因：**
- drugs表中药材的_id是"drug_001"
- 但stock表中对应的drugId是其他值（如"布洛芬_001"）

**解决方法：**
```sql
-- 直接查询数据库
-- 查询布洛芬的库存记录
SELECT * FROM stock WHERE drugName LIKE '%布洛芬%'

-- 查看drugId字段的值
-- 然后对比drugs表中的_id
```

---

### **情况4：园区筛选问题**

```
云函数日志显示：
  - 查询条件: {"drugId":"drug_001","quantity":{...},"location":"drug_storage"}
  - 查询结果数量: 0
  - 该药材所有批次数量: 2
  - 有库存的批次数量: 1
  ⚠️ 其他园区可能有库存，当前园区无库存
```

**可能原因：**
- 布洛芬在"陆园"或"水园"有库存
- 但在"drug_storage"（药房）无库存

**解决方法：**
```javascript
// 方案1：去掉园区筛选
:default-location="''"  // 不限园区

// 方案2：改为正确的园区
:default-location="'land_park'"  // 陆园
```

---

## 🔧 快速修复方案

### **方案A：确保drugId正确传递**

```javascript
// 在 pages-sub/out/add.vue 的 onShow 方法中
// 已添加调试日志，确认 finalDrugId 的值

// 如果发现drugId不对，检查：
1. drug._id 是否是正确的药材档案ID
2. drugs表中的_id字段
3. stock表中的drugId字段是否匹配
```

---

### **方案B：修复stock表数据**

```javascript
// 如果发现stock表中的drugId不匹配
// 需要更新stock表

// 示例：更新stock表的drugId
db.collection('stock')
  .where({
    drugName: '布洛芬缓释胶囊'
  })
  .update({
    data: {
      drugId: 'drug_001'  // 改为正确的药材档案ID
    }
  })
```

---

### **方案C：调整批次选择器参数**

```vue
<!-- 在 pages-sub/out/add.vue 第119-129行 -->
<batch-selector
  :button-text="item.batch ? `✓ 批号: ${item.batch}` : '🔍 选择批次'"
  button-type="info"
  button-size="small"
  :drug-id="item.drugId"
  :drug-info="{ 
    name: item.drugName, 
    specification: item.specification || item.spec, 
    unit: item.unit 
  }"
  :show-location-filter="false"
  :default-location="''"          ← 改为空，不限园区
  :enable-f-i-f-o="true"
  @select="(batch) => onBatchSelect(index, batch)"
></batch-selector>
```

---

## 📝 日志示例

### **正常情况的完整日志：**

```javascript
// 1. 选择药材
=== 选择药材确认 ===
选中数量: 1
药材1: 布洛芬缓释胶囊
  - _id: drug_001
  - drugId: 无
  - specification: 0.3g×20粒/盒

// 2. 返回出库页
=== 出库页面 onShow ===
从缓存读取的药材数量: 1
药材1: 布洛芬缓释胶囊
  - drug._id: drug_001
  - drug.drugId: 无
  - 最终使用的 drugId: drug_001     ✅ 使用了 _id

// 3. 打开批次选择器
=== 批次选择器调试 ===
药材ID (drugId): drug_001           ✅ 一致
药材名称 (drugName): 布洛芬缓释胶囊
默认园区 (location): drug_storage
启用FIFO: true

// 4. 云函数查询
📊 [云函数] getBatchesByDrugId 调试:
  - drugId: drug_001                 ✅ 一致
  - location: drug_storage
  - 查询条件: {"drugId":"drug_001","quantity":{...},"location":"drug_storage"}
  - 查询结果数量: 2                  ✅ 找到批次！
  ✅ 找到批次: 2 个
    批次1: {
      batch: "20241101",
      quantity: 50,
      location: "drug_storage",
      expireDate: "2026-11-01"
    }
    批次2: {
      batch: "20241015",
      quantity: 30,
      location: "drug_storage",
      expireDate: "2026-10-15"
    }
```

---

### **异常情况的完整日志：**

```javascript
// 1. 选择药材
=== 选择药材确认 ===
选中数量: 1
药材1: 布洛芬缓释胶囊
  - _id: 64a1b2c3d4e5f6789012345   ← 这是什么ID？
  - drugId: 无

// 2. 返回出库页
=== 出库页面 onShow ===
药材1: 布洛芬缓释胶囊
  - drug._id: 64a1b2c3d4e5f6789012345
  - 最终使用的 drugId: 64a1b2c3d4e5f6789012345  ❌ 可疑！

// 3. 云函数查询
📊 [云函数] getBatchesByDrugId 调试:
  - drugId: 64a1b2c3d4e5f6789012345
  - 查询结果数量: 0
  ⚠️ 未找到库存批次
  - 该药材所有批次数量: 0              ❌ 数据库中没有这个drugId
  ⚠️ 数据库中完全没有该药材的批次记录
  - 可能是 drugId 不匹配
```

**结论：drugId 不匹配！需要检查数据来源。**

---

## ✅ 完成测试后

### **报告格式：**

请提供以下信息：

```markdown
### 测试结果

**drugId链路：**
- 选择药材: _id = _______
- 出库页面: drugId = _______
- 批次选择器: drugId = _______
- 云函数查询: drugId = _______

**查询结果：**
- 查询结果数量: _______
- 所有批次数量: _______
- 有库存批次数量: _______

**结论：**
□ drugId 一致，但数据库无记录
□ drugId 不一致
□ drugId 一致，园区筛选问题
□ 其他：_______

**云函数完整日志：**
```粘贴云函数的完整日志```
```

---

## 🎯 目标

通过这个完整的调试流程，我们将找到：

1. ✅ drugId 在哪个环节出现不一致
2. ✅ stock表中的drugId是什么
3. ✅ 是否是园区筛选问题
4. ✅ 确定准确的解决方案

**准备好了吗？开始测试吧！** 🚀
