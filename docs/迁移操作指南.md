# 📦 v3.14 数据迁移操作指南

## ✅ 前置条件检查

- [x] outRecords 云函数已重命名为 `index.js`
- [x] 编译错误已修复
- [x] 迁移页面已创建：`pages/test/migration.vue`

---

## 🚀 迁移步骤（3步走）

### 第1步：重新编译小程序

```
1. 在微信开发者工具中
2. 点击 "编译" 按钮
3. 等待编译成功（不再有错误）
```

**预期结果**：控制台显示 "编译成功"

---

### 第2步：访问迁移页面

**方式1：控制台导航（推荐）**

在微信开发者工具的控制台（Console）中输入：

```javascript
wx.navigateTo({
  url: '/pages/test/migration'
})
```

**方式2：临时添加首页入口**

如果上面的方法不方便，可以在首页添加一个测试按钮（临时使用）

---

### 第3步：执行迁移操作

在迁移页面中，**按顺序点击按钮**：

#### 3.1 点击 "1️⃣ 环境检查"

等待执行完成，确认看到：

```
✅ 药库配置已存在（或 ⚠️ 药库配置不存在，迁移时会自动创建）
📊 药品档案: X 条
📦 库存记录: X 条
✅ inRecords 正常
✅ outRecords 正常
✅ 环境检查完成，可以开始迁移
```

#### 3.2 点击 "2️⃣ 开始迁移"

等待执行完成（可能需要 2-5 分钟），确认看到：

```
步骤1: 添加药库配置...
✅ 药库配置添加成功
步骤2: 迁移药品档案...
找到 X 个药品
✅ 药品迁移完成: 成功 X, 失败 0
步骤3: 迁移库存数据...
找到 X 条库存
✅ 库存迁移完成: 成功 X, 失败 0
🎉 数据迁移完成！
```

#### 3.3 点击 "3️⃣ 验证结果"

等待执行完成，确认看到：

```
✅ 药库配置存在
📊 药品档案: X/X 包含 specification 字段
📦 库存数据: X/X 包含 specification 字段
🎉 验证通过！所有数据迁移成功
```

此时会弹出提示框："迁移成功，数据迁移已完成，可以开始测试！"

---

## ⚠️ 常见问题

### 问题1：编译失败

**症状**：控制台显示编译错误

**解决**：
- 检查是否有语法错误
- 确认 `pages-sub/in/add.vue` 的第158行已修复
- 尝试关闭小程序，重新编译

### 问题2：云函数调用失败

**症状**：环境检查时显示 "❌ outRecords 调用失败"

**解决**：
1. 确认 `cloudfunctions/outRecords/index.js` 文件存在
2. 在微信开发者工具中，右键 `outRecords` 文件夹
3. 选择 "上传并部署：云端安装依赖"
4. 等待上传完成
5. 重新执行环境检查

### 问题3：迁移部分失败

**症状**：看到 "失败 X" 的提示

**解决**：
- 查看日志中的具体错误信息
- 点击 "🗑️ 清空日志"
- 重新执行 "2️⃣ 开始迁移"
- 如果仍然失败，记录错误信息并报告

### 问题4：无法访问迁移页面

**症状**：控制台执行 `wx.navigateTo` 报错

**解决**：
- 确认 `pages.json` 中已添加页面配置
- 确认 `pages/test/migration.vue` 文件存在
- 重新编译小程序

---

## 📊 迁移数据说明

### 本次迁移会做什么？

1. **添加药库配置**
   - 在 `locations` 集合中添加 `drug_storage`（药库）
   - 用于区分药库和园区的库存

2. **迁移药品档案**
   - 为每个药品添加 `specification` 字段
   - 统一规格字段名称

3. **迁移库存数据**
   - 为每条库存添加 `specification` 字段
   - 添加 `lockQuantity` 字段（预留库存）

### 迁移是否安全？

- ✅ **只添加字段，不删除数据**
- ✅ **不修改现有字段的值**
- ✅ **可重复执行（幂等操作）**
- ✅ **有数据库备份保护**

---

## ✅ 迁移成功后

### 验证迁移结果

1. **打开云开发控制台**
2. **查看 locations 集合**
   - 应该看到一条 `code: 'drug_storage'` 的记录
3. **查看 drugs 集合**
   - 每条记录应该有 `specification` 字段
4. **查看 stock 集合**
   - 每条记录应该有 `specification` 和 `lockQuantity` 字段

### 下一步：功能测试

迁移成功后，可以开始测试新功能：

1. **测试工具类**
   - 测试 `UnitConverter` 单位转换功能
   
2. **测试入库流程**
   - 创建入库单
   - 查看库存变化（药库中增加）

3. **测试出库流程**
   - 创建出库单（从药库到园区）
   - 查看单位转换效果
   - 验证药库减少包装单位，园区增加最小单位

4. **测试门诊消耗**
   - 记录门诊消耗
   - 查看园区库存减少

详细测试步骤请参考：`docs/v3.14_测试指南.md`

---

## 🎯 快速参考

### 迁移命令

```javascript
// 访问迁移页面
wx.navigateTo({ url: '/pages/test/migration' })
```

### 迁移耗时

- 环境检查：10-30 秒
- 数据迁移：2-5 分钟
- 验证结果：10-30 秒
- **总计**：3-6 分钟

### 文档索引

- 📋 测试指南：`docs/v3.14_测试指南.md`
- 📖 详细步骤：`docs/v3.14_准备步骤详解.md`
- 🎯 快速参考：`docs/v3.14_快速参考.md`
- 📐 设计文档：`_backup_docs/📐分园区单位转换界面设计_v3.14_终极版.md`

---

## 💡 提示

1. **迁移过程中不要关闭页面**
2. **观察日志输出，及时发现问题**
3. **迁移完成后可以删除测试页面**
4. **建议在测试环境先执行，验证无误后再在生产环境执行**

---

**祝您迁移顺利！** 🎉







