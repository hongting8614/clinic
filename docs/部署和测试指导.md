# 权限系统部署和测试指导

## 📋 目录

1. [准备工作](#准备工作)
2. [数据库初始化](#数据库初始化)
3. [云函数部署](#云函数部署)
4. [前端配置](#前端配置)
5. [测试流程](#测试流程)
6. [常见问题](#常见问题)

---

## 🎯 准备工作

### 1. 环境要求

- **HBuilderX**：最新版本
- **微信开发者工具**：最新稳定版
- **微信小程序账号**：已注册并开通云开发
- **云开发环境**：已创建云开发环境

### 2. 确认文件清单

确保以下文件已创建：

```
✅ 云函数（5个）
- cloudfunctions/login/
- cloudfunctions/addUser/
- cloudfunctions/getUserList/
- cloudfunctions/updateUser/
- cloudfunctions/deleteUser/
- cloudfunctions/updateUserStatus/

✅ 工具类（2个）
- utils/permission.js
- utils/auth.js

✅ 页面（1个）
- pages-sub/setting/user-list.vue

✅ 文档（3个）
- docs/权限设计方案.md
- docs/权限实现示例.md
- docs/部署和测试指导.md（本文档）
```

---

## 💾 数据库初始化

### 步骤1：创建数据表

在云开发控制台创建以下集合：

#### 1.1 创建 operation_logs 表（操作日志）

```javascript
// 集合名称：operation_logs
// 权限设置：仅管理员可读写

// 示例数据结构
{
  _id: "log_001",
  operator: "oXXXX",              // 操作者openid
  operatorName: "张三",            // 操作者姓名
  action: "add_user",             // 操作类型
  target: "user_002",             // 操作目标ID
  details: {                      // 操作详情
    name: "李四",
    role: "pharmacy"
  },
  timestamp: "2025-01-27 10:00:00"
}
```

**创建索引**：
```javascript
// 在云开发控制台 → 数据库 → operation_logs → 索引
db.collection('operation_logs').createIndex({
  timestamp: -1  // 按时间倒序
})

db.collection('operation_logs').createIndex({
  operator: 1    // 按操作者查询
})

db.collection('operation_logs').createIndex({
  action: 1      // 按操作类型查询
})
```

### 步骤2：更新 users 表

如果你已经有 users 表，需要为现有用户添加新字段：

```javascript
// 在云开发控制台 → 云开发 → 云函数 → 新建云函数
// 创建临时云函数 migrateUsers

const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  try {
    // 获取所有用户
    const users = await db.collection('users').get()
    
    // 更新每个用户
    for (const user of users.data) {
      await db.collection('users').doc(user._id).update({
        data: {
          nickname: user.nickname || user.name,  // 如果没有昵称，使用姓名
          lastLogin: user.lastLogin || null,     // 如果没有登录时间，设为null
          role: user.role || 'admin'              // 现有用户默认为管理员
        }
      })
    }
    
    return {
      success: true,
      count: users.data.length,
      message: '迁移成功'
    }
  } catch (err) {
    return {
      success: false,
      error: err.message
    }
  }
}
```

**执行迁移**：
1. 在微信开发者工具中创建云函数 `migrateUsers`
2. 上传并部署
3. 在云开发控制台 → 云函数 → migrateUsers → 测试
4. 点击"测试"按钮执行
5. 执行完成后删除该云函数

### 步骤3：添加第一个管理员账号

**方法一：在云开发控制台手动添加**

1. 打开云开发控制台 → 数据库 → users
2. 点击"添加记录"
3. 填入以下数据：

```json
{
  "openid": "你的微信openid",
  "name": "系统管理员",
  "nickname": "管理员",
  "phone": "13800138000",
  "role": "admin",
  "status": "active",
  "createTime": {"$date": "2025-01-27T00:00:00.000Z"},
  "updateTime": {"$date": "2025-01-27T00:00:00.000Z"},
  "lastLogin": null
}
```

**获取你的 openid 方法**：
```javascript
// 在小程序任意页面的 onLoad 中临时添加
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('你的openid:', res.result.userInfo.openId)
  }
})
```

**方法二：创建初始化云函数**

```javascript
// cloudfunctions/initAdmin/index.js
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  
  try {
    // 检查是否已有管理员
    const adminCount = await db.collection('users')
      .where({ role: 'admin' })
      .count()
    
    if (adminCount.total > 0) {
      return {
        success: false,
        message: '已存在管理员，无需初始化'
      }
    }
    
    // 创建第一个管理员（当前登录用户）
    await db.collection('users').add({
      data: {
        openid: wxContext.OPENID,
        name: '系统管理员',
        nickname: '管理员',
        phone: '13800138000',
        role: 'admin',
        status: 'active',
        createTime: db.serverDate(),
        updateTime: db.serverDate(),
        lastLogin: null
      }
    })
    
    return {
      success: true,
      openid: wxContext.OPENID,
      message: '管理员初始化成功'
    }
  } catch (err) {
    return {
      success: false,
      error: err.message
    }
  }
}
```

---

## ☁️ 云函数部署

### 步骤1：批量上传云函数

在微信开发者工具中：

1. **展开 cloudfunctions 目录**
2. **逐个上传云函数**（按顺序）：

```bash
# 右键每个云函数目录 → 上传并部署：云端安装依赖

✅ login               # 用户登录
✅ addUser             # 添加用户
✅ getUserList         # 获取用户列表
✅ updateUser          # 更新用户
✅ deleteUser          # 删除用户
✅ updateUserStatus    # 更新用户状态
```

### 步骤2：验证云函数

在云开发控制台测试每个云函数：

#### 测试 login

```json
// 测试参数（空对象）
{}

// 预期返回（如果openid在白名单内）
{
  "code": 0,
  "authorized": true,
  "message": "登录成功",
  "userInfo": {
    "userId": "user_001",
    "openid": "oXXXX",
    "name": "系统管理员",
    "role": "admin"
  }
}
```

#### 测试 getUserList

```json
// 测试参数
{}

// 预期返回
{
  "code": 0,
  "message": "获取成功",
  "data": [
    {
      "_id": "user_001",
      "name": "系统管理员",
      "role": "admin",
      "roleText": "管理员",
      "status": "active"
    }
  ]
}
```

### 步骤3：设置云函数权限

在云开发控制台 → 云函数 → 权限设置：

```javascript
// 所有用户管理相关云函数设置为：仅创建者可访问
// 这样可以确保只有登录用户才能调用
```

---

## 🎨 前端配置

### 步骤1：配置 pages.json

在 `pages.json` 中添加用户管理页面：

```json
{
  "subPackages": [
    {
      "root": "pages-sub/setting",
      "pages": [
        {
          "path": "user-list",
          "style": {
            "navigationBarTitleText": "用户管理"
          }
        }
      ]
    }
  ]
}
```

### 步骤2：添加导航入口

在"我的"页面添加用户管理入口：

```vue
<!-- pages/user/index.vue -->
<template>
  <view class="user-page">
    <!-- 管理员菜单 -->
    <view v-if="isAdmin" class="menu-section">
      <text class="section-title">管理员功能</text>
      <view class="menu-item" @click="navigateTo('/pages-sub/setting/user-list')">
        <text class="menu-icon">👥</text>
        <text class="menu-title">用户管理</text>
        <text class="menu-arrow">→</text>
      </view>
    </view>
  </view>
</template>

<script>
import { authMixin } from '@/utils/auth.js'

export default {
  mixins: [authMixin],
  
  methods: {
    navigateTo(url) {
      uni.navigateTo({ url })
    }
  }
}
</script>
```

### 步骤3：配置 App.js 登录

```javascript
// App.js
import { login } from './utils/auth.js'

App({
  async onLaunch() {
    // 初始化云开发
    if (!wx.cloud) {
      console.error('请使用 2.2.3 或以上的基础库以使用云能力')
    } else {
      wx.cloud.init({
        env: 'your-env-id',  // 替换为你的云开发环境ID
        traceUser: true
      })
    }
    
    // 用户登录验证
    console.log('正在验证用户身份...')
    const loginResult = await login()
    
    if (!loginResult.success) {
      // 不在白名单
      wx.showModal({
        title: '访问受限',
        content: loginResult.message || '您不在系统白名单内，请联系管理员',
        showCancel: false,
        success: () => {
          // 可以跳转到一个说明页面
          console.log('用户未授权')
        }
      })
    } else {
      console.log('登录成功:', loginResult.userInfo)
    }
  }
})
```

---

## 🧪 测试流程

### 测试准备

创建测试账号（手动在数据库中添加）：

```javascript
// 测试账号1：管理员
{
  openid: "test_admin_openid",
  name: "测试管理员",
  phone: "13800000001",
  role: "admin",
  status: "active"
}

// 测试账号2：药房人员
{
  openid: "test_pharmacy_openid",
  name: "测试药房人员",
  phone: "13800000002",
  role: "pharmacy",
  status: "active"
}

// 测试账号3：查看者
{
  openid: "test_viewer_openid",
  name: "测试查看者",
  phone: "13800000003",
  role: "viewer",
  status: "active"
}
```

### 测试用例

#### 测试1：登录验证 ✅

**步骤**：
1. 清除小程序缓存
2. 重新打开小程序
3. 观察控制台输出

**预期**：
- ✅ 白名单用户：显示"登录成功"
- ✅ 非白名单用户：显示"访问受限"提示

---

#### 测试2：用户管理页面权限 ✅

**测试2.1：管理员访问**

**步骤**：
1. 使用管理员账号登录
2. 进入"我的"页面
3. 点击"用户管理"

**预期**：
- ✅ 能看到"用户管理"菜单
- ✅ 能正常打开用户管理页面
- ✅ 能看到所有用户列表

**测试2.2：非管理员访问**

**步骤**：
1. 使用药房人员或查看者账号登录
2. 进入"我的"页面
3. 尝试访问用户管理页面（可通过URL直接跳转测试）

**预期**：
- ✅ 看不到"用户管理"菜单
- ✅ 直接访问URL会弹出"权限不足"提示并返回

---

#### 测试3：添加用户功能 ✅

**步骤**：
1. 管理员登录
2. 进入用户管理页面
3. 点击"添加用户"按钮
4. 填写表单：
   - OpenID: `oTest123456`
   - 姓名: `测试用户`
   - 手机号: `13900000000`
   - 角色: `pharmacy`
5. 点击"添加"

**预期**：
- ✅ 表单验证通过
- ✅ 显示"添加成功"提示
- ✅ 用户列表自动刷新
- ✅ 新用户出现在列表中

**测试失败情况**：
- ❌ 重复添加：显示"该用户已存在"
- ❌ 手机号格式错误：显示"手机号格式不正确"
- ❌ 必填项未填：显示"请填写完整信息"

---

#### 测试4：编辑用户功能 ✅

**步骤**：
1. 点击用户卡片的"编辑"按钮
2. 修改姓名为"测试用户（已修改）"
3. 修改角色为"viewer"
4. 点击"保存"

**预期**：
- ✅ 显示"保存成功"
- ✅ 用户信息已更新

**测试特殊情况**：
- ❌ 编辑自己的账号角色：应显示"不能修改自己的角色"

---

#### 测试5：禁用/启用用户 ✅

**步骤**：
1. 点击用户的"禁用"按钮
2. 确认操作

**预期**：
- ✅ 显示"操作成功"
- ✅ 用户状态变为"已禁用"
- ✅ 用户卡片显示半透明效果

**测试特殊情况**：
- ❌ 禁用自己：应显示"不能禁用自己的账号"
- ❌ 禁用最后一个管理员：应显示"不能禁用最后一个管理员账号"

---

#### 测试6：删除用户 ✅

**步骤**：
1. 点击用户的"删除"按钮
2. 确认操作

**预期**：
- ✅ 显示"删除成功"
- ✅ 用户从列表中消失

**测试特殊情况**：
- ❌ 删除自己：应显示"不能删除自己的账号"
- ❌ 删除最后一个管理员：应显示"不能删除最后一个管理员账号"

---

#### 测试7：筛选功能 ✅

**步骤**：
1. 点击"角色"筛选
2. 选择"管理员"

**预期**：
- ✅ 只显示角色为"管理员"的用户

---

#### 测试8：登录后权限生效 ✅

**步骤**：
1. 使用管理员账号登录
2. 尝试访问"药材管理" → "添加药材"
3. 退出登录
4. 使用查看者账号登录
5. 再次尝试访问"添加药材"

**预期**：
- ✅ 管理员：可以正常访问
- ✅ 查看者：显示"权限不足"提示

---

#### 测试9：操作日志记录 ✅

**步骤**：
1. 执行添加/编辑/删除用户操作
2. 查看数据库 operation_logs 表

**预期**：
- ✅ 每个操作都有对应的日志记录
- ✅ 日志包含：操作者、操作类型、目标、时间戳

---

### 性能测试

#### 测试10：用户列表加载速度

**步骤**：
1. 在数据库中添加50个测试用户
2. 打开用户管理页面
3. 记录加载时间

**预期**：
- ✅ 3秒内完成加载
- ✅ 数据正确显示

---

### 安全测试

#### 测试11：云函数权限验证

**步骤**：
1. 使用非管理员账号的openid
2. 直接调用 addUser 云函数

```javascript
wx.cloud.callFunction({
  name: 'addUser',
  data: {
    openid: 'hack_test',
    name: '恶意用户',
    phone: '13900000000',
    role: 'admin'
  }
})
```

**预期**：
- ✅ 返回"权限不足"错误
- ✅ 用户未被添加到数据库

---

## 🐛 常见问题

### 问题1：找不到 openid

**症状**：添加用户时不知道填什么openid

**解决方案**：
```javascript
// 临时获取openid的方法
// 在任意页面添加
onLoad() {
  wx.cloud.callFunction({
    name: 'login',
    success: res => {
      console.log('当前用户openid:', res.result.userInfo.openId)
      // 或者弹窗显示
      wx.showModal({
        title: '你的OpenID',
        content: res.result.userInfo.openId,
        showCancel: false
      })
    }
  })
}
```

---

### 问题2：云函数调用失败

**症状**：调用云函数时报错 "errCode: -1"

**可能原因**：
1. 云函数未正确部署
2. 云开发环境ID配置错误
3. 网络问题

**解决方案**：
```javascript
// 1. 检查 App.js 中的环境ID
wx.cloud.init({
  env: 'your-env-id'  // 确认这里的ID是否正确
})

// 2. 重新上传云函数
// 右键云函数 → 上传并部署：云端安装依赖

// 3. 查看云函数日志
// 云开发控制台 → 云函数 → 日志 → 查看错误信息
```

---

### 问题3：权限判断不生效

**症状**：页面应该被拦截，但没有拦截

**可能原因**：
1. 权限混入未正确引入
2. 角色信息未正确保存到本地存储

**解决方案**：
```javascript
// 1. 检查页面是否引入混入
import { authMixin } from '@/utils/auth.js'
export default {
  mixins: [authMixin],  // 确认这行存在
  ...
}

// 2. 检查本地存储
console.log('当前角色:', uni.getStorageSync('userRole'))

// 3. 清除缓存重新登录
uni.clearStorageSync()
// 重启小程序
```

---

### 问题4：页面报错 "authMixin is not defined"

**症状**：页面加载时控制台报错

**解决方案**：
```javascript
// 检查导入路径是否正确
// 如果是 pages/ 目录下的页面
import { authMixin } from '@/utils/auth.js'

// 如果是 pages-sub/ 目录下的页面
import { authMixin } from '@/utils/auth.js'  // 路径相同
```

---

### 问题5：无法添加第一个管理员

**症状**：系统刚初始化，没有管理员账号

**解决方案**：

**方法1：使用临时初始化云函数**（推荐）
```javascript
// 创建 cloudfunctions/initAdmin/index.js
// 代码见前文"数据库初始化"部分
// 上传后在控制台测试即可
```

**方法2：直接在数据库添加**
1. 打开云开发控制台
2. 数据库 → users → 添加记录
3. 填入管理员信息（见前文）

---

### 问题6：操作日志表不存在

**症状**：云函数报错 "collection 'operation_logs' not found"

**解决方案**：
1. 在云开发控制台创建 operation_logs 集合
2. 权限设置为"仅管理员可读写"

---

## ✅ 测试清单

使用此清单确保所有功能正常：

```
□ 登录功能
  □ 白名单用户可登录
  □ 非白名单用户被拦截
  
□ 用户管理页面
  □ 管理员可访问
  □ 非管理员不可访问
  □ 用户列表正确显示
  □ 统计数据正确
  
□ 添加用户
  □ 表单验证正常
  □ 成功添加到数据库
  □ 重复添加被阻止
  
□ 编辑用户
  □ 信息正确回显
  □ 成功保存修改
  □ 不能修改自己的角色
  
□ 禁用/启用用户
  □ 状态正确切换
  □ 不能禁用自己
  □ 不能禁用最后一个管理员
  
□ 删除用户
  □ 成功删除
  □ 不能删除自己
  □ 不能删除最后一个管理员
  
□ 筛选功能
  □ 按角色筛选正常
  □ 按状态筛选正常
  
□ 操作日志
  □ 所有操作都有日志
  □ 日志信息完整
  
□ 安全性
  □ 云函数权限验证生效
  □ 前端权限拦截生效
```

---

## 📞 技术支持

如遇到问题：

1. **查看控制台日志**
   - 浏览器控制台
   - 微信开发者工具控制台
   - 云函数日志

2. **检查文档**
   - 权限设计方案.md
   - 权限实现示例.md

3. **查看代码注释**
   - 所有关键代码都有详细注释

---

**文档版本**：v1.0  
**最后更新**：2025-01-27  
**维护者**：开发团队





























