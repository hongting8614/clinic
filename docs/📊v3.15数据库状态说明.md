# ğŸ“Š v3.15 æ•°æ®åº“çŠ¶æ€è¯´æ˜

> ğŸ“… ç‰ˆæœ¬ï¼šv3.15  
> ğŸ—„ï¸ æ¶‰åŠé›†åˆï¼š`in_records`  
> ğŸ¯ æ ¸å¿ƒå˜æ›´ï¼š`supplier` â†’ `remark`

---

## ğŸ“‹ æ•°æ®ç»“æ„å˜åŒ–

### v3.14 åŠä¹‹å‰ç‰ˆæœ¬

```javascript
// in_records é›†åˆ
{
  _id: "record_xxx",
  drugName: "å¸ƒæ´›èŠ¬ç¼“é‡Šèƒ¶å›Š",
  spec: "0.3g*20ç²’/ç›’",
  batchNo: "20251101",
  expireDate: "2026-11-01",
  quantity: 10,
  price: 15.8,
  supplier: "XXåŒ»è¯å…¬å¸",  // â† ä¾›åº”å•†å­—æ®µ
  operator: "å¼ ä¸‰",
  status: "pending",
  createTime: 1700000000000,
  // ... å…¶ä»–å­—æ®µ
}
```

### v3.15 ç‰ˆæœ¬

```javascript
// in_records é›†åˆï¼ˆæ–°è®°å½•ï¼‰
{
  _id: "record_xxx",
  drugName: "å¸ƒæ´›èŠ¬ç¼“é‡Šèƒ¶å›Š",
  spec: "0.3g*20ç²’/ç›’",
  batchNo: "20251116",
  expireDate: "2026-11-16",
  quantity: 10,
  price: 15.8,
  remark: "æ€¥ç”¨è¯æï¼Œä¼˜å…ˆå…¥åº“",  // â† å¤‡æ³¨å­—æ®µï¼ˆæ–°ï¼‰
  operator: "æå››",
  status: "pending",
  createTime: 1731744000000,
  // ... å…¶ä»–å­—æ®µ
  // æ³¨æ„ï¼šæ²¡æœ‰ supplier å­—æ®µ
}
```

---

## ğŸ”„ æ•°æ®å…¼å®¹æ€§

### å†å²æ•°æ®ï¼ˆv3.14ä¹‹å‰ï¼‰
- âœ… **å®Œå…¨ä¿ç•™**ï¼šæ‰€æœ‰å­—æ®µåŒ…æ‹¬ `supplier` éƒ½ä¿ç•™
- âœ… **æ­£å¸¸è®¿é—®**ï¼šå¯ä»¥æ­£å¸¸æŸ¥è¯¢ã€æ˜¾ç¤ºã€å¯¼å‡º
- âš ï¸ **ä¸å†æ˜¾ç¤º**ï¼šå‰ç«¯ç•Œé¢ä¸æ˜¾ç¤º `supplier` å­—æ®µ

### æ–°æ•°æ®ï¼ˆv3.15ä¹‹åï¼‰
- âœ… **æ–°å­—æ®µ**ï¼šä½¿ç”¨ `remark` å­—æ®µè®°å½•å¤‡æ³¨
- âœ… **æ—  supplier**ï¼šä¸å†åŒ…å« `supplier` å­—æ®µ
- âœ… **å®Œå…¨å…¼å®¹**ï¼šä¸å†å²æ•°æ®å¹¶å­˜æ— å†²çª

---

## ğŸ“Š æ•°æ®åº“å½“å‰çŠ¶æ€

### é›†åˆï¼š`in_records`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®°å½•ç±»å‹   â”‚  supplier   â”‚   remark     â”‚    æ•°é‡     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†å²è®°å½•     â”‚   âœ… å­˜åœ¨    â”‚   å¯èƒ½å­˜åœ¨   â”‚   Næ¡       â”‚
â”‚ v3.15æ–°è®°å½•  â”‚   âŒ ä¸å­˜åœ¨  â”‚   âœ… å­˜åœ¨    â”‚   Mæ¡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ¸…ç†å†³ç­–ï¼šä¸æ¸…ç†

### å†³ç­–ç†ç”±

#### 1. æ•°æ®å®Œæ•´æ€§ âœ…
- å†å²è®°å½•ä¿æŒå®Œæ•´
- å¯è¿½æº¯å†å²ä¾›åº”å•†ä¿¡æ¯
- æ»¡è¶³å®¡è®¡å’Œåˆè§„è¦æ±‚

#### 2. åŠŸèƒ½å…¼å®¹æ€§ âœ…
- å‰ç«¯ä»£ç å·²é€‚é…ï¼šä¸è¯»å– `supplier` å­—æ®µ
- äº‘å‡½æ•°å·²é€‚é…ï¼šä¸æŸ¥è¯¢ `supplier` å­—æ®µ
- æŠ¥è¡¨å·²é€‚é…ï¼šä¸ç»Ÿè®¡ `supplier` ç»´åº¦

#### 3. é£é™©æœ€å°åŒ– âœ…
- é›¶æ“ä½œé£é™©
- æ•°æ®æ°¸ä¸ä¸¢å¤±
- å¯éšæ—¶å›æ»šåˆ°v3.14

#### 4. æˆæœ¬æ•ˆç›Š âœ…
- æ¸…ç†å·¥ä½œé‡ï¼šä¸­ç­‰
- æ¸…ç†æ”¶ç›Šï¼šå‡ ä¹ä¸ºé›¶ï¼ˆå­˜å‚¨æˆæœ¬å¯å¿½ç•¥ï¼‰
- é£é™©æˆæœ¬ï¼šæ•°æ®ä¸¢å¤±é£é™©

---

## ğŸ” æ•°æ®æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢æ‰€æœ‰è®°å½•ï¼ˆåŒ…å«å†å²ï¼‰

```javascript
// äº‘å‡½æ•°
const db = cloud.database();

const { data } = await db.collection('in_records')
  .orderBy('createTime', 'desc')
  .get();

// ç»“æœåŒ…å«ï¼š
// - æœ‰supplierå­—æ®µçš„å†å²è®°å½•
// - æœ‰remarkå­—æ®µçš„æ–°è®°å½•
// - ä¸¤è€…æ··åˆï¼Œäº’ä¸å½±å“
```

### æŸ¥è¯¢æ–°è®°å½•ï¼ˆv3.15åï¼‰

```javascript
// æŒ‰åˆ›å»ºæ—¶é—´ç­›é€‰ï¼ˆå‡è®¾2025-11-16åä¸ºv3.15ï¼‰
const v315Date = new Date('2025-11-16').getTime();

const { data } = await db.collection('in_records')
  .where({
    createTime: db.command.gte(v315Date)
  })
  .get();

// è¿™äº›è®°å½•åº”è¯¥æœ‰remarkå­—æ®µï¼Œæ— supplierå­—æ®µ
```

### ç»Ÿè®¡å†å²ä¾›åº”å•†ä¿¡æ¯ï¼ˆå¦‚éœ€è¦ï¼‰

```javascript
// è™½ç„¶å‰ç«¯ä¸æ˜¾ç¤ºï¼Œä½†æ•°æ®ä»å¯æŸ¥è¯¢
const { data } = await db.collection('in_records')
  .where({
    supplier: db.command.exists(true)
  })
  .get();

console.log(`å†å²è®°å½•ä¸­æœ‰ä¾›åº”å•†ä¿¡æ¯çš„ï¼š${data.length}æ¡`);
```

---

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨ä¿éšœ

### è‡ªåŠ¨å¤‡ä»½
è…¾è®¯äº‘å¼€å‘ä¼šè‡ªåŠ¨å¤‡ä»½æ•°æ®åº“ï¼š
- ğŸ“… æ¯æ—¥è‡ªåŠ¨å¤‡ä»½
- â° ä¿ç•™7å¤©
- ğŸ”„ å¯éšæ—¶æ¢å¤

### æ‰‹åŠ¨å¤‡ä»½å»ºè®®
å¦‚éœ€é•¿æœŸä¿å­˜ï¼š
1. å¯¼å‡ºæ•´ä¸ª `in_records` é›†åˆ
2. ä¿å­˜ä¸ºJSONæ–‡ä»¶
3. å­˜å‚¨åœ¨å®‰å…¨ä½ç½®

```bash
# å¯¼å‡ºå‘½ä»¤ï¼ˆç¤ºä¾‹ï¼‰
tcb db export -e your-env-id -c in_records -f in_records_backup.json
```

---

## ğŸ”„ å¦‚æœå°†æ¥éœ€è¦æ¸…ç†

### æ¸…ç†æ—¶æœº
å»ºè®®åœ¨ä»¥ä¸‹æƒ…å†µä¸‹è€ƒè™‘æ¸…ç†ï¼š
- âœ… v3.15è¿è¡Œç¨³å®šè¶…è¿‡3ä¸ªæœˆ
- âœ… ç¡®è®¤ä¸éœ€è¦å›æ»š
- âœ… å†å²ä¾›åº”å•†ä¿¡æ¯å·²å½’æ¡£
- âœ… å¾—åˆ°ç®¡ç†å±‚æ‰¹å‡†

### æ¸…ç†æ–¹æ³•
åˆ›å»ºäº‘å‡½æ•°æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```javascript
// äº‘å‡½æ•°ï¼šcleanSupplierField
const cloud = require('wx-server-sdk');
cloud.init();
const db = cloud.database();
const _ = db.command;

exports.main = async (event, context) => {
  try {
    // 1. ç»Ÿè®¡éœ€è¦æ¸…ç†çš„è®°å½•æ•°
    const { total } = await db.collection('in_records')
      .where({ supplier: _.exists(true) })
      .count();
    
    console.log(`éœ€è¦æ¸…ç†çš„è®°å½•æ•°ï¼š${total}`);
    
    // 2. æ‰¹é‡åˆ é™¤supplierå­—æ®µ
    const batchSize = 1000;
    let processed = 0;
    
    while (processed < total) {
      const { data } = await db.collection('in_records')
        .where({ supplier: _.exists(true) })
        .limit(batchSize)
        .get();
      
      for (let record of data) {
        await db.collection('in_records').doc(record._id).update({
          data: {
            supplier: _.remove()
          }
        });
      }
      
      processed += data.length;
      console.log(`å·²å¤„ç†ï¼š${processed}/${total}`);
    }
    
    return { success: true, processed };
  } catch (error) {
    console.error('æ¸…ç†å¤±è´¥ï¼š', error);
    return { success: false, error: error.message };
  }
};
```

### âš ï¸ æ¸…ç†å‰åŠ¡å¿…
1. ğŸ“¦ å®Œæ•´å¤‡ä»½æ•°æ®åº“
2. ğŸ§ª åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
3. ğŸ“ è®°å½•æ¸…ç†æ—¥å¿—
4. ğŸ‘¥ é€šçŸ¥ç›¸å…³äººå‘˜

---

## ğŸ“ˆ æ•°æ®å¢é•¿é¢„æµ‹

å‡è®¾æ¯å¤©æ–°å»º5æ¡å…¥åº“å•ï¼š

```
æ—¶é—´          å†å²è®°å½•(æœ‰supplier)    æ–°è®°å½•(æœ‰remark)    æ€»è®°å½•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç°åœ¨(v3.15)        100æ¡                  0æ¡            100æ¡
1ä¸ªæœˆå            100æ¡                 150æ¡           250æ¡
3ä¸ªæœˆå            100æ¡                 450æ¡           550æ¡
6ä¸ªæœˆå            100æ¡                 900æ¡          1000æ¡
1å¹´å              100æ¡                1800æ¡          1900æ¡
```

**ç»“è®º**ï¼šéšæ—¶é—´æ¨ç§»ï¼Œæ–°è®°å½•å æ¯”è¶Šæ¥è¶Šå¤§ï¼Œå†å²è®°å½•çš„`supplier`å­—æ®µå½±å“è¶Šæ¥è¶Šå°ã€‚

---

## âœ… æœ€ä½³å®è·µå»ºè®®

### å¼€å‘å»ºè®®
1. **ä»£ç å…¼å®¹**ï¼šå§‹ç»ˆæ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
   ```javascript
   if (record.supplier) {
     // å¤„ç†å†å²è®°å½•
   }
   if (record.remark) {
     // å¤„ç†æ–°è®°å½•
   }
   ```

2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä¸æŸ¥è¯¢æœªä½¿ç”¨çš„å­—æ®µ
   ```javascript
   // å¥½çš„åšæ³•
   .field({ drugName: true, spec: true, remark: true })
   
   // é¿å…
   .field({ supplier: true })  // ä¸å†éœ€è¦
   ```

3. **æ–‡æ¡£æ³¨é‡Š**ï¼šè¯´æ˜å­—æ®µå†å²
   ```javascript
   /**
    * @property {string} supplier - ä¾›åº”å•†ï¼ˆv3.14åºŸå¼ƒï¼Œä»…å†å²æ•°æ®å­˜åœ¨ï¼‰
    * @property {string} remark - å¤‡æ³¨ï¼ˆv3.15æ–°å¢ï¼‰
    */
   ```

### è¿ç»´å»ºè®®
1. å®šæœŸç›‘æ§æ•°æ®åº“å¤§å°
2. æ¯æœˆç”Ÿæˆæ•°æ®æŠ¥å‘Š
3. æ¯å­£åº¦è¯„ä¼°æ˜¯å¦éœ€è¦å½’æ¡£
4. æ¯å¹´è¯„ä¼°æ˜¯å¦éœ€è¦æ¸…ç†åºŸå¼ƒå­—æ®µ

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å†å²æ•°æ®çš„supplierå­—æ®µä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
**A**: ä¸ä¼šã€‚æœªä½¿ç”¨çš„å­—æ®µä¸å½±å“æŸ¥è¯¢æ€§èƒ½ã€‚

### Q2: å¯ä»¥åŒæ—¶æœ‰supplierå’Œremarkå—ï¼Ÿ
**A**: ç†è®ºä¸Šå¯ä»¥ï¼Œä½†v3.15ååˆ›å»ºçš„è®°å½•åªæœ‰remarkã€‚

### Q3: å¦‚ä½•æŸ¥çœ‹æŸæ¡è®°å½•æ˜¯å†å²è®°å½•è¿˜æ˜¯æ–°è®°å½•ï¼Ÿ
**A**: é€šè¿‡ `createTime` å­—æ®µï¼Œ2025-11-16åçš„ä¸ºæ–°è®°å½•ã€‚

### Q4: å›æ»šåˆ°v3.14ä¼šæœ‰é—®é¢˜å—ï¼Ÿ
**A**: ä¸ä¼šã€‚v3.14çš„ä»£ç å¯ä»¥æ­£å¸¸è¯»å–ä¸¤ç§è®°å½•ã€‚

### Q5: å°†æ¥å‡çº§åˆ°v3.16ä¼šæœ‰é—®é¢˜å—ï¼Ÿ
**A**: ä¸ä¼šã€‚ä¿æŒå‘åå…¼å®¹å³å¯ã€‚

---

## ğŸ“Š æ•°æ®åº“å¥åº·æ£€æŸ¥

### å®šæœŸæ£€æŸ¥é¡¹

```javascript
// äº‘å‡½æ•°ï¼šcheckDatabaseHealth
const db = cloud.database();
const _ = db.command;

// 1. ç»Ÿè®¡è®°å½•ç±»å‹åˆ†å¸ƒ
const totalRecords = await db.collection('in_records').count();
const withSupplier = await db.collection('in_records')
  .where({ supplier: _.exists(true) }).count();
const withRemark = await db.collection('in_records')
  .where({ remark: _.exists(true) }).count();

console.log(`
æ•°æ®åº“å¥åº·æŠ¥å‘Š
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®°å½•æ•°ï¼š${totalRecords.total}
æœ‰supplierå­—æ®µï¼š${withSupplier.total} (${(withSupplier.total/totalRecords.total*100).toFixed(1)}%)
æœ‰remarkå­—æ®µï¼š${withRemark.total} (${(withRemark.total/totalRecords.total*100).toFixed(1)}%)
`);
```

---

## ğŸ¯ æ€»ç»“

### å½“å‰ç­–ç•¥ï¼šâœ… ä¸æ¸…ç†supplierå­—æ®µ

- âœ… **å†å²æ•°æ®**ï¼šå®Œæ•´ä¿ç•™
- âœ… **æ–°æ•°æ®**ï¼šä½¿ç”¨remark
- âœ… **å…¼å®¹æ€§**ï¼šå®Œç¾å…±å­˜
- âœ… **é£é™©**ï¼šé›¶é£é™©
- âœ… **æˆæœ¬**ï¼šé›¶æˆæœ¬

### æœªæ¥æ–¹å‘ï¼š
- ğŸ“Š æŒç»­ç›‘æ§æ•°æ®åº“çŠ¶æ€
- ğŸ“ˆ æ¯å­£åº¦è¯„ä¼°æ¸…ç†å¿…è¦æ€§
- ğŸ”„ 3-6ä¸ªæœˆåè€ƒè™‘å½’æ¡£å†å²æ•°æ®
- ğŸ—„ï¸ 1å¹´åè€ƒè™‘æ¸…ç†åºŸå¼ƒå­—æ®µï¼ˆå¯é€‰ï¼‰

---

**ç»“è®ºï¼šç°é˜¶æ®µæ— éœ€ä»»ä½•æ•°æ®åº“æ“ä½œï¼** âœ¨

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0 | æ›´æ–°æ—¥æœŸï¼š2025-11-16 | è´Ÿè´£äººï¼šå¼€å‘å›¢é˜Ÿ*

