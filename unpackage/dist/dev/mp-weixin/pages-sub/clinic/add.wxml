<view class="clinic-add data-v-0904e2e0"><scroll-view class="clinic-scroll data-v-0904e2e0" scroll-y="{{true}}" scroll-into-view="{{activeFieldId}}"><view class="page-header data-v-0904e2e0"><view class="title data-v-0904e2e0">北京欢乐谷医务室</view><view class="subtitle data-v-0904e2e0">门诊登记表</view></view><view class="top-actions-card data-v-0904e2e0"><view class="top-buttons data-v-0904e2e0"><button data-event-opts="{{[['tap',[['openLocationSelector',['$event']]]]]}}" class="top-btn primary data-v-0904e2e0" bindtap="__e">{{''+(locationLocked?'选择园区':currentLocationLabel)+''}}</button><button data-event-opts="{{[['tap',[['generateDailyReport',['$event']]]]]}}" class="top-btn ghost data-v-0904e2e0" bindtap="__e">门诊日报</button></view></view><block wx:if="{{showLocationTip}}"><view class="location-modal-overlay data-v-0904e2e0"><view class="location-modal data-v-0904e2e0"><view class="modal-icon-row data-v-0904e2e0"><view class="modal-icon-circle data-v-0904e2e0">园</view></view><view class="modal-title data-v-0904e2e0">请选择当前所在园区</view><view class="modal-subtitle data-v-0904e2e0">{{"当前："+currentLocationLabel+"，用于统计门诊登记、日报等数据"}}</view><view class="modal-location-buttons data-v-0904e2e0"><button data-event-opts="{{[['tap',[['handleLocationSelect',['land_park']]]]]}}" class="{{['modal-loc-btn','data-v-0904e2e0',(form.location==='land_park')?'active':'']}}" bindtap="__e">陆园</button><button data-event-opts="{{[['tap',[['handleLocationSelect',['water_park']]]]]}}" class="{{['modal-loc-btn','data-v-0904e2e0',(form.location==='water_park')?'active':'']}}" bindtap="__e">水园</button></view><view class="modal-hint-text data-v-0904e2e0">后续可随时通过上方“选择园区”按钮切换，不影响已登记记录。</view><view data-event-opts="{{[['tap',[['e0',['$event']]]]]}}" class="modal-row data-v-0904e2e0" bindtap="__e"><checkbox checked="{{noTipNextTime}}" class="data-v-0904e2e0"></checkbox><text class="modal-checkbox-text data-v-0904e2e0">下次不再提醒</text></view><button data-event-opts="{{[['tap',[['closeLocationTip',['$event']]]]]}}" class="modal-close-btn data-v-0904e2e0" bindtap="__e">关闭提示</button></view></view></block><view class="form-section data-v-0904e2e0" id="field-remark"><view class="section-title data-v-0904e2e0">患者基本信息</view><view class="form-row data-v-0904e2e0"><view class="form-item half data-v-0904e2e0" id="field-name"><view class="label required data-v-0904e2e0">就诊日期时间</view><view class="datetime-display data-v-0904e2e0">{{form.visitDateTime}}</view></view><view class="form-item half data-v-0904e2e0"><view class="label required data-v-0904e2e0">身份</view><view class="identity-selector data-v-0904e2e0"><block wx:for="{{identityOptions}}" wx:for-item="idOpt" wx:for-index="__i0__" wx:key="value"><view data-event-opts="{{[['tap',[['setIdentity',['$0'],[[['identityOptions','value',idOpt.value,'value']]]]]]]}}" class="{{['identity-item','data-v-0904e2e0',(form.identity===idOpt.value)?'active':'']}}" bindtap="__e">{{''+idOpt.label+''}}</view></block></view></view></view><view class="form-row data-v-0904e2e0"><view class="form-item half data-v-0904e2e0"><view class="label required data-v-0904e2e0">姓名</view><input type="text" placeholder="选园区后输入姓名" disabled="{{locationLocked}}" cursor-spacing="80" data-event-opts="{{[['input',[['__set_model',['$0','name','$event',[]],['form']]]]]}}" value="{{form.name}}" bindinput="__e" class="data-v-0904e2e0"/></view><view class="form-item half data-v-0904e2e0"><view class="label required data-v-0904e2e0">性别 / 年龄</view><view class="gender-age-row data-v-0904e2e0"><view class="gender-selector compact data-v-0904e2e0"><view data-event-opts="{{[['tap',[['e1',['$event']]]]]}}" class="{{['gender-item','data-v-0904e2e0',(form.gender==='男')?'active':'']}}" bindtap="__e"> 男 </view><view data-event-opts="{{[['tap',[['e2',['$event']]]]]}}" class="{{['gender-item','data-v-0904e2e0',(form.gender==='女')?'active':'']}}" bindtap="__e"> 女 </view></view><input class="age-input data-v-0904e2e0" type="number" inputmode="numeric" pattern="[0-9]*" maxlength="{{3}}" focus="{{ageFocus}}" confirm-type="done" placeholder="年龄" data-event-opts="{{[['tap',[['e3',['$event']]]],['blur',[['e4',['$event']],['$forceUpdate']]],['input',[['__set_model',['$0','age','$event',['number']],['form']]]]]}}" value="{{form.age}}" bindtap="__e" bindblur="__e" bindinput="__e"/></view></view></view><view class="form-item data-v-0904e2e0" id="field-chiefComplaint"><view class="label required data-v-0904e2e0">主诉</view><view class="disease-input-wrapper data-v-0904e2e0"><textarea class="{{['data-v-0904e2e0','textarea-uniform','textarea-auto',complaintFontSizeClass]}}" placeholder="请输入患者自述症状，例如：头部外伤伴头晕" maxlength="100" focus="{{complaintFocus}}" data-event-opts="{{[['focus',[['onComplaintFocus'],['onFieldFocus',['field-chiefComplaint']]]],['input',[['__set_model',['$0','chiefComplaint','$event',[]],['form']],['onComplaintInput',['$event']]]],['blur',[['onComplaintBlur',['$event']]]]]}}" value="{{form.chiefComplaint}}" bindfocus="__e" bindinput="__e" bindblur="__e"></textarea><block wx:if="{{$root.g0}}"><view class="disease-dropdown data-v-0904e2e0"><scroll-view class="disease-scroll data-v-0904e2e0" scroll-y="{{true}}"><block wx:for="{{filteredComplaints}}" wx:for-item="opt" wx:for-index="__i1__" wx:key="key"><view data-event-opts="{{[['tap',[['selectComplaint',['$0'],[[['filteredComplaints','key',opt.key]]]]]]]}}" class="disease-item data-v-0904e2e0" bindtap="__e">{{''+opt.label+''}}</view></block></scroll-view></view></block></view></view></view><view class="form-section data-v-0904e2e0"><view class="section-title data-v-0904e2e0">就诊信息</view><view class="form-row data-v-0904e2e0"><view class="form-item half data-v-0904e2e0"><view class="label required data-v-0904e2e0">是否出诊</view><view class="identity-selector visit-type-selector data-v-0904e2e0"><block wx:for="{{visitTypeOptions}}" wx:for-item="vt" wx:for-index="__i2__" wx:key="value"><view data-event-opts="{{[['tap',[['setVisitType',['$0'],[[['visitTypeOptions','value',vt.value,'value']]]]]]]}}" class="{{['identity-item','data-v-0904e2e0',(form.visitType===vt.value)?'active':'']}}" bindtap="__e"><text class="visit-type-text data-v-0904e2e0">{{vt.label}}</text></view></block></view></view><view class="form-item half data-v-0904e2e0"><view class="{{['label','data-v-0904e2e0',(form.visitType==='outcall')?'required':'']}}">受伤地点</view><view class="location-input-wrapper data-v-0904e2e0"><input class="input-uniform data-v-0904e2e0" type="text" placeholder="{{form.visitType==='outcall'?'请输入受伤地点（必填）':'例如：机动游戏区、餐饮区（可选）'}}" data-event-opts="{{[['focus',[['onLocationFocus'],['onFieldFocus',['field-injuryLocation']]]],['input',[['__set_model',['$0','injuryLocation','$event',[]],['form']],['onLocationInput',['$event']]]]]}}" value="{{form.injuryLocation}}" bindfocus="__e" bindinput="__e"/><block wx:if="{{$root.g1}}"><view class="location-dropdown data-v-0904e2e0"><scroll-view class="location-scroll data-v-0904e2e0" scroll-y="{{true}}"><block wx:for="{{filteredLocations}}" wx:for-item="loc" wx:for-index="__i3__" wx:key="*this"><view data-event-opts="{{[['tap',[['selectLocationFromList',['$0'],[[['filteredLocations','',__i3__]]]]]]]}}" class="location-item data-v-0904e2e0" bindtap="__e">{{''+loc+''}}</view></block></scroll-view></view></block></view></view></view><view class="form-item data-v-0904e2e0"><view class="label required data-v-0904e2e0">诊断</view><view class="disease-input-wrapper data-v-0904e2e0"><textarea class="{{['data-v-0904e2e0','textarea-uniform','textarea-auto',diagnosisFontSizeClass]}}" placeholder="请输入初步诊断结果，例如：轻度头部挫伤" maxlength="100" data-event-opts="{{[['focus',[['onDiagnosisFocus'],['onFieldFocus',['field-diagnosis']]]],['input',[['__set_model',['$0','diagnosis','$event',[]],['form']],['onDiagnosisInput',['$event']]]]]}}" value="{{form.diagnosis}}" bindfocus="__e" bindinput="__e"></textarea><block wx:if="{{$root.g2}}"><view class="disease-dropdown data-v-0904e2e0"><scroll-view class="disease-scroll data-v-0904e2e0" scroll-y="{{true}}"><block wx:for="{{filteredDiagnosis}}" wx:for-item="it" wx:for-index="__i4__" wx:key="*this"><view data-event-opts="{{[['tap',[['selectDiagnosis',['$0'],[[['filteredDiagnosis','',__i4__]]]]]]]}}" class="disease-item data-v-0904e2e0" bindtap="__e">{{''+it+''}}</view></block></scroll-view></view></block></view></view><view class="form-item data-v-0904e2e0"><view class="label data-v-0904e2e0">症状</view><view class="disease-input-wrapper data-v-0904e2e0"><textarea class="textarea-uniform textarea-auto data-v-0904e2e0" placeholder="可记录体征/检查所见等补充症状信息（可选）" maxlength="150" data-event-opts="{{[['focus',[['onFieldFocus',['field-symptom']]]],['input',[['__set_model',['$0','symptom','$event',[]],['form']]]]]}}" value="{{form.symptom}}" bindfocus="__e" bindinput="__e"></textarea></view></view><view class="form-item data-v-0904e2e0"><view class="label required data-v-0904e2e0">疾病名称</view><view class="disease-input-wrapper data-v-0904e2e0"><input class="input-uniform data-v-0904e2e0" type="text" placeholder="例如：感冒、外伤、中暑等" data-event-opts="{{[['input',[['__set_model',['$0','diseaseName','$event',[]],['form']],['onDiseaseInput',['$event']]]],['focus',[['onDiseaseFocus'],['onFieldFocus',['field-diseaseName']]]],['blur',[['onDiseaseBlur',['$event']]]]]}}" value="{{form.diseaseName}}" bindinput="__e" bindfocus="__e" bindblur="__e"/><block wx:if="{{$root.g3}}"><view class="disease-dropdown data-v-0904e2e0"><scroll-view class="disease-scroll data-v-0904e2e0" scroll-y="{{true}}"><block wx:for="{{filteredDiseases}}" wx:for-item="disease" wx:for-index="__i5__" wx:key="*this"><view data-event-opts="{{[['tap',[['selectDisease',['$0'],[[['filteredDiseases','',__i5__]]]]]]]}}" class="disease-item data-v-0904e2e0" bindtap="__e">{{''+disease+''}}</view></block></scroll-view></view></block></view></view><view class="form-item data-v-0904e2e0"><view class="label required data-v-0904e2e0">处置</view><view class="disease-input-wrapper data-v-0904e2e0"><textarea class="textarea-uniform textarea-auto data-v-0904e2e0" placeholder="请输入处理措施，例如：伤口清洗消毒、冷敷" maxlength="120" data-event-opts="{{[['focus',[['onTreatmentFocus'],['onFieldFocus',['field-treatment']]]],['input',[['__set_model',['$0','treatment','$event',[]],['form']],['onTreatmentInput',['$event']]]]]}}" value="{{form.treatment}}" bindfocus="__e" bindinput="__e"></textarea><block wx:if="{{$root.g4}}"><view class="disease-dropdown data-v-0904e2e0"><scroll-view class="disease-scroll data-v-0904e2e0" scroll-y="{{true}}"><block wx:for="{{filteredTreatments}}" wx:for-item="it" wx:for-index="__i6__" wx:key="*this"><view data-event-opts="{{[['tap',[['selectTreatment',['$0'],[[['filteredTreatments','',__i6__]]]]]]]}}" class="disease-item data-v-0904e2e0" bindtap="__e">{{''+it+''}}</view></block></scroll-view></view></block></view></view></view><view class="form-section data-v-0904e2e0"><view class="section-title data-v-0904e2e0">用药信息（可选）</view><view class="form-item data-v-0904e2e0"><view class="label data-v-0904e2e0">药材名称</view><view class="drug-input-wrapper data-v-0904e2e0"><input class="input-uniform data-v-0904e2e0" type="text" placeholder="点击查看所有药材或输入搜索" data-event-opts="{{[['input',[['__set_model',['','drugSearchText','$event',[]]],['onDrugSearch',['$event']]]],['focus',[['onDrugInputFocus',['$event']]]]]}}" value="{{drugSearchText}}" bindinput="__e" bindfocus="__e"/><block wx:if="{{$root.g5}}"><view class="drug-dropdown data-v-0904e2e0"><view class="dropdown-header data-v-0904e2e0"><text class="dropdown-title data-v-0904e2e0">{{(form.location==='land_park'?'陆园':'水园')+"库存药材"}}</text><text class="dropdown-count data-v-0904e2e0">{{"("+$root.g6+"种)"}}</text></view><scroll-view class="drug-scroll data-v-0904e2e0" scroll-y="{{true}}"><block wx:for="{{filteredDrugs}}" wx:for-item="drug" wx:for-index="__i7__" wx:key="_id"><view data-event-opts="{{[['tap',[['selectDrugFromList',['$0'],[[['filteredDrugs','_id',drug._id]]]]]]]}}" class="drug-item data-v-0904e2e0" bindtap="__e"><view class="drug-name data-v-0904e2e0">{{drug.name}}</view><view class="drug-spec data-v-0904e2e0">{{drug.specification}}</view></view></block></scroll-view></view></block><block wx:if="{{$root.g7}}"><view class="no-result data-v-0904e2e0"> 未找到匹配的药材 </view></block></view><block wx:if="{{selectedDrug}}"><view class="drug-info data-v-0904e2e0"><text class="spec data-v-0904e2e0">{{selectedDrug.name+" - "+selectedDrug.specification}}</text><text class="stock data-v-0904e2e0">{{''+(form.location==='land_park'?'陆园':'水园')+"库存："+availableStock+" "+selectedDrug.minUnit+''}}</text></view></block></view><block wx:if="{{selectedDrug}}"><view class="drug-quick-info data-v-0904e2e0"><view class="drug-name-card data-v-0904e2e0"><view class="drug-details data-v-0904e2e0"><view class="drug-main-name data-v-0904e2e0">{{selectedDrug.name}}</view><view class="drug-spec-text data-v-0904e2e0">{{selectedDrug.specification}}</view></view></view><view class="quick-info-bar data-v-0904e2e0"><view class="info-tag park-tag data-v-0904e2e0"><text class="tag-text data-v-0904e2e0">{{form.location==='land_park'?'陆园':'水园'}}</text></view><view class="{{['info-tag','stock-tag','data-v-0904e2e0',(availableStock<10)?'stock-warning':'']}}"><text class="tag-text data-v-0904e2e0">{{"库存 "+availableStock+" "+selectedDrug.minUnit}}</text></view><view class="info-tag unit-tag data-v-0904e2e0"><text class="tag-text data-v-0904e2e0">{{selectedDrug.minUnit}}</text></view></view><view class="quantity-card data-v-0904e2e0"><view class="quantity-label data-v-0904e2e0"><text class="label-text data-v-0904e2e0">用药数量</text><text class="required-star data-v-0904e2e0">*</text></view><view class="quantity-input-wrapper data-v-0904e2e0"><input class="quantity-input-large data-v-0904e2e0" type="number" placeholder="请输入数量" data-event-opts="{{[['input',[['__set_model',['$0','quantity','$event',['number']],['form']]]],['blur',[['$forceUpdate']]]]}}" value="{{form.quantity}}" bindinput="__e" bindblur="__e"/><view class="quantity-unit-display data-v-0904e2e0">{{selectedDrug.minUnit}}</view></view><block wx:if="{{form.quantity>availableStock}}"><view class="quantity-warning data-v-0904e2e0"><text class="warning-text data-v-0904e2e0">{{"库存不足！当前库存："+availableStock+" "+selectedDrug.minUnit}}</text></view></block></view></view></block><block wx:if="{{selectedBatch}}"><view class="batch-info data-v-0904e2e0"><view class="batch-item data-v-0904e2e0"><text class="label data-v-0904e2e0">批次号：</text><text class="data-v-0904e2e0">{{selectedBatch.batch}}</text></view><view class="batch-item data-v-0904e2e0"><text class="label data-v-0904e2e0">有效期：</text><text class="data-v-0904e2e0">{{$root.m0}}</text><block wx:if="{{selectedBatch.daysToExpiry<=60}}"><text class="warning data-v-0904e2e0">{{'（'+selectedBatch.daysToExpiry+'天后到期）'}}</text></block></view><view class="batch-item data-v-0904e2e0"><text class="label data-v-0904e2e0">剩余库存：</text><text class="data-v-0904e2e0">{{selectedBatch.quantity+" "+selectedDrug.minUnit}}</text></view></view></block></view><view class="form-section data-v-0904e2e0"><view class="section-title data-v-0904e2e0">备注</view><view class="form-item data-v-0904e2e0"><textarea class="textarea-uniform textarea-auto data-v-0904e2e0" placeholder="其他说明或建议（可选）" maxlength="200" data-event-opts="{{[['focus',[['onFieldFocus',['field-remark']]]],['input',[['__set_model',['$0','remark','$event',[]],['form']]]]]}}" value="{{form.remark}}" bindfocus="__e" bindinput="__e"></textarea></view></view><view class="form-section data-v-0904e2e0"><view class="section-title data-v-0904e2e0">接诊医生签名</view><view class="signature-info data-v-0904e2e0"><view class="signature-tip data-v-0904e2e0"><text class="tip-text data-v-0904e2e0">请医生在下方签名确认本次就诊信息</text></view></view><view class="signature-section data-v-0904e2e0"><view class="signature-label-row data-v-0904e2e0"><view class="signature-label data-v-0904e2e0">医生签名</view><text class="required data-v-0904e2e0">*</text></view><signature vue-id="1797fa26-1" title="医生签名" value="{{form.doctorSign}}" data-event-opts="{{[['^change',[['onDoctorSignChange']]],['^input',[['__set_model',['$0','doctorSign','$event',[]],['form']]]]]}}" bind:change="__e" bind:input="__e" class="data-v-0904e2e0" bind:__l="__l"></signature><block wx:if="{{form.signTime}}"><view class="signature-time data-v-0904e2e0">{{'签名时间：'+form.signTime+''}}</view></block></view></view><view class="continue-option data-v-0904e2e0"><view data-event-opts="{{[['tap',[['toggleContinue',['$event']]]]]}}" class="continue-card data-v-0904e2e0" bindtap="__e"><view class="continue-checkbox data-v-0904e2e0"><checkbox checked="{{continueAfterSubmit}}" class="data-v-0904e2e0"></checkbox></view><view class="continue-text data-v-0904e2e0"><view class="continue-title data-v-0904e2e0">连续登记模式</view><view class="continue-desc data-v-0904e2e0">提交后自动清空表单，继续登记下一位患者</view></view></view></view><block wx:if="{{showDrugSelector}}"><drug-selector bind:select="__e" bind:close="__e" vue-id="1797fa26-2" data-event-opts="{{[['^select',[['onDrugSelect']]],['^close',[['e5']]]]}}" class="data-v-0904e2e0" bind:__l="__l"></drug-selector></block></scroll-view><view class="submit-section data-v-0904e2e0"><button data-event-opts="{{[['tap',[['goBack',['$event']]]]]}}" class="cancel-btn data-v-0904e2e0" bindtap="__e">取消</button><button class="submit-btn data-v-0904e2e0" loading="{{submitting}}" data-event-opts="{{[['tap',[['handleSubmit',['$event']]]]]}}" bindtap="__e"> 保存 </button></view><view class="continue-option data-v-0904e2e0"><view data-event-opts="{{[['tap',[['toggleContinue',['$event']]]]]}}" class="continue-card data-v-0904e2e0" bindtap="__e"><view class="continue-checkbox data-v-0904e2e0"><checkbox checked="{{continueAfterSubmit}}" class="data-v-0904e2e0"></checkbox></view><view class="continue-text data-v-0904e2e0"><view class="continue-title data-v-0904e2e0">连续登记模式</view><view class="continue-desc data-v-0904e2e0">提交后自动清空表单，继续登记下一位患者</view></view></view></view><block wx:if="{{showDrugSelector}}"><drug-selector bind:select="__e" bind:close="__e" vue-id="1797fa26-3" data-event-opts="{{[['^select',[['onDrugSelect']]],['^close',[['e6']]]]}}" class="data-v-0904e2e0" bind:__l="__l"></drug-selector></block></view>