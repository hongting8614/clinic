<view class="page data-v-017bfd6a"><view class="page-header data-v-017bfd6a"><view class="header-content data-v-017bfd6a"><text class="header-title data-v-017bfd6a">è¯æå‡ºåº“</text><text class="header-subtitle data-v-017bfd6a">{{"å‡ºåº“æ—¥æœŸï¼š"+currentDate}}</text></view></view><view class="info-card data-v-017bfd6a"><view class="info-row data-v-017bfd6a"><view class="info-item data-v-017bfd6a"><text class="label data-v-017bfd6a">å•å·ï¼š</text><text class="value data-v-017bfd6a">{{recordNo||'è‡ªåŠ¨ç”Ÿæˆ'}}</text></view><view class="info-item data-v-017bfd6a"><text class="label data-v-017bfd6a">å‘æ”¾äººï¼š</text><text class="value data-v-017bfd6a">{{dispenser}}</text></view></view><view class="info-row data-v-017bfd6a"><view class="info-item data-v-017bfd6a"><text class="label data-v-017bfd6a">å‡ºåº“åˆ°å›­åŒºï¼š<text class="required data-v-017bfd6a">*</text></text><picker range="{{locations}}" range-key="label" value="{{locationIndex}}" data-event-opts="{{[['change',[['onLocationChange',['$event']]]]]}}" bindchange="__e" class="data-v-017bfd6a"><view class="picker-input data-v-017bfd6a"><text class="value data-v-017bfd6a">{{currentLocation.label}}</text><text class="picker-arrow data-v-017bfd6a">â€º</text></view></picker></view><view class="info-item data-v-017bfd6a"><text class="label data-v-017bfd6a">å›­åŒºè¯·é¢†ï¼š</text><picker range="{{requestAreas}}" range-key="label" value="{{requestAreaIndex}}" data-event-opts="{{[['change',[['onRequestAreaChange',['$event']]]]]}}" bindchange="__e" class="data-v-017bfd6a"><view class="picker-input data-v-017bfd6a"><text class="value data-v-017bfd6a">{{currentRequestArea.label}}</text><text class="picker-arrow data-v-017bfd6a">â€º</text></view></picker></view></view><view class="info-row data-v-017bfd6a"><view class="info-item full data-v-017bfd6a"><text class="label data-v-017bfd6a">å¤‡æ³¨</text><input class="input-value data-v-017bfd6a" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰" placeholder-class="placeholder" data-event-opts="{{[['input',[['__set_model',['','remark','$event',[]]]]]]}}" value="{{remark}}" bindinput="__e"/></view></view></view><view class="form-section data-v-017bfd6a"><view class="section-title data-v-017bfd6a"> è¯ææ˜ç»† <text class="section-count data-v-017bfd6a">{{"("+$root.g0+"ç§)"}}</text></view><view class="action-buttons data-v-017bfd6a"><view data-event-opts="{{[['tap',[['goSelectDrug',['$event']]]]]}}" class="add-drug-btn data-v-017bfd6a" bindtap="__e"><text class="btn-icon data-v-017bfd6a">â•</text><text class="btn-text data-v-017bfd6a">æ·»åŠ è¯æ</text></view></view><view class="drug-list data-v-017bfd6a"><block wx:for="{{$root.l0}}" wx:for-item="item" wx:for-index="index" wx:key="index"><view class="drug-item data-v-017bfd6a"><view class="drug-header data-v-017bfd6a"><view class="drug-title-row data-v-017bfd6a"><view class="drug-badges data-v-017bfd6a"><block wx:if="{{item.$orig.isHighValue}}"><text class="badge high-value data-v-017bfd6a">é«˜å€¼</text></block><block wx:if="{{item.$orig.isEmergency}}"><text class="badge emergency data-v-017bfd6a">æ€¥æ•‘</text></block></view><text class="drug-name data-v-017bfd6a">{{item.$orig.drugName}}</text></view><view data-event-opts="{{[['tap',[['deleteDrug',[index]]]]]}}" class="drug-delete data-v-017bfd6a" bindtap="__e">åˆ é™¤</view></view><view class="drug-spec-row data-v-017bfd6a"><text class="spec-icon data-v-017bfd6a">ğŸ“¦</text><text class="spec-text data-v-017bfd6a">{{item.$orig.specification||item.$orig.spec}}</text><text class="spec-divider data-v-017bfd6a">Â·</text><text class="unit-text data-v-017bfd6a">{{"å•ä½: "+item.$orig.unit}}</text></view><block wx:if="{{item.$orig.drugCode}}"><view class="drug-code-row data-v-017bfd6a"><text class="code-icon data-v-017bfd6a">ğŸ·ï¸</text><text class="code-text data-v-017bfd6a">{{"ä»£ç : "+item.$orig.drugCode}}</text></view></block><view class="drug-debug-row data-v-017bfd6a" style="font-size:20rpx;color:#999;padding:5rpx 0;"><text class="data-v-017bfd6a">{{"ğŸ” drugId: "+(item.$orig.drugId||'âŒ æ— ')}}</text></view><view class="drug-input-section data-v-017bfd6a"><block wx:if="{{item.g1}}"><view class="batch-allocation-result data-v-017bfd6a"><view class="allocation-header data-v-017bfd6a"><text class="allocation-title data-v-017bfd6a">{{"âœ… å·²è‡ªåŠ¨åˆ†é… "+item.$orig.batchCount+" ä¸ªæ‰¹æ¬¡"}}</text><block wx:if="{{item.$orig.hasNearExpiry}}"><text class="near-expiry-tag data-v-017bfd6a">âš ï¸ å«è¿‘æ•ˆæœŸ</text></block></view><view class="allocation-list data-v-017bfd6a"><block wx:for="{{item.$orig.batchAllocation}}" wx:for-item="batch" wx:for-index="bIndex" wx:key="bIndex"><view class="{{['allocation-item','data-v-017bfd6a',(batch.isNearExpiry)?'near-expiry':'']}}"><view class="allocation-row data-v-017bfd6a"><text class="allocation-label data-v-017bfd6a">æ‰¹å·ï¼š</text><text class="allocation-value data-v-017bfd6a">{{batch.batch}}</text><text class="allocation-quantity data-v-017bfd6a">{{batch.quantity+" "+item.$orig.unit}}</text></view><view class="allocation-row data-v-017bfd6a"><text class="allocation-label data-v-017bfd6a">æœ‰æ•ˆæœŸï¼š</text><text class="{{['allocation-value','data-v-017bfd6a',(batch.isNearExpiry)?'text-warning':'']}}">{{''+batch.expireDate+''}}<block wx:if="{{batch.isNearExpiry}}"><text class="days-hint data-v-017bfd6a">{{"("+batch.daysToExpire+"å¤©ååˆ°æœŸ)"}}</text></block></text></view></view></block></view><view class="allocation-actions data-v-017bfd6a"><text data-event-opts="{{[['tap',[['clearAllocation',[index]]]]]}}" class="action-btn data-v-017bfd6a" bindtap="__e">ğŸ”„ é‡æ–°åˆ†é…</text></view></view></block><block wx:else><block wx:if="{{item.$orig.batch}}"><view class="batch-info-selected data-v-017bfd6a"><view class="batch-info-row data-v-017bfd6a"><text class="batch-label data-v-017bfd6a">æ‰¹å·ï¼š</text><text class="batch-value data-v-017bfd6a">{{item.$orig.batch}}</text></view><view class="batch-info-row data-v-017bfd6a"><text class="batch-label data-v-017bfd6a">â° æœ‰æ•ˆæœŸï¼š</text><text class="batch-value data-v-017bfd6a">{{item.$orig.expireDate}}</text></view><view class="batch-info-row data-v-017bfd6a"><text class="batch-label data-v-017bfd6a">ğŸ“Š åº“å­˜ï¼š</text><text class="batch-value data-v-017bfd6a">{{item.$orig.stockQuantity+" "+item.$orig.unit}}</text></view></view></block><block wx:else><view class="batch-select-row data-v-017bfd6a"><batch-selector vue-id="{{'2e0430dc-1-'+index}}" button-text="ğŸ” æ‰‹åŠ¨é€‰æ‹©æ‰¹æ¬¡" button-type="info" button-size="small" drug-id="{{item.$orig.drugId}}" drug-info="{{item.a0}}" show-location-filter="{{false}}" default-location="drug_storage" enable-f-i-f-o="{{true}}" data-event-opts="{{[['^select',[['e0']]]]}}" data-event-params="{{({index})}}" bind:select="__e" class="data-v-017bfd6a" bind:__l="__l"></batch-selector></view></block></block><view class="input-row data-v-017bfd6a"><text class="input-label data-v-017bfd6a">å‡ºåº“æ•°é‡ *</text><input class="input-field data-v-017bfd6a" type="number" placeholder="{{'æœ€å¤š'+(item.$orig.stockQuantity||0)}}" data-event-opts="{{[['blur',[['onQuantityBlur',[index]],['$forceUpdate']]],['input',[['__set_model',['$0','quantity','$event',['number']],[[['drugList','',index]]]],['onQuantityInput',[index]]]]]}}" value="{{item.$orig.quantity}}" bindblur="__e" bindinput="__e"/><text class="input-unit data-v-017bfd6a">{{item.$orig.unit}}</text></view><block wx:if="{{item.$orig.quantity&&item.$orig.quantity>0&&!item.$orig.batchAllocation}}"><view class="auto-allocate-hint data-v-017bfd6a"><text class="hint-icon data-v-017bfd6a">ğŸ’¡</text><text class="hint-text data-v-017bfd6a">è¾“å…¥æ•°é‡åè‡ªåŠ¨FIFOåˆ†é…æ‰¹æ¬¡</text><text data-event-opts="{{[['tap',[['autoAllocateBatch',[index]]]]]}}" class="action-link data-v-017bfd6a" bindtap="__e">ç«‹å³åˆ†é…</text></view></block><block wx:if="{{item.$orig.quantity&&item.$orig.conversionRate&&item.$orig.conversionRate>1}}"><view class="convert-hint data-v-017bfd6a"><text class="hint-icon data-v-017bfd6a">ğŸ”„</text><text class="hint-text data-v-017bfd6a">{{'å°†è½¬æ¢ä¸º '+item.g2+" "+item.$orig.minUnit+" å­˜å…¥"+currentLocation.label+''}}</text></view></block><block wx:if="{{item.$orig.isHighValue&&item.$orig.quantity&&item.$orig.price}}"><view class="amount-hint data-v-017bfd6a"><text class="amount-label data-v-017bfd6a">é‡‘é¢ï¼š</text><text class="amount-value data-v-017bfd6a">{{"Â¥"+item.g3}}</text></view></block></view></view></block><block wx:if="{{$root.g4===0}}"><view class="empty-hint data-v-017bfd6a"><text class="data-v-017bfd6a">ğŸ’Š æš‚æ— è¯æï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </text></view></block></view></view><view class="form-section data-v-017bfd6a"><view class="section-title data-v-017bfd6a">å‘æ”¾äººç­¾å *</view><signature bind:input="__e" vue-id="2e0430dc-2" title="å‘æ”¾äººç­¾å" value="{{dispenserSign}}" data-event-opts="{{[['^input',[['__set_model',['','dispenserSign','$event',[]]]]]]}}" class="data-v-017bfd6a" bind:__l="__l"></signature></view><view class="bottom-actions data-v-017bfd6a"><view data-event-opts="{{[['tap',[['saveDraft',['$event']]]]]}}" class="bottom-btn btn-secondary data-v-017bfd6a" bindtap="__e"><text class="data-v-017bfd6a">ä¿å­˜è‰ç¨¿</text></view><view data-event-opts="{{[['tap',[['submitReview',['$event']]]]]}}" class="bottom-btn btn-primary data-v-017bfd6a" bindtap="__e"><text class="data-v-017bfd6a">æäº¤å¤æ ¸</text></view></view></view>