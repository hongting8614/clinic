# äº‘å‡½æ•°æœ¬åœ°æµ‹è¯•æŒ‡å—

## ğŸ“‹ ç›®å½•
- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [æœ¬åœ°è°ƒè¯•æ–¹æ³•](#æœ¬åœ°è°ƒè¯•æ–¹æ³•)
- [æµ‹è¯•ç¤ºä¾‹](#æµ‹è¯•ç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£…å¾®ä¿¡å¼€å‘è€…å·¥å…·
- ä¸‹è½½åœ°å€ï¼šhttps://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
- ç¡®ä¿ç‰ˆæœ¬ >= 1.02.1904090

### 2. å¼€å¯äº‘å¼€å‘
1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. æ‰“å¼€é¡¹ç›®ï¼š`D:\AK-PMS`
3. ç‚¹å‡»å·¥å…·æ ã€Œäº‘å¼€å‘ã€æŒ‰é’®
4. å¼€é€šäº‘å¼€å‘ç¯å¢ƒï¼ˆå¦‚å·²å¼€é€šåˆ™è·³è¿‡ï¼‰

### 3. å®‰è£…äº‘å‡½æ•°ä¾èµ–
```powershell
# è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\AK-PMS

# ä¸ºæ‰€æœ‰äº‘å‡½æ•°å®‰è£…ä¾èµ–ï¼ˆå¯é€‰æ‹©æ€§å®‰è£…ï¼‰
cd cloudfunctions\login
npm install

cd ..\addUser
npm install

# ... å…¶ä»–äº‘å‡½æ•°ç±»ä¼¼
```

---

## ğŸ§ª æœ¬åœ°è°ƒè¯•æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼ˆæ¨èï¼‰

#### 1. æœ¬åœ°è°ƒè¯•å•ä¸ªäº‘å‡½æ•°
```
1. åœ¨å¼€å‘è€…å·¥å…·ä¸­ï¼Œå³é”®ç‚¹å‡»äº‘å‡½æ•°æ–‡ä»¶å¤¹ï¼ˆå¦‚ loginï¼‰
2. é€‰æ‹©ã€Œæœ¬åœ°è°ƒè¯•ã€
3. åœ¨å¼¹å‡ºçš„è°ƒè¯•çª—å£ä¸­ï¼š
   - è¾“å…¥æµ‹è¯•å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰
   - ç‚¹å‡»ã€Œè°ƒè¯•ã€æŒ‰é’®
   - æŸ¥çœ‹è¿”å›ç»“æœå’Œæ—¥å¿—
```

#### 2. æµ‹è¯•å‚æ•°ç¤ºä¾‹

**ç™»å½•äº‘å‡½æ•° (login)**
```json
{
  "username": "admin",
  "password": "123456"
}
```

**è·å–åº“å­˜åˆ—è¡¨ (getStockList)**
```json
{
  "page": 1,
  "pageSize": 20,
  "keyword": ""
}
```

**æ·»åŠ ç”¨æˆ· (addUser)**
```json
{
  "username": "testuser",
  "password": "123456",
  "name": "æµ‹è¯•ç”¨æˆ·",
  "role": "doctor"
}
```

#### 3. æŸ¥çœ‹è°ƒè¯•æ—¥å¿—
- åœ¨è°ƒè¯•çª—å£çš„ã€Œæ—¥å¿—ã€æ ‡ç­¾é¡µæŸ¥çœ‹
- å¯ä»¥çœ‹åˆ° console.log è¾“å‡º
- å¯ä»¥çœ‹åˆ°æ•°æ®åº“æ“ä½œè®°å½•

---

### æ–¹æ³•äºŒï¼šä½¿ç”¨äº‘å‡½æ•°æ¨¡æ‹Ÿå™¨

#### 1. å¯åŠ¨äº‘å‡½æ•°æ¨¡æ‹Ÿå™¨
```
1. ç‚¹å‡»å¼€å‘è€…å·¥å…·é¡¶éƒ¨èœå•ã€Œå·¥å…·ã€
2. é€‰æ‹©ã€Œäº‘å¼€å‘æ§åˆ¶å°ã€
3. åœ¨æ§åˆ¶å°ä¸­é€‰æ‹©ã€Œäº‘å‡½æ•°ã€
4. ç‚¹å‡»ã€Œæœ¬åœ°è°ƒè¯•ã€
```

#### 2. é…ç½®æœ¬åœ°è°ƒè¯•
```javascript
// åœ¨å°ç¨‹åºä»£ç ä¸­ä½¿ç”¨æœ¬åœ°äº‘å‡½æ•°
wx.cloud.init({
  env: 'your-env-id',
  traceUser: true
})

// è°ƒç”¨äº‘å‡½æ•°
wx.cloud.callFunction({
  name: 'login',
  data: {
    username: 'admin',
    password: '123456'
  }
}).then(res => {
  console.log('äº‘å‡½æ•°è¿”å›ï¼š', res)
}).catch(err => {
  console.error('äº‘å‡½æ•°é”™è¯¯ï¼š', err)
})
```

---

### æ–¹æ³•ä¸‰ï¼šç¼–å†™æœ¬åœ°æµ‹è¯•è„šæœ¬

#### 1. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
åœ¨äº‘å‡½æ•°ç›®å½•ä¸‹åˆ›å»º `test.js`ï¼š

```javascript
// cloudfunctions/login/test.js
const cloud = require('wx-server-sdk')

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()

// æ¨¡æ‹Ÿäº‘å‡½æ•°å…¥å£
exports.main = async (event, context) => {
  // è¿™é‡Œæ˜¯äº‘å‡½æ•°çš„å®é™…ä»£ç 
  const { username, password } = event
  
  try {
    const result = await db.collection('users').where({
      username: username
    }).get()
    
    console.log('æŸ¥è¯¢ç»“æœï¼š', result)
    return {
      success: true,
      data: result.data
    }
  } catch (err) {
    console.error('é”™è¯¯ï¼š', err)
    return {
      success: false,
      error: err
    }
  }
}

// æœ¬åœ°æµ‹è¯•
if (require.main === module) {
  exports.main({
    username: 'admin',
    password: '123456'
  }, {}).then(res => {
    console.log('æµ‹è¯•ç»“æœï¼š', res)
  })
}
```

#### 2. è¿è¡Œæµ‹è¯•
```powershell
cd cloudfunctions\login
node test.js
```

---

## ğŸ“ æµ‹è¯•ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæµ‹è¯•ç™»å½•åŠŸèƒ½

**æ­¥éª¤ï¼š**
1. å³é”®ç‚¹å‡» `cloudfunctions/login` æ–‡ä»¶å¤¹
2. é€‰æ‹©ã€Œæœ¬åœ°è°ƒè¯•ã€
3. è¾“å…¥æµ‹è¯•å‚æ•°ï¼š
```json
{
  "username": "admin",
  "password": "123456"
}
```
4. ç‚¹å‡»ã€Œè°ƒè¯•ã€
5. æŸ¥çœ‹è¿”å›ç»“æœ

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": true,
  "data": {
    "userId": "xxx",
    "username": "admin",
    "name": "ç®¡ç†å‘˜",
    "role": "admin"
  }
}
```

---

### ç¤ºä¾‹2ï¼šæµ‹è¯•åº“å­˜æŸ¥è¯¢

**æ­¥éª¤ï¼š**
1. å³é”®ç‚¹å‡» `cloudfunctions/getStockList` æ–‡ä»¶å¤¹
2. é€‰æ‹©ã€Œæœ¬åœ°è°ƒè¯•ã€
3. è¾“å…¥æµ‹è¯•å‚æ•°ï¼š
```json
{
  "page": 1,
  "pageSize": 10,
  "keyword": "é˜¿è«è¥¿æ—"
}
```
4. ç‚¹å‡»ã€Œè°ƒè¯•ã€

**é¢„æœŸç»“æœï¼š**
```json
{
  "success": true,
  "data": {
    "list": [...],
    "total": 100
  }
}
```

---

### ç¤ºä¾‹3ï¼šæµ‹è¯•è¯å“æœç´¢

**æ­¥éª¤ï¼š**
1. å³é”®ç‚¹å‡» `cloudfunctions/drugSearch` æ–‡ä»¶å¤¹
2. é€‰æ‹©ã€Œæœ¬åœ°è°ƒè¯•ã€
3. è¾“å…¥æµ‹è¯•å‚æ•°ï¼š
```json
{
  "keyword": "æ„Ÿå†’",
  "page": 1,
  "pageSize": 20
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. äº‘å‡½æ•°è°ƒè¯•å¤±è´¥

**é—®é¢˜ï¼š** æç¤º"äº‘å‡½æ•°ä¸å­˜åœ¨"

**è§£å†³æ–¹æ¡ˆï¼š**
```
1. ç¡®ä¿äº‘å‡½æ•°å·²ä¸Šä¼ åˆ°äº‘ç«¯
2. å³é”®äº‘å‡½æ•°æ–‡ä»¶å¤¹ â†’ é€‰æ‹©ã€Œä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ã€
3. ç­‰å¾…ä¸Šä¼ å®Œæˆåå†è¿›è¡Œæœ¬åœ°è°ƒè¯•
```

---

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

**é—®é¢˜ï¼š** æç¤º"æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥"

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// æ£€æŸ¥äº‘å‡½æ•°ä¸­çš„åˆå§‹åŒ–ä»£ç 
const cloud = require('wx-server-sdk')

cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV  // ä½¿ç”¨å½“å‰ç¯å¢ƒ
})

const db = cloud.database()
```

---

### 3. ä¾èµ–åŒ…ç¼ºå¤±

**é—®é¢˜ï¼š** æç¤º"Cannot find module 'xxx'"

**è§£å†³æ–¹æ¡ˆï¼š**
```powershell
# è¿›å…¥äº‘å‡½æ•°ç›®å½•
cd cloudfunctions\[äº‘å‡½æ•°åç§°]

# å®‰è£…ä¾èµ–
npm install

# æˆ–è€…é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–
rm -rf node_modules
rm package-lock.json
npm install
```

---

### 4. æƒé™ä¸è¶³

**é—®é¢˜ï¼š** æç¤º"permission denied"

**è§£å†³æ–¹æ¡ˆï¼š**
```
1. æ£€æŸ¥æ•°æ®åº“æƒé™è®¾ç½®
2. åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ æƒé™è®¾ç½®
3. ç¡®ä¿äº‘å‡½æ•°æœ‰ç›¸åº”çš„è¯»å†™æƒé™
```

---

### 5. è¶…æ—¶é—®é¢˜

**é—®é¢˜ï¼š** äº‘å‡½æ•°æ‰§è¡Œè¶…æ—¶

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// åœ¨ package.json ä¸­å¢åŠ è¶…æ—¶é…ç½®
{
  "name": "login",
  "version": "1.0.0",
  "cloudfunction-config": {
    "timeout": 20  // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  }
}
```

---

## ğŸ’¡ è°ƒè¯•æŠ€å·§

### 1. ä½¿ç”¨ console.log
```javascript
exports.main = async (event, context) => {
  console.log('æ¥æ”¶åˆ°çš„å‚æ•°ï¼š', event)
  
  const result = await db.collection('users').get()
  console.log('æŸ¥è¯¢ç»“æœï¼š', result)
  
  return result
}
```

### 2. ä½¿ç”¨ try-catch
```javascript
exports.main = async (event, context) => {
  try {
    const result = await db.collection('users').get()
    return {
      success: true,
      data: result.data
    }
  } catch (err) {
    console.error('é”™è¯¯è¯¦æƒ…ï¼š', err)
    return {
      success: false,
      error: err.message
    }
  }
}
```

### 3. åˆ†æ­¥è°ƒè¯•
```javascript
exports.main = async (event, context) => {
  console.log('æ­¥éª¤1ï¼šå¼€å§‹æŸ¥è¯¢')
  const users = await db.collection('users').get()
  console.log('æ­¥éª¤2ï¼šæŸ¥è¯¢å®Œæˆï¼Œç»“æœæ•°é‡ï¼š', users.data.length)
  
  console.log('æ­¥éª¤3ï¼šå¼€å§‹å¤„ç†æ•°æ®')
  const processed = users.data.map(u => ({
    id: u._id,
    name: u.name
  }))
  console.log('æ­¥éª¤4ï¼šå¤„ç†å®Œæˆ')
  
  return processed
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡äº‘å¼€å‘å®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [äº‘å‡½æ•°å¼€å‘æŒ‡å—](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html)
- [äº‘æ•°æ®åº“ä½¿ç”¨æŒ‡å—](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database.html)

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] äº‘å‡½æ•°ä¾èµ–å·²å®‰è£…
- [ ] äº‘å¼€å‘ç¯å¢ƒå·²åˆå§‹åŒ–
- [ ] æ•°æ®åº“æƒé™å·²é…ç½®
- [ ] æµ‹è¯•å‚æ•°å‡†å¤‡å®Œæ•´
- [ ] èƒ½å¤ŸæŸ¥çœ‹è°ƒè¯•æ—¥å¿—
- [ ] è¿”å›ç»“æœç¬¦åˆé¢„æœŸ
- [ ] é”™è¯¯å¤„ç†æ­£å¸¸å·¥ä½œ

---

**æœ€åæ›´æ–°ï¼š** 2025-12-26
**é€‚ç”¨ç‰ˆæœ¬ï¼š** v3.16.1+

