# 云函数部署指南

## 📋 目录
- [快速部署](#快速部署)
- [单个云函数部署](#单个云函数部署)
- [批量部署](#批量部署)
- [部署检查](#部署检查)
- [常见问题](#常见问题)

---

## 🚀 快速部署

### 方法一：使用微信开发者工具（推荐）

#### 1. 部署单个云函数
```
1. 在微信开发者工具中，找到 cloudfunctions 文件夹
2. 右键点击要部署的云函数文件夹（如 login）
3. 选择「上传并部署：云端安装依赖」
4. 等待上传完成（会显示上传进度）
5. 部署成功后会显示绿色的 ✓ 标记
```

#### 2. 部署所有云函数
```
1. 右键点击 cloudfunctions 文件夹
2. 选择「同步云函数列表」
3. 然后逐个右键点击每个云函数文件夹
4. 选择「上传并部署：云端安装依赖」
```

---

## 📦 单个云函数部署

### 步骤详解

#### 1. 检查云函数代码
确保云函数包含以下文件：
```
cloudfunctions/
  └── login/
      ├── index.js       # 云函数入口文件
      └── package.json   # 依赖配置文件
```

#### 2. 检查 package.json
```json
{
  "name": "login",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "latest"
  }
}
```

#### 3. 上传部署
```
右键云函数文件夹 → 上传并部署：云端安装依赖
```

**注意事项：**
- ✅ 选择「云端安装依赖」（推荐）- 在云端自动安装 node_modules
- ⚠️ 避免选择「不上传 node_modules」- 可能导致依赖缺失

---

## 🔄 批量部署

### 方法一：使用批量部署脚本

创建 `部署所有云函数.bat`：

```batch
@echo off
echo ====================================
echo 云函数批量部署脚本
echo ====================================
echo.

echo 请在微信开发者工具中执行以下操作：
echo.
echo 1. 右键点击 cloudfunctions 文件夹
echo 2. 选择「同步云函数列表」
echo 3. 等待同步完成
echo.
echo 然后依次部署以下云函数：
echo.

set functions=login addUser getUserList updateUser deleteUser updateUserStatus getMyOpenId inRecords outRecords stockManage getStockList updateStock drugManage drugSearch drugAPI drugBarcodeQuery getDrugList clinicRecords consumeRecords requisitionRecords reports queryService dailySummary expiryMonitor changePassword updateMyInfo resetPassword sendResetPasswordCode verifyResetPasswordCode clearInRecords createClinicRecordsCollection

for %%f in (%functions%) do (
    echo [待部署] %%f
)

echo.
echo ====================================
echo 部署方法：
echo 右键云函数文件夹 → 上传并部署：云端安装依赖
echo ====================================
pause
```

### 方法二：使用云开发控制台

```
1. 打开微信开发者工具
2. 点击工具栏「云开发」按钮
3. 进入「云函数」页面
4. 点击「上传全部」按钮
5. 等待所有云函数上传完成
```

---

## ✅ 部署检查

### 1. 检查云函数列表

在微信开发者工具中：
```
1. 点击「云开发」按钮
2. 进入「云函数」页面
3. 查看云函数列表
4. 确认所有云函数都显示为「已部署」状态
```

### 2. 测试云函数

#### 方法1：使用开发者工具测试
```
1. 在云函数列表中，点击云函数名称
2. 点击「测试」按钮
3. 输入测试参数
4. 查看返回结果
```

#### 方法2：在小程序中测试
```javascript
// 在小程序代码中调用
wx.cloud.callFunction({
  name: 'login',
  data: {
    username: 'admin',
    password: '123456'
  }
}).then(res => {
  console.log('测试成功：', res)
}).catch(err => {
  console.error('测试失败：', err)
})
```

### 3. 查看部署日志

```
1. 在云函数列表中，点击云函数名称
2. 点击「日志」标签
3. 查看最近的调用日志
4. 确认没有错误信息
```

---

## 🐛 常见问题

### 1. 云函数上传失败

**问题：** 提示"上传失败"或"网络错误"

**解决方案：**
```
1. 检查网络连接
2. 检查是否登录微信开发者工具
3. 检查云开发环境是否已开通
4. 尝试重新登录开发者工具
5. 检查防火墙设置
```

---

### 2. 云函数调用失败 - Failed to fetch

**问题：** 调用云函数时提示 `Error: Failed to fetch`

**这是您当前遇到的问题！**

**解决方案：**

#### ✅ 步骤1：检查云函数是否已部署
```
1. 打开微信开发者工具
2. 点击「云开发」→「云函数」
3. 检查以下云函数是否都已部署：
   - inRecords
   - outRecords
   - drugManage
   - stockManage
   - clinicRecords
   - 其他所有云函数
```

#### ✅ 步骤2：重新部署云函数
```
如果云函数未部署或显示异常：
1. 右键点击云函数文件夹
2. 选择「上传并部署：云端安装依赖」
3. 等待上传完成
```

#### ✅ 步骤3：检查云开发环境
```javascript
// 在 App.vue 中检查环境ID
wx.cloud.init({
  env: 'cloud1-3gv7spppf7d2d0f4',  // 确认这是正确的环境ID
  traceUser: true
})
```

#### ✅ 步骤4：检查网络设置
```
1. 在开发者工具中，点击「详情」
2. 选择「本地设置」
3. 确保勾选：
   ✓ 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   ✓ 启用调试
```

#### ✅ 步骤5：重启开发者工具
```
1. 关闭微信开发者工具
2. 重新打开项目
3. 等待云开发初始化完成
4. 重新测试
```

---

### 3. 依赖安装失败

**问题：** 提示"依赖安装失败"

**解决方案：**
```
方法1：使用云端安装依赖
1. 右键云函数文件夹
2. 选择「上传并部署：云端安装依赖」（不是「不上传 node_modules」）

方法2：本地安装后上传
1. 进入云函数目录
   cd cloudfunctions\login
2. 安装依赖
   npm install
3. 右键云函数文件夹
4. 选择「上传并部署：所有文件」
```

---

### 4. 云函数超时

**问题：** 云函数执行超时

**解决方案：**
```javascript
// 在 package.json 中增加超时配置
{
  "name": "login",
  "version": "1.0.0",
  "cloudfunction-config": {
    "timeout": 20,  // 设置超时时间（秒），默认3秒
    "envVariables": {}
  }
}
```

---

### 5. 权限不足

**问题：** 提示"permission denied"

**解决方案：**
```
1. 打开云开发控制台
2. 进入「数据库」→「权限设置」
3. 设置集合权限：
   - 开发环境：可以设置为「所有用户可读写」
   - 生产环境：建议设置为「仅创建者可读写」，通过云函数访问
```

---

### 6. 环境ID错误

**问题：** 提示"env not found"

**解决方案：**
```javascript
// 检查 App.vue 中的环境ID
wx.cloud.init({
  env: 'cloud1-3gv7spppf7d2d0f4',  // 确认环境ID正确
  traceUser: true
})

// 或者使用动态环境
wx.cloud.init({
  env: wx.cloud.DYNAMIC_CURRENT_ENV,
  traceUser: true
})
```

---

## 📝 部署检查清单

### 部署前检查
- [ ] 已安装微信开发者工具
- [ ] 已登录开发者账号
- [ ] 已开通云开发环境
- [ ] 云函数代码已编写完成
- [ ] package.json 配置正确

### 部署中检查
- [ ] 选择「云端安装依赖」
- [ ] 等待上传进度完成
- [ ] 没有错误提示
- [ ] 云函数显示绿色 ✓ 标记

### 部署后检查
- [ ] 云函数列表中显示「已部署」
- [ ] 可以在控制台看到云函数
- [ ] 测试调用成功
- [ ] 日志中没有错误

---

## 🔧 快速修复当前问题

根据您的错误日志，需要部署以下云函数：

```
必须部署的云函数：
✓ inRecords       - 入库记录
✓ outRecords      - 出库记录
✓ drugManage      - 药品管理
✓ stockManage     - 库存管理
✓ clinicRecords   - 门诊记录
```

### 立即执行：

1️⃣ **打开微信开发者工具**

2️⃣ **同步云函数列表**
```
右键 cloudfunctions 文件夹 → 同步云函数列表
```

3️⃣ **部署核心云函数**
```
依次右键以下文件夹，选择「上传并部署：云端安装依赖」：
- inRecords
- outRecords
- drugManage
- stockManage
- clinicRecords
```

4️⃣ **等待部署完成**
```
每个云函数上传需要 10-30 秒
部署成功后会显示绿色 ✓ 标记
```

5️⃣ **刷新小程序**
```
在模拟器中点击「编译」按钮
或按 Ctrl + R 刷新
```

---

## 📚 相关文档

- [微信云开发官方文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [云函数部署指南](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/deploy.html)
- [云开发控制台](https://console.cloud.tencent.com/tcb)

---

## 💡 最佳实践

### 1. 开发环境部署
```
- 使用「云端安装依赖」
- 及时查看部署日志
- 部署后立���测试
```

### 2. 生产环境部署
```
- 先在开发环境测试
- 使用版本管理
- 做好备份
- 分批部署
- 监控日志
```

### 3. 持续部署
```
- 代码修改后立即部署
- 使用 Git 管理代码
- 记录部署日志
- 定期检查云函数状态
```

---

**最后更新：** 2025-12-26
**适用版本：** v3.16.1+
**当前问题：** ✅ 已识别 - 云函数未部署
**解决方案：** 按照上述步骤部署云函数即可

