# 处方库存获取失败问题修复说明

## 问题描述

在门诊登记页面提交处方时，出现错误提示：
```
药品布洛芬缓释胶囊(芬必得)当前库存取货失败
```

## 问题原因

提交处方时，系统会调用云函数 `stockManage.getBatchesByDrugId` 获取药品的批次信息，如果获取失败会显示此错误。

可能的原因包括：

1. **园区库存不匹配** - 当前选择的园区（陆园/水园）没有该药品的库存
2. **药品未入库** - 该药品虽然在药品档案中，但未进行入库操作
3. **drugId 不匹配** - 药品ID在库存表中找不到对应记录
4. **批次数据异常** - 库存记录存在但数据不完整

## 修复内容

### 1. 改进错误提示

**修改文件**: `pages-sub/clinic/add.vue`

**修改位置**: 提交处方时获取批次信息的代码（约第4070行）

**修改内容**:
- 添加详细的控制台日志，便于调试
- 将简单的 Toast 提示改为 Modal 弹窗，显示更详细的错误信息
- 明确指出是哪个园区没有库存
- 提供操作建议

**修改前**:
```javascript
if (!batchRes.result.success || !batchRes.result.data || batchRes.result.data.length === 0) {
  uni.showToast({
    title: `${item.drugName || ''}库存不足`,
    icon: 'none'
  });
  return;
}
```

**修改后**:
```javascript
if (!batchRes.result.success || !batchRes.result.data || batchRes.result.data.length === 0) {
  const locationName = this.form.location === 'land_park' ? '陆园' : '水园';
  let errorMsg = `药品${item.drugName || ''}当前库存取货失败`;
  
  if (!batchRes.result.success) {
    errorMsg += `\n\n失败原因: ${batchRes.result.message || '查询失败'}`;
  } else if (!batchRes.result.data || batchRes.result.data.length === 0) {
    errorMsg += `\n\n失败原因: ${locationName}暂无库存`;
    errorMsg += `\n\n建议: 请检查该药品是否已入库到${locationName}`;
  }
  
  console.error('❌ [提交处方] 批次获取失败:', errorMsg);
  
  uni.showModal({
    title: '库存获取失败',
    content: errorMsg,
    showCancel: false,
    confirmText: '知道了'
  });
  return;
}
```

## 如何排查问题

### 1. 查看控制台日志

修复后，提交处方时会在控制台输出详细日志：

```javascript
🔍 [提交处方] 获取批次信息: {
  drugId: "xxx",
  drugName: "布洛芬缓释胶囊(芬必得)",
  location: "land_park",
  locationName: "陆园"
}

📦 [提交处方] 批次查询结果: {
  success: false,
  dataLength: 0,
  message: "该药材暂无库存"
}
```

### 2. 检查库存数据

在微信开发者工具的"云开发"控制台中，检查 `stock` 集合：

```javascript
// 查询该药品在指定园区的库存
db.collection('stock').where({
  drugId: '药品ID',
  location: 'land_park',  // 或 'water_park'
  quantity: _.gt(0)
}).get()
```

### 3. 检查药品档案

确认药品在 `drugs` 集合中存在：

```javascript
db.collection('drugs').where({
  _id: '药品ID'
}).get()
```

## 解决方案

### 方案1: 为该园区入库该药品

1. 进入"入库管���"页面
2. 选择对应的园区（陆园/水园）
3. 添加该药品的入库记录
4. 提交入库单并完成复核

### 方案2: 切换到有库存的园区

1. 在门诊登记页面顶部点击"选择园区"按钮
2. 切换到有该药品库存的园区
3. 重新提交处方

### 方案3: 使用其他药品

如果该药品确实缺货，可以：
1. 从处方中移除该药品
2. 选择其他替代药品
3. 重新提交处方

## 预防措施

1. **定期检查库存** - 使用"库存管理"功能查看各园区的库存情况
2. **及时入库** - 药品到货后及时录入系统
3. **库存预警** - 关注系统的库存预警提示
4. **双园区备货** - 常用药品建议在陆园和水园都保持库存

## 测试验证

修复后，请按以下步骤测试：

1. **测试场景1**: 提交有库存的药品
   - 预期：正常提交成功
   
2. **测试场景2**: 提交无库存的药品
   - 预期：显示详细的错误弹窗，说明哪个园区无库存
   
3. **测试场景3**: 切换园区后提交
   - 预期：根据新园区的库存情况正确处理

## 相关文件

- `pages-sub/clinic/add.vue` - 门诊登记页面
- `cloudfunctions/stockManage/index.js` - 库存管理云函数
- `cloudfunctions/clinicRecords/index.js` - 门诊记录云函数

## 更新日期

2025-12-26

## 版本

v3.16.1



