# 📱 手机端不显示园区选择弹窗 - 解决方案

## 🎯 问题描述

**现象：**
- ✅ 在电脑（微信开发者工具）中：每次进入门诊登记页面都会显示园区选择弹窗
- ❌ 在手机（真机调试）中：不显示园区选择弹窗

---

## 🔍 原因分析

### 核心原因

**手机端已经保存了"下次不再提醒"的设置！**

代码逻辑（`restoreLastLocation()` 方法）：

```javascript
// 规则：
// 1）默认不选园区，每次进入都弹窗；
// 2）只有当用户勾选了"下次不再提醒"并关闭弹窗时，才记住园区且下次不再弹窗；
// 3）此时才在进入页面时自动带出上次园区。
if (tipClosed && isValidLocation) {
  // 用户明确选择了不再提醒，并有合法园区记录
  this.form.location = lastLocation;
  this.showLocationTip = false;  // ← 不显示弹窗
} else {
  // 其余情况：不自动选园区，始终弹出提示
  this.form.location = '';
  this.showLocationTip = true;  // ← 显示弹窗
}
```

### 为什么电脑和手机不一样？

1. **电脑（微信开发者工具）**
   - 可能没有保存"下次不再提醒"的设置
   - 或者存储被清除了
   - 所以每次都会显示弹窗

2. **手机（真机调试）**
   - 之前勾选了"下次不再提醒"
   - 设置被保存到手机本地存储
   - 所以不再显示弹窗

---

## ✅ 解决方案

### 方案1：清除手机端的存储设置（推荐）

#### 方法A：在手机小程序中清除

**步骤1：在手机小程序控制台执行**

```javascript
// 清除园区选择相关的存储
uni.removeStorageSync('clinic_location_tip_closed')
uni.removeStorageSync('clinic_last_location')

console.log('✅ 已清除园区选择设置')
console.log('下次进入页面会重新显示弹窗')
```

**步骤2：重新进入门诊登记页面**

关闭小程序，重新打开，进入门诊登记页面，应该会显示弹窗。

---

#### 方法B：在微信开发者工具中清除

1. 打开微信开发者工具
2. 点击菜单：**工具** → **清除缓存** → **清除数据缓存**
3. 重新编译
4. 在真机调试中重新打开小程序

---

### 方案2：修改代码逻辑（如果需要强制显示）

如果希望每次进入都显示弹窗（忽略"下次不再提醒"设置），可以修改代码：

**修改位置：** `pages-sub/clinic/add.vue` 的 `restoreLastLocation()` 方法

**修改前：**
```javascript
if (tipClosed && isValidLocation) {
  this.form.location = lastLocation;
  this.showLocationTip = false;  // 不显示弹窗
}
```

**修改后（强制显示）：**
```javascript
// 强制显示弹窗，忽略"下次不再提醒"设置
this.form.location = '';
this.showLocationTip = true;
```

**或者（保留选择但强制显示）：**
```javascript
if (tipClosed && isValidLocation) {
  this.form.location = lastLocation;
  // 仍然显示弹窗，让用户确认
  this.showLocationTip = true;  // 改为 true
}
```

---

### 方案3：添加调试功能（开发时使用）

在代码中添加一个调试按钮，可以清除存储：

```vue
<!-- 在开发环境下显示 -->
<view v-if="isDev" class="debug-panel">
  <button @tap="clearLocationStorage">清除园区选择设置</button>
</view>
```

```javascript
methods: {
  clearLocationStorage() {
    uni.removeStorageSync('clinic_location_tip_closed')
    uni.removeStorageSync('clinic_last_location')
    uni.showToast({ title: '已清除，请重新进入页面', icon: 'success' })
  }
}
```

---

## 🧪 验证方法

### 步骤1：清除存储

在手机小程序控制台执行：
```javascript
uni.removeStorageSync('clinic_location_tip_closed')
uni.removeStorageSync('clinic_last_location')
```

### 步骤2：检查存储

```javascript
console.log('tipClosed:', uni.getStorageSync('clinic_location_tip_closed'))
console.log('lastLocation:', uni.getStorageSync('clinic_last_location'))
```

应该都返回 `undefined` 或空值。

### 步骤3：重新进入页面

关闭小程序，重新打开，进入门诊登记页面，应该会显示弹窗。

---

## 📋 存储键说明

| 存储键 | 说明 | 默认值 |
|--------|------|--------|
| `clinic_location_tip_closed` | 是否关闭了提示（勾选了"下次不再提醒"） | `undefined` |
| `clinic_last_location` | 上次选择的园区（`land_park` 或 `water_park`） | `undefined` |

### 存储逻辑

1. **首次进入**：两个键都是 `undefined` → 显示弹窗
2. **勾选"下次不再提醒"并选择园区**：
   - `clinic_location_tip_closed` = `true`
   - `clinic_last_location` = `'land_park'` 或 `'water_park'`
   - 下次进入不显示弹窗，自动使用上次选择的园区
3. **清除存储后**：恢复首次进入的状态

---

## 💡 最佳实践

### 推荐做法

1. **开发阶段**：每次测试时清除存储，确保弹窗显示
2. **生产环境**：尊重用户选择，如果用户选择了"下次不再提醒"，就不显示弹窗
3. **如果需要重新选择**：提供清除存储的方法（如方案3）

### 用户体验考虑

- ✅ 首次使用：显示弹窗，引导用户选择园区
- ✅ 用户选择"不再提醒"：尊重用户选择，不再显示
- ✅ 需要切换园区：可以通过顶部的"选择园区"按钮切换

---

## 🔧 快速修复命令

### 在手机小程序控制台执行：

```javascript
// 一键清除园区选择设置
(function() {
  uni.removeStorageSync('clinic_location_tip_closed')
  uni.removeStorageSync('clinic_last_location')
  console.log('✅ 已清除园区选择设置')
  console.log('请关闭小程序重新打开，进入门诊登记页面')
})()
```

---

## 📞 如果还是不行

### 检查1：确认存储已清除

```javascript
console.log('检查存储:', {
  tipClosed: uni.getStorageSync('clinic_location_tip_closed'),
  lastLocation: uni.getStorageSync('clinic_last_location')
})
```

### 检查2：检查代码逻辑

确认 `restoreLastLocation()` 方法中的逻辑是否正确。

### 检查3：检查页面加载

确认 `onLoad()` 方法中调用了 `restoreLastLocation()`。

---

**总结**：手机端不显示弹窗是因为之前保存了"下次不再提醒"的设置。清除相关存储后，下次进入页面就会重新显示弹窗。


