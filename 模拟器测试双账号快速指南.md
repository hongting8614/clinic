# 📱 模拟器测试双账号快速指南（不需要扫码）

## 🎯 为什么推荐用模拟器？

```
✅ 不需要扫码
✅ 不需要真机
✅ 切换账号超快
✅ 调试更方便
✅ 效率更高
```

---

## ⚡ 5分钟快速上手

### 步骤1：获取您当前的OpenID（1分钟）

1. **在微信开发者工具中，确保已点击"编译"**
   - 不要点"真机调试"
   - 就用左侧的模拟器

2. **打开"控制台"标签**（在底部）

3. **输入以下代码并回车：**

```javascript
wx.cloud.callFunction({
  name: 'login',
  success: res => {
    console.log('========================================')
    console.log('您的OpenID是：')
    console.log(res.result.openid || res.result.userInfo?.openid)
    console.log('========================================')
    console.log('请复制保存这个OpenID')
  },
  fail: err => {
    console.error('获取失败：', err)
  }
})
```

4. **复制显示的OpenID**
   - 例如：`oXYZ123abc...`
   - 保存到记事本

---

### 步骤2：在数据库中添加账号A（管理员）（2分钟）

1. **打开云开发控制台**
   ```
   访问：https://console.cloud.tencent.com/tcb
   选择您的环境
   ```

2. **进入数据库**
   ```
   左侧菜单 → 数据库 → users 集合
   ```

3. **添加记录**
   ```
   点击"添加记录"
   切换到"导入"模式
   ```

4. **粘贴以下内容：**

```json
{
  "openid": "粘贴您刚才复制的OpenID",
  "name": "管理员张三",
  "realName": "张三",
  "nickname": "张三",
  "phone": "13800138000",
  "wechatId": "wxid_a123",
  "role": "admin",
  "password": null,
  "status": "active",
  "createTime": "2025-11-10T12:00:00.000Z",
  "updateTime": "2025-11-10T12:00:00.000Z",
  "lastLogin": null
}
```

5. **记得替换：**
   - ⚠️ 将 `"粘贴您刚才复制的OpenID"` 替换为真实的OpenID
   - 可以修改姓名和手机号

6. **点击"确定"保存**

---

### 步骤3：测试登录（1分钟）

1. **返回微信开发者工具**

2. **在小程序中点击"退出登录"**（如果已登录）
   - 进入"我的"页面
   - 点击"退出登录"

3. **重新编译小程序**
   - 点击顶部"编译"按钮

4. **✅ 自动登录成功！**
   - 进入"我的"页面
   - 应该显示："张三 | 管理员"

---

### 步骤4：添加账号B（项目经理）（1分钟）

**方法A：如果您有第二个微信账号（真实双账号测试）**

```
1. 在开发者工具右上角，点击头像 → "退出登录"
2. 用第二个微信扫码登录开发者工具
3. 重复步骤1获取OpenID
4. 在数据库中添加第二个用户（role改为"project_manager"）
5. 随时切换微信账号测试
```

**方法B：如果只有一个微信账号（模拟双账号测试）**

```
直接在数据库中创建一个虚拟用户：
{
  "openid": "oVirtualUser001_ProjectManager",
  "name": "项目经理李四",
  "realName": "李四",
  "phone": "13900139000",
  "role": "project_manager",
  "status": "active"
}

测试时修改自己的role字段即可切换角色
```

---

## 🔄 如何快速切换角色测试？

### 方法1：修改数据库（最快）⚡

**测试管理员功能：**
```
1. 打开云开发控制台
2. 数据库 → users → 找到您的记录
3. 修改 role 为 "admin"
4. 保存
5. 在小程序中"退出登录" → 重新进入
6. ✅ 现在是管理员身份
```

**测试项目经理功能：**
```
1. 修改 role 为 "project_manager"
2. 保存
3. 退出登录 → 重新进入
4. ✅ 现在是项目经理身份
```

**测试医生功能：**
```
1. 修改 role 为 "doctor"
2. 保存
3. 退出登录 → 重新进入
4. ✅ 现在是医生身份
```

---

### 方法2：使用自定义编译模式（推荐）⭐

**一次性设置：**

```
1. 点击顶部"编译"按钮旁的下拉箭头 ▼
2. 选择"添加编译模式"
3. 创建多个模式：
   - 名称：管理员模式
   - 名称：项目经理模式
   - 名称：医生模式
4. 确定
```

**日常使用：**
```
1. 点击"编译" ▼
2. 选择"管理员模式"
3. ✅ 立即切换到管理员测试

1. 点击"编译" ▼  
2. 选择"项目经理模式"
3. ✅ 立即切换到项目经理测试
```

**⚠️ 注意：** 仍需要在数据库中修改role，但编译模式可以快速重置小程序状态

---

## 🎯 完整测试场景示例

### 场景：测试"项目经理可以复核，药房不能复核"

#### 第1步：以药房身份入库

```
1. 在数据库中修改您的role为"pharmacy"
2. 在小程序中退出登录 → 重新进入
3. 进入"新建入库单"
4. 添加药材，提交
5. ✅ 入库成功，等待复核
```

#### 第2步：切换到项目经理复核

```
1. 在数据库中修改您的role为"project_manager"  
2. 在小程序中退出登录 → 重新进入
3. 进入"入库记录"
4. 找到刚才的入库单
5. 点击"复核"
6. ✅ 复核成功（项目经理可以复核）
```

#### 第3步：验证药房不能复核

```
1. 再添加一个入库单（保持项目经理身份）
2. 修改role为"pharmacy"
3. 退出登录 → 重新进入
4. 进入"入库记录"
5. 查看入库单
6. ✅ 应该看不到"复核"按钮（药房不能复核）
```

---

## 💡 实用技巧

### 技巧1：快速查看当前角色

**在控制台输入：**
```javascript
const userInfo = uni.getStorageSync('userInfo')
console.log('==============================')
console.log('当前角色：', userInfo.roleText)
console.log('OpenID：', userInfo.openid)
console.log('姓名：', userInfo.name)
console.log('==============================')
```

---

### 技巧2：快速清除缓存

**在控制台输入：**
```javascript
uni.clearStorageSync()
console.log('✅ 缓存已清除，请重新编译')
```

---

### 技巧3：快速测试权限

**在控制台输入：**
```javascript
// 导入权限工具
const { hasPermission } = require('../../utils/permission.js')

// 测试当前角色是否有某个权限
console.log('是否有入库权限：', hasPermission('in.create'))
console.log('是否有复核权限：', hasPermission('in.review'))
console.log('是否有用户管理权限：', hasPermission('user.create'))
```

---

## 🆚 模拟器 vs 真机调试

| 对比项 | 模拟器（推荐） | 真机调试 |
|-------|--------------|---------|
| **是否需要扫码** | ❌ 不需要 | ✅ 需要 |
| **切换账号** | ⚡ 秒切（改数据库） | 🐢 慢（扫码） |
| **调试便利性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **网络要求** | 无要求 | 同一WiFi |
| **权限要求** | 无要求 | 需添加开发者 |
| **适用场景** | 日常开发 | 最终测试 |

---

## 📋 角色切换速查表

| 要测试的角色 | role值 | 主要功能 |
|------------|--------|---------|
| 管理员 | `admin` | 所有功能 |
| 项目经理 | `project_manager` | 用户管理、复核、报表 |
| 医生 | `doctor` | 门诊登记 |
| 药房 | `pharmacy` | 出入库操作 |
| 查看者 | `viewer` | 只读查看 |

---

## ⚠️ 常见问题

### Q1：修改role后没有生效？

**A：** 需要退出登录
```
在小程序中：
1. 进入"我的"页面
2. 点击"退出登录"
3. 重新编译小程序
4. ✅ 新角色生效
```

---

### Q2：提示"您不在系统白名单内"？

**A：** 检查数据库
```
1. 确认OpenID是否正确
2. 确认status字段是"active"
3. 确认role字段不为空
```

---

### Q3：控制台运行代码报错？

**A：** 可能需要初始化云环境
```
1. 在开发者工具顶部
2. 点击"云开发"按钮
3. 选择您的环境
4. 等待初始化完成
5. 重新运行代码
```

---

## 🎉 总结

### 推荐工作流程：

```
日常开发（95%时间）：
✅ 使用模拟器
✅ 在控制台获取OpenID
✅ 在数据库中快速切换角色
✅ 30秒完成角色切换

最终测试（5%时间）：
✅ 使用真机调试
✅ 测试真实环境
✅ 发现真机特有问题
```

---

**最快速的双账号测试方案：**
```
1️⃣ 获取OpenID（控制台）        → 1分钟
2️⃣ 添加到数据库（管理员角色）   → 2分钟
3️⃣ 测试登录                   → 1分钟
4️⃣ 切换角色（修改role字段）     → 30秒
5️⃣ 退出登录 → 重新进入          → 30秒

总计：5分钟搞定双账号测试！
```

---

**最后更新：** 2025年11月10日


