# 👤 用户头像功能使用指南

## ✅ 已完成的功能

### 1️⃣ 点击头像上传
- ✅ 点击用户头像可以选择上传方式
- ✅ 支持从相册选择
- ✅ 支持拍照上传
- ✅ 自动上传到云存储
- ✅ 自动保存到数据库

### 2️⃣ 自动显示
- ✅ 优先显示自定义头像
- ✅ 没有自定义头像则显示默认图标
- ✅ 加载失败自动降级到默认图标

### 3️⃣ 缓存机制
- ✅ 头像信息保存到本地缓存
- ✅ 下次打开自动显示

---

## 🚀 用户使用流程

### 步骤1：登录小程序

```
1. 打开小程序
2. 进入"我的"页面
3. 如果未登录，点击"点击登录"按钮
```

### 步骤2：上传头像

```
1. 点击头像区域
2. 选择上传方式：
   ├─ 从相册选择
   └─ 拍照

3. 选择图片后自动上传
4. 看到"头像已更新"提示
5. ✅ 完成！头像立即显示
```

---

## 🎯 功能特点

### 1. 简单易用
```
只需2步：
1. 点击头像
2. 选择图片
→ 自动完成上传和保存
```

### 2. 自动压缩
```
系统自动压缩图片
- 节省存储空间
- 加快上传速度
- 优化加载性能
```

### 3. 错误处理
```
如果上传失败：
- 自动显示错误提示
- 保留原有头像
- 可以重新上传
```

---

## 📊 技术实现

### 前端（pages/user/index.vue）

**显示逻辑：**
```vue
<!-- 头像显示 -->
<image 
  v-if="displayAvatar" 
  :src="displayAvatar" 
  class="avatar-img"
  mode="aspectFill"
  @error="onAvatarError"
/>
<text v-else class="avatar-icon">👤</text>
```

**点击事件：**
```javascript
// 点击头像
showAvatarOptions() {
  uni.showActionSheet({
    itemList: ['从相册选择', '拍照'],
    success: (res) => {
      if (res.tapIndex === 0) {
        this.chooseImageFromAlbum()
      } else if (res.tapIndex === 1) {
        this.takePhoto()
      }
    }
  })
}
```

**上传流程：**
```javascript
async chooseAndUploadImage(sourceType) {
  // 1. 选择图片
  const res = await uni.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: sourceType
  })
  
  // 2. 上传到云存储
  const cloudPath = await this.uploadToCloud(tempFilePath)
  
  // 3. 更新数据库
  await this.updateAvatar(cloudPath, 'custom')
  
  // 4. 更新本地显示
  this.userInfo.avatarUrl = cloudPath
}
```

---

### 后端（cloudfunctions/updateMyInfo/index.js）

**支持更新字段：**
```javascript
{
  realName,            // 实名
  avatarUrl,           // 自定义头像
  wechatAvatarUrl,     // 微信头像
  updates              // 批量更新
}
```

**更新逻辑：**
```javascript
// 处理头像更新
if (avatarUrl !== undefined) {
  updateData.avatarUrl = avatarUrl
  updateData.avatarUpdateTime = db.serverDate()
  action = 'update_avatar'
}
```

---

## 🗄️ 数据库结构

### users 表新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| avatarUrl | String | 自定义头像URL（优先显示） |
| wechatAvatarUrl | String | 微信头像URL |
| avatarUpdateTime | Date | 头像更新时间 |

**示例数据：**
```json
{
  "_id": "user_001",
  "openid": "oXXXX",
  "name": "张三",
  "phone": "138xxxx1234",
  "role": "admin",
  "status": "active",
  "avatarUrl": "cloud://xxx/avatars/1699999999-abc123.jpg",
  "wechatAvatarUrl": "",
  "avatarUpdateTime": "2025-11-10T12:00:00.000Z"
}
```

---

## 🔧 开发者须知

### 1. 上传云函数

```bash
# 上传 updateMyInfo 云函数
在微信开发者工具中：
1. 右键 cloudfunctions/updateMyInfo
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成
```

### 2. 开启云存储

```
1. 登录云开发控制台
   https://console.cloud.tencent.com/tcb

2. 进入您的环境

3. 点击左侧"云存储"

4. 开启云存储功能

5. 创建 avatars 文件夹（可选）
```

### 3. 配置存储权限

```
在云开发控制台 → 云存储：

权限设置：
- 所有用户可读
- 仅创建者可写可读

这样可以防止用户删除或修改他人的头像
```

---

## ⚠️ 注意事项

### 1. 存储空间

```
免费额度：
- 云存储：5GB
- 上传操作：20万次/月
- 下载操作：100万次/月

建议：
- 图片自动压缩（已实现）
- 定期清理无用图片
- 监控存储使用情况
```

### 2. 图片审核

```
当前状态：未开启审核

如需开启：
1. 开通内容安全服务
2. 在上传前调用审核API
3. 审核通过后再保存

参考：docs/用户头像功能实现方案.md
```

### 3. 头像尺寸

```
当前设置：
- 自动压缩
- 格式：jpg
- 命名：时间戳 + 随机数

可优化：
- 限制图片大小（如5MB以内）
- 限制图片尺寸（如1024x1024）
- 生成缩略图
```

---

## 🎨 UI展示

### 默认状态（未上传头像）
```
┌─────────────┐
│  👤        │  显示默认图标
└─────────────┘
  📷          ← 相机图标提示可点击
```

### 上传后
```
┌─────────────┐
│  [头像]     │  显示真实头像
└─────────────┘
  📷          ← 点击可更换
```

---

## 🔄 升级计划

### 短期（可选）

- [ ] 添加头像裁剪功能
- [ ] 支持获取微信头像
- [ ] 添加头像预设（职业图标）

### 长期（可选）

- [ ] 头像审核机制
- [ ] 头像历史记录
- [ ] 头像模板库

---

## 🆘 常见问题

### Q1：为什么点击头像没反应？

**A：** 检查是否已登录
```
解决方案：
1. 确保已登录小程序
2. 进入"我的"页面
3. 看到用户名和角色信息
4. 再次点击头像
```

### Q2：上传失败怎么办？

**A：** 检查云开发环境
```
可能原因：
1. 云存储未开启
   → 在云开发控制台开启

2. 权限不足
   → 检查存储权限配置

3. 网络问题
   → 切换网络重试
```

### Q3：头像显示不出来？

**A：** 检查存储权限
```
解决方案：
1. 云开发控制台 → 云存储
2. 权限设置
3. 确保"所有用户可读"
```

---

## ✅ 测试清单

### 功能测试

```
□ 点击头像显示选项菜单
□ 从相册选择图片成功上传
□ 拍照上传成功
□ 上传后头像立即显示
□ 重新进入页面头像正常显示
□ 头像加载失败显示默认图标
□ 未登录时提示"请先登录"
```

### 边界测试

```
□ 选择非常大的图片（自动压缩）
□ 取消选择图片（不报错）
□ 网络断开时上传（显示错误提示）
□ 快速连续上传（防抖处理）
```

---

## 📝 更新日志

### v1.0.0 (2025-11-10)

**新增功能：**
- ✅ 用户头像上传功能
- ✅ 从相册选择
- ✅ 拍照上传
- ✅ 自动云存储
- ✅ 本地缓存

**技术改进：**
- ✅ 修改 updateMyInfo 云函数支持头像字段
- ✅ 优化图片上传流程
- ✅ 添加错误处理

---

**文档创建：** 2025年11月10日  
**最后更新：** 2025年11月10日  
**维护者：** AI助手

