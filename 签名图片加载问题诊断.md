# ğŸ” ç­¾åå›¾ç‰‡åŠ è½½é—®é¢˜è¯Šæ–­æŒ‡å—

## é—®é¢˜ç°è±¡

```
[æ¸²æŸ“å±‚ç½‘ç»œå±‚é”™è¯¯] Failed to load local image resource 
/pages-sub/in/cloud://cloud1-3gv7spppf7d2d0f4.636c-cloud1-3gv7spppf7d2d0f4-1384445947/signatures/1762744964775_275.png 
the server responded with a status of 500 (HTTP/1.1 500 Internal Server Error)
```

**é”™è¯¯è·¯å¾„æ ¼å¼ï¼š** `/pages-sub/in/cloud://...`  
**æ­£ç¡®è·¯å¾„æ ¼å¼åº”è¯¥æ˜¯ï¼š** `cloud://...` æˆ– `https://...`

---

## è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

**å·²æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ï¼š**

```
ğŸ” å¼€å§‹è½¬æ¢ç­¾åå›¾ç‰‡URL
æ“ä½œå‘˜ç­¾åè·¯å¾„: [æ˜¾ç¤ºåŸå§‹è·¯å¾„]
å¤æ ¸å‘˜ç­¾åè·¯å¾„: [æ˜¾ç¤ºåŸå§‹è·¯å¾„]
âœ… æ·»åŠ æ“ä½œå‘˜ç­¾ååˆ°è½¬æ¢åˆ—è¡¨
ğŸ“‹ éœ€è¦è½¬æ¢çš„æ–‡ä»¶åˆ—è¡¨: [...]
ğŸ”„ æ­£åœ¨è°ƒç”¨ getTempFileURL...
ğŸ“¦ getTempFileURL è¿”å›ç»“æœ: [...]
âœ… æ“ä½œå‘˜ç­¾åURLè½¬æ¢æˆåŠŸ: [ä¸´æ—¶URL]
âœ… ç­¾åå›¾ç‰‡URLè½¬æ¢å®Œæˆ
```

### æ­¥éª¤2ï¼šæ£€æŸ¥æ—¥å¿—è¾“å‡º

**æƒ…å†µ1ï¼šå¦‚æœçœ‹åˆ°è½¬æ¢æˆåŠŸæ—¥å¿—**
```
âœ… æ“ä½œå‘˜ç­¾åURLè½¬æ¢æˆåŠŸ: https://...
```
- è¯´æ˜URLè½¬æ¢æˆåŠŸ
- ä½†å›¾ç‰‡ä»ç„¶åŠ è½½å¤±è´¥
- å¯èƒ½æ˜¯ä¸´æ—¶URLè¿‡æœŸæˆ–æƒé™é—®é¢˜

**æƒ…å†µ2ï¼šå¦‚æœçœ‹åˆ°"æ²¡æœ‰éœ€è¦è½¬æ¢çš„äº‘å­˜å‚¨å›¾ç‰‡"**
```
â„¹ï¸ æ²¡æœ‰éœ€è¦è½¬æ¢çš„äº‘å­˜å‚¨å›¾ç‰‡
```
- è¯´æ˜ç­¾åè·¯å¾„ä¸æ˜¯ `cloud://` æ ¼å¼
- å¯èƒ½æ˜¯å…¶ä»–æ ¼å¼çš„è·¯å¾„
- éœ€è¦æ£€æŸ¥æ•°æ®åº“ä¸­çš„å®é™…è·¯å¾„

**æƒ…å†µ3ï¼šå¦‚æœçœ‹åˆ°"äº‘å¼€å‘APIä¸å¯ç”¨"**
```
âš ï¸ äº‘å¼€å‘APIä¸å¯ç”¨ï¼Œæ— æ³•è½¬æ¢ç­¾åå›¾ç‰‡URL
```
- è¯´æ˜ `wx.cloud` æœªåˆå§‹åŒ–
- éœ€è¦æ£€æŸ¥ App.vue ä¸­çš„äº‘å¼€å‘åˆå§‹åŒ–

**æƒ…å†µ4ï¼šå¦‚æœçœ‹åˆ°è½¬æ¢å¤±è´¥é”™è¯¯**
```
âŒ è½¬æ¢ç­¾åå›¾ç‰‡URLå¤±è´¥: [é”™è¯¯ä¿¡æ¯]
```
- æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯
- å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æƒé™é—®é¢˜

---

## å¯èƒ½çš„åŸå› 

### åŸå› 1ï¼šç­¾åè·¯å¾„æ ¼å¼é—®é¢˜

**æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç­¾åè·¯å¾„ï¼š**

```javascript
// åœ¨æ§åˆ¶å°è¿è¡Œ
wx.cloud.callFunction({
  name: 'inRecords',
  data: {
    action: 'getDetail',
    data: { _id: 'ä½ çš„å…¥åº“å•ID' }
  },
  success: res => {
    console.log('æ“ä½œå‘˜ç­¾åè·¯å¾„:', res.result.data.operatorSign)
    console.log('å¤æ ¸å‘˜ç­¾åè·¯å¾„:', res.result.data.reviewerSign)
  }
})
```

**å¯èƒ½çš„è·¯å¾„æ ¼å¼ï¼š**
1. âœ… `cloud://cloud1-xxx.xxx/signatures/xxx.png` - äº‘å­˜å‚¨è·¯å¾„ï¼ˆéœ€è¦è½¬æ¢ï¼‰
2. âœ… `https://xxx.tcb.qcloud.la/xxx.png` - ä¸´æ—¶URLï¼ˆæ— éœ€è½¬æ¢ï¼‰
3. âŒ `/pages-sub/in/cloud://...` - é”™è¯¯æ ¼å¼ï¼ˆè·¯å¾„è¢«æ±¡æŸ“ï¼‰
4. âŒ `undefined` æˆ– `null` - æ²¡æœ‰ç­¾å

### åŸå› 2ï¼šVueå“åº”å¼æ›´æ–°é—®é¢˜

**å¦‚æœURLè½¬æ¢æˆåŠŸä½†å›¾ç‰‡ä»ä¸æ˜¾ç¤ºï¼š**

å¯èƒ½æ˜¯ Vue æ²¡æœ‰æ£€æµ‹åˆ° `record` å¯¹è±¡çš„å˜åŒ–ã€‚

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ `this.$set` å¼ºåˆ¶æ›´æ–°**

```javascript
// ä¿®æ”¹ convertSignatureUrls æ–¹æ³•
if (item.fileID === this.record.operatorSign && item.tempFileURL) {
  this.$set(this.record, 'operatorSign', item.tempFileURL)
  console.log('âœ… æ“ä½œå‘˜ç­¾åURLè½¬æ¢æˆåŠŸ:', item.tempFileURL)
}
```

### åŸå› 3ï¼šå›¾ç‰‡ç»„ä»¶æ¸²æŸ“æ—¶æœºé—®é¢˜

**å›¾ç‰‡å¯èƒ½åœ¨URLè½¬æ¢å‰å°±å·²ç»æ¸²æŸ“ï¼š**

```html
<!-- å½“å‰ä»£ç  -->
<image 
  v-if="record.operatorSign"
  :src="record.operatorSign"
></image>
```

**è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ åŠ è½½çŠ¶æ€**

```html
<image 
  v-if="record.operatorSign && !isLoadingSignature"
  :src="record.operatorSign"
  @error="onImageError"
></image>
```

---

## ç«‹å³æµ‹è¯•

### æµ‹è¯•1ï¼šæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

1. é‡æ–°ç¼–è¯‘å°ç¨‹åº
2. è¿›å…¥å…¥åº“å•è¯¦æƒ…é¡µ
3. æŸ¥çœ‹æ§åˆ¶å°ï¼Œæ‰¾åˆ°ä»¥ ğŸ” å¼€å¤´çš„æ—¥å¿—
4. è®°å½•æ‰€æœ‰æ—¥å¿—å†…å®¹

### æµ‹è¯•2ï¼šæ£€æŸ¥ç­¾åè·¯å¾„

åœ¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
// è·å–å½“å‰é¡µé¢å®ä¾‹
const pages = getCurrentPages()
const currentPage = pages[pages.length - 1]

// æŸ¥çœ‹ç­¾åè·¯å¾„
console.log('æ“ä½œå‘˜ç­¾å:', currentPage.data.record.operatorSign)
console.log('å¤æ ¸å‘˜ç­¾å:', currentPage.data.record.reviewerSign)
```

### æµ‹è¯•3ï¼šæ‰‹åŠ¨è½¬æ¢URL

åœ¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
wx.cloud.getTempFileURL({
  fileList: ['cloud://cloud1-3gv7spppf7d2d0f4.636c-cloud1-3gv7spppf7d2d0f4-1384445947/signatures/1762744964775_275.png'],
  success: res => {
    console.log('è½¬æ¢ç»“æœ:', res.fileList)
  },
  fail: err => {
    console.error('è½¬æ¢å¤±è´¥:', err)
  }
})
```

---

## ä¸‹ä¸€æ­¥æ“ä½œ

**è¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ“ä½œï¼š**

1. âœ… **é‡æ–°ç¼–è¯‘å°ç¨‹åº**
2. âœ… **è¿›å…¥å…¥åº“å•è¯¦æƒ…é¡µ**
3. âœ… **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**
4. âœ… **å°†æ‰€æœ‰ ğŸ” å¼€å¤´çš„æ—¥å¿—å‘ç»™æˆ‘**

**æˆ‘éœ€è¦çœ‹åˆ°ï¼š**
- æ“ä½œå‘˜ç­¾åè·¯å¾„çš„åŸå§‹å€¼
- æ˜¯å¦æˆåŠŸæ·»åŠ åˆ°è½¬æ¢åˆ—è¡¨
- getTempFileURL çš„è¿”å›ç»“æœ
- æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

---

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

**å¦‚æœæ€¥éœ€ä½¿ç”¨ï¼Œå¯ä»¥ä¸´æ—¶ä¿®æ”¹äº‘å‡½æ•°ï¼š**

åœ¨ `cloudfunctions/inRecords/index.js` çš„ `getDetail` æ–¹æ³•ä¸­ï¼Œç›´æ¥è¿”å›ä¸´æ—¶URLï¼š

```javascript
// åœ¨è¿”å›æ•°æ®å‰è½¬æ¢URL
if (record.operatorSign && record.operatorSign.startsWith('cloud://')) {
  const res = await cloud.getTempFileURL({
    fileList: [record.operatorSign]
  })
  if (res.fileList && res.fileList[0]) {
    record.operatorSign = res.fileList[0].tempFileURL
  }
}

if (record.reviewerSign && record.reviewerSign.startsWith('cloud://')) {
  const res = await cloud.getTempFileURL({
    fileList: [record.reviewerSign]
  })
  if (res.fileList && res.fileList[0]) {
    record.reviewerSign = res.fileList[0].tempFileURL
  }
}
```

---

**æœ€åæ›´æ–°ï¼š** 2025å¹´11æœˆ10æ—¥  
**çŠ¶æ€ï¼š** ç­‰å¾…è¯Šæ–­æ—¥å¿—

