# 🔧 诊断字段关联逻辑优化方案

## 🎯 问题分析

### 当前问题
1. **诊断与主诉不匹配**：选择诊断后，自动填充的主诉可能不准确
2. **诊断与处置不匹配**：选择诊断后，自动填充的处置可能不准确
3. **症状与诊断不匹配**：症状可能来自不同的模板记录
4. **字段覆盖问题**：用户手动输入的内容可能被自动填充覆盖

---

## 🔍 根本原因

### 问题1：部分匹配导致不准确

**当前逻辑**：
```javascript
// 选择诊断时，只查找第一条匹配的记录
const record = this.templateIndex.find(r => 
  (r.diagnoses || []).some(d => d === text)
);
```

**问题**：
- 同一个诊断可能出现在多个模板记录中
- 只取第一条，可能不是最匹配的
- 没有考虑主诉、疾病名称的关联性

### 问题2：字段来源不一致

**当前逻辑**：
- 选择诊断 → 从模板A填充主诉、症状、处置
- 选择主诉 → 从模板B填充诊断、症状、处置
- 选择疾病 → 从模板C填充主诉、诊断、症状、处置

**问题**：
- 不同字段可能来自不同的模板记录
- 导致字段之间不匹配、不准确

### 问题3：自动覆盖用户输入

**当前逻辑**：
- 选择诊断后，直接覆盖主诉、症状、处置
- 没有检查用户是否已手动输入

**问题**：
- 用户手动输入的内容被覆盖
- 用户体验差

---

## ✅ 优化方案

### 核心原则

1. **完整匹配优先**：优先使用包含所有相关字段的完整模板记录
2. **关联性检查**：确保诊断、主诉、症状、处置来自同一条记录
3. **智能合并**：用户已输入的内容优先，只填充空白字段
4. **精确匹配**：基于多个字段同时匹配，找到最准确的模板

---

## 🔧 实施步骤

### 步骤1：改进模板匹配逻辑

**新逻辑**：基于多个字段同时匹配，找到最完整的模板记录

```javascript
// 查找最匹配的模板记录（考虑多个字段）
findBestMatchingRecord(diagnosis, complaint, diseaseName) {
  let bestMatch = null;
  let bestScore = 0;
  
  for (const record of this.templateIndex) {
    let score = 0;
    
    // 诊断匹配度
    if (diagnosis && record.diagnoses) {
      const diagnosisMatch = record.diagnoses.some(d => 
        d === diagnosis || d.includes(diagnosis) || diagnosis.includes(d)
      );
      if (diagnosisMatch) score += 3; // 诊断匹配权重最高
    }
    
    // 主诉匹配度
    if (complaint && record.complaint) {
      const complaintMatch = record.complaint.includes(complaint) || 
                            complaint.includes(record.complaint);
      if (complaintMatch) score += 2;
    }
    
    // 疾病名称匹配度
    if (diseaseName && record.disease) {
      if (record.disease === diseaseName) score += 2;
      else if (record.disease.includes(diseaseName) || 
               diseaseName.includes(record.disease)) score += 1;
    }
    
    // 选择得分最高的记录
    if (score > bestScore) {
      bestScore = score;
      bestMatch = record;
    }
  }
  
  return bestMatch;
}
```

### 步骤2：智能填充策略

**新逻辑**：只填充空白字段，保留用户已输入的内容

```javascript
// 智能填充：只填充空白字段
smartFillFields(record, options = {}) {
  const {
    preserveComplaint = false,  // 是否保留主诉
    preserveSymptom = false,    // 是否保留症状
    preserveDiagnosis = false,  // 是否保留诊断
    preserveTreatment = false   // 是否保留处置
  } = options;
  
  // 主诉：如果为空或允许覆盖，则填充
  if (!preserveComplaint && (!this.form.chiefComplaint || !this.form.chiefComplaint.trim())) {
    if (record.complaint) {
      this.form.chiefComplaint = record.complaint;
    }
  }
  
  // 症状：如果为空或允许覆盖，则填充
  if (!preserveSymptom && (!this.form.symptom || !this.form.symptom.trim())) {
    if (record.symptoms && record.symptoms.length) {
      this.form.symptom = record.symptoms.join('；');
    }
  }
  
  // 诊断：如果为空或允许覆盖，则填充
  if (!preserveDiagnosis && (!this.form.diagnosis || !this.form.diagnosis.trim())) {
    if (record.diagnoses && record.diagnoses.length) {
      this.form.diagnosis = record.diagnoses.join('；');
    }
  }
  
  // 处置：如果为空或允许覆盖，则填充
  if (!preserveTreatment && (!this.form.treatment || !this.form.treatment.trim())) {
    if (record.treatments && record.treatments.length) {
      this.form.treatment = record.treatments.join('；');
    }
  }
  
  // 疾病名称：始终更新（用于分类）
  if (record.disease) {
    const analyzedDisease = this.analyzeDiseaseFromDiagnosis(
      record.diagnoses?.[0] || record.disease
    );
    this.form.diseaseName = analyzedDisease || record.disease;
  }
}
```

### 步骤3：改进选择诊断逻辑

**新逻辑**：选择诊断时，找到最匹配的完整记录

```javascript
selectDiagnosis(text) {
  // 优先检查是否是AI建议的诊断
  if (this.hvSuggestion && this.hvSuggestion.name === text) {
    this.applyHvSuggestion();
    this.showDiagnosisList = false;
    return;
  }
  
  // 查找最匹配的模板记录（考虑当前已输入的字段）
  const bestRecord = this.findBestMatchingRecord(
    text,  // 诊断
    this.form.chiefComplaint,  // 当前主诉
    this.form.diseaseName      // 当前疾病名称
  );
  
  if (bestRecord) {
    // 智能填充：只填充空白字段，保留用户已输入的内容
    this.smartFillFields(bestRecord, {
      preserveComplaint: !!this.form.chiefComplaint?.trim(),  // 如果主诉已输入，保留
      preserveSymptom: !!this.form.symptom?.trim(),           // 如果症状已输入，保留
      preserveDiagnosis: false,  // 诊断字段用新选择的替换
      preserveTreatment: !!this.form.treatment?.trim()        // 如果处置已输入，保留
    });
    
    // 确保诊断字段使用选择的诊断
    this.form.diagnosis = text;
    
    // 自动选择推荐用药
    if (Array.isArray(bestRecord.suggestDrugs) && bestRecord.suggestDrugs.length) {
      bestRecord.suggestDrugs.forEach(name => {
        if (name) this.onDrugChip(name);
      });
    }
  } else {
    // 如果没有找到匹配记录，只更新诊断和疾病名称
    this.form.diagnosis = text;
    const analyzedDisease = this.analyzeDiseaseFromDiagnosis(text);
    this.form.diseaseName = analyzedDisease || '其他';
  }
  
  this.showDiagnosisList = false;
}
```

### 步骤4：改进选择主诉逻辑

**新逻辑**：选择主诉时，找到最匹配的完整记录

```javascript
selectComplaint(opt) {
  if (!opt || !opt.record) return;
  const record = opt.record;
  
  // 智能填充：只填充空白字段
  this.smartFillFields(record, {
    preserveComplaint: false,  // 主诉用新选择的替换
    preserveSymptom: !!this.form.symptom?.trim(),
    preserveDiagnosis: !!this.form.diagnosis?.trim(),
    preserveTreatment: !!this.form.treatment?.trim()
  });
  
  // 确保主诉字段使用选择的主诉
  this.form.chiefComplaint = record.complaint;
  
  // 自动选择推荐用药
  if (Array.isArray(record.suggestDrugs) && record.suggestDrugs.length) {
    record.suggestDrugs.forEach(name => {
      if (name) this.onDrugChip(name);
    });
  }
  
  // 进入自由编辑模式
  this.complaintSelectedMode = true;
  this.showComplaintList = false;
}
```

### 步骤5：改进选择疾病逻辑

**新逻辑**：选择疾病时，找到最匹配的完整记录

```javascript
selectDisease(disease) {
  // 查找该疾病的第一条完整模板记录
  const record = this.templateIndex.find(r => r.disease === disease);
  
  if (record) {
    // 智能填充：只填充空白字段
    this.smartFillFields(record, {
      preserveComplaint: !!this.form.chiefComplaint?.trim(),
      preserveSymptom: !!this.form.symptom?.trim(),
      preserveDiagnosis: !!this.form.diagnosis?.trim(),
      preserveTreatment: !!this.form.treatment?.trim()
    });
    
    // 确保疾病名称使用标准名称
    this.form.diseaseName = disease;
    
    // 自动选择推荐用药
    if (Array.isArray(record.suggestDrugs) && record.suggestDrugs.length) {
      record.suggestDrugs.forEach(name => {
        if (name) this.onDrugChip(name);
      });
    }
  }
  
  this.showDiseaseList = false;
}
```

---

## 📊 优化效果

### 优化前
- ❌ 字段之间可能不匹配
- ❌ 用户输入被覆盖
- ❌ 只匹配第一条记录，可能不准确

### 优化后
- ✅ 字段之间完全匹配（来自同一条记录）
- ✅ 保留用户已输入的内容
- ✅ 智能匹配，找到最准确的记录
- ✅ 只填充空白字段，不覆盖已有内容

---

## 🎯 实施优先级

### 阶段1：核心逻辑优化（立即实施）
1. 实现 `findBestMatchingRecord()` 方法
2. 实现 `smartFillFields()` 方法
3. 修改 `selectDiagnosis()` 方法
4. 修改 `selectComplaint()` 方法
5. 修改 `selectDisease()` 方法

### 阶段2：用户体验优化（后续优化）
1. 添加字段关联提示
2. 添加字段一致性检查
3. 优化自动填充动画

---

## 💡 关键改进点

1. **完整匹配**：确保所有字段来自同一条模板记录
2. **智能填充**：只填充空白字段，保留用户输入
3. **精确匹配**：基于多个字段同时匹配，找到最准确的记录
4. **用户优先**：用户手动输入的内容优先于自动填充

