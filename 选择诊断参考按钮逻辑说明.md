# 🔍 "选择诊断参考" 按钮逻辑说明

## 📋 按钮位置

**位置**：门诊登记页面 → 诊断输入框下方

**UI 元素**：
```vue
<view class="diagnosis-reference-btn" @click="openDiagnosisGuide">
  <text class="iconfont icon-search"></text>
  <text>选择诊断参考</text>
</view>
```

---

## 🎯 功能目的

帮助医生快速查找和选择诊断参考，基于已输入的**疾病名称**、**主诉**、**诊断**关键词，智能匹配相关的诊断选项。

---

## ⚙️ 工作流程

### 步骤1：用户点击按钮

```javascript
openDiagnosisGuide() {
  // 触发全局搜索
  const result = this.performGlobalSearch(
    this.form.diseaseName,    // 疾病名称
    this.form.chiefComplaint,  // 主诉
    this.form.diagnosis        // 当前诊断
  );
  this.filteredDiagnosis = result.diagnoses;
  
  // 显示诊断下拉列表
  if (this.filteredDiagnosis.length > 0) {
    this.showDiagnosisList = true;
    this.onDiagnosisFocus();  // 触发焦点事件，显示下拉
  } else {
    // 提示用户输入关键词
    uni.showToast({
      title: '请输入疾病名称或主诉以查看诊断参考',
      icon: 'none'
    });
  }
}
```

### 步骤2：全局搜索（`performGlobalSearch`）

**搜索逻辑**：
1. **多关键词匹配**：同时基于疾病名称、主诉、诊断三个字段的关键词
2. **模糊匹配**：使用 `includes()` 进行包含匹配（不区分大小写）
3. **模板索引搜索**：在 `templateIndex` 中搜索匹配的记录
4. **结果提取**：提取匹配记录中的诊断选项

**搜索范围**：
- 最多搜索 500 条模板记录（性能优化）
- 最多返回 50 条匹配结果

**返回结果**：
```javascript
{
  diseases: ['扭伤', '擦伤', ...],      // 匹配的疾病名称
  complaints: [...],                     // 匹配的主诉
  diagnoses: ['踝关节扭伤', '腕关节扭伤', ...]  // 匹配的诊断
}
```

### 步骤3：显示诊断下拉列表

如果找到匹配的诊断：
- `showDiagnosisList = true` → 显示下拉列表
- 调用 `onDiagnosisFocus()` → 触发诊断输入框的焦点事件
- 下拉列表显示所有匹配的诊断选项

如果没有找到：
- 显示提示："请输入疾病名称或主诉以查看诊断参考"

### 步骤4：用户选择诊断

用户点击下拉列表中的诊断选项：

```javascript
selectDiagnosis(text) {
  // 1. 查找包含该诊断的模板记录
  const record = this.templateIndex.find(r => 
    (r.diagnoses || []).some(d => d === text)
  );
  
  // 2. 自动填充相关字段
  if (record) {
    // 分析并设置疾病名称
    this.form.diseaseName = analyzeDiseaseFromDiagnosis(text);
    
    // 填充主诉
    this.form.chiefComplaint = record.complaint;
    
    // 填充症状
    if (record.symptoms) {
      this.form.symptom = record.symptoms.join('；');
    }
    
    // 填充诊断（完整诊断组合）
    if (record.diagnoses) {
      this.form.diagnosis = record.diagnoses.join('；');
    }
    
    // 填充处置
    if (record.treatments) {
      this.form.treatment = record.treatments.join('；');
    }
    
    // 自动选择推荐用药
    if (record.suggestDrugs) {
      this.applySuggestDrugs(record.suggestDrugs);
    }
  }
}
```

---

## 🔄 完整交互流程

```
用户点击"选择诊断参考"按钮
    ↓
openDiagnosisGuide() 执行
    ↓
performGlobalSearch() 搜索
    ├─ 基于疾病名称关键词
    ├─ 基于主诉关键词
    └─ 基于诊断关键词
    ↓
返回匹配的诊断列表
    ↓
显示诊断下拉列表
    ↓
用户选择诊断
    ↓
selectDiagnosis() 执行
    ↓
自动填充：
    ├─ 疾病名称
    ├─ 主诉
    ├─ 症状
    ├─ 诊断
    ├─ 处置
    └─ 推荐用药
```

---

## 💡 使用场景

### 场景1：已输入疾病名称

**用户操作**：
1. 在"疾病名称"输入框输入：`扭伤`
2. 点击"选择诊断参考"按钮

**系统行为**：
- 搜索所有包含"扭伤"的模板记录
- 显示匹配的诊断：`踝关节扭伤`、`腕关节扭伤`、`膝关节扭伤` 等
- 用户选择后，自动填充主诉、症状、处置等

### 场景2：已输入主诉

**用户操作**：
1. 在"主诉"输入框输入：`崴脚后脚踝疼痛`
2. 点击"选择诊断参考"按钮

**系统行为**：
- 搜索所有包含相关关键词的模板记录
- 显示匹配的诊断：`踝关节扭伤`、`关节扭伤` 等
- 用户选择后，自动填充完整信息

### 场景3：已输入诊断关键词

**用户操作**：
1. 在"诊断"输入框输入：`关节`
2. 点击"选择诊断参考"按钮

**系统行为**：
- 搜索所有包含"关节"的诊断
- 显示匹配的诊断选项
- 用户选择后，自动填充相关信息

### 场景4：未输入任何关键词

**用户操作**：
1. 直接点击"选择诊断参考"按钮

**系统行为**：
- 提示："请输入疾病名称或主诉以查看诊断参考"
- 不显示下拉列表

---

## 🎨 UI 交互

### 按钮样式
- 位置：诊断输入框下方
- 图标：搜索图标（`icon-search`）
- 文字："选择诊断参考"
- 点击效果：显示诊断下拉列表

### 下拉列表
- 位置：诊断输入框下方
- 内容：匹配的诊断选项列表
- 交互：点击选项自动填充表单

---

## 🔧 技术实现

### 核心方法

1. **`openDiagnosisGuide()`**
   - 入口方法
   - 触发全局搜索
   - 控制下拉列表显示

2. **`performGlobalSearch(diseaseKw, complaintKw, diagnosisKw)`**
   - 全局搜索核心逻辑
   - 多关键词匹配
   - 返回匹配结果

3. **`onDiagnosisFocus()`**
   - 诊断输入框焦点事件
   - 触发搜索并显示下拉列表

4. **`selectDiagnosis(text)`**
   - 诊断选择处理
   - 自动填充表单字段

### 数据源

- **`templateIndex`**：模板索引数组（52条记录）
- **`diseaseTemplateLib`**：疾病模板库
- **`userDiseaseTemplates`**：用户自定义模板

---

## 📊 性能优化

1. **搜索限制**：最多搜索 500 条记录
2. **结果限制**：最多返回 50 条结果
3. **防抖处理**：输入时延迟 200ms 执行搜索

---

## ✅ 总结

"选择诊断参考"按钮是一个**智能诊断助手**，帮助医生：

1. **快速查找**：基于已输入的关键词，快速找到相关诊断
2. **自动填充**：选择诊断后，自动填充主诉、症状、处置等完整信息
3. **提高效率**：减少手动输入，提高登记效率

**最佳使用方式**：
- 先输入疾病名称或主诉
- 再点击"选择诊断参考"
- 从下拉列表中选择最匹配的诊断
- 系统自动填充完整信息

---

**最后更新**：2025-12-13

